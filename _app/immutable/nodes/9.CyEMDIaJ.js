var O=Object.defineProperty;var E=r=>{throw TypeError(r)};var R=(r,e,t)=>e in r?O(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var l=(r,e,t)=>R(r,typeof e!="symbol"?e+"":e,t),P=(r,e,t)=>e.has(r)||E("Cannot "+t);var w=(r,e,t)=>(P(r,e,"read from private field"),t?t.call(r):e.get(r)),k=(r,e,t)=>e.has(r)?E("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(r):e.set(r,t),S=(r,e,t,s)=>(P(r,e,"write to private field"),s?s.call(r,t):e.set(r,t),t);import"../chunks/CWj6FrbW.js";import"../chunks/DxqOjG3C.js";import{p as $,f as y,U as j,d as m,b,c as x,$ as N,s as f,ak as F,l as v,r as g,a as H,t as L}from"../chunks/DZGWyE00.js";import{d as U,s as W}from"../chunks/j-tIMm_a.js";import{i as q}from"../chunks/qJDjqx1W.js";import{h as D}from"../chunks/BJ8MXW2t.js";import{s as z}from"../chunks/D117-Z4F.js";import{i as B}from"../chunks/D9nVkNGF.js";import{C as G}from"../chunks/BaF23LuM.js";import{a as J,e as Q,g as V,T as X}from"../chunks/wP1rRefP.js";import{s as Y}from"../chunks/DOPGH-7y.js";import{t as Z}from"../chunks/Ce7-ILAV.js";import{m as tt,W as et,P as C,c as rt,G as st}from"../chunks/Dmo4G5XH.js";class at{constructor({log:e=null,batchSize:t=1e3}){l(this,"neo4j",V());l(this,"path",[]);l(this,"log",null);l(this,"batchSize",1500);e!=null?this.log=e:Y.debugging&&(this.log=console.debug),this.batchSize=t}async node(e){var s,i;const t=this.neo4j.session();if(e==null){const a=await t.run(`
        MATCH (r:Root) RETURN elementId(r) as id
      `),n=a.records.length;if(n===0)throw new Error("Couldn’t find `rootId`.");if(n>1)throw new Error(`Found ${n} \`rootId\`s.`);e=a.records[0].get("id")}if(e==null)throw new Error("Couldn’t get `rootId`.");if(this.path.includes(e))throw new Error(`Revisited ${e}. (¿Cycle found?)`,{cause:this.path});this.path.push(e);try{const o=`
        MATCH (start) WHERE elementId(start) = $rootId
        OPTIONAL MATCH (start)-[rel]->(node)
        RETURN
          labels(start) AS labels,
          properties(start) AS properties,
          [r IN collect({
            type: type(rel),
            properties: properties(rel),
            targetId: elementId(node)
          }) WHERE r.type IS NOT NULL] AS relations
      `,{records:a}=await t.run(o,{rootId:e});if((s=this.log)==null||s.call(this,`Found ${a.length} node${a.length===1?"":"s"} at ${e.split(":").at(-1)}`),console.debug({records:a}),a.length!==1)throw new Error(`Returned ${a.length} records.`);const[n]=a,p=[];for(const c of n.get("relations")??[])p.push({type:c.type,...c.properties,target:await this.node(c.targetId)});const d=await A({labels:n.get("labels"),properties:Object.fromEntries(Object.entries(n.get("properties")).map(([c,u])=>(c==="cid"&&typeof u=="string"&&(u=G.parse(u)),[c,u]))),relationships:p});return this.path.pop(),(i=this.log)==null||i.call(this,{cid:d}),d}finally{await t.close()}}}async function A(r){return await J().block.put(Q(r),{format:"dag-json"})}async function ot({log:r=null,batchSize:e=1e3,rootId:t=null}){var s,i;try{const o=new at({log:r,batchSize:e});(s=o.log)==null||s.call(o,"Exporting nodes…");const a=await o.node();return(i=o.log)==null||i.call(o,{rootCID:a}),a}catch(o){throw console.error({"Graph Serializing Error":o}),o}}var h;class it{constructor(){l(this,"networks",[tt]);l(this,"adapter",new et({projectId:C,networks:this.networks}));l(this,"metadata",{name:"Mïmis",description:"Collaborative filesystem",url:"https://mimis.dhappy.org",icons:["https://avatars.githubusercontent.com/u/179229932"]});k(this,h,null)}get appKit(){return w(this,h)||S(this,h,rt({adapters:[this.adapter],networks:this.networks,metadata:this.metadata,projectId:C,features:{analytics:!0,swaps:!1,onramp:!1,connectMethodsOrder:["wallet","social","email"]}})),w(this,h)}async getProvider(e="eip155",{log:t}={}){await this.appKit.ready();const s=new Promise((i,o)=>{const a=this.appKit.getProvider(e);if(a)return t==null||t({"AppKit Provider":a}),i(a);this.appKit.subscribeProviders(n=>i(n[e])),this.appKit.subscribeEvents(n=>{n.data.event==="MODAL_CLOSE"&&(n.data.properties.connected||o(new Error("Modal closed without connection.")))}),this.appKit.open()});return t==null||t({"Promised Provider":s}),s}async signMessage(e,{log:t}={}){const s=await this.getProvider(void 0,{log:t});let{address:i}=this.appKit.getAccount();if(i||(i=await new Promise(o=>{this.appKit.subscribeAccount(({address:a})=>{a&&o(a)}),this.appKit.open()})),t==null||t({message:e,provider:s,address:i}),!i)throw new Error("Could not find address from provider.");return await s.request({method:"personal_sign",params:[e,i]})}}h=new WeakMap;const I=new it,nt=async(r,e)=>{try{const t=await ot({});console.debug({acct:await st(I.adapter.wagmiConfig)});const s=await I.signMessage(t.toString(),{log:console.debug});console.debug({signature:s}),F(e,await A({root:t,signature:s}))}catch(t){console.debug({"Signing Error":t}),X({text:t.message,duration:16e3,close:!0,gravity:"bottom",position:"center",stopOnFocus:!0,style:{background:"linear-gradient(to right, #b09b00, #96003d)"}}).showToast()}};var ct=y('<link rel="icon" href="radioactive%20barrel.svg"/>'),pt=y('<hr/> <a class="button svelte-182wcux" target="_blank"><span class="svelte-182wcux">Browse <code> </code></span></a>',1),lt=y('<main class="svelte-182wcux"><button class="svelte-182wcux">Publish</button> <appkit-button></appkit-button> <!></main>',2);function St(r,e){$(e,!1);let t=j(null);B();var s=lt();D(p=>{var d=ct();N.title="Mïmis: Serialize",b(p,d)});var i=m(s);i.__click=[nt,t];var o=f(i,2),a=f(o,2);{var n=p=>{var d=pt(),c=f(H(d),2),u=m(c),_=f(m(u)),T=m(_);g(_),g(u),g(c),L((K,M)=>{z(c,"href",K),W(T,`ipfs://${M??""}`)},[()=>Z({cid:v(t).toString()}),()=>v(t).toString()]),b(p,d)};q(a,p=>{v(t)&&p(n)})}g(s),b(r,s),x()}U(["click"]);export{St as component};
