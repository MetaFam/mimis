var J=Object.defineProperty;var N=a=>{throw TypeError(a)};var Q=(a,t,e)=>t in a?J(a,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[t]=e;var p=(a,t,e)=>Q(a,typeof t!="symbol"?t+"":t,e),U=(a,t,e)=>t.has(a)||N("Cannot "+e);var I=(a,t,e)=>(U(a,t,"read from private field"),e?e.call(a):t.get(a)),j=(a,t,e)=>t.has(a)?N("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(a):t.set(a,e),G=(a,t,e,s)=>(U(a,t,"write to private field"),s?s.call(a,e):t.set(a,e),e);import"../chunks/CWj6FrbW.js";import{p as V,f as _,s as v,a as P,b,c as X,$ as Y,d as R,k as h,al as T,r as A,aQ as Z,t as M,ak as g}from"../chunks/DfeIPOsS.js";import{d as tt,s as D}from"../chunks/DqgNaS7H.js";import{i as W}from"../chunks/BcRHwbIc.js";import{h as et}from"../chunks/B1wUj1WG.js";import{s as K}from"../chunks/BSfT1czH.js";import{C as O,g as rt,a as at,s as st,c as ot}from"../chunks/D14G0noR.js";import{T as it}from"../chunks/izcudvy4.js";import{t as nt}from"../chunks/DxMxlmXu.js";import{C as ct}from"../chunks/B4zkc6MB.js";import{s as lt}from"../chunks/CWzx57QE.js";import{t as pt}from"../chunks/C3Ih53BO.js";import{m as dt,W as ht,P as $,c as ut,G as ft}from"../chunks/D3Lnneyv.js";O.parse("bafybeiczsscdsbs7ffqz55ahobb37kkvllc4hikvjbgmsecgnuyzy4b4ga");class mt{constructor({log:t=null,batchSize:e=1e3}){p(this,"neo4j",rt());p(this,"path",[]);p(this,"log",null);p(this,"batchSize",1500);p(this,"carReadable",null);p(this,"carWritable",null);p(this,"carWriter",null);p(this,"blocks",[]);t!=null?this.log=t:lt.debugging&&(this.log=console.debug),this.batchSize=e;const{readable:s,writable:o}=new TransformStream;this.carReadable=s,this.carWritable=o,this.carWriter=o.getWriter();const i=this.blocks;this.carReadable.pipeTo(new WritableStream({write(r){i.push(r)}}))}async node(t){var s,o;const e=this.neo4j.session();if(t==null){const r=await e.run(`
        MATCH (r:Root) RETURN elementId(r) as id
      `),n=r.records.length;if(n===0)throw new Error("Couldn’t find `rootId`.");if(n>1)throw new Error(`Found ${n} \`rootId\`s.`);t=r.records[0].get("id")}if(t==null)throw new Error("Couldn’t get `rootId`.");if(this.path.includes(t))throw new Error(`Revisited ${t}. (¿Cycle found?)`,{cause:this.path});this.path.push(t);try{const i=`
        MATCH (start) WHERE elementId(start) = $rootId
        OPTIONAL MATCH (start)-[rel]->(node)
        RETURN
          labels(start) AS labels,
          properties(start) AS properties,
          [r IN collect({
            type: type(rel),
            properties: properties(rel),
            targetId: elementId(node)
          }) WHERE r.type IS NOT NULL] AS relations
      `,{records:r}=await e.run(i,{rootId:t});if((s=this.log)==null||s.call(this,`Found ${r.length} node${r.length===1?"":"s"} at ${t.split(":").at(-1)}`),r.length!==1)throw new Error(`Returned ${r.length} records.`);const[n]=r,u=[];for(const f of n.get("relations")??[])u.push({type:f.type,...f.properties,target:await this.node(f.targetId)});const S=await this.addToCAR({labels:n.get("labels"),properties:Object.fromEntries(Object.entries(n.get("properties")).map(([f,y])=>(f==="cid"&&typeof y=="string"&&(y=O.parse(y)),[f,y]))),relationships:u});return this.path.pop(),(o=this.log)==null||o.call(this,{cid:S.toString()}),S}finally{await e.close()}}async addToCAR(t){const e=at(t),s=await st.digest(e),o=O.create(1,ot,s);if(this.carWriter==null)throw new Error("No `carWriter`.");return await this.carWriter.write({cid:o,bytes:e}),o}async carURL(){var i;(i=this.log)==null||i.call(this,"Generating CAR URL…");const t=this.blocks,e=new ReadableStream({pull(r){t.length>0?r.enqueue(t.shift()):r.close()}});if(!t||t.length===0)throw new Error("No blocks generated.");const s=t.at(-1);if(!s)throw new Error("No root block found.");const o=[];return await e.pipeThrough(new ct([s.cid])).pipeTo(new WritableStream({write(r){o.push(r)}})),URL.createObjectURL(new Blob(o))}}async function bt({log:a=null,batchSize:t=1e3,rootId:e=null}){var s,o;try{const i=new mt({log:a,batchSize:t});(s=i.log)==null||s.call(i,"Exporting nodes…");const r=await i.node(e);return(o=i.log)==null||o.call(i,{rootCID:r}),{serializer:i,rootCID:r}}catch(i){throw console.error({"Graph Serializing Error":i}),i}}var C;class gt{constructor(){p(this,"networks",[dt]);p(this,"adapter",new ht({projectId:$,networks:this.networks}));p(this,"metadata",{name:"Mïmis",description:"Collaborative filesystem",url:"https://mimis.dhappy.org",icons:["https://avatars.githubusercontent.com/u/179229932"]});j(this,C,null)}get appKit(){return I(this,C)||G(this,C,ut({adapters:[this.adapter],networks:this.networks,metadata:this.metadata,projectId:$,features:{analytics:!0,swaps:!1,onramp:!1,connectMethodsOrder:["wallet","social","email"]}})),I(this,C)}async getProvider(t="eip155",{log:e}={}){await this.appKit.ready();const s=new Promise((o,i)=>{const r=this.appKit.getProvider(t);if(r)return e==null||e({"AppKit Provider":r}),o(r);this.appKit.subscribeProviders(n=>o(n[t])),this.appKit.subscribeEvents(n=>{n.data.event==="MODAL_CLOSE"&&(n.data.properties.connected||i(new Error("Modal closed without connection.")))}),this.appKit.open()});return e==null||e({"Promised Provider":s}),s}async signMessage(t,{log:e}={}){const s=await this.getProvider(void 0,{log:e});let{address:o}=this.appKit.getAccount();if(o||(o=await new Promise(i=>{this.appKit.subscribeAccount(({address:r})=>{r&&i(r)}),this.appKit.open()})),e==null||e({message:t,provider:s,address:o}),!o)throw new Error("Could not find address from provider.");return await s.request({method:"personal_sign",params:[t,o]})}}C=new WeakMap;const q=new gt,wt=async(a,t,e,s,o,i)=>{g(t,!0);try{const{rootCID:r,serializer:n}=await bt({});g(e,!0),console.debug({acct:await ft(q.adapter.wagmiConfig)});const u=await q.signMessage(r.toString(),{log:console.debug});g(e,!1),g(s,await n.addToCAR({root:r,signature:u}),!0),console.debug({final:h(s).toString(),signature:u}),g(o,await n.carURL(),!0),g(i,`mïmis.full-tree.${nt()}.car`)}catch(r){console.error({"Generation Error":r}),it({text:r.message,duration:16e3,close:!0,gravity:"bottom",position:"center",stopOnFocus:!0,style:{background:"linear-gradient(to right, #b09b00, #96003d)"}}).showToast()}finally{g(e,!1),g(t,!1)}};var vt=_('<link rel="icon" href="radioactive%20barrel.svg"/>'),_t=_("<button><span>Generate a CAR Archive</span></button>"),yt=_("<p>Generating CAR…</p>"),kt=_("<p>Awaiting Ethereum Wallet Signature…</p>"),Rt=_('<hr/> <a class="button"><span> </span></a>',1),At=_('<hr/> <a class="button" target="_blank"><span>Browse <code> </code></span></a>',1),Ct=_('<heading><h1>Generate a JSON-DAG of the Graph Structure</h1></heading> <main class="svelte-1wsw2an"><!> <appkit-button></appkit-button> <!> <!></main>',3);function Dt(a,t){V(t,!0);let e=T(null),s=T(null),o=T(!1),i=T(!1),r=T("dl.car");var n=Ct();et(c=>{var l=vt();Y.title="Mïmis: Serialize",b(c,l)});var u=v(P(n),2),S=R(u);{var f=c=>{var l=_t();l.__click=[wt,o,i,e,s,r],b(c,l)},y=c=>{var l=Z(),d=P(l);{var w=m=>{var E=yt();b(m,E)},k=m=>{var E=kt();b(m,E)};W(d,m=>{h(i)?m(k,!1):m(w)})}b(c,l)};W(S,c=>{h(o)?c(y,!1):c(f)})}var x=v(S,2),L=v(x,2);{var z=c=>{var l=Rt(),d=v(P(l),2),w=R(d),k=R(w);A(w),A(d),M(()=>{K(d,"href",h(s)),K(d,"download",h(r)),D(k,`Download DAG-JSON CAR: ${h(r)??""}`)}),b(c,l)};W(L,c=>{h(s)&&c(z)})}var H=v(L,2);{var B=c=>{var l=At(),d=v(P(l),2),w=R(d),k=v(R(w)),m=R(k);A(k),A(w),A(d),M((E,F)=>{K(d,"href",E),D(m,`ipfs://${F??""}`)},[()=>pt({cid:h(e).toString()}),()=>h(e).toString()]),b(c,l)};W(H,c=>{h(e)&&c(B)})}A(u),b(a,n),X()}tt(["click"]);export{Dt as component};
