import"../chunks/DsnmJJEf.js";import{p as at,aw as N,aB as Y,f as x,s as b,a as J,d as _,t as O,b as I,c as st,k as a,az as v,ay as dt,ax as lt,r as w,aA as ct,b7 as mt,b8 as ut}from"../chunks/C0lYg4N8.js";import{s as Q}from"../chunks/9GzlE_cd.js";import{i as z}from"../chunks/DJx03HtA.js";import{e as pt,i as ft}from"../chunks/BznPomiX.js";import{h as Et}from"../chunks/vHHk0yCJ.js";import{d as gt,e as L}from"../chunks/DmKVZe3W.js";import{d as ht,s as vt}from"../chunks/CoB6fEAl.js";import{b as Tt}from"../chunks/C1A0XLvw.js";import{s as yt}from"../chunks/DQWNuCS8.js";import{T as St}from"../chunks/lnCFUhDM.js";import{s as Rt,w as bt,D as wt}from"../chunks/w-0vudfU.js";import"../chunks/C6yTcgQs.js";import"../chunks/2Ml8XYcV.js";import{v as T}from"../chunks/Z36B0dHS.js";import{C as Ut}from"../chunks/B-VOZDPm.js";import{d as $t,g as At}from"../chunks/M1RXKuGZ.js";import{m as _t}from"../chunks/4OAf_7cD.js";import{t as Ct}from"../chunks/gq_7AhkF.js";import{c as Nt}from"../chunks/BqMWvxrD.js";import"../chunks/B0SWonas.js";import{l as It}from"../chunks/BN8qNu6t.js";import{P as Dt}from"../chunks/DGuOeEMp.js";async function*Ot(y){const f=y.getReader();try{for(;;){const{done:h,value:U}=await f.read();if(h)return;yield U}}finally{f.releaseLock()}}async function zt(y,{log:f}={}){const h=await Ut.fromIterable(Ot(y.stream())),U=[],$=[],c={};let i=null,C=0;for await(const{cid:m,bytes:D}of h){i=m.toString(),f?.({"Current CID":i,count:++C});try{const p=await $t(D),{Links:S}=p;if(S.length===0){U.push(i);continue}if(S.every(({Name:o})=>o==="")){$.push(i);continue}const s=S.map(({Name:o,Tsize:r,Hash:n})=>({name:o,size:r,cid:n.toString()}));c[i]=s.map(o=>{const r=$.includes(o.cid)||U.includes(o.cid)?"file":"directory",n={type:r,title:o.name??`Unknown ${r}`,size:o.size??0,cid:o.cid};if(r==="directory"){const d=n.children=c[o.cid],l=d.map(({childCount:E=0})=>E);n.childCount=l.reduce((E,R)=>E+R,d.length)}return n})}catch{U.push(i)}}if(!i)throw new Error("No nodes found.");return c[i]}async function xt({root:y,path:f=[],log:h,on:U}){const c=At().session(),i=c.beginTransaction({metadata:{action:"car import",path:f,file:y.data.filename}});try{const s=await p();if(y.children?.length!=1)throw new Error(`Can't handle ${y.children?.length} root children.`);const o=await S({node:y.children[0],mountId:s}),r=`/${f.join("/")}${f.length>0?"/":""}`;return h?.(`Mounted ${o} at ${r}.`),await i.commit(),{rootId:o}}catch(s){console.error({Error:s.message}),await i.rollback()}finally{await c.close()}async function C({dirId:s}){h?.({"Adding Point":`${s}`});const o=`
      MATCH (dir) WHERE dir.mïmid = $dirId
      MERGE (dir)-[rel:REPRESENTED_BY]->(point:Nöopoint)
      ON CREATE SET point.mïmid = $pointUUID
      ON CREATE SET rel.mïmid = $relUUID
      ON CREATE SET point.created_at = toString(datetime())
      ON CREATE SET rel.created_at = toString(datetime())
      RETURN point.mïmid AS id
    `,{records:r}=await i.run(o,{dirId:s,pointUUID:T(),relUUID:T()});return r[0].get("id")}async function m({dirId:s,itemId:o,name:r,type:n=":Spot",rship:d=":CONTAINS"}){h?.(`Adding Dir Entry ${r} → ${o}`);const l=`
      ${o?"MATCH (entry) WHERE entry.mïmid = $itemId":""}
      ${s==null?`CREATE (dir${n} { mïmid: $dirUUID })`:"MATCH (dir) WHERE dir.mïmid = $dirId"}
      MERGE (dir)-[c${d} ${r!=null?"{ path: $name }":""}]->(entry)
      ON CREATE SET c.mïmid = $relUUID
      ON CREATE SET entry.mïmid = $entryUUID
      ON CREATE SET c.created_at = toString(datetime())
      ON CREATE SET entry.created_at = toString(datetime())
      SET dir:Spot
      SET entry:Spot
      RETURN entry.mïmid AS id
    `,{records:[E]}=await i.run(l,{itemId:o??null,name:r,dirId:s,dirUUID:T(),relUUID:T(),entryUUID:T()});return E.get("id")}async function D({dirId:s,cid:o,type:r,size:n}){const d=await C({dirId:s});h?.({"Adding File At":`${d}: ${o} (${r})`});const l=`
      MATCH (point) WHERE point.mïmid = $pointId
      MERGE (file:IPFS:File { cid: $cid })
      MERGE (point)-[rel:EMBODIED_AS]->(file)
      ON CREATE SET file.mïmid = $fileUUID
      ON CREATE SET rel.mïmid = $relUUID
      ON CREATE SET file.created_at = toString(datetime())
      ON CREATE SET rel.created_at = toString(datetime())
      SET file.mimetype = CASE WHEN $type IS NOT NULL THEN $type END
      SET file.size = $size
      RETURN file.mïmid AS id
    `,{records:E}=await i.run(l,{pointId:d,cid:o,type:r,size:n,itemUUID:T(),fileUUID:T(),relUUID:T()});return E[0].get("id")}async function p(){const s=`
      MERGE (r:Root)
      ON CREATE SET r.mïmid = $uuid
      ON CREATE SET r.created_at = toString(datetime())
      SET r:Root:Spot
      RETURN r.mïmid AS id
    `,{records:[o]}=await i.run(s,{uuid:T()});let r=o.get("id");for(h?.({"Got Root":r});f.length>0;){const n=`
        MATCH (dir) WHERE dir.mïmid = $current
        MERGE (dir)-[rel:CONTAINS { path: $elem }]->(item)
        ON CREATE SET rel.mïmid = $relUUID
        ON CREATE SET item.mïmid = $itemUUID
        ON CREATE SET rel.created_at = toString(datetime())
        ON CREATE SET item.created_at = toString(datetime())
        SET item:Spot
        RETURN item.mïmid as id
      `,d=f.shift(),{records:l}=await i.run(n,{current:r,elem:d,itemUUID:T(),relUUID:T()});r=l[0].get("id")}return r}async function S({node:s,mountId:o}){if(!s.children)throw new Error(`Not a directory: ${s.title}.`);if(s.children.length===0)throw new Error(`Empty directory: ${s.title}.`);let r=await m({dirId:o,name:s.title});return await Promise.all(s.children.map(async n=>{if(U.node.enter(n),!n.selected&&n.getSelectedNodes().length===0)return null;if(n.isExpandable())await S({node:n,mountId:r});else{const d=n.title.split(".").at(-1);let l=n.title.slice(0,-(d.length+1));l===""&&(console.warn(`Error Processing: "${n.title}": No Extension`),l=d);const E=l===""||l===d,R=_t.getType(d)??`unknown/${d}`;E||(r=await m({name:l,dirId:r})),await D({dirId:r,cid:n.data.cid,type:R,size:n.data.size})}})),r}}var Mt=x('<link rel="icon" href="upload.svg"/>'),kt=x("<button><span>Read CAR</span></button>"),Ht=x('<form id="neo4j-import" class="svelte-tziouu"><!> <button><span>Neo4j Import <!></span></button></form>'),Ft=x("<li> </li>"),Pt=x('<form id="input-upload" class="svelte-tziouu"><button><span>Upload Entire Input CAR</span></button> <ul><li><label><input type="checkbox" name="service" value="storacha" checked class="svelte-tziouu"/> to Storacha</label></li> <li><label><input type="checkbox" name="service" value="kubo" class="svelte-tziouu"/> to Kubo</label></li></ul></form> <ol reversed></ol>',1),Lt=x('<header><h1>Upload a CAR File to Mïmis</h1></header> <main class="svelte-tziouu"><form id="read-car" class="svelte-tziouu"><input type="file" required accept=".car" class="svelte-tziouu"/> <!></form> <!> <!> <section id="display" class="svelte-tziouu"><div id="fs-tree"></div> <div id="content" class="svelte-tziouu"><!></div></section> <!></main>',1);function me(y,f){at(f,!0);class h{#t=N();get form(){return a(this.#t)}set form(e){v(this.#t,e,!0)}#e=dt(()=>!this.form?.checkValidity());get disabled(){return a(this.#e)}set disabled(e){v(this.#e,e)}#r=N(!1);get generating(){return a(this.#r)}set generating(e){v(this.#r,e,!0)}}class U{#t=N();get url(){return a(this.#t)}set url(e){v(this.#t,e,!0)}#e=N();get title(){return a(this.#e)}set title(e){v(this.#e,e,!0)}remove(){this.url=this.title=void 0}get present(){return!!this.url}}let $=N(0),c=N(void 0),i=new h,C=N(Y([""])),m=N(null);const D=Y([]);let p=new U;const S=It(D),s=()=>{v($,0),a(c)?.clear(),v(c,void 0),v(C,[""],!0)},o=async t=>{t.preventDefault();const e=i.form?.querySelector('input[type="file"]')??null;if(v(m,e?.files?.[0],!0),!a(m))throw new Error("No file selected.");const g=await zt(a(m),{log:console.debug});Rt(g),v(c,bt({source:g,mount:"fs-tree",activate:async u=>{console.debug({count:u.node.children?.length,bool:(u.node.children?.length??1)>0}),u.node.children&&u.node.children.length>0?p.remove():(p.title=u.node.title,p.url=Ct({cid:await u.node.data.cid}),console.debug({title:p.title,url:p.url}))}}),!0),a(c).data.filename=a(m).name},r={node:{enter:t=>{mt($)}}},n=async t=>{t.preventDefault();try{i.generating=!0;const e=[...a(C)].filter(Boolean);if(!a(c))throw new Error("No tree to mount.");const g=u=>{console.debug(u)};await xt({root:a(c).root,path:e,log:g,on:r}),St({text:`Loaded: ${a($)} Entr${a($)===1?"y":"ies"}`,duration:8e3,close:!0,gravity:"bottom",position:"center",stopOnFocus:!0,style:{background:"linear-gradient(to right, #00b09b, #96c93d)"}}).showToast()}finally{i.generating=!1}};async function d(t){if(t.preventDefault(),!a(m))throw new Error("CAR upload attempted with no file.");const e=await Nt({log:S});S?.(`Uploading: ${a(m).name}.`),await e.uploadCAR(a(m)),S?.("Finished Uploading.")}var l=Lt();Et(t=>{var e=Mt();lt.title="Upload a CAR",I(t,e)});var E=b(J(l),2),R=_(E),G=_(R);G.__change=()=>{s(),i.disabled=!i.form?.checkValidity()};var X=b(G,2);{var Z=t=>{var e=kt();O(()=>e.disabled=i.disabled),I(t,e)};z(X,t=>{i.disabled||t(Z)})}w(R),Tt(R,t=>i.form=t,()=>i?.form);var W=b(R,2);{var tt=t=>{var e=Ht(),g=_(e);Dt(g,{get elements(){return a(C)},set elements(A){v(C,A,!0)}});var u=b(g,2),M=_(u),F=b(_(M));{var P=A=>{var H=ut();O(nt=>Q(H,nt),[()=>a($).toLocaleString()]),I(A,H)};z(F,A=>{i.generating&&A(P)})}w(M),w(u),w(e),O(()=>u.disabled=i.generating),L("submit",e,n),I(t,e)};z(W,t=>{a(c)&&t(tt)})}var j=b(W,2);z(j,t=>{});var k=b(j,2);let B;var q=_(k);let V;var K=b(q,2),et=_(K);{var rt=t=>{wt(t,yt(()=>p))};z(et,t=>{p.present&&t(rt)})}w(K),w(k);var it=b(k,2);{var ot=t=>{var e=Pt(),g=J(e),u=_(g);ct(2),w(g);var M=b(g,2);pt(M,21,()=>D,ft,(F,P)=>{var A=Ft(),H=_(A,!0);w(A),O(()=>Q(H,a(P))),I(F,A)}),w(M),O(()=>u.disabled=!a(m)),L("submit",g,d),I(t,e)};z(it,t=>{a(m)&&t(ot)})}w(E),O((t,e)=>{B=ht(k,"",B,t),V=vt(q,1,"svelte-tziouu",null,V,e)},[()=>({visibility:a(c)?"visible":"hidden"}),()=>({accompanied:p.present})]),L("submit",R,o),I(y,l),st()}gt(["change"]);export{me as component};
