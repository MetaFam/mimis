var B=e=>{throw TypeError(e)};var X=(e,n,t)=>n.has(e)||B("Cannot "+t);var E=(e,n,t)=>(X(e,n,"read from private field"),t?t.call(e):n.get(e)),_=(e,n,t)=>n.has(e)?B("Cannot add the same private member more than once"):n instanceof WeakSet?n.add(e):n.set(e,t);import{a as z,t as W}from"../chunks/D4b2_asw.js";import{p as Z,s as O,f as j,t as F,a as ee,a9 as te,c as M,g as w,m as b,n as x,r as U,aa as ne}from"../chunks/C2cU29iA.js";import{d as re,e as G}from"../chunks/DvtKE-QB.js";import{h as ae}from"../chunks/j4HOt26g.js";import{a as oe,p as S}from"../chunks/LQSnVXXT.js";import{r as ie}from"../chunks/DedBp538.js";import{c as se}from"../chunks/D6EZi2pP.js";import{b as ce}from"../chunks/CZroP44a.js";import{v as I,d as de,a as q,C as Q,b as ue,s as fe,w as le}from"../chunks/B58CceKm.js";import{g as he,T as ye}from"../chunks/BWr02cJ3.js";const D={SHA2_256:18,LENGTH:32,DAG_PB:112},me=40;function $(e,n){if(!e.length)throw new Error("Unexpected end of data");const t=I.decode(e);return n.seek(I.decode.bytes),t}function pe(e){const n=new DataView(e.buffer,e.byteOffset,e.byteLength);let t=0;return{version:2,characteristics:[n.getBigUint64(t,!0),n.getBigUint64(t+=8,!0)],dataOffset:Number(n.getBigUint64(t+=8,!0)),dataSize:Number(n.getBigUint64(t+=8,!0)),indexOffset:Number(n.getBigUint64(t+=8,!0))}}function ge(e){I.decode(e);const n=I.decode.bytes,t=I.decode(e.subarray(I.decode.bytes)),a=I.decode.bytes;return n+a+t}const v={Null:e=>e===null?e:void 0,Int:e=>Number.isInteger(e)?e:void 0,Float:e=>typeof e=="number"&&Number.isFinite(e)?e:void 0,String:e=>typeof e=="string"?e:void 0,Bool:e=>typeof e=="boolean"?e:void 0,Bytes:e=>e instanceof Uint8Array?e:void 0,Link:e=>e!==null&&typeof e=="object"&&e.asCID===e?e:void 0,List:e=>Array.isArray(e)?e:void 0,Map:e=>e!==null&&typeof e=="object"&&e.asCID!==e&&!Array.isArray(e)&&!(e instanceof Uint8Array)?e:void 0},R={"CarV1HeaderOrV2Pragma > roots (anon) > valueType (anon)":v.Link,"CarV1HeaderOrV2Pragma > roots (anon)":e=>{if(v.List(e)!==void 0){for(let n=0;n<e.length;n++){let t=e[n];if(t=R["CarV1HeaderOrV2Pragma > roots (anon) > valueType (anon)"](t),t===void 0)return;if(t!==e[n]){const a=e.slice(0,n);for(let r=n;r<e.length;r++){let i=e[r];if(i=R["CarV1HeaderOrV2Pragma > roots (anon) > valueType (anon)"](i),i===void 0)return;a.push(i)}return a}}return e}},Int:v.Int,CarV1HeaderOrV2Pragma:e=>{if(v.Map(e)===void 0)return;const n=Object.entries(e);let t=e,a=1;for(let r=0;r<n.length;r++){const[i,c]=n[r];switch(i){case"roots":{const o=R["CarV1HeaderOrV2Pragma > roots (anon)"](e[i]);if(o===void 0)return;if(o!==c||t!==e){if(t===e){t={};for(let d=0;d<r;d++)t[n[d][0]]=n[d][1]}t.roots=o}}break;case"version":{a--;const o=R.Int(e[i]);if(o===void 0)return;if(o!==c||t!==e){if(t===e){t={};for(let d=0;d<r;d++)t[n[d][0]]=n[d][1]}t.version=o}}break;default:return}}if(!(a>0))return t}},H={"CarV1HeaderOrV2Pragma > roots (anon) > valueType (anon)":v.Link,"CarV1HeaderOrV2Pragma > roots (anon)":e=>{if(v.List(e)!==void 0){for(let n=0;n<e.length;n++){let t=e[n];if(t=H["CarV1HeaderOrV2Pragma > roots (anon) > valueType (anon)"](t),t===void 0)return;if(t!==e[n]){const a=e.slice(0,n);for(let r=n;r<e.length;r++){let i=e[r];if(i=H["CarV1HeaderOrV2Pragma > roots (anon) > valueType (anon)"](i),i===void 0)return;a.push(i)}return a}}return e}},Int:v.Int,CarV1HeaderOrV2Pragma:e=>{if(v.Map(e)===void 0)return;const n=Object.entries(e);let t=e,a=1;for(let r=0;r<n.length;r++){const[i,c]=n[r];switch(i){case"roots":{const o=H["CarV1HeaderOrV2Pragma > roots (anon)"](c);if(o===void 0)return;if(o!==c||t!==e){if(t===e){t={};for(let d=0;d<r;d++)t[n[d][0]]=n[d][1]}t.roots=o}}break;case"version":{a--;const o=H.Int(c);if(o===void 0)return;if(o!==c||t!==e){if(t===e){t={};for(let d=0;d<r;d++)t[n[d][0]]=n[d][1]}t.version=o}}break;default:return}}if(!(a>0))return t}},we={toTyped:R.CarV1HeaderOrV2Pragma,toRepresentation:H.CarV1HeaderOrV2Pragma};async function K(e,n){const t=$(await e.upTo(8),e);if(t===0)throw new Error("Invalid CAR header (zero length)");const a=await e.exactly(t,!0),r=de(a);if(we.toTyped(r)===void 0)throw new Error("Invalid CAR header format");if(r.version!==1&&r.version!==2||n!==void 0&&r.version!==n)throw new Error(`Invalid CAR version: ${r.version}${n!==void 0?` (expected ${n})`:""}`);if(r.version===1){if(!Array.isArray(r.roots))throw new Error("Invalid CAR header format");return r}if(r.roots!==void 0)throw new Error("Invalid CAR header format");const i=pe(await e.exactly(me,!0));e.seek(i.dataOffset-e.pos);const c=await K(e,1);return Object.assign(c,i)}async function ve(e){const n=await e.exactly(2,!1);if(n[0]===D.SHA2_256&&n[1]===D.LENGTH){const c=await e.exactly(34,!0),o=q(c);return Q.create(0,D.DAG_PB,o)}const t=$(await e.upTo(8),e);if(t!==1)throw new Error(`Unexpected CID version (${t})`);const a=$(await e.upTo(8),e),r=await e.exactly(ge(await e.upTo(8)),!0),i=q(r);return Q.create(t,a,i)}async function Y(e){const n=e.pos;let t=$(await e.upTo(8),e);if(t===0)throw new Error("Invalid CAR section (zero length)");t+=e.pos-n;const a=await ve(e),r=t-Number(e.pos-n);return{cid:a,length:t,blockLength:r}}async function Ce(e){const{cid:n,blockLength:t}=await Y(e);return{bytes:await e.exactly(t,!0),cid:n}}async function Ee(e){const n=e.pos,{cid:t,length:a,blockLength:r}=await Y(e),i={cid:t,length:a,blockLength:r,offset:n,blockOffset:e.pos};return e.seek(i.blockLength),i}function Ie(e){const n=(async()=>{const t=await K(e);if(t.version===2){const a=e.pos-t.dataOffset;e=be(e,t.dataSize-a)}return t})();return{header:()=>n,async*blocks(){for(await n;(await e.upTo(8)).length>0;)yield await Ce(e)},async*blocksIndex(){for(await n;(await e.upTo(8)).length>0;)yield await Ee(e)}}}function Te(e){let n=0;return{async upTo(t){return e.subarray(n,n+Math.min(t,e.length-n))},async exactly(t,a=!1){if(t>e.length-n)throw new Error("Unexpected end of data");const r=e.subarray(n,n+t);return a&&(n+=t),r},seek(t){n+=t},get pos(){return n}}}function ke(e){let n=0,t=0,a=0,r=new Uint8Array(0);const i=async c=>{t=r.length-a;const o=[r.subarray(a)];for(;t<c;){const s=await e();if(s==null)break;t<0?s.length>t&&o.push(s.subarray(-t)):o.push(s),t+=s.length}r=new Uint8Array(o.reduce((s,f)=>s+f.length,0));let d=0;for(const s of o)r.set(s,d),d+=s.length;a=0};return{async upTo(c){return r.length-a<c&&await i(c),r.subarray(a,a+Math.min(r.length-a,c))},async exactly(c,o=!1){if(r.length-a<c&&await i(c),r.length-a<c)throw new Error("Unexpected end of data");const d=r.subarray(a,a+c);return o&&(n+=c,a+=c),d},seek(c){n+=c,a+=c},get pos(){return n}}}function Ae(e){const n=e[Symbol.asyncIterator]();async function t(){const a=await n.next();return a.done?null:a.value}return ke(t)}function be(e,n){let t=0;return{async upTo(a){let r=await e.upTo(a);return r.length+t>n&&(r=r.subarray(0,n-t)),r},async exactly(a,r=!1){const i=await e.exactly(a,r);if(i.length+t>n)throw new Error("Unexpected end of data");return r&&(t+=a),i},seek(a){t+=a,e.seek(a)},get pos(){return e.pos}}}class xe{constructor(n,t,a){this._version=n,this._roots=t,this._iterable=a,this._decoded=!1}get version(){return this._version}async getRoots(){return this._roots}}class L extends xe{[Symbol.asyncIterator](){if(this._decoded)throw new Error("Cannot decode more than once");if(!this._iterable)throw new Error("Block iterable not found");return this._decoded=!0,this._iterable[Symbol.asyncIterator]()}static async fromBytes(n){const{version:t,roots:a,iterator:r}=await Re(n);return new L(t,a,r)}static async fromIterable(n){const{version:t,roots:a,iterator:r}=await He(n);return new L(t,a,r)}}async function Re(e){if(!(e instanceof Uint8Array))throw new TypeError("fromBytes() requires a Uint8Array");return J(Te(e))}async function He(e){if(!e||typeof e[Symbol.asyncIterator]!="function")throw new TypeError("fromIterable() requires an async iterable");return J(Ae(e))}async function J(e){const n=Ie(e),{version:t,roots:a}=await n.header();return{version:t,roots:a,iterator:n.blocks()}}async function*Ve(e){const n=e.getReader();try{for(;;){const{done:t,value:a}=await n.read();if(t)return;yield a}}finally{n.releaseLock()}}async function Ne(e){const n=await L.fromIterable(Ve(e.stream())),t=[],a=[],r={};let i=null;for await(const{cid:c,bytes:o}of n){i=c.toString();const d=await ue(o),{Links:s}=d;if(s.length===0){t.push(c.toString());continue}if(s.every(({Name:u})=>u==="")){a.push(c.toString());continue}const f=s.map(({Name:u,Tsize:y,Hash:g})=>({name:u,size:y,cid:g.toString()}));r[c.toString()]=f.map(u=>{const y=a.includes(u.cid)||t.includes(u.cid)?"file":"directory",g={type:y,title:u.name??`Unknown ${y}`,size:u.size??0,cid:u.cid};if(y==="directory"){const T=g.children=r[u.cid],k=T.map(({childCount:p=0})=>p);g.childCount=k.reduce((p,C)=>p+C,T.length)}return g})}if(!i)throw new Error("No nodes found.");return r[i]}async function _e(e,n=[]){const t=he();try{const o=await c(e,structuredClone(n));return console.info(`Mounted ${o} at /${n.join("/")}/.`),o}finally{await t.close()}async function a({dirCID:o,entryCID:d,name:s}){const f=t.session();await f.run(`
      MATCH (e:IPFS { cid: $entryCID })
      MERGE (d:IPFS:Directory { cid: $dirCID })
      MERGE (d)-[c:CONTAINS]->(e)
      SET c.path = $name
    `,{dirCID:o,entryCID:d,name:s}),await f.close()}async function r({cid:o,type:d,size:s}){const f=t.session();await f.run(`
      MERGE (e:IPFS:File { cid: $cid })
      SET e.mimetype = CASE WHEN $type IS NOT NULL THEN $type END
      SET e.size = $size
    `,{cid:o,type:d,size:s}),await f.close()}async function i({path:o,cid:d}){const s=t.session(),f=`
      MERGE (r:Mount:Root)
      RETURN elementId(r) as id
    `,{records:u}=await s.run(f);let y=u[0].get("id");for(;o.length>0;){const T=`
        MATCH (p:Mount)
        WHERE elementId(p) = $next
        MERGE (p)-[:CONTAINS {path: $elem}]->(n:Mount)
        RETURN elementId(n) as id
      `,{records:k}=await s.run(T,{next:y,elem:o.shift()});y=k[0].get("id")}await s.run(`
      MATCH (m:Mount)
      WHERE elementId(m) = $next
      MATCH (i:IPFS { cid: $cid })
      MERGE (m)-[:CONNECTS {order: 1}]->(i)
    `,{next:y,cid:d}),await s.close()}async function c(o,d=[]){if(!o.children)throw new Error(`Not A Directory: ${o.title}`);for(const s of o.children)if(!(!s.selected&&s.getSelectedNodes().length===0)){if(s.children)await c(s);else{const f=(()=>{var u;switch((u=s.title.split(".").at(-1))==null?void 0:u.toLowerCase()){case"svg":return"image/svg+xml";case"png":return"image/png";case"jpg":case"jpeg":return"image/jpeg";default:return null}})();await r({cid:s.data.cid,type:f,size:s.data.size})}if(o.data.cid)await a({dirCID:o.data.cid,entryCID:s.data.cid,name:s.title});else return await i({path:d,cid:s.data.cid}),s.data.cid}return o.data.cid}}var Oe=W('<form class="svelte-o04jkh"><input placeholder="/system/mount/point/"> <button>Neo4j Import</button></form>'),Se=W('<header><h1>Upload a CAR File to Mïmis</h1></header> <main><form class="svelte-o04jkh"><input type="file" required accept=".car"> <button>Read CAR</button></form> <!> <div id="fs-tree" class="svelte-o04jkh"></div></main>',1);function Qe(e,n){var k,p,C,A;Z(n,!0);class t{constructor(){_(this,p,b());_(this,C,b(!((k=this.form)!=null&&k.checkValidity())));_(this,A,b(!1))}get form(){return w(E(this,p))}set form(l){x(E(this,p),S(l))}get disabled(){return w(E(this,C))}set disabled(l){x(E(this,C),S(l))}get generating(){return w(E(this,A))}set generating(l){x(E(this,A),S(l))}}p=new WeakMap,C=new WeakMap,A=new WeakMap;let a=b(void 0),r=new t,i=b("");const c=async h=>{var N,P;h.preventDefault();const l=((N=r.form)==null?void 0:N.querySelector('input[type="file"]'))??null,m=(P=l==null?void 0:l.files)==null?void 0:P[0];if(!m)throw new Error("No file selected.");const V=await Ne(m);fe(V),x(a,S(le({source:V,mount:"fs-tree"})))},o=async h=>{h.preventDefault();try{r.generating=!0;const l=w(i).split("/").filter(Boolean);if(!w(a))throw new Error("No tree to mount.");const m=await _e(w(a).root,l);ye({text:`Loaded: ipfs://${m.slice(0,5)}…${m.slice(-5)}`,duration:8e3,destination:`https://w3s.link/ipfs/${m}`,newWindow:!0,close:!0,gravity:"bottom",position:"center",stopOnFocus:!0,style:{background:"linear-gradient(to right, #00b09b, #96c93d)"}}).showToast()}finally{r.generating=!1}};var d=Se();ae(h=>{te.title="Upload a CAR"});var s=O(j(d),2),f=M(s),u=M(f);u.__change=()=>{var h;return r.disabled=!((h=r.form)!=null&&h.checkValidity())};var y=O(u,2);U(f),ce(f,h=>r.form=h,()=>r==null?void 0:r.form);var g=O(f,2);{var T=h=>{var l=Oe(),m=M(l);ie(m);var V=O(m,2);U(l),F(()=>V.disabled=r.generating),G("submit",l,o),se(m,()=>w(i),N=>x(i,N)),z(h,l)};oe(g,h=>{w(a)&&h(T)})}ne(2),U(s),F(()=>y.disabled=r.disabled),G("submit",f,c),z(e,d),ee()}re(["change"]);export{Qe as component};
