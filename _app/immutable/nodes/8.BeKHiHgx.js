var P=e=>{throw TypeError(e)};var J=(e,n,t)=>n.has(e)||P("Cannot "+t);var E=(e,n,t)=>(J(e,n,"read from private field"),t?t.call(e):n.get(e)),_=(e,n,t)=>n.has(e)?P("Cannot add the same private member more than once"):n instanceof WeakSet?n.add(e):n.set(e,t);import{t as Q,a as B}from"../chunks/Br-l2XOM.js";import{p as X,s as O,f as Z,c as L,t as z,a as j,m as b,i as w,n as R,af as ee,r as M,z as te}from"../chunks/eyN12E4_.js";import{d as ne,e as F}from"../chunks/B3QevTHV.js";import{h as re}from"../chunks/C4bKyMxN.js";import{i as ae}from"../chunks/BpDf-klp.js";import{r as oe}from"../chunks/B9gGqUDe.js";import{c as ie}from"../chunks/c27XNntE.js";import{b as se}from"../chunks/CABEh8Sl.js";import{v as I,d as ce,a as G,C as q,b as de,s as ue,w as fe}from"../chunks/CzHRWkwW.js";import{g as le,T as he}from"../chunks/DbwXKgbL.js";const U={SHA2_256:18,LENGTH:32,DAG_PB:112},ye=40;function S(e,n){if(!e.length)throw new Error("Unexpected end of data");const t=I.decode(e);return n.seek(I.decode.bytes),t}function me(e){const n=new DataView(e.buffer,e.byteOffset,e.byteLength);let t=0;return{version:2,characteristics:[n.getBigUint64(t,!0),n.getBigUint64(t+=8,!0)],dataOffset:Number(n.getBigUint64(t+=8,!0)),dataSize:Number(n.getBigUint64(t+=8,!0)),indexOffset:Number(n.getBigUint64(t+=8,!0))}}function pe(e){I.decode(e);const n=I.decode.bytes,t=I.decode(e.subarray(I.decode.bytes)),a=I.decode.bytes;return n+a+t}const v={Null:e=>e===null?e:void 0,Int:e=>Number.isInteger(e)?e:void 0,Float:e=>typeof e=="number"&&Number.isFinite(e)?e:void 0,String:e=>typeof e=="string"?e:void 0,Bool:e=>typeof e=="boolean"?e:void 0,Bytes:e=>e instanceof Uint8Array?e:void 0,Link:e=>e!==null&&typeof e=="object"&&e.asCID===e?e:void 0,List:e=>Array.isArray(e)?e:void 0,Map:e=>e!==null&&typeof e=="object"&&e.asCID!==e&&!Array.isArray(e)&&!(e instanceof Uint8Array)?e:void 0},x={"CarV1HeaderOrV2Pragma > roots (anon) > valueType (anon)":v.Link,"CarV1HeaderOrV2Pragma > roots (anon)":e=>{if(v.List(e)!==void 0){for(let n=0;n<e.length;n++){let t=e[n];if(t=x["CarV1HeaderOrV2Pragma > roots (anon) > valueType (anon)"](t),t===void 0)return;if(t!==e[n]){const a=e.slice(0,n);for(let r=n;r<e.length;r++){let i=e[r];if(i=x["CarV1HeaderOrV2Pragma > roots (anon) > valueType (anon)"](i),i===void 0)return;a.push(i)}return a}}return e}},Int:v.Int,CarV1HeaderOrV2Pragma:e=>{if(v.Map(e)===void 0)return;const n=Object.entries(e);let t=e,a=1;for(let r=0;r<n.length;r++){const[i,c]=n[r];switch(i){case"roots":{const o=x["CarV1HeaderOrV2Pragma > roots (anon)"](e[i]);if(o===void 0)return;if(o!==c||t!==e){if(t===e){t={};for(let d=0;d<r;d++)t[n[d][0]]=n[d][1]}t.roots=o}}break;case"version":{a--;const o=x.Int(e[i]);if(o===void 0)return;if(o!==c||t!==e){if(t===e){t={};for(let d=0;d<r;d++)t[n[d][0]]=n[d][1]}t.version=o}}break;default:return}}if(!(a>0))return t}},H={"CarV1HeaderOrV2Pragma > roots (anon) > valueType (anon)":v.Link,"CarV1HeaderOrV2Pragma > roots (anon)":e=>{if(v.List(e)!==void 0){for(let n=0;n<e.length;n++){let t=e[n];if(t=H["CarV1HeaderOrV2Pragma > roots (anon) > valueType (anon)"](t),t===void 0)return;if(t!==e[n]){const a=e.slice(0,n);for(let r=n;r<e.length;r++){let i=e[r];if(i=H["CarV1HeaderOrV2Pragma > roots (anon) > valueType (anon)"](i),i===void 0)return;a.push(i)}return a}}return e}},Int:v.Int,CarV1HeaderOrV2Pragma:e=>{if(v.Map(e)===void 0)return;const n=Object.entries(e);let t=e,a=1;for(let r=0;r<n.length;r++){const[i,c]=n[r];switch(i){case"roots":{const o=H["CarV1HeaderOrV2Pragma > roots (anon)"](c);if(o===void 0)return;if(o!==c||t!==e){if(t===e){t={};for(let d=0;d<r;d++)t[n[d][0]]=n[d][1]}t.roots=o}}break;case"version":{a--;const o=H.Int(c);if(o===void 0)return;if(o!==c||t!==e){if(t===e){t={};for(let d=0;d<r;d++)t[n[d][0]]=n[d][1]}t.version=o}}break;default:return}}if(!(a>0))return t}},ge={toTyped:x.CarV1HeaderOrV2Pragma,toRepresentation:H.CarV1HeaderOrV2Pragma};async function W(e,n){const t=S(await e.upTo(8),e);if(t===0)throw new Error("Invalid CAR header (zero length)");const a=await e.exactly(t,!0),r=ce(a);if(ge.toTyped(r)===void 0)throw new Error("Invalid CAR header format");if(r.version!==1&&r.version!==2||n!==void 0&&r.version!==n)throw new Error(`Invalid CAR version: ${r.version}${n!==void 0?` (expected ${n})`:""}`);if(r.version===1){if(!Array.isArray(r.roots))throw new Error("Invalid CAR header format");return r}if(r.roots!==void 0)throw new Error("Invalid CAR header format");const i=me(await e.exactly(ye,!0));e.seek(i.dataOffset-e.pos);const c=await W(e,1);return Object.assign(c,i)}async function we(e){const n=await e.exactly(2,!1);if(n[0]===U.SHA2_256&&n[1]===U.LENGTH){const c=await e.exactly(34,!0),o=G(c);return q.create(0,U.DAG_PB,o)}const t=S(await e.upTo(8),e);if(t!==1)throw new Error(`Unexpected CID version (${t})`);const a=S(await e.upTo(8),e),r=await e.exactly(pe(await e.upTo(8)),!0),i=G(r);return q.create(t,a,i)}async function K(e){const n=e.pos;let t=S(await e.upTo(8),e);if(t===0)throw new Error("Invalid CAR section (zero length)");t+=e.pos-n;const a=await we(e),r=t-Number(e.pos-n);return{cid:a,length:t,blockLength:r}}async function ve(e){const{cid:n,blockLength:t}=await K(e);return{bytes:await e.exactly(t,!0),cid:n}}async function Ce(e){const n=e.pos,{cid:t,length:a,blockLength:r}=await K(e),i={cid:t,length:a,blockLength:r,offset:n,blockOffset:e.pos};return e.seek(i.blockLength),i}function Ee(e){const n=(async()=>{const t=await W(e);if(t.version===2){const a=e.pos-t.dataOffset;e=Ae(e,t.dataSize-a)}return t})();return{header:()=>n,async*blocks(){for(await n;(await e.upTo(8)).length>0;)yield await ve(e)},async*blocksIndex(){for(await n;(await e.upTo(8)).length>0;)yield await Ce(e)}}}function Ie(e){let n=0;return{async upTo(t){return e.subarray(n,n+Math.min(t,e.length-n))},async exactly(t,a=!1){if(t>e.length-n)throw new Error("Unexpected end of data");const r=e.subarray(n,n+t);return a&&(n+=t),r},seek(t){n+=t},get pos(){return n}}}function Te(e){let n=0,t=0,a=0,r=new Uint8Array(0);const i=async c=>{t=r.length-a;const o=[r.subarray(a)];for(;t<c;){const s=await e();if(s==null)break;t<0?s.length>t&&o.push(s.subarray(-t)):o.push(s),t+=s.length}r=new Uint8Array(o.reduce((s,f)=>s+f.length,0));let d=0;for(const s of o)r.set(s,d),d+=s.length;a=0};return{async upTo(c){return r.length-a<c&&await i(c),r.subarray(a,a+Math.min(r.length-a,c))},async exactly(c,o=!1){if(r.length-a<c&&await i(c),r.length-a<c)throw new Error("Unexpected end of data");const d=r.subarray(a,a+c);return o&&(n+=c,a+=c),d},seek(c){n+=c,a+=c},get pos(){return n}}}function ke(e){const n=e[Symbol.asyncIterator]();async function t(){const a=await n.next();return a.done?null:a.value}return Te(t)}function Ae(e,n){let t=0;return{async upTo(a){let r=await e.upTo(a);return r.length+t>n&&(r=r.subarray(0,n-t)),r},async exactly(a,r=!1){const i=await e.exactly(a,r);if(i.length+t>n)throw new Error("Unexpected end of data");return r&&(t+=a),i},seek(a){t+=a,e.seek(a)},get pos(){return e.pos}}}class be{constructor(n,t,a){this._version=n,this._roots=t,this._iterable=a,this._decoded=!1}get version(){return this._version}async getRoots(){return this._roots}}class $ extends be{[Symbol.asyncIterator](){if(this._decoded)throw new Error("Cannot decode more than once");if(!this._iterable)throw new Error("Block iterable not found");return this._decoded=!0,this._iterable[Symbol.asyncIterator]()}static async fromBytes(n){const{version:t,roots:a,iterator:r}=await Re(n);return new $(t,a,r)}static async fromIterable(n){const{version:t,roots:a,iterator:r}=await xe(n);return new $(t,a,r)}}async function Re(e){if(!(e instanceof Uint8Array))throw new TypeError("fromBytes() requires a Uint8Array");return Y(Ie(e))}async function xe(e){if(!e||typeof e[Symbol.asyncIterator]!="function")throw new TypeError("fromIterable() requires an async iterable");return Y(ke(e))}async function Y(e){const n=Ee(e),{version:t,roots:a}=await n.header();return{version:t,roots:a,iterator:n.blocks()}}async function*He(e){const n=e.getReader();try{for(;;){const{done:t,value:a}=await n.read();if(t)return;yield a}}finally{n.releaseLock()}}async function Ve(e){const n=await $.fromIterable(He(e.stream())),t=[],a=[],r={};let i=null;for await(const{cid:c,bytes:o}of n){i=c.toString();const d=await de(o),{Links:s}=d;if(s.length===0){t.push(c.toString());continue}if(s.every(({Name:u})=>u==="")){a.push(c.toString());continue}const f=s.map(({Name:u,Tsize:y,Hash:g})=>({name:u,size:y,cid:g.toString()}));r[c.toString()]=f.map(u=>{const y=a.includes(u.cid)||t.includes(u.cid)?"file":"directory",g={type:y,title:u.name??`Unknown ${y}`,size:u.size??0,cid:u.cid};if(y==="directory"){const T=g.children=r[u.cid],k=T.map(({childCount:p=0})=>p);g.childCount=k.reduce((p,C)=>p+C,T.length)}return g})}if(!i)throw new Error("No nodes found.");return r[i]}async function Ne(e,n=[]){const t=le();try{const o=await c(e,structuredClone(n));return console.info(`Mounted ${o} at /${n.join("/")}/.`),o}finally{await t.close()}async function a({dirCID:o,entryCID:d,name:s}){const f=t.session();await f.run(`
      MATCH (e:IPFS { cid: $entryCID })
      MERGE (d:IPFS:Directory { cid: $dirCID })
      MERGE (d)-[c:CONTAINS]->(e)
      SET c.path = $name
    `,{dirCID:o,entryCID:d,name:s}),await f.close()}async function r({cid:o,type:d,size:s}){const f=t.session();await f.run(`
      MERGE (e:IPFS:File { cid: $cid })
      SET e.mimetype = CASE WHEN $type IS NOT NULL THEN $type END
      SET e.size = $size
    `,{cid:o,type:d,size:s}),await f.close()}async function i({path:o,cid:d}){const s=t.session(),f=`
      MERGE (r:Mount:Root)
      RETURN elementId(r) as id
    `,{records:u}=await s.run(f);let y=u[0].get("id");for(;o.length>0;){const T=`
        MATCH (p:Mount)
        WHERE elementId(p) = $next
        MERGE (p)-[:CONTAINS {path: $elem}]->(n:Mount)
        RETURN elementId(n) as id
      `,{records:k}=await s.run(T,{next:y,elem:o.shift()});y=k[0].get("id")}await s.run(`
      MATCH (m:Mount)
      WHERE elementId(m) = $next
      MATCH (i:IPFS { cid: $cid })
      MERGE (m)-[:CONNECTS {order: 1}]->(i)
    `,{next:y,cid:d}),await s.close()}async function c(o,d=[]){if(!o.children)throw new Error(`Not A Directory: ${o.title}`);for(const s of o.children)if(!(!s.selected&&s.getSelectedNodes().length===0)){if(s.children)await c(s);else{const f=(()=>{var u;switch((u=s.title.split(".").at(-1))==null?void 0:u.toLowerCase()){case"svg":return"image/svg+xml";case"png":return"image/png";case"jpg":case"jpeg":return"image/jpeg";default:return null}})();await r({cid:s.data.cid,type:f,size:s.data.size})}if(o.data.cid)await a({dirCID:o.data.cid,entryCID:s.data.cid,name:s.title});else return await i({path:d,cid:s.data.cid}),s.data.cid}return o.data.cid}}var _e=Q('<form class="svelte-o04jkh"><input placeholder="/system/mount/point/"> <button>Neo4j Import</button></form>'),Oe=Q('<header><h1>Upload a CAR File to Mïmis</h1></header> <main><form class="svelte-o04jkh"><input type="file" required accept=".car"> <button>Read CAR</button></form> <!> <div id="fs-tree" class="svelte-o04jkh"></div></main>',1);function qe(e,n){var k,p,C,A;X(n,!0);class t{constructor(){_(this,p,b());_(this,C,b(!((k=this.form)!=null&&k.checkValidity())));_(this,A,b(!1))}get form(){return w(E(this,p))}set form(l){R(E(this,p),l,!0)}get disabled(){return w(E(this,C))}set disabled(l){R(E(this,C),l,!0)}get generating(){return w(E(this,A))}set generating(l){R(E(this,A),l,!0)}}p=new WeakMap,C=new WeakMap,A=new WeakMap;let a=b(void 0),r=new t,i=b("");const c=async h=>{var N,D;h.preventDefault();const l=((N=r.form)==null?void 0:N.querySelector('input[type="file"]'))??null,m=(D=l==null?void 0:l.files)==null?void 0:D[0];if(!m)throw new Error("No file selected.");const V=await Ve(m);ue(V),R(a,fe({source:V,mount:"fs-tree"}),!0)},o=async h=>{h.preventDefault();try{r.generating=!0;const l=w(i).split("/").filter(Boolean);if(!w(a))throw new Error("No tree to mount.");const m=await Ne(w(a).root,l);he({text:`Loaded: ipfs://${m.slice(0,5)}…${m.slice(-5)}`,duration:8e3,destination:`https://w3s.link/ipfs/${m}`,newWindow:!0,close:!0,gravity:"bottom",position:"center",stopOnFocus:!0,style:{background:"linear-gradient(to right, #00b09b, #96c93d)"}}).showToast()}finally{r.generating=!1}};var d=Oe();re(h=>{ee.title="Upload a CAR"});var s=O(Z(d),2),f=L(s),u=L(f);u.__change=()=>{var h;return r.disabled=!((h=r.form)!=null&&h.checkValidity())};var y=O(u,2);M(f),se(f,h=>r.form=h,()=>r==null?void 0:r.form);var g=O(f,2);{var T=h=>{var l=_e(),m=L(l);oe(m);var V=O(m,2);M(l),z(()=>V.disabled=r.generating),F("submit",l,o),ie(m,()=>w(i),N=>R(i,N)),B(h,l)};ae(g,h=>{w(a)&&h(T)})}te(2),M(s),z(()=>y.disabled=r.disabled),F("submit",f,c),B(e,d),j()}ne(["change"]);export{qe as component};
