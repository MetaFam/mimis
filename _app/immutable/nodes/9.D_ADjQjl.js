var J=Object.defineProperty;var N=o=>{throw TypeError(o)};var Q=(o,e,t)=>e in o?J(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var d=(o,e,t)=>Q(o,typeof e!="symbol"?e+"":e,t),x=(o,e,t)=>e.has(o)||N("Cannot "+t);var U=(o,e,t)=>(x(o,e,"read from private field"),t?t.call(o):e.get(o)),j=(o,e,t)=>e.has(o)?N("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(o):e.set(o,t),G=(o,e,t,a)=>(x(o,e,"write to private field"),a?a.call(o,t):e.set(o,t),t);import"../chunks/CWj6FrbW.js";import{p as V,f as y,s as b,a as P,b as w,c as X,ai as Y,d as C,k as l,al as T,r as R,aQ as Z,t as L,ak as g}from"../chunks/DdNfpMyg.js";import{d as tt,s as M}from"../chunks/BW3j7JZm.js";import{i as W}from"../chunks/CvR87Jl7.js";import{h as et}from"../chunks/DCgJCFhG.js";import{s as I}from"../chunks/DRm78Km9.js";import{C as K,g as rt,a as at,s as st,c as ot,b as it}from"../chunks/DPegraxV.js";import{T as nt}from"../chunks/Do9QUcz1.js";import{t as ct}from"../chunks/C2mARH-o.js";import{C as lt}from"../chunks/BlhuEV3G.js";import{s as pt}from"../chunks/C7stL2V7.js";import{t as dt}from"../chunks/DYv-w5u2.js";import{m as ht,W as ut,P as $,c as bt,G as ft}from"../chunks/C_tEtCOc.js";import{c as mt}from"../chunks/7EiRJxKg.js";K.parse("bafybeiczsscdsbs7ffqz55ahobb37kkvllc4hikvjbgmsecgnuyzy4b4ga");class wt{constructor({log:e=null,batchSize:t=1e3}){d(this,"neo4j",rt());d(this,"path",[]);d(this,"log",null);d(this,"batchSize",1500);d(this,"carReadable",null);d(this,"carWritable",null);d(this,"carWriter",null);d(this,"blocks",[]);e!=null?this.log=e:pt.debugging&&(this.log=console.debug),this.batchSize=t;const{readable:a,writable:s}=new TransformStream;this.carReadable=a,this.carWritable=s,this.carWriter=s.getWriter();const i=this.blocks;this.carReadable.pipeTo(new WritableStream({write(r){i.push(r)}}))}async node(e){var a,s;const t=this.neo4j.session();if(e==null){const r=await t.run(`
        MATCH (r:Root) RETURN elementId(r) as id
      `),n=r.records.length;if(n===0)throw new Error("Couldn’t find `rootId`.");if(n>1)throw new Error(`Found ${n} \`rootId\`s.`);e=r.records[0].get("id")}if(e==null)throw new Error("Couldn’t get `rootId`.");if(this.path.includes(e))throw new Error(`Revisited ${e}. (¿Cycle found?)`,{cause:this.path});this.path.push(e);try{const i=`
        MATCH (start) WHERE elementId(start) = $rootId
        OPTIONAL MATCH (start)-[rel]->(node)
        RETURN
          labels(start) AS labels,
          properties(start) AS properties,
          [r IN collect({
            type: type(rel),
            properties: properties(rel),
            targetId: elementId(node)
          }) WHERE r.type IS NOT NULL] AS relations
      `,{records:r}=await t.run(i,{rootId:e});if((a=this.log)==null||a.call(this,`Found ${r.length} node${r.length===1?"":"s"} at ${e.split(":").at(-1)}`),r.length!==1)throw new Error(`Returned ${r.length} records.`);const[n]=r,f=[];for(const m of n.get("relations")??[])f.push({type:m.type,...m.properties,target:await this.node(m.targetId)});const E=await this.addToCAR({labels:n.get("labels"),properties:Object.fromEntries(Object.entries(n.get("properties")).map(([m,k])=>(m==="cid"&&typeof k=="string"&&(k=K.parse(k)),[m,k]))),relationships:f});return this.path.pop(),(s=this.log)==null||s.call(this,{cid:E.toString()}),E}finally{await t.close()}}async addToCAR(e){const t=at(e),a=await st.digest(t),s=K.create(1,ot,a);if(this.carWriter==null)throw new Error("No `carWriter`.");return await this.carWriter.write({cid:s,bytes:t}),s}async carURL(){var i;(i=this.log)==null||i.call(this,"Generating CAR URL…");const e=this.blocks,t=new ReadableStream({pull(r){e.length>0?r.enqueue(e.shift()):r.close()}});if(!e||e.length===0)throw new Error("No blocks generated.");const a=e.at(-1);if(!a)throw new Error("No root block found.");const s=[];return await t.pipeThrough(new lt([a.cid])).pipeTo(new WritableStream({write(r){s.push(r)}})),URL.createObjectURL(new Blob(s))}}async function gt({log:o=null,batchSize:e=1e3,rootId:t=null}){var a,s;try{const i=new wt({log:o,batchSize:e});(a=i.log)==null||a.call(i,"Exporting nodes…");const r=await i.node(t);return(s=i.log)==null||s.call(i,{rootCID:r}),{serializer:i,rootCID:r}}catch(i){throw console.error({"Graph Serializing Error":i}),i}}var S;class vt{constructor(){d(this,"networks",[ht]);d(this,"adapter",new ut({projectId:$,networks:this.networks}));d(this,"metadata",{name:"Mïmis",description:"Collaborative filesystem",url:"https://mimis.dhappy.org",icons:["https://avatars.githubusercontent.com/u/179229932"]});j(this,S,null)}get appKit(){return U(this,S)||G(this,S,bt({adapters:[this.adapter],networks:this.networks,metadata:this.metadata,projectId:$,features:{analytics:!0,swaps:!1,onramp:!1,connectMethodsOrder:["wallet","social","email"]}})),U(this,S)}async getProvider(e="eip155",{log:t}={}){await this.appKit.ready();const a=new Promise((s,i)=>{const r=this.appKit.getProvider(e);if(r)return t==null||t({"AppKit Provider":r}),s(r);this.appKit.subscribeProviders(n=>s(n[e])),this.appKit.subscribeEvents(n=>{n.data.event==="MODAL_CLOSE"&&(n.data.properties.connected||i(new Error("Modal closed without connection.")))}),this.appKit.open()});return t==null||t({"Promised Provider":a}),a}async signMessage(e,{log:t}={}){const a=await this.getProvider(void 0,{log:t});let{address:s}=this.appKit.getAccount();if(s||(s=await new Promise(i=>{this.appKit.subscribeAccount(({address:r})=>{r&&i(r)}),this.appKit.open()})),t==null||t({message:e,provider:a,address:s}),!s)throw new Error("Could not find address from provider.");return await a.request({method:"personal_sign",params:[e,s]})}}S=new WeakMap;const D=new vt,_t=async(o,e,t,a,s,i)=>{g(e,!0);try{const{rootCID:r,serializer:n}=await gt({});g(t,!0),console.debug({acct:await ft(D.adapter.wagmiConfig)});const f=await D.signMessage(r.toString(),{log:console.debug});g(t,!1),g(a,await n.addToCAR({root:r,signature:f}),!0),console.debug({final:l(a).toString(),signature:f}),g(s,await n.carURL(),!0),g(i,`mïmis.full-tree.${ct()}.car`)}catch(r){console.error({"Generation Error":r}),nt({text:r.message,duration:16e3,close:!0,gravity:"bottom",position:"center",stopOnFocus:!0,style:{background:"linear-gradient(to right, #b09b00, #96003d)"}}).showToast()}finally{g(t,!1),g(e,!1)}};var yt=y('<link rel="icon" href="radioactive%20barrel.svg"/>'),kt=y("<button><span>Generate a CAR Archive</span></button>"),At=y("<p>Generating CAR…</p>"),Ct=y("<p>Awaiting Ethereum Wallet Signature…</p>"),Rt=async(o,e)=>{if(!l(e))throw new Error("`carURL` isn’t set.");const t=console.debug,a=await mt({log:t}),s=await fetch(l(e));t==null||t(`Uploading: "${l(e)}".`),await a.uploadCAR(await s.blob()),t==null||t("Upload Complete.")},St=async(o,e)=>{if(!l(e))throw new Error("`carURL` isn’t set.");const t=console.debug,a=await it(),r=await(await(await fetch(l(e))).blob()).arrayBuffer();t==null||t(`Uploading: "${l(e)}".`),await a.dag.import([new Uint8Array(r)]),t==null||t("Upload Complete.")},Et=y('<hr class="svelte-1oslbmx"/> <a class="button"><span> </span></a> <hr class="svelte-1oslbmx"/> <button><span>Upload CAR To Storacha</span></button> <hr class="svelte-1oslbmx"/> <button><span>Upload CAR To Kubo</span></button>',1),Tt=y('<hr class="svelte-1oslbmx"/> <a class="button" target="_blank"><span>Browse <code> </code></span></a>',1),Pt=y('<heading><h1>Generate a JSON-DAG of the Graph Structure</h1></heading> <main class="svelte-1oslbmx"><!> <appkit-button></appkit-button> <!> <!></main>',3);function Ht(o,e){V(e,!0);let t=T(null),a=T(null),s=T(!1),i=T(!1),r=T("dl.car");var n=Pt();et(c=>{var p=yt();Y.title="Mïmis: Serialize",w(c,p)});var f=b(P(n),2),E=C(f);{var m=c=>{var p=kt();p.__click=[_t,s,i,t,a,r],w(c,p)},k=c=>{var p=Z(),h=P(p);{var v=u=>{var _=At();w(u,_)},A=u=>{var _=Ct();w(u,_)};W(h,u=>{l(i)?u(A,!1):u(v)})}w(c,p)};W(E,c=>{l(s)?c(k,!1):c(m)})}var q=b(E,2),O=b(q,2);{var z=c=>{var p=Et(),h=b(P(p),2),v=C(h),A=C(v);R(v),R(h);var u=b(h,4);u.__click=[Rt,a];var _=b(u,4);_.__click=[St,a],L(()=>{I(h,"href",l(a)),I(h,"download",l(r)),M(A,`Download DAG-JSON CAR: ${l(r)??""}`)}),w(c,p)};W(O,c=>{l(a)&&c(z)})}var H=b(O,2);{var B=c=>{var p=Tt(),h=b(P(p),2),v=C(h),A=b(C(v)),u=C(A);R(A),R(v),R(h),L((_,F)=>{I(h,"href",_),M(u,`ipfs://${F??""}`)},[()=>dt({cid:l(t).toString()}),()=>l(t).toString()]),w(c,p)};W(H,c=>{l(t)&&c(B)})}R(f),w(o,n),X()}tt(["click"]);export{Ht as component};
