import"../chunks/DsnmJJEf.js";import{o as $e}from"../chunks/Ckl8bskq.js";import{b2 as Ue,O as Me,y as G,P as Oe,b3 as _e,$ as Be,a0 as je,a1 as We,a2 as ge,a4 as ye,ae as re,ag as be,af as Ee,T as oe,x as Fe,W as qe,at as Te,as as Ne,aR as xe,e as Ye,a6 as Ie,a7 as ne,b4 as Ge,I as Ke,p as Qe,g as we,aw as K,aB as Q,f as d,b as i,c as Ve,k as t,ax as Ze,s as ie,d as c,az as L,b5 as Re,a as le,r as o,ay as H,t as V,aA as Je}from"../chunks/C0lYg4N8.js";import{s as B}from"../chunks/9GzlE_cd.js";import{i as Z}from"../chunks/DJx03HtA.js";import{e as ce,i as ue}from"../chunks/BznPomiX.js";import{h as Xe}from"../chunks/vHHk0yCJ.js";import{b as et,a as j}from"../chunks/CoB6fEAl.js";import{d as tt}from"../chunks/DmKVZe3W.js";import{T as at}from"../chunks/lnCFUhDM.js";import{R as Se,o as st,g as ke}from"../chunks/C4K8jg7x.js";import{m as ze}from"../chunks/4OAf_7cD.js";import{p as W}from"../chunks/BdZBV5Ue.js";import{g as rt}from"../chunks/M1RXKuGZ.js";import{s as me}from"../chunks/B0SWonas.js";import{t as de}from"../chunks/gq_7AhkF.js";const he=0,J=1,fe=2;function Ae(v,u,_,E,F){G&&Oe();var h=v,l=Ue(),T=Ye,n=ye,y,N,P,k=l?be(void 0):Ee(void 0,!1,!1),$=l?be(void 0):Ee(void 0,!1,!1),U=!1;function A(e,a){U=!0,a&&(Te(q),Ne(q),xe(T));try{e===he&&_&&(y?Ie(y):y=oe(()=>_(h))),e===J&&E&&(N?Ie(N):N=oe(()=>E(h,k))),e!==he&&y&&ne(y,()=>y=null),e!==J&&N&&ne(N,()=>N=null),e!==fe&&P&&ne(P,()=>P=null)}finally{a&&(xe(null),Ne(null),Te(null),Ge||Ke())}}var q=Me(()=>{if(n===(n=u()))return;let e=G&&_e(n)===(h.data===Be);if(e&&(h=je(),We(h),ge(!1),e=!0),_e(n)){var a=n;U=!1,a.then(s=>{a===n&&(re(k,s),A(J,!0))},s=>{if(a===n)throw re($,s),A(fe,!0),$.v}),G?_&&(y=oe(()=>_(h))):Fe(()=>{U||A(he,!0)})}else re(k,n),A(J,!1);return e&&ge(!0),()=>n=ye});G&&(h=qe)}function ot(v,u){throw new Se(v,u.toString())}function nt(v){return v instanceof Se}const Ce=async({path:v,type:u=null,limit:_=200,offset:E=0})=>{const h=rt().session();try{v=v.filter(y=>y.trim()!==""),_=parseInt(Number(_).toFixed(0)),E=parseInt(Number(E).toFixed(0)),u&&!u.includes("/")&&(u=ze.getType(u)??`unknown/${u}`);const l=v.length===0?`
        MATCH (start:Root)-[next:CONTAINS]->(child)
        RETURN [] as path, next, child
      `:`
        WITH $elems as pathElems
        MATCH path = (start:Root)-[:CONTAINS|EQUALS*]->(end)
        WITH pathElems, path, end,
            [
            rel in relationships(path)
            WHERE NOT isEmpty(rel.path)
            | rel.path
          ] as elements
        WHERE size(elements) = size(pathElems)
        AND ALL(
          i IN range(0, size(pathElems) - 1)
          WHERE (
            pathElems[i] = '*'
            OR elements[i] = pathElems[i]
          )
        )
        CALL (end) {
          MATCH (end)-[next:CONTAINS]->(child)
            RETURN next, child
          UNION DISTINCT
          MATCH (end)-[:REPRESENTED_BY]->(mediate)-[next:EMBODIED_AS]->(child${u?" { mimetype: $type }":""})
            RETURN next, child
        }
        RETURN DISTINCT
          elements AS path,
          end.mïmid as id,
          next,
          child
        SKIP $offset
        LIMIT $limit
      `,T={elems:v,type:u,limit:BigInt(_||me.limit),offset:BigInt(E)},{records:n}=await h.run(l,T);return n}finally{await h.close()}};var it=d('<link rel="icon" href="infinity%20eyes.svg"/>'),lt=d("<option> </option>"),ct=d('<select class="svelte-lozh81"></select>'),ut=d("<button><span> </span></button>"),dt=d("<span>Loading…</span>"),ht=d('<li class="svelte-lozh81"><!></li>'),ft=d('<ul id="path" class="svelte-lozh81"></ul>'),mt=d("<h2>No Results</h2>"),pt=d('<h2 class="svelte-lozh81"><a class="svelte-lozh81"><code> </code></a></h2> <object class="svelte-lozh81"><p>Could not display <a target="_blank" class="svelte-lozh81"> </a>.</p></object>',1),vt=d('<a class="button svelte-lozh81"><span> </span></a>'),_t=d('<li class="content svelte-lozh81"><!></li>'),gt=d('<ul id="result" class="svelte-lozh81"></ul>'),yt=d("<h2>Searching…</h2>"),bt=d('<main class="svelte-lozh81"><!> <section id="result" class="svelte-lozh81"><!></section></main>');function $t(v,u){Qe(u,!0);let _=null,E=null;we(()=>{_=(e=>e?Number(e):me.limit)(W.url.searchParams.get("limit")),E=Number(W.url.searchParams.get("offset"))});class F{#t;get selected(){return t(this.#t)}set selected(a){L(this.#t,a,!0)}previous;#e;constructor({selected:a,choices:s=null,previous:r=null}={}){if(!a)throw new Error("`selected` is not defined.");if(s!=null&&!s.includes(a))throw new Error("`choices` doesn’t contain `selected`.`");this.#t=K(Q(a)),this.previous=r,this.#e=K(Q(s))}get path(){return[...this.previous?.path??[],this.selected].filter(Boolean)}async choices(){if(t(this.#e)==null){const a=this.path.slice(0,-1),r=(await Ce({path:a,limit:_,offset:E})).map(g=>g.get("next").properties.path).filter(Boolean);r.length>1&&r.unshift("*"),L(this.#e,r,!0)}return t(this.#e)}}function h(e){e=e.filter(Boolean);let a=null;const s=[];for(const r of e)s.push(new F({selected:r,previous:a})),a=s.at(-1);return s}me.debugging&&console.debug({"Page Data":u.data});let l=K(Q(h(W.params.path?.split("/")??[]))),T=H(()=>t(l).map(e=>e.selected)),n=K(Q([])),y=H(async()=>{try{const e=[...t(T)];let a=null;t(T).length>0&&!W.params.path?.endsWith("/")&&([,a]=Array.from(e.at(-1)?.match(/^(.+)\.\1$/)??[]),a&&e.pop());const s=await Ce({path:e,type:a,limit:_,offset:E});if(a){const r=s.find(C=>C.get("child")?.labels.includes("File")),{cid:g}=r?.get("child")?.properties;g&&(console.debug({Redirecting:g}),window.location.href=de({cid:g}))}return s}catch(e){if(nt(e))throw ot;at({text:e.message,duration:16e3,close:!0,gravity:"bottom",position:"center",stopOnFocus:!0,style:{background:"linear-gradient(to right, #00b09b, #96c93d)"}}).showToast()}}),N=1;$e(async()=>{const e=W.url.pathname.split("/").filter(Boolean);N=e.length-t(l).length,L(n,e.slice(0,N),!0)}),st(async e=>{L(l,h(e.to?.params?.path?.split("/")??[]),!0)});const P=e=>{t(l).splice(e,1)};we(()=>{const e=a=>{if(a.key==="ArrowLeft"&&a.target===document.body)P(-1);else if(["+","-"].includes(a.key)){const s=getComputedStyle(document.documentElement).getPropertyValue("--h");let r="80dvh";if(s){const g=Number(s.replace(/\D/g,""));r=`${Math.round(Math.max(g*(a.key==="+"?1.2:.8),8))}dvh`}console.debug({current:s,next:r}),document.documentElement.style.setProperty("--h",r)}else console.debug({key:a.key})};return window.addEventListener("keydown",e),()=>{window.removeEventListener("keydown",e)}});var k=bt();Xe(e=>{var a=it();Ze.title="Mïmis: Search",i(e,a)});var $=c(k);{var U=e=>{var a=ft();ce(a,21,()=>t(l),ue,(s,r,g)=>{var C=ht(),I=c(C);Ae(I,()=>t(r).choices(),x=>{var D=dt();i(x,D)},(x,D)=>{var w=Re(),X=le(w);{var M=R=>{var b=ct();b.__input=({target:f})=>{t(r).selected=f.value,L(l,t(l).slice(0,g+1),!0),ke(`/${[...t(n),...t(T)].map(encodeURIComponent).join("/")}`)},ce(b,21,()=>t(D),ue,(f,m)=>{var p=lt(),S=c(p,!0);o(p),V(()=>{et(p,t(m)===t(r).selected),B(S,t(m))}),i(f,p)}),o(b),i(R,b)},ee=R=>{var b=ut();b.__click=p=>{L(l,t(l).slice(0,g+1),!0),ke(`/${[...t(n),...t(T)].map(encodeURIComponent).join("/")}`)};var f=c(b),m=c(f,!0);o(f),o(b),V(()=>B(m,t(r).selected)),i(R,b)};Z(X,R=>{t(D).length>1?R(M):R(ee,!1)})}i(x,w)}),o(C),i(s,C)}),o(a),i(e,a)};Z($,e=>{t(l).length>0&&e(U)})}var A=ie($,2),q=c(A);Ae(q,()=>t(y),e=>{var a=yt();i(e,a)},(e,a)=>{var s=Re(),r=le(s);{var g=I=>{var x=mt();i(I,x)},C=I=>{var x=gt();ce(x,21,()=>t(a),ue,(D,w)=>{const X=H(()=>"/"+[...t(n),...t(T)].map(encodeURIComponent).join("/"));var M=_t(),ee=c(M);{var R=f=>{const m=H(()=>{const{cid:ae,mimetype:se}=t(w).get("child")?.properties;return{cid:ae,mimetype:se}}),p=H(()=>ze.getExtension(t(m).mimetype));var S=pt(),O=le(S),z=c(O),pe=c(z),De=c(pe,!0);o(pe),o(z),o(O);var Y=ie(O,2),ve=c(Y),te=ie(c(ve)),Le=c(te);o(te),Je(),o(ve),o(Y),V((ae,se,He,Pe)=>{j(z,"href",`/browse/${ae??""}/${t(p)??""}.${t(p)??""}`),B(De,se),j(Y,"data",He),j(Y,"title",`ipfs://${t(m).cid}`),j(te,"href",Pe),B(Le,`ipfs://${t(m).cid??""}`)},[()=>t(w).get("path")?.join("/"),()=>t(w).get("path").at(-1),()=>de({cid:t(m).cid}),()=>de({cid:t(m).cid})]),i(f,S)},b=f=>{const m=H(()=>{const{path:z}=t(w).get("next").properties;return{chip:z}});var p=vt(),S=c(p),O=c(S,!0);o(S),o(p),V(z=>{j(p,"href",`${t(X)??""}/${z??""}`),B(O,t(m).chip)},[()=>encodeURIComponent(t(m).chip)]),i(f,p)};Z(ee,f=>{t(w).get("child")?.labels.includes("File")?f(R):f(b,!1)})}o(M),i(D,M)}),o(x),i(I,x)};Z(r,I=>{!t(a)||t(a).length===0?I(g):I(C,!1)})}i(e,s)}),o(A),o(k),i(v,k),Ve()}tt(["input","click"]);export{$t as component};
