import"../chunks/DsnmJJEf.js";import{p as Y,aB as Q,f as y,s as g,a as T,b as f,c as V,ax as X,d as C,k as n,aw as k,r as w,b5 as Z,t as S,az as v}from"../chunks/C0lYg4N8.js";import{s as x}from"../chunks/9GzlE_cd.js";import{i as D}from"../chunks/DJx03HtA.js";import{e as tt,i as et}from"../chunks/BznPomiX.js";import{h as at}from"../chunks/vHHk0yCJ.js";import{a as P}from"../chunks/CoB6fEAl.js";import{d as rt}from"../chunks/DmKVZe3W.js";import{C as K,c as st}from"../chunks/C6yTcgQs.js";import{T as ot}from"../chunks/lnCFUhDM.js";import{g as it,j as W,s as nt,a as ct}from"../chunks/M1RXKuGZ.js";import{s as lt}from"../chunks/B0SWonas.js";import{R as pt,g as dt}from"../chunks/DWPNOrj6.js";import{v as ht}from"../chunks/Z36B0dHS.js";import{t as ut}from"../chunks/gq_7AhkF.js";import{dp as mt,dq as gt,bx as ft,dr as bt,ds as wt,cL as I,cK as vt,cM as U,cN as yt,dt as _t,n as j}from"../chunks/DgjbO070.js";import{g as Ct,v as Et,s as At}from"../chunks/DRDJEAPC.js";import{c as Rt}from"../chunks/BqMWvxrD.js";import{l as Tt,t as kt}from"../chunks/BN8qNu6t.js";async function St(l,e){const{account:r=l.account,domain:a,message:t,primaryType:s}=e;if(!r)throw new mt({docsPath:"/docs/actions/wallet/signTypedData"});const o=gt(r),i={EIP712Domain:Ct({domain:a}),...e.types};if(Et({domain:a,message:t,primaryType:s,types:i}),o.signTypedData)return o.signTypedData({domain:a,message:t,primaryType:s,types:i});const p=At({domain:a,message:t,primaryType:s,types:i});return l.request({method:"eth_signTypedData_v4",params:[o.address,p]},{retryCount:0})}const N=ft({id:11155111,name:"Sepolia",nativeCurrency:{name:"Sepolia Ether",symbol:"ETH",decimals:18},rpcUrls:{default:{http:["https://sepolia.drpc.org"]}},blockExplorers:{default:{name:"Etherscan",url:"https://sepolia.etherscan.io",apiUrl:"https://api-sepolia.etherscan.io/api"}},contracts:{multicall3:{address:"0xca11bde05977b3631167028862be2a173976ca11",blockCreated:751532},ensUniversalResolver:{address:"0xeeeeeeee14d718c2b47d9923deab1335e144eeee",blockCreated:8928790}},testnet:!0});async function Dt(l,e){const{account:r,connector:a,...t}=e;let s;return typeof r=="object"&&r.type==="local"?s=l.getClient():s=await bt(l,{account:r,connector:a}),wt(s,St,"signTypedData")({...t,...r?{account:r}:{}})}K.parse("bafybeiczsscdsbs7ffqz55ahobb37kkvllc4hikvjbgmsecgnuyzy4b4ga");class Pt{neo4j=it();path=[];log=null;batchSize=1500;encoder=W;carReadable=null;carWritable=null;carWriter=null;blocks=[];recorder=new pt;constructor({log:e=null,batchSize:r=1e3,encoder:a=W}){e!=null?this.log=e:lt.debugging&&(this.log=console.debug),this.batchSize=r,this.encoder=a;const{readable:t,writable:s}=new TransformStream;this.carReadable=t,this.carWritable=s,this.carWriter=s.getWriter();const o=this.blocks;this.carReadable.pipeTo(new WritableStream({write(i){o.push(i)}}))}async node(e){const r=this.neo4j.session();if(e==null){const a=`
        MERGE (r:Root)
        ON CREATE SET r.mïmid = $uuid
        RETURN r.mïmid as id
      `,{records:t}=await this.recorder.exec({statement:a,params:{uuid:ht()}},{}),s=t.length;if(s===0)throw new Error("Couldn’t find `rootId`.");if(s>1)throw new Error(`Found ${s} \`rootId\`s.`);e=t[0].get("id")}if(e==null)throw new Error("Couldn’t get `rootId`.");if(this.path.includes(e))throw new Error(`Revisited ${e}. (¿Cycle found?)`,{cause:this.path});this.path.push(e);try{const a=`
        MATCH (start) WHERE start.mïmid = $rootId
        OPTIONAL MATCH (start)-[rel]->(node)
        ORDER BY rel.path
        RETURN
          labels(start) AS labels,
          properties(start) AS properties,
          [r IN collect({
            type: type(rel),
            properties: properties(rel),
            targetId: node.mïmid
          }) WHERE r.type IS NOT NULL] AS relations
      `,{records:t}=await this.recorder.exec({statement:a,params:{rootId:e}},{session:r});if(this.log?.(`Found ${t.length} node${t.length===1?"":"s"} at ${e.split(":").at(-1)}`),t.length!==1)throw new Error(`Returned ${t.length} records.`);const[s]=t,o=[];for(const p of s.get("relations")??[])o.push({type:p.type,...p.properties,target:await this.node(p.targetId)});const i=await this.addToCAR({labels:s.get("labels"),properties:Object.fromEntries(Object.entries(s.get("properties")).map(([p,m])=>(p==="cid"&&typeof m=="string"&&(m=K.parse(m)),[p,m]))),relationships:o});return this.path.pop(),this.log?.({cid:i.toString()}),i}finally{await r.close()}}async addToCAR(e){const r=this.encoder.encode(e),a=await nt.digest(r),t=K.create(1,this.encoder.code,a);if(this.carWriter==null)throw new Error("No `carWriter`.");return await this.carWriter.write({cid:t,bytes:r}),t}async generateCAR(){return dt(this.blocks)}}async function zt({log:l=null,batchSize:e=1e3,rootId:r=null}){try{const a=st,t=new Pt({log:l,batchSize:e,encoder:a});t.recorder.reset(),t.log?.(`Exporting nodes to \`${a.name}\`…`);const s=await t.node(r),o=(await t.recorder.generateCAR()).cid;return t.log?.({rootCID:s,opsCID:o}),{serializer:t,rootCID:s,opsCID:o}}catch(a){throw console.error({"Graph Serializing Error":a}),a}}class xt{networks=[I];adapter=new vt({projectId:U,networks:this.networks});metadata={name:"Mïmis",description:"Collaborative Filesystem",url:"https://mimis.dhappy.org",icons:["https://avatars.githubusercontent.com/u/179229932"]};#t=null;get appKit(){return this.#t||(this.#t=yt({adapters:[this.adapter],networks:this.networks,metadata:this.metadata,projectId:U,features:{analytics:!0,swaps:!1,onramp:!1,connectMethodsOrder:["wallet","social","email"]}})),this.#t}async getProvider(e="eip155",{log:r}={}){await this.appKit.ready();const a=new Promise((t,s)=>{const o=this.appKit.getProvider(e);if(o)return r?.({"AppKit Provider":o}),t(o);this.appKit.subscribeProviders(i=>t(i[e])),this.appKit.subscribeEvents(i=>{i.data.event==="MODAL_CLOSE"&&(i.data.properties.connected||s(new Error("Modal closed without connection.")))}),this.appKit.open()});return r?.({"Promised Provider":a}),a}async signMessage(e,{log:r}={}){const a=await this.getProvider(void 0,{log:r});let{address:t}=this.appKit.getAccount();if(t||(t=await new Promise(s=>{this.appKit.subscribeAccount(({address:o})=>{o&&s(o)}),this.appKit.open()})),r?.({message:e,provider:a,address:t}),!t)throw new Error("Could not find address from provider.");return await a.request({method:"personal_sign",params:[e,t]})}async signCID(e){const r=_t({chains:[I,N],transports:{[I.id]:j(),[N.id]:j()}});return await Dt(r,{types:{Root:[{name:"cid",type:"string"}]},primaryType:"Root",message:{cid:e}})}}const It=new xt,Kt=async(l,e,r,a,t,s,o)=>{v(e,!0);try{const i=Tt(r),{rootCID:p,serializer:m}=await zt({log:i});v(a,!0);const A=await It.signMessage(p.toString(),{log:i});v(a,!1),v(t,await m.addToCAR({root:p,signature:A}),!0),console.debug({final:n(t).toString(),signature:A}),v(s,(await m.generateCAR()).url,!0),v(o,`mïmis.full-tree.${kt()}.car`)}catch(i){console.error({"Generation Error":i}),ot({text:i.message,duration:16e3,close:!0,gravity:"bottom",position:"center",stopOnFocus:!0,style:{background:"linear-gradient(to right, #b09b00, #96003d)"}}).showToast()}finally{v(a,!1),v(e,!1)}};var Ot=y('<link rel="icon" href="radioactive%20barrel.svg"/>'),Wt=y("<button><span>Generate a CAR Archive</span></button>"),Ut=y("<li> </li>"),jt=y('<p>Generating CAR…</p> <ol class="logs" reversed></ol>',1),Nt=y("<p>Awaiting Ethereum Wallet Signature…</p>"),$t=async(l,e)=>{if(!n(e))throw new Error("`carURL` isn’t set.");const r=console.debug,a=await Rt({log:r}),t=await fetch(n(e));r?.(`Uploading: "${n(e)}".`),await a.uploadCAR(await t.blob()),r?.("Upload Complete.")},Mt=async(l,e)=>{if(!n(e))throw new Error("`carURL` isn’t set.");const r=console.debug,a=await ct(),o=await(await(await fetch(n(e))).blob()).arrayBuffer();r?.(`Uploading: "${n(e)}".`),await a.dag.import([new Uint8Array(o)]),r?.("Upload Complete.")},Gt=y('<hr class="svelte-15pzoc"/> <a class="button"><span> </span></a> <hr class="svelte-15pzoc"/> <button><span>Upload CAR To Storacha</span></button> <hr class="svelte-15pzoc"/> <button><span>Upload CAR To Kubo</span></button>',1),Ft=y('<hr class="svelte-15pzoc"/> <a class="button" target="_blank"><span>Browse <code> </code></span></a>',1),Bt=y('<heading><h1>Generate a <acronym title="Common Binary Object Representation">CBOR</acronym>-<acronym title="Directed Acyclic Graph">DAG</acronym> of the Graph Structure</h1></heading> <main class="svelte-15pzoc"><!> <appkit-button></appkit-button> <!> <!></main>',3);function pe(l,e){Y(e,!0);let r=k(null),a=k(null),t=k(!1),s=k(!1),o=k("dl.car"),i=Q([]);var p=Bt();at(c=>{var d=Ot();X.title="Mïmis: Serialize",f(c,d)});var m=g(T(p),2),A=C(m);{var $=c=>{var d=Wt();d.__click=[Kt,t,i,s,r,a,o],f(c,d)},M=c=>{var d=Z(),h=T(d);{var _=u=>{var b=jt(),R=g(T(b),2);tt(R,21,()=>i.slice(0,10),et,(L,q)=>{var z=Ut(),J=C(z,!0);w(z),S(()=>x(J,n(q))),f(L,z)}),w(R),S(()=>P(R,"start",i.length)),f(u,b)},E=u=>{var b=Nt();f(u,b)};D(h,u=>{n(s)?u(E,!1):u(_)})}f(c,d)};D(A,c=>{n(t)?c(M,!1):c($)})}var G=g(A,2),O=g(G,2);{var F=c=>{var d=Gt(),h=g(T(d),2),_=C(h),E=C(_);w(_),w(h);var u=g(h,4);u.__click=[$t,a];var b=g(u,4);b.__click=[Mt,a],S(()=>{P(h,"href",n(a)),P(h,"download",n(o)),x(E,`Download DAG-JSON CAR: ${n(o)??""}`)}),f(c,d)};D(O,c=>{n(a)&&c(F)})}var B=g(O,2);{var H=c=>{var d=Ft(),h=g(T(d),2),_=C(h),E=g(C(_)),u=C(E);w(E),w(_),w(h),S((b,R)=>{P(h,"href",b),x(u,`ipfs://${R??""}`)},[()=>ut({cid:n(r).toString()}),()=>n(r).toString()]),f(c,d)};D(B,c=>{n(r)&&c(H)})}w(m),f(l,p),V()}rt(["click"]);export{pe as component};
