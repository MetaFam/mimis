var rE=Object.defineProperty;var F3=n=>{throw TypeError(n)};var nE=(n,e,t)=>e in n?rE(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var l=(n,e,t)=>nE(n,typeof e!="symbol"?e+"":e,t),V1=(n,e,t)=>e.has(n)||F3("Cannot "+t);var A=(n,e,t)=>(V1(n,e,"read from private field"),t?t.call(n):e.get(n)),pe=(n,e,t)=>e.has(n)?F3("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,t),Ae=(n,e,t,r)=>(V1(n,e,"write to private field"),r?r.call(n,t):e.set(n,t),t),D=(n,e,t)=>(V1(n,e,"access private method"),t);var Tr=(n,e,t,r)=>({set _(i){Ae(n,e,i,t)},get _(){return A(n,e,r)}});import{G as Ht,H as Jr,I as yc,U as Ee,J as fh,K as Wt,L as me,M as Fe,N as ye,O as we,P as vr,Q as U,S as R,w as nn,C as le,o as Mr,V as ke,W as Mu,X as rl,s as ut,f as Pt,v as Zn,Y as pr,E as ds,Z as hu,_ as Cs,$ as hs,a0 as iE,j as sE,c as oE,R as j6,a1 as nl,a2 as qo,a3 as ks,A as oi,x as Bt,h as At,a4 as $3,a5 as Q6,a6 as Le,a7 as Qf,a8 as aE,a9 as cE,aa as Uu,ab as lE,ac as Y6,ad as X6,ae as Z6,af as $e,ag as z1,ah as il,ai as uE,aj as dE,ak as hE,al as Ja,am as Fu,an as fE,ao as J6,ap as H3,aq as fu,ar as ec,as as e8,at as t8,au as ph,av as Ts,aw as sl,ax as pE,ay as gE,az as mE,aA as yE,aB as wE,aC as Pp,aD as bE,aE as sr,aF as Ut,aG as pu,aH as Fi,aI as Op,aJ as V3,aK as fe,aL as gh,aM as Dp,aN as wc,aO as Np,aP as ba,aQ as Ul,aR as vE,aS as SE,y as r8,aT as EE,aU as xE,b as mh,B as Lp,aV as n8,d as cr,aW as Xs,aX as Jn,z as AE,i as dt,p as sn,e as i8,aY as kE,g as $u}from"./CXtfRil7.js";import{C as _E}from"./BWbRstIW.js";import{p as ve,i as Yf,r as IE,h as s8,v as Hu}from"./Bl4l--aQ.js";import{n as CE,q as _s,E as o8,a as Bp,F as TE,m as gu,G as z3,c as a8,I as RE,p as PE,h as ol,g as Xf,t as K3}from"./CKxxabAx.js";import{s as ai}from"./DJp8xxOB.js";import{E as OE,d as DE,_ as fs,a as Mp,b as Zf,c as Fl,f as NE,g as LE}from"./CBMopQBq.js";import{h as Up}from"./DzUzPSph.js";import{s as BE}from"./DN21MdDm.js";import{_ as g,a as ME}from"./CUM3LBRj.js";import{r as al}from"./DZQaga-d.js";import"./DErBbmgI.js";const UE=Symbol.for("@libp2p/connection"),bc=Symbol.for("@libp2p/content-routing"),Vu=Symbol.for("@libp2p/peer-discovery"),Fp=Symbol.for("@libp2p/peer-id");function _o(n){return!!(n!=null&&n[Fp])}const vc=Symbol.for("@libp2p/peer-routing"),yh="keep-alive",wh=Symbol.for("@libp2p/transport");var Sc;(function(n){n[n.FATAL_ALL=0]="FATAL_ALL",n[n.NO_FATAL=1]="NO_FATAL"})(Sc||(Sc={}));var $f;let ci=($f=class extends Error{constructor(e="The operation was aborted"){super(e),this.name="AbortError"}},l($f,"name","AbortError"),$f);class c8 extends Error{constructor(e="Unexpected Peer"){super(e),this.name="UnexpectedPeerError"}}l(c8,"name","UnexpectedPeerError");var Hf;let FE=(Hf=class extends Error{constructor(e="Invalid crypto exchange"){super(e),this.name="InvalidCryptoExchangeError"}},l(Hf,"name","InvalidCryptoExchangeError"),Hf);var Vf;let O=(Vf=class extends Error{constructor(e="Invalid parameters"){super(e),this.name="InvalidParametersError"}},l(Vf,"name","InvalidParametersError"),Vf);class Ec extends Error{constructor(e="Invalid public key"){super(e),this.name="InvalidPublicKeyError"}}l(Ec,"name","InvalidPublicKeyError");class $p extends Error{constructor(e="Invalid private key"){super(e),this.name="InvalidPrivateKeyError"}}l($p,"name","InvalidPrivateKeyError");class l8 extends Error{constructor(e="The connection is closing"){super(e),this.name="ConnectionClosingError"}}l(l8,"name","ConnectionClosingError");class Hp extends Error{constructor(e="The connection is closed"){super(e),this.name="ConnectionClosedError"}}l(Hp,"name","ConnectionClosedError");class bh extends Error{constructor(e="Connection failed"){super(e),this.name="ConnectionFailedError"}}l(bh,"name","ConnectionFailedError");class ps extends Error{constructor(e="The muxer is closed"){super(e),this.name="MuxerClosedError"}}l(ps,"name","MuxerClosedError");class u8 extends Error{constructor(e="The stream has been reset"){super(e),this.name="StreamResetError"}}l(u8,"name","StreamResetError");class zu extends Error{constructor(e="The stream is in an invalid state"){super(e),this.name="StreamStateError"}}l(zu,"name","StreamStateError");var zf;let tr=(zf=class extends Error{constructor(e="Not found"){super(e),this.name="NotFoundError"}},l(zf,"name","NotFoundError"),zf);class Vp extends Error{constructor(e="Invalid PeerID"){super(e),this.name="InvalidPeerIdError"}}l(Vp,"name","InvalidPeerIdError");class vh extends Error{constructor(e="Invalid multiaddr"){super(e),this.name="InvalidMultiaddrError"}}l(vh,"name","InvalidMultiaddrError");class d8 extends Error{constructor(e="Invalid CID"){super(e),this.name="InvalidCIDError"}}l(d8,"name","InvalidCIDError");class Sh extends Error{constructor(e="Invalid Multihash"){super(e),this.name="InvalidMultihashError"}}l(Sh,"name","InvalidMultihashError");class cl extends Error{constructor(e="Unsupported protocol error"){super(e),this.name="UnsupportedProtocolError"}}l(cl,"name","UnsupportedProtocolError");class qe extends Error{constructor(e="Invalid message"){super(e),this.name="InvalidMessageError"}}l(qe,"name","InvalidMessageError");class h8 extends Error{constructor(e="Protocol error"){super(e),this.name="ProtocolError"}}l(h8,"name","ProtocolError");var Kf;let ll=(Kf=class extends Error{constructor(e="Timed out"){super(e),this.name="TimeoutError"}},l(Kf,"name","TimeoutError"),Kf);class Rs extends Error{constructor(e="Not started"){super(e),this.name="NotStartedError"}}l(Rs,"name","NotStartedError");class Io extends Error{constructor(e="Dial error"){super(e),this.name="DialError"}}l(Io,"name","DialError");class Ku extends Error{constructor(e="Listen error"){super(e),this.name="ListenError"}}l(Ku,"name","ListenError");class Jf extends Error{constructor(e="Limited connection"){super(e),this.name="LimitedConnectionError"}}l(Jf,"name","LimitedConnectionError");class f8 extends Error{constructor(e="Too many inbound protocol streams"){super(e),this.name="TooManyInboundProtocolStreamsError"}}l(f8,"name","TooManyInboundProtocolStreamsError");class Eh extends Error{constructor(e="Too many outbound protocol streams"){super(e),this.name="TooManyOutboundProtocolStreamsError"}}l(Eh,"name","TooManyOutboundProtocolStreamsError");class Zs extends Error{constructor(e="Unsupported key type"){super(e),this.name="UnsupportedKeyTypeError"}}l(Zs,"name","UnsupportedKeyTypeError");var bn;class ot extends EventTarget{constructor(){super();pe(this,bn,new Map)}listenerCount(t){const r=A(this,bn).get(t);return r==null?0:r.length}addEventListener(t,r,i){super.addEventListener(t,r,i);let s=A(this,bn).get(t);s==null&&(s=[],A(this,bn).set(t,s)),s.push({callback:r,once:(i!==!0&&i!==!1&&(i==null?void 0:i.once))??!1})}removeEventListener(t,r,i){super.removeEventListener(t.toString(),r??null,i);let s=A(this,bn).get(t);s!=null&&(s=s.filter(({callback:o})=>o!==r),A(this,bn).set(t,s))}dispatchEvent(t){const r=super.dispatchEvent(t);let i=A(this,bn).get(t.type);return i==null||(i=i.filter(({once:s})=>!s),A(this,bn).set(t.type,i)),r}safeDispatchEvent(t,r={}){return this.dispatchEvent(new CustomEvent(t,r))}}bn=new WeakMap;function zp(n){return n!=null&&typeof n.start=="function"&&typeof n.stop=="function"}async function li(...n){const e=[];for(const t of n)zp(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStart!=null&&await t.beforeStart()})),await Promise.all(e.map(async t=>{await t.start()})),await Promise.all(e.map(async t=>{t.afterStart!=null&&await t.afterStart()}))}async function rs(...n){const e=[];for(const t of n)zp(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStop!=null&&await t.beforeStop()})),await Promise.all(e.map(async t=>{await t.stop()})),await Promise.all(e.map(async t=>{t.afterStop!=null&&await t.afterStop()}))}const kt=Symbol.for("@libp2p/service-capabilities"),Ps=Symbol.for("@libp2p/service-dependencies");class N extends Event{constructor(t,r){super(t);l(this,"type");l(this,"detail");this.type=t,this.detail=r}}class q3{constructor(e){l(this,"buffer");l(this,"mask");l(this,"top");l(this,"btm");l(this,"next");if(!(e>0)||e-1&e)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){const e=this.buffer[this.btm];if(e!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return this.buffer[this.btm]===void 0}}class K1{constructor(e={}){l(this,"size");l(this,"hwm");l(this,"head");l(this,"tail");this.hwm=e.splitLimit??16,this.head=new q3(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return(e==null?void 0:e.byteLength)!=null?e.byteLength:1}push(e){if((e==null?void 0:e.value)!=null&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){const t=this.head;this.head=t.next=new q3(2*this.head.buffer.length),this.head.push(e)}}shift(){let e=this.tail.shift();if(e===void 0&&this.tail.next!=null){const t=this.tail.next;this.tail.next=null,this.tail=t,e=this.tail.shift()}return(e==null?void 0:e.value)!=null&&(this.size-=this.calculateSize(e.value)),e}isEmpty(){return this.head.isEmpty()}}let $E=class extends Error{constructor(t,r){super(t??"The operation was aborted");l(this,"type");l(this,"code");this.type="aborted",this.code=r??"ABORT_ERR"}};function cn(n={}){return HE(t=>{const r=t.shift();if(r==null)return{done:!0};if(r.error!=null)throw r.error;return{done:r.done===!0,value:r.value}},n)}function HE(n,e){e=e??{};let t=e.onEnd,r=new K1,i,s,o,a=ve();const c=async()=>{try{return r.isEmpty()?o?{done:!0}:await new Promise((b,S)=>{s=k=>{s=null,r.push(k);try{b(n(r))}catch(C){S(C)}return i}}):n(r)}finally{r.isEmpty()&&queueMicrotask(()=>{a.resolve(),a=ve()})}},u=b=>s!=null?s(b):(r.push(b),i),d=b=>(r=new K1,s!=null?s({error:b}):(r.push({error:b}),i)),h=b=>{if(o)return i;if((e==null?void 0:e.objectMode)!==!0&&(b==null?void 0:b.byteLength)==null)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return u({done:!1,value:b})},f=b=>o?i:(o=!0,b!=null?d(b):u({done:!0})),p=()=>(r=new K1,f(),{done:!0}),m=b=>(f(b),{done:!0});if(i={[Symbol.asyncIterator](){return this},next:c,return:p,throw:m,push:h,end:f,get readableLength(){return r.size},onEmpty:async b=>{const S=b==null?void 0:b.signal;if(S==null||S.throwIfAborted(),r.isEmpty())return;let k,C;S!=null&&(k=new Promise((Q,re)=>{C=()=>{re(new $E)},S.addEventListener("abort",C)}));try{await Promise.race([a.promise,k])}finally{C!=null&&S!=null&&(S==null||S.removeEventListener("abort",C))}}},t==null)return i;const w=i;return i={[Symbol.asyncIterator](){return this},next(){return w.next()},throw(b){return w.throw(b),t!=null&&(t(b),t=void 0),{done:!0}},return(){return w.return(),t!=null&&(t(),t=void 0),{done:!0}},push:h,end(b){return w.end(b),t!=null&&(t(b),t=void 0),i},get readableLength(){return w.readableLength},onEmpty:b=>w.onEmpty(b)},i}var qf;let Wo=(qf=class extends Error{constructor(t="The operation was aborted",...r){super(t,...r);l(this,"name","AbortError")}},l(qf,"name","AbortError"),qf);async function Vt(n,e,t,r){const i=new Wo(r==null?void 0:r.errorMessage);(r==null?void 0:r.errorCode)!=null&&(i.code=r.errorCode);const s=(r==null?void 0:r.errorEvent)??"error";return(t==null?void 0:t.aborted)===!0?Promise.reject(i):new Promise((o,a)=>{function c(){W1(t,"abort",h),W1(n,e,u),W1(n,s,d)}const u=f=>{var p;try{if(((p=r==null?void 0:r.filter)==null?void 0:p.call(r,f))===!1)return}catch(m){c(),a(m);return}c(),o(f)},d=f=>{if(c(),f instanceof Error){a(f);return}a(f.detail??(r==null?void 0:r.error)??new Error(`The "${r==null?void 0:r.errorEvent}" event was emitted but the event had no '.detail' field. Pass an 'error' option to race-event to change this message.`))},h=()=>{c(),a(i)};q1(t,"abort",h),q1(n,e,u),q1(n,s,d)})}function q1(n,e,t){n!=null&&(p8(n)?n.addEventListener(e,t):n.addListener(e,t))}function W1(n,e,t){n!=null&&(p8(n)?n.removeEventListener(e,t):n.removeListener(e,t))}function p8(n){return typeof n.addEventListener=="function"&&typeof n.removeEventListener=="function"}function xc(n,e){let t;const r=function(){const i=function(){t=void 0,n()};clearTimeout(t),t=setTimeout(i,e)};return r.start=()=>{},r.stop=()=>{clearTimeout(t)},r}class VE extends Error{constructor(t="Rate limit exceeded",r){super(t);l(this,"remainingPoints");l(this,"msBeforeNext");l(this,"consumedPoints");l(this,"isFirstInDuration");this.name="RateLimitError",this.remainingPoints=r.remainingPoints,this.msBeforeNext=r.msBeforeNext,this.consumedPoints=r.consumedPoints,this.isFirstInDuration=r.isFirstInDuration}}var Wf;let zE=(Wf=class extends Error{constructor(e="The queue was full"){super(e),this.name="QueueFullError"}},l(Wf,"name","QueueFullError"),Wf),W3=class extends Error{constructor(t,r,i){super(t??"The operation was aborted");l(this,"type");l(this,"code");this.type="aborted",this.name=i??"AbortError",this.code=r??"ABORT_ERR"}};async function yt(n,e,t){if(e==null)return n;if(e.aborted)return n.catch(()=>{}),Promise.reject(new W3(t==null?void 0:t.errorMessage,t==null?void 0:t.errorCode,t==null?void 0:t.errorName));let r;const i=new W3(t==null?void 0:t.errorMessage,t==null?void 0:t.errorCode,t==null?void 0:t.errorName);try{return await Promise.race([n,new Promise((s,o)=>{r=()=>{o(i)},e.addEventListener("abort",r)})])}finally{r!=null&&e.removeEventListener("abort",r)}}let KE=class{constructor(e){l(this,"deferred");l(this,"signal");var t;this.signal=e,this.deferred=ve(),this.onAbort=this.onAbort.bind(this),(t=this.signal)==null||t.addEventListener("abort",this.onAbort)}onAbort(){var e;this.deferred.reject(((e=this.signal)==null?void 0:e.reason)??new ci)}cleanup(){var e;(e=this.signal)==null||e.removeEventListener("abort",this.onAbort)}};function qE(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}let WE=class{constructor(e,t){l(this,"id");l(this,"fn");l(this,"options");l(this,"recipients");l(this,"status");l(this,"timeline");l(this,"controller");this.id=qE(),this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce((t,r)=>{var i;return t&&((i=r.signal)==null?void 0:i.aborted)===!0},!0)&&(this.controller.abort(new ci),this.cleanup())}async join(e={}){var r;const t=new KE(e.signal);return this.recipients.push(t),(r=e.signal)==null||r.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();const e=await yt(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(t=>{t.deferred.resolve(e)}),this.status="complete"}catch(e){this.recipients.forEach(t=>{t.deferred.reject(e)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(e=>{var t;e.cleanup(),(t=e.signal)==null||t.removeEventListener("abort",this.onAbort)})}},Wi=class extends ot{constructor(t={}){var r;super();l(this,"concurrency");l(this,"maxSize");l(this,"queue");l(this,"pending");l(this,"sort");this.concurrency=t.concurrency??Number.POSITIVE_INFINITY,this.maxSize=t.maxSize??Number.POSITIVE_INFINITY,this.pending=0,t.metricName!=null&&((r=t.metrics)==null||r.registerMetricGroup(t.metricName,{calculate:()=>({size:this.queue.length,running:this.pending,queued:this.queue.length-this.pending})})),this.sort=t.sort,this.queue=[],this.emitEmpty=xc(this.emitEmpty.bind(this),1),this.emitIdle=xc(this.emitIdle.bind(this),1)}emitEmpty(){this.size===0&&this.safeDispatchEvent("empty")}emitIdle(){this.running===0&&this.safeDispatchEvent("idle")}tryToStartAnother(){if(this.size===0)return this.emitEmpty(),this.running===0&&this.emitIdle(),!1;if(this.pending<this.concurrency){let t;for(const r of this.queue)if(r.status==="queued"){t=r;break}return t==null?!1:(this.safeDispatchEvent("active"),this.pending++,t.run().finally(()=>{for(let r=0;r<this.queue.length;r++)if(this.queue[r]===t){this.queue.splice(r,1);break}this.pending--,this.tryToStartAnother(),this.safeDispatchEvent("next")}),!0)}return!1}enqueue(t){this.queue.push(t),this.sort!=null&&this.queue.sort(this.sort)}async add(t,r){var s;if((s=r==null?void 0:r.signal)==null||s.throwIfAborted(),this.size===this.maxSize)throw new zE;const i=new WE(t,r);return this.enqueue(i),this.safeDispatchEvent("add"),this.tryToStartAnother(),i.join(r).then(o=>(this.safeDispatchEvent("completed",{detail:o}),this.safeDispatchEvent("success",{detail:{job:i,result:o}}),o)).catch(o=>{if(i.status==="queued"){for(let a=0;a<this.queue.length;a++)if(this.queue[a]===i){this.queue.splice(a,1);break}}throw this.safeDispatchEvent("failure",{detail:{job:i,error:o}}),o})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(t=>{t.abort(new ci)}),this.clear()}async onEmpty(t){this.size!==0&&await Vt(this,"empty",t==null?void 0:t.signal)}async onSizeLessThan(t,r){this.size<t||await Vt(this,"next",r==null?void 0:r.signal,{filter:()=>this.size<t})}async onIdle(t){this.pending===0&&this.size===0||await Vt(this,"idle",t==null?void 0:t.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(t){var u,d,h;(u=t==null?void 0:t.signal)==null||u.throwIfAborted();const r=cn({objectMode:!0}),i=f=>{f!=null?this.abort():this.clear(),r.end(f)},s=f=>{f.detail!=null&&r.push(f.detail)},o=f=>{i(f.detail.error)},a=()=>{i()},c=()=>{i(new ci("Queue aborted"))};this.addEventListener("completed",s),this.addEventListener("failure",o),this.addEventListener("idle",a),(d=t==null?void 0:t.signal)==null||d.addEventListener("abort",c);try{yield*r}finally{this.removeEventListener("completed",s),this.removeEventListener("failure",o),this.removeEventListener("idle",a),(h=t==null?void 0:t.signal)==null||h.removeEventListener("abort",c),i()}}};class Gi extends Wi{has(e){return this.find(e)!=null}find(e){return this.queue.find(t=>e.equals(t.options.peerId))}}function GE(n){return n[Symbol.asyncIterator]!=null}function ui(n){if(GE(n))return(async()=>{for await(const e of n);})();for(const e of n);}const jE=8,Kp=1024*1024*4;let QE=class extends Error{constructor(){super(...arguments);l(this,"name","InvalidMessageLengthError");l(this,"code","ERR_INVALID_MSG_LENGTH")}},g8=class extends Error{constructor(){super(...arguments);l(this,"name","InvalidDataLengthError");l(this,"code","ERR_MSG_DATA_TOO_LONG")}},YE=class extends Error{constructor(){super(...arguments);l(this,"name","InvalidDataLengthLengthError");l(this,"code","ERR_MSG_LENGTH_TOO_LONG")}},G3=class extends Error{constructor(){super(...arguments);l(this,"name","UnexpectedEOFError");l(this,"code","ERR_UNEXPECTED_EOF")}};function m8(n){return n[Symbol.asyncIterator]!=null}function y8(n,e){if(n.byteLength>e)throw new g8("Message length too long")}const xh=n=>{const e=Ht(n),t=yc(e);return Jr(n,t),xh.bytes=e,t};xh.bytes=0;function Ac(n,e){e=e??{};const t=e.lengthEncoder??xh,r=(e==null?void 0:e.maxDataLength)??Kp;function*i(s){y8(s,r);const o=t(s.byteLength);o instanceof Uint8Array?yield o:yield*o,s instanceof Uint8Array?yield s:yield*s}return m8(n)?async function*(){for await(const s of n)yield*i(s)}():function*(){for(const s of n)yield*i(s)}()}Ac.single=(n,e)=>{e=e??{};const t=e.lengthEncoder??xh,r=(e==null?void 0:e.maxDataLength)??Kp;return y8(n,r),new Ee(t(n.byteLength),n)};var gs;(function(n){n[n.LENGTH=0]="LENGTH",n[n.DATA=1]="DATA"})(gs||(gs={}));const qp=n=>{const e=fh(n);return qp.bytes=Ht(e),e};qp.bytes=0;function kc(n,e){const t=new Ee;let r=gs.LENGTH,i=-1;const s=(e==null?void 0:e.lengthDecoder)??qp,o=(e==null?void 0:e.maxLengthLength)??jE,a=(e==null?void 0:e.maxDataLength)??Kp;function*c(){for(;t.byteLength>0;){if(r===gs.LENGTH)try{if(i=s(t),i<0)throw new QE("Invalid message length");if(i>a)throw new g8("Message length too long");const u=s.bytes;t.consume(u),(e==null?void 0:e.onLength)!=null&&e.onLength(i),r=gs.DATA}catch(u){if(u instanceof RangeError){if(t.byteLength>o)throw new YE("Message length length too long");break}throw u}if(r===gs.DATA){if(t.byteLength<i)break;const u=t.sublist(0,i);t.consume(i),(e==null?void 0:e.onData)!=null&&e.onData(u),yield u,r=gs.LENGTH}}}return m8(n)?async function*(){for await(const u of n)t.append(u),yield*c();if(t.byteLength>0)throw new G3("Unexpected end of input")}():function*(){for(const u of n)t.append(u),yield*c();if(t.byteLength>0)throw new G3("Unexpected end of input")}()}kc.fromReader=(n,e)=>{let t=1;const r=async function*(){for(;;)try{const{done:s,value:o}=await n.next(t);if(s===!0)return;o!=null&&(yield o)}catch(s){if(s.code==="ERR_UNDER_READ")return{done:!0,value:null};throw s}finally{t=1}}();return kc(r,{...e??{},onLength:s=>{t=s}})};class XE{constructor(){l(this,"readNext");l(this,"haveNext");l(this,"ended");l(this,"nextResult");l(this,"error");this.ended=!1,this.readNext=ve(),this.haveNext=ve()}[Symbol.asyncIterator](){return this}async next(){if(this.nextResult==null&&await this.haveNext.promise,this.nextResult==null)throw new Error("HaveNext promise resolved but nextResult was undefined");const e=this.nextResult;return this.nextResult=void 0,this.readNext.resolve(),this.readNext=ve(),e}async throw(e){return this.ended=!0,this.error=e,e!=null&&(this.haveNext.promise.catch(()=>{}),this.haveNext.reject(e)),{done:!0,value:void 0}}async return(){const e={done:!0,value:void 0};return this.ended=!0,this.nextResult=e,this.haveNext.resolve(),e}async push(e,t){await this._push(e,t)}async end(e,t){e!=null?await this.throw(e):await this._push(void 0,t)}async _push(e,t){if(e!=null&&this.ended)throw this.error??new Error("Cannot push value onto an ended pushable");for(;this.nextResult!=null;)await this.readNext.promise;e!=null?this.nextResult={done:!1,value:e}:(this.ended=!0,this.nextResult={done:!0,value:void 0}),this.haveNext.resolve(),this.haveNext=ve(),await yt(this.readNext.promise,t==null?void 0:t.signal,t)}}function w8(){return new XE}function ZE(n){return n[Symbol.asyncIterator]!=null}async function JE(n,e,t){try{await Promise.all(n.map(async r=>{for await(const i of r)await e.push(i,{signal:t}),t.throwIfAborted()})),await e.end(void 0,{signal:t})}catch(r){await e.end(r,{signal:t}).catch(()=>{})}}async function*ex(n){const e=new AbortController,t=w8();JE(n,t,e.signal).catch(()=>{});try{yield*t}finally{e.abort()}}function*tx(n){for(const e of n)yield*e}function $i(...n){const e=[];for(const t of n)ZE(t)||e.push(t);return e.length===n.length?tx(e):ex(n)}function _t(n,...e){if(n==null)throw new Error("Empty pipeline");if(G1(n)){const r=n;n=()=>r.source}else if(v8(n)||b8(n)){const r=n;n=()=>r}const t=[n,...e];if(t.length>1&&G1(t[t.length-1])&&(t[t.length-1]=t[t.length-1].sink),t.length>2)for(let r=1;r<t.length-1;r++)G1(t[r])&&(t[r]=nx(t[r]));return rx(...t)}const rx=(...n)=>{let e;for(;n.length>0;)e=n.shift()(e);return e},b8=n=>(n==null?void 0:n[Symbol.asyncIterator])!=null,v8=n=>(n==null?void 0:n[Symbol.iterator])!=null,G1=n=>n==null?!1:n.sink!=null&&n.source!=null,nx=n=>e=>{const t=n.sink(e);if((t==null?void 0:t.then)!=null){const r=cn({objectMode:!0});t.then(()=>{r.end()},o=>{r.end(o)});let i;const s=n.source;if(b8(s))i=async function*(){yield*s,r.end()};else if(v8(s))i=function*(){yield*s,r.end()};else throw new Error("Unknown duplex source type - must be Iterable or AsyncIterable");return $i(r,i())}return n.source};function ix(n){return n[Symbol.asyncIterator]!=null}function qu(n,e){return ix(n)?async function*(){let t=0;if(!(e<1)){for await(const r of n)if(yield r,t++,t===e)return}}():function*(){let t=0;if(!(e<1)){for(const r of n)if(yield r,t++,t===e)return}}()}const $l="/ipfs/bitswap/1.2.0",sx=1024,ox=1024,ax=1024,cx=5e3,lx=10,ux=50,dx=!1,hx=3,S8=1024*1024*4,fx=S8;class It extends Error{constructor(){super(...arguments);l(this,"code","ERR_MAX_LENGTH");l(this,"name","MaxLengthError")}}class j3 extends Error{constructor(){super(...arguments);l(this,"code","ERR_MAX_SIZE");l(this,"name","MaxSizeError")}}var mt;(function(n){n.WantBlock="WantBlock",n.WantHave="WantHave"})(mt||(mt={}));var e0;(function(n){n[n.WantBlock=0]="WantBlock",n[n.WantHave=1]="WantHave"})(e0||(e0={}));(function(n){n.codec=()=>Wt(e0)})(mt||(mt={}));var _c;(function(n){let e;n.codec=()=>(e==null&&(e=me((t,r,i={})=>{i.lengthDelimited!==!1&&r.fork(),t.cid!=null&&t.cid.byteLength>0&&(r.uint32(10),r.bytes(t.cid)),t.priority!=null&&t.priority!==0&&(r.uint32(16),r.int32(t.priority)),t.cancel!=null&&(r.uint32(24),r.bool(t.cancel)),t.wantType!=null&&(r.uint32(32),mt.codec().encode(t.wantType,r)),t.sendDontHave!=null&&(r.uint32(40),r.bool(t.sendDontHave)),i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{const s={cid:Fe(0),priority:0},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.cid=t.bytes();break}case 2:{s.priority=t.int32();break}case 3:{s.cancel=t.bool();break}case 4:{s.wantType=mt.codec().decode(t);break}case 5:{s.sendDontHave=t.bool();break}default:{t.skipType(a&7);break}}}return s})),e),n.encode=t=>ye(t,n.codec()),n.decode=(t,r)=>we(t,n.codec(),r)})(_c||(_c={}));var Wu;(function(n){let e;n.codec=()=>(e==null&&(e=me((t,r,i={})=>{if(i.lengthDelimited!==!1&&r.fork(),t.entries!=null)for(const s of t.entries)r.uint32(10),_c.codec().encode(s,r);t.full!=null&&(r.uint32(16),r.bool(t.full)),i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{var a,c;const s={entries:[]},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const u=t.uint32();switch(u>>>3){case 1:{if(((a=i.limits)==null?void 0:a.entries)!=null&&s.entries.length===i.limits.entries)throw new It('Decode error - map field "entries" had too many elements');s.entries.push(_c.codec().decode(t,t.uint32(),{limits:(c=i.limits)==null?void 0:c.entries$}));break}case 2:{s.full=t.bool();break}default:{t.skipType(u&7);break}}}return s})),e),n.encode=t=>ye(t,n.codec()),n.decode=(t,r)=>we(t,n.codec(),r)})(Wu||(Wu={}));var Ic;(function(n){let e;n.codec=()=>(e==null&&(e=me((t,r,i={})=>{i.lengthDelimited!==!1&&r.fork(),t.prefix!=null&&t.prefix.byteLength>0&&(r.uint32(10),r.bytes(t.prefix)),t.data!=null&&t.data.byteLength>0&&(r.uint32(18),r.bytes(t.data)),i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{const s={prefix:Fe(0),data:Fe(0)},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.prefix=t.bytes();break}case 2:{s.data=t.bytes();break}default:{t.skipType(a&7);break}}}return s})),e),n.encode=t=>ye(t,n.codec()),n.decode=(t,r)=>we(t,n.codec(),r)})(Ic||(Ic={}));var En;(function(n){n.HaveBlock="HaveBlock",n.DoNotHaveBlock="DoNotHaveBlock"})(En||(En={}));var Gu;(function(n){n[n.HaveBlock=0]="HaveBlock",n[n.DoNotHaveBlock=1]="DoNotHaveBlock"})(Gu||(Gu={}));(function(n){n.codec=()=>Wt(Gu)})(En||(En={}));var Cc;(function(n){let e;n.codec=()=>(e==null&&(e=me((t,r,i={})=>{i.lengthDelimited!==!1&&r.fork(),t.cid!=null&&t.cid.byteLength>0&&(r.uint32(10),r.bytes(t.cid)),t.type!=null&&Gu[t.type]!==0&&(r.uint32(16),En.codec().encode(t.type,r)),i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{const s={cid:Fe(0),type:En.HaveBlock},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.cid=t.bytes();break}case 2:{s.type=En.codec().decode(t);break}default:{t.skipType(a&7);break}}}return s})),e),n.encode=t=>ye(t,n.codec()),n.decode=(t,r)=>we(t,n.codec(),r)})(Cc||(Cc={}));var Tc;(function(n){let e;n.codec=()=>(e==null&&(e=me((t,r,i={})=>{if(i.lengthDelimited!==!1&&r.fork(),t.wantlist!=null&&(r.uint32(10),Wu.codec().encode(t.wantlist,r)),t.blocks!=null)for(const s of t.blocks)r.uint32(26),Ic.codec().encode(s,r);if(t.blockPresences!=null)for(const s of t.blockPresences)r.uint32(34),Cc.codec().encode(s,r);t.pendingBytes!=null&&t.pendingBytes!==0&&(r.uint32(40),r.int32(t.pendingBytes)),i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{var a,c,u,d,h;const s={blocks:[],blockPresences:[],pendingBytes:0},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const f=t.uint32();switch(f>>>3){case 1:{s.wantlist=Wu.codec().decode(t,t.uint32(),{limits:(a=i.limits)==null?void 0:a.wantlist});break}case 3:{if(((c=i.limits)==null?void 0:c.blocks)!=null&&s.blocks.length===i.limits.blocks)throw new It('Decode error - map field "blocks" had too many elements');s.blocks.push(Ic.codec().decode(t,t.uint32(),{limits:(u=i.limits)==null?void 0:u.blocks$}));break}case 4:{if(((d=i.limits)==null?void 0:d.blockPresences)!=null&&s.blockPresences.length===i.limits.blockPresences)throw new It('Decode error - map field "blockPresences" had too many elements');s.blockPresences.push(Cc.codec().decode(t,t.uint32(),{limits:(h=i.limits)==null?void 0:h.blockPresences$}));break}case 5:{s.pendingBytes=t.int32();break}default:{t.skipType(f&7);break}}}return s})),e),n.encode=t=>ye(t,n.codec()),n.decode=(t,r)=>we(t,n.codec(),r)})(Tc||(Tc={}));function px(n,e){for(const[t,r]of e.wantlist.entries()){const i=n.wantlist.get(t);i!=null&&(i.priority>r.priority&&(r.priority=i.priority),r.cancel=r.cancel??i.cancel,r.wantType=r.wantType??i.wantType,r.sendDontHave=r.sendDontHave??i.sendDontHave),n.wantlist.set(t,r)}for(const[t,r]of e.blockPresences.entries())n.blockPresences.set(t,r);for(const[t,r]of e.blocks.entries())n.blocks.set(t,r);return e.full&&!n.full&&(n.full=!0),n}class E8 extends Error{constructor(e="Block too large"){super(e),this.name="BlockTooLargeError"}}l(E8,"name","BlockTooLargeError");const gx=4193648,mx=gx+16;function*yx(n,e){const t=[...n.wantlist.values()],r=[...n.blockPresences.values()],i=[...n.blocks.values()];let s=0,o=0,a=0,c=!1;for(;;){const u={wantlist:{full:n.full??!1,entries:[]},blockPresences:[],blocks:[],pendingBytes:0};let d=Tc.encode(u).byteLength,{added:h,hasMore:f,newSize:p}=j1(i,u.blocks,a,e,d,wx);a+=h,d=p;const m=f;({added:h,hasMore:f,newSize:p}=j1(r,u.blockPresences,o,e,d,bx)),o+=h,d=p;const w=f;if({added:h,hasMore:f,newSize:p}=j1(t,u.wantlist.entries,s,e,d,vx),s+=h,d=p,c=!m&&!w&&!f,c||(u.wantlist.full=!1),yield Tc.encode(u),c)break}}function j1(n,e,t,r,i,s){let o=0,a=!1;for(let c=t;c<n.length;c++){const u=n[c],d=s(u);if(d>mx)throw new E8("Cannot send block as after encoding it is over the max message size");const h=i+d;if(h>r){a=!0;break}e.push(u),o++,i=h}return{hasMore:a,added:o,newSize:i}}function wx(n){return Wp(3,Ic.encode(n))}function bx(n){return Wp(4,Cc.encode(n))}function vx(n){return Wp(1,_c.encode(n))}function Wp(n,e){const t=Ht(n),r=Ht(e.byteLength);return t+r+e.byteLength}let Sx=class extends ot{constructor(t,r={}){var i,s;super();l(this,"log");l(this,"libp2p");l(this,"routing");l(this,"protocols");l(this,"running");l(this,"maxInboundStreams");l(this,"maxOutboundStreams");l(this,"messageReceiveTimeout");l(this,"registrarIds");l(this,"metrics");l(this,"sendQueue");l(this,"runOnLimitedConnections");l(this,"maxOutgoingMessageSize");l(this,"maxIncomingMessageSize");this.log=t.logger.forComponent("helia:bitswap:network"),this.libp2p=t.libp2p,this.routing=t.routing,this.protocols=r.protocols??[$l],this.registrarIds=[],this.running=!1,this._onStream=this._onStream.bind(this),this.maxInboundStreams=r.maxInboundStreams??ox,this.maxOutboundStreams=r.maxOutboundStreams??ax,this.messageReceiveTimeout=r.messageReceiveTimeout??cx,this.runOnLimitedConnections=r.runOnLimitedConnections??dx,this.maxIncomingMessageSize=r.maxIncomingMessageSize??S8,this.maxOutgoingMessageSize=r.maxOutgoingMessageSize??r.maxIncomingMessageSize??fx,this.metrics={blocksSent:(i=t.metrics)==null?void 0:i.registerCounter("helia_bitswap_sent_blocks_total"),dataSent:(s=t.metrics)==null?void 0:s.registerCounter("helia_bitswap_sent_data_bytes_total")},this.sendQueue=new Gi({concurrency:r.messageSendConcurrency??ux,metrics:t.metrics,metricName:"helia_bitswap_message_send_queue"}),this.sendQueue.addEventListener("error",o=>{this.log.error("error sending wantlist to peer",o.detail)})}async start(){if(this.running)return;this.running=!0,await this.libp2p.handle(this.protocols,this._onStream,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnections});const t={onConnect:r=>{this.safeDispatchEvent("peer:connected",{detail:r})},onDisconnect:r=>{this.safeDispatchEvent("peer:disconnected",{detail:r})}};this.registrarIds=[];for(const r of this.protocols)this.registrarIds.push(await this.libp2p.register(r,t));this.libp2p.getConnections().forEach(r=>{this.safeDispatchEvent("peer:connected",{detail:r.remotePeer})})}async stop(){if(this.running=!1,await this.libp2p.unhandle(this.protocols),this.registrarIds!=null){for(const t of this.registrarIds)this.libp2p.unregister(t);this.registrarIds=[]}}_onStream(t){if(!this.running)return;const{stream:r,connection:i}=t;Promise.resolve().then(async()=>{this.log("incoming new bitswap %s stream from %p",r.protocol,i.remotePeer);const s=()=>{r.status==="open"?r.abort(new ll(`Incoming Bitswap stream timed out after ${this.messageReceiveTimeout}ms`)):this.log("stream aborted with status %s",r.status)};let o=AbortSignal.timeout(this.messageReceiveTimeout);o.addEventListener("abort",s),await r.closeWrite(),await _t(r,a=>kc(a,{maxDataLength:this.maxIncomingMessageSize}),async a=>{for await(const c of a)try{const u=Tc.decode(c);this.log("incoming new bitswap %s message from %p on stream",r.protocol,i.remotePeer,r.id),this.safeDispatchEvent("bitswap:message",{detail:{peer:i.remotePeer,message:u}}),o.removeEventListener("abort",s),o=AbortSignal.timeout(this.messageReceiveTimeout),o.addEventListener("abort",s)}catch(u){this.log.error("error reading incoming bitswap message from %p on stream",i.remotePeer,r.id,u),r.abort(u);break}})}).catch(s=>{this.log.error("error handling incoming stream from %p",i.remotePeer,s),r.abort(s)})}async*findProviders(t,r){var i;(i=r==null?void 0:r.onProgress)==null||i.call(r,new N("bitswap:network:find-providers",t));for await(const s of this.routing.findProviders(t,r))await this.libp2p.isDialable(s.multiaddrs,{runOnLimitedConnection:this.runOnLimitedConnections})&&(yield s)}async findAndConnect(t,r){(r==null?void 0:r.providers)!=null&&await Promise.all(r.providers.map(async i=>this.connectTo(i).catch(s=>{this.log.error("could not connect to supplied provider - %e",s)}))),await ui(vr(qu(this.findProviders(t,r),(r==null?void 0:r.maxProviders)??hx),async i=>this.connectTo(i.id,r))).catch(i=>{this.log.error(i)})}async sendMessage(t,r,i){if(!this.running)throw new Error("network isn't running");const s=this.sendQueue.queue.find(o=>t.equals(o.options.peerId)&&o.status==="queued");if(s!=null){s.options.message=px(s.options.message,r),await s.join({signal:i==null?void 0:i.signal});return}await this.sendQueue.add(async o=>{var u,d;const a=o==null?void 0:o.message;if(a==null)throw new O("No message to send");this.log("sendMessage to %p",t),(u=o==null?void 0:o.onProgress)==null||u.call(o,new N("bitswap:network:send-wantlist",t));const c=await this.libp2p.dialProtocol(t,$l,o);await c.closeRead();try{await _t(yx(a,this.maxOutgoingMessageSize),h=>Ac(h),c),await c.close(o)}catch(h){(d=o==null?void 0:o.onProgress)==null||d.call(o,new N("bitswap:network:send-wantlist:error",{peer:t,error:h})),this.log.error("error sending message to %p",t,h),c.abort(h)}this._updateSentStats(a.blocks)},{peerId:t,signal:i==null?void 0:i.signal,message:r})}async connectTo(t,r){var s;if(!this.running)throw new Rs("Network isn't running");(s=r==null?void 0:r.onProgress)==null||s.call(r,new N("bitswap:network:dial",t));const[i]=await Promise.all([this.libp2p.dial(t,r),Vt(this.libp2p,"peer:identify",r==null?void 0:r.signal,{filter:o=>{if(!o.detail.peerId.equals(t))return!1;if(o.detail.protocols.includes($l))return!0;throw new cl(`${t} did not support ${$l}`)}})]);return i}_updateSentStats(t){var i,s;let r=0;for(const o of t.values())r+=o.data.byteLength;(i=this.metrics.dataSent)==null||i.increment(r),(s=this.metrics.blocksSent)==null||s.increment(t.size)}};const Ex=parseInt("11111",2),t0=parseInt("10000000",2),xx=parseInt("01111111",2),Q3={0:Ma,1:Ma,2:Ax,3:Ix,4:Cx,5:_x,6:kx,16:Ma,22:Ma,48:Ma};function Js(n,e={offset:0}){const t=n[e.offset]&Ex;if(e.offset++,Q3[t]!=null)return Q3[t](n,e);throw new Error("No decoder for tag "+t)}function ul(n,e){let t=0;if((n[e.offset]&t0)===t0){const r=n[e.offset]&xx;let i="0x";e.offset++;for(let s=0;s<r;s++,e.offset++)i+=n[e.offset].toString(16).padStart(2,"0");t=parseInt(i,16)}else t=n[e.offset],e.offset++;return t}function Ma(n,e){ul(n,e);const t=[];for(;!(e.offset>=n.byteLength);){const r=Js(n,e);if(r===null)break;t.push(r)}return t}function Ax(n,e){const t=ul(n,e),r=e.offset,i=e.offset+t,s=[];for(let o=r;o<i;o++)o===r&&n[o]===0||s.push(n[o]);return e.offset+=t,Uint8Array.from(s)}function kx(n,e){const t=ul(n,e),r=e.offset+t,i=n[e.offset];e.offset++;let s=0,o=0;i<40?(s=0,o=i):i<80?(s=1,o=i-40):(s=2,o=i-80);let a=`${s}.${o}`,c=[];for(;e.offset<r;){const u=n[e.offset];if(e.offset++,c.push(u&127),u<128){c.reverse();let d=0;for(let h=0;h<c.length;h++)d+=c[h]<<h*7;a+=`.${d}`,c=[]}}return a}function _x(n,e){return e.offset++,null}function Ix(n,e){const t=ul(n,e),r=n[e.offset];e.offset++;const i=n.subarray(e.offset,e.offset+t-1);if(e.offset+=t,r!==0)throw new Error("Unused bits in bit string is unimplemented");return i}function Cx(n,e){const t=ul(n,e),r=n.subarray(e.offset,e.offset+t);return e.offset+=t,r}function Tx(n){let e=n.toString(16);e.length%2===1&&(e="0"+e);const t=new Ee;for(let r=0;r<e.length;r+=2)t.append(Uint8Array.from([parseInt(`${e[r]}${e[r+1]}`,16)]));return t}function Ah(n){if(n.byteLength<128)return Uint8Array.from([n.byteLength]);const e=Tx(n.byteLength);return new Ee(Uint8Array.from([e.byteLength|t0]),e)}function dr(n){const e=new Ee,t=128;return(n.subarray()[0]&t)===t&&e.append(Uint8Array.from([0])),e.append(n),new Ee(Uint8Array.from([2]),Ah(e),e)}function Gp(n){const e=Uint8Array.from([0]),t=new Ee(e,n);return new Ee(Uint8Array.from([3]),Ah(t),t)}function Rx(n){return new Ee(Uint8Array.from([4]),Ah(n),n)}function ei(n,e=48){const t=new Ee;for(const r of n)t.append(r);return new Ee(Uint8Array.from([e]),Ah(t),t)}const Px="1.2.840.10045.3.1.7",Ox="1.3.132.0.34",Dx="1.3.132.0.35";async function Nx(n="P-256"){const e=await crypto.subtle.generateKey({name:"ECDSA",namedCurve:n},!0,["sign","verify"]);return{publicKey:await crypto.subtle.exportKey("jwk",e.publicKey),privateKey:await crypto.subtle.exportKey("jwk",e.privateKey)}}async function Lx(n,e,t){var s,o;const r=await crypto.subtle.importKey("jwk",n,{name:"ECDSA",namedCurve:n.crv??"P-256"},!1,["sign"]);(s=t==null?void 0:t.signal)==null||s.throwIfAborted();const i=await crypto.subtle.sign({name:"ECDSA",hash:{name:"SHA-256"}},r,e.subarray());return(o=t==null?void 0:t.signal)==null||o.throwIfAborted(),new Uint8Array(i,0,i.byteLength)}async function Bx(n,e,t,r){var o,a;const i=await crypto.subtle.importKey("jwk",n,{name:"ECDSA",namedCurve:n.crv??"P-256"},!1,["verify"]);(o=r==null?void 0:r.signal)==null||o.throwIfAborted();const s=await crypto.subtle.verify({name:"ECDSA",hash:{name:"SHA-256"}},i,e,t.subarray());return(a=r==null?void 0:r.signal)==null||a.throwIfAborted(),s}const Mx=Uint8Array.from([6,8,42,134,72,206,61,3,1,7]),Ux=Uint8Array.from([6,5,43,129,4,0,34]),Fx=Uint8Array.from([6,5,43,129,4,0,35]),x8={ext:!0,kty:"EC",crv:"P-256"},A8={ext:!0,kty:"EC",crv:"P-384"},k8={ext:!0,kty:"EC",crv:"P-521"},Co=32,To=48,Ro=66;function $x(n){const e=Js(n);return _8(e)}function _8(n){const e=n[1],t=U(e,"base64url"),r=n[2][1][0],i=1;let s,o;if(e.byteLength===Co)return s=U(r.subarray(i,i+Co),"base64url"),o=U(r.subarray(i+Co),"base64url"),new yu({...x8,key_ops:["sign"],d:t,x:s,y:o});if(e.byteLength===To)return s=U(r.subarray(i,i+To),"base64url"),o=U(r.subarray(i+To),"base64url"),new yu({...A8,key_ops:["sign"],d:t,x:s,y:o});if(e.byteLength===Ro)return s=U(r.subarray(i,i+Ro),"base64url"),o=U(r.subarray(i+Ro),"base64url"),new yu({...k8,key_ops:["sign"],d:t,x:s,y:o});throw new O(`Private key length was wrong length, got ${e.byteLength}, expected 32, 48 or 66`)}function I8(n){const e=Js(n);return Hx(e)}function Hx(n){const e=n[1][1][0],t=1;let r,i;if(e.byteLength===Co*2+1)return r=U(e.subarray(t,t+Co),"base64url"),i=U(e.subarray(t+Co),"base64url"),new mu({...x8,key_ops:["verify"],x:r,y:i});if(e.byteLength===To*2+1)return r=U(e.subarray(t,t+To),"base64url"),i=U(e.subarray(t+To),"base64url"),new mu({...A8,key_ops:["verify"],x:r,y:i});if(e.byteLength===Ro*2+1)return r=U(e.subarray(t,t+Ro),"base64url"),i=U(e.subarray(t+Ro),"base64url"),new mu({...k8,key_ops:["verify"],x:r,y:i});throw new O(`coordinates were wrong length, got ${e.byteLength}, expected 65, 97 or 133`)}function Vx(n){return ei([dr(Uint8Array.from([1])),Rx(R(n.d??"","base64url")),ei([C8(n.crv)],160),ei([Gp(new Ee(Uint8Array.from([4]),R(n.x??"","base64url"),R(n.y??"","base64url")))],161)]).subarray()}function zx(n){return ei([dr(Uint8Array.from([1])),ei([C8(n.crv)],160),ei([Gp(new Ee(Uint8Array.from([4]),R(n.x??"","base64url"),R(n.y??"","base64url")))],161)]).subarray()}function C8(n){if(n==="P-256")return Mx;if(n==="P-384")return Ux;if(n==="P-521")return Fx;throw new O(`Invalid curve ${n}`)}async function Kx(n="P-256"){const e=await Nx(n);return new yu(e.privateKey)}class mu{constructor(e){l(this,"type","ECDSA");l(this,"jwk");l(this,"_raw");this.jwk=e}get raw(){return this._raw==null&&(this._raw=zx(this.jwk)),this._raw}toMultihash(){return nn.digest(en(this))}toCID(){return le.createV1(114,this.toMultihash())}toString(){return Mr.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:ke(this.raw,e.raw)}async verify(e,t,r){return Bx(this.jwk,t,e,r)}}class yu{constructor(e){l(this,"type","ECDSA");l(this,"jwk");l(this,"publicKey");l(this,"_raw");this.jwk=e,this.publicKey=new mu({crv:e.crv,ext:e.ext,key_ops:["verify"],kty:"EC",x:e.x,y:e.y})}get raw(){return this._raw==null&&(this._raw=Vx(this.jwk)),this._raw}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:ke(this.raw,e.raw)}async sign(e,t){return Lx(this.jwk,e,t)}}class Y3 extends Error{constructor(e="An error occurred while signing a message"){super(e),this.name="SigningError"}}class X3 extends Error{constructor(e="An error occurred while verifying a message"){super(e),this.name="VerificationError"}}class qx extends Error{constructor(e="Missing Web Crypto API"){super(e),this.name="WebCryptoMissingError"}}const Gt={get(n=globalThis){const e=n.crypto;if((e==null?void 0:e.subtle)==null)throw new qx("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api");return e}},ju=32,vn=64,r0=32;let Po;const T8=(async()=>{try{return await Gt.get().subtle.generateKey({name:"Ed25519"},!0,["sign","verify"]),!0}catch{return!1}})();function Wx(){const n=Mu.utils.randomPrivateKey(),e=Mu.getPublicKey(n);return{privateKey:Jx(n,e),publicKey:e}}async function Gx(n,e){let t;n.length===vn?t=n.subarray(0,32):t=n;const r={crv:"Ed25519",kty:"OKP",x:U(n.subarray(32),"base64url"),d:U(t,"base64url"),ext:!0,key_ops:["sign"]},i=await Gt.get().subtle.importKey("jwk",r,{name:"Ed25519"},!0,["sign"]),s=await Gt.get().subtle.sign({name:"Ed25519"},i,e instanceof Uint8Array?e:e.subarray());return new Uint8Array(s,0,s.byteLength)}function jx(n,e){const t=n.subarray(0,r0);return Mu.sign(e instanceof Uint8Array?e:e.subarray(),t)}async function Qx(n,e){return Po==null&&(Po=await T8),Po?Gx(n,e):jx(n,e)}async function Yx(n,e,t){if(n.buffer instanceof ArrayBuffer){const r=await Gt.get().subtle.importKey("raw",n.buffer,{name:"Ed25519"},!1,["verify"]);return await Gt.get().subtle.verify({name:"Ed25519"},r,e,t instanceof Uint8Array?t:t.subarray())}throw new TypeError("WebCrypto does not support SharedArrayBuffer for Ed25519 keys")}function Xx(n,e,t){return Mu.verify(e,t instanceof Uint8Array?t:t.subarray(),n)}async function Zx(n,e,t){return Po==null&&(Po=await T8),Po?Yx(n,e,t):Xx(n,e,t)}function Jx(n,e){const t=new Uint8Array(vn);for(let r=0;r<r0;r++)t[r]=n[r],t[r0+r]=e[r];return t}function kh(n){return n==null?!1:typeof n.then=="function"&&typeof n.catch=="function"&&typeof n.finally=="function"}class R8{constructor(e){l(this,"type","Ed25519");l(this,"raw");this.raw=Rc(e,ju)}toMultihash(){return nn.digest(en(this))}toCID(){return le.createV1(114,this.toMultihash())}toString(){return Mr.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:ke(this.raw,e.raw)}verify(e,t,r){var s;(s=r==null?void 0:r.signal)==null||s.throwIfAborted();const i=Zx(this.raw,t,e);return kh(i)?i.then(o=>{var a;return(a=r==null?void 0:r.signal)==null||a.throwIfAborted(),o}):i}}class n0{constructor(e,t){l(this,"type","Ed25519");l(this,"raw");l(this,"publicKey");this.raw=Rc(e,vn),this.publicKey=new R8(t)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:ke(this.raw,e.raw)}sign(e,t){var i,s;(i=t==null?void 0:t.signal)==null||i.throwIfAborted();const r=Qx(this.raw,e);return kh(r)?r.then(o=>{var a;return(a=t==null?void 0:t.signal)==null||a.throwIfAborted(),o}):((s=t==null?void 0:t.signal)==null||s.throwIfAborted(),r)}}function P8(n){if(n.length>vn){n=Rc(n,vn+ju);const r=n.subarray(0,vn),i=n.subarray(vn,n.length);return new n0(r,i)}n=Rc(n,vn);const e=n.subarray(0,vn),t=n.subarray(ju);return new n0(e,t)}function O8(n){return n=Rc(n,ju),new R8(n)}async function eA(){const{privateKey:n,publicKey:e}=Wx();return new n0(n,e)}function Rc(n,e){if(n=Uint8Array.from(n??[]),n.length!==e)throw new O(`Key must be a Uint8Array of length ${e}, got ${n.length}`);return n}var Xe;(function(n){n.RSA="RSA",n.Ed25519="Ed25519",n.secp256k1="secp256k1",n.ECDSA="ECDSA"})(Xe||(Xe={}));var i0;(function(n){n[n.RSA=0]="RSA",n[n.Ed25519=1]="Ed25519",n[n.secp256k1=2]="secp256k1",n[n.ECDSA=3]="ECDSA"})(i0||(i0={}));(function(n){n.codec=()=>Wt(i0)})(Xe||(Xe={}));var ji;(function(n){let e;n.codec=()=>(e==null&&(e=me((t,r,i={})=>{i.lengthDelimited!==!1&&r.fork(),t.Type!=null&&(r.uint32(8),Xe.codec().encode(t.Type,r)),t.Data!=null&&(r.uint32(18),r.bytes(t.Data)),i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{const s={},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.Type=Xe.codec().decode(t);break}case 2:{s.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return s})),e),n.encode=t=>ye(t,n.codec()),n.decode=(t,r)=>we(t,n.codec(),r)})(ji||(ji={}));var Qu;(function(n){let e;n.codec=()=>(e==null&&(e=me((t,r,i={})=>{i.lengthDelimited!==!1&&r.fork(),t.Type!=null&&(r.uint32(8),Xe.codec().encode(t.Type,r)),t.Data!=null&&(r.uint32(18),r.bytes(t.Data)),i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{const s={},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.Type=Xe.codec().decode(t);break}case 2:{s.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return s})),e),n.encode=t=>ye(t,n.codec()),n.decode=(t,r)=>we(t,n.codec(),r)})(Qu||(Qu={}));function Os(n){if(isNaN(n)||n<=0)throw new O("random bytes length must be a Number bigger than 0");return CE(n)}let jp=class{constructor(e,t){l(this,"type","RSA");l(this,"jwk");l(this,"_raw");l(this,"_multihash");this.jwk=e,this._multihash=t}get raw(){return this._raw==null&&(this._raw=Yp(this.jwk)),this._raw}toMultihash(){return this._multihash}toCID(){return le.createV1(114,this._multihash)}toString(){return Mr.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:ke(this.raw,e.raw)}verify(e,t,r){return pA(this.jwk,t,e,r)}},D8=class{constructor(e,t){l(this,"type","RSA");l(this,"jwk");l(this,"_raw");l(this,"publicKey");this.jwk=e,this.publicKey=t}get raw(){return this._raw==null&&(this._raw=iA(this.jwk)),this._raw}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:ke(this.raw,e.raw)}sign(e,t){return fA(this.jwk,e,t)}};const N8=8192,Qp=18,tA=1062,rA=Uint8Array.from([48,13,6,9,42,134,72,134,247,13,1,1,1,5,0]);function nA(n){return{n:U(n[1],"base64url"),e:U(n[2],"base64url"),d:U(n[3],"base64url"),p:U(n[4],"base64url"),q:U(n[5],"base64url"),dp:U(n[6],"base64url"),dq:U(n[7],"base64url"),qi:U(n[8],"base64url"),kty:"RSA"}}function iA(n){if(n.n==null||n.e==null||n.d==null||n.p==null||n.q==null||n.dp==null||n.dq==null||n.qi==null)throw new O("JWK was missing components");return ei([dr(Uint8Array.from([0])),dr(R(n.n,"base64url")),dr(R(n.e,"base64url")),dr(R(n.d,"base64url")),dr(R(n.p,"base64url")),dr(R(n.q,"base64url")),dr(R(n.dp,"base64url")),dr(R(n.dq,"base64url")),dr(R(n.qi,"base64url"))]).subarray()}function sA(n){const e=Js(n[1],{offset:0});return{kty:"RSA",n:U(e[0],"base64url"),e:U(e[1],"base64url")}}function Yp(n){if(n.n==null||n.e==null)throw new O("JWK was missing components");return ei([rA,Gp(ei([dr(R(n.n,"base64url")),dr(R(n.e,"base64url"))]))]).subarray()}function oA(n){const e=Js(n);return L8(e)}function L8(n){const e=nA(n);return lA(e)}function aA(n,e){if(n.byteLength>=tA)throw new Ec("Key size is too large");const t=Js(n,{offset:0});return cA(t,n,e)}function cA(n,e,t){const r=sA(n);if(t==null){const i=_s(ji.encode({Type:Xe.RSA,Data:e}));t=rl(Qp,i)}return new jp(r,t)}function lA(n){if(mA(n)>N8)throw new O("Key size is too large");const e=dA(n),t=_s(ji.encode({Type:Xe.RSA,Data:Yp(e.publicKey)})),r=rl(Qp,t);return new D8(e.privateKey,new jp(e.publicKey,r))}async function uA(n){if(n>N8)throw new O("Key size is too large");const e=await hA(n),t=_s(ji.encode({Type:Xe.RSA,Data:Yp(e.publicKey)})),r=rl(Qp,t);return new D8(e.privateKey,new jp(e.publicKey,r))}function dA(n){if(n==null)throw new O("Missing key parameter");return{privateKey:n,publicKey:{kty:n.kty,n:n.n,e:n.e}}}async function hA(n,e){const t=await Gt.get().subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:n,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]),r=await gA(t);return{privateKey:r[0],publicKey:r[1]}}async function fA(n,e,t){var s,o;const r=await Gt.get().subtle.importKey("jwk",n,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["sign"]);(s=t==null?void 0:t.signal)==null||s.throwIfAborted();const i=await Gt.get().subtle.sign({name:"RSASSA-PKCS1-v1_5"},r,e instanceof Uint8Array?e:e.subarray());return(o=t==null?void 0:t.signal)==null||o.throwIfAborted(),new Uint8Array(i,0,i.byteLength)}async function pA(n,e,t,r){var o,a;const i=await Gt.get().subtle.importKey("jwk",n,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);(o=r==null?void 0:r.signal)==null||o.throwIfAborted();const s=await Gt.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},i,e,t instanceof Uint8Array?t:t.subarray());return(a=r==null?void 0:r.signal)==null||a.throwIfAborted(),s}async function gA(n,e){if(n.privateKey==null||n.publicKey==null)throw new O("Private and public key are required");return await Promise.all([Gt.get().subtle.exportKey("jwk",n.privateKey),Gt.get().subtle.exportKey("jwk",n.publicKey)])}function mA(n){if(n.kty!=="RSA")throw new O("invalid key type");if(n.n==null)throw new O("invalid key modulus");return R(n.n,"base64url").length*8}const yA=32;function wA(n,e,t){const r=ut.digest(e instanceof Uint8Array?e:e.subarray());if(kh(r))return r.then(({digest:i})=>{var s;return(s=t==null?void 0:t.signal)==null||s.throwIfAborted(),ai.sign(i,n).toDERRawBytes()}).catch(i=>{throw i.name==="AbortError"?i:new Y3(String(i))});try{return ai.sign(r.digest,n).toDERRawBytes()}catch(i){throw new Y3(String(i))}}function bA(n,e,t,r){var s;const i=ut.digest(t instanceof Uint8Array?t:t.subarray());if(kh(i))return i.then(({digest:o})=>{var a;return(a=r==null?void 0:r.signal)==null||a.throwIfAborted(),ai.verify(e,o,n)}).catch(o=>{throw o.name==="AbortError"?o:new X3(String(o))});try{return(s=r==null?void 0:r.signal)==null||s.throwIfAborted(),ai.verify(e,i.digest,n)}catch(o){throw new X3(String(o))}}class B8{constructor(e){l(this,"type","secp256k1");l(this,"raw");l(this,"_key");this._key=xA(e),this.raw=SA(this._key)}toMultihash(){return nn.digest(en(this))}toCID(){return le.createV1(114,this.toMultihash())}toString(){return Mr.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:ke(this.raw,e.raw)}verify(e,t,r){return bA(this._key,t,e,r)}}class M8{constructor(e,t){l(this,"type","secp256k1");l(this,"raw");l(this,"publicKey");this.raw=EA(e),this.publicKey=new B8(t??AA(e))}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:ke(this.raw,e.raw)}sign(e,t){return wA(this.raw,e,t)}}function U8(n){return new M8(n)}function F8(n){return new B8(n)}async function vA(){const n=kA();return new M8(n)}function SA(n){return ai.ProjectivePoint.fromHex(n).toRawBytes(!0)}function EA(n){try{return ai.getPublicKey(n,!0),n}catch(e){throw new $p(String(e))}}function xA(n){try{return ai.ProjectivePoint.fromHex(n),n}catch(e){throw new Ec(String(e))}}function AA(n){try{return ai.getPublicKey(n,!0)}catch(e){throw new $p(String(e))}}function kA(){return ai.utils.randomPrivateKey()}async function Xp(n,e){if(n==="Ed25519")return eA();if(n==="secp256k1")return vA();if(n==="RSA")return uA(CA(e));if(n==="ECDSA")return Kx(TA(e));throw new Zs}function on(n,e){const{Type:t,Data:r}=ji.decode(n),i=r??new Uint8Array;switch(t){case Xe.RSA:return aA(i,e);case Xe.Ed25519:return O8(i);case Xe.secp256k1:return F8(i);case Xe.ECDSA:return I8(i);default:throw new Zs}}function $8(n){const{Type:e,Data:t}=ji.decode(n.digest),r=t??new Uint8Array;switch(e){case Xe.Ed25519:return O8(r);case Xe.secp256k1:return F8(r);case Xe.ECDSA:return I8(r);default:throw new Zs}}function en(n){return ji.encode({Type:Xe[n.type],Data:n.raw})}function _A(n){const e=Qu.decode(n),t=e.Data??new Uint8Array;switch(e.Type){case Xe.RSA:return oA(t);case Xe.Ed25519:return P8(t);case Xe.secp256k1:return U8(t);case Xe.ECDSA:return $x(t);default:throw new Zs}}function IA(n){var r;if(n.byteLength===vn)return P8(n);if(n.byteLength===yA)return U8(n);const e=Js(n),t=(r=e[2])==null?void 0:r[0];if(t===Px||t===Ox||t===Dx)return _8(e);if(e.length>8)return L8(e);throw new O("Could not extract private key from raw bytes")}function dl(n){return Qu.encode({Type:Xe[n.type],Data:n.raw})}function CA(n){return n==null?2048:parseInt(n,10)}function TA(n){if(n==="P-256"||n==null)return"P-256";if(n==="P-384")return"P-384";if(n==="P-521")return"P-521";throw new O("Unsupported curve, should be P-256, P-384 or P-521")}async function H8(n){if(n.type==="RSA")return{privateKey:await crypto.subtle.importKey("jwk",n.jwk,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["sign"]),publicKey:await crypto.subtle.importKey("jwk",n.publicKey.jwk,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["verify"])};if(n.type==="ECDSA")return{privateKey:await crypto.subtle.importKey("jwk",n.jwk,{name:"ECDSA",namedCurve:n.jwk.crv??"P-256"},!0,["sign"]),publicKey:await crypto.subtle.importKey("jwk",n.publicKey.jwk,{name:"ECDSA",namedCurve:n.publicKey.jwk.crv??"P-256"},!0,["verify"])};throw new O("Only RSA and ECDSA keys are supported")}const V8=Symbol.for("nodejs.util.inspect.custom"),RA=114;var z5;class Zp{constructor(e){l(this,"type");l(this,"multihash");l(this,"publicKey");l(this,"string");l(this,z5,!0);this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}toString(){return this.string==null&&(this.string=Mr.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return le.createV1(RA,this.multihash)}toJSON(){return this.toString()}equals(e){var t;if(e==null)return!1;if(e instanceof Uint8Array)return ke(this.multihash.bytes,e);if(typeof e=="string")return this.toString()===e;if(((t=e==null?void 0:e.toMultihash())==null?void 0:t.bytes)!=null)return ke(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[(z5=Fp,V8)](){return`PeerId(${this.toString()})`}}class z8 extends Zp{constructor(t){super({...t,type:"RSA"});l(this,"type","RSA");l(this,"publicKey");this.publicKey=t.publicKey}}class K8 extends Zp{constructor(t){super({...t,type:"Ed25519"});l(this,"type","Ed25519");l(this,"publicKey");this.publicKey=t.publicKey}}class q8 extends Zp{constructor(t){super({...t,type:"secp256k1"});l(this,"type","secp256k1");l(this,"publicKey");this.publicKey=t.publicKey}}const PA=2336;var K5,q5;class W8{constructor(e){l(this,"type","url");l(this,"multihash");l(this,"publicKey");l(this,"url");l(this,K5,!0);this.url=e.toString(),this.multihash=nn.digest(R(this.url))}[(q5=V8,K5=Fp,q5)](){return`PeerId(${this.url})`}toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return le.createV1(PA,this.toMultihash())}toJSON(){return this.toString()}equals(e){return e==null?!1:(e instanceof Uint8Array&&(e=U(e)),e.toString()===this.toString())}}const OA=114,Z3=2336;function Ur(n,e){let t;if(n.charAt(0)==="1"||n.charAt(0)==="Q")t=Pt(Mr.decode(`z${n}`));else{if(n.startsWith("k51qzi5uqu5")||n.startsWith("kzwfwjn5ji4")||n.startsWith("k2k4r8")||n.startsWith("bafz"))return hl(le.parse(n));throw new O('Please pass a multibase decoder for strings that do not start with "1" or "Q"')}return ln(t)}function Go(n){if(n.type==="Ed25519")return new K8({multihash:n.toCID().multihash,publicKey:n});if(n.type==="secp256k1")return new q8({multihash:n.toCID().multihash,publicKey:n});if(n.type==="RSA")return new z8({multihash:n.toCID().multihash,publicKey:n});throw new Zs}function DA(n){return Go(n.publicKey)}function ln(n){if(LA(n))return new z8({multihash:n});if(NA(n))try{const e=$8(n);if(e.type==="Ed25519")return new K8({multihash:n,publicKey:e});if(e.type==="secp256k1")return new q8({multihash:n,publicKey:e})}catch{const t=U(n.digest);return new W8(new URL(t))}throw new Sh("Supplied PeerID Multihash is invalid")}function hl(n){if((n==null?void 0:n.multihash)==null||n.version==null||n.version===1&&n.code!==OA&&n.code!==Z3)throw new d8("Supplied PeerID CID is invalid");if(n.code===Z3){const e=U(n.multihash.digest);return new W8(new URL(e))}return ln(n.multihash)}function NA(n){return n.code===nn.code}function LA(n){return n.code===ut.code}function tc(n,e){const t={[Symbol.iterator]:()=>t,next:()=>{const r=n.next(),i=r.value;return r.done===!0||i==null?{done:!0,value:void 0}:{done:!1,value:e(i)}}};return t}function Q1(n){const e=Pt(Mr.decode(`z${n}`));return ln(e)}class eo{constructor(e){l(this,"map");if(this.map=new Map,e!=null)for(const[t,r]of e.entries())this.map.set(t.toString(),{key:t,value:r})}[Symbol.iterator](){return this.entries()}clear(){this.map.clear()}delete(e){return this.map.delete(e.toString())}entries(){return tc(this.map.entries(),e=>[e[1].key,e[1].value])}forEach(e){this.map.forEach((t,r)=>{e(t.value,t.key,this)})}get(e){var t;return(t=this.map.get(e.toString()))==null?void 0:t.value}has(e){return this.map.has(e.toString())}set(e,t){this.map.set(e.toString(),{key:e,value:t})}keys(){return tc(this.map.values(),e=>e.key)}values(){return tc(this.map.values(),e=>e.value)}get size(){return this.map.size}}class xn{constructor(e){l(this,"set");if(this.set=new Set,e!=null)for(const t of e)this.set.add(t.toString())}get size(){return this.set.size}[Symbol.iterator](){return this.values()}add(e){this.set.add(e.toString())}clear(){this.set.clear()}delete(e){this.set.delete(e.toString())}entries(){return tc(this.set.entries(),e=>{const t=Q1(e[0]);return[t,t]})}forEach(e){this.set.forEach(t=>{const r=Q1(t);e(r,r,this)})}has(e){return this.set.has(e.toString())}values(){return tc(this.set.values(),e=>Q1(e))}intersection(e){const t=new xn;for(const r of e)this.has(r)&&t.add(r);return t}difference(e){const t=new xn;for(const r of this)e.has(r)||t.add(r);return t}union(e){const t=new xn;for(const r of e)t.add(r);for(const r of this)t.add(r);return t}}function BA(){return new xn}function G8(n,e,t,r){Bp(n);const i=TE({dkLen:32,asyncTick:10},r),{c:s,dkLen:o,asyncTick:a}=i;if(gu(s),gu(o),gu(a),s<1)throw new Error("iterations (c) should be >= 1");const c=z3(e),u=z3(t),d=new Uint8Array(o),h=Up.create(n,c),f=h._cloneInto().update(u);return{c:s,dkLen:o,asyncTick:a,DK:d,PRF:h,PRFSalt:f}}function j8(n,e,t,r,i){return n.destroy(),e.destroy(),r&&r.destroy(),a8(i),t}function MA(n,e,t,r){const{c:i,dkLen:s,DK:o,PRF:a,PRFSalt:c}=G8(n,e,t,r);let u;const d=new Uint8Array(4),h=o8(d),f=new Uint8Array(a.outputLen);for(let p=1,m=0;m<s;p++,m+=a.outputLen){const w=o.subarray(m,m+a.outputLen);h.setInt32(0,p,!1),(u=c._cloneInto(u)).update(d).digestInto(f),w.set(f.subarray(0,w.length));for(let b=1;b<i;b++){a._cloneInto(u).update(f).digestInto(f);for(let S=0;S<w.length;S++)w[S]^=f[S]}}return j8(a,c,o,u,f)}async function Q8(n,e,t,r){const{c:i,dkLen:s,asyncTick:o,DK:a,PRF:c,PRFSalt:u}=G8(n,e,t,r);let d;const h=new Uint8Array(4),f=o8(h),p=new Uint8Array(c.outputLen);for(let m=1,w=0;w<s;m++,w+=c.outputLen){const b=a.subarray(w,w+c.outputLen);f.setInt32(0,m,!1),(d=u._cloneInto(d)).update(h).digestInto(p),b.set(p.subarray(0,b.length)),await RE(i-1,o,()=>{c._cloneInto(d).update(p).digestInto(p);for(let S=0;S<b.length;S++)b[S]^=p[S]})}return j8(c,u,a,d,p)}const UA=BE,Jp=PE,J3={sha1:UA,"sha2-256":_s,"sha2-512":Jp};function em(n,e,t,r,i){if(i!=="sha1"&&i!=="sha2-256"&&i!=="sha2-512"){const a=Object.keys(J3).join(" / ");throw new O(`Hash '${i}' is unknown or not supported. Must be ${a}`)}const s=J3[i],o=MA(s,n,e,{c:t,dkLen:r});return Zn.encode(o).substring(1)}const eg={32:16777619n,64:1099511628211n,128:309485009821345068724781371n,256:374144419156711147060143317175368453031918731002211n,512:35835915874844867368919076489095108449946327955754392558399825615420669938882575126094039892345713852759n,1024:5016456510113118655434598811035278955030765345404790744303017523831112055108147451509157692220295382716162651878526895249385292291816524375083746691371804094271873160484737966720260389217684476157468082573n},Y8={32:2166136261n,64:14695981039346656037n,128:144066263297769815596495629667062367629n,256:100029257958052580907070968620625704837092796014241193945225284501741471925557n,512:9659303129496669498009435400716310466090418745672637896108374329434462657994582932197716438449813051892206539805784495328239340083876191928701583869517785n,1024:14197795064947621068722070641403218320880622795441933960878474914617582723252296732303717722150864096521202355549365628174669108571814760471015076148029755969804077320157692458563003215304957150157403644460363550505412711285966361610267868082893823963790439336411086884584107735010676915n},X8=new globalThis.TextEncoder;function FA(n,e){const t=eg[e];let r=Y8[e];for(let i=0;i<n.length;i++)r^=BigInt(n[i]),r=BigInt.asUintN(e,r*t);return r}function $A(n,e,t){if(t.length===0)throw new Error("The `utf8Buffer` option must have a length greater than zero");const r=eg[e];let i=Y8[e],s=n;for(;s.length>0;){const o=X8.encodeInto(s,t);s=s.slice(o.read);for(let a=0;a<o.written;a++)i^=BigInt(t[a]),i=BigInt.asUintN(e,i*r)}return i}function HA(n,{size:e=32,utf8Buffer:t}={}){if(!eg[e])throw new Error("The `size` option must be one of 32, 64, 128, 256, 512, or 1024");if(typeof n=="string"){if(t)return $A(n,e,t);n=X8.encode(n)}return FA(n,e)}const tg={hash:n=>Number(HA(n,{size:32})),hashV:(n,e)=>VA(tg.hash(n,e))};function VA(n){let e=n.toString(16);return e.length%2===1&&(e=`0${e}`),R(e,"base16")}const Z8=64;class ys{constructor(e,t,r,i=2){l(this,"fp");l(this,"h");l(this,"seed");if(i>Z8)throw new TypeError("Invalid Fingerprint Size");const s=t.hashV(e,r),o=Fe(i);for(let a=0;a<o.length;a++)o[a]=s[a];o.length===0&&(o[0]=7),this.fp=o,this.h=t,this.seed=r}hash(){return this.h.hash(this.fp,this.seed)}equals(e){return(e==null?void 0:e.fp)instanceof Uint8Array?ke(this.fp,e.fp):!1}}function Yu(n,e){return Math.floor(Math.random()*(e-n))+n}let Hl=class{constructor(e){l(this,"contents");this.contents=new Array(e).fill(null)}has(e){if(!(e instanceof ys))throw new TypeError("Invalid Fingerprint");return this.contents.some(t=>e.equals(t))}add(e){if(!(e instanceof ys))throw new TypeError("Invalid Fingerprint");for(let t=0;t<this.contents.length;t++)if(this.contents[t]==null)return this.contents[t]=e,!0;return!0}swap(e){if(!(e instanceof ys))throw new TypeError("Invalid Fingerprint");const t=Yu(0,this.contents.length-1),r=this.contents[t];return this.contents[t]=e,r}remove(e){if(!(e instanceof ys))throw new TypeError("Invalid Fingerprint");const t=this.contents.findIndex(r=>e.equals(r));return t>-1?(this.contents[t]=null,!0):!1}};const zA=500;class tm{constructor(e){l(this,"bucketSize");l(this,"filterSize");l(this,"fingerprintSize");l(this,"buckets");l(this,"count");l(this,"hash");l(this,"seed");this.filterSize=e.filterSize,this.bucketSize=e.bucketSize??4,this.fingerprintSize=e.fingerprintSize??2,this.count=0,this.buckets=[],this.hash=e.hash??tg,this.seed=e.seed??Yu(0,Math.pow(2,10))}add(e){typeof e=="string"&&(e=R(e));const t=new ys(e,this.hash,this.seed,this.fingerprintSize),r=this.hash.hash(e,this.seed)%this.filterSize,i=(r^t.hash())%this.filterSize;if(this.buckets[r]==null&&(this.buckets[r]=new Hl(this.bucketSize)),this.buckets[i]==null&&(this.buckets[i]=new Hl(this.bucketSize)),this.buckets[r].add(t)||this.buckets[i].add(t))return this.count++,!0;const s=[r,i];let o=s[Yu(0,s.length-1)];this.buckets[o]==null&&(this.buckets[o]=new Hl(this.bucketSize));for(let a=0;a<zA;a++){const c=this.buckets[o].swap(t);if(c!=null&&(o=(o^c.hash())%this.filterSize,this.buckets[o]==null&&(this.buckets[o]=new Hl(this.bucketSize)),this.buckets[o].add(c)))return this.count++,!0}return!1}has(e){var o,a;typeof e=="string"&&(e=R(e));const t=new ys(e,this.hash,this.seed,this.fingerprintSize),r=this.hash.hash(e,this.seed)%this.filterSize,i=((o=this.buckets[r])==null?void 0:o.has(t))??!1;if(i)return i;const s=(r^t.hash())%this.filterSize;return((a=this.buckets[s])==null?void 0:a.has(t))??!1}remove(e){var a,c;typeof e=="string"&&(e=R(e));const t=new ys(e,this.hash,this.seed,this.fingerprintSize),r=this.hash.hash(e,this.seed)%this.filterSize,i=((a=this.buckets[r])==null?void 0:a.remove(t))??!1;if(i)return this.count--,i;const s=(r^t.hash())%this.filterSize,o=((c=this.buckets[s])==null?void 0:c.remove(t))??!1;return o&&this.count--,o}get reliable(){return Math.floor(100*(this.count/this.filterSize))<=90}}const KA={1:.5,2:.84,4:.95,8:.98};function qA(n=.001){return n>.002?2:n>1e-5?4:8}function WA(n,e=.001){const t=qA(e),r=KA[t],i=Math.round(n/r),s=Math.min(Math.ceil(Math.log2(1/e)+Math.log2(2*t)),Z8);return{filterSize:i,bucketSize:t,fingerprintSize:s}}class J8{constructor(e){l(this,"filterSize");l(this,"bucketSize");l(this,"fingerprintSize");l(this,"scale");l(this,"filterSeries");l(this,"hash");l(this,"seed");this.bucketSize=e.bucketSize??4,this.filterSize=e.filterSize??(1<<18)/this.bucketSize,this.fingerprintSize=e.fingerprintSize??2,this.scale=e.scale??2,this.hash=e.hash??tg,this.seed=e.seed??Yu(0,Math.pow(2,10)),this.filterSeries=[new tm({filterSize:this.filterSize,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed})]}add(e){if(typeof e=="string"&&(e=R(e)),this.has(e))return!0;let t=this.filterSeries.find(r=>r.reliable);if(t==null){const r=this.filterSize*Math.pow(this.scale,this.filterSeries.length);t=new tm({filterSize:r,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed}),this.filterSeries.push(t)}return t.add(e)}has(e){typeof e=="string"&&(e=R(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].has(e))return!0;return!1}remove(e){typeof e=="string"&&(e=R(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].remove(e))return!0;return!1}get count(){return this.filterSeries.reduce((e,t)=>e+t.count,0)}}function Qi(n,e=.001,t){return new J8({...WA(n,e)})}class GA{constructor(e,t){l(this,"filter");this.filter=Qi(e,t)}has(e){return this.filter.has(e.toMultihash().bytes)}add(e){this.filter.add(e.toMultihash().bytes)}remove(e){var t,r;(r=(t=this.filter).remove)==null||r.call(t,e.toMultihash().bytes)}}function jA(n,e=.001){return new GA(n,e)}class QA extends eo{constructor(t){super();l(this,"metric");const{name:r,metrics:i}=t;this.metric=i.registerMetric(r),this.updateComponentMetric()}set(t,r){return super.set(t,r),this.updateComponentMetric(),this}delete(t){const r=super.delete(t);return this.updateComponentMetric(),r}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}}function _h(n){const{name:e,metrics:t}=n;let r;return t!=null?r=new QA({name:e,metrics:t}):r=new eo,r}class qa{constructor(e=!1,t=0){l(this,"full");l(this,"pendingBytes");l(this,"wantlist");l(this,"blocks");l(this,"blockPresences");this.full=e,this.wantlist=new Map,this.blocks=new Map,this.blockPresences=new Map,this.pendingBytes=0}addWantlistEntry(e,t){const r=Zn.encode(e.multihash.bytes);this.wantlist.set(r,t)}addBlockPresence(e,t){const r=Zn.encode(e.multihash.bytes);this.blockPresences.set(r,t)}addBlock(e,t){const r=Zn.encode(e.multihash.bytes);this.blocks.set(r,t)}}function YA(n){let e=new Uint8Array(n.reduce((r,i)=>r+Ht(i),0)),t=0;for(const r of n)e=Jr(r,e,t),t+=Ht(r);return e}function rm(n){return YA([n.version,n.code,n.multihash.code,n.multihash.digest.byteLength])}class XA{constructor(e,t){l(this,"peerId");l(this,"blockstore");l(this,"network");l(this,"wants");l(this,"exchangeCount");l(this,"bytesSent");l(this,"bytesReceived");l(this,"lastExchange");l(this,"maxSizeReplaceHasWithBlock");l(this,"log");this.peerId=e.peerId,this.blockstore=e.blockstore,this.network=e.network,this.wants=new Map,this.log=e.logger.forComponent(`helia:bitswap:ledger:${e.peerId}`),this.exchangeCount=0,this.bytesSent=0,this.bytesReceived=0,this.maxSizeReplaceHasWithBlock=t.maxSizeReplaceHasWithBlock??sx}sentBytes(e){this.exchangeCount++,this.lastExchange=new Date().getTime(),this.bytesSent+=e}receivedBytes(e){this.exchangeCount++,this.lastExchange=new Date().getTime(),this.bytesReceived+=e}debtRatio(){return this.bytesSent/(this.bytesReceived+1)}async sendBlocksToPeer(e){const t=new qa,r=new Set;for(const[i,s]of this.wants.entries())try{const o=await this.blockstore.get(s.cid,e);s.wantType===mt.WantHave?o.byteLength<this.maxSizeReplaceHasWithBlock?(this.log("sending have and block for %c",s.cid),r.add(i),t.addBlock(s.cid,{data:o,prefix:rm(s.cid)})):(this.log("sending have for %c",s.cid),t.addBlockPresence(s.cid,{cid:s.cid.bytes,type:En.HaveBlock})):(this.log("sending block for %c",s.cid),r.add(i),t.addBlock(s.cid,{data:o,prefix:rm(s.cid)}))}catch(o){if(o.name!=="NotFoundError")throw o;if(this.log("do not have block for %c",s.cid),!s.sendDontHave||s.sentDoNotHave===!0)continue;s.sentDoNotHave=!0,t.addBlockPresence(s.cid,{cid:s.cid.bytes,type:En.DoNotHaveBlock})}if(t.blocks.size>0||t.blockPresences.size>0){this.log("sending message"),await this.network.sendMessage(this.peerId,t,e),this.log("sent message"),this.sentBytes([...t.blocks.values()].reduce((i,s)=>i+s.data.byteLength,0));for(const i of r)this.wants.delete(i)}}}class ZA{constructor(e,t={}){l(this,"blockstore");l(this,"network");l(this,"ledgerMap");l(this,"maxSizeReplaceHasWithBlock");l(this,"log");l(this,"logger");this.blockstore=e.blockstore,this.network=e.network,this.maxSizeReplaceHasWithBlock=t.maxSizeReplaceHasWithBlock,this.log=e.logger.forComponent("helia:bitswap:peer-want-lists"),this.logger=e.logger,this.ledgerMap=_h({name:"helia_bitswap_ledger_map",metrics:e.metrics}),this.network.addEventListener("bitswap:message",r=>{this.receiveMessage(r.detail.peer,r.detail.message).catch(i=>{this.log.error("error receiving bitswap message from %p",r.detail.peer,i)})}),this.network.addEventListener("peer:disconnected",r=>{this.peerDisconnected(r.detail)})}ledgerForPeer(e){const t=this.ledgerMap.get(e);if(t!=null)return{peer:t.peerId,value:t.debtRatio(),sent:t.bytesSent,received:t.bytesReceived,exchanged:t.exchangeCount}}wantListForPeer(e){const t=this.ledgerMap.get(e);if(t!=null)return[...t.wants.values()]}peers(){return Array.from(this.ledgerMap.values()).map(e=>e.peerId)}async receiveMessage(e,t){var i;let r=this.ledgerMap.get(e);if(r==null&&(r=new XA({peerId:e,blockstore:this.blockstore,network:this.network,logger:this.logger},{maxSizeReplaceHasWithBlock:this.maxSizeReplaceHasWithBlock}),this.ledgerMap.set(e,r)),r.receivedBytes(((i=t.blocks)==null?void 0:i.reduce((s,o)=>s+o.data.byteLength,0))??0),t.wantlist!=null){t.wantlist.full===!0&&r.wants.clear();for(const s of t.wantlist.entries){const o=le.decode(s.cid),a=U(o.multihash.bytes,"base64");s.cancel===!0?(this.log("peer %p cancelled want of block for %c",e,o),r.wants.delete(a)):(s.wantType===mt.WantHave?this.log("peer %p wanted block presence for %c",e,o):this.log("peer %p wanted block for %c",e,o),r.wants.set(a,{cid:o,priority:s.priority,wantType:s.wantType??mt.WantBlock,sendDontHave:s.sendDontHave??!1}))}}this.log("send blocks to peer"),await r.sendBlocksToPeer()}async receivedBlock(e,t){const r=U(e.multihash.bytes,"base64"),i=[];for(const s of this.ledgerMap.values())s.wants.has(r)&&i.push(s);await Promise.all(i.map(async s=>s.sendBlocksToPeer(t)))}peerDisconnected(e){this.ledgerMap.delete(e)}}pr.formatters.b=n=>n==null?"undefined":Mr.baseEncode(n);pr.formatters.t=n=>n==null?"undefined":ds.baseEncode(n);pr.formatters.m=n=>n==null?"undefined":Zn.baseEncode(n);pr.formatters.p=n=>n==null?"undefined":n.toString();pr.formatters.c=n=>n==null?"undefined":n.toString();pr.formatters.k=n=>n==null?"undefined":n.toString();pr.formatters.a=n=>n==null?"undefined":n.toString();pr.formatters.e=n=>n==null?"undefined":nm(n.stack)??nm(n.message)??n.toString();function JA(n){const e=()=>{};return e.enabled=!1,e.color="",e.diff=0,e.log=()=>{},e.namespace=n,e.destroy=()=>!0,e.extend=()=>e,e}function Ih(){return{forComponent(n){return Ch(n)}}}function Ch(n){let e=JA(`${n}:trace`);return pr.enabled(`${n}:trace`)&&pr.names.map(t=>t.toString()).find(t=>t.includes(":trace"))!=null&&(e=pr(`${n}:trace`)),Object.assign(pr(n),{error:pr(`${n}:error`),trace:e,newScope:t=>Ch(`${n}:${t}`)})}function nm(n){if(n!=null&&(n=n.trim(),n.length!==0))return n}class e7 extends Error{constructor(e){super(e),this.name="TimeoutError"}}let ek=class extends Error{constructor(e){super(),this.name="AbortError",this.message=e}};const im=n=>globalThis.DOMException===void 0?new ek(n):new DOMException(n),sm=n=>{const e=n.reason===void 0?im("This operation was aborted."):n.reason;return e instanceof Error?e:im(e)};function Th(n,e){const{milliseconds:t,fallback:r,message:i,customTimers:s={setTimeout,clearTimeout}}=e;let o,a;const u=new Promise((d,h)=>{if(typeof t!="number"||Math.sign(t)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${t}\``);if(e.signal){const{signal:p}=e;p.aborted&&h(sm(p)),a=()=>{h(sm(p))},p.addEventListener("abort",a,{once:!0})}if(t===Number.POSITIVE_INFINITY){n.then(d,h);return}const f=new e7;o=s.setTimeout.call(void 0,()=>{if(r){try{d(r())}catch(p){h(p)}return}typeof n.cancel=="function"&&n.cancel(),i===!1?d():i instanceof Error?h(i):(f.message=i??`Promise timed out after ${t} milliseconds`,h(f))},t),(async()=>{try{d(await n)}catch(p){h(p)}})()}).finally(()=>{u.clear(),a&&e.signal&&e.signal.removeEventListener("abort",a)});return u.clear=()=>{s.clearTimeout.call(void 0,o),o=void 0},u}function tk(n,e,t){let r=0,i=n.length;for(;i>0;){const s=Math.trunc(i/2);let o=r+s;t(n[o],e)<=0?(r=++o,i-=s+1):i=s}return r}var Rr,W5;let rk=(W5=class{constructor(){pe(this,Rr,[])}enqueue(e,t){t={priority:0,...t};const r={priority:t.priority,id:t.id,run:e};if(this.size===0||A(this,Rr)[this.size-1].priority>=t.priority){A(this,Rr).push(r);return}const i=tk(A(this,Rr),r,(s,o)=>o.priority-s.priority);A(this,Rr).splice(i,0,r)}setPriority(e,t){const r=A(this,Rr).findIndex(s=>s.id===e);if(r===-1)throw new ReferenceError(`No promise function with the id "${e}" exists in the queue.`);const[i]=A(this,Rr).splice(r,1);this.enqueue(i.run,{priority:t,id:e})}dequeue(){const e=A(this,Rr).shift();return e==null?void 0:e.run}filter(e){return A(this,Rr).filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return A(this,Rr).length}},Rr=new WeakMap,W5);var Bo,Mo,Ri,Yc,Uo,Xc,Pr,Fo,Ft,Zc,Or,$o,Fn,Jc,uh,Ne,t7,r7,n7,i7,s7,wu,s0,o0,bu,o7,vu;class fl extends OE{constructor(t){var r,i;super();pe(this,Ne);pe(this,Bo);pe(this,Mo);pe(this,Ri,0);pe(this,Yc);pe(this,Uo);pe(this,Xc,0);pe(this,Pr);pe(this,Fo);pe(this,Ft);pe(this,Zc);pe(this,Or,0);pe(this,$o);pe(this,Fn);pe(this,Jc);pe(this,uh,1n);l(this,"timeout");if(t={carryoverConcurrencyCount:!1,intervalCap:Number.POSITIVE_INFINITY,interval:0,concurrency:Number.POSITIVE_INFINITY,autoStart:!0,queueClass:rk,...t},!(typeof t.intervalCap=="number"&&t.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${((r=t.intervalCap)==null?void 0:r.toString())??""}\` (${typeof t.intervalCap})`);if(t.interval===void 0||!(Number.isFinite(t.interval)&&t.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${((i=t.interval)==null?void 0:i.toString())??""}\` (${typeof t.interval})`);Ae(this,Bo,t.carryoverConcurrencyCount),Ae(this,Mo,t.intervalCap===Number.POSITIVE_INFINITY||t.interval===0),Ae(this,Yc,t.intervalCap),Ae(this,Uo,t.interval),Ae(this,Ft,new t.queueClass),Ae(this,Zc,t.queueClass),this.concurrency=t.concurrency,this.timeout=t.timeout,Ae(this,Jc,t.throwOnTimeout===!0),Ae(this,Fn,t.autoStart===!1)}get concurrency(){return A(this,$o)}set concurrency(t){if(!(typeof t=="number"&&t>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${t}\` (${typeof t})`);Ae(this,$o,t),D(this,Ne,bu).call(this)}setPriority(t,r){A(this,Ft).setPriority(t,r)}async add(t,r={}){return r.id??(r.id=(Tr(this,uh)._++).toString()),r={timeout:this.timeout,throwOnTimeout:A(this,Jc),...r},new Promise((i,s)=>{A(this,Ft).enqueue(async()=>{var o;Tr(this,Or)._++,Tr(this,Ri)._++;try{(o=r.signal)==null||o.throwIfAborted();let a=t({signal:r.signal});r.timeout&&(a=Th(Promise.resolve(a),{milliseconds:r.timeout})),r.signal&&(a=Promise.race([a,D(this,Ne,o7).call(this,r.signal)]));const c=await a;i(c),this.emit("completed",c)}catch(a){if(a instanceof e7&&!r.throwOnTimeout){i();return}s(a),this.emit("error",a)}finally{D(this,Ne,n7).call(this)}},r),this.emit("add"),D(this,Ne,wu).call(this)})}async addAll(t,r){return Promise.all(t.map(async i=>this.add(i,r)))}start(){return A(this,Fn)?(Ae(this,Fn,!1),D(this,Ne,bu).call(this),this):this}pause(){Ae(this,Fn,!0)}clear(){Ae(this,Ft,new(A(this,Zc)))}async onEmpty(){A(this,Ft).size!==0&&await D(this,Ne,vu).call(this,"empty")}async onSizeLessThan(t){A(this,Ft).size<t||await D(this,Ne,vu).call(this,"next",()=>A(this,Ft).size<t)}async onIdle(){A(this,Or)===0&&A(this,Ft).size===0||await D(this,Ne,vu).call(this,"idle")}get size(){return A(this,Ft).size}sizeBy(t){return A(this,Ft).filter(t).length}get pending(){return A(this,Or)}get isPaused(){return A(this,Fn)}}Bo=new WeakMap,Mo=new WeakMap,Ri=new WeakMap,Yc=new WeakMap,Uo=new WeakMap,Xc=new WeakMap,Pr=new WeakMap,Fo=new WeakMap,Ft=new WeakMap,Zc=new WeakMap,Or=new WeakMap,$o=new WeakMap,Fn=new WeakMap,Jc=new WeakMap,uh=new WeakMap,Ne=new WeakSet,t7=function(){return A(this,Mo)||A(this,Ri)<A(this,Yc)},r7=function(){return A(this,Or)<A(this,$o)},n7=function(){Tr(this,Or)._--,D(this,Ne,wu).call(this),this.emit("next")},i7=function(){D(this,Ne,o0).call(this),D(this,Ne,s0).call(this),Ae(this,Fo,void 0)},s7=function(){const t=Date.now();if(A(this,Pr)===void 0){const r=A(this,Xc)-t;if(r<0)Ae(this,Ri,A(this,Bo)?A(this,Or):0);else return A(this,Fo)===void 0&&Ae(this,Fo,setTimeout(()=>{D(this,Ne,i7).call(this)},r)),!0}return!1},wu=function(){if(A(this,Ft).size===0)return A(this,Pr)&&clearInterval(A(this,Pr)),Ae(this,Pr,void 0),this.emit("empty"),A(this,Or)===0&&this.emit("idle"),!1;if(!A(this,Fn)){const t=!A(this,Ne,s7);if(A(this,Ne,t7)&&A(this,Ne,r7)){const r=A(this,Ft).dequeue();return r?(this.emit("active"),r(),t&&D(this,Ne,s0).call(this),!0):!1}}return!1},s0=function(){A(this,Mo)||A(this,Pr)!==void 0||(Ae(this,Pr,setInterval(()=>{D(this,Ne,o0).call(this)},A(this,Uo))),Ae(this,Xc,Date.now()+A(this,Uo)))},o0=function(){A(this,Ri)===0&&A(this,Or)===0&&A(this,Pr)&&(clearInterval(A(this,Pr)),Ae(this,Pr,void 0)),Ae(this,Ri,A(this,Bo)?A(this,Or):0),D(this,Ne,bu).call(this)},bu=function(){for(;D(this,Ne,wu).call(this););},o7=async function(t){return new Promise((r,i)=>{t.addEventListener("abort",()=>{i(t.reason)},{once:!0})})},vu=async function(t,r){return new Promise(i=>{const s=()=>{r&&!r()||(this.off(t,s),i())};this.on(t,s)})};function a7(n){const e=[_n.A];return n==null?e:Array.isArray(n)?n.length===0?e:n:[n]}const c7=60;function l7(n){return{Status:n.Status??0,TC:n.TC??n.flag_tc??!1,RD:n.RD??n.flag_rd??!1,RA:n.RA??n.flag_ra??!1,AD:n.AD??n.flag_ad??!1,CD:n.CD??n.flag_cd??!1,Question:(n.Question??n.questions??[]).map(e=>({name:e.name,type:_n[e.type]})),Answer:(n.Answer??n.answers??[]).map(e=>({name:e.name,type:_n[e.type],TTL:e.TTL??e.ttl??c7,data:e.data instanceof Uint8Array?U(e.data):e.data}))}}const nk=4;function om(n,e={}){const t=new fl({concurrency:e.queryConcurrency??nk});return async(r,i={})=>{var a;const s=new URLSearchParams;s.set("name",r),a7(i.types).forEach(c=>{s.append("type",_n[c])}),(a=i.onProgress)==null||a.call(i,new N("dns:query",{detail:r}));const o=await t.add(async()=>{var d;const c=await fetch(`${n}?${s}`,{headers:{accept:"application/dns-json"},signal:i==null?void 0:i.signal});if(c.status!==200)throw new Error(`Unexpected HTTP status: ${c.status} - ${c.statusText}`);const u=l7(await c.json());return(d=i.onProgress)==null||d.call(i,new N("dns:response",{detail:u})),u},{signal:i.signal});if(o==null)throw new Error("No DNS response received");return o}}function ik(){return[om("https://cloudflare-dns.com/dns-query"),om("https://dns.google/resolve")]}var sk=function(n){if(!n)throw Error("hashlru must have a max value, of type number, greater than 0");var e=0,t=Object.create(null),r=Object.create(null);function i(s,o){t[s]=o,e++,e>=n&&(e=0,r=t,t=Object.create(null))}return{has:function(s){return t[s]!==void 0||r[s]!==void 0},remove:function(s){t[s]!==void 0&&(t[s]=void 0),r[s]!==void 0&&(r[s]=void 0)},get:function(s){var o=t[s];if(o!==void 0)return o;if((o=r[s])!==void 0)return i(s,o),o},set:function(s,o){t[s]!==void 0?t[s]=o:i(s,o)},clear:function(){t=Object.create(null),r=Object.create(null)}}};const ok=ol(sk);class ak{constructor(e){l(this,"lru");this.lru=ok(e)}get(e,t){let r=!0;const i=[];for(const s of t){const o=this.getAnswers(e,s);if(o.length===0){r=!1;break}i.push(...o)}if(r)return l7({answers:i})}getAnswers(e,t){const r=`${e.toLowerCase()}-${t}`,i=this.lru.get(r);if(i!=null){const s=i.filter(o=>o.expires>Date.now()).map(({expires:o,value:a})=>({...a,TTL:Math.round((o-Date.now())/1e3),type:_n[a.type]}));return s.length===0&&this.lru.remove(r),s}return[]}add(e,t){const r=`${e.toLowerCase()}-${t.type}`,i=this.lru.get(r)??[];i.push({expires:Date.now()+(t.TTL??c7)*1e3,value:t}),this.lru.set(r,i)}remove(e,t){const r=`${e.toLowerCase()}-${t}`;this.lru.remove(r)}clear(){this.lru.clear()}}function ck(n){return new ak(n)}const lk=1e3;let uk=class{constructor(e){l(this,"resolvers");l(this,"cache");this.resolvers={},this.cache=ck(e.cacheSize??lk),Object.entries(e.resolvers??{}).forEach(([t,r])=>{Array.isArray(r)||(r=[r]),t.endsWith(".")||(t=`${t}.`),this.resolvers[t]=r}),this.resolvers["."]==null&&(this.resolvers["."]=ik())}async query(e,t={}){var c,u,d;const r=a7(t.types),i=t.cached!==!1?this.cache.get(e,r):void 0;if(i!=null)return(c=t.onProgress)==null||c.call(t,new N("dns:cache",{detail:i})),i;const s=`${e.split(".").pop()}.`,o=(this.resolvers[s]??this.resolvers["."]).sort(()=>Math.random()>.5?-1:1),a=[];for(const h of o){if(((u=t.signal)==null?void 0:u.aborted)===!0)break;try{const f=await h(e,{...t,types:r});for(const p of f.Answer)this.cache.add(e,p);return f}catch(f){a.push(f),(d=t.onProgress)==null||d.call(t,new N("dns:error",{detail:f}))}}throw a.length===1?a[0]:new AggregateError(a,`DNS lookup of ${e} ${r} failed`)}};var _n;(function(n){n[n.A=1]="A",n[n.CNAME=5]="CNAME",n[n.TXT=16]="TXT",n[n.AAAA=28]="AAAA"})(_n||(_n={}));function Xu(n={}){return new uk(n)}const Dn="/",u7=new TextEncoder().encode(Dn),Vl=u7[0];class Ue{constructor(e,t){l(this,"_buf");if(typeof e=="string")this._buf=R(e);else if(e instanceof Uint8Array)this._buf=e;else throw new Error("Invalid key, should be String of Uint8Array");if(t==null&&(t=!0),t&&this.clean(),this._buf.byteLength===0||this._buf[0]!==Vl)throw new Error("Invalid key")}toString(e="utf8"){return U(this._buf,e)}uint8Array(){return this._buf}get[Symbol.toStringTag](){return`Key(${this.toString()})`}static withNamespaces(e){return new Ue(e.join(Dn))}static random(){return new Ue(Math.random().toString().substring(2))}static asKey(e){return e instanceof Uint8Array||typeof e=="string"?new Ue(e):typeof e.uint8Array=="function"?new Ue(e.uint8Array()):null}clean(){if((this._buf==null||this._buf.byteLength===0)&&(this._buf=u7),this._buf[0]!==Vl){const e=new Uint8Array(this._buf.byteLength+1);e.fill(Vl,0,1),e.set(this._buf,1),this._buf=e}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===Vl;)this._buf=this._buf.subarray(0,-1)}less(e){const t=this.list(),r=e.list();for(let i=0;i<t.length;i++){if(r.length<i+1)return!1;const s=t[i],o=r[i];if(s<o)return!0;if(s>o)return!1}return t.length<r.length}reverse(){return Ue.withNamespaces(this.list().slice().reverse())}namespaces(){return this.list()}baseNamespace(){const e=this.namespaces();return e[e.length-1]}list(){return this.toString().split(Dn).slice(1)}type(){return dk(this.baseNamespace())}name(){return hk(this.baseNamespace())}instance(e){return new Ue(this.toString()+":"+e)}path(){let e=this.parent().toString();return e.endsWith(Dn)||(e+=Dn),e+=this.type(),new Ue(e)}parent(){const e=this.list();return e.length===1?new Ue(Dn):new Ue(e.slice(0,-1).join(Dn))}child(e){return this.toString()===Dn?e:e.toString()===Dn?this:new Ue(this.toString()+e.toString(),!1)}isAncestorOf(e){return e.toString()===this.toString()?!1:e.toString().startsWith(this.toString())}isDecendantOf(e){return e.toString()===this.toString()?!1:this.toString().startsWith(e.toString())}isTopLevel(){return this.list().length===1}concat(...e){return Ue.withNamespaces([...this.namespaces(),...fk(e.map(t=>t.namespaces()))])}}function dk(n){const e=n.split(":");return e.length<2?"":e.slice(0,-1).join(":")}function hk(n){const e=n.split(":");return e[e.length-1]}function fk(n){return[].concat(...n)}const d7="/pin/",am="/pinned-block/",a0=Cs,cm=1;function zl(n){return n.version===0&&(n=n.toV1()),new Ue(`${d7}${n.toString(a0)}`)}var ii,Su,c0;class pk{constructor(e,t,r){pe(this,ii);l(this,"datastore");l(this,"blockstore");l(this,"getCodec");this.datastore=e,this.blockstore=t,this.getCodec=r}async*add(e,t={}){const r=zl(e);if(await this.datastore.has(r))throw new Error("Already pinned");const i=Math.round(t.depth??1/0);if(i<0)throw new Error("Depth must be greater than or equal to 0");const s=new Wi({concurrency:cm});for await(const a of D(this,ii,Su).call(this,e,s,{...t,depth:i}))await D(this,ii,c0).call(this,a,c=>c.pinnedBy.find(u=>ke(u,e.bytes))!=null?!1:(c.pinCount++,c.pinnedBy.push(e.bytes),!0),t),yield a;const o={depth:i,metadata:t.metadata??{}};await this.datastore.put(r,hu(o),t)}async*rm(e,t={}){const r=zl(e),i=await this.datastore.get(r,t),s=hs(i);await this.datastore.delete(r,t);const o=new Wi({concurrency:cm});for await(const a of D(this,ii,Su).call(this,e,o,{...t,depth:s.depth}))await D(this,ii,c0).call(this,a,c=>(c.pinCount--,c.pinnedBy=c.pinnedBy.filter(u=>ke(u,e.bytes)),!0),{...t,depth:s.depth}),yield a}async*ls(e={}){for await(const{key:t,value:r}of this.datastore.query({prefix:d7+(e.cid!=null?`${e.cid.toString(Cs)}`:"")},e)){const i=le.parse(t.toString().substring(5),Cs),s=hs(r);yield{cid:i,...s}}}async isPinned(e,t={}){const r=new Ue(`${am}${a0.encode(e.multihash.bytes)}`);return this.datastore.has(r,t)}async get(e,t){const r=zl(e),i=await this.datastore.get(r,t);return hs(i)}async setMetadata(e,t,r){const i=zl(e),s=await this.datastore.get(i,r),o=hs(s);o.metadata=t??{},await this.datastore.put(i,hu(o),r)}}ii=new WeakSet,Su=async function*(e,t,r){if(r.depth===-1)return;const i=await this.getCodec(e.code),s=await this.blockstore.get(e,r),o=Yf({bytes:s,cid:e,codec:i});yield e;for(const[,a]of o.links())yield*await t.add(async()=>D(this,ii,Su).call(this,a,t,{...r,depth:r.depth-1}))},c0=async function(e,t,r){var a;const i=new Ue(`${am}${a0.encode(e.multihash.bytes)}`);let s={pinCount:0,pinnedBy:[]};try{s=hs(await this.datastore.get(i,r))}catch(c){if(c.name!=="NotFoundError")throw c}if(t(s)){if(s.pinCount===0&&await this.datastore.has(i)){await this.datastore.delete(i);return}await this.datastore.put(i,hu(s),r),(a=r.onProgress)==null||a.call(r,new N("helia:pin:add",e))}};const gk=1,mk=5;class h7 extends Error{constructor(e="Insufficient providers found"){super(e),this.name="InsufficientProvidersError"}}l(h7,"name","InsufficientProvidersError");class Wa extends Error{constructor(e="No routers available"){super(e),this.name="NoRoutersAvailableError"}}l(Wa,"name","NoRoutersAvailableError");class f7 extends Error{constructor(e="Unknown hash algorithm"){super(e),this.name="UnknownHashAlgorithmError"}}l(f7,"name","UnknownHashAlgorithmError");class p7 extends Error{constructor(e="Unknown codec"){super(e),this.name="UnknownCodecError"}}l(p7,"name","UnknownCodecError");const yk=5;class wk{constructor(e,t){l(this,"log");l(this,"routers");l(this,"providerLookupConcurrency");var r,i,s,o,a,c,u;this.log=e.logger.forComponent("helia:routing"),this.routers=t.routers??[],this.providerLookupConcurrency=t.providerLookupConcurrency??yk,this.findProviders=((r=e.metrics)==null?void 0:r.traceFunction("helia.routing.findProviders",this.findProviders.bind(this),{optionsIndex:1}))??this.findProviders,this.provide=((i=e.metrics)==null?void 0:i.traceFunction("helia.routing.provide",this.provide.bind(this),{optionsIndex:1}))??this.provide,this.cancelReprovide=((s=e.metrics)==null?void 0:s.traceFunction("helia.routing.cancelReprovide",this.cancelReprovide.bind(this),{optionsIndex:1}))??this.cancelReprovide,this.put=((o=e.metrics)==null?void 0:o.traceFunction("helia.routing.put",this.put.bind(this),{optionsIndex:2}))??this.put,this.get=((a=e.metrics)==null?void 0:a.traceFunction("helia.routing.get",this.get.bind(this),{optionsIndex:1}))??this.get,this.findPeer=((c=e.metrics)==null?void 0:c.traceFunction("helia.routing.findPeer",this.findPeer.bind(this),{optionsIndex:1}))??this.findPeer,this.getClosestPeers=((u=e.metrics)==null?void 0:u.traceFunction("helia.routing.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1}))??this.getClosestPeers}async start(){await li(...this.routers)}async stop(){await rs(...this.routers)}async*findProviders(e,t={}){if(this.routers.length===0)throw new Wa("No content routers available");const r=new Gi({concurrency:this.providerLookupConcurrency});r.addEventListener("error",()=>{});for await(const i of $i(r.toGenerator(),...cs(this.routers,"findProviders").map(s=>s.findProviders(e,t))))if(i!=null){if(i.multiaddrs.length===0){if(r.find(i.id)!=null)continue;r.add(async()=>{try{const s=await this.findPeer(i.id,t);return s.multiaddrs.length===0?null:s}catch(s){return this.log.error("could not load multiaddrs for peer %p",i.id,s),null}},{peerId:i.id,signal:t.signal}).catch(s=>{this.log.error("could not load multiaddrs for peer %p",i.id,s)})}yield i}}async provide(e,t={}){if(this.routers.length===0)throw new Wa("No content routers available");await Promise.all(cs(this.routers,"provide").map(async r=>{await r.provide(e,t)}))}async cancelReprovide(e,t={}){await Promise.all(cs(this.routers,"cancelReprovide").map(async r=>{await r.cancelReprovide(e,t)}))}async put(e,t,r){await Promise.all(cs(this.routers,"put").map(async i=>{await i.put(e,t,r)}))}async get(e,t){return Promise.any(cs(this.routers,"get").map(async r=>r.get(e,t)))}async findPeer(e,t){if(this.routers.length===0)throw new Wa("No peer routers available");const r=this,i=$i(...cs(this.routers,"findPeer").map(s=>async function*(){try{yield await s.findPeer(e,t)}catch(o){r.log.error(o)}}()));for await(const s of i)if(s!=null)return s;throw new tr("Could not find peer in routing")}async*getClosestPeers(e,t={}){if(this.routers.length===0)throw new Wa("No peer routers available");for await(const r of $i(...cs(this.routers,"getClosestPeers").map(i=>i.getClosestPeers(e,t))))r!=null&&(yield r)}}function cs(n,e){return n.filter(t=>t[e]!=null)}class g7 extends Error{constructor(e="The queue was full"){super(e),this.name="QueueFullError"}}l(g7,"name","QueueFullError");class bk{constructor(e){l(this,"deferred");l(this,"signal");var t;this.signal=e,this.deferred=Promise.withResolvers(),this.onAbort=this.onAbort.bind(this),(t=this.signal)==null||t.addEventListener("abort",this.onAbort)}onAbort(){var e;this.deferred.reject(((e=this.signal)==null?void 0:e.reason)??new Wo)}cleanup(){var e;(e=this.signal)==null||e.removeEventListener("abort",this.onAbort)}}function vk(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}class Sk{constructor(e,t){l(this,"id");l(this,"fn");l(this,"options");l(this,"recipients");l(this,"status");l(this,"timeline");l(this,"controller");this.id=vk(),this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce((t,r)=>{var i;return t&&((i=r.signal)==null?void 0:i.aborted)===!0},!0)&&(this.controller.abort(new Wo),this.cleanup())}async join(e={}){var r;const t=new bk(e.signal);return this.recipients.push(t),(r=e.signal)==null||r.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();const e=await yt(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(t=>{t.deferred.resolve(e)}),this.status="complete"}catch(e){this.recipients.forEach(t=>{t.deferred.reject(e)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(e=>{var t;e.cleanup(),(t=e.signal)==null||t.removeEventListener("abort",this.onAbort)})}}function lm(n,e){let t;const r=function(){const i=function(){t=void 0,n()};clearTimeout(t),t=setTimeout(i,e)};return r.start=()=>{},r.stop=()=>{clearTimeout(t)},r}class um extends ot{constructor(t={}){super();l(this,"concurrency");l(this,"maxSize");l(this,"queue");l(this,"pending");l(this,"sort");l(this,"autoStart");this.concurrency=t.concurrency??Number.POSITIVE_INFINITY,this.maxSize=t.maxSize??Number.POSITIVE_INFINITY,this.pending=0,this.autoStart=t.autoStart??!0,this.sort=t.sort,this.queue=[],this.emitEmpty=lm(this.emitEmpty.bind(this),1),this.emitIdle=lm(this.emitIdle.bind(this),1)}[Symbol.asyncIterator](){return this.toGenerator()}emitEmpty(){this.size===0&&this.safeDispatchEvent("empty")}emitIdle(){this.running===0&&this.safeDispatchEvent("idle")}tryToStartAnother(){if(this.size===0)return this.emitEmpty(),this.running===0&&this.emitIdle(),!1;if(this.pending<this.concurrency){let t;for(const r of this.queue)if(r.status==="queued"){t=r;break}return t==null?!1:(this.safeDispatchEvent("active"),this.pending++,t.run().finally(()=>{for(let r=0;r<this.queue.length;r++)if(this.queue[r]===t){this.queue.splice(r,1);break}this.pending--,this.safeDispatchEvent("next"),this.autoStart&&this.tryToStartAnother()}),!0)}return!1}enqueue(t){this.queue.push(t),this.sort!=null&&this.queue.sort(this.sort)}start(){this.autoStart===!1&&(this.autoStart=!0,this.tryToStartAnother())}pause(){this.autoStart=!1}async add(t,r){var s;if((s=r==null?void 0:r.signal)==null||s.throwIfAborted(),this.size===this.maxSize)throw new g7;const i=new Sk(t,r);return this.enqueue(i),this.safeDispatchEvent("add"),this.autoStart&&this.tryToStartAnother(),i.join(r).then(o=>(this.safeDispatchEvent("success",{detail:{job:i,result:o}}),o)).catch(o=>{if(i.status==="queued"){for(let a=0;a<this.queue.length;a++)if(this.queue[a]===i){this.queue.splice(a,1);break}}throw this.safeDispatchEvent("failure",{detail:{job:i,error:o}}),o})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(t=>{t.abort(new Wo)}),this.clear()}async onEmpty(t){this.size!==0&&await Vt(this,"empty",t==null?void 0:t.signal)}async onSizeLessThan(t,r){this.size<t||await Vt(this,"next",r==null?void 0:r.signal,{filter:()=>this.size<t})}async onIdle(t){this.pending===0&&this.size===0||await Vt(this,"idle",t==null?void 0:t.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(t){var u,d,h;(u=t==null?void 0:t.signal)==null||u.throwIfAborted();const r=cn({objectMode:!0}),i=f=>{f!=null?this.abort():this.clear(),r.end(f)},s=f=>{f.detail!=null&&r.push(f.detail.result)},o=f=>{i(f.detail.error)},a=()=>{i()},c=()=>{i(new Wo("Queue aborted"))};this.addEventListener("success",s),this.addEventListener("failure",o),this.addEventListener("idle",a),(d=t==null?void 0:t.signal)==null||d.addEventListener("abort",c);try{yield*r}finally{this.removeEventListener("success",s),this.removeEventListener("failure",o),this.removeEventListener("idle",a),(h=t==null?void 0:t.signal)==null||h.removeEventListener("abort",c),i()}}}const m7="lock:worker:request-read",y7="lock:worker:abort-read-request",w7="lock:worker:release-read",b7="lock:master:grant-read",v7="lock:master:error-read",S7="lock:worker:request-write",E7="lock:worker:abort-write-request",x7="lock:worker:release-write",A7="lock:master:grant-write",k7="lock:master:error-write",_7="lock:worker:finalize",I7="mortice",Ek={singleProcess:!1},dm=(n,e,t,r,i,s,o,a,c)=>u=>{if(u.data==null)return;const d={type:u.data.type,name:u.data.name,identifier:u.data.identifier};d.type===i&&n.safeDispatchEvent(t,{detail:{name:d.name,identifier:d.identifier,handler:async()=>{e.postMessage({type:c,name:d.name,identifier:d.identifier}),await new Promise(h=>{const f=p=>{if((p==null?void 0:p.data)==null)return;const m={type:p.data.type,name:p.data.name,identifier:p.data.identifier};m.type===a&&m.identifier===d.identifier&&(e.removeEventListener("message",f),h())};e.addEventListener("message",f)})},onError:h=>{e.postMessage({type:o,name:d.name,identifier:d.identifier,error:{message:h.message,name:h.name,stack:h.stack}})}}}),d.type===s&&n.safeDispatchEvent(r,{detail:{name:d.name,identifier:d.identifier}}),d.type===_7&&n.safeDispatchEvent("finalizeRequest",{detail:{name:d.name}})},xk=(n=10)=>Math.random().toString().substring(2,n+2);class Ak{constructor(e){l(this,"name");l(this,"channel");this.name=e,this.channel=new BroadcastChannel(I7)}readLock(e){return this.sendRequest(m7,y7,b7,v7,w7,e)}writeLock(e){return this.sendRequest(S7,E7,A7,k7,x7,e)}finalize(){this.channel.postMessage({type:_7,name:this.name}),this.channel.close()}async sendRequest(e,t,r,i,s,o){var c;(c=o==null?void 0:o.signal)==null||c.throwIfAborted();const a=xk();return this.channel.postMessage({type:e,identifier:a,name:this.name}),new Promise((u,d)=>{var p;const h=()=>{this.channel.postMessage({type:t,identifier:a,name:this.name})};(p=o==null?void 0:o.signal)==null||p.addEventListener("abort",h,{once:!0});const f=m=>{var w,b,S,k;if(((w=m.data)==null?void 0:w.identifier)===a&&(((b=m.data)==null?void 0:b.type)===r&&(this.channel.removeEventListener("message",f),(S=o==null?void 0:o.signal)==null||S.removeEventListener("abort",h),u(()=>{this.channel.postMessage({type:s,identifier:a,name:this.name})})),m.data.type===i)){this.channel.removeEventListener("message",f),(k=o==null?void 0:o.signal)==null||k.removeEventListener("abort",h);const C=new Error;m.data.error!=null&&(C.message=m.data.error.message,C.name=m.data.error.name,C.stack=m.data.error.stack),d(C)}};this.channel.addEventListener("message",f)})}}const kk=n=>{if(n=Object.assign({},Ek,n),!!globalThis.document||n.singleProcess){const t=new BroadcastChannel(I7),r=new ot;return t.addEventListener("message",dm(r,t,"requestReadLock","abortReadLockRequest",m7,y7,v7,w7,b7)),t.addEventListener("message",dm(r,t,"requestWriteLock","abortWriteLockRequest",S7,E7,k7,x7,A7)),r}return new Ak(n.name)},ws=new Map;let Ua;function C7(n){return typeof(n==null?void 0:n.readLock)=="function"&&typeof(n==null?void 0:n.writeLock)=="function"}function _k(n){if(Ua==null&&(Ua=kk(n),!C7(Ua))){const e=Ua;e.addEventListener("requestReadLock",t=>{const r=t.detail.name,i=t.detail.identifier,s=ws.get(r);if(s==null)return;const o=new AbortController,a=c=>{c.detail.name!==r||c.detail.identifier!==i||o.abort()};e.addEventListener("abortReadLockRequest",a),s.readLock({signal:o.signal}).then(async c=>{await t.detail.handler().finally(()=>{c()})}).catch(c=>{t.detail.onError(c)}).finally(()=>{e.removeEventListener("abortReadLockRequest",a)})}),e.addEventListener("requestWriteLock",t=>{const r=t.detail.name,i=t.detail.identifier,s=ws.get(r);if(s==null)return;const o=new AbortController,a=c=>{c.detail.name!==r||c.detail.identifier!==i||o.abort()};e.addEventListener("abortWriteLockRequest",a),s.writeLock({signal:o.signal}).then(async c=>{await t.detail.handler().finally(()=>{c()})}).catch(c=>{t.detail.onError(c)}).finally(()=>{e.removeEventListener("abortWriteLockRequest",a)})}),e.addEventListener("finalizeRequest",t=>{const r=t.detail.name,i=ws.get(r);i!=null&&i.finalize()})}return Ua}async function Y1(n,e){var o;let t,r;const i=new Promise((a,c)=>{t=a,r=c}),s=()=>{r(new Wo)};return(o=e==null?void 0:e.signal)==null||o.addEventListener("abort",s,{once:!0}),n.add(async()=>{await new Promise(a=>{t(()=>{var c;(c=e==null?void 0:e.signal)==null||c.removeEventListener("abort",s),a()})})},{signal:e==null?void 0:e.signal}).catch(a=>{r(a)}),i}const Ik=(n,e)=>{let t=ws.get(n);if(t!=null)return t;const r=_k(e);if(C7(r))return t=r,ws.set(n,t),t;const i=new um({concurrency:1});let s;return t={async readLock(o){if(s!=null)return Y1(s,o);s=new um({concurrency:e.concurrency,autoStart:!1});const a=s,c=Y1(s,o);return i.add(async()=>{a.start(),await a.onIdle().then(()=>{s===a&&(s=null)})}),c},async writeLock(o){return s=null,Y1(i,o)},finalize:()=>{ws.delete(n)},queue:i},ws.set(n,t),e.autoFinalize===!0&&i.addEventListener("idle",()=>{t.finalize()},{once:!0}),t},Ck={name:"lock",concurrency:1/0,singleProcess:!1,autoFinalize:!1};function T7(n){const e=Object.assign({},Ck,n);return Ik(e.name,e)}class Tk{constructor(e,t,r={}){l(this,"lock");l(this,"child");l(this,"pins");l(this,"started");this.child=e,this.pins=t,this.lock=T7({singleProcess:r.holdGcLock}),this.started=!1}isStarted(){return this.started}async start(){await li(this.child),this.started=!0}async stop(){await rs(this.child),this.started=!1}unwrap(){return this.child}async put(e,t,r={}){var s;(s=r==null?void 0:r.signal)==null||s.throwIfAborted();const i=await this.lock.readLock();try{return await this.child.put(e,t,r)}finally{i()}}async*putMany(e,t={}){var i;(i=t==null?void 0:t.signal)==null||i.throwIfAborted();const r=await this.lock.readLock();try{yield*this.child.putMany(e,t)}finally{r()}}async get(e,t={}){var i;(i=t==null?void 0:t.signal)==null||i.throwIfAborted();const r=await this.lock.readLock();try{return await this.child.get(e,t)}finally{r()}}async*getMany(e,t={}){var i;(i=t==null?void 0:t.signal)==null||i.throwIfAborted();const r=await this.lock.readLock();try{yield*this.child.getMany(e,t)}finally{r()}}async delete(e,t={}){var i;(i=t==null?void 0:t.signal)==null||i.throwIfAborted();const r=await this.lock.writeLock();try{if(await this.pins.isPinned(e))throw new Error("CID was pinned");await this.child.delete(e,t)}finally{r()}}async*deleteMany(e,t={}){var i;(i=t==null?void 0:t.signal)==null||i.throwIfAborted();const r=await this.lock.writeLock();try{const s=this;yield*this.child.deleteMany(async function*(){for await(const o of e){if(await s.pins.isPinned(o))throw new Error("CID was pinned");yield o}}(),t)}finally{r()}}async has(e,t={}){var i;(i=t==null?void 0:t.signal)==null||i.throwIfAborted();const r=await this.lock.readLock();try{return await this.child.has(e,t)}finally{r()}}async*getAll(e={}){var r;(r=e==null?void 0:e.signal)==null||r.throwIfAborted();const t=await this.lock.readLock();try{yield*this.child.getAll(e)}finally{t()}}createSession(e,t){var r;return(r=t==null?void 0:t.signal)==null||r.throwIfAborted(),this.child.createSession(e,t)}}const X1=new Ue("/version"),hm=1;async function Rk(n){if(!await n.has(X1)){await n.put(X1,R(`${hm}`));return}const e=await n.get(X1),t=U(e);if(parseInt(t,10)!==hm)throw new Error("Unknown datastore version, a datastore migration may be required")}function rg(n){return(n==null?void 0:n.then)!=null}function Pk(n=[],e){const t={[At]:nl,[Bt]:j6,[oi]:oE,[ks]:sE,[qo]:iE};return n.forEach(r=>{t[r.code]=r}),async r=>{let i=t[r];if(i==null&&e!=null){const s=e(r);rg(s)?i=await s:i=s,t[i.code]=i}if(i!=null)return i;throw new p7(`Could not load codec for ${r}`)}}function Ok(n=[],e){const t={[ut.code]:ut,[$3.code]:$3,[nn.code]:nn};return n.forEach(r=>{t[r.code]=r}),async r=>{let i=t[r];if(i==null&&e!=null){const s=e(r);rg(s)?i=await s:i=s,t[i.code]=i}if(i!=null)return i;throw new f7(`No hasher configured for multihash code 0x${r.toString(16)}, please configure one. You can look up which hash this is at https://github.com/multiformats/multicodec/blob/master/table.csv`)}}var Hn;let ng=(Hn=class extends Error{constructor(t="Not Found"){super(t);l(this,"name",Hn.name);l(this,"code",Hn.code)}},l(Hn,"name","NotFoundError"),l(Hn,"code","ERR_NOT_FOUND"),Hn);class R7{has(e,t){return Promise.reject(new Error(".has is not implemented"))}put(e,t,r){return Promise.reject(new Error(".put is not implemented"))}async*putMany(e,t){for await(const{cid:r,block:i}of e)await this.put(r,i,t),yield r}get(e,t){return Promise.reject(new Error(".get is not implemented"))}async*getMany(e,t){for await(const r of e)yield{cid:r,block:await this.get(r,t)}}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*deleteMany(e,t){for await(const r of e)await this.delete(r,t),yield r}async*getAll(e){throw new Error(".getAll is not implemented")}}const Kl=0;class Dk extends R7{constructor(t){super();l(this,"child");this.child=t}put(t,r,i){var s,o;return t.multihash.code===Kl?((s=i==null?void 0:i.signal)==null||s.throwIfAborted(),t):this.child==null?((o=i==null?void 0:i.signal)==null||o.throwIfAborted(),t):this.child.put(t,r,i)}get(t,r){var i,s;if(t.multihash.code===Kl)return(i=r==null?void 0:r.signal)==null||i.throwIfAborted(),t.multihash.digest;if(this.child==null)throw(s=r==null?void 0:r.signal)==null||s.throwIfAborted(),new ng;return this.child.get(t,r)}has(t,r){var i,s;return t.multihash.code===Kl?((i=r==null?void 0:r.signal)==null||i.throwIfAborted(),!0):this.child==null?((s=r==null?void 0:r.signal)==null||s.throwIfAborted(),!1):this.child.has(t,r)}delete(t,r){var i;if(t.code===Kl){(i=r==null?void 0:r.signal)==null||i.throwIfAborted();return}if(this.child!=null)return this.child.delete(t,r)}getAll(t){var r;return this.child!=null?this.child.getAll(t):((r=t==null?void 0:t.signal)==null||r.throwIfAborted(),[])}}function Nk(n){return n[Symbol.asyncIterator]!=null}function Mn(n,e){let t=0;if(Nk(n))return async function*(){for await(const c of n)await e(c,t++)&&(yield c)}();const r=Q6(n),{value:i,done:s}=r.next();if(s===!0)return function*(){}();const o=e(i,t++);if(typeof o.then=="function")return async function*(){await o&&(yield i);for(const c of r)await e(c,t++)&&(yield c)}();const a=e;return function*(){o===!0&&(yield i);for(const c of r)a(c,t++)&&(yield c)}()}function Lk(n){return n[Symbol.asyncIterator]!=null}function fm(n){return(n==null?void 0:n.then)!=null}function Zu(n,e){let t=0;if(Lk(n))return async function*(){for await(const c of n){const u=e(c,t++);fm(u)&&await u,yield c}}();const r=Q6(n),{value:i,done:s}=r.next();if(s===!0)return function*(){}();const o=e(i,t++);if(typeof(o==null?void 0:o.then)=="function")return async function*(){yield i;for(const c of r){const u=e(c,t++);fm(u)&&await u,yield c}}();const a=e;return function*(){yield i;for(const c of r)a(c,t++),yield c}()}class P7{constructor(e){l(this,"child");l(this,"getHasher");l(this,"log");l(this,"logger");l(this,"components");this.log=e.logger.forComponent("helia:networked-storage"),this.logger=e.logger,this.components=e,this.child=new Dk(e.blockstore),this.getHasher=e.getHasher}async put(e,t,r={}){var i,s,o;return await this.child.has(e,r)?((i=r.onProgress)==null||i.call(r,new N("blocks:put:duplicate",e)),e):((s=r.onProgress)==null||s.call(r,new N("blocks:put:providers:notify",e)),await Promise.all(this.components.blockBrokers.map(async a=>{var c;return(c=a.announce)==null?void 0:c.call(a,e,t,r)})),(o=r.onProgress)==null||o.call(r,new N("blocks:put:blockstore:put",e)),this.child.put(e,t,r))}async*putMany(e,t={}){var s;const r=Mn(e,async({cid:o})=>{var c;const a=await this.child.has(o,t);return a&&((c=t.onProgress)==null||c.call(t,new N("blocks:put-many:duplicate",o))),!a}),i=Zu(r,async({cid:o,block:a})=>{var c;(c=t.onProgress)==null||c.call(t,new N("blocks:put-many:providers:notify",o)),await Promise.all(this.components.blockBrokers.map(async u=>{var d;return(d=u.announce)==null?void 0:d.call(u,o,a,t)}))});(s=t.onProgress)==null||s.call(t,new N("blocks:put-many:blockstore:put-many")),yield*this.child.putMany(i,t)}async get(e,t={}){var r,i,s,o;if(t.offline!==!0&&!await this.child.has(e,t)){const a=await this.getHasher(e.multihash.code);(r=t.onProgress)==null||r.call(t,new N("blocks:get:providers:get",e));const c=await pm(e,this.components.blockBrokers,a,{...t,log:this.log});return(i=t.onProgress)==null||i.call(t,new N("blocks:get:blockstore:put",e)),await this.child.put(e,c,t),(s=t.onProgress)==null||s.call(t,new N("blocks:get:providers:notify",e)),await Promise.all(this.components.blockBrokers.map(async u=>{var d;return(d=u.announce)==null?void 0:d.call(u,e,c,t)})),c}return(o=t.onProgress)==null||o.call(t,new N("blocks:get:blockstore:get",e)),this.child.get(e,t)}async*getMany(e,t={}){var r;(r=t.onProgress)==null||r.call(t,new N("blocks:get-many:blockstore:get-many")),yield*this.child.getMany(Zu(e,async i=>{var s,o,a;if(t.offline!==!0&&!await this.child.has(i,t)){const c=await this.getHasher(i.multihash.code);(s=t.onProgress)==null||s.call(t,new N("blocks:get-many:providers:get",i));const u=await pm(i,this.components.blockBrokers,c,{...t,log:this.log});(o=t.onProgress)==null||o.call(t,new N("blocks:get-many:blockstore:put",i)),await this.child.put(i,u,t),(a=t.onProgress)==null||a.call(t,new N("blocks:get-many:providers:notify",i)),await Promise.all(this.components.blockBrokers.map(async d=>{var h;return(h=d.announce)==null?void 0:h.call(d,i,u,t)}))}}))}async delete(e,t={}){var r;(r=t.onProgress)==null||r.call(t,new N("blocks:delete:blockstore:delete",e)),await this.child.delete(e,t)}async*deleteMany(e,t={}){var r;(r=t.onProgress)==null||r.call(t,new N("blocks:delete-many:blockstore:delete-many")),yield*this.child.deleteMany(async function*(){for await(const i of e)yield i}(),t)}async has(e,t={}){return this.child.has(e,t)}async*getAll(e={}){var t;(t=e.onProgress)==null||t.call(e,new N("blocks:get-all:blockstore:get-many")),yield*this.child.getAll(e)}}class Bk extends P7{constructor(t){super(t);l(this,"started");this.started=!1}isStarted(){return this.started}async start(){await li(this.child,...this.components.blockBrokers),this.started=!0}async stop(){await rs(this.child,...this.components.blockBrokers),this.started=!1}unwrap(){return this.child}createSession(t,r){const i=this.components.blockBrokers.map(s=>s.createSession==null?s:s.createSession(r));return new Mk({blockstore:this.child,blockBrokers:i,getHasher:this.getHasher,logger:this.logger},{root:t})}}class Mk extends P7{constructor(t,r){super(t);l(this,"closeController");this.closeController=new AbortController,this.closeController.signal,this.log=t.logger.forComponent(`helia:session-storage:${r.root}`)}close(){this.closeController.abort()}async put(t,r,i={}){const s=Le([this.closeController.signal,i.signal]);try{return await super.put(t,r,{...i,signal:s})}finally{s.clear()}}async*putMany(t,r={}){const i=Le([this.closeController.signal,r.signal]);try{yield*super.putMany(t,{...r,signal:i})}finally{i.clear()}}async get(t,r={}){const i=Le([this.closeController.signal,r.signal]);try{return await super.get(t,{...r,signal:i})}finally{i.clear()}}async*getMany(t,r={}){const i=Le([this.closeController.signal,r.signal]);try{yield*super.getMany(t,{...r,signal:i})}finally{i.clear()}}async delete(t,r={}){const i=Le([this.closeController.signal,r.signal]);try{await super.delete(t,{...r,signal:i})}finally{i.clear()}}async*deleteMany(t,r={}){const i=Le([this.closeController.signal,r.signal]);try{yield*super.deleteMany(t,{...r,signal:i})}finally{i.clear()}}async has(t,r={}){const i=Le([this.closeController.signal,r.signal]);try{return await super.has(t,{...r,signal:i})}finally{i.clear()}}async*getAll(t={}){const r=Le([this.closeController.signal,t.signal]);try{yield*super.getAll({...t,signal:r})}finally{r.clear()}}}function Uk(n){return typeof n.retrieve=="function"}const Fk=(n,e)=>{if(e==null)throw new O(`No hasher configured for multihash code 0x${n.multihash.code.toString(16)}, please configure one. You can look up which hash this is at https://github.com/multiformats/multicodec/blob/master/table.csv`);return async t=>{let r;const i=e.digest(t);if(rg(i)?r=await i:r=i,!ke(r.digest,n.multihash.digest))throw new Sh("Hash of downloaded block did not match multihash from passed CID")}};async function pm(n,e,t,r){const i=Fk(n,t),s=new AbortController,o=Le([s.signal,r.signal]);s.signal;const a=[];for(const c of e)Uk(c)&&a.push(c);try{return await Promise.any(a.map(async c=>{try{let u=!1;const d=await c.retrieve(n,{...r,signal:o,validateFn:async h=>{await i(h),u=!0}});return u||await i(d),d}catch(u){throw r.log.error("could not retrieve verified block for %c",n,u),u}}))}finally{s.abort(),o.clear()}}class O7 extends ot{constructor(t,r){super();l(this,"initialPeerSearchComplete");l(this,"requests");l(this,"name");l(this,"log");l(this,"logger");l(this,"minProviders");l(this,"maxProviders");l(this,"providers");l(this,"evictionFilter");l(this,"initialProviders");this.name=r.name,this.logger=t.logger,this.log=t.logger.forComponent(this.name),this.requests=new Map,this.minProviders=r.minProviders??gk,this.maxProviders=r.maxProviders??mk,this.providers=[],this.evictionFilter=Qi(this.maxProviders),this.initialProviders=r.providers??[]}async retrieve(t,r={}){var h,f;const i=Zn.encode(t.multihash.bytes),s=this.requests.get(i);if(s!=null)return this.log("join existing request for %c",t),s;const o=ve();if(this.requests.set(i,o.promise),this.providers.length===0){let p=!1;this.initialPeerSearchComplete==null&&(p=!0,this.log=this.logger.forComponent(`${this.name}:${t}`),this.initialPeerSearchComplete=this.findProviders(t,this.minProviders,r)),await this.initialPeerSearchComplete,p&&this.log("found initial session peers for %c",t)}let a=!1;const c=new Wi({concurrency:this.maxProviders});c.addEventListener("error",()=>{}),c.addEventListener("failure",p=>{this.log.error("error querying provider %o, evicting from session",p.detail.job.options.provider,p.detail.error),this.evict(p.detail.job.options.provider)}),c.addEventListener("success",p=>{a=!0,o.resolve(p.detail.result)}),c.addEventListener("idle",()=>{var p;if(a||((p=r.signal)==null?void 0:p.aborted)===!0){this.log.trace("session idle, found block");return}Promise.resolve().then(async()=>{this.log("no session peers had block for for %c, finding new providers",t);for(let m=0;m<this.minProviders&&this.providers.length!==0;m++){const w=this.providers[Math.floor(Math.random()*this.providers.length)];this.evict(w)}await this.findProviders(t,this.minProviders,r),this.log("found new providers re-retrieving %c",t),this.requests.delete(i),o.resolve(await this.retrieve(t,r))}).catch(m=>{this.log.error("could not find new providers for %c",t,m),o.reject(m)})});const u=p=>{c.add(async()=>this.queryProvider(t,p.detail,r),{provider:p.detail}).catch(m=>{var w;((w=r.signal)==null?void 0:w.aborted)!==!0&&this.log.error("error retrieving session block for %c",t,m)})};this.addEventListener("provider",u),Promise.all([...this.providers].map(async p=>c.add(async()=>this.queryProvider(t,p,r),{provider:p}))).catch(p=>{var m;((m=r.signal)==null?void 0:m.aborted)!==!0&&this.log.error("error retrieving session block for %c",t,p)});const d=()=>{var p;o.reject(new ci(((p=r.signal)==null?void 0:p.reason)??"Session aborted")),c.abort()};(h=r.signal)==null||h.addEventListener("abort",d);try{return await o.promise}finally{this.removeEventListener("provider",u),(f=r.signal)==null||f.removeEventListener("abort",d),c.clear(),this.requests.delete(i)}}evict(t){this.evictionFilter.add(this.toEvictionKey(t));const r=this.providers.findIndex(i=>this.equals(i,t));r!==-1&&this.providers.splice(r,1)}isEvicted(t){return this.evictionFilter.has(this.toEvictionKey(t))}hasProvider(t){return!!(this.providers.find(r=>this.equals(r,t))!=null||this.isEvicted(t))}async findProviders(t,r,i){const s=ve();let o=0;return Promise.resolve().then(async()=>{var a,c;if(this.log("finding %d-%d new provider(s) for %c",r,this.maxProviders,t),this.initialProviders.length>0)for(;o<r&&this.initialProviders.length>0;){const u=this.initialProviders.pop();if(u==null)break;const d=await this.convertToProvider(u,i);if(((a=i.signal)==null?void 0:a.aborted)===!0)break;if(d!=null&&!this.hasProvider(d)&&(this.log("found %d/%d new providers",o,this.maxProviders),this.providers.push(d),this.safeDispatchEvent("provider",{detail:d}),o++,o===r&&(this.log("session is ready"),s.resolve()),this.providers.length===this.maxProviders)){this.log("found max session peers",o);break}}if(o<this.maxProviders)for await(const u of this.findNewProviders(t,i)){if(o===this.maxProviders||((c=i.signal)==null?void 0:c.aborted)===!0)break;if(!this.hasProvider(u)&&(this.log("found %d/%d new providers",o,this.maxProviders),this.providers.push(u),this.safeDispatchEvent("provider",{detail:u}),o++,o===r&&(this.log("session is ready"),s.resolve()),this.providers.length===this.maxProviders)){this.log("found max session peers",o);break}}if(this.log("found %d/%d new session peers",o,this.maxProviders),o<r)throw new h7(`Found ${o} of ${r} ${this.name} providers for ${t}`)}).catch(a=>{this.log.error("error searching routing for potential session peers for %c",t,a.errors??a),s.reject(a)}),s.promise}}class $k{constructor(e){l(this,"libp2p");l(this,"blockstore");l(this,"datastore");l(this,"pins");l(this,"logger");l(this,"routing");l(this,"getCodec");l(this,"getHasher");l(this,"dns");l(this,"metrics");l(this,"log");this.logger=e.logger??Ih(),this.log=this.logger.forComponent("helia"),this.getHasher=Ok(e.hashers,e.loadHasher),this.getCodec=Pk(e.codecs,e.loadCodec),this.dns=e.dns??Xu(),this.metrics=e.metrics,this.libp2p=e.libp2p;const t={blockstore:e.blockstore,datastore:e.datastore,logger:this.logger,libp2p:this.libp2p,blockBrokers:[],getHasher:this.getHasher,getCodec:this.getCodec,dns:this.dns,metrics:this.metrics,...e.components??{}};this.routing=t.routing=new wk(t,{routers:(e.routers??[]).flatMap(i=>{const s=[i];return i[bc]!=null&&s.push(i[bc]),i[vc]!=null&&s.push(i[vc]),s}),providerLookupConcurrency:e.providerLookupConcurrency});const r=new Bk(t);this.pins=new pk(e.datastore,r,this.getCodec),this.blockstore=new Tk(r,this.pins,{holdGcLock:e.holdGcLock??!0}),this.datastore=e.datastore,t.blockBrokers=e.blockBrokers.map(i=>i(t))}async start(){await Rk(this.datastore),await li(this.blockstore,this.datastore,this.routing,this.libp2p)}async stop(){await rs(this.blockstore,this.datastore,this.routing,this.libp2p)}async gc(e={}){const t=await this.blockstore.lock.writeLock();try{const r=this,i=this.blockstore.unwrap();this.log("gc start"),await ui(i.deleteMany(async function*(){var s,o;for await(const{cid:a}of i.getAll())try{if(await r.pins.isPinned(a,e))continue;yield a,(s=e.onProgress)==null||s.call(e,new N("helia:gc:deleted",a))}catch(c){r.log.error("Error during gc",c),(o=e.onProgress)==null||o.call(e,new N("helia:gc:error",c))}}()))}finally{t()}this.log("gc finished")}}class Hk extends O7{constructor(t,r){super(t,{...r,name:"helia:bitswap:session"});l(this,"wantList");l(this,"network");l(this,"libp2p");this.wantList=t.wantList,this.network=t.network,this.libp2p=t.libp2p}async queryProvider(t,r,i){this.log("sending WANT-BLOCK for %c to %p",t,r);const s=await this.wantList.wantSessionBlock(t,r,i);if(this.log("%p %s %c",r,s.has?"has":"does not have",t),s.has&&s.block!=null)return s.block;throw new Error("Provider did not have block")}async*findNewProviders(t,r={}){for await(const i of this.network.findProviders(t,r))yield i.id}toEvictionKey(t){return t.toMultihash().bytes}equals(t,r){return t.equals(r)}async convertToProvider(t,r){return _o(t)?t:(await this.libp2p.dial(t,r)).remotePeer}}function Vk(n,e){return new Hk(n,e)}class zk{constructor(e){l(this,"blocksReceived");l(this,"duplicateBlocksReceived");l(this,"dataReceived");l(this,"duplicateDataReceived");var t,r,i,s;this.blocksReceived=(t=e.metrics)==null?void 0:t.registerMetricGroup("helia_bitswap_received_blocks"),this.duplicateBlocksReceived=(r=e.metrics)==null?void 0:r.registerMetricGroup("helia_bitswap_duplicate_received_blocks"),this.dataReceived=(i=e.metrics)==null?void 0:i.registerMetricGroup("helia_bitswap_data_received_bytes"),this.duplicateDataReceived=(s=e.metrics)==null?void 0:s.registerMetricGroup("helia_bitswap_duplicate_data_received_bytes")}updateBlocksReceived(e=1,t){var i;const r={global:e};t!=null&&(r[t.toString()]=e),(i=this.blocksReceived)==null||i.increment(r)}updateDuplicateBlocksReceived(e=1,t){var i;const r={global:e};t!=null&&(r[t.toString()]=e),(i=this.duplicateBlocksReceived)==null||i.increment(r)}updateDataReceived(e,t){var i;const r={global:e};t!=null&&(r[t.toString()]=e),(i=this.dataReceived)==null||i.increment(r)}updateDuplicateDataReceived(e,t){var i;const r={global:e};t!=null&&(r[t.toString()]=e),(i=this.duplicateDataReceived)==null||i.increment(r)}}class Kk extends Map{constructor(t){super();l(this,"metric");const{name:r,metrics:i}=t;this.metric=i.registerMetric(r),this.updateComponentMetric()}set(t,r){return super.set(t,r),this.updateComponentMetric(),this}delete(t){const r=super.delete(t);return this.updateComponentMetric(),r}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}}function an(n){const{name:e,metrics:t}=n;let r;return t!=null?r=new Kk({name:e,metrics:t}):r=new Map,r}function qk(n){if(!(n instanceof Uint8Array))throw new Error("arg needs to be a Uint8Array");const e=[];for(;n.length>0;){const t=fh(n);e.push(t),n=n.slice(Ht(t))}return e}class Wk extends ot{constructor(t,r={}){super();l(this,"peers");l(this,"wants");l(this,"network");l(this,"log");l(this,"sendMessagesDelay");l(this,"sendMessagesTimeout");l(this,"hashLoader");l(this,"sendingMessages");this.peers=_h({name:"helia_bitswap_peers",metrics:t.metrics}),this.wants=an({name:"helia_bitswap_wantlist",metrics:t.metrics}),this.network=t.network,this.sendMessagesDelay=r.sendMessagesDelay??lx,this.log=t.logger.forComponent("helia:bitswap:wantlist"),this.hashLoader=r.hashLoader,this.network.addEventListener("bitswap:message",i=>{this.receiveMessage(i.detail.peer,i.detail.message).catch(s=>{this.log.error("error receiving bitswap message from %p",i.detail.peer,s)})}),this.network.addEventListener("peer:connected",i=>{this.peerConnected(i.detail).catch(s=>{this.log.error("error processing newly connected bitswap peer %p",i.detail,s)})}),this.network.addEventListener("peer:disconnected",i=>{this.peerDisconnected(i.detail)})}async addEntry(t,r){var o;const i=U(t.multihash.bytes,"base64");let s=this.wants.get(i);s==null&&(s={cid:t,priority:r.priority??1,wantType:r.wantType??mt.WantBlock,cancel:!1,sendDontHave:!0},this.wants.set(i,s)),s.wantType===mt.WantHave&&r.wantType===mt.WantBlock&&(s.wantType=mt.WantBlock),await this.sendMessagesDebounced();try{return r.wantType===mt.WantBlock?(await Vt(this,"block",r==null?void 0:r.signal,{filter:u=>ke(t.multihash.digest,u.detail.cid.multihash.digest),errorMessage:"Want was aborted"})).detail:(await Vt(this,"presence",r==null?void 0:r.signal,{filter:c=>ke(t.multihash.digest,c.detail.cid.multihash.digest),errorMessage:"Want was aborted"})).detail}finally{((o=r.signal)==null?void 0:o.aborted)===!0&&(this.log("want for %c was aborted, cancelling want",t),s.cancel=!0,await this.sendMessagesDebounced())}}async sendMessagesDebounced(){var t;await((t=this.sendingMessages)==null?void 0:t.promise),clearTimeout(this.sendMessagesTimeout),this.sendMessagesTimeout=setTimeout(()=>{this.sendMessages().catch(r=>{this.log("error sending messages to peers",r)})},this.sendMessagesDelay)}async sendMessages(){this.sendingMessages=ve(),await Promise.all([...this.peers.entries()].map(async([t,r])=>{const i=new Set,s=new qa;for(const[o,a]of this.wants.entries())r.has(o)||a.cancel||(i.add(o),s.addWantlistEntry(a.cid,{cid:a.cid.bytes,priority:a.priority,wantType:a.wantType,cancel:a.cancel,sendDontHave:a.sendDontHave}));if(s.wantlist.size!==0)try{await this.network.sendMessage(t,s);for(const o of i)r.add(o)}catch(o){this.log.error("error sending full wantlist to new peer",o)}})).catch(t=>{this.log.error("error sending messages",t)});for(const[t,r]of this.wants)if(r.cancel){this.wants.delete(t);for(const i of this.peers.values())i.delete(t)}this.sendingMessages.resolve()}has(t){const r=U(t.multihash.bytes,"base64");return this.wants.has(r)}async wantSessionPresence(t,r,i={}){const s=new qa;return s.addWantlistEntry(t,{cid:t.bytes,sendDontHave:!0,wantType:mt.WantHave,priority:1}),await this.network.sendMessage(r,s),(await Vt(this,"presence",i.signal,{filter:a=>r.equals(a.detail.sender)&&ke(t.multihash.digest,a.detail.cid.multihash.digest)})).detail}async wantBlock(t,r={}){return this.addEntry(t,{...r,wantType:mt.WantBlock})}async wantSessionBlock(t,r,i={}){const s=new qa;return s.addWantlistEntry(t,{cid:t.bytes,sendDontHave:!0,wantType:mt.WantBlock,priority:1}),await this.network.sendMessage(r,s),(await Vt(this,"presence",i.signal,{filter:a=>r.equals(a.detail.sender)&&ke(t.multihash.digest,a.detail.cid.multihash.digest)})).detail}async receivedBlock(t,r){const i=U(t.multihash.bytes,"base64"),s=this.wants.get(i);s!=null&&(s.cancel=!0,await this.sendMessagesDebounced())}async receiveMessage(t,r){var s;this.log("received message from %p with %d blocks",t,r.blocks.length);let i=!1;for(const o of r.blocks){if(o.prefix==null||o.data==null)continue;const a=qk(o.prefix),c=a[0],u=a[1],d=a[2],h=d===ut.code?ut:await((s=this.hashLoader)==null?void 0:s.getHasher(d));if(h==null){this.log.error("unknown hash algorithm",d);continue}let f=h.digest(o.data);f.then!=null&&(f=await f);const p=le.create(c===0?0:1,u,f);this.log("received block from %p for %c",t,p),this.safeDispatchEvent("block",{detail:{sender:t,cid:p,block:o.data}}),this.safeDispatchEvent("presence",{detail:{sender:t,cid:p,has:!0,block:o.data}});const m=U(p.multihash.bytes,"base64"),w=this.wants.get(m);w!=null&&(w.cancel=!0,i=!0)}for(const{cid:o,type:a}of r.blockPresences){const c=le.decode(o);this.log("received %s from %p for %c",a,t,c),this.safeDispatchEvent("presence",{detail:{sender:t,cid:c,has:a===En.HaveBlock}})}i&&await this.sendMessagesDebounced()}async peerConnected(t){const r=new Set,i=new qa(!0);for(const[s,o]of this.wants.entries())o.cancel||(r.add(s),i.addWantlistEntry(o.cid,{cid:o.cid.bytes,priority:1,wantType:mt.WantBlock,cancel:!1,sendDontHave:!1}));if(i.wantlist.size===0){this.peers.set(t,r);return}try{await this.network.sendMessage(t,i),this.peers.set(t,r)}catch(s){this.log.error("error sending full wantlist to new peer %p",t,s)}}peerDisconnected(t){this.peers.delete(t)}start(){}stop(){this.peers.clear(),clearTimeout(this.sendMessagesTimeout)}}class Gk{constructor(e,t={}){l(this,"log");l(this,"logger");l(this,"stats");l(this,"network");l(this,"blockstore");l(this,"peerWantLists");l(this,"wantList");l(this,"libp2p");this.logger=e.logger,this.log=e.logger.forComponent("helia:bitswap"),this.blockstore=e.blockstore,this.libp2p=e.libp2p,this.stats=new zk(e),this.network=new Sx(e,t),this.peerWantLists=new ZA({...e,network:this.network},t),this.wantList=new Wk({...e,network:this.network},t)}createSession(e={}){return Vk({wantList:this.wantList,network:this.network,logger:this.logger,libp2p:this.libp2p},e)}async want(e,t={}){var s;const r=new AbortController,i=Le([r.signal,t.signal]);r.signal,this.network.findAndConnect(e,{...t,signal:i}).catch(o=>{r.signal.aborted||this.log.error("error during finding and connect for cid %c",e,o)});try{const o=await this.wantList.wantBlock(e,{...t,signal:i});return(s=t.onProgress)==null||s.call(t,new N("bitswap:want-block:received",{cid:e,sender:o.sender})),o.block}finally{r.abort(),i.clear()}}async notify(e,t,r={}){await Promise.all([this.peerWantLists.receivedBlock(e,r),this.wantList.receivedBlock(e,r)])}getWantlist(){return[...this.wantList.wants.values()].filter(e=>!e.cancel).map(e=>({cid:e.cid,priority:e.priority,wantType:e.wantType}))}getPeerWantlist(e){return this.peerWantLists.wantListForPeer(e)}async start(){this.wantList.start(),await this.network.start()}async stop(){this.wantList.stop(),await this.network.stop()}}const jk=(n,e={})=>new Gk(n,e);class Qk{constructor(e,t={}){l(this,"bitswap");l(this,"started");const{getHasher:r}=e;this.bitswap=jk(e,{hashLoader:{getHasher:async i=>r(i)},...t}),this.started=!1}isStarted(){return this.started}async start(){await this.bitswap.start(),this.started=!0}async stop(){await this.bitswap.stop(),this.started=!1}async announce(e,t,r){await this.bitswap.notify(e,t,r)}async retrieve(e,t={}){return this.bitswap.want(e,t)}createSession(e){const t=this.bitswap.createSession(e);return{announce:async(r,i,s)=>{await this.bitswap.notify(r,i,s)},retrieve:async(r,i)=>t.retrieve(r,i)}}}function D7(n={}){return e=>new Qk(e,n)}const Yk=Symbol.for("@libp2p/content-routing");function Xk(n){return n==null?!1:(n.type==="RSA"||n.type==="Ed25519"||n.type==="secp256k1"||n.type==="ECDSA")&&n.raw instanceof Uint8Array&&typeof n.equals=="function"&&typeof n.toMultihash=="function"&&typeof n.toCID=="function"&&typeof n.verify=="function"}const Zk=Symbol.for("@libp2p/peer-routing");function Jk(n,e,t){let r=0;for(const i of n)if(!(r<e)){if(r>t)break;if(i!==255)return!1;r++}return!0}function e_(n,e,t,r){let i=0;for(const s of n)if(!(i<t)){if(i>r)break;if(s!==e[i])return!1;i++}return!0}function t_(n){switch(n.length){case Pc:return n.join(".");case Oc:{const e=[];for(let t=0;t<n.length;t++)t%2===0&&e.push(n[t].toString(16).padStart(2,"0")+n[t+1].toString(16).padStart(2,"0"));return e.join(":")}default:throw new Error("Invalid ip length")}}function r_(n){let e=0;for(let[t,r]of n.entries()){if(r===255){e+=8;continue}for(;r&128;)e++,r=r<<1;if(r&128)return-1;for(let i=t+1;i<n.length;i++)if(n[i]!=0)return-1;break}return e}function n_(n){let e="0x";for(const t of n)e+=(t>>4).toString(16)+(t&15).toString(16);return e}const Pc=4,Oc=16,i_=new Uint8Array([0,0,0,0,0,0,0,0,0,0,255,255]);function N7(n,e){e.length===Oc&&n.length===Pc&&Jk(e,0,11)&&(e=e.slice(12)),e.length===Pc&&n.length===Oc&&e_(n,i_,0,11)&&(n=n.slice(12));const t=n.length;if(t!=e.length)throw new Error("Failed to mask ip");const r=new Uint8Array(t);for(let i=0;i<t;i++)r[i]=n[i]&e[i];return r}function s_(n,e){if(typeof e=="string"&&(e=Qf(e)),e==null)throw new Error("Invalid ip");if(e.length!==n.network.length)return!1;for(let t=0;t<e.length;t++)if((n.network[t]&n.mask[t])!==(e[t]&n.mask[t]))return!1;return!0}function o_(n){const[e,t]=n.split("/");if(!e||!t)throw new Error("Failed to parse given CIDR: "+n);let r=Pc,i=aE(e);if(i==null&&(r=Oc,i=cE(e),i==null))throw new Error("Failed to parse given CIDR: "+n);const s=parseInt(t,10);if(Number.isNaN(s)||String(s).length!==t.length||s<0||s>r*8)throw new Error("Failed to parse given CIDR: "+n);const o=L7(s,8*r);return{network:N7(i,o),mask:o}}function L7(n,e){if(e!==8*Pc&&e!==8*Oc)throw new Error("Invalid CIDR mask");if(n<0||n>e)throw new Error("Invalid CIDR mask");const t=e/8,r=new Uint8Array(t);for(let i=0;i<t;i++){if(n>=8){r[i]=255,n-=8;continue}r[i]=255-(255>>n),n=0}return r}class B7{constructor(e,t){if(t==null)({network:this.network,mask:this.mask}=o_(e));else{const r=Qf(e);if(r==null)throw new Error("Failed to parse network");t=String(t);const i=parseInt(t,10);if(Number.isNaN(i)||String(i).length!==t.length||i<0||i>r.length*8){const s=Qf(t);if(s==null)throw new Error("Failed to parse mask");this.mask=s}else this.mask=L7(i,8*r.length);this.network=N7(r,this.mask)}}contains(e){return s_({network:this.network,mask:this.mask},e)}toString(){const e=r_(this.mask),t=e!==-1?String(e):n_(this.mask);return t_(this.network)+"/"+t}}function a_(n,e){return new B7(n).contains(e)}function c_(n){let e,t;if(n.getComponents().forEach(r=>{(r.name==="ip4"||r.name==="ip6")&&(t=r.value),r.name==="ipcidr"&&(e=r.value)}),e==null||t==null)throw new Error("Invalid multiaddr");return new B7(t,e)}var M7;(function(){var n,e,t,r,i,s,o,a;a=function(c){var u,d,h,f;return u=(c&255<<24)>>>24,d=(c&255<<16)>>>16,h=(c&65280)>>>8,f=c&255,[u,d,h,f].join(".")},o=function(c){var u,d,h,f,p,m;for(u=[],h=f=0;f<=3&&c.length!==0;h=++f){if(h>0){if(c[0]!==".")throw new Error("Invalid IP");c=c.substring(1)}m=e(c),p=m[0],d=m[1],c=c.substring(d),u.push(p)}if(c.length!==0)throw new Error("Invalid IP");switch(u.length){case 1:if(u[0]>4294967295)throw new Error("Invalid IP");return u[0]>>>0;case 2:if(u[0]>255||u[1]>16777215)throw new Error("Invalid IP");return(u[0]<<24|u[1])>>>0;case 3:if(u[0]>255||u[1]>255||u[2]>65535)throw new Error("Invalid IP");return(u[0]<<24|u[1]<<16|u[2])>>>0;case 4:if(u[0]>255||u[1]>255||u[2]>255||u[3]>255)throw new Error("Invalid IP");return(u[0]<<24|u[1]<<16|u[2]<<8|u[3])>>>0;default:throw new Error("Invalid IP")}},t=function(c){return c.charCodeAt(0)},r=t("0"),s=t("a"),i=t("A"),e=function(c){var u,d,h,f,p;for(f=0,u=10,d="9",h=0,c.length>1&&c[h]==="0"&&(c[h+1]==="x"||c[h+1]==="X"?(h+=2,u=16):"0"<=c[h+1]&&c[h+1]<="9"&&(h++,u=8,d="7")),p=h;h<c.length;){if("0"<=c[h]&&c[h]<=d)f=f*u+(t(c[h])-r)>>>0;else if(u===16)if("a"<=c[h]&&c[h]<="f")f=f*u+(10+t(c[h])-s)>>>0;else if("A"<=c[h]&&c[h]<="F")f=f*u+(10+t(c[h])-i)>>>0;else break;else break;if(f>4294967295)throw new Error("too large");h++}if(h===p)throw new Error("empty octet");return[f,h]},n=function(){function c(u,d){var h,f,p;if(typeof u!="string")throw new Error("Missing `net' parameter");if(d||(p=u.split("/",2),u=p[0],d=p[1]),d||(d=32),typeof d=="string"&&d.indexOf(".")>-1){try{this.maskLong=o(d)}catch{throw new Error("Invalid mask: "+d)}for(h=f=32;f>=0;h=--f)if(this.maskLong===4294967295<<32-h>>>0){this.bitmask=h;break}}else if(d||d===0)this.bitmask=parseInt(d,10),this.maskLong=0,this.bitmask>0&&(this.maskLong=4294967295<<32-this.bitmask>>>0);else throw new Error("Invalid mask: empty");try{this.netLong=(o(u)&this.maskLong)>>>0}catch{throw new Error("Invalid net address: "+u)}if(!(this.bitmask<=32))throw new Error("Invalid mask for ip4: "+d);this.size=Math.pow(2,32-this.bitmask),this.base=a(this.netLong),this.mask=a(this.maskLong),this.hostmask=a(~this.maskLong),this.first=this.bitmask<=30?a(this.netLong+1):this.base,this.last=this.bitmask<=30?a(this.netLong+this.size-2):a(this.netLong+this.size-1),this.broadcast=this.bitmask<=30?a(this.netLong+this.size-1):void 0}return c.prototype.contains=function(u){return typeof u=="string"&&(u.indexOf("/")>0||u.split(".").length!==4)&&(u=new c(u)),u instanceof c?this.contains(u.base)&&this.contains(u.broadcast||u.last):(o(u)&this.maskLong)>>>0===(this.netLong&this.maskLong)>>>0},c.prototype.next=function(u){return u==null&&(u=1),new c(a(this.netLong+this.size*u),this.mask)},c.prototype.forEach=function(u){var d,h,f;for(f=o(this.first),h=o(this.last),d=0;f<=h;)u(a(f),f,d),d++,f++},c.prototype.toString=function(){return this.base+"/"+this.bitmask},c}(),M7=n}).call(Xf);const l_=["0.0.0.0/8","10.0.0.0/8","100.64.0.0/10","127.0.0.0/8","169.254.0.0/16","172.16.0.0/12","192.0.0.0/24","192.0.0.0/29","192.0.0.8/32","192.0.0.9/32","192.0.0.10/32","192.0.0.170/32","192.0.0.171/32","192.0.2.0/24","192.31.196.0/24","192.52.193.0/24","192.88.99.0/24","192.168.0.0/16","192.175.48.0/24","198.18.0.0/15","198.51.100.0/24","203.0.113.0/24","240.0.0.0/4","255.255.255.255/32"],u_=l_.map(n=>new M7(n));function ig(n){for(const e of u_)if(e.contains(n))return!0;return!1}function d_(n){return/^::ffff:([0-9a-fA-F]{1,4}):([0-9a-fA-F]{1,4})$/.test(n)}function h_(n){const e=n.split(":");if(e.length<2)return!1;const t=e[e.length-1].padStart(4,"0"),r=e[e.length-2].padStart(4,"0"),i=`${parseInt(r.substring(0,2),16)}.${parseInt(r.substring(2),16)}.${parseInt(t.substring(0,2),16)}.${parseInt(t.substring(2),16)}`;return ig(i)}function f_(n){return/^::ffff:([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(n)}function p_(n){const e=n.split(":"),t=e[e.length-1];return ig(t)}function g_(n){return/^::$/.test(n)||/^::1$/.test(n)||/^64:ff9b::([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(n)||/^100::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(n)||/^2001::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(n)||/^2001:2[0-9a-fA-F]:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(n)||/^2001:db8:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(n)||/^2002:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(n)||/^f[c-d]([0-9a-fA-F]{2,2}):/i.test(n)||/^fe[8-9a-bA-B][0-9a-fA-F]:/i.test(n)||/^ff([0-9a-fA-F]{2,2}):/i.test(n)}function ns(n){if(Uu(n))return ig(n);if(d_(n))return h_(n);if(f_(n))return p_(n);if(lE(n))return g_(n)}const Ke=n=>({match:e=>{const t=e[0];return t==null||t.code!==n||t.value!=null?!1:e.slice(1)}}),de=(n,e)=>({match:t=>{const r=t[0];return(r==null?void 0:r.code)!==n||r.value==null||e!=null&&r.value!==e?!1:t.slice(1)}}),De=n=>({match:e=>{const t=n.match(e);return t===!1?e:t}}),jt=(...n)=>({match:e=>{let t;for(const r of n){const i=r.match(e);i!==!1&&(t==null||i.length<t.length)&&(t=i)}return t??!1}}),Be=(...n)=>({match:e=>{for(const t of n){const r=t.match(e);if(r===!1)return!1;e=r}return e}});function He(...n){function e(i){if(i==null)return!1;let s=i.getComponents();for(const o of n){const a=o.match(s);if(a===!1)return!1;s=a}return s}function t(i){return e(i)!==!1}function r(i){const s=e(i);return s===!1?!1:s.length===0}return{matchers:n,matches:t,exactMatch:r}}const m_=de($e),y_=He(m_),Rh=de(X6),Ph=de(Z6),Oh=de(Y6),sg=de(e8);He(Rh,De(de($e)));He(Ph,De(de($e)));He(Oh,De(de($e)));const U7=He(jt(sg,Oh,Rh,Ph),De(de($e))),F7=Be(de(ph),De(de(t8))),$7=Be(De(de(sl)),de(Ts),De(de(t8))),og=jt(F7,$7),Ds=jt(og,sg,Rh,Ph,Oh),w_=He(jt(og,Be(jt(sg,Oh,Rh,Ph),De(de($e))))),gm=He(F7),mm=He($7),b_=He(og),ag=Be(Ds,de(Ja)),pl=Be(Ds,de(dE)),Ju=He(Be(ag,De(de($e))));He(pl);const cg=Be(pl,Ke(hE),De(de($e))),Dh=Be(pl,Ke(pE),De(de($e))),v_=jt(cg,Dh);He(cg);const S_=He(Dh),l0=jt(Ds,ag,pl,cg,Dh),H7=jt(Be(l0,Ke(J6),De(de($e)))),Dc=He(H7),V7=jt(Be(l0,Ke(mE),De(de($e))),Be(l0,Ke(fu),De(de(gE)),Ke(J6),De(de($e)))),ed=He(V7),z7=Be(pl,Ke(uE),De(de(Fu)),De(de(Fu)),De(de($e))),u0=He(z7),K7=Be(Dh,Ke(fE),De(de(Fu)),De(de(Fu)),De(de($e))),ym=He(K7),td=jt(H7,V7,Be(ag,De(de($e))),Be(v_,De(de($e))),Be(Ds,De(de($e))),z7,K7,de($e)),q7=He(td),E_=Be(td,Ke(il),de($e)),Yi=He(E_),x_=jt(Be(td,Ke(il),Ke(z1),De(de($e))),Be(td,Ke(z1),De(de($e))),Be(Ke(z1),De(de($e)))),d0=He(x_),A_=jt(Be(Ds,de(Ja),Ke(ec),De(de($e))),Be(Ds,Ke(ec),De(de($e)))),k_=He(A_),__=Be(Ds,jt(Be(de(Ja,"443"),Ke(ec)),Be(de(Ja),Ke(H3)),Be(de(Ja),Ke(fu),Ke(ec)),Be(Ke(fu),Ke(ec)),Ke(fu),Ke(H3)),De(de($e))),I_=He(__),C_=jt(Be(de(yE),De(de($e))));He(C_);const T_=jt(Be(de(wE),De(de($e))));He(T_);function W7(n,e,t){return n.filter(r=>{if(I_.matches(r)||e&&k_.matches(r))return t||U7.matches(r)?!0:ns(r.toOptions().host)===!1;if(!e&&t){const{host:i}=r.toOptions();if(i==="127.0.0.1"||i==="localhost"||i.endsWith(".localhost"))return!0}return!1})}async function*G7(n,e,t,r,i,s={}){for await(const o of e.findProviders(n,s)){const a=W7(o.multiaddrs,r,i);if(a.length===0)continue;const c=Pp(a[0]);yield new j7(c,{logger:t,transformRequestInit:s.transformRequestInit})}}async function R_(n,e,t){var c;const{signal:r,log:i}=t??{},s=n.headers.get("content-length");if(s!=null){const u=parseInt(s,10);if(u>e)throw i==null||i.error("content-length header (%d) is greater than the limit (%d)",u,e),n.body!=null&&await n.body.cancel().catch(d=>{i==null||i.error("error cancelling response body after content-length check - %e",d)}),new Error(`Content-Length header (${u}) is greater than the limit (${e}).`)}const o=(c=n.body)==null?void 0:c.getReader();if(o==null)throw new Error("Response body is not readable");const a=new Ee;try{for(;;){if((r==null?void 0:r.aborted)===!0)throw new Error("Response body read was aborted.");const{done:u,value:d}=await o.read();if(u)break;if(a.append(d),a.byteLength>e)throw new Error(`Response body is greater than the limit (${e}), received ${a.byteLength} bytes.`)}}finally{o.cancel().catch(u=>{i==null||i.error("error cancelling reader - %e",u)}).finally(()=>{o.releaseLock()})}return a.subarray()}var Es,xs,Ho,Vo,As,dh,Q7;class j7{constructor(e,{logger:t,transformRequestInit:r}){pe(this,dh);l(this,"url");pe(this,Es,0);pe(this,xs,0);pe(this,Ho,0);pe(this,Vo,0);pe(this,As,new Map);l(this,"log");l(this,"transformRequestInit");this.url=e instanceof URL?e:new URL(e),this.transformRequestInit=r,this.log=t.forComponent(`helia:trustless-gateway-block-broker:${this.url.hostname}`)}async getRawBlock(e,{signal:t,maxSize:r=N_}={}){const i=new URL(this.url.toString());if(i.pathname=`/ipfs/${e.toString()}`,i.search="?format=raw",(t==null?void 0:t.aborted)===!0)throw new Error(`Signal to fetch raw block for CID ${e} from gateway ${this.url} was aborted prior to fetch`);const s=D(this,dh,Q7).call(this,e),o=new AbortController,a=()=>{o.abort()};t==null||t.addEventListener("abort",a);try{let c=A(this,As).get(s);if(c==null){Tr(this,Es)._++;const u={signal:o.signal,headers:{Accept:"application/vnd.ipld.raw"},cache:"force-cache"},d=this.transformRequestInit!=null?await this.transformRequestInit(u):u;c=fetch(i.toString(),d).then(async h=>{if(this.log("GET %s %d",i,h.status),!h.ok)throw Tr(this,xs)._++,new Error(`unable to fetch raw block for CID ${e} from gateway ${this.url}`);const f=await R_(h,r,{signal:o.signal,log:this.log});return Tr(this,Vo)._++,f}),A(this,As).set(s,c)}return await c}catch{throw(t==null?void 0:t.aborted)===!0?new Error(`fetching raw block for CID ${e} from gateway ${this.url} was aborted`):(Tr(this,xs)._++,new Error(`unable to fetch raw block for CID ${e}`))}finally{t==null||t.removeEventListener("abort",a),A(this,As).delete(s)}}reliability(){return A(this,Es)===0?1:A(this,Ho)>0?-1/0:A(this,Vo)/(A(this,Es)+A(this,xs)*3)}incrementInvalidBlocks(){Tr(this,Ho)._++}getStats(){return{attempts:A(this,Es),errors:A(this,xs),invalidBlocks:A(this,Ho),successes:A(this,Vo),pendingResponses:A(this,As).size}}}Es=new WeakMap,xs=new WeakMap,Ho=new WeakMap,Vo=new WeakMap,As=new WeakMap,dh=new WeakSet,Q7=function(e){const t=e.multihash.bytes;return Zn.encode(t)};class P_ extends O7{constructor(t,r){super(t,{...r,name:"helia:trustless-gateway:session"});l(this,"routing");l(this,"allowInsecure");l(this,"allowLocal");l(this,"transformRequestInit");this.routing=t.routing,this.allowInsecure=r.allowInsecure??Y7,this.allowLocal=r.allowLocal??X7,this.transformRequestInit=r.transformRequestInit}async queryProvider(t,r,i){var o;this.log("fetching BLOCK for %c from %s",t,r.url);const s=await r.getRawBlock(t,i);return this.log.trace("got block for %c from %s",t,r.url),await((o=i.validateFn)==null?void 0:o.call(i,s)),s}async*findNewProviders(t,r={}){yield*G7(t,this.routing,this.logger,this.allowInsecure,this.allowLocal,{...r,transformRequestInit:this.transformRequestInit})}toEvictionKey(t){return t.url.toString()}equals(t,r){return t.url.toString()===r.url.toString()}async convertToProvider(t,r){if(bE(t))return;const i=W7(Array.isArray(t)?t:[t],this.allowInsecure,this.allowLocal);if(i.length===0)return;const s=Pp(i[0]);return new j7(s,{logger:this.logger,transformRequestInit:this.transformRequestInit})}}function O_(n,e){return new P_(n,e)}class D_{constructor(e,t={}){l(this,"allowInsecure");l(this,"allowLocal");l(this,"transformRequestInit");l(this,"routing");l(this,"log");l(this,"logger");this.log=e.logger.forComponent("helia:trustless-gateway-block-broker"),this.logger=e.logger,this.routing=e.routing,this.allowInsecure=t.allowInsecure??Y7,this.allowLocal=t.allowLocal??X7,this.transformRequestInit=t.transformRequestInit}async retrieve(e,t={}){var i,s;const r=[];for await(const o of G7(e,this.routing,this.logger,this.allowInsecure,this.allowLocal,{...t,transformRequestInit:this.transformRequestInit})){this.log("getting block for %c from %s",e,o.url);try{const a=await o.getRawBlock(e,t);this.log.trace("got block for %c from %s",e,o.url);try{await((i=t.validateFn)==null?void 0:i.call(t,a))}catch(c){this.log.error("failed to validate block for %c from %s",e,o.url,c);continue}return a}catch(a){if(this.log.error("failed to get block for %c from %s",e,o.url,a),a instanceof Error?r.push(a):r.push(new Error(`Unable to fetch raw block for CID ${e} from gateway ${o.url}`)),((s=t.signal)==null?void 0:s.aborted)===!0){this.log.trace("request aborted while fetching raw block for CID %c from gateway %s",e,o.url);break}}}throw r.length>0?new AggregateError(r,`Unable to fetch raw block for CID ${e} from any gateway`):new Error(`Unable to fetch raw block for CID ${e} from any gateway`)}createSession(e={}){return O_({logger:this.logger,routing:this.routing},{...e,allowLocal:this.allowLocal,allowInsecure:this.allowInsecure,transformRequestInit:this.transformRequestInit})}}const Y7=!1,X7=!1,N_=2097152;function Z7(n={}){return e=>new D_(e,n)}var J7={exports:{}};(function(n){(function(){n.exports=b;var e=86400,t=3200,r=146097*t/400,i=e*r,s=1e3*i,o=864e13,a=4294967296,c=1e6,u="000000000",d=Math.trunc||function(L){var B=L-L%1;return B==0&&(L<0||L===0&&1/L!=1/0)?-0:B},h=b.prototype,f=(b.fromDate=function(L){return new b(+L)},b.fromInt64BE=re(0,1,2,3,0,4),b.fromInt64LE=re(3,2,1,0,4,0),b.fromString=function(V){var B,M=new b,V=(V+="").replace(/^\s*[+\-]?\d+/,function(ie){var ie=+ie,ae=1970+(ie-1970)%400;return M.year=ie-ae,ae}).replace(/(?:Z|([+\-]\d{2}):?(\d{2}))$/,function(K,ie,ae){return ie<0&&(ae*=-1),B=6e4*(60*+ie+ +ae),""}).replace(/\.\d+$/,function(K){return M.nano=+(K+u).substr(1,9),""}).split(/\D+/);if(1<V.length?V[1]--:V[1]=0,M.time=B=Date.UTC.apply(Date,V)-(B||0),isNaN(B))throw new TypeError("Invalid Date");return S(M)},b.fromTimeT=function(L){return C(L,0)},h.year=0,h.time=0,h.nano=0,h.addNano=function(L){return this.nano+=+L||0,this},h.getNano=function(){var L=S(this);return(L.time%1e3*c+ +L.nano+1e9)%1e9},h.getTimeT=function(){var B=S(this),L=Math.floor(B.time/1e3),B=B.year;return B&&(L+=B*r*e/t),L},h.getYear=function(){return this.toDate().getUTCFullYear()+this.year},h.toDate=function(){return k(S(this).time)},h.toJSON=function(){return this.toString().replace(/0{1,6}Z$/,"Z")},h.toString=function(L){var B=this,M=B.toDate(),V={H:function(){return Y(M.getUTCHours())},L:function(){return se(M.getUTCMilliseconds(),3)},M:function(){return Y(M.getUTCMinutes())},N:function(){return se(B.getNano(),9)},S:function(){return Y(M.getUTCSeconds())},Y:function(){var K=B.getYear();return 999999<K?"+"+K:9999<K?"+"+se(K,6):0<=K?se(K,4):-999999<=K?"-"+se(-K,6):K},a:function(){return m[M.getUTCDay()]},b:function(){return p[M.getUTCMonth()]},d:function(){return Y(M.getUTCDate())},e:function(){return function(K){return(9<K?"":" ")+(0|K)}(M.getUTCDate())},m:function(){return Y(M.getUTCMonth()+1)}};return function K(ie){return ie.replace(/%./g,function(ae){var oe=ae[1],J=w[oe],oe=V[oe];return J?K(J):oe?oe():ae})}(L||f)},h.writeInt64BE=Q(0,1,2,3,0,4),h.writeInt64LE=Q(3,2,1,0,4,0),"%Y-%m-%dT%H:%M:%S.%NZ"),p=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],m=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],w={"%":"%",F:"%Y-%m-%d",n:`
`,R:"%H:%M",T:"%H:%M:%S",t:"	",X:"%T",Z:"GMT",z:"+0000"};return b;function b(L,B,M){var V=this;if(!(V instanceof b))return new b(L,B,M);V.time=+L||0,V.nano=+B||0,V.year=+M||0,S(V)}function S(L){var B,M,V,K=L.year,ie=L.time,ae=L.nano,J=((ae<0||c<=ae)&&(ae-=(M=Math.floor(ae/c))*c,ie+=M,M=1),K%t);return(ie<-o||o<ie||J)&&((B=d(ie/s))&&(K+=B*t,ie-=B*s),(V=k(ie)).setUTCFullYear(J+V.getUTCFullYear()),V=(ie=+V)+(B=d((K-=J)/t))*s,B&&-o<=V&&V<=o&&(K-=B*t,ie=V),M=1),M&&(L.year=K,L.time=ie,L.nano=ae),L}function k(L){var B=new Date(0);return B.setTime(L),B}function C(K,V){K=+K||0;var M=d((V=(V|0)*a)/i)+d(K/i),V=V%i+K%i,K=d(V/i);return K&&(M+=K,V-=K*i),new b(1e3*V,0,M*t)}function Q(L,B,M,V,K,ie){return function(J,oe){var z=S(this);J=J||new Array(8),T(J,oe|=0);var _e=Math.floor(z.time/1e3),z=z.year*(r*e/t),ge=d(z/a)+d(_e/a),z=z%a+_e%a,_e=Math.floor(z/a);return _e&&(ge+=_e,z-=_e*a),ae(J,oe+K,ge),ae(J,oe+ie,z),J};function ae(J,oe,ge){J[oe+L]=ge>>24&255,J[oe+B]=ge>>16&255,J[oe+M]=ge>>8&255,J[oe+V]=255&ge}}function re(L,B,M,V,K,ie){return function(J,oe){T(J,oe|=0);var ge=ae(J,oe+K);return C(ae(J,oe+ie),ge)};function ae(J,oe){return 16777216*J[oe+L]+(J[oe+B]<<16|J[oe+M]<<8|J[oe+V])}}function T(L,B){if(L=L&&L.length,L==null)throw new TypeError("Invalid Buffer");if(L<B+8)throw new RangeError("Out of range")}function Y(L){return(9<L?"":"0")+(0|L)}function se(L,B){return(u+(0|L)).substr(-B)}})()})(J7);var L_=J7.exports;const rd=ol(L_);class e9 extends Error{constructor(e="Record signature creation failed"){super(e),this.name="SignatureCreationError"}}l(e9,"name","SignatureCreationError");class Ti extends Error{constructor(e="Record signature verification failed"){super(e),this.name="SignatureVerificationError"}}l(Ti,"name","SignatureVerificationError");class t9 extends Error{constructor(e="Record has expired"){super(e),this.name="RecordExpiredError"}}l(t9,"name","RecordExpiredError");class Nh extends Error{constructor(e="The validity type is unsupported"){super(e),this.name="UnsupportedValidityError"}}l(Nh,"name","UnsupportedValidityError");class r9 extends Error{constructor(e="The record is too large"){super(e),this.name="RecordTooLargeError"}}l(r9,"name","RecordTooLargeError");var Gf;let n9=(Gf=class extends Error{constructor(e="Value must be a valid content path starting with /"){super(e),this.name="InvalidValueError"}},l(Gf,"name","InvalidValueError"),Gf);class i9 extends Error{constructor(e="Invalid record data"){super(e),this.name="InvalidRecordDataError"}}l(i9,"name","InvalidRecordDataError");class h0 extends Error{constructor(e="Invalid embedded public key"){super(e),this.name="InvalidEmbeddedPublicKeyError"}}l(h0,"name","InvalidEmbeddedPublicKeyError");var br;(function(n){(function(r){r.EOL="EOL"})(n.ValidityType||(n.ValidityType={}));let e;(function(r){r[r.EOL=0]="EOL"})(e||(e={})),function(r){r.codec=()=>Wt(e)}(n.ValidityType||(n.ValidityType={}));let t;n.codec=()=>(t==null&&(t=me((r,i,s={})=>{s.lengthDelimited!==!1&&i.fork(),r.value!=null&&(i.uint32(10),i.bytes(r.value)),r.signatureV1!=null&&(i.uint32(18),i.bytes(r.signatureV1)),r.validityType!=null&&(i.uint32(24),n.ValidityType.codec().encode(r.validityType,i)),r.validity!=null&&(i.uint32(34),i.bytes(r.validity)),r.sequence!=null&&(i.uint32(40),i.uint64(r.sequence)),r.ttl!=null&&(i.uint32(48),i.uint64(r.ttl)),r.pubKey!=null&&(i.uint32(58),i.bytes(r.pubKey)),r.signatureV2!=null&&(i.uint32(66),i.bytes(r.signatureV2)),r.data!=null&&(i.uint32(74),i.bytes(r.data)),s.lengthDelimited!==!1&&i.ldelim()},(r,i,s={})=>{const o={},a=i==null?r.len:r.pos+i;for(;r.pos<a;){const c=r.uint32();switch(c>>>3){case 1:{o.value=r.bytes();break}case 2:{o.signatureV1=r.bytes();break}case 3:{o.validityType=n.ValidityType.codec().decode(r);break}case 4:{o.validity=r.bytes();break}case 5:{o.sequence=r.uint64();break}case 6:{o.ttl=r.uint64();break}case 7:{o.pubKey=r.bytes();break}case 8:{o.signatureV2=r.bytes();break}case 9:{o.data=r.bytes();break}default:{r.skipType(c&7);break}}}return o})),t),n.encode=r=>ye(r,n.codec()),n.decode=(r,i)=>we(r,n.codec(),i)})(br||(br={}));const B_=Ut("ipns:utils"),s9=R("/ipns/"),M_=114,U_=0,F_=18;function o9(n){let e;if(n.pubKey!=null)try{e=on(n.pubKey)}catch(t){throw B_.error(t),t}if(e!=null)return e}function $_(n,e,t){const r=R(e);return sr([n,t,r])}function a9(n){const e=R("ipns-signature:");return sr([e,n])}function nd(n){return"signatureV1"in n?br.encode({value:R(n.value),signatureV1:n.signatureV1,validityType:n.validityType,validity:R(n.validity),sequence:n.sequence,ttl:n.ttl,pubKey:n.pubKey,signatureV2:n.signatureV2,data:n.data}):br.encode({pubKey:n.pubKey,signatureV2:n.signatureV2,data:n.data})}function Hi(n){const e=br.decode(n);if(e.sequence!=null&&(e.sequence=BigInt(e.sequence)),e.ttl!=null&&(e.ttl=BigInt(e.ttl)),e.signatureV2==null||e.data==null)throw new Ti("Missing data or signatureV2");const t=c9(e.data),r=V_(t.Value),i=U(t.Validity);if(e.value!=null&&e.signatureV1!=null)return K_(e),{value:r,validityType:br.ValidityType.EOL,validity:i,sequence:t.Sequence,ttl:t.TTL,pubKey:e.pubKey,signatureV1:e.signatureV1,signatureV2:e.signatureV2,data:e.data};if(e.signatureV2!=null)return{value:r,validityType:br.ValidityType.EOL,validity:i,sequence:t.Sequence,ttl:t.TTL,pubKey:e.pubKey,signatureV2:e.signatureV2,data:e.data};throw new Error("invalid record: does not include signatureV1 or signatureV2")}function rc(n){return sr([s9,n.bytes])}function f0(n){const e=Pt(n.slice(s9.length));if(!p0(e,U_)&&!p0(e,F_))throw new Sh("Multihash in IPNS key was not identity or sha2-256");return e}function H_(n,e,t,r,i){let s;if(e===br.ValidityType.EOL)s=0;else throw new Nh("The validity type is unsupported");return hu({Value:n,Validity:t,ValidityType:s,Sequence:r,TTL:i})}function c9(n){const e=hs(n);if(e.ValidityType===0)e.ValidityType=br.ValidityType.EOL;else throw new Nh("The validity type is unsupported");return Number.isInteger(e.Sequence)&&(e.Sequence=BigInt(e.Sequence)),Number.isInteger(e.TTL)&&(e.TTL=BigInt(e.TTL)),e}function V_(n){const e=U(n).trim();if(e.startsWith("/"))return e;try{return`/ipfs/${le.decode(n).toV1().toString()}`}catch{}try{return`/ipfs/${le.parse(e).toV1().toString()}`}catch{}throw new n9("Value must be a valid content path starting with /")}function z_(n){if(n!=null){const e=G_(n);if(e!=null)return e.code===M_?`/ipns/${e.toString(Cs)}`:`/ipfs/${e.toV1().toString()}`;if(q_(n))return`/ipns/${Cs.encode(n.bytes)}`;const t=n.toString().trim();if(t.startsWith("/")&&t.length>1)return t}throw new n9("Value must be a valid content path starting with /")}function K_(n){if(n.data==null)throw new i9("Record data is missing");const e=c9(n.data);if(!ke(e.Value,n.value??new Uint8Array(0)))throw new Ti('Field "value" did not match between protobuf and CBOR');if(!ke(e.Validity,n.validity??new Uint8Array(0)))throw new Ti('Field "validity" did not match between protobuf and CBOR');if(e.ValidityType!==n.validityType)throw new Ti('Field "validityType" did not match between protobuf and CBOR');if(e.Sequence!==n.sequence)throw new Ti('Field "sequence" did not match between protobuf and CBOR');if(e.TTL!==n.ttl)throw new Ti('Field "ttl" did not match between protobuf and CBOR')}function q_(n){return n.bytes instanceof Uint8Array}function W_(n){return typeof(n==null?void 0:n.toCID)=="function"}function G_(n){if(W_(n))return n.toCID();try{return le.parse(n)}catch{}return le.asCID(n)}function p0(n,e){return n.code===e}const j_=Ut("ipns"),l9=5*60*1e9,u9={v1Compatible:!0,ttlNs:l9};async function Q_(n,e,t,r,i=u9){const s=new rd(Date.now()+Number(r)),o=br.ValidityType.EOL,a=BigInt(i.ttlNs??l9);return Y_(n,e,t,o,s.toString(),a,i)}const Y_=async(n,e,t,r,i,s,o=u9)=>{t=BigInt(t);const a=R(i),c=z_(e),u=R(c),d=H_(u,r,a,t,s),h=a9(d),f=await n.sign(h);let p;if(n.type==="RSA"&&(p=en(n.publicKey)),o.v1Compatible===!0){const m=await X_(n,u,r,a),w={value:c,signatureV1:m,validity:i,validityType:r,sequence:t,ttl:s,signatureV2:f,data:d};return p!=null&&(w.pubKey=p),w}else{const m={value:c,validity:i,validityType:r,sequence:t,ttl:s,signatureV2:f,data:d};return p!=null&&(m.pubKey=p),m}},X_=async(n,e,t,r)=>{try{const i=$_(e,t,r);return await n.sign(i)}catch(i){throw j_.error("record signature creation failed",i),new e9("Record signature creation failed")}},ql=Ut("ipns:validator"),Z_=1024*10;async function J_(n,e){const t=Hi(e);let r;try{const i=a9(t.data);r=await n.verify(i,t.signatureV2)}catch{r=!1}if(!r)throw ql.error("record signature verification failed"),new Ti("Record signature verification failed");if(t.validityType===br.ValidityType.EOL){if(rd.fromString(t.validity).toDate().getTime()<Date.now())throw ql.error("record has expired"),new t9("record has expired")}else if(t.validityType!=null)throw ql.error("the validity type is unsupported"),new Nh("The validity type is unsupported");ql("ipns record for %s is valid",t.value)}async function nc(n,e){if(e.byteLength>Z_)throw new r9("The record is too large");const t=f0(n);let r;p0(t,0)&&(r=$8(t));const i=Hi(e),s=o9(i)??r;if(s==null)throw new h0("Could not extract public key from IPNS record or routing key");const o=rc(s.toMultihash());if(!ke(o,n))throw new h0("Embedded public key did not match routing key");await J_(s,e)}let eI=class extends Error{constructor(){super(...arguments);l(this,"name","InvalidMessageLengthError");l(this,"code","ERR_INVALID_MESSAGE_LENGTH")}};async function*wm(n,e={}){const t=/\r?\n/,r=new TextDecoder("utf8");let i="";for await(let s of n){if(typeof s=="string"&&(s=new TextEncoder().encode(s)),pu(s)&&(s=s.subarray()),i+=r.decode(s,{stream:!0}),i.length>((e==null?void 0:e.maxMessageLength)??i.length))throw new eI("Incoming message too long");const o=i.split(t);i=o.pop()??"";for(let a=0;a<o.length;a++)yield JSON.parse(o[a])}i+=r.decode(),i!==""&&(yield JSON.parse(i))}class Eu extends Error{constructor(e="Invalid request"){super(e),this.name="InvalidRequestError"}}l(Eu,"name","InvalidRequestError");class Nn extends Error{constructor(e="Bad response"){super(e),this.name="BadResponseError"}}l(Nn,"name","BadResponseError");const bm=R("/ipns/");function vm(n){return ke(n.subarray(0,bm.byteLength),bm)}class tI{constructor(e){l(this,"client");this.client=e}async*findProviders(e,t={}){yield*vr(this.client.getProviders(e,t),r=>({id:r.ID,multiaddrs:r.Addrs??[]}))}async provide(){}async cancelReprovide(){}async put(e,t,r){if(!vm(e))return;const i=f0(e),s=le.createV1(114,i),o=Hi(t);await this.client.putIPNS(s,o,r)}async get(e,t){if(!vm(e))throw new Fi("Not found");const r=f0(e),i=le.createV1(114,r);try{const s=await this.client.getIPNS(i,t);return nd(s)}catch(s){throw s.name==="BadResponseError"?new Fi("Not found"):s}}}class rI{constructor(e){l(this,"client");this.client=e}async findPeer(e,t={}){const r=await Op(this.client.getPeers(e,t));if(r!=null)return{id:r.ID,multiaddrs:r.Addrs??[]};throw new Fi("Not found")}async*getClosestPeers(e,t={}){}}const bt=Ut("delegated-routing-v1-http-api-client"),Wl={concurrentRequests:4,timeout:3e4,cacheTTL:5*60*1e3,cacheName:"delegated-routing-v1-cache"};var Kt,Ga,g0,ja;class nI{constructor(e,t={}){pe(this,Kt);l(this,"started");l(this,"httpQueue");l(this,"shutDownController");l(this,"clientUrl");l(this,"timeout");l(this,"contentRouting");l(this,"peerRouting");l(this,"filterAddrs");l(this,"filterProtocols");l(this,"inFlightRequests");l(this,"cacheName");l(this,"cache");l(this,"cacheTTL");this.started=!1,this.shutDownController=new AbortController,this.shutDownController.signal,this.httpQueue=new fl({concurrency:t.concurrentRequests??Wl.concurrentRequests}),this.inFlightRequests=new Map,this.clientUrl=e instanceof URL?e:new URL(e),this.timeout=t.timeout??Wl.timeout,this.filterAddrs=t.filterAddrs,this.filterProtocols=t.filterProtocols,this.contentRouting=new tI(this),this.peerRouting=new rI(this),this.cacheName=t.cacheName??Wl.cacheName,this.cacheTTL=t.cacheTTL??Wl.cacheTTL}get[Yk](){return this.contentRouting}get[Zk](){return this.peerRouting}isStarted(){return this.started}async start(){var e;this.started||(this.started=!0,this.cacheTTL>0&&(this.cache=await((e=globalThis.caches)==null?void 0:e.open(this.cacheName)),this.cache!=null&&bt("cache enabled with ttl %d",this.cacheTTL)))}async stop(){var e;this.httpQueue.clear(),this.shutDownController.abort(),await((e=globalThis.caches)==null?void 0:e.delete(this.cacheName)),this.started=!1}async*getProviders(e,t={}){bt("getProviders starts: %c",e);const r=AbortSignal.timeout(this.timeout),i=Le([this.shutDownController.signal,r,t.signal]),s=ve(),o=ve();this.httpQueue.add(async()=>(s.resolve(),o.promise));try{await s.promise;const a=new URL(`${this.clientUrl}routing/v1/providers/${e.toString()}`);D(this,Kt,g0).call(this,a,t.filterAddrs,t.filterProtocols);const c={headers:{Accept:"application/x-ndjson"},signal:i},u=await D(this,Kt,ja).call(this,a.toString(),c);if(u==null)throw new Nn("No response received");if(!u.ok)throw u.status===404?new Fi("No matching records found"):u.status===422?new Eu("Request does not conform to schema or semantic constraints"):new Nn(`Unexpected status code: ${u.status}`);if(u.body==null)throw new Nn("Routing response had no body");const d=u.headers.get("Content-Type");if(d==null)throw new Nn("No Content-Type header received");if(d!=null&&d.startsWith("application/json")){const h=await u.json();for(const f of h.Providers){const p=D(this,Kt,Ga).call(this,f);p!=null&&(yield p)}}else if(d.includes("application/x-ndjson"))for await(const h of wm(V3(u.body))){const f=D(this,Kt,Ga).call(this,h);f!=null&&(yield f)}else throw new Nn(`Unsupported Content-Type: ${d}`)}finally{i.clear(),o.resolve(),bt("getProviders finished: %c",e)}}async*getPeers(e,t={}){bt("getPeers starts: %c",e);const r=AbortSignal.timeout(this.timeout),i=Le([this.shutDownController.signal,r,t.signal]),s=ve(),o=ve();this.httpQueue.add(async()=>(s.resolve(),o.promise));try{await s.promise;const a=new URL(`${this.clientUrl}routing/v1/peers/${e.toCID().toString()}`);D(this,Kt,g0).call(this,a,t.filterAddrs,t.filterProtocols);const c={headers:{Accept:"application/x-ndjson"},signal:i},u=await D(this,Kt,ja).call(this,a.toString(),c);if(u.status===404)throw new Fi("No matching records found");if(u.status===422)throw new Eu("Request does not conform to schema or semantic constraints");if(u.body==null)throw new Nn("Routing response had no body");if(u.headers.get("Content-Type")==="application/json"){const h=await u.json();for(const f of h.Peers){const p=D(this,Kt,Ga).call(this,f);p!=null&&(yield p)}}else for await(const h of wm(V3(u.body))){const f=D(this,Kt,Ga).call(this,h);f!=null&&(yield f)}}catch(a){bt.error("getPeers errored:",a)}finally{i.clear(),o.resolve(),bt("getPeers finished: %c",e)}}async getIPNS(e,t={}){bt("getIPNS starts: %s",e);const r=AbortSignal.timeout(this.timeout),i=Le([this.shutDownController.signal,r,t.signal]),s=ve(),o=ve();this.httpQueue.add(async()=>(s.resolve(),o.promise));const a=`${this.clientUrl}routing/v1/ipns/${e}`;try{await s.promise;const c={headers:{Accept:"application/vnd.ipfs.ipns-record"},signal:i},u=await D(this,Kt,ja).call(this,a,c);if(bt("getIPNS GET %s %d",a,u.status),u.status===404)throw new Fi("No matching records found");if(u.status===422)throw new Eu("Request does not conform to schema or semantic constraints");if(u.body==null)throw new Nn("GET ipns response had no body");const d=await u.arrayBuffer(),h=new Uint8Array(d,0,d.byteLength);return t.validate!==!1&&await nc(rc(e.multihash),h),Hi(h)}catch(c){throw bt.error("getIPNS GET %s error:",a,c),c}finally{i.clear(),o.resolve(),bt("getIPNS finished: %s",e)}}async putIPNS(e,t,r={}){bt("putIPNS starts: %c",e);const i=AbortSignal.timeout(this.timeout),s=Le([this.shutDownController.signal,i,r.signal]),o=ve(),a=ve();this.httpQueue.add(async()=>(o.resolve(),a.promise));const c=`${this.clientUrl}routing/v1/ipns/${e}`;try{await o.promise;const u=nd(t),d={method:"PUT",headers:{"Content-Type":"application/vnd.ipfs.ipns-record"},body:u,signal:s},h=await D(this,Kt,ja).call(this,c,d);if(bt("putIPNS PUT %s %d",c,h.status),h.status!==200)throw new Nn("PUT ipns response had status other than 200")}catch(u){throw bt.error("putIPNS PUT %s error:",c,u.stack),u}finally{s.clear(),a.resolve(),bt("putIPNS finished: %c",e)}}}Kt=new WeakSet,Ga=function(e){var t;try{const r=[],i=((t=e.Addrs)==null?void 0:t.map(fe))??[];return e.Protocols!=null&&r.push(...e.Protocols),e.Protocol!=null&&(r.push(e.Protocol),delete e.Protocol),{...e,Schema:"peer",ID:gh(e.ID),Addrs:i,Protocols:r}}catch(r){bt.error("could not conform record to peer schema",r)}},g0=function(e,t,r){var i,s;if(t!=null||this.filterAddrs!=null){const o=(t==null?void 0:t.join(","))??((i=this.filterAddrs)==null?void 0:i.join(","))??"";o!==""&&e.searchParams.set("filter-addrs",o)}if(r!=null||this.filterProtocols!=null){const o=(r==null?void 0:r.join(","))??((s=this.filterProtocols)==null?void 0:s.join(","))??"";o!==""&&e.searchParams.set("filter-protocols",o)}},ja=async function(e,t){var c,u;const r=t.method??"GET",i=`${r}-${e}`;if(r==="GET"){const d=await((c=this.cache)==null?void 0:c.match(e));if(d!=null){if(parseInt(d.headers.get("x-cache-expires")??"0",10)>Date.now())return bt("returning cached response for %s",i),d;await((u=this.cache)==null?void 0:u.delete(e))}}const s=this.inFlightRequests.get(i);if(s!=null){const d=await s;return bt("deduplicating outgoing request for %s",i),d.clone()}const o=fetch(e,t).then(async d=>{if(this.cache!=null&&d.ok&&r==="GET"){const h=Date.now()+this.cacheTTL,f=new Headers(d.headers);f.set("x-cache-expires",h.toString());const p=new Response(d.clone().body,{status:d.status,statusText:d.statusText,headers:f});await this.cache.put(e,p)}return d}).finally(()=>{this.inFlightRequests.delete(i)});return this.inFlightRequests.set(i,o),await o};function d9(n,e={}){return new nI(new URL(n),e)}function iI(){return{filterProtocols:["unknown","transport-bitswap","transport-ipfs-gateway-http"],filterAddrs:["https","webtransport","webrtc","webrtc-direct","wss","tls"]}}const Sm="[a-fA-F\\d:]",Di=n=>n&&n.includeBoundaries?`(?:(?<=\\s|^)(?=${Sm})|(?<=${Sm})(?=\\s|$))`:"",jr="(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)(?:\\.(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)){3}",ct="[a-fA-F\\d]{1,4}",Lh=`
(?:
(?:${ct}:){7}(?:${ct}|:)|                                    // 1:2:3:4:5:6:7::  1:2:3:4:5:6:7:8
(?:${ct}:){6}(?:${jr}|:${ct}|:)|                             // 1:2:3:4:5:6::    1:2:3:4:5:6::8   1:2:3:4:5:6::8  1:2:3:4:5:6::1.2.3.4
(?:${ct}:){5}(?::${jr}|(?::${ct}){1,2}|:)|                   // 1:2:3:4:5::      1:2:3:4:5::7:8   1:2:3:4:5::8    1:2:3:4:5::7:1.2.3.4
(?:${ct}:){4}(?:(?::${ct}){0,1}:${jr}|(?::${ct}){1,3}|:)| // 1:2:3:4::        1:2:3:4::6:7:8   1:2:3:4::8      1:2:3:4::6:7:1.2.3.4
(?:${ct}:){3}(?:(?::${ct}){0,2}:${jr}|(?::${ct}){1,4}|:)| // 1:2:3::          1:2:3::5:6:7:8   1:2:3::8        1:2:3::5:6:7:1.2.3.4
(?:${ct}:){2}(?:(?::${ct}){0,3}:${jr}|(?::${ct}){1,5}|:)| // 1:2::            1:2::4:5:6:7:8   1:2::8          1:2::4:5:6:7:1.2.3.4
(?:${ct}:){1}(?:(?::${ct}){0,4}:${jr}|(?::${ct}){1,6}|:)| // 1::              1::3:4:5:6:7:8   1::8            1::3:4:5:6:7:1.2.3.4
(?::(?:(?::${ct}){0,5}:${jr}|(?::${ct}){1,7}|:))             // ::2:3:4:5:6:7:8  ::2:3:4:5:6:7:8  ::8             ::1.2.3.4
)(?:%[0-9a-zA-Z]{1,})?                                             // %eth0            %1
`.replace(/\s*\/\/.*$/gm,"").replace(/\n/g,"").trim(),sI=new RegExp(`(?:^${jr}$)|(?:^${Lh}$)`),oI=new RegExp(`^${jr}$`),aI=new RegExp(`^${Lh}$`),Bh=n=>n&&n.exact?sI:new RegExp(`(?:${Di(n)}${jr}${Di(n)})|(?:${Di(n)}${Lh}${Di(n)})`,"g");Bh.v4=n=>n&&n.exact?oI:new RegExp(`${Di(n)}${jr}${Di(n)}`,"g");Bh.v6=n=>n&&n.exact?aI:new RegExp(`${Di(n)}${Lh}${Di(n)}`,"g");function cI(n){const e=(...t)=>n(...t);return Object.defineProperty(e,"name",{value:`functionTimeout(${n.name||"<anonymous>"})`,configurable:!0}),e}const{toString:lI}=Object.prototype;function uI(n){return lI.call(n)==="[object RegExp]"}const Em={global:"g",ignoreCase:"i",multiline:"m",dotAll:"s",sticky:"y",unicode:"u"};function dI(n,e={}){if(!uI(n))throw new TypeError("Expected a RegExp instance");const t=Object.keys(Em).map(i=>(typeof e[i]=="boolean"?e[i]:n[i])?Em[i]:"").join(""),r=new RegExp(e.source||n.source,t);return r.lastIndex=typeof e.lastIndex=="number"?e.lastIndex:n.lastIndex,r}function h9(n,e,{timeout:t}={}){try{return cI(()=>dI(n).test(e),{timeout:t})()}catch(r){throw r}}const hI=15,fI=45,f9={timeout:400};function xm(n){return n.length>fI?!1:h9(Bh.v6({exact:!0}),n,f9)}function pI(n){return n.length>hI?!1:h9(Bh.v4({exact:!0}),n,f9)}const Am={http:"80",https:"443",ws:"80",wss:"443"},gI=["http","https","ws","wss"];function mI(n,e){e=e??{};const t=e.defaultDnsType??"dns",{scheme:r,hostname:i,port:s,path:o}=yI(n),a=[wI(i,t),bI(s,r),vI(r)];o!=null&&a.push(SI(o));const c="/"+a.filter(u=>!!u).reduce((u,d)=>u.concat(d),[]).join("/");return fe(c)}function yI(n){const[e]=n.split(":");gI.includes(e)||(n="http"+n.substring(e.length));let{protocol:t,hostname:r,port:i,pathname:s,search:o}=new URL(n);if(i==null||i===""){const c=EI(e);c!=null&&(i=c),c==null&&t==="http:"&&(i="80")}let a;return s!=null&&s!==""&&s!=="/"&&(s.startsWith("/")&&(s=s.substring(1)),a=s),o!=null&&o!==""&&(a=a??"",a+=o),{scheme:e,hostname:r,port:i,path:a}}function wI(n,e){if(!(n==null||n==="")){if(pI(n))return["ip4",n];if(xm(n))return["ip6",n];if(n[0]==="["){const t=n.substring(1,n.length-1);if(xm(t))return["ip6",t]}return[e,n]}}function bI(n,e){if(!(n==null||n===""))return e==="udp"?["udp",n]:["tcp",n]}function vI(n){if(n.match(/^tcp$|^udp$/)==null)return n==="https"?["/tls/http"]:n==="wss"?["/tls/ws"]:[n]}function SI(n){if(!(n==null||n===""))return["http-path",encodeURIComponent(n)]}function EI(n){if(!(n==null||n===""||Am[n]==null))return Am[n]}const xI=["https://trustless-gateway.link","https://4everland.io"],AI=2336;function kI(n){return n=n.toString(),{id:Dp(le.createV1(AI,nn.digest(R(n)))),multiaddrs:[mI(n)]}}class _I{constructor(e={}){l(this,"gateways");l(this,"shuffle");this.gateways=(e.gateways??xI).map(t=>kI(t)),this.shuffle=e.shuffle??!0}async*findProviders(e,t){yield*(this.shuffle?this.gateways.toSorted(()=>Math.random()>.5?1:-1):this.gateways).map(r=>({...r,protocols:["transport-ipfs-gateway-http"]}))}}function p9(n={}){return new _I(n)}class II{constructor(e){l(this,"libp2p");this.libp2p=e}async provide(e,t){await this.libp2p.contentRouting.provide(e,t)}async cancelReprovide(e,t){await this.libp2p.contentRouting.cancelReprovide(e,t)}async*findProviders(e,t){yield*this.libp2p.contentRouting.findProviders(e,t)}async put(e,t,r){await this.libp2p.contentRouting.put(e,t,r)}async get(e,t){return this.libp2p.contentRouting.get(e,t)}async findPeer(e,t){return this.libp2p.peerRouting.findPeer(e,t)}async*getClosestPeers(e,t){yield*this.libp2p.peerRouting.getClosestPeers(e,t)}}function g9(n){return new II(n)}class CI extends R7{constructor(){super();l(this,"data");this.data=new Map}put(t,r,i){var s;return(s=i==null?void 0:i.signal)==null||s.throwIfAborted(),this.data.set(ds.encode(t.multihash.bytes),r),t}get(t,r){var s;(s=r==null?void 0:r.signal)==null||s.throwIfAborted();const i=this.data.get(ds.encode(t.multihash.bytes));if(i==null)throw new ng;return i}has(t,r){var i;return(i=r==null?void 0:r.signal)==null||i.throwIfAborted(),this.data.has(ds.encode(t.multihash.bytes))}async delete(t,r){var i;(i=r==null?void 0:r.signal)==null||i.throwIfAborted(),this.data.delete(ds.encode(t.multihash.bytes))}async*getAll(t){var r,i;(r=t==null?void 0:t.signal)==null||r.throwIfAborted();for(const[s,o]of this.data.entries())yield{cid:le.createV1(Bt,Pt(ds.decode(s))),block:o},(i=t==null?void 0:t.signal)==null||i.throwIfAborted()}}Ch("blockstore:core:tiered");const TI="SHARDING";function RI(n){return n[Symbol.asyncIterator]!=null}function km(n,e){return RI(n)?async function*(){yield*(await wc(n)).sort(e)}():function*(){yield*wc(n).sort(e)}()}class PI{put(e,t,r){return Promise.reject(new Error(".put is not implemented"))}get(e,t){return Promise.reject(new Error(".get is not implemented"))}has(e,t){return Promise.reject(new Error(".has is not implemented"))}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*putMany(e,t={}){for await(const{key:r,value:i}of e)await this.put(r,i,t),yield r}async*getMany(e,t={}){for await(const r of e)yield{key:r,value:await this.get(r,t)}}async*deleteMany(e,t={}){for await(const r of e)await this.delete(r,t),yield r}batch(){let e=[],t=[];return{put(r,i){e.push({key:r,value:i})},delete(r){t.push(r)},commit:async r=>{await ui(this.putMany(e,r)),e=[],await ui(this.deleteMany(t,r)),t=[]}}}async*_all(e,t){throw new Error("._all is not implemented")}async*_allKeys(e,t){throw new Error("._allKeys is not implemented")}query(e,t){let r=this._all(e,t);if(e.prefix!=null){const i=e.prefix;r=Mn(r,s=>s.key.toString().startsWith(i))}if(Array.isArray(e.filters)&&(r=e.filters.reduce((i,s)=>Mn(i,s),r)),Array.isArray(e.orders)&&(r=e.orders.reduce((i,s)=>km(i,s),r)),e.offset!=null){let i=0;const s=e.offset;r=Mn(r,()=>i++>=s)}return e.limit!=null&&(r=qu(r,e.limit)),r}queryKeys(e,t){let r=this._allKeys(e,t);if(e.prefix!=null){const i=e.prefix;r=Mn(r,s=>s.toString().startsWith(i))}if(Array.isArray(e.filters)&&(r=e.filters.reduce((i,s)=>Mn(i,s),r)),Array.isArray(e.orders)&&(r=e.orders.reduce((i,s)=>km(i,s),r)),e.offset!=null){const i=e.offset;let s=0;r=Mn(r,()=>s++>=i)}return e.limit!=null&&(r=qu(r,e.limit)),r}}class m9 extends PI{constructor(){super();l(this,"data");this.data=new Map}put(t,r,i){var s;return(s=i==null?void 0:i.signal)==null||s.throwIfAborted(),this.data.set(t.toString(),r),t}get(t,r){var s;(s=r==null?void 0:r.signal)==null||s.throwIfAborted();const i=this.data.get(t.toString());if(i==null)throw new ng;return i}has(t,r){var i;return(i=r==null?void 0:r.signal)==null||i.throwIfAborted(),this.data.has(t.toString())}delete(t,r){var i;(i=r==null?void 0:r.signal)==null||i.throwIfAborted(),this.data.delete(t.toString())}*_all(t,r){var i,s;(i=r==null?void 0:r.signal)==null||i.throwIfAborted();for(const[o,a]of this.data.entries())yield{key:new Ue(o),value:a},(s=r==null?void 0:r.signal)==null||s.throwIfAborted()}*_allKeys(t,r){var i,s;(i=r==null?void 0:r.signal)==null||i.throwIfAborted();for(const o of this.data.keys())yield new Ue(o),(s=r==null?void 0:r.signal)==null||s.throwIfAborted()}}new Ue(TI);Ch("datastore:core:tiered");function id(n){if(typeof n!="object"||n===null)return!1;const e=Object.getPrototypeOf(n);return(e===null||e===Object.prototype||Object.getPrototypeOf(e)===null)&&!(Symbol.toStringTag in n)&&!(Symbol.iterator in n)}const{hasOwnProperty:y9}=Object.prototype,{propertyIsEnumerable:OI}=Object,jo=(n,e,t)=>{Object.defineProperty(n,e,{value:t,writable:!0,enumerable:!0,configurable:!0})},DI=void 0,_m={concatArrays:!1,ignoreUndefined:!1},Mh=n=>{const e=[];for(const t in n)y9.call(n,t)&&e.push(t);if(Object.getOwnPropertySymbols){const t=Object.getOwnPropertySymbols(n);for(const r of t)OI.call(n,r)&&e.push(r)}return e};function va(n){return Array.isArray(n)?NI(n):id(n)?LI(n):n}function NI(n){const e=n.slice(0,0);return Mh(n).forEach(t=>{jo(e,t,va(n[t]))}),e}function LI(n){const e=Object.getPrototypeOf(n)===null?Object.create(null):{};return Mh(n).forEach(t=>{jo(e,t,va(n[t]))}),e}const w9=(n,e,t,r)=>(t.forEach(i=>{typeof e[i]>"u"&&r.ignoreUndefined||(i in n&&n[i]!==Object.getPrototypeOf(n)?jo(n,i,m0(n[i],e[i],r)):jo(n,i,va(e[i])))}),n),BI=(n,e,t)=>{let r=n.slice(0,0),i=0;return[n,e].forEach(s=>{const o=[];for(let a=0;a<s.length;a++)y9.call(s,a)&&(o.push(String(a)),s===n?jo(r,i++,s[a]):jo(r,i++,va(s[a])));r=w9(r,s,Mh(s).filter(a=>!o.includes(a)),t)}),r};function m0(n,e,t){return t.concatArrays&&Array.isArray(n)&&Array.isArray(e)?BI(n,e,t):!id(e)||!id(n)?va(e):w9(n,e,Mh(e),t)}function un(...n){const e=m0(va(_m),this!==DI&&this||{},_m);let t={_:{}};for(const r of n)if(r!==void 0){if(!id(r))throw new TypeError("`"+r+"` is not an Option Object");t=m0(t,{_:r},e)}return t._}class MI{constructor(){l(this,"dns")}canResolve(e){return e.getComponents().some(({name:t})=>t==="dnsaddr")}async resolve(e,t){var c,u;const r=(c=e.getComponents().find(d=>d.name==="dnsaddr"))==null?void 0:c.value;if(r==null)return[e];const s=await this.getDNS(t).query(`_dnsaddr.${r}`,{signal:t==null?void 0:t.signal,types:[_n.TXT]}),o=(u=e.getComponents().find(d=>d.name==="p2p"))==null?void 0:u.value,a=[];for(const d of s.Answer){const h=d.data.replace(/["']/g,"").trim().split("=")[1];h!=null&&(o!=null&&!h.includes(o)||a.push(fe(h)))}return a}getDNS(e){return e.dns!=null?e.dns:(this.dns==null&&(this.dns=Xu()),this.dns)}}const lg=new MI,UI={addresses:{listen:[],announce:[],noAnnounce:[],announceFilter:n=>n},connectionManager:{resolvers:{dnsaddr:lg}},transportManager:{faultTolerance:Sc.FATAL_ALL}};async function FI(n){var t,r;const e=un(UI,n);if(e.connectionProtector===null&&((r=(t=globalThis.process)==null?void 0:t.env)==null?void 0:r.LIBP2P_FORCE_PNET)!=null)throw new O("Private network is enforced, but no protector was provided");return e}var sd;(function(n){let e;n.codec=()=>(e==null&&(e=me((t,r,i={})=>{i.lengthDelimited!==!1&&r.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(r.uint32(10),r.bytes(t.publicKey)),t.payloadType!=null&&t.payloadType.byteLength>0&&(r.uint32(18),r.bytes(t.payloadType)),t.payload!=null&&t.payload.byteLength>0&&(r.uint32(26),r.bytes(t.payload)),t.signature!=null&&t.signature.byteLength>0&&(r.uint32(42),r.bytes(t.signature)),i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{const s={publicKey:Fe(0),payloadType:Fe(0),payload:Fe(0),signature:Fe(0)},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.publicKey=t.bytes();break}case 2:{s.payloadType=t.bytes();break}case 3:{s.payload=t.bytes();break}case 5:{s.signature=t.bytes();break}default:{t.skipType(a&7);break}}}return s})),e),n.encode=t=>ye(t,n.codec()),n.decode=(t,r)=>we(t,n.codec(),r)})(sd||(sd={}));class $I extends Error{constructor(e="Invalid signature"){super(e),this.name="InvalidSignatureError"}}const Ci=class Ci{constructor(e){l(this,"publicKey");l(this,"payloadType");l(this,"payload");l(this,"signature");l(this,"marshaled");const{publicKey:t,payloadType:r,payload:i,signature:s}=e;this.publicKey=t,this.payloadType=r,this.payload=i,this.signature=s}marshal(){return this.marshaled==null&&(this.marshaled=sd.encode({publicKey:en(this.publicKey),payloadType:this.payloadType,payload:this.payload.subarray(),signature:this.signature})),this.marshaled}equals(e){return e==null?!1:ke(this.marshal(),e.marshal())}async validate(e,t){const r=Im(e,this.payloadType,this.payload);return this.publicKey.verify(r.subarray(),this.signature,t)}};l(Ci,"createFromProtobuf",e=>{const t=sd.decode(e),r=on(t.publicKey);return new Ci({publicKey:r,payloadType:t.payloadType,payload:t.payload,signature:t.signature})}),l(Ci,"seal",async(e,t,r)=>{if(t==null)throw new Error("Missing private key");const i=e.domain,s=e.codec,o=e.marshal(),a=Im(i,s,o),c=await t.sign(a.subarray(),r);return new Ci({publicKey:t.publicKey,payloadType:s,payload:o,signature:c})}),l(Ci,"openAndCertify",async(e,t,r)=>{const i=Ci.createFromProtobuf(e);if(!await i.validate(t,r))throw new $I("Envelope signature is not valid for the given domain");return i});let Xi=Ci;const Im=(n,e,t)=>{const r=R(n),i=Jr(r.byteLength),s=Jr(e.length),o=Jr(t.length);return new Ee(i,r,s,e,o,t)};function HI(n,e){const t=(r,i)=>r.toString().localeCompare(i.toString());return n.length!==e.length?!1:(e.sort(t),n.sort(t).every((r,i)=>e[i].equals(r)))}const VI="libp2p-peer-record",zI=Uint8Array.from([3,1]);var od;(function(n){(function(t){let r;t.codec=()=>(r==null&&(r=me((i,s,o={})=>{o.lengthDelimited!==!1&&s.fork(),i.multiaddr!=null&&i.multiaddr.byteLength>0&&(s.uint32(10),s.bytes(i.multiaddr)),o.lengthDelimited!==!1&&s.ldelim()},(i,s,o={})=>{const a={multiaddr:Fe(0)},c=s==null?i.len:i.pos+s;for(;i.pos<c;){const u=i.uint32();switch(u>>>3){case 1:{a.multiaddr=i.bytes();break}default:{i.skipType(u&7);break}}}return a})),r),t.encode=i=>ye(i,t.codec()),t.decode=(i,s)=>we(i,t.codec(),s)})(n.AddressInfo||(n.AddressInfo={}));let e;n.codec=()=>(e==null&&(e=me((t,r,i={})=>{if(i.lengthDelimited!==!1&&r.fork(),t.peerId!=null&&t.peerId.byteLength>0&&(r.uint32(10),r.bytes(t.peerId)),t.seq!=null&&t.seq!==0n&&(r.uint32(16),r.uint64(t.seq)),t.addresses!=null)for(const s of t.addresses)r.uint32(26),n.AddressInfo.codec().encode(s,r);i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{var a,c;const s={peerId:Fe(0),seq:0n,addresses:[]},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const u=t.uint32();switch(u>>>3){case 1:{s.peerId=t.bytes();break}case 2:{s.seq=t.uint64();break}case 3:{if(((a=i.limits)==null?void 0:a.addresses)!=null&&s.addresses.length===i.limits.addresses)throw new It('Decode error - map field "addresses" had too many elements');s.addresses.push(n.AddressInfo.codec().decode(t,t.uint32(),{limits:(c=i.limits)==null?void 0:c.addresses$}));break}default:{t.skipType(u&7);break}}}return s})),e),n.encode=t=>ye(t,n.codec()),n.decode=(t,r)=>we(t,n.codec(),r)})(od||(od={}));const Bn=class Bn{constructor(e){l(this,"peerId");l(this,"multiaddrs");l(this,"seqNumber");l(this,"domain",Bn.DOMAIN);l(this,"codec",Bn.CODEC);l(this,"marshaled");const{peerId:t,multiaddrs:r,seqNumber:i}=e;this.peerId=t,this.multiaddrs=r??[],this.seqNumber=i??BigInt(Date.now())}marshal(){return this.marshaled==null&&(this.marshaled=od.encode({peerId:this.peerId.toMultihash().bytes,seq:BigInt(this.seqNumber),addresses:this.multiaddrs.map(e=>({multiaddr:e.bytes}))})),this.marshaled}equals(e){return!(!(e instanceof Bn)||!this.peerId.equals(e.peerId)||this.seqNumber!==e.seqNumber||!HI(this.multiaddrs,e.multiaddrs))}};l(Bn,"createFromProtobuf",e=>{const t=od.decode(e),r=ln(Pt(t.peerId)),i=(t.addresses??[]).map(o=>fe(o.multiaddr)),s=t.seq;return new Bn({peerId:r,multiaddrs:i,seqNumber:s})}),l(Bn,"DOMAIN",VI),l(Bn,"CODEC",zI);let An=Bn;const KI=36e5,qI=216e5;var bs;(function(n){(function(t){let r;t.codec=()=>(r==null&&(r=me((i,s,o={})=>{o.lengthDelimited!==!1&&s.fork(),i.key!=null&&i.key!==""&&(s.uint32(10),s.string(i.key)),i.value!=null&&i.value.byteLength>0&&(s.uint32(18),s.bytes(i.value)),o.lengthDelimited!==!1&&s.ldelim()},(i,s,o={})=>{const a={key:"",value:Fe(0)},c=s==null?i.len:i.pos+s;for(;i.pos<c;){const u=i.uint32();switch(u>>>3){case 1:{a.key=i.string();break}case 2:{a.value=i.bytes();break}default:{i.skipType(u&7);break}}}return a})),r),t.encode=i=>ye(i,t.codec()),t.decode=(i,s)=>we(i,t.codec(),s)})(n.Peer$metadataEntry||(n.Peer$metadataEntry={})),function(t){let r;t.codec=()=>(r==null&&(r=me((i,s,o={})=>{o.lengthDelimited!==!1&&s.fork(),i.key!=null&&i.key!==""&&(s.uint32(10),s.string(i.key)),i.value!=null&&(s.uint32(18),cd.codec().encode(i.value,s)),o.lengthDelimited!==!1&&s.ldelim()},(i,s,o={})=>{var u;const a={key:""},c=s==null?i.len:i.pos+s;for(;i.pos<c;){const d=i.uint32();switch(d>>>3){case 1:{a.key=i.string();break}case 2:{a.value=cd.codec().decode(i,i.uint32(),{limits:(u=o.limits)==null?void 0:u.value});break}default:{i.skipType(d&7);break}}}return a})),r),t.encode=i=>ye(i,t.codec()),t.decode=(i,s)=>we(i,t.codec(),s)}(n.Peer$tagsEntry||(n.Peer$tagsEntry={}));let e;n.codec=()=>(e==null&&(e=me((t,r,i={})=>{if(i.lengthDelimited!==!1&&r.fork(),t.addresses!=null)for(const s of t.addresses)r.uint32(10),ad.codec().encode(s,r);if(t.protocols!=null)for(const s of t.protocols)r.uint32(18),r.string(s);if(t.publicKey!=null&&(r.uint32(34),r.bytes(t.publicKey)),t.peerRecordEnvelope!=null&&(r.uint32(42),r.bytes(t.peerRecordEnvelope)),t.metadata!=null&&t.metadata.size!==0)for(const[s,o]of t.metadata.entries())r.uint32(50),n.Peer$metadataEntry.codec().encode({key:s,value:o},r);if(t.tags!=null&&t.tags.size!==0)for(const[s,o]of t.tags.entries())r.uint32(58),n.Peer$tagsEntry.codec().encode({key:s,value:o},r);t.updated!=null&&(r.uint32(64),r.uint64Number(t.updated)),i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{var a,c,u,d,h,f;const s={addresses:[],protocols:[],metadata:new Map,tags:new Map},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const p=t.uint32();switch(p>>>3){case 1:{if(((a=i.limits)==null?void 0:a.addresses)!=null&&s.addresses.length===i.limits.addresses)throw new It('Decode error - map field "addresses" had too many elements');s.addresses.push(ad.codec().decode(t,t.uint32(),{limits:(c=i.limits)==null?void 0:c.addresses$}));break}case 2:{if(((u=i.limits)==null?void 0:u.protocols)!=null&&s.protocols.length===i.limits.protocols)throw new It('Decode error - map field "protocols" had too many elements');s.protocols.push(t.string());break}case 4:{s.publicKey=t.bytes();break}case 5:{s.peerRecordEnvelope=t.bytes();break}case 6:{if(((d=i.limits)==null?void 0:d.metadata)!=null&&s.metadata.size===i.limits.metadata)throw new j3('Decode error - map field "metadata" had too many elements');const m=n.Peer$metadataEntry.codec().decode(t,t.uint32());s.metadata.set(m.key,m.value);break}case 7:{if(((h=i.limits)==null?void 0:h.tags)!=null&&s.tags.size===i.limits.tags)throw new j3('Decode error - map field "tags" had too many elements');const m=n.Peer$tagsEntry.codec().decode(t,t.uint32(),{limits:{value:(f=i.limits)==null?void 0:f.tags$value}});s.tags.set(m.key,m.value);break}case 8:{s.updated=t.uint64Number();break}default:{t.skipType(p&7);break}}}return s})),e),n.encode=t=>ye(t,n.codec()),n.decode=(t,r)=>we(t,n.codec(),r)})(bs||(bs={}));var ad;(function(n){let e;n.codec=()=>(e==null&&(e=me((t,r,i={})=>{i.lengthDelimited!==!1&&r.fork(),t.multiaddr!=null&&t.multiaddr.byteLength>0&&(r.uint32(10),r.bytes(t.multiaddr)),t.isCertified!=null&&(r.uint32(16),r.bool(t.isCertified)),t.observed!=null&&(r.uint32(24),r.uint64Number(t.observed)),i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{const s={multiaddr:Fe(0)},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.multiaddr=t.bytes();break}case 2:{s.isCertified=t.bool();break}case 3:{s.observed=t.uint64Number();break}default:{t.skipType(a&7);break}}}return s})),e),n.encode=t=>ye(t,n.codec()),n.decode=(t,r)=>we(t,n.codec(),r)})(ad||(ad={}));var cd;(function(n){let e;n.codec=()=>(e==null&&(e=me((t,r,i={})=>{i.lengthDelimited!==!1&&r.fork(),t.value!=null&&t.value!==0&&(r.uint32(8),r.uint32(t.value)),t.expiry!=null&&(r.uint32(16),r.uint64(t.expiry)),i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{const s={value:0},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.value=t.uint32();break}case 2:{s.expiry=t.uint64();break}default:{t.skipType(a&7);break}}}return s})),e),n.encode=t=>ye(t,n.codec()),n.decode=(t,r)=>we(t,n.codec(),r)})(cd||(cd={}));function WI(n,e){if(n.publicKey!=null||e.publicKey==null)return n;let t;n.type==="RSA"&&(t=n.toMultihash());const r=on(e.publicKey,t);return Go(r)}function GI(n,e,t){const r=bs.decode(e);return Qa(n,r,t)}function Qa(n,e,t){const r=new Map,i=BigInt(Date.now());for(const[s,o]of e.tags.entries())o.expiry!=null&&o.expiry<i||r.set(s,o);return{...e,id:WI(n,e),addresses:e.addresses.filter(({observed:s})=>s!=null&&s>Date.now()-t).map(({multiaddr:s,isCertified:o})=>({multiaddr:fe(s),isCertified:o??!1})),metadata:e.metadata,peerRecordEnvelope:e.peerRecordEnvelope??void 0,tags:r}}function jI(n,e){return QI(n.addresses,e.addresses)&&YI(n.protocols,e.protocols)&&XI(n.publicKey,e.publicKey)&&ZI(n.peerRecordEnvelope,e.peerRecordEnvelope)&&JI(n.metadata,e.metadata)&&eC(n.tags,e.tags)}function QI(n,e){return v9(n,e,(t,r)=>!(t.isCertified!==r.isCertified||!ke(t.multiaddr,r.multiaddr)))}function YI(n,e){return v9(n,e,(t,r)=>t===r)}function XI(n,e){return b9(n,e)}function ZI(n,e){return b9(n,e)}function JI(n,e){return S9(n,e,(t,r)=>ke(t,r))}function eC(n,e){return S9(n,e,(t,r)=>t.value===r.value&&t.expiry===r.expiry)}function b9(n,e){return n==null&&e==null?!0:n!=null&&e!=null?ke(n,e):!1}function v9(n,e,t){if(n.length!==e.length)return!1;for(let r=0;r<n.length;r++)if(!t(n[r],e[r]))return!1;return!0}function S9(n,e,t){if(n.size!==e.size)return!1;for(const[r,i]of n.entries()){const s=e.get(r);if(s==null||!t(i,s))return!1}return!0}const E9="/peers/";function Gl(n){if(!_o(n)||n.type==null)throw new O("Invalid PeerId");const e=n.toCID().toString();return new Ue(`${E9}${e}`)}async function tC(n,e,t,r,i){const s=new Map;for(const o of t){if(o==null)continue;if(o.multiaddr instanceof Uint8Array&&(o.multiaddr=fe(o.multiaddr)),!Np(o.multiaddr))throw new O("Multiaddr was invalid");if(!await e(n,o.multiaddr,i))continue;const a=o.isCertified??!1,c=o.multiaddr.toString(),u=s.get(c);u!=null?o.isCertified=u.isCertified||a:s.set(c,{multiaddr:o.multiaddr,isCertified:a})}return[...s.values()].sort((o,a)=>o.multiaddr.toString().localeCompare(a.multiaddr.toString())).map(({isCertified:o,multiaddr:a})=>{const c=a.getPeerId();return n.equals(c)&&(a=a.decapsulate(fe(`/p2p/${n}`))),{isCertified:o,multiaddr:a.bytes}})}async function Z1(n,e,t,r){var f,p;if(e==null)throw new O("Invalid PeerData");if(e.publicKey!=null&&n.publicKey!=null&&!e.publicKey.equals(n.publicKey))throw new O("publicKey bytes do not match peer id publicKey bytes");const i=(f=r.existingPeer)==null?void 0:f.peer;if(i!=null&&!n.equals(i.id))throw new O("peer id did not match existing peer id");let s=(i==null?void 0:i.addresses)??[],o=new Set((i==null?void 0:i.protocols)??[]),a=(i==null?void 0:i.metadata)??new Map,c=(i==null?void 0:i.tags)??new Map,u=i==null?void 0:i.peerRecordEnvelope;if(t==="patch"){if((e.multiaddrs!=null||e.addresses!=null)&&(s=[],e.multiaddrs!=null&&s.push(...e.multiaddrs.map(m=>({isCertified:!1,multiaddr:m}))),e.addresses!=null&&s.push(...e.addresses)),e.protocols!=null&&(o=new Set(e.protocols)),e.metadata!=null){const m=e.metadata instanceof Map?[...e.metadata.entries()]:Object.entries(e.metadata);a=jl(m,{validate:Cm})}if(e.tags!=null){const m=e.tags instanceof Map?[...e.tags.entries()]:Object.entries(e.tags);c=jl(m,{validate:Tm,map:Rm})}e.peerRecordEnvelope!=null&&(u=e.peerRecordEnvelope)}if(t==="merge"){if(e.multiaddrs!=null&&s.push(...e.multiaddrs.map(m=>({isCertified:!1,multiaddr:m}))),e.addresses!=null&&s.push(...e.addresses),e.protocols!=null&&(o=new Set([...o,...e.protocols])),e.metadata!=null){const m=e.metadata instanceof Map?[...e.metadata.entries()]:Object.entries(e.metadata);for(const[w,b]of m)b==null?a.delete(w):a.set(w,b);a=jl([...a.entries()],{validate:Cm})}if(e.tags!=null){const m=e.tags instanceof Map?[...e.tags.entries()]:Object.entries(e.tags),w=new Map(c);for(const[b,S]of m)S==null?w.delete(b):w.set(b,S);c=jl([...w.entries()],{validate:Tm,map:Rm})}e.peerRecordEnvelope!=null&&(u=e.peerRecordEnvelope)}let d;(i==null?void 0:i.id.publicKey)!=null?d=en(i.id.publicKey):e.publicKey!=null?d=en(e.publicKey):n.publicKey!=null&&(d=en(n.publicKey));const h={addresses:await tC(n,r.addressFilter??(async()=>!0),s,(p=r.existingPeer)==null?void 0:p.peerPB.addresses,r),protocols:[...o.values()].sort((m,w)=>m.localeCompare(w)),metadata:a,tags:c,publicKey:d,peerRecordEnvelope:u};return h.addresses.forEach(m=>{var w,b,S;m.observed=((S=(b=(w=r.existingPeer)==null?void 0:w.peerPB.addresses)==null?void 0:b.find(k=>ke(k.multiaddr,k.multiaddr)))==null?void 0:S.observed)??Date.now()}),n.type!=="RSA"&&delete h.publicKey,h}function jl(n,e){var r;const t=new Map;for(const[i,s]of n)s!=null&&e.validate(i,s);for(const[i,s]of n.sort(([o],[a])=>o.localeCompare(a)))s!=null&&t.set(i,((r=e.map)==null?void 0:r.call(e,i,s))??s);return t}function Cm(n,e){if(typeof n!="string")throw new O("Metadata key must be a string");if(!(e instanceof Uint8Array))throw new O("Metadata value must be a Uint8Array")}function Tm(n,e){if(typeof n!="string")throw new O("Tag name must be a string");if(e.value!=null){if(parseInt(`${e.value}`,10)!==e.value)throw new O("Tag value must be an integer");if(e.value<0||e.value>100)throw new O("Tag value must be between 0-100")}if(e.ttl!=null){if(parseInt(`${e.ttl}`,10)!==e.ttl)throw new O("Tag ttl must be an integer");if(e.ttl<0)throw new O("Tag ttl must be between greater than 0")}}function Rm(n,e){let t;e.expiry!=null&&(t=e.expiry),e.ttl!=null&&(t=BigInt(Date.now()+Number(e.ttl)));const r={value:e.value??0};return t!=null&&(r.expiry=t),r}function x9(n){const e=n.toString().split("/")[2],t=le.parse(e,ds);return hl(t)}function J1(n,e,t){const r=x9(n);return GI(r,e,t)}function rC(n,e){return{prefix:E9,filters:(n.filters??[]).map(t=>({key:r,value:i})=>t(J1(r,i,e))),orders:(n.orders??[]).map(t=>(r,i)=>t(J1(r.key,r.value,e),J1(i.key,i.value,e)))}}var ir,xu,Au,ku;class nC{constructor(e,t={}){pe(this,ir);l(this,"peerId");l(this,"datastore");l(this,"locks");l(this,"addressFilter");l(this,"log");l(this,"maxAddressAge");l(this,"maxPeerAge");this.log=e.logger.forComponent("libp2p:peer-store"),this.peerId=e.peerId,this.datastore=e.datastore,this.addressFilter=t.addressFilter,this.locks=_h({name:"libp2p_peer_store_locks",metrics:e.metrics}),this.maxAddressAge=t.maxAddressAge??KI,this.maxPeerAge=t.maxPeerAge??qI}getLock(e){let t=this.locks.get(e);return t==null&&(t={refs:0,lock:T7({name:e.toString(),singleProcess:!0})},this.locks.set(e,t)),t.refs++,t}maybeRemoveLock(e,t){t.refs--,t.refs===0&&(t.lock.finalize(),this.locks.delete(e))}async getReadLock(e,t){const r=this.getLock(e);try{const i=await r.lock.readLock(t);return()=>{i(),this.maybeRemoveLock(e,r)}}catch(i){throw this.maybeRemoveLock(e,r),i}}async getWriteLock(e,t){const r=this.getLock(e);try{const i=await r.lock.writeLock(t);return()=>{i(),this.maybeRemoveLock(e,r)}}catch(i){throw this.maybeRemoveLock(e,r),i}}async has(e,t){try{return await this.load(e,t),!0}catch(r){if(r.name!=="NotFoundError")throw r}return!1}async delete(e,t){this.peerId.equals(e)||await this.datastore.delete(Gl(e),t)}async load(e,t){const r=Gl(e),i=await this.datastore.get(r,t),s=bs.decode(i);if(D(this,ir,ku).call(this,e,s))throw await this.datastore.delete(r,t),new tr;return Qa(e,s,this.peerId.equals(e)?1/0:this.maxAddressAge)}async save(e,t,r){const i=await D(this,ir,xu).call(this,e,r),s=await Z1(e,t,"patch",{...r,addressFilter:this.addressFilter});return D(this,ir,Au).call(this,e,s,i)}async patch(e,t,r){const i=await D(this,ir,xu).call(this,e,r),s=await Z1(e,t,"patch",{...r,addressFilter:this.addressFilter,existingPeer:i});return D(this,ir,Au).call(this,e,s,i)}async merge(e,t,r){const i=await D(this,ir,xu).call(this,e,r),s=await Z1(e,t,"merge",{addressFilter:this.addressFilter,existingPeer:i});return D(this,ir,Au).call(this,e,s,i)}async*all(e){for await(const{key:t,value:r}of this.datastore.query(rC(e??{},this.maxAddressAge),e)){const i=x9(t);if(i.equals(this.peerId))continue;const s=bs.decode(r);if(D(this,ir,ku).call(this,i,s)){await this.datastore.delete(t,e);continue}yield Qa(i,s,this.peerId.equals(i)?1/0:this.maxAddressAge)}}}ir=new WeakSet,xu=async function(e,t){try{const r=Gl(e),i=await this.datastore.get(r,t),s=bs.decode(i);if(D(this,ir,ku).call(this,e,s))throw await this.datastore.delete(r,t),new tr;return{peerPB:s,peer:Qa(e,s,this.maxAddressAge)}}catch(r){r.name!=="NotFoundError"&&this.log.error("invalid peer data found in peer store - %e",r)}},Au=async function(e,t,r,i){t.updated=Date.now();const s=bs.encode(t);return await this.datastore.put(Gl(e),s,i),{peer:Qa(e,t,this.maxAddressAge),previous:r==null?void 0:r.peer,updated:r==null||!jI(t,r.peerPB)}},ku=function(e,t){if(t.updated==null)return!0;if(this.peerId.equals(e))return!1;const r=t.updated<Date.now()-this.maxPeerAge,i=Date.now()-this.maxAddressAge,s=t.addresses.filter(o=>o.observed!=null&&o.observed>i);return r&&s.length===0};var G5,zo,_u;G5=Symbol.toStringTag;class iC{constructor(e,t={}){pe(this,zo);l(this,"store");l(this,"events");l(this,"peerId");l(this,"log");l(this,G5,"@libp2p/peer-store");this.log=e.logger.forComponent("libp2p:peer-store"),this.events=e.events,this.peerId=e.peerId,this.store=new nC(e,t)}async forEach(e,t){for await(const r of this.store.all(t))e(r)}async all(e){return wc(this.store.all(e))}async delete(e,t){const r=await this.store.getReadLock(e,t);try{await this.store.delete(e,t)}finally{r()}}async has(e,t){const r=await this.store.getReadLock(e,t);try{return await this.store.has(e,t)}finally{this.log.trace("has release read lock"),r==null||r()}}async get(e,t){const r=await this.store.getReadLock(e,t);try{return await this.store.load(e,t)}finally{r==null||r()}}async getInfo(e,t){const r=await this.get(e,t);return{id:r.id,multiaddrs:r.addresses.map(({multiaddr:i})=>i)}}async save(e,t,r){const i=await this.store.getWriteLock(e,r);try{const s=await this.store.save(e,t,r);return D(this,zo,_u).call(this,e,s),s.peer}finally{i==null||i()}}async patch(e,t,r){const i=await this.store.getWriteLock(e,r);try{const s=await this.store.patch(e,t,r);return D(this,zo,_u).call(this,e,s),s.peer}finally{i==null||i()}}async merge(e,t,r){const i=await this.store.getWriteLock(e,r);try{const s=await this.store.merge(e,t,r);return D(this,zo,_u).call(this,e,s),s.peer}finally{i==null||i()}}async consumePeerRecord(e,t,r){const i=_o(t)?t:_o(t==null?void 0:t.expectedPeer)?t.expectedPeer:void 0,s=_o(t)||t===void 0?r:t,o=await Xi.openAndCertify(e,An.DOMAIN,s),a=hl(o.publicKey.toCID());if((i==null?void 0:i.equals(a))===!1)return this.log("envelope peer id was not the expected peer id - expected: %p received: %p",i,a),!1;const c=An.createFromProtobuf(o.payload);let u;try{u=await this.get(a,s)}catch(d){if(d.name!=="NotFoundError")throw d}if((u==null?void 0:u.peerRecordEnvelope)!=null){const d=Xi.createFromProtobuf(u.peerRecordEnvelope),h=An.createFromProtobuf(d.payload);if(h.seqNumber>=c.seqNumber)return this.log("sequence number was lower or equal to existing sequence number - stored: %d received: %d",h.seqNumber,c.seqNumber),!1}return await this.patch(c.peerId,{peerRecordEnvelope:e,addresses:c.multiaddrs.map(d=>({isCertified:!0,multiaddr:d}))},s),!0}}zo=new WeakSet,_u=function(e,t){t.updated&&(this.peerId.equals(e)?this.events.safeDispatchEvent("self:peer:update",{detail:t}):this.events.safeDispatchEvent("peer:update",{detail:t}))};function sC(n,e={}){return new iC(n,e)}const Pm=864e13,oC=448,ef=449,aC=53,cC=54,lC=55,uC=56;class dC{constructor(e,t={}){l(this,"log");l(this,"mappings");this.log=e.logger.forComponent("libp2p:address-manager:dns-mappings"),this.mappings=an({name:"libp2p_address_manager_dns_mappings",metrics:e.metrics})}has(e){const t=this.findHost(e);for(const r of this.mappings.values())if(r.domain===t)return!0;return!1}add(e,t){t.forEach(r=>{this.log("add DNS mapping %s to %s",r,e);const i=ns(r)===!0;this.mappings.set(r,{domain:e,verified:i,expires:i?Pm-Date.now():0,lastVerified:i?Pm-Date.now():void 0})})}remove(e){const t=this.findHost(e);let r=!1;for(const[i,s]of this.mappings.entries())s.domain===t&&(this.log("removing %s to %s DNS mapping %e",i,s.domain),this.mappings.delete(i),r=r||s.verified);return r}getAll(e){const t=[];for(let r=0;r<e.length;r++){const s=e[r].multiaddr.stringTuples(),o=s[0][1];if(o!=null)for(const[a,c]of this.mappings.entries()){if(o!==a)continue;this.maybeAddSNITuple(s,c.domain)&&(e.splice(r,1),r--,t.push({multiaddr:fe(`/${s.map(d=>[ba(d[0]).name,d[1]].join("/")).join("/")}`),verified:c.verified,type:"dns-mapping",expires:c.expires,lastVerified:c.lastVerified}))}}return t}maybeAddSNITuple(e,t){var r;for(let i=0;i<e.length;i++)if(e[i][0]===oC&&((r=e[i+1])==null?void 0:r[0])!==ef)return e.splice(i+1,0,[ef,t]),!0;return!1}confirm(e,t){const r=this.findHost(e);let i=!1;for(const[s,o]of this.mappings.entries())o.domain===r&&(this.log("marking %s to %s DNS mapping as verified",s,o.domain),i=o.verified,o.verified=!0,o.expires=Date.now()+t,o.lastVerified=Date.now());return i}unconfirm(e,t){const r=this.findHost(e);let i=!1;for(const[s,o]of this.mappings.entries())o.domain===r&&(this.log("removing verification of %s to %s DNS mapping",s,o.domain),i=i||o.verified,o.verified=!1,o.expires=Date.now()+t);return i}findHost(e){for(const t of e.stringTuples())if(t[0]===ef||t[0]===aC||t[0]===cC||t[0]===lC||t[0]===uC)return t[1]}}const tf=4,rf=41,nf=6,hC=273;class fC{constructor(e,t={}){l(this,"log");l(this,"mappings");this.log=e.logger.forComponent("libp2p:address-manager:ip-mappings"),this.mappings=an({name:"libp2p_address_manager_ip_mappings",metrics:e.metrics})}has(e){const t=e.stringTuples();for(const r of this.mappings.values())for(const i of r)if(i.externalIp===t[0][1])return!0;return!1}add(e,t,r,i=t,s="tcp"){const o=`${e}-${t}-${s}`,a=this.mappings.get(o)??[],c={internalIp:e,internalPort:t,externalIp:r,externalPort:i,externalFamily:Uu(r)?4:6,protocol:s,verified:!1,expires:0};a.push(c),this.mappings.set(o,a)}remove(e){const t=e.stringTuples(),r=t[0][1]??"",i=t[1][0]===nf?"tcp":"udp",s=parseInt(t[1][1]??"0");let o=!1;for(const[a,c]of this.mappings.entries()){for(let u=0;u<c.length;u++){const d=c[u];d.externalIp===r&&d.externalPort===s&&d.protocol===i&&(this.log("removing %s:%s to %s:%s %s IP mapping",d.externalIp,d.externalPort,r,s,i),o=o||d.verified,c.splice(u,1),u--)}c.length===0&&this.mappings.delete(a)}return o}getAll(e){const t=[];for(const{multiaddr:r}of e){const i=r.stringTuples();let s;if((i[0][0]===tf||i[0][0]===rf)&&i[1][0]===nf?s=`${i[0][1]}-${i[1][1]}-tcp`:(i[0][0]===tf||i[0][0]===rf)&&i[1][0]===hC&&(s=`${i[0][1]}-${i[1][1]}-udp`),s==null)continue;const o=this.mappings.get(s);if(o!=null)for(const a of o)i[0][0]=a.externalFamily===4?tf:rf,i[0][1]=a.externalIp,i[1][1]=`${a.externalPort}`,t.push({multiaddr:fe(`/${i.map(c=>[ba(c[0]).name,c[1]].join("/")).join("/")}`),verified:a.verified,type:"ip-mapping",expires:a.expires,lastVerified:a.lastVerified})}return t}confirm(e,t){const i=e.stringTuples()[0][1];let s=!1;for(const o of this.mappings.values())for(const a of o)a.externalIp===i&&(this.log("marking %s to %s IP mapping as verified",a.internalIp,a.externalIp),s=a.verified,a.verified=!0,a.expires=Date.now()+t,a.lastVerified=Date.now());return s}unconfirm(e,t){const r=e.stringTuples(),i=r[0][1]??"",s=r[1][0]===nf?"tcp":"udp",o=parseInt(r[1][1]??"0");let a=!1;for(const c of this.mappings.values())for(let u=0;u<c.length;u++){const d=c[u];d.externalIp===i&&d.externalPort===o&&d.protocol===s&&(this.log("removing verification of %s:%s to %s:%s %s IP mapping",d.externalIp,d.externalPort,i,o,s),a=a||d.verified,d.verified=!1,d.expires=Date.now()+t)}return a}}function pC(n){try{for(const{code:e,value:t}of n.getComponents())if(e!==sl&&t!=null){if(e===ph)return t.startsWith("169.254.");if(e===Ts)return t.toLowerCase().startsWith("fe80")}}catch{}return!1}function A9(n){try{for(const{code:e}of n.getComponents())if(e!==sl)return e===ph||e===Ts}catch{}return!1}function Ns(n){try{if(!A9(n))return!1;const[[,e]]=n.stringTuples();return e==null?!1:ns(e)??!1}catch{}return!0}const gC={maxObservedAddresses:10};class mC{constructor(e,t={}){l(this,"log");l(this,"addresses");l(this,"maxObservedAddresses");this.log=e.logger.forComponent("libp2p:address-manager:observed-addresses"),this.addresses=an({name:"libp2p_address_manager_observed_addresses",metrics:e.metrics}),this.maxObservedAddresses=t.maxObservedAddresses??gC.maxObservedAddresses}has(e){return this.addresses.has(e.toString())}removePrefixed(e){for(const t of this.addresses.keys())t.toString().startsWith(e)&&this.addresses.delete(t)}add(e){this.addresses.size!==this.maxObservedAddresses&&(Ns(e)||pC(e)||(this.log("adding observed address %a",e),this.addresses.set(e.toString(),{verified:!1,expires:0})))}getAll(){return Array.from(this.addresses).map(([e,t])=>({multiaddr:fe(e),verified:t.verified,type:"observed",expires:t.expires,lastVerified:t.lastVerified}))}remove(e){var r;const t=((r=this.addresses.get(e.toString()))==null?void 0:r.verified)??!1;return this.log("removing observed address %a",e),this.addresses.delete(e.toString()),t}confirm(e,t){const r=e.toString(),i=this.addresses.get(r)??{verified:!1,expires:Date.now()+t,lastVerified:Date.now()},s=i.verified;return i.verified=!0,i.expires=Date.now()+t,i.lastVerified=Date.now(),this.log("marking observed address %a as verified",r),this.addresses.set(r,i),s}}const yC=[ph,Ts,e8,X6,Z6,Y6];function Om(n){try{for(const{code:e}of n.getComponents())if(e!==sl)return yC.includes(e)}catch{}return!1}const wC={maxObservedAddresses:10};class bC{constructor(e,t={}){l(this,"log");l(this,"addresses");l(this,"maxObservedAddresses");this.log=e.logger.forComponent("libp2p:address-manager:observed-addresses"),this.addresses=an({name:"libp2p_address_manager_transport_addresses",metrics:e.metrics}),this.maxObservedAddresses=t.maxObservedAddresses??wC.maxObservedAddresses}get(e,t){if(Ns(e))return{multiaddr:e,verified:!0,type:"transport",expires:Date.now()+t,lastVerified:Date.now()};const r=this.toKey(e);let i=this.addresses.get(r);return i==null&&(i={verified:!Om(e),expires:0},this.addresses.set(r,i)),{multiaddr:e,verified:i.verified,type:"transport",expires:i.expires,lastVerified:i.lastVerified}}has(e){const t=this.toKey(e);return this.addresses.has(t)}remove(e){var i;const t=this.toKey(e),r=((i=this.addresses.get(t))==null?void 0:i.verified)??!1;return this.log("removing observed address %a",e),this.addresses.delete(t),r}confirm(e,t){const r=this.toKey(e),i=this.addresses.get(r)??{verified:!1,expires:0,lastVerified:0},s=i.verified;return i.verified=!0,i.expires=Date.now()+t,i.lastVerified=Date.now(),this.addresses.set(r,i),s}unconfirm(e,t){const r=this.toKey(e),i=this.addresses.get(r)??{verified:!1,expires:0},s=i.verified;return i.verified=!1,i.expires=Date.now()+t,this.addresses.set(r,i),s}toKey(e){if(Om(e)){const t=e.toOptions();return`${t.host}-${t.port}-${t.transport}`}return e.toString()}}const Dm=6e4,Nm={addressVerificationTTL:Dm*10,addressVerificationRetry:Dm*5},vC=n=>n;function sf(n,e){const t=n.getPeerId();return t!=null&&Ur(t).equals(e)&&(n=n.decapsulate(fe(`/p2p/${e.toString()}`))),n}var j5;j5=Symbol.toStringTag;class SC{constructor(e,t={}){l(this,"log");l(this,"components");l(this,"listen");l(this,"announce");l(this,"appendAnnounce");l(this,"announceFilter");l(this,"observed");l(this,"dnsMappings");l(this,"ipMappings");l(this,"transportAddresses");l(this,"observedAddressFilter");l(this,"addressVerificationTTL");l(this,"addressVerificationRetry");l(this,j5,"@libp2p/address-manager");const{listen:r=[],announce:i=[],appendAnnounce:s=[]}=t;this.components=e,this.log=e.logger.forComponent("libp2p:address-manager"),this.listen=r.map(o=>o.toString()),this.announce=new Set(i.map(o=>o.toString())),this.appendAnnounce=new Set(s.map(o=>o.toString())),this.observed=new mC(e,t),this.dnsMappings=new dC(e,t),this.ipMappings=new fC(e,t),this.transportAddresses=new bC(e,t),this.announceFilter=t.announceFilter??vC,this.observedAddressFilter=Qi(1024),this.addressVerificationTTL=t.addressVerificationTTL??Nm.addressVerificationTTL,this.addressVerificationRetry=t.addressVerificationRetry??Nm.addressVerificationRetry,this._updatePeerStoreAddresses=xc(this._updatePeerStoreAddresses.bind(this),1e3),e.events.addEventListener("transport:listening",()=>{this._updatePeerStoreAddresses()}),e.events.addEventListener("transport:close",()=>{this._updatePeerStoreAddresses()})}_updatePeerStoreAddresses(){const e=this.getAddresses().map(t=>t.getPeerId()===this.components.peerId.toString()?t.decapsulate(`/p2p/${this.components.peerId.toString()}`):t);this.components.peerStore.patch(this.components.peerId,{multiaddrs:e}).catch(t=>{this.log.error("error updating addresses",t)})}getListenAddrs(){return Array.from(this.listen).map(e=>fe(e))}getAnnounceAddrs(){return Array.from(this.announce).map(e=>fe(e))}getAppendAnnounceAddrs(){return Array.from(this.appendAnnounce).map(e=>fe(e))}getObservedAddrs(){return this.observed.getAll().map(e=>e.multiaddr)}addObservedAddr(e){const t=e.stringTuples(),r=`${t[0][1]}:${t[1][1]}`;this.observedAddressFilter.has(r)||(this.observedAddressFilter.add(r),e=sf(e,this.components.peerId),!this.ipMappings.has(e)&&(this.dnsMappings.has(e)||this.observed.add(e)))}confirmObservedAddr(e,t){e=sf(e,this.components.peerId);let r=!0;((t==null?void 0:t.type)==="transport"||this.transportAddresses.has(e))&&!this.transportAddresses.confirm(e,(t==null?void 0:t.ttl)??this.addressVerificationTTL)&&r&&(r=!1),((t==null?void 0:t.type)==="dns-mapping"||this.dnsMappings.has(e))&&!this.dnsMappings.confirm(e,(t==null?void 0:t.ttl)??this.addressVerificationTTL)&&r&&(r=!1),((t==null?void 0:t.type)==="ip-mapping"||this.ipMappings.has(e))&&!this.ipMappings.confirm(e,(t==null?void 0:t.ttl)??this.addressVerificationTTL)&&r&&(r=!1),((t==null?void 0:t.type)==="observed"||this.observed.has(e))&&(this.maybeUpgradeToIPMapping(e)?(this.ipMappings.confirm(e,(t==null?void 0:t.ttl)??this.addressVerificationTTL),r=!1):!this.observed.confirm(e,(t==null?void 0:t.ttl)??this.addressVerificationTTL)&&r&&(r=!1)),r||this._updatePeerStoreAddresses()}removeObservedAddr(e,t){e=sf(e,this.components.peerId),this.observed.has(e)&&this.observed.remove(e),this.transportAddresses.has(e)&&this.transportAddresses.unconfirm(e,(t==null?void 0:t.ttl)??this.addressVerificationRetry),this.dnsMappings.has(e)&&this.dnsMappings.unconfirm(e,(t==null?void 0:t.ttl)??this.addressVerificationRetry),this.ipMappings.has(e)&&this.ipMappings.unconfirm(e,(t==null?void 0:t.ttl)??this.addressVerificationRetry)}getAddresses(){const e=new Set,t=this.getAddressesWithMetadata().filter(r=>{if(!r.verified)return!1;const i=r.multiaddr.toString();return e.has(i)?!1:(e.add(i),!0)}).map(r=>r.multiaddr);return this.announceFilter(t.map(r=>{const i=fe(r),s=i.getComponents().pop();return(s==null?void 0:s.value)===this.components.peerId.toString()?i:i.encapsulate(`/p2p/${this.components.peerId.toString()}`)}))}getAddressesWithMetadata(){const e=this.getAnnounceAddrs();if(e.length>0)return this.components.transportManager.getListeners().forEach(i=>{i.updateAnnounceAddrs(e)}),e.map(i=>({multiaddr:i,verified:!0,type:"announce",expires:Date.now()+this.addressVerificationTTL,lastVerified:Date.now()}));let t=[];t=t.concat(this.components.transportManager.getAddrs().map(i=>this.transportAddresses.get(i,this.addressVerificationTTL)));const r=this.getAppendAnnounceAddrs();return r.length>0&&(this.components.transportManager.getListeners().forEach(i=>{i.updateAnnounceAddrs(r)}),t=t.concat(r.map(i=>({multiaddr:i,verified:!0,type:"announce",expires:Date.now()+this.addressVerificationTTL,lastVerified:Date.now()})))),t=t.concat(this.observed.getAll()),t=t.concat(this.ipMappings.getAll(t)),t=t.concat(this.dnsMappings.getAll(t)),t}addDNSMapping(e,t){this.dnsMappings.add(e,t)}removeDNSMapping(e){this.dnsMappings.remove(fe(`/dns/${e}`))&&this._updatePeerStoreAddresses()}addPublicAddressMapping(e,t,r,i=t,s="tcp"){this.ipMappings.add(e,t,r,i,s),this.observed.removePrefixed(`/ip${Uu(r)?4:6}/${r}/${s}/${i}`)}removePublicAddressMapping(e,t,r,i=t,s="tcp"){this.ipMappings.remove(fe(`/ip${Uu(r)?4:6}/${r}/${s}/${i}`))&&this._updatePeerStoreAddresses()}maybeUpgradeToIPMapping(e){if(this.ipMappings.has(e))return!1;const t=e.toOptions();if(t.family===6||t.host==="127.0.0.1"||ns(t.host)===!0)return!1;const r=this.components.transportManager.getListeners(),i=[s=>Dc.exactMatch(s)||ed.exactMatch(s),s=>Ju.exactMatch(s),s=>S_.exactMatch(s)];for(const s of i){if(!s(e))continue;const o=r.filter(u=>u.getAddrs().filter(d=>d.toOptions().family===4&&s(d)).length>0);if(o.length!==1)continue;const a=o[0].getAddrs().filter(u=>u.toOptions().host!=="127.0.0.1").pop();if(a==null)continue;const c=a.toOptions();return this.observed.remove(e),this.ipMappings.add(c.host,c.port,t.host,t.port,t.transport),!0}return!1}}var Lm;(function(n){n.NOT_STARTED_YET="The libp2p node is not started yet",n.NOT_FOUND="Not found"})(Lm||(Lm={}));class EC extends Error{constructor(e="Missing service"){super(e),this.name="MissingServiceError"}}class xC extends Error{constructor(e="Unmet service dependencies"){super(e),this.name="UnmetServiceDependenciesError"}}class of extends Error{constructor(e="No content routers available"){super(e),this.name="NoContentRoutersError"}}class Bm extends Error{constructor(e="No peer routers available"){super(e),this.name="NoPeerRoutersError"}}class AC extends Error{constructor(e="Should not try to find self"){super(e),this.name="QueriedForSelfError"}}class kC extends Error{constructor(e="Unhandled protocol error"){super(e),this.name="UnhandledProtocolError"}}class _C extends Error{constructor(e="Duplicate protocol handler error"){super(e),this.name="DuplicateProtocolHandlerError"}}class Mm extends Error{constructor(e="Dial denied error"){super(e),this.name="DialDeniedError"}}class IC extends Error{constructor(e="No transport was configured to listen on this address"){super(e),this.name="UnsupportedListenAddressError"}}class CC extends Error{constructor(e="Configured listen addresses could not be listened on"){super(e),this.name="UnsupportedListenAddressesError"}}class TC extends Error{constructor(e="No valid addresses"){super(e),this.name="NoValidAddressesError"}}class RC extends Error{constructor(e="Connection intercepted"){super(e),this.name="ConnectionInterceptedError"}}class PC extends Error{constructor(e="Connection denied"){super(e),this.name="ConnectionDeniedError"}}class y0 extends Error{constructor(e="Stream is not multiplexed"){super(e),this.name="MuxerUnavailableError"}}class Ql extends Error{constructor(e="Encryption failed"){super(e),this.name="EncryptionFailedError"}}class OC extends Error{constructor(e="Transport unavailable"){super(e),this.name="TransportUnavailableError"}}class DC extends Error{constructor(e="Max recursive depth reached"){super(e),this.name="RecursionLimitError"}}class NC{constructor(e={}){l(this,"components",{});l(this,"_started",!1);this.components={};for(const[t,r]of Object.entries(e))this.components[t]=r;this.components.logger==null&&(this.components.logger=Ih())}isStarted(){return this._started}async _invokeStartableMethod(e){await Promise.all(Object.values(this.components).filter(t=>zp(t)).map(async t=>{var r;await((r=t[e])==null?void 0:r.call(t))}))}async beforeStart(){await this._invokeStartableMethod("beforeStart")}async start(){await this._invokeStartableMethod("start"),this._started=!0}async afterStart(){await this._invokeStartableMethod("afterStart")}async beforeStop(){await this._invokeStartableMethod("beforeStop")}async stop(){await this._invokeStartableMethod("stop"),this._started=!1}async afterStop(){await this._invokeStartableMethod("afterStop")}}const LC=["metrics","connectionProtector","dns"],BC=["components","isStarted","beforeStart","start","afterStart","beforeStop","stop","afterStop","then","_invokeStartableMethod"];function MC(n={}){const e=new NC(n);return new Proxy(e,{get(r,i,s){if(typeof i=="string"&&!BC.includes(i)){const o=e.components[i];if(o==null&&!LC.includes(i))throw new EC(`${i} not set`);return o}return Reflect.get(r,i,s)},set(r,i,s){return typeof i=="string"?e.components[i]=s:Reflect.set(r,i,s),!0}})}function UC(n){const e={};for(const t of Object.values(n.components))for(const r of FC(t))e[r]=!0;for(const t of Object.values(n.components))for(const r of $C(t))if(e[r]!==!0)throw new xC(`Service "${HC(t)}" required capability "${r}" but it was not provided by any component, you may need to add additional configuration when creating your node.`)}function FC(n){return Array.isArray(n==null?void 0:n[kt])?n[kt]:[]}function $C(n){return Array.isArray(n==null?void 0:n[Ps])?n[Ps]:[]}function HC(n){return(n==null?void 0:n[Symbol.toStringTag])??(n==null?void 0:n.toString())??"unknown"}const VC=4,zC=41;function KC(n={}){return{denyDialPeer:async()=>!1,denyDialMultiaddr:async e=>{if(Dc.matches(e))return!1;const t=e.stringTuples();return t[0][0]===VC||t[0][0]===zC?!!ns(`${t[0][1]}`):!1},denyInboundConnection:async()=>!1,denyOutboundConnection:async()=>!1,denyInboundEncryptedConnection:async()=>!1,denyOutboundEncryptedConnection:async()=>!1,denyInboundUpgradedConnection:async()=>!1,denyOutboundUpgradedConnection:async()=>!1,filterMultiaddrForPeer:async()=>!0,...n}}const Um=()=>{const n=new Error("Delay aborted");return n.name="AbortError",n},qC=new WeakMap;function WC({clearTimeout:n,setTimeout:e}={}){return(t,{value:r,signal:i}={})=>{if(i!=null&&i.aborted)return Promise.reject(Um());let s,o,a;const c=n??clearTimeout,u=()=>{c(s),a(Um())},d=()=>{i&&i.removeEventListener("abort",u)},h=new Promise((f,p)=>{o=()=>{d(),f(r)},a=p,s=(e??setTimeout)(o,t)});return i&&i.addEventListener("abort",u,{once:!0}),qC.set(h,()=>{c(s),s=null,o()}),h}}const k9=WC();class _9{constructor(e={}){l(this,"memoryStorage");l(this,"points");l(this,"duration");l(this,"blockDuration");l(this,"execEvenly");l(this,"execEvenlyMinDelayMs");l(this,"keyPrefix");this.points=e.points??4,this.duration=e.duration??1,this.blockDuration=e.blockDuration??0,this.execEvenly=e.execEvenly??!1,this.execEvenlyMinDelayMs=e.execEvenlyMinDelayMs??this.duration*1e3/this.points,this.keyPrefix=e.keyPrefix??"rlflx",this.memoryStorage=new GC}async consume(e,t=1,r={}){const i=this.getKey(e),s=this._getKeySecDuration(r);let o=this.memoryStorage.incrby(i,t,s);if(o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o.consumedPoints>this.points)throw this.blockDuration>0&&o.consumedPoints<=this.points+t&&(o=this.memoryStorage.set(i,o.consumedPoints,this.blockDuration)),new VE("Rate limit exceeded",o);if(this.execEvenly&&o.msBeforeNext>0&&!o.isFirstInDuration){let a=Math.ceil(o.msBeforeNext/(o.remainingPoints+2));a<this.execEvenlyMinDelayMs&&(a=o.consumedPoints*this.execEvenlyMinDelayMs),await k9(a)}return o}penalty(e,t=1,r={}){const i=this.getKey(e),s=this._getKeySecDuration(r),o=this.memoryStorage.incrby(i,t,s);return o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o}reward(e,t=1,r={}){const i=this.getKey(e),s=this._getKeySecDuration(r),o=this.memoryStorage.incrby(i,-t,s);return o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o}block(e,t){const r=t*1e3,i=this.points+1;return this.memoryStorage.set(this.getKey(e),i,t),{remainingPoints:0,msBeforeNext:r===0?-1:r,consumedPoints:i,isFirstInDuration:!1}}set(e,t,r=0){const i=(r>=0?r:this.duration)*1e3;return this.memoryStorage.set(this.getKey(e),t,r),{remainingPoints:0,msBeforeNext:i===0?-1:i,consumedPoints:t,isFirstInDuration:!1}}get(e){const t=this.memoryStorage.get(this.getKey(e));return t!=null&&(t.remainingPoints=Math.max(this.points-t.consumedPoints,0)),t}delete(e){this.memoryStorage.delete(this.getKey(e))}_getKeySecDuration(e){return(e==null?void 0:e.customDuration)!=null&&e.customDuration>=0?e.customDuration:this.duration}getKey(e){return this.keyPrefix.length>0?`${this.keyPrefix}:${e}`:e}parseKey(e){return e.substring(this.keyPrefix.length)}}class GC{constructor(){l(this,"storage");this.storage=new Map}incrby(e,t,r){const i=this.storage.get(e);if(i!=null){const s=i.expiresAt!=null?i.expiresAt.getTime()-new Date().getTime():-1;return i.expiresAt==null||s>0?(i.value+=t,{remainingPoints:0,msBeforeNext:s,consumedPoints:i.value,isFirstInDuration:!1}):this.set(e,t,r)}return this.set(e,t,r)}set(e,t,r){const i=r*1e3,s=this.storage.get(e);s!=null&&clearTimeout(s.timeoutId);const o={value:t,expiresAt:i>0?new Date(Date.now()+i):void 0};return this.storage.set(e,o),i>0&&(o.timeoutId=setTimeout(()=>{this.storage.delete(e)},i),o.timeoutId.unref!=null&&o.timeoutId.unref()),{remainingPoints:0,msBeforeNext:i===0?-1:i,consumedPoints:o.value,isFirstInDuration:!0}}get(e){const t=this.storage.get(e);if(t!=null)return{remainingPoints:0,msBeforeNext:t.expiresAt!=null?t.expiresAt.getTime()-new Date().getTime():-1,consumedPoints:t.value,isFirstInDuration:!1}}delete(e){const t=this.storage.get(e);return t!=null?(t.timeoutId!=null&&clearTimeout(t.timeoutId),this.storage.delete(e),!0):!1}}function I9(n){if(_o(n))return{peerId:n,multiaddrs:[]};let e=Array.isArray(n)?n:[n],t;if(e.length>0){const r=e[0].getPeerId();t=r==null?void 0:Ur(r),e.forEach(i=>{if(!Np(i))throw new vh("Invalid multiaddr");const s=i.getPeerId();if(s==null){if(t!=null)throw new O("Multiaddrs must all have the same peer id or have no peer id")}else{const o=Ur(s);if((t==null?void 0:t.equals(o))!==!0)throw new O("Multiaddrs must all have the same peer id or have no peer id")}})}return e=e.filter(r=>!y_.exactMatch(r)),{peerId:t,multiaddrs:e}}const jC=["/ipfs/id/1.0.0","/ipfs/id/push/1.0.0","/libp2p/autonat/1.0.0","/libp2p/dcutr"];async function QC(n,e){var i;const t=((i=n==null?void 0:n.streams)==null?void 0:i.map(s=>s.protocol))??[],r=(e==null?void 0:e.closableProtocols)??jC;if(!(t.filter(s=>s!=null&&!r.includes(s)).length>0))try{await(n==null?void 0:n.close(e))}catch(s){n==null||n.abort(s)}}function w0(n){try{let e;typeof n=="string"?e=fe(n):e=n;const t=new Set([...e.getComponents().map(r=>r.name)]);if(!t.has("ipcidr")){const i=t.has("ip6")?"/ipcidr/128":"/ipcidr/32";e=e.encapsulate(i)}return c_(e)}catch{throw new Error(`Can't convert to IpNet, Invalid multiaddr format: ${n}`)}}class YC{constructor(e,t={}){l(this,"connectionManager");l(this,"peerStore");l(this,"allow");l(this,"events");l(this,"log");this.allow=(t.allow??[]).map(r=>w0(r)),this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager:connection-pruner"),this.maybePruneConnections=this.maybePruneConnections.bind(this)}start(){this.events.addEventListener("connection:open",this.maybePruneConnections)}stop(){this.events.removeEventListener("connection:open",this.maybePruneConnections)}maybePruneConnections(){this._maybePruneConnections().catch(e=>{this.log.error("error while pruning connections %e",e)})}async _maybePruneConnections(){const e=this.connectionManager.getConnections(),t=e.length,r=this.connectionManager.getMaxConnections();if(this.log("checking max connections limit %d/%d",t,r),t<=r)return;const i=new eo;for(const c of e){const u=c.remotePeer;if(!i.has(u)){i.set(u,0);try{const d=await this.peerStore.get(u);i.set(u,[...d.tags.values()].reduce((h,f)=>h+f.value,0))}catch(d){d.name!=="NotFoundError"&&this.log.error("error loading peer tags",d)}}}const s=this.sortConnections(e,i),o=Math.max(t-r,0),a=[];for(const c of s)if(this.log("too many connections open - closing a connection to %p",c.remotePeer),this.allow.some(d=>d.contains(c.remoteAddr.nodeAddress().address))||a.push(c),a.length===o)break;await Promise.all(a.map(async c=>{await QC(c,{signal:AbortSignal.timeout(1e3)})})),this.events.safeDispatchEvent("connection:prune",{detail:a})}sortConnections(e,t){return e.sort((r,i)=>{const s=r.timeline.open,o=i.timeline.open;return s<o?1:s>o?-1:0}).sort((r,i)=>r.direction==="outbound"&&i.direction==="inbound"?1:r.direction==="inbound"&&i.direction==="outbound"?-1:0).sort((r,i)=>r.streams.length>i.streams.length?1:r.streams.length<i.streams.length?-1:0).sort((r,i)=>{const s=t.get(r.remotePeer)??0,o=t.get(i.remotePeer)??0;return s>o?1:s<o?-1:0})}}const C9=1e4,XC=1e4,ld=1e4,T9=25,ZC=5,JC=10,eT=5,tT="last-dial-failure",rT="last-dial-success",R9=500,nT=32,iT=100,P9=50;class sT extends Wi{constructor(e={}){super({...e,sort:(t,r)=>t.options.priority>r.options.priority?-1:t.options.priority<r.options.priority?1:0})}}function oT(n){return/^127\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(n)||/^::1$/.test(n)}function Fm(n){if(!A9(n))return!1;const{address:e}=n.nodeAddress();return oT(e)}function aT(n,e){const t=Ju.exactMatch(n.multiaddr),r=Ju.exactMatch(e.multiaddr);if(t&&!r)return-1;if(!t&&r)return 1;const i=ed.exactMatch(n.multiaddr),s=ed.exactMatch(e.multiaddr);if(i&&!s)return-1;if(!i&&s)return 1;const o=Dc.exactMatch(n.multiaddr),a=Dc.exactMatch(e.multiaddr);if(o&&!a)return-1;if(!o&&a)return 1;const c=d0.exactMatch(n.multiaddr),u=d0.exactMatch(e.multiaddr);if(c&&!u)return-1;if(!c&&u)return 1;const d=u0.exactMatch(n.multiaddr),h=u0.exactMatch(e.multiaddr);if(d&&!h)return-1;if(!d&&h)return 1;const f=ym.exactMatch(n.multiaddr),p=ym.exactMatch(e.multiaddr);return f&&!p?-1:!f&&p?1:0}function cT(n,e){const t=Fm(n.multiaddr),r=Fm(e.multiaddr);return t&&!r?1:!t&&r?-1:0}function lT(n,e){const t=Ns(n.multiaddr),r=Ns(e.multiaddr);return t&&!r?1:!t&&r?-1:0}function uT(n,e){return n.isCertified&&!e.isCertified?-1:!n.isCertified&&e.isCertified?1:0}function dT(n,e){const t=Yi.exactMatch(n.multiaddr),r=Yi.exactMatch(e.multiaddr);return t&&!r?1:!t&&r?-1:0}function hT(n){return n.sort(aT).sort(uT).sort(dT).sort(lT).sort(cT)}async function O9(n,e,t){const r=t.depth??0;if(r>(t.maxRecursiveDepth??nT))throw new DC("Max recursive depth reached");let i=!1;const s=[];for(const o of Object.values(e))if(o.canResolve(n)){i=!0;const a=await o.resolve(n,t);for(const c of a)s.push(...await O9(c,e,{...t,depth:r+1}))}return i===!1&&s.push(n),s}const Fa={maxParallelDials:P9,maxDialQueueLength:R9,maxPeerAddrsToDial:T9,dialTimeout:C9,resolvers:{dnsaddr:lg}};class fT{constructor(e,t={}){l(this,"queue");l(this,"components");l(this,"addressSorter");l(this,"maxPeerAddrsToDial");l(this,"maxDialQueueLength");l(this,"dialTimeout");l(this,"shutDownController");l(this,"connections");l(this,"log");l(this,"resolvers");this.addressSorter=t.addressSorter,this.maxPeerAddrsToDial=t.maxPeerAddrsToDial??Fa.maxPeerAddrsToDial,this.maxDialQueueLength=t.maxDialQueueLength??Fa.maxDialQueueLength,this.dialTimeout=t.dialTimeout??Fa.dialTimeout,this.connections=t.connections??new eo,this.log=e.logger.forComponent("libp2p:connection-manager:dial-queue"),this.components=e,this.resolvers=t.resolvers??Fa.resolvers,this.shutDownController=new AbortController,this.shutDownController.signal,this.queue=new sT({concurrency:t.maxParallelDials??Fa.maxParallelDials,metricName:"libp2p_dial_queue",metrics:e.metrics}),this.queue.addEventListener("failure",r=>{var i;((i=r.detail)==null?void 0:i.error.name)!==ci.name&&this.log.error("error in dial queue - %e",r.detail)})}start(){this.shutDownController=new AbortController,this.shutDownController.signal}stop(){this.shutDownController.abort(),this.queue.abort()}async dial(e,t={}){var a,c,u;const{peerId:r,multiaddrs:i}=I9(e),s=Array.from(this.connections.values()).flat().find(d=>t.force===!0||d.limits!=null?!1:d.remotePeer.equals(r)?!0:i.find(h=>h.equals(d.remoteAddr)));if((s==null?void 0:s.status)==="open")return this.log("already connected to %a",s.remoteAddr),(a=t.onProgress)==null||a.call(t,new N("dial-queue:already-connected")),s;const o=this.queue.queue.find(d=>{if((r==null?void 0:r.equals(d.options.peerId))===!0)return!0;const h=d.options.multiaddrs;if(h==null)return!1;for(const f of i)if(h.has(f.toString()))return!0;return!1});if(o!=null){this.log("joining existing dial target for %p",r);for(const d of i)o.options.multiaddrs.add(d.toString());return(c=t.onProgress)==null||c.call(t,new N("dial-queue:already-in-dial-queue")),o.join(t)}if(this.queue.size>=this.maxDialQueueLength)throw new Io("Dial queue is full");return this.log("creating dial target for %p",r,i.map(d=>d.toString())),(u=t.onProgress)==null||u.call(t,new N("dial-queue:add-to-dial-queue")),this.queue.add(async d=>{var f;(f=d.onProgress)==null||f.call(d,new N("dial-queue:start-dial"));const h=Le([this.shutDownController.signal,d.signal]);try{return await this.dialPeer(d,h)}finally{h.clear()}},{peerId:r,priority:t.priority??D9,multiaddrs:new Set(i.map(d=>d.toString())),signal:t.signal??AbortSignal.timeout(this.dialTimeout),onProgress:t.onProgress})}async dialPeer(e,t){var d;const r=e.peerId,i=e.multiaddrs,s=new Set;let o=e.multiaddrs.size===0,a=0,c=0;const u=[];for(this.log("starting dial to %p",r);o||i.size>0;){c++,o=!1;const h=[],f=new Set(e.multiaddrs);i.clear(),this.log("calculating addrs to dial %p from %s",r,[...f]);const p=await this.calculateMultiaddrs(r,f,{...e,signal:t});for(const m of p){if(s.has(m.multiaddr.toString())){this.log.trace("skipping previously failed multiaddr %a while dialing %p",m.multiaddr,r);continue}h.push(m)}this.log("%s dial to %p with %s",c===1?"starting":"continuing",r,h.map(m=>m.multiaddr.toString())),(d=e==null?void 0:e.onProgress)==null||d.call(e,new N("dial-queue:calculated-addresses",h));for(const m of h){if(a===this.maxPeerAddrsToDial)throw this.log("dialed maxPeerAddrsToDial (%d) addresses for %p, not trying any others",a,e.peerId),new Io("Peer had more than maxPeerAddrsToDial");a++;try{const w=await this.components.transportManager.dial(m.multiaddr,{...e,signal:t});this.log("dial to %a succeeded",m.multiaddr);try{await this.components.peerStore.merge(w.remotePeer,{multiaddrs:[w.remoteAddr],metadata:{[rT]:R(Date.now().toString())}})}catch(b){this.log.error("could not update last dial failure key for %p",r,b)}return w}catch(w){if(this.log.error("dial failed to %a",m.multiaddr,w),s.add(m.multiaddr.toString()),r!=null)try{await this.components.peerStore.merge(r,{metadata:{[tT]:R(Date.now().toString())}})}catch(b){this.log.error("could not update last dial failure key for %p",r,b)}if(t.aborted)throw new ll(w.message);u.push(w)}}}throw u.length===1?u[0]:new AggregateError(u,"All multiaddr dials failed")}async calculateMultiaddrs(e,t=new Set,r={}){var h,f;const i=[...t].map(p=>({multiaddr:fe(p),isCertified:!1}));if(e!=null){if(this.components.peerId.equals(e))throw new Io("Tried to dial self");if(await((f=(h=this.components.connectionGater).denyDialPeer)==null?void 0:f.call(h,e))===!0)throw new Mm("The dial request is blocked by gater.allowDialPeer");if(i.length===0){this.log("loading multiaddrs for %p",e);try{const p=await this.components.peerStore.get(e);i.push(...p.addresses),this.log("loaded multiaddrs for %p",e,i.map(({multiaddr:m})=>m.toString()))}catch(p){if(p.name!=="NotFoundError")throw p}}if(i.length===0){this.log("looking up multiaddrs for %p in the peer routing",e);try{const p=await this.components.peerRouting.findPeer(e,r);this.log("found multiaddrs for %p in the peer routing",e,i.map(({multiaddr:m})=>m.toString())),i.push(...p.multiaddrs.map(m=>({multiaddr:m,isCertified:!1})))}catch(p){p.name==="NoPeerRoutersError"?this.log("no peer routers configured",e):this.log.error("looking up multiaddrs for %p in the peer routing failed - %e",e,p)}}}let s=(await Promise.all(i.map(async p=>{const m=await O9(p.multiaddr,this.resolvers,{dns:this.components.dns,log:this.log,...r});return m.length===1&&m[0].equals(p.multiaddr)?p:m.map(w=>({multiaddr:w,isCertified:!1}))}))).flat();if(e!=null){const p=`/p2p/${e.toString()}`;s=s.map(m=>{const w=m.multiaddr.getComponents().pop();return(w==null?void 0:w.name)!=="p2p"?{multiaddr:m.multiaddr.encapsulate(p),isCertified:m.isCertified}:m})}const o=s.filter(p=>{if(this.components.transportManager.dialTransportForMultiaddr(p.multiaddr)==null)return!1;const m=p.multiaddr.getPeerId();return e!=null&&m!=null?e.equals(m):!0}),a=new Map;for(const p of o){const m=p.multiaddr.toString(),w=a.get(m);if(w!=null){w.isCertified=w.isCertified||p.isCertified||!1;continue}a.set(m,p)}const c=[...a.values()];if(c.length===0)throw new TC("The dial request has no valid addresses");const u=[];for(const p of c)this.components.connectionGater.denyDialMultiaddr!=null&&await this.components.connectionGater.denyDialMultiaddr(p.multiaddr)||u.push(p);const d=this.addressSorter==null?hT(u):u.sort(this.addressSorter);if(d.length===0)throw new Mm("The connection gater denied all addresses in the dial request");return this.log.trace("addresses for %p before filtering",e??"unknown peer",s.map(({multiaddr:p})=>p.toString())),this.log.trace("addresses for %p after filtering",e??"unknown peer",d.map(({multiaddr:p})=>p.toString())),d}async isDialable(e,t={}){Array.isArray(e)||(e=[e]);try{const r=await this.calculateMultiaddrs(void 0,new Set(e.map(i=>i.toString())),t);return t.runOnLimitedConnection===!1?r.find(i=>!Yi.matches(i.multiaddr))!=null:!0}catch(r){this.log.trace("error calculating if multiaddr(s) were dialable",r)}return!1}}const pT=Object.prototype.toString,gT=n=>pT.call(n)==="[object Error]",mT=new Set(["network error","Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Load failed","Network request failed","fetch failed","terminated"]);function yT(n){return n&&gT(n)&&n.name==="TypeError"&&typeof n.message=="string"?n.message==="Load failed"?n.stack===void 0:mT.has(n.message):!1}let wT=class extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}};const $m=(n,e,t)=>{const r=t.retries-(e-1);return n.attemptNumber=e,n.retriesLeft=r,n};async function bT(n,e){return new Promise((t,r)=>{e={...e},e.onFailedAttempt??(e.onFailedAttempt=()=>{}),e.shouldRetry??(e.shouldRetry=()=>!0),e.retries??(e.retries=10);const i=IE.operation(e),s=()=>{var a;i.stop(),r((a=e.signal)==null?void 0:a.reason)};e.signal&&!e.signal.aborted&&e.signal.addEventListener("abort",s,{once:!0});const o=()=>{var a;(a=e.signal)==null||a.removeEventListener("abort",s),i.stop()};i.attempt(async a=>{try{const c=await n(a);o(),t(c)}catch(c){try{if(!(c instanceof Error))throw new TypeError(`Non-error was thrown: "${c}". You should only throw errors.`);if(c instanceof wT)throw c.originalError;if(c instanceof TypeError&&!yT(c))throw c;if($m(c,a,e),await e.shouldRetry(c)||(i.stop(),r(c)),await e.onFailedAttempt(c),!i.retry(c))throw i.mainError()}catch(u){$m(u,a,e),o(),r(u)}}})})}class vT{constructor(e,t={}){l(this,"log");l(this,"queue");l(this,"started");l(this,"peerStore");l(this,"retries");l(this,"retryInterval");l(this,"backoffFactor");l(this,"connectionManager");l(this,"events");this.log=e.logger.forComponent("libp2p:reconnect-queue"),this.peerStore=e.peerStore,this.connectionManager=e.connectionManager,this.queue=new Gi({concurrency:t.maxParallelReconnects??eT,metricName:"libp2p_reconnect_queue",metrics:e.metrics}),this.started=!1,this.retries=t.retries??5,this.backoffFactor=t.backoffFactor,this.retryInterval=t.retryInterval,this.events=e.events,e.events.addEventListener("peer:disconnect",r=>{this.maybeReconnect(r.detail).catch(i=>{this.log.error("failed to maybe reconnect to %p - %e",r.detail,i)})})}async maybeReconnect(e){if(!this.started)return;const t=await this.peerStore.get(e);Hm(t)&&(this.queue.has(e)||this.queue.add(async r=>{await bT(async i=>{if(this.started)try{await this.connectionManager.openConnection(e,{signal:r==null?void 0:r.signal})}catch(s){throw this.log("reconnecting to %p attempt %d of %d failed - %e",e,i,this.retries,s),s}},{signal:r==null?void 0:r.signal,retries:this.retries,factor:this.backoffFactor,minTimeout:this.retryInterval})},{peerId:e}).catch(async r=>{this.log.error("failed to reconnect to %p - %e",e,r);const i={};[...t.tags.keys()].forEach(s=>{s.startsWith(yh)&&(i[s]=void 0)}),await this.peerStore.merge(e,{tags:i}),this.events.safeDispatchEvent("peer:reconnect-failure",{detail:e})}).catch(async r=>{this.log.error("failed to remove keep-alive tag from %p - %e",e,r)}))}start(){this.started=!0}async afterStart(){Promise.resolve().then(async()=>{const e=await this.peerStore.all({filters:[t=>Hm(t)]});await Promise.all(e.map(async t=>{await this.connectionManager.openConnection(t.id).catch(r=>{this.log.error(r)})}))}).catch(e=>{this.log.error(e)})}stop(){this.started=!1,this.queue.abort()}}function Hm(n){for(const e of n.tags.keys())if(e.startsWith(yh))return!0;return!1}const D9=50,af={maxConnections:iT,inboundConnectionThreshold:ZC,maxIncomingPendingConnections:JC};var Q5;Q5=Symbol.toStringTag;class ST{constructor(e,t={}){l(this,"started");l(this,"connections");l(this,"allow");l(this,"deny");l(this,"maxIncomingPendingConnections");l(this,"incomingPendingConnections");l(this,"outboundPendingConnections");l(this,"maxConnections");l(this,"dialQueue");l(this,"reconnectQueue");l(this,"connectionPruner");l(this,"inboundConnectionRateLimiter");l(this,"peerStore");l(this,"metrics");l(this,"events");l(this,"log");l(this,"peerId");l(this,Q5,"@libp2p/connection-manager");var r;if(this.maxConnections=t.maxConnections??af.maxConnections,this.maxConnections<1)throw new O("Connection Manager maxConnections must be greater than 0");this.connections=new eo,this.started=!1,this.peerId=e.peerId,this.peerStore=e.peerStore,this.metrics=e.metrics,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager"),this.onConnect=this.onConnect.bind(this),this.onDisconnect=this.onDisconnect.bind(this),this.allow=(t.allow??[]).map(i=>w0(i)),this.deny=(t.deny??[]).map(i=>w0(i)),this.incomingPendingConnections=0,this.maxIncomingPendingConnections=t.maxIncomingPendingConnections??af.maxIncomingPendingConnections,this.outboundPendingConnections=0,this.inboundConnectionRateLimiter=new _9({points:t.inboundConnectionThreshold??af.inboundConnectionThreshold,duration:1}),this.connectionPruner=new YC({connectionManager:this,peerStore:e.peerStore,events:e.events,logger:e.logger},{allow:(r=t.allow)==null?void 0:r.map(i=>fe(i))}),this.dialQueue=new fT(e,{addressSorter:t.addressSorter,maxParallelDials:t.maxParallelDials??P9,maxDialQueueLength:t.maxDialQueueLength??R9,maxPeerAddrsToDial:t.maxPeerAddrsToDial??T9,dialTimeout:t.dialTimeout??C9,resolvers:t.resolvers??{dnsaddr:lg},connections:this.connections}),this.reconnectQueue=new vT({events:e.events,peerStore:e.peerStore,logger:e.logger,connectionManager:this},{retries:t.reconnectRetries,retryInterval:t.reconnectRetryInterval,backoffFactor:t.reconnectBackoffFactor,maxParallelReconnects:t.maxParallelReconnects})}async start(){var e,t,r;(e=this.metrics)==null||e.registerMetricGroup("libp2p_connection_manager_connections",{calculate:()=>{const i={inbound:0,"inbound pending":this.incomingPendingConnections,outbound:0,"outbound pending":this.outboundPendingConnections};for(const s of this.connections.values())for(const o of s)i[o.direction]++;return i}}),(t=this.metrics)==null||t.registerMetricGroup("libp2p_protocol_streams_total",{label:"protocol",calculate:()=>{const i={};for(const s of this.connections.values())for(const o of s)for(const a of o.streams){const c=`${a.direction} ${a.protocol??"unnegotiated"}`;i[c]=(i[c]??0)+1}return i}}),(r=this.metrics)==null||r.registerMetricGroup("libp2p_connection_manager_protocol_streams_per_connection_90th_percentile",{label:"protocol",calculate:()=>{const i={};for(const o of this.connections.values())for(const a of o){const c={};for(const u of a.streams){const d=`${u.direction} ${u.protocol??"unnegotiated"}`;c[d]=(c[d]??0)+1}for(const[u,d]of Object.entries(c))i[u]=i[u]??[],i[u].push(d)}const s={};for(let[o,a]of Object.entries(i)){a=a.sort((u,d)=>u-d);const c=Math.floor(a.length*.9);s[o]=a[c]}return s}}),this.events.addEventListener("connection:open",this.onConnect),this.events.addEventListener("connection:close",this.onDisconnect),await li(this.dialQueue,this.reconnectQueue,this.connectionPruner),this.started=!0,this.log("started")}async stop(){this.events.removeEventListener("connection:open",this.onConnect),this.events.removeEventListener("connection:close",this.onDisconnect),await rs(this.reconnectQueue,this.dialQueue,this.connectionPruner);const e=[];for(const t of this.connections.values())for(const r of t)e.push((async()=>{try{await r.close()}catch(i){this.log.error(i)}})());this.log("closing %d connections",e.length),await Promise.all(e),this.connections.clear(),this.log("stopped")}getMaxConnections(){return this.maxConnections}setMaxConnections(e){if(this.maxConnections<1)throw new O("Connection Manager maxConnections must be greater than 0");let t=!1;e<this.maxConnections&&(t=!0),this.maxConnections=e,t&&this.connectionPruner.maybePruneConnections()}onConnect(e){this._onConnect(e).catch(t=>{this.log.error(t)})}async _onConnect(e){const{detail:t}=e;if(!this.started){await t.close();return}if(t.status!=="open")return;const r=t.remotePeer,i=!this.connections.has(r),s=this.connections.get(r)??[];s.push(t),this.connections.set(r,s),r.publicKey!=null&&r.type==="RSA"&&await this.peerStore.patch(r,{publicKey:r.publicKey}),i&&this.events.safeDispatchEvent("peer:connect",{detail:t.remotePeer})}onDisconnect(e){const{detail:t}=e,r=t.remotePeer,s=(this.connections.get(r)??[]).filter(o=>o.id!==t.id);this.connections.set(r,s),s.length===0&&(this.log.trace("peer %p disconnected, removing connection map entry",r),this.connections.delete(r),this.events.safeDispatchEvent("peer:disconnect",{detail:t.remotePeer}))}getConnections(e){if(e!=null)return this.connections.get(e)??[];let t=[];for(const r of this.connections.values())t=t.concat(r);return t}getConnectionsMap(){return this.connections}async openConnection(e,t={}){var r,i;if(!this.started)throw new Rs("Not started");this.outboundPendingConnections++;try{(r=t.signal)==null||r.throwIfAborted();const{peerId:s}=I9(e);if(this.peerId.equals(s))throw new Vp("Can not dial self");if(s!=null&&t.force!==!0){this.log("dial %p",s);const u=this.getConnections(s).find(d=>d.limits==null);if(u!=null)return this.log("had an existing non-limited connection to %p as %a",s,u.remoteAddr),(i=t.onProgress)==null||i.call(t,new N("dial-queue:already-connected")),u}const o=await this.dialQueue.dial(e,{...t,priority:t.priority??D9});if(o.status!=="open")throw new Hp("Remote closed connection during opening");let a=this.connections.get(o.remotePeer);a==null&&(a=[],this.connections.set(o.remotePeer,a));let c=!1;for(const u of a)if(u.id===o.id&&(c=!0),t.force!==!0&&u.id!==o.id&&u.remoteAddr.equals(o.remoteAddr))return o.abort(new vh("Duplicate multiaddr connection")),u;return c||a.push(o),o}finally{this.outboundPendingConnections--}}async closeConnections(e,t={}){const r=this.connections.get(e)??[];await Promise.all(r.map(async i=>{try{await i.close(t)}catch(s){i.abort(s)}}))}async acceptIncomingConnection(e){if(this.deny.some(i=>i.contains(e.remoteAddr.nodeAddress().address)))return this.log("connection from %a refused - connection remote address was in deny list",e.remoteAddr),!1;if(this.allow.some(i=>i.contains(e.remoteAddr.nodeAddress().address)))return this.incomingPendingConnections++,!0;if(this.incomingPendingConnections===this.maxIncomingPendingConnections)return this.log("connection from %a refused - incomingPendingConnections exceeded by host",e.remoteAddr),!1;if(e.remoteAddr.isThinWaistAddress()){const i=e.remoteAddr.nodeAddress().address;try{await this.inboundConnectionRateLimiter.consume(i,1)}catch{return this.log("connection from %a refused - inboundConnectionThreshold exceeded by host %s",e.remoteAddr,i),!1}}return this.getConnections().length<this.maxConnections?(this.incomingPendingConnections++,!0):(this.log("connection from %a refused - maxConnections exceeded",e.remoteAddr),!1)}afterUpgradeInbound(){this.incomingPendingConnections--}getDialQueue(){const e={queued:"queued",running:"active",errored:"error",complete:"success"};return this.dialQueue.queue.queue.map(t=>({id:t.id,status:e[t.status],peerId:t.options.peerId,multiaddrs:[...t.options.multiaddrs].map(r=>fe(r))}))}async isDialable(e,t={}){return this.dialQueue.isDialable(e,t)}}class cf{constructor(e){l(this,"movingAverage");l(this,"variance");l(this,"deviation");l(this,"forecast");l(this,"timeSpan");l(this,"previousTime");this.timeSpan=e,this.movingAverage=0,this.variance=0,this.deviation=0,this.forecast=0}alpha(e,t){return 1-Math.exp(-(e-t)/this.timeSpan)}push(e,t=Date.now()){if(this.previousTime!=null){const r=this.alpha(t,this.previousTime),i=e-this.movingAverage,s=r*i;this.movingAverage=r*e+(1-r)*this.movingAverage,this.variance=(1-r)*(this.variance+i*s),this.deviation=Math.sqrt(this.variance),this.forecast=this.movingAverage+r*i}else this.movingAverage=e;this.previousTime=t}}const ET=1.2,xT=2,AT=5e3,kT=6e4,_T=5e3;class Nc{constructor(e={}){l(this,"success");l(this,"failure");l(this,"next");l(this,"metric");l(this,"timeoutMultiplier");l(this,"failureMultiplier");l(this,"minTimeout");l(this,"maxTimeout");var r;const t=e.interval??_T;this.success=new cf(t),this.failure=new cf(t),this.next=new cf(t),this.failureMultiplier=e.failureMultiplier??xT,this.timeoutMultiplier=e.timeoutMultiplier??ET,this.minTimeout=e.minTimeout??AT,this.maxTimeout=e.maxTimeout??kT,e.metricName!=null&&(this.metric=(r=e.metrics)==null?void 0:r.registerMetricGroup(e.metricName))}getTimeoutSignal(e={}){let t=Math.round(this.next.movingAverage*(e.timeoutFactor??this.timeoutMultiplier));t<this.minTimeout&&(t=this.minTimeout),t>this.maxTimeout&&(t=this.maxTimeout);const r=AbortSignal.timeout(t),i=Le([e.signal,r]);return i.start=Date.now(),i.timeout=t,i}cleanUp(e){var r,i;const t=Date.now()-e.start;e.aborted?(this.failure.push(t),this.next.push(t*this.failureMultiplier),(r=this.metric)==null||r.update({failureMovingAverage:this.failure.movingAverage,failureDeviation:this.failure.deviation,failureForecast:this.failure.forecast,failureVariance:this.failure.variance,failure:t})):(this.success.push(t),this.next.push(t),(i=this.metric)==null||i.update({successMovingAverage:this.success.movingAverage,successDeviation:this.success.deviation,successForecast:this.success.forecast,successVariance:this.success.variance,success:t}))}}class IT extends Error{constructor(){super(...arguments);l(this,"name","UnexpectedEOFError");l(this,"code","ERR_UNEXPECTED_EOF")}}function ud(n,e){const t=w8();n.sink(t).catch(async o=>{await t.end(o)}),n.sink=async o=>{for await(const a of o)await t.push(a);await t.end()};let r=n.source;n.source[Symbol.iterator]!=null?r=n.source[Symbol.iterator]():n.source[Symbol.asyncIterator]!=null&&(r=n.source[Symbol.asyncIterator]());const i=new Ee;return{read:async o=>{var c;if((c=o==null?void 0:o.signal)==null||c.throwIfAborted(),(o==null?void 0:o.bytes)==null){const{done:u,value:d}=await yt(r.next(),o==null?void 0:o.signal);return u===!0?null:d}for(;i.byteLength<o.bytes;){const{value:u,done:d}=await yt(r.next(),o==null?void 0:o.signal);if(d===!0)throw new IT("unexpected end of input");i.append(u)}const a=i.sublist(0,o.bytes);return i.consume(o.bytes),a},write:async(o,a)=>{var c;(c=a==null?void 0:a.signal)==null||c.throwIfAborted(),o instanceof Uint8Array?await t.push(o,a):await t.push(o.subarray(),a)},unwrap:()=>{if(i.byteLength>0){const o=n.source;n.source=async function*(){(e==null?void 0:e.yieldBytes)===!1?yield i:yield*i,yield*o}()}return n}}}const CT=1e4,TT="1.0.0",RT="ping",PT="ipfs",Vm=32,OT=!0;var Y5,X5;X5=Symbol.toStringTag,Y5=kt;class DT{constructor(e,t={}){l(this,"protocol");l(this,"components");l(this,"log");l(this,"heartbeatInterval");l(this,"pingIntervalMs");l(this,"abortController");l(this,"timeout");l(this,"abortConnectionOnPingFailure");l(this,X5,"@libp2p/connection-monitor");l(this,Y5,["@libp2p/connection-monitor"]);this.components=e,this.protocol=`/${t.protocolPrefix??PT}/${RT}/${TT}`,this.log=e.logger.forComponent("libp2p:connection-monitor"),this.pingIntervalMs=t.pingInterval??CT,this.abortConnectionOnPingFailure=t.abortConnectionOnPingFailure??OT,this.timeout=new Nc({...t.pingTimeout??{},metrics:e.metrics,metricName:"libp2p_connection_monitor_ping_time_milliseconds"})}start(){this.abortController=new AbortController,this.abortController.signal,this.heartbeatInterval=setInterval(()=>{this.components.connectionManager.getConnections().forEach(e=>{Promise.resolve().then(async()=>{var r;let t=Date.now();try{const i=this.timeout.getTimeoutSignal({signal:(r=this.abortController)==null?void 0:r.signal}),s=await e.newStream(this.protocol,{signal:i,runOnLimitedConnection:!0}),o=ud(s);t=Date.now(),await Promise.all([o.write(Os(Vm),{signal:i}),o.read({bytes:Vm,signal:i})]),e.rtt=Date.now()-t,await o.unwrap().close({signal:i})}catch(i){if(i.name!=="UnsupportedProtocolError")throw i;e.rtt=(Date.now()-t)/2}}).catch(t=>{this.log.error("error during heartbeat",t),this.abortConnectionOnPingFailure?(this.log.error("aborting connection due to ping failure"),e.abort(t)):this.log("connection ping failed, but not aborting due to abortConnectionOnPingFailure flag")})})},this.pingIntervalMs)}stop(){var e;(e=this.abortController)==null||e.abort(),this.heartbeatInterval!=null&&clearInterval(this.heartbeatInterval)}}var Z5;Z5=Symbol.toStringTag;class NT{constructor(e,t){l(this,"routers");l(this,"started");l(this,"components");l(this,Z5,"@libp2p/content-routing");var r,i,s,o,a;this.routers=t.routers??[],this.started=!1,this.components=e,this.findProviders=((r=e.metrics)==null?void 0:r.traceFunction("libp2p.contentRouting.findProviders",this.findProviders.bind(this),{optionsIndex:1,getAttributesFromArgs:([c],u)=>({...u,cid:c.toString()}),getAttributesFromYieldedValue:(c,u)=>({...u,providers:[...Array.isArray(u.providers)?u.providers:[],c.id.toString()]})}))??this.findProviders,this.provide=((i=e.metrics)==null?void 0:i.traceFunction("libp2p.contentRouting.provide",this.provide.bind(this),{optionsIndex:1,getAttributesFromArgs:([c],u)=>({...u,cid:c.toString()})}))??this.provide,this.cancelReprovide=((s=e.metrics)==null?void 0:s.traceFunction("libp2p.contentRouting.cancelReprovide",this.cancelReprovide.bind(this),{optionsIndex:1,getAttributesFromArgs:([c],u)=>({...u,cid:c.toString()})}))??this.cancelReprovide,this.put=((o=e.metrics)==null?void 0:o.traceFunction("libp2p.contentRouting.put",this.put.bind(this),{optionsIndex:2,getAttributesFromArgs:([c])=>({key:U(c,"base36")})}))??this.put,this.get=((a=e.metrics)==null?void 0:a.traceFunction("libp2p.contentRouting.get",this.get.bind(this),{optionsIndex:1,getAttributesFromArgs:([c])=>({key:U(c,"base36")})}))??this.get}isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1}async*findProviders(e,t={}){if(this.routers.length===0)throw new of("No content routers available");const r=this,i=new xn;for await(const s of $i(...r.routers.filter(o=>o.findProviders instanceof Function).map(o=>o.findProviders(e,t))))s!=null&&(s.multiaddrs.length>0&&await this.components.peerStore.merge(s.id,{multiaddrs:s.multiaddrs},t),!i.has(s.id)&&(i.add(s.id),yield s))}async provide(e,t={}){if(this.routers.length===0)throw new of("No content routers available");await Promise.all(this.routers.filter(r=>r.provide instanceof Function).map(async r=>{await r.provide(e,t)}))}async cancelReprovide(e,t={}){if(this.routers.length===0)throw new of("No content routers available");await Promise.all(this.routers.filter(r=>r.cancelReprovide instanceof Function).map(async r=>{await r.cancelReprovide(e,t)}))}async put(e,t,r){if(!this.isStarted())throw new Rs;await Promise.all(this.routers.filter(i=>i.put instanceof Function).map(async i=>{await i.put(e,t,r)}))}async get(e,t){if(!this.isStarted())throw new Rs;return Promise.any(this.routers.filter(r=>r.get instanceof Function).map(async r=>r.get(e,t)))}}const Yl=globalThis.CustomEvent??Event;async function*Cn(n,e={}){let t=e.concurrency??1/0;t<1&&(t=1/0);const r=e.ordered??!1,i=new EventTarget,s=[];let o=ve(),a=ve(),c=!1,u,d=!1;i.addEventListener("task-complete",()=>{a.resolve()}),Promise.resolve().then(async()=>{try{for await(const m of n){if(s.length===t&&(o=ve(),await o.promise),d)break;const w={done:!1};s.push(w),m().then(b=>{w.done=!0,w.ok=!0,w.value=b,i.dispatchEvent(new Yl("task-complete"))},b=>{w.done=!0,w.err=b,i.dispatchEvent(new Yl("task-complete"))})}c=!0,i.dispatchEvent(new Yl("task-complete"))}catch(m){u=m,i.dispatchEvent(new Yl("task-complete"))}});function h(){var m;return r?(m=s[0])==null?void 0:m.done:!!s.find(w=>w.done)}function*f(){for(;s.length>0&&s[0].done;){const m=s[0];if(s.shift(),m.ok)yield m.value;else throw d=!0,o.resolve(),m.err;o.resolve()}}function*p(){for(;h();)for(let m=0;m<s.length;m++)if(s[m].done){const w=s[m];if(s.splice(m,1),m--,w.ok)yield w.value;else throw d=!0,o.resolve(),w.err;o.resolve()}}for(;;){if(h()||(a=ve(),await a.promise),u!=null||(r?yield*f():yield*p(),u!=null))throw u;if(c&&s.length===0)break}}var J5;J5=Symbol.toStringTag;class LT{constructor(e,t={}){l(this,"log");l(this,"peerId");l(this,"peerStore");l(this,"routers");l(this,J5,"@libp2p/peer-routing");var r,i;this.log=e.logger.forComponent("libp2p:peer-routing"),this.peerId=e.peerId,this.peerStore=e.peerStore,this.routers=t.routers??[],this.findPeer=((r=e.metrics)==null?void 0:r.traceFunction("libp2p.peerRouting.findPeer",this.findPeer.bind(this),{optionsIndex:1,getAttributesFromArgs:([s],o)=>({...o,peer:s.toString()})}))??this.findPeer,this.getClosestPeers=((i=e.metrics)==null?void 0:i.traceFunction("libp2p.peerRouting.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1,getAttributesFromArgs:([s],o)=>({...o,key:U(s,"base36")}),getAttributesFromYieldedValue:(s,o)=>({...o,peers:[...Array.isArray(o.peers)?o.peers:[],s.id.toString()]})}))??this.getClosestPeers}async findPeer(e,t){if(this.routers.length===0)throw new Bm("No peer routers available");if(e.toString()===this.peerId.toString())throw new AC("Should not try to find self");const r=this,i=$i(...this.routers.filter(s=>s.findPeer instanceof Function).map(s=>async function*(){try{yield await s.findPeer(e,t)}catch(o){r.log.error(o)}}()));for await(const s of i)if(s!=null)return s.multiaddrs.length>0&&await this.peerStore.merge(s.id,{multiaddrs:s.multiaddrs},t),s;throw new tr}async*getClosestPeers(e,t={}){if(this.routers.length===0)throw new Bm("No peer routers available");const r=this,i=Qi(1024);for await(const s of Cn(async function*(){const o=$i(...r.routers.filter(a=>a.getClosestPeers instanceof Function).map(a=>a.getClosestPeers(e,t)));for await(let a of o)yield async()=>{if(a.multiaddrs.length===0)try{a=await r.findPeer(a.id,{...t,useCache:!1})}catch(c){r.log.error("could not find peer multiaddrs",c);return}return a}}()))s!=null&&(s.multiaddrs.length>0&&await this.peerStore.merge(s.id,{multiaddrs:s.multiaddrs},t),!i.has(s.id.toMultihash().bytes)&&(i.add(s.id.toMultihash().bytes),yield s))}}var e6,t6;class BT extends(t6=ot,e6=Symbol.toStringTag,t6){constructor(t){super();l(this,"peerRouting");l(this,"log");l(this,"walking");l(this,"walkers");l(this,"shutdownController");l(this,"walkController");l(this,"needNext");l(this,e6,"@libp2p/random-walk");this.log=t.logger.forComponent("libp2p:random-walk"),this.peerRouting=t.peerRouting,this.walkers=0,this.walking=!1,this.shutdownController=new AbortController,this.shutdownController.signal}start(){this.shutdownController=new AbortController,this.shutdownController.signal}stop(){this.shutdownController.abort()}async*walk(t){var i,s;this.walking||this.startWalk(),this.walkers++;const r=Le([this.shutdownController.signal,t==null?void 0:t.signal]);try{for(;;)(i=this.needNext)==null||i.resolve(),this.needNext=ve(),yield(await Vt(this,"walk:peer",r,{errorEvent:"walk:error"})).detail}finally{r.clear(),this.walkers--,this.walkers===0&&((s=this.walkController)==null||s.abort(),this.walkController=void 0)}}startWalk(){this.walking=!0,this.walkController=new AbortController,this.walkController.signal;const t=Le([this.walkController.signal,this.shutdownController.signal]),r=Date.now();let i=0;Promise.resolve().then(async()=>{for(this.log("start walk");this.walkers>0;)try{const s=Os(32);let o=Date.now();for await(const a of this.peerRouting.getClosestPeers(s,{signal:t}))t.aborted&&this.log("aborting walk"),t.throwIfAborted(),this.log("found peer %p after %dms for %d walkers",a.id,Date.now()-o,this.walkers),i++,this.safeDispatchEvent("walk:peer",{detail:a}),this.walkers===1&&this.needNext!=null&&(this.log("wait for need next"),await yt(this.needNext.promise,t)),o=Date.now();this.log("walk iteration for %b and %d walkers finished, found %d peers",s,this.walkers,i)}catch(s){this.log.error("random walk errored",s),this.safeDispatchEvent("walk:error",{detail:s})}this.log("no walkers left, ended walk")}).catch(s=>{this.log.error("random walk errored",s)}).finally(()=>{this.log("finished walk, found %d peers after %dms",i,Date.now()-r),this.walking=!1})}}const N9=32,L9=64;var r6;r6=Symbol.toStringTag;class MT{constructor(e){l(this,"log");l(this,"topologies");l(this,"handlers");l(this,"components");l(this,r6,"@libp2p/registrar");var t;this.components=e,this.log=e.logger.forComponent("libp2p:registrar"),this.topologies=new Map,(t=e.metrics)==null||t.registerMetricGroup("libp2p_registrar_topologies",{calculate:()=>{const r={};for(const[i,s]of this.topologies)r[i]=s.size;return r}}),this.handlers=an({name:"libp2p_registrar_protocol_handlers",metrics:e.metrics}),this._onDisconnect=this._onDisconnect.bind(this),this._onPeerUpdate=this._onPeerUpdate.bind(this),this._onPeerIdentify=this._onPeerIdentify.bind(this),this.components.events.addEventListener("peer:disconnect",this._onDisconnect),this.components.events.addEventListener("peer:update",this._onPeerUpdate),this.components.events.addEventListener("peer:identify",this._onPeerIdentify)}getProtocols(){return Array.from(new Set([...this.handlers.keys()])).sort()}getHandler(e){const t=this.handlers.get(e);if(t==null)throw new kC(`No handler registered for protocol ${e}`);return t}getTopologies(e){const t=this.topologies.get(e);return t==null?[]:[...t.values()]}async handle(e,t,r){if(this.handlers.has(e)&&(r==null?void 0:r.force)!==!0)throw new _C(`Handler already registered for protocol ${e}`);const i=un.bind({ignoreUndefined:!0})({maxInboundStreams:N9,maxOutboundStreams:L9},r);this.handlers.set(e,{handler:t,options:i}),await this.components.peerStore.merge(this.components.peerId,{protocols:[e]},r)}async unhandle(e,t){(Array.isArray(e)?e:[e]).forEach(i=>{this.handlers.delete(i)}),await this.components.peerStore.patch(this.components.peerId,{protocols:this.getProtocols()},t)}async register(e,t){if(t==null)throw new O("invalid topology");const r=`${(Math.random()*1e9).toString(36)}${Date.now()}`;let i=this.topologies.get(e);return i==null&&(i=new Map,this.topologies.set(e,i)),i.set(r,t),r}unregister(e){for(const[t,r]of this.topologies.entries())r.has(e)&&(r.delete(e),r.size===0&&this.topologies.delete(t))}_onDisconnect(e){const t=e.detail,r={signal:AbortSignal.timeout(5e3)};this.components.peerStore.get(t,r).then(i=>{var s,o,a;for(const c of i.protocols){const u=this.topologies.get(c);if(u!=null)for(const d of u.values())((s=d.filter)==null?void 0:s.has(t))!==!1&&((o=d.filter)==null||o.remove(t),(a=d.onDisconnect)==null||a.call(d,t))}}).catch(i=>{i.name!=="NotFoundError"&&this.log.error("could not inform topologies of disconnecting peer %p",t,i)})}_onPeerUpdate(e){var s,o,a;const{peer:t,previous:r}=e.detail,i=((r==null?void 0:r.protocols)??[]).filter(c=>!t.protocols.includes(c));for(const c of i){const u=this.topologies.get(c);if(u!=null)for(const d of u.values())((s=d.filter)==null?void 0:s.has(t.id))!==!1&&((o=d.filter)==null||o.remove(t.id),(a=d.onDisconnect)==null||a.call(d,t.id))}}_onPeerIdentify(e){var s,o,a;const t=e.detail.protocols,r=e.detail.connection,i=e.detail.peerId;for(const c of t){const u=this.topologies.get(c);if(u!=null)for(const d of u.values())r.limits!=null&&d.notifyOnLimitedConnection!==!0||((s=d.filter)==null?void 0:s.has(i))!==!0&&((o=d.filter)==null||o.add(i),(a=d.onConnect)==null||a.call(d,i,r))}}}var n6;n6=Symbol.toStringTag;class UT{constructor(e,t={}){l(this,"log");l(this,"components");l(this,"transports");l(this,"listeners");l(this,"faultTolerance");l(this,"started");l(this,n6,"@libp2p/transport-manager");this.log=e.logger.forComponent("libp2p:transports"),this.components=e,this.started=!1,this.transports=an({name:"libp2p_transport_manager_transports",metrics:this.components.metrics}),this.listeners=an({name:"libp2p_transport_manager_listeners",metrics:this.components.metrics}),this.faultTolerance=t.faultTolerance??Sc.FATAL_ALL}add(e){const t=e[Symbol.toStringTag];if(t==null)throw new O("Transport must have a valid tag");if(this.transports.has(t))throw new O(`There is already a transport with the tag ${t}`);this.log("adding transport %s",t),this.transports.set(t,e),this.listeners.has(t)||this.listeners.set(t,[])}isStarted(){return this.started}start(){this.started=!0}async afterStart(){const e=this.components.addressManager.getListenAddrs();await this.listen(e)}async stop(){const e=[];for(const[t,r]of this.listeners)for(this.log("closing listeners for %s",t);r.length>0;){const i=r.pop();i!=null&&e.push(i.close())}await Promise.all(e),this.log("all listeners closed");for(const t of this.listeners.keys())this.listeners.set(t,[]);this.started=!1}async dial(e,t){var i;const r=this.dialTransportForMultiaddr(e);if(r==null)throw new OC(`No transport available for address ${String(e)}`);return(i=t==null?void 0:t.onProgress)==null||i.call(t,new N("transport-manager:selected-transport",r[Symbol.toStringTag])),r.dial(e,{...t,upgrader:this.components.upgrader})}getAddrs(){let e=[];for(const t of this.listeners.values())for(const r of t)e=[...e,...r.getAddrs()];return e}getTransports(){return Array.of(...this.transports.values())}getListeners(){return Array.of(...this.listeners.values()).flat()}dialTransportForMultiaddr(e){for(const t of this.transports.values())if(t.dialFilter([e]).length>0)return t}listenTransportForMultiaddr(e){for(const t of this.transports.values())if(t.listenFilter([e]).length>0)return t}async listen(e){if(!this.isStarted())throw new Rs("Not started");if(e==null||e.length===0){this.log("no addresses were provided for listening, this node is dial only");return}const t={errors:new Map,ipv4:{success:0,attempts:0},ipv6:{success:0,attempts:0}};e.forEach(s=>{t.errors.set(s.toString(),new IC)});const r=[];for(const[s,o]of this.transports.entries()){const a=o.listenFilter(e);for(const c of a){this.log("creating listener for %s on %a",s,c);const u=o.createListener({upgrader:this.components.upgrader});let d=this.listeners.get(s)??[];d==null&&(d=[],this.listeners.set(s,d)),d.push(u),u.addEventListener("listening",()=>{this.components.events.safeDispatchEvent("transport:listening",{detail:u})}),u.addEventListener("close",()=>{const h=d.findIndex(f=>f===u);d.splice(h,1),this.components.events.safeDispatchEvent("transport:close",{detail:u})}),gm.matches(c)?t.ipv4.attempts++:mm.matches(c)&&t.ipv6.attempts++,r.push(u.listen(c).then(()=>{t.errors.delete(c.toString()),gm.matches(c)&&t.ipv4.success++,mm.matches(c)&&t.ipv6.success++},h=>{throw this.log.error("transport %s could not listen on address %a - %e",s,c,h),t.errors.set(c.toString(),h),h}))}}const i=await Promise.allSettled(r);if(!(i.length>0&&i.every(s=>s.status==="fulfilled"))){if(this.ipv6Unsupported(t)){this.log("all IPv4 addresses succeed but all IPv6 failed");return}if(this.faultTolerance===Sc.NO_FATAL){this.log("failed to listen on any address but fault tolerance allows this");return}throw new CC(`Some configured addresses failed to be listened on, you may need to remove one or more listen addresses from your configuration or set \`transportManager.faultTolerance\` to NO_FATAL:
${[...t.errors.entries()].map(([s,o])=>`
  ${s}: ${`${o.stack??o}`.split(`
`).join(`
  `)}
`).join("")}`)}}ipv6Unsupported(e){if(e.ipv4.attempts===0||e.ipv6.attempts===0)return!1;const t=e.ipv4.attempts===e.ipv4.success,r=e.ipv6.success===0;return t&&r}async remove(e){const t=this.listeners.get(e)??[];this.log.trace("removing transport %s",e);const r=[];for(this.log.trace("closing listeners for %s",e);t.length>0;){const i=t.pop();i!=null&&r.push(i.close())}await Promise.all(r),this.transports.delete(e),this.listeners.delete(e)}async removeAll(){const e=[];for(const t of this.transports.keys())e.push(this.remove(t));await Promise.all(e)}}const Zt="/multistream/1.0.0",ug=1024;class FT extends Error{constructor(){super(...arguments);l(this,"name","InvalidMessageLengthError");l(this,"code","ERR_INVALID_MSG_LENGTH")}}class $T extends Error{constructor(){super(...arguments);l(this,"name","InvalidDataLengthError");l(this,"code","ERR_MSG_DATA_TOO_LONG")}}class HT extends Error{constructor(){super(...arguments);l(this,"name","InvalidDataLengthLengthError");l(this,"code","ERR_MSG_LENGTH_TOO_LONG")}}function Qo(n,e={}){const t=ud(n,e);e.maxDataLength!=null&&e.maxLengthLength==null&&(e.maxLengthLength=Ht(e.maxDataLength));const r=(e==null?void 0:e.lengthDecoder)??fh,i=(e==null?void 0:e.lengthEncoder)??Jr;return{read:async o=>{let a=-1;const c=new Ee;for(;;){c.append(await t.read({...o,bytes:1}));try{a=r(c)}catch(u){if(u instanceof RangeError)continue;throw u}if(a<0)throw new FT("Invalid message length");if((e==null?void 0:e.maxLengthLength)!=null&&c.byteLength>e.maxLengthLength)throw new HT("message length length too long");if(a>-1)break}if((e==null?void 0:e.maxDataLength)!=null&&a>e.maxDataLength)throw new $T("message length too long");return t.read({...o,bytes:a})},write:async(o,a)=>{await t.write(new Ee(i(o.byteLength),o),a)},writeV:async(o,a)=>{const c=new Ee(...o.flatMap(u=>[i(u.byteLength),u]));await t.write(c,a)},unwrap:()=>t.unwrap()}}const VT=R(`
`);async function Ya(n,e,t){await n.write(e,t)}async function zT(n,e,t){await n.writeV(e,t)}async function KT(n,e){const t=await n.read(e);if(t.byteLength===0||t.get(t.byteLength-1)!==VT[0])throw e.log.error("Invalid mss message - missing newline",t),new qe("Missing newline");return t.sublist(0,-1)}async function Oo(n,e){const t=await KT(n,e);return U(t.subarray())}async function b0(n,e,t){if(e=Array.isArray(e)?[...e]:[e],e.length===1&&t.negotiateFully===!1)return qT(n,e[0],t);const r=Qo(n,{...t,maxDataLength:ug}),i=e.shift();if(i==null)throw new Error("At least one protocol must be specified");t.log.trace('select: write ["%s", "%s"]',Zt,i);const s=R(`${Zt}
`),o=R(`${i}
`);await zT(r,[s,o],t),t.log.trace("select: reading multistream-select header");let a=await Oo(r,t);if(t.log.trace('select: read "%s"',a),a===Zt&&(t.log.trace("select: reading protocol response"),a=await Oo(r,t),t.log.trace('select: read "%s"',a)),a===i)return{stream:r.unwrap(),protocol:i};for(const c of e){t.log.trace('select: write "%s"',c),await Ya(r,R(`${c}
`),t),t.log.trace("select: reading protocol response");const u=await Oo(r,t);if(t.log.trace('select: read "%s" for "%s"',u,c),u===c)return{stream:r.unwrap(),protocol:c}}throw new cl("protocol selection failed")}function qT(n,e,t){const r=n.sink.bind(n),i=n.source;let s=!1,o=!1;const a=ve();let c=!1,u=!1;const d=ve();let h=!1,f=!1;const p=ve(),m=Qo({sink:r,source:i},{...t,maxDataLength:ug});n.sink=async k=>{const{sink:C}=m.unwrap();await C(async function*(){let Q=!1;for await(const re of k){if(u&&await d.promise,c)yield re;else{u=!0,t.log.trace('optimistic: write ["%s", "%s", data(%d)] in sink',Zt,e,re.byteLength);const T=`${e}
`;yield new Ee(Uint8Array.from([19]),R(`${Zt}
`),Jr(T.length),R(T),re).subarray(),t.log.trace('optimistic: wrote ["%s", "%s", data(%d)] in sink',Zt,e,re.byteLength),c=!0,u=!1,d.resolve(),w().catch(Y=>{t.log.error("could not finish optimistic protocol negotiation of %s",e,Y)})}Q=!0}Q||await w()}())};async function w(){if(o){t.log.trace("optimistic: already negotiating %s stream",e),await a.promise;return}o=!0;try{c||(t.log.trace("optimistic: doing send protocol for %s stream",e),await b()),h||(t.log.trace("optimistic: doing read protocol for %s stream",e),await S())}finally{o=!1,s=!0,a.resolve()}}async function b(){if(u){await d.promise;return}u=!0;try{t.log.trace('optimistic: write ["%s", "%s", data] in source',Zt,e),await m.writeV([R(`${Zt}
`),R(`${e}
`)]),t.log.trace('optimistic: wrote ["%s", "%s", data] in source',Zt,e)}finally{c=!0,u=!1,d.resolve()}}async function S(){if(f){await p.promise;return}f=!0;try{t.log.trace("optimistic: reading multistream select header");let k=await Oo(m,t);if(t.log.trace('optimistic: read multistream select header "%s"',k),k===Zt&&(k=await Oo(m,t)),t.log.trace('optimistic: read protocol "%s", expecting "%s"',k,e),k!==e)throw new cl("protocol selection failed")}finally{h=!0,f=!1,p.resolve()}}if(n.source=async function*(){await w(),t.log.trace('optimistic: reading data from "%s" stream',e),yield*m.unwrap().source}(),n.closeRead!=null){const k=n.closeRead.bind(n);n.closeRead=async C=>{s||await w().catch(Q=>{t.log.error("could not negotiate protocol before close read",Q)}),await k(C)}}if(n.closeWrite!=null){const k=n.closeWrite.bind(n);n.closeWrite=async C=>{s||await w().catch(Q=>{t.log.error("could not negotiate protocol before close write",Q)}),await k(C)}}if(n.close!=null){const k=n.close.bind(n);n.close=async C=>{const Q=[];u&&Q.push(d.promise),f&&Q.push(p.promise),Q.length>0?await yt(Promise.all(Q),C==null?void 0:C.signal):(s=!0,o=!1,a.resolve()),await k(C)}}return{stream:n,protocol:e}}async function v0(n,e,t){e=Array.isArray(e)?e:[e],t.log.trace("handle: available protocols %s",e);const r=Qo(n,{...t,maxDataLength:ug,maxLengthLength:2});for(;;){t.log.trace("handle: reading incoming string");const i=await Oo(r,t);if(t.log.trace('handle: read "%s"',i),i===Zt){t.log.trace('handle: respond with "%s" for "%s"',Zt,i),await Ya(r,R(`${Zt}
`),t),t.log.trace('handle: responded with "%s" for "%s"',Zt,i);continue}if(e.includes(i))return t.log.trace('handle: respond with "%s" for "%s"',i,i),await Ya(r,R(`${i}
`),t),t.log.trace('handle: responded with "%s" for "%s"',i,i),{stream:r.unwrap(),protocol:i};if(i==="ls"){const s=new Ee(...e.map(o=>Ac.single(R(`${o}
`))),R(`
`));t.log.trace('handle: respond with "%s" for %s',e,i),await Ya(r,s,t),t.log.trace('handle: responded with "%s" for %s',e,i);continue}t.log.trace('handle: respond with "na" for "%s"',i),await Ya(r,R(`na
`),t),t.log('handle: responded with "na" for "%s"',i)}}const WT=500;var i6,s6;s6=Symbol.toStringTag,i6=UE;class GT{constructor(e,t){l(this,"id");l(this,"remoteAddr");l(this,"remotePeer");l(this,"direction");l(this,"timeline");l(this,"multiplexer");l(this,"encryption");l(this,"status");l(this,"limits");l(this,"log");l(this,"tags");l(this,"maConn");l(this,"muxer");l(this,"components");l(this,"outboundStreamProtocolNegotiationTimeout");l(this,"inboundStreamProtocolNegotiationTimeout");l(this,s6,"Connection");l(this,i6,!0);l(this,"newStream",async(e,t={})=>{var i;if(this.status==="closing")throw new l8("the connection is being closed");if(this.status==="closed")throw new Hp("the connection is closed");if(Array.isArray(e)||(e=[e]),this.limits!=null&&(t==null?void 0:t.runOnLimitedConnection)!==!0)throw new Jf("Cannot open protocol stream on limited connection");if(this.muxer==null)throw new y0("Connection is not multiplexed");this.log.trace("starting new stream for protocols %s",e);const r=await this.muxer.newStream();this.log.trace("started new stream %s for protocols %s",r.id,e);try{if(t.signal==null){r.log("no abort signal was passed while trying to negotiate protocols %s falling back to default timeout",e);const u=AbortSignal.timeout(this.outboundStreamProtocolNegotiationTimeout);t={...t,signal:u}}r.log.trace("selecting protocol from protocols %s",e);const{stream:s,protocol:o}=await b0(r,e,{...t,log:r.log,yieldBytes:!0});r.log("selected protocol %s",o);const a=YT(o,this.components.registrar,t),c=zm(o,"outbound",this);if(c>=a){const u=new Eh(`Too many outbound protocol streams for protocol "${o}" - ${c}/${a}`);throw r.abort(u),u}return await this.components.peerStore.merge(this.remotePeer,{protocols:[o]}),r.source=s.source,r.sink=s.sink,r.protocol=o,s.closeWrite!=null&&(r.closeWrite=s.closeWrite),s.closeRead!=null&&(r.closeRead=s.closeRead),s.close!=null&&(r.close=s.close),(i=this.components.metrics)==null||i.trackProtocolStream(r,this),r.direction="outbound",r}catch(s){throw this.log.error("could not create new outbound stream on connection %s %a for protocols %s - %e",this.direction==="inbound"?"from":"to",this.remoteAddr,e,s),r.timeline.close==null&&r.abort(s),s}});this.components=e,this.id=t.id,this.remoteAddr=t.maConn.remoteAddr,this.remotePeer=t.remotePeer,this.direction=t.direction??"outbound",this.status="open",this.timeline=t.maConn.timeline,this.encryption=t.encryption,this.limits=t.limits,this.maConn=t.maConn,this.log=t.maConn.log,this.outboundStreamProtocolNegotiationTimeout=t.outboundStreamProtocolNegotiationTimeout??ld,this.inboundStreamProtocolNegotiationTimeout=t.inboundStreamProtocolNegotiationTimeout??ld,this.remoteAddr.getPeerId()==null&&(this.remoteAddr=this.remoteAddr.encapsulate(`/p2p/${this.remotePeer}`)),this.tags=[],t.muxerFactory!=null&&(this.multiplexer=t.muxerFactory.protocol,this.muxer=t.muxerFactory.createStreamMuxer({direction:this.direction,log:this.log,onIncomingStream:r=>{this.onIncomingStream(r)}}),Promise.all([this.muxer.sink(this.maConn.source),this.maConn.sink(this.muxer.source)]).catch(r=>{this.log.error("error piping data through muxer - %e",r)}))}get streams(){var e;return((e=this.muxer)==null?void 0:e.streams)??[]}onIncomingStream(e){const t=AbortSignal.timeout(this.inboundStreamProtocolNegotiationTimeout);Promise.resolve().then(async()=>{var d;const r=this.components.registrar.getProtocols(),{stream:i,protocol:s}=await v0(e,r,{signal:t,log:e.log,yieldBytes:!1});this.log("incoming %s stream opened",s);const o=QT(s,this.components.registrar);if(zm(s,"inbound",this)===o){const h=new f8(`Too many inbound protocol streams for protocol "${s}" - limit ${o}`);throw e.abort(h),h}e.source=i.source,e.sink=i.sink,e.protocol=s,i.closeWrite!=null&&(e.closeWrite=i.closeWrite),i.closeRead!=null&&(e.closeRead=i.closeRead),i.close!=null&&(e.close=i.close),await this.components.peerStore.merge(this.remotePeer,{protocols:[s]},{signal:t}),(d=this.components.metrics)==null||d.trackProtocolStream(e,this);const{handler:c,options:u}=this.components.registrar.getHandler(s);if(this.limits!=null&&u.runOnLimitedConnection!==!0)throw new Jf("Cannot open protocol stream on limited connection");await c({connection:this,stream:e})}).catch(async r=>{this.log.error("error handling incoming stream id %s - %e",e.id,r),e.abort(r)})}async close(e={}){var t;if(!(this.status==="closed"||this.status==="closing")){if(this.log("closing connection to %a",this.remoteAddr),this.status="closing",e.signal==null){const r=AbortSignal.timeout(WT);e={...e,signal:r}}try{this.log.trace("closing underlying transport"),await((t=this.muxer)==null?void 0:t.close(e)),await this.maConn.close(e),this.log.trace("updating timeline with close time"),this.status="closed",this.timeline.close=Date.now()}catch(r){this.log.error("error encountered during graceful close of connection to %a",this.remoteAddr,r),this.abort(r)}}}abort(e){var t;this.status!=="closed"&&(this.log.error("aborting connection to %a due to error",this.remoteAddr,e),this.status="closing",(t=this.muxer)==null||t.abort(e),this.maConn.abort(e),this.status="closed",this.timeline.close=Date.now())}}function jT(n,e){return new GT(n,e)}function QT(n,e){try{const{options:t}=e.getHandler(n);return t.maxInboundStreams}catch(t){if(t.name!=="UnhandledProtocolError")throw t}return N9}function YT(n,e,t={}){try{const{options:r}=e.getHandler(n);if(r.maxOutboundStreams!=null)return r.maxOutboundStreams}catch(r){if(r.name!=="UnhandledProtocolError")throw r}return t.maxOutboundStreams??L9}function zm(n,e,t){let r=0;return t.streams.forEach(i=>{i.direction===e&&i.protocol===n&&r++}),r}var o6;o6=Symbol.toStringTag;class XT{constructor(e,t){l(this,"components");l(this,"connectionEncrypters");l(this,"streamMuxers");l(this,"inboundUpgradeTimeout");l(this,"inboundStreamProtocolNegotiationTimeout");l(this,"outboundStreamProtocolNegotiationTimeout");l(this,"events");l(this,"metrics");l(this,o6,"@libp2p/upgrader");var r,i,s,o;this.components=e,this.connectionEncrypters=an({name:"libp2p_upgrader_connection_encrypters",metrics:this.components.metrics}),t.connectionEncrypters.forEach(a=>{this.connectionEncrypters.set(a.protocol,a)}),this.streamMuxers=an({name:"libp2p_upgrader_stream_multiplexers",metrics:this.components.metrics}),t.streamMuxers.forEach(a=>{this.streamMuxers.set(a.protocol,a)}),this.inboundUpgradeTimeout=t.inboundUpgradeTimeout??XC,this.inboundStreamProtocolNegotiationTimeout=t.inboundStreamProtocolNegotiationTimeout??ld,this.outboundStreamProtocolNegotiationTimeout=t.outboundStreamProtocolNegotiationTimeout??ld,this.events=e.events,this.metrics={dials:(r=e.metrics)==null?void 0:r.registerCounterGroup("libp2p_connection_manager_dials_total"),errors:(i=e.metrics)==null?void 0:i.registerCounterGroup("libp2p_connection_manager_dial_errors_total"),inboundErrors:(s=e.metrics)==null?void 0:s.registerCounterGroup("libp2p_connection_manager_dials_inbound_errors_total"),outboundErrors:(o=e.metrics)==null?void 0:o.registerCounterGroup("libp2p_connection_manager_dials_outbound_errors_total")}}async shouldBlockConnection(e,...t){const r=this.components.connectionGater[e];if(r==null)return;if(await r.apply(this.components.connectionGater,t)===!0)throw new RC(`The multiaddr connection is blocked by gater.${e}`)}createInboundAbortSignal(e){return Le([AbortSignal.timeout(this.inboundUpgradeTimeout),e])}async upgradeInbound(e,t){var s,o,a;let r=!1;const i=this.createInboundAbortSignal(t.signal);try{if((s=this.metrics.dials)==null||s.increment({inbound:!0}),r=await yt(this.components.connectionManager.acceptIncomingConnection(e),i),!r)throw new PC("Connection denied");await yt(this.shouldBlockConnection("denyInboundConnection",e),i),await this._performUpgrade(e,"inbound",{...t,signal:i})}catch(c){throw(o=this.metrics.errors)==null||o.increment({inbound:!0}),(a=this.metrics.inboundErrors)==null||a.increment({[c.name??"Error"]:!0}),c}finally{i.clear(),r&&this.components.connectionManager.afterUpgradeInbound()}}async upgradeOutbound(e,t){var r,i,s;try{(r=this.metrics.dials)==null||r.increment({outbound:!0});const o=e.remoteAddr.getPeerId();let a;o!=null&&(a=Ur(o),await yt(this.shouldBlockConnection("denyOutboundConnection",a,e),t.signal));let c="outbound";return t.initiator===!1&&(c="inbound"),await this._performUpgrade(e,c,t)}catch(o){throw(i=this.metrics.errors)==null||i.increment({outbound:!0}),(s=this.metrics.outboundErrors)==null||s.increment({[o.name??"Error"]:!0}),o}}async _performUpgrade(e,t,r){var f,p,m;let i,s,o,a,c;const u=`${parseInt(String(Math.random()*1e9)).toString(36)}${Date.now()}`;e.log=e.log.newScope(`${t}:${u}`),(f=this.components.metrics)==null||f.trackMultiaddrConnection(e),e.log.trace("starting the %s connection upgrade",t);let d=e;if((r==null?void 0:r.skipProtection)!==!0){const w=this.components.connectionProtector;w!=null&&(e.log("protecting the %s connection",t),d=await w.protect(e,r))}try{if(i=d,(r==null?void 0:r.skipEncryption)!==!0){(p=r==null?void 0:r.onProgress)==null||p.call(r,new N(`upgrader:encrypt-${t}-connection`)),{conn:i,remotePeer:s,protocol:c,streamMuxer:a}=await(t==="inbound"?this._encryptInbound(d,r):this._encryptOutbound(d,r));const w={...d,...i};await this.shouldBlockConnection(t==="inbound"?"denyInboundEncryptedConnection":"denyOutboundEncryptedConnection",s,w)}else{const w=e.remoteAddr.getPeerId();if(w==null)throw new vh(`${t} connection that skipped encryption must have a peer id`);const b=Ur(w);c="native",s=b}if(s.equals(this.components.peerId)){const w=new Vp("Can not dial self");throw e.abort(w),w}if(o=i,(r==null?void 0:r.muxerFactory)!=null)a=r.muxerFactory;else if(a==null&&this.streamMuxers.size>0){(m=r==null?void 0:r.onProgress)==null||m.call(r,new N(`upgrader:multiplex-${t}-connection`));const w=await(t==="inbound"?this._multiplexInbound({...d,...i},this.streamMuxers,r):this._multiplexOutbound({...d,...i},this.streamMuxers,r));a=w.muxerFactory,o=w.stream}}catch(w){throw e.log.error("failed to upgrade inbound connection %s %a - %e",t==="inbound"?"from":"to",e.remoteAddr,w),w}await this.shouldBlockConnection(t==="inbound"?"denyInboundUpgradedConnection":"denyOutboundUpgradedConnection",s,e);const h=this._createConnection({id:u,cryptoProtocol:c,direction:t,maConn:e,upgradedConn:o,muxerFactory:a,remotePeer:s,limits:r==null?void 0:r.limits});return h.log("successfully upgraded %s connection",t),h}_createConnection(e){const{id:t,cryptoProtocol:r,direction:i,maConn:s,upgradedConn:o,remotePeer:a,muxerFactory:c,limits:u}=e;let d;const h=s.timeline;return s.timeline=new Proxy(h,{set:(...f)=>(f[1]==="close"&&f[2]!=null&&h.close==null&&(async()=>{try{d.status==="open"&&await d.close()}catch(p){d.log.error("error closing connection after timeline close %e",p)}finally{this.events.safeDispatchEvent("connection:close",{detail:d})}})().catch(p=>{d.log.error("error thrown while dispatching connection:close event %e",p)}),Reflect.set(...f))}),s.timeline.upgraded=Date.now(),d=jT(this.components,{id:t,maConn:o,remotePeer:a,direction:i,muxerFactory:c,encryption:r,limits:u,outboundStreamProtocolNegotiationTimeout:this.outboundStreamProtocolNegotiationTimeout,inboundStreamProtocolNegotiationTimeout:this.inboundStreamProtocolNegotiationTimeout}),this.events.safeDispatchEvent("connection:open",{detail:d}),d}async _encryptInbound(e,t){const r=Array.from(this.connectionEncrypters.keys());try{const{stream:i,protocol:s}=await v0(e,r,{...t,log:e.log}),o=this.connectionEncrypters.get(s);if(o==null)throw new Ql(`no crypto module found for ${s}`);return e.log("encrypting inbound connection to %a using %s",e.remoteAddr,s),{...await o.secureInbound(i,t),protocol:s}}catch(i){throw e.log.error("encrypting inbound connection from %a failed",e.remoteAddr,i),new Ql(i.message)}}async _encryptOutbound(e,t){const r=Array.from(this.connectionEncrypters.keys());try{e.log.trace("selecting encrypter from %s",r);const{stream:i,protocol:s}=await b0(e,r,{...t,log:e.log,yieldBytes:!0}),o=this.connectionEncrypters.get(s);if(o==null)throw new Ql(`no crypto module found for ${s}`);return e.log("encrypting outbound connection to %a using %s",e.remoteAddr,s),{...await o.secureOutbound(i,t),protocol:s}}catch(i){throw e.log.error("encrypting outbound connection to %a failed",e.remoteAddr,i),new Ql(i.message)}}async _multiplexOutbound(e,t,r){const i=Array.from(t.keys());e.log("outbound selecting muxer %s",i);try{e.log.trace("selecting stream muxer from %s",i);const{stream:s,protocol:o}=await b0(e,i,{...r,log:e.log,yieldBytes:!0});e.log("selected %s as muxer protocol",o);const a=t.get(o);return{stream:s,muxerFactory:a}}catch(s){throw e.log.error("error multiplexing outbound connection",s),new y0(String(s))}}async _multiplexInbound(e,t,r){const i=Array.from(t.keys());e.log("inbound handling muxers %s",i);try{const{stream:s,protocol:o}=await v0(e,i,{...r,log:e.log}),a=t.get(o);return{stream:s,muxerFactory:a}}catch(s){throw e.log.error("error multiplexing inbound connection",s),new y0(String(s))}}getConnectionEncrypters(){return this.connectionEncrypters}getStreamMuxers(){return this.streamMuxers}}const B9="2.10.0",M9="js-libp2p";function U9(n,e){return`${n??M9}/${e??B9} browser/${globalThis.navigator.userAgent}`}var el,S0;class F9 extends ot{constructor(t){var d,h,f,p,m,w,b,S,k,C,Q,re;super();pe(this,el);l(this,"peerId");l(this,"peerStore");l(this,"contentRouting");l(this,"peerRouting");l(this,"metrics");l(this,"services");l(this,"logger");l(this,"status");l(this,"components");l(this,"log");this.status="stopped";const r=new ot,i=r.dispatchEvent.bind(r);r.dispatchEvent=T=>{const Y=i(T),se=this.dispatchEvent(new CustomEvent(T.type,{detail:T.detail}));return Y||se},this.peerId=t.peerId,this.logger=t.logger??Ih(),this.log=this.logger.forComponent("libp2p"),this.services={};const s=((d=t.nodeInfo)==null?void 0:d.name)??M9,o=((h=t.nodeInfo)==null?void 0:h.version)??B9,a=this.components=MC({peerId:t.peerId,privateKey:t.privateKey,nodeInfo:{name:s,version:o,userAgent:((f=t.nodeInfo)==null?void 0:f.userAgent)??U9(s,o)},logger:this.logger,events:r,datastore:t.datastore??new m9,connectionGater:KC(t.connectionGater),dns:t.dns});t.metrics!=null&&(this.metrics=this.configureComponent("metrics",t.metrics(this.components))),this.peerStore=this.configureComponent("peerStore",sC(a,{addressFilter:this.components.connectionGater.filterMultiaddrForPeer,...t.peerStore})),a.events.addEventListener("peer:update",T=>{if(T.detail.previous==null){const Y={id:T.detail.peer.id,multiaddrs:T.detail.peer.addresses.map(se=>se.multiaddr)};a.events.safeDispatchEvent("peer:discovery",{detail:Y})}}),t.connectionProtector!=null&&this.configureComponent("connectionProtector",t.connectionProtector(a)),this.components.upgrader=new XT(this.components,{connectionEncrypters:(t.connectionEncrypters??[]).map((T,Y)=>this.configureComponent(`connection-encryption-${Y}`,T(this.components))),streamMuxers:(t.streamMuxers??[]).map((T,Y)=>this.configureComponent(`stream-muxers-${Y}`,T(this.components))),inboundUpgradeTimeout:(p=t.connectionManager)==null?void 0:p.inboundUpgradeTimeout,inboundStreamProtocolNegotiationTimeout:((m=t.connectionManager)==null?void 0:m.inboundStreamProtocolNegotiationTimeout)??((w=t.connectionManager)==null?void 0:w.protocolNegotiationTimeout),outboundStreamProtocolNegotiationTimeout:((b=t.connectionManager)==null?void 0:b.outboundStreamProtocolNegotiationTimeout)??((S=t.connectionManager)==null?void 0:S.protocolNegotiationTimeout)}),this.configureComponent("transportManager",new UT(this.components,t.transportManager)),this.configureComponent("connectionManager",new ST(this.components,t.connectionManager)),((k=t.connectionMonitor)==null?void 0:k.enabled)!==!1&&this.configureComponent("connectionMonitor",new DT(this.components,t.connectionMonitor)),this.configureComponent("registrar",new MT(this.components)),this.configureComponent("addressManager",new SC(this.components,t.addresses));const c=(t.peerRouters??[]).map((T,Y)=>this.configureComponent(`peer-router-${Y}`,T(this.components)));this.peerRouting=this.components.peerRouting=this.configureComponent("peerRouting",new LT(this.components,{routers:c}));const u=(t.contentRouters??[]).map((T,Y)=>this.configureComponent(`content-router-${Y}`,T(this.components)));if(this.contentRouting=this.components.contentRouting=this.configureComponent("contentRouting",new NT(this.components,{routers:u})),this.configureComponent("randomWalk",new BT(this.components)),(t.peerDiscovery??[]).forEach((T,Y)=>{this.configureComponent(`peer-discovery-${Y}`,T(this.components)).addEventListener("peer",L=>{D(this,el,S0).call(this,L)})}),(C=t.transports)==null||C.forEach((T,Y)=>{this.components.transportManager.add(this.configureComponent(`transport-${Y}`,T(this.components)))}),t.services!=null)for(const T of Object.keys(t.services)){const Y=t.services[T],se=Y(this.components);if(se==null){this.log.error("service factory %s returned null or undefined instance",T);continue}this.services[T]=se,this.configureComponent(T,se),se[bc]!=null&&(this.log("registering service %s for content routing",T),u.push(se[bc])),se[vc]!=null&&(this.log("registering service %s for peer routing",T),c.push(se[vc])),se[Vu]!=null&&(this.log("registering service %s for peer discovery",T),(re=(Q=se[Vu]).addEventListener)==null||re.call(Q,"peer",L=>{D(this,el,S0).call(this,L)}))}UC(a)}configureComponent(t,r){return r==null&&this.log.error("component %s was null or undefined",t),this.components[t]=r,r}async start(){var t,r,i,s;if(this.status==="stopped"){this.status="starting",this.log("libp2p is starting");try{await((r=(t=this.components).beforeStart)==null?void 0:r.call(t)),await this.components.start(),await((s=(i=this.components).afterStart)==null?void 0:s.call(i)),this.status="started",this.safeDispatchEvent("start",{detail:this}),this.log("libp2p has started")}catch(o){throw this.log.error("An error occurred starting libp2p",o),this.status="started",await this.stop(),o}}}async stop(){var t,r,i,s;this.status==="started"&&(this.log("libp2p is stopping"),this.status="stopping",await((r=(t=this.components).beforeStop)==null?void 0:r.call(t)),await this.components.stop(),await((s=(i=this.components).afterStop)==null?void 0:s.call(i)),this.status="stopped",this.safeDispatchEvent("stop",{detail:this}),this.log("libp2p has stopped"))}getConnections(t){return this.components.connectionManager.getConnections(t)}getDialQueue(){return this.components.connectionManager.getDialQueue()}getPeers(){const t=new xn;for(const r of this.components.connectionManager.getConnections())t.add(r.remotePeer);return Array.from(t)}async dial(t,r={}){return this.components.connectionManager.openConnection(t,{priority:75,...r})}async dialProtocol(t,r,i={}){if(r==null)throw new O("no protocols were provided to open a stream");if(r=Array.isArray(r)?r:[r],r.length===0)throw new O("no protocols were provided to open a stream");return(await this.dial(t,i)).newStream(r,i)}getMultiaddrs(){return this.components.addressManager.getAddresses()}getProtocols(){return this.components.registrar.getProtocols()}async hangUp(t,r={}){Np(t)&&(t=Ur(t.getPeerId()??"")),await this.components.connectionManager.closeConnections(t,r)}async getPublicKey(t,r={}){if(this.log("getPublicKey %p",t),t.publicKey!=null)return t.publicKey;try{const a=await this.peerStore.get(t,r);if(a.id.publicKey!=null)return a.id.publicKey}catch(a){if(a.name!=="NotFoundError")throw a}const i=sr([R("/pk/"),t.toMultihash().bytes]),s=await this.contentRouting.get(i,r),o=on(s);return await this.peerStore.patch(t,{publicKey:o},r),o}async handle(t,r,i){Array.isArray(t)||(t=[t]),await Promise.all(t.map(async s=>{await this.components.registrar.handle(s,r,i)}))}async unhandle(t,r){Array.isArray(t)||(t=[t]),await Promise.all(t.map(async i=>{await this.components.registrar.unhandle(i,r)}))}async register(t,r,i){return this.components.registrar.register(t,r,i)}unregister(t){this.components.registrar.unregister(t)}async isDialable(t,r={}){return this.components.connectionManager.isDialable(t,r)}}el=new WeakSet,S0=function(t){const{detail:r}=t;if(r.id.toString()===this.peerId.toString()){this.log.error("peer discovery mechanism discovered self");return}this.components.peerStore.merge(r.id,{multiaddrs:r.multiaddrs}).catch(i=>{this.log.error(i)})};async function $9(n={}){n.privateKey??(n.privateKey=await Xp("Ed25519"));const e=new F9({...await FI(n),peerId:DA(n.privateKey)});return n.start!==!1&&await e.start(),e}const ZT=["dial","dialProtocol","hangUp","handle","unhandle","getMultiaddrs","getProtocols"];function JT(n){return n==null?!1:n instanceof F9?!0:ZT.every(e=>typeof n[e]=="function")}function eR(n){return n>=55296&&n<=56319}function tR(n){return n>=56320&&n<=57343}var rR=function(e,t,r){if(typeof t!="string")throw new Error("Input must be string");for(var i=t.length,s=0,o,a,c=0;c<i;c+=1){if(o=t.charCodeAt(c),a=t[c],eR(o)&&tR(t.charCodeAt(c+1))&&(c+=1,a+=t[c]),s+=e(a),s===r)return t.slice(0,c+1);if(s>r)return t.slice(0,c-a.length+1)}return t};function nR(n){return n>=55296&&n<=56319}function iR(n){return n>=56320&&n<=57343}var sR=function(e){if(typeof e!="string")throw new Error("Input must be string");for(var t=e.length,r=0,i=null,s=null,o=0;o<t;o++)i=e.charCodeAt(o),iR(i)?s!=null&&nR(s)?r+=1:r+=3:i<=127?r+=1:i>=128&&i<=2047?r+=2:i>=2048&&i<=65535&&(r+=3),s=i;return r},oR=rR,aR=sR,cR=oR.bind(null,aR),lR=cR,uR=/[\/\?<>\\:\*\|"]/g,dR=/[\x00-\x1f\x80-\x9f]/g,hR=/^\.+$/,fR=/^(con|prn|aux|nul|com[0-9]|lpt[0-9])(\..*)?$/i,pR=/[\. ]+$/;function Km(n,e){if(typeof n!="string")throw new Error("Input must be string");var t=n.replace(uR,e).replace(dR,e).replace(hR,e).replace(fR,e).replace(pR,e);return lR(t,255)}var gR=function(n,e){var t=e&&e.replacement||"",r=Km(n,t);return t===""?r:Km(r,"")};const mR=ol(gR),lf={alg:"A128GCM",ext:!0,k:"scm9jmO_4BJAgdwWGVulLg",key_ops:["encrypt","decrypt"],kty:"oct"};function H9(n){const e="AES-GCM";let t=16;const r=12,i="SHA-256",s=16,o=32767,a=Gt.get();t*=8;async function c(h,f){const p=a.getRandomValues(new Uint8Array(s)),m=a.getRandomValues(new Uint8Array(r)),w={name:e,iv:m};typeof f=="string"&&(f=R(f));let b;if(f.length===0){b=await a.subtle.importKey("jwk",lf,{name:"AES-GCM"},!0,["encrypt"]);try{const k={name:"PBKDF2",salt:p,iterations:o,hash:{name:i}},C=await a.subtle.importKey("raw",f,{name:"PBKDF2"},!1,["deriveKey"]);b=await a.subtle.deriveKey(k,C,{name:e,length:t},!0,["encrypt"])}catch{b=await a.subtle.importKey("jwk",lf,{name:"AES-GCM"},!0,["encrypt"])}}else{const k={name:"PBKDF2",salt:p,iterations:o,hash:{name:i}},C=await a.subtle.importKey("raw",f,{name:"PBKDF2"},!1,["deriveKey"]);b=await a.subtle.deriveKey(k,C,{name:e,length:t},!0,["encrypt"])}const S=await a.subtle.encrypt(w,b,h);return sr([p,w.iv,new Uint8Array(S)])}async function u(h,f){const p=h.subarray(0,s),m=h.subarray(s,s+r),w=h.subarray(s+r),b={name:e,iv:m};typeof f=="string"&&(f=R(f));let S;if(f.length===0)try{const C={name:"PBKDF2",salt:p,iterations:o,hash:{name:i}},Q=await a.subtle.importKey("raw",f,{name:"PBKDF2"},!1,["deriveKey"]);S=await a.subtle.deriveKey(C,Q,{name:e,length:t},!0,["decrypt"])}catch{S=await a.subtle.importKey("jwk",lf,{name:"AES-GCM"},!0,["decrypt"])}else{const C={name:"PBKDF2",salt:p,iterations:o,hash:{name:i}},Q=await a.subtle.importKey("raw",f,{name:"PBKDF2"},!1,["deriveKey"]);S=await a.subtle.deriveKey(C,Q,{name:e,length:t},!0,["decrypt"])}const k=await a.subtle.decrypt(b,S,w);return new Uint8Array(k)}return{encrypt:c,decrypt:u}}/*!
 * MIT License
 * 
 * Copyright (c) 2017-2024 Peculiar Ventures, LLC
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 * 
 */const yR="[object ArrayBuffer]";class H{static isArrayBuffer(e){return Object.prototype.toString.call(e)===yR}static toArrayBuffer(e){return this.isArrayBuffer(e)?e:e.byteLength===e.buffer.byteLength||e.byteOffset===0&&e.byteLength===e.buffer.byteLength?e.buffer:this.toUint8Array(e.buffer).slice(e.byteOffset,e.byteOffset+e.byteLength).buffer}static toUint8Array(e){return this.toView(e,Uint8Array)}static toView(e,t){if(e.constructor===t)return e;if(this.isArrayBuffer(e))return new t(e);if(this.isArrayBufferView(e))return new t(e.buffer,e.byteOffset,e.byteLength);throw new TypeError("The provided value is not of type '(ArrayBuffer or ArrayBufferView)'")}static isBufferSource(e){return this.isArrayBufferView(e)||this.isArrayBuffer(e)}static isArrayBufferView(e){return ArrayBuffer.isView(e)||e&&this.isArrayBuffer(e.buffer)}static isEqual(e,t){const r=H.toUint8Array(e),i=H.toUint8Array(t);if(r.length!==i.byteLength)return!1;for(let s=0;s<r.length;s++)if(r[s]!==i[s])return!1;return!0}static concat(...e){let t;Array.isArray(e[0])&&!(e[1]instanceof Function)||Array.isArray(e[0])&&e[1]instanceof Function?t=e[0]:e[e.length-1]instanceof Function?t=e.slice(0,e.length-1):t=e;let r=0;for(const o of t)r+=o.byteLength;const i=new Uint8Array(r);let s=0;for(const o of t){const a=this.toUint8Array(o);i.set(a,s),s+=a.length}return e[e.length-1]instanceof Function?this.toView(i,e[e.length-1]):i.buffer}}const uf="string",wR=/^[0-9a-f\s]+$/i,bR=/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/,vR=/^[a-zA-Z0-9-_]+$/;class qm{static fromString(e){const t=unescape(encodeURIComponent(e)),r=new Uint8Array(t.length);for(let i=0;i<t.length;i++)r[i]=t.charCodeAt(i);return r.buffer}static toString(e){const t=H.toUint8Array(e);let r="";for(let s=0;s<t.length;s++)r+=String.fromCharCode(t[s]);return decodeURIComponent(escape(r))}}class fn{static toString(e,t=!1){const r=H.toArrayBuffer(e),i=new DataView(r);let s="";for(let o=0;o<r.byteLength;o+=2){const a=i.getUint16(o,t);s+=String.fromCharCode(a)}return s}static fromString(e,t=!1){const r=new ArrayBuffer(e.length*2),i=new DataView(r);for(let s=0;s<e.length;s++)i.setUint16(s*2,e.charCodeAt(s),t);return r}}class ee{static isHex(e){return typeof e===uf&&wR.test(e)}static isBase64(e){return typeof e===uf&&bR.test(e)}static isBase64Url(e){return typeof e===uf&&vR.test(e)}static ToString(e,t="utf8"){const r=H.toUint8Array(e);switch(t.toLowerCase()){case"utf8":return this.ToUtf8String(r);case"binary":return this.ToBinary(r);case"hex":return this.ToHex(r);case"base64":return this.ToBase64(r);case"base64url":return this.ToBase64Url(r);case"utf16le":return fn.toString(r,!0);case"utf16":case"utf16be":return fn.toString(r);default:throw new Error(`Unknown type of encoding '${t}'`)}}static FromString(e,t="utf8"){if(!e)return new ArrayBuffer(0);switch(t.toLowerCase()){case"utf8":return this.FromUtf8String(e);case"binary":return this.FromBinary(e);case"hex":return this.FromHex(e);case"base64":return this.FromBase64(e);case"base64url":return this.FromBase64Url(e);case"utf16le":return fn.fromString(e,!0);case"utf16":case"utf16be":return fn.fromString(e);default:throw new Error(`Unknown type of encoding '${t}'`)}}static ToBase64(e){const t=H.toUint8Array(e);if(typeof btoa<"u"){const r=this.ToString(t,"binary");return btoa(r)}else return Buffer.from(t).toString("base64")}static FromBase64(e){const t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!ee.isBase64(t))throw new TypeError("Argument 'base64Text' is not Base64 encoded");return typeof atob<"u"?this.FromBinary(atob(t)):new Uint8Array(Buffer.from(t,"base64")).buffer}static FromBase64Url(e){const t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!ee.isBase64Url(t))throw new TypeError("Argument 'base64url' is not Base64Url encoded");return this.FromBase64(this.Base64Padding(t.replace(/\-/g,"+").replace(/\_/g,"/")))}static ToBase64Url(e){return this.ToBase64(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,"")}static FromUtf8String(e,t=ee.DEFAULT_UTF8_ENCODING){switch(t){case"ascii":return this.FromBinary(e);case"utf8":return qm.fromString(e);case"utf16":case"utf16be":return fn.fromString(e);case"utf16le":case"usc2":return fn.fromString(e,!0);default:throw new Error(`Unknown type of encoding '${t}'`)}}static ToUtf8String(e,t=ee.DEFAULT_UTF8_ENCODING){switch(t){case"ascii":return this.ToBinary(e);case"utf8":return qm.toString(e);case"utf16":case"utf16be":return fn.toString(e);case"utf16le":case"usc2":return fn.toString(e,!0);default:throw new Error(`Unknown type of encoding '${t}'`)}}static FromBinary(e){const t=e.length,r=new Uint8Array(t);for(let i=0;i<t;i++)r[i]=e.charCodeAt(i);return r.buffer}static ToBinary(e){const t=H.toUint8Array(e);let r="";for(let i=0;i<t.length;i++)r+=String.fromCharCode(t[i]);return r}static ToHex(e){const t=H.toUint8Array(e);let r="";const i=t.length;for(let s=0;s<i;s++){const o=t[s];o<16&&(r+="0"),r+=o.toString(16)}return r}static FromHex(e){let t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!ee.isHex(t))throw new TypeError("Argument 'hexString' is not HEX encoded");t.length%2&&(t=`0${t}`);const r=new Uint8Array(t.length/2);for(let i=0;i<t.length;i=i+2){const s=t.slice(i,i+2);r[i/2]=parseInt(s,16)}return r.buffer}static ToUtf16String(e,t=!1){return fn.toString(e,t)}static FromUtf16String(e,t=!1){return fn.fromString(e,t)}static Base64Padding(e){const t=4-e.length%4;if(t<4)for(let r=0;r<t;r++)e+="=";return e}static formatString(e){return(e==null?void 0:e.replace(/[\n\r\t ]/g,""))||""}}ee.DEFAULT_UTF8_ENCODING="utf8";function SR(...n){const e=n.map(i=>i.byteLength).reduce((i,s)=>i+s),t=new Uint8Array(e);let r=0;return n.map(i=>new Uint8Array(i)).forEach(i=>{for(const s of i)t[r++]=s}),t.buffer}function V9(n,e){if(!(n&&e)||n.byteLength!==e.byteLength)return!1;const t=new Uint8Array(n),r=new Uint8Array(e);for(let i=0;i<n.byteLength;i++)if(t[i]!==r[i])return!1;return!0}/*!
 Copyright (c) Peculiar Ventures, LLC
*/function Yo(n,e){let t=0;if(n.length===1)return n[0];for(let r=n.length-1;r>=0;r--)t+=n[n.length-1-r]*Math.pow(2,e*r);return t}function Ls(n,e,t=-1){const r=t;let i=n,s=0,o=Math.pow(2,e);for(let a=1;a<8;a++){if(n<o){let c;if(r<0)c=new ArrayBuffer(a),s=a;else{if(r<a)return new ArrayBuffer(0);c=new ArrayBuffer(r),s=r}const u=new Uint8Array(c);for(let d=a-1;d>=0;d--){const h=Math.pow(2,d*e);u[s-d-1]=Math.floor(i/h),i-=u[s-d-1]*h}return c}o*=Math.pow(2,e)}return new ArrayBuffer(0)}function E0(...n){let e=0,t=0;for(const s of n)e+=s.length;const r=new ArrayBuffer(e),i=new Uint8Array(r);for(const s of n)i.set(s,t),t+=s.length;return i}function z9(){const n=new Uint8Array(this.valueHex);if(this.valueHex.byteLength>=2){const a=n[0]===255&&n[1]&128,c=n[0]===0&&(n[1]&128)===0;(a||c)&&this.warnings.push("Needlessly long format")}const e=new ArrayBuffer(this.valueHex.byteLength),t=new Uint8Array(e);for(let a=0;a<this.valueHex.byteLength;a++)t[a]=0;t[0]=n[0]&128;const r=Yo(t,8),i=new ArrayBuffer(this.valueHex.byteLength),s=new Uint8Array(i);for(let a=0;a<this.valueHex.byteLength;a++)s[a]=n[a];return s[0]&=127,Yo(s,8)-r}function ER(n){const e=n<0?n*-1:n;let t=128;for(let r=1;r<8;r++){if(e<=t){if(n<0){const o=t-e,a=Ls(o,8,r),c=new Uint8Array(a);return c[0]|=128,a}let i=Ls(e,8,r),s=new Uint8Array(i);if(s[0]&128){const o=i.slice(0),a=new Uint8Array(o);i=new ArrayBuffer(i.byteLength+1),s=new Uint8Array(i);for(let c=0;c<o.byteLength;c++)s[c+1]=a[c];s[0]=0}return i}t*=Math.pow(2,8)}return new ArrayBuffer(0)}function xR(n,e){if(n.byteLength!==e.byteLength)return!1;const t=new Uint8Array(n),r=new Uint8Array(e);for(let i=0;i<t.length;i++)if(t[i]!==r[i])return!1;return!0}function fr(n,e){const t=n.toString(10);if(e<t.length)return"";const r=e-t.length,i=new Array(r);for(let o=0;o<r;o++)i[o]="0";return i.join("").concat(t)}/*!
 * Copyright (c) 2014, GMO GlobalSign
 * Copyright (c) 2015-2022, Peculiar Ventures
 * All rights reserved.
 * 
 * Author 2014-2019, Yury Strozhevsky
 * 
 * Redistribution and use in source and binary forms, with or without modification,
 * are permitted provided that the following conditions are met:
 * 
 * * Redistributions of source code must retain the above copyright notice, this
 *   list of conditions and the following disclaimer.
 * 
 * * Redistributions in binary form must reproduce the above copyright notice, this
 *   list of conditions and the following disclaimer in the documentation and/or
 *   other materials provided with the distribution.
 * 
 * * Neither the name of the copyright holder nor the names of its
 *   contributors may be used to endorse or promote products derived from
 *   this software without specific prior written permission.
 * 
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR
 * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
 * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 * 
 */function dd(){if(typeof BigInt>"u")throw new Error("BigInt is not defined. Your environment doesn't implement BigInt.")}function dg(n){let e=0,t=0;for(let i=0;i<n.length;i++){const s=n[i];e+=s.byteLength}const r=new Uint8Array(e);for(let i=0;i<n.length;i++){const s=n[i];r.set(new Uint8Array(s),t),t+=s.byteLength}return r.buffer}function wi(n,e,t,r){return e instanceof Uint8Array?e.byteLength?t<0?(n.error="Wrong parameter: inputOffset less than zero",!1):r<0?(n.error="Wrong parameter: inputLength less than zero",!1):e.byteLength-t-r<0?(n.error="End of input reached before message was fully decoded (inconsistent offset and length values)",!1):!0:(n.error="Wrong parameter: inputBuffer has zero length",!1):(n.error="Wrong parameter: inputBuffer must be 'Uint8Array'",!1)}class Uh{constructor(){this.items=[]}write(e){this.items.push(e)}final(){return dg(this.items)}}const $a=[new Uint8Array([1])],Wm="0123456789",df="name",Gm="valueHexView",AR="isHexOnly",kR="idBlock",_R="tagClass",IR="tagNumber",CR="isConstructed",TR="fromBER",RR="toBER",PR="local",Jt="",dn=new ArrayBuffer(0),Fh=new Uint8Array(0),Lc="EndOfContent",K9="OCTET STRING",q9="BIT STRING";function Tn(n){var e;return e=class extends n{get valueHex(){return this.valueHexView.slice().buffer}set valueHex(r){this.valueHexView=new Uint8Array(r)}constructor(...r){var i;super(...r);const s=r[0]||{};this.isHexOnly=(i=s.isHexOnly)!==null&&i!==void 0?i:!1,this.valueHexView=s.valueHex?H.toUint8Array(s.valueHex):Fh}fromBER(r,i,s){const o=r instanceof ArrayBuffer?new Uint8Array(r):r;if(!wi(this,o,i,s))return-1;const a=i+s;return this.valueHexView=o.subarray(i,a),this.valueHexView.length?(this.blockLength=s,a):(this.warnings.push("Zero buffer length"),i)}toBER(r=!1){return this.isHexOnly?r?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.byteLength===this.valueHexView.buffer.byteLength?this.valueHexView.buffer:this.valueHexView.slice().buffer:(this.error="Flag 'isHexOnly' is not set, abort",dn)}toJSON(){return{...super.toJSON(),isHexOnly:this.isHexOnly,valueHex:ee.ToHex(this.valueHexView)}}},e.NAME="hexBlock",e}class to{static blockName(){return this.NAME}get valueBeforeDecode(){return this.valueBeforeDecodeView.slice().buffer}set valueBeforeDecode(e){this.valueBeforeDecodeView=new Uint8Array(e)}constructor({blockLength:e=0,error:t=Jt,warnings:r=[],valueBeforeDecode:i=Fh}={}){this.blockLength=e,this.error=t,this.warnings=r,this.valueBeforeDecodeView=H.toUint8Array(i)}toJSON(){return{blockName:this.constructor.NAME,blockLength:this.blockLength,error:this.error,warnings:this.warnings,valueBeforeDecode:ee.ToHex(this.valueBeforeDecodeView)}}}to.NAME="baseBlock";class Qt extends to{fromBER(e,t,r){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}toBER(e,t){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}}Qt.NAME="valueBlock";class W9 extends Tn(to){constructor({idBlock:e={}}={}){var t,r,i,s;super(),e?(this.isHexOnly=(t=e.isHexOnly)!==null&&t!==void 0?t:!1,this.valueHexView=e.valueHex?H.toUint8Array(e.valueHex):Fh,this.tagClass=(r=e.tagClass)!==null&&r!==void 0?r:-1,this.tagNumber=(i=e.tagNumber)!==null&&i!==void 0?i:-1,this.isConstructed=(s=e.isConstructed)!==null&&s!==void 0?s:!1):(this.tagClass=-1,this.tagNumber=-1,this.isConstructed=!1)}toBER(e=!1){let t=0;switch(this.tagClass){case 1:t|=0;break;case 2:t|=64;break;case 3:t|=128;break;case 4:t|=192;break;default:return this.error="Unknown tag class",dn}if(this.isConstructed&&(t|=32),this.tagNumber<31&&!this.isHexOnly){const i=new Uint8Array(1);if(!e){let s=this.tagNumber;s&=31,t|=s,i[0]=t}return i.buffer}if(!this.isHexOnly){const i=Ls(this.tagNumber,7),s=new Uint8Array(i),o=i.byteLength,a=new Uint8Array(o+1);if(a[0]=t|31,!e){for(let c=0;c<o-1;c++)a[c+1]=s[c]|128;a[o]=s[o-1]}return a.buffer}const r=new Uint8Array(this.valueHexView.byteLength+1);if(r[0]=t|31,!e){const i=this.valueHexView;for(let s=0;s<i.length-1;s++)r[s+1]=i[s]|128;r[this.valueHexView.byteLength]=i[i.length-1]}return r.buffer}fromBER(e,t,r){const i=H.toUint8Array(e);if(!wi(this,i,t,r))return-1;const s=i.subarray(t,t+r);if(s.length===0)return this.error="Zero buffer length",-1;switch(s[0]&192){case 0:this.tagClass=1;break;case 64:this.tagClass=2;break;case 128:this.tagClass=3;break;case 192:this.tagClass=4;break;default:return this.error="Unknown tag class",-1}this.isConstructed=(s[0]&32)===32,this.isHexOnly=!1;const a=s[0]&31;if(a!==31)this.tagNumber=a,this.blockLength=1;else{let c=1,u=this.valueHexView=new Uint8Array(255),d=255;for(;s[c]&128;){if(u[c-1]=s[c]&127,c++,c>=s.length)return this.error="End of input reached before message was fully decoded",-1;if(c===d){d+=255;const f=new Uint8Array(d);for(let p=0;p<u.length;p++)f[p]=u[p];u=this.valueHexView=new Uint8Array(d)}}this.blockLength=c+1,u[c-1]=s[c]&127;const h=new Uint8Array(c);for(let f=0;f<c;f++)h[f]=u[f];u=this.valueHexView=new Uint8Array(c),u.set(h),this.blockLength<=9?this.tagNumber=Yo(u,7):(this.isHexOnly=!0,this.warnings.push("Tag too long, represented as hex-coded"))}if(this.tagClass===1&&this.isConstructed)switch(this.tagNumber){case 1:case 2:case 5:case 6:case 9:case 13:case 14:case 23:case 24:case 31:case 32:case 33:case 34:return this.error="Constructed encoding used for primitive type",-1}return t+this.blockLength}toJSON(){return{...super.toJSON(),tagClass:this.tagClass,tagNumber:this.tagNumber,isConstructed:this.isConstructed}}}W9.NAME="identificationBlock";class G9 extends to{constructor({lenBlock:e={}}={}){var t,r,i;super(),this.isIndefiniteForm=(t=e.isIndefiniteForm)!==null&&t!==void 0?t:!1,this.longFormUsed=(r=e.longFormUsed)!==null&&r!==void 0?r:!1,this.length=(i=e.length)!==null&&i!==void 0?i:0}fromBER(e,t,r){const i=H.toUint8Array(e);if(!wi(this,i,t,r))return-1;const s=i.subarray(t,t+r);if(s.length===0)return this.error="Zero buffer length",-1;if(s[0]===255)return this.error="Length block 0xFF is reserved by standard",-1;if(this.isIndefiniteForm=s[0]===128,this.isIndefiniteForm)return this.blockLength=1,t+this.blockLength;if(this.longFormUsed=!!(s[0]&128),this.longFormUsed===!1)return this.length=s[0],this.blockLength=1,t+this.blockLength;const o=s[0]&127;if(o>8)return this.error="Too big integer",-1;if(o+1>s.length)return this.error="End of input reached before message was fully decoded",-1;const a=t+1,c=i.subarray(a,a+o);return c[o-1]===0&&this.warnings.push("Needlessly long encoded length"),this.length=Yo(c,8),this.longFormUsed&&this.length<=127&&this.warnings.push("Unnecessary usage of long length form"),this.blockLength=o+1,t+this.blockLength}toBER(e=!1){let t,r;if(this.length>127&&(this.longFormUsed=!0),this.isIndefiniteForm)return t=new ArrayBuffer(1),e===!1&&(r=new Uint8Array(t),r[0]=128),t;if(this.longFormUsed){const i=Ls(this.length,8);if(i.byteLength>127)return this.error="Too big length",dn;if(t=new ArrayBuffer(i.byteLength+1),e)return t;const s=new Uint8Array(i);r=new Uint8Array(t),r[0]=i.byteLength|128;for(let o=0;o<i.byteLength;o++)r[o+1]=s[o];return t}return t=new ArrayBuffer(1),e===!1&&(r=new Uint8Array(t),r[0]=this.length),t}toJSON(){return{...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,longFormUsed:this.longFormUsed,length:this.length}}}G9.NAME="lengthBlock";const X={};class Ct extends to{constructor({name:e=Jt,optional:t=!1,primitiveSchema:r,...i}={},s){super(i),this.name=e,this.optional=t,r&&(this.primitiveSchema=r),this.idBlock=new W9(i),this.lenBlock=new G9(i),this.valueBlock=s?new s(i):new Qt(i)}fromBER(e,t,r){const i=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?r:this.lenBlock.length);return i===-1?(this.error=this.valueBlock.error,i):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),i)}toBER(e,t){const r=t||new Uh;t||j9(this);const i=this.idBlock.toBER(e);if(r.write(i),this.lenBlock.isIndefiniteForm)r.write(new Uint8Array([128]).buffer),this.valueBlock.toBER(e,r),r.write(new ArrayBuffer(2));else{const s=this.valueBlock.toBER(e);this.lenBlock.length=s.byteLength;const o=this.lenBlock.toBER(e);r.write(o),r.write(s)}return t?dn:r.final()}toJSON(){const e={...super.toJSON(),idBlock:this.idBlock.toJSON(),lenBlock:this.lenBlock.toJSON(),valueBlock:this.valueBlock.toJSON(),name:this.name,optional:this.optional};return this.primitiveSchema&&(e.primitiveSchema=this.primitiveSchema.toJSON()),e}toString(e="ascii"){return e==="ascii"?this.onAsciiEncoding():ee.ToHex(this.toBER())}onAsciiEncoding(){const e=this.constructor.NAME,t=ee.ToHex(this.valueBlock.valueBeforeDecodeView);return`${e} : ${t}`}isEqual(e){if(this===e)return!0;if(!(e instanceof this.constructor))return!1;const t=this.toBER(),r=e.toBER();return xR(t,r)}}Ct.NAME="BaseBlock";function j9(n){var e;if(n instanceof X.Constructed)for(const t of n.valueBlock.value)j9(t)&&(n.lenBlock.isIndefiniteForm=!0);return!!(!((e=n.lenBlock)===null||e===void 0)&&e.isIndefiniteForm)}class hg extends Ct{getValue(){return this.valueBlock.value}setValue(e){this.valueBlock.value=e}constructor({value:e=Jt,...t}={},r){super(t,r),e&&this.fromString(e)}fromBER(e,t,r){const i=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?r:this.lenBlock.length);return i===-1?(this.error=this.valueBlock.error,i):(this.fromBuffer(this.valueBlock.valueHexView),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),i)}onAsciiEncoding(){return`${this.constructor.NAME} : '${this.valueBlock.value}'`}}hg.NAME="BaseStringBlock";class Q9 extends Tn(Qt){constructor({isHexOnly:e=!0,...t}={}){super(t),this.isHexOnly=e}}Q9.NAME="PrimitiveValueBlock";var Y9;class gl extends Ct{constructor(e={}){super(e,Q9),this.idBlock.isConstructed=!1}}Y9=gl;X.Primitive=Y9;gl.NAME="PRIMITIVE";function OR(n,e){if(n instanceof e)return n;const t=new e;return t.idBlock=n.idBlock,t.lenBlock=n.lenBlock,t.warnings=n.warnings,t.valueBeforeDecodeView=n.valueBeforeDecodeView,t}function Sa(n,e=0,t=n.length){const r=e;let i=new Ct({},Qt);const s=new to;if(!wi(s,n,e,t))return i.error=s.error,{offset:-1,result:i};if(!n.subarray(e,e+t).length)return i.error="Zero buffer length",{offset:-1,result:i};let a=i.idBlock.fromBER(n,e,t);if(i.idBlock.warnings.length&&i.warnings.concat(i.idBlock.warnings),a===-1)return i.error=i.idBlock.error,{offset:-1,result:i};if(e=a,t-=i.idBlock.blockLength,a=i.lenBlock.fromBER(n,e,t),i.lenBlock.warnings.length&&i.warnings.concat(i.lenBlock.warnings),a===-1)return i.error=i.lenBlock.error,{offset:-1,result:i};if(e=a,t-=i.lenBlock.blockLength,!i.idBlock.isConstructed&&i.lenBlock.isIndefiniteForm)return i.error="Indefinite length form used for primitive encoding form",{offset:-1,result:i};let c=Ct;switch(i.idBlock.tagClass){case 1:if(i.idBlock.tagNumber>=37&&i.idBlock.isHexOnly===!1)return i.error="UNIVERSAL 37 and upper tags are reserved by ASN.1 standard",{offset:-1,result:i};switch(i.idBlock.tagNumber){case 0:if(i.idBlock.isConstructed&&i.lenBlock.length>0)return i.error="Type [UNIVERSAL 0] is reserved",{offset:-1,result:i};c=X.EndOfContent;break;case 1:c=X.Boolean;break;case 2:c=X.Integer;break;case 3:c=X.BitString;break;case 4:c=X.OctetString;break;case 5:c=X.Null;break;case 6:c=X.ObjectIdentifier;break;case 10:c=X.Enumerated;break;case 12:c=X.Utf8String;break;case 13:c=X.RelativeObjectIdentifier;break;case 14:c=X.TIME;break;case 15:return i.error="[UNIVERSAL 15] is reserved by ASN.1 standard",{offset:-1,result:i};case 16:c=X.Sequence;break;case 17:c=X.Set;break;case 18:c=X.NumericString;break;case 19:c=X.PrintableString;break;case 20:c=X.TeletexString;break;case 21:c=X.VideotexString;break;case 22:c=X.IA5String;break;case 23:c=X.UTCTime;break;case 24:c=X.GeneralizedTime;break;case 25:c=X.GraphicString;break;case 26:c=X.VisibleString;break;case 27:c=X.GeneralString;break;case 28:c=X.UniversalString;break;case 29:c=X.CharacterString;break;case 30:c=X.BmpString;break;case 31:c=X.DATE;break;case 32:c=X.TimeOfDay;break;case 33:c=X.DateTime;break;case 34:c=X.Duration;break;default:{const u=i.idBlock.isConstructed?new X.Constructed:new X.Primitive;u.idBlock=i.idBlock,u.lenBlock=i.lenBlock,u.warnings=i.warnings,i=u}}break;case 2:case 3:case 4:default:c=i.idBlock.isConstructed?X.Constructed:X.Primitive}return i=OR(i,c),a=i.fromBER(n,e,i.lenBlock.isIndefiniteForm?t:i.lenBlock.length),i.valueBeforeDecodeView=n.subarray(r,r+i.blockLength),{offset:a,result:i}}function ti(n){if(!n.byteLength){const e=new Ct({},Qt);return e.error="Input buffer has zero length",{offset:-1,result:e}}return Sa(H.toUint8Array(n).slice(),0,n.byteLength)}function DR(n,e){return n?1:e}class Vi extends Qt{constructor({value:e=[],isIndefiniteForm:t=!1,...r}={}){super(r),this.value=e,this.isIndefiniteForm=t}fromBER(e,t,r){const i=H.toUint8Array(e);if(!wi(this,i,t,r))return-1;if(this.valueBeforeDecodeView=i.subarray(t,t+r),this.valueBeforeDecodeView.length===0)return this.warnings.push("Zero buffer length"),t;let s=t;for(;DR(this.isIndefiniteForm,r)>0;){const o=Sa(i,s,r);if(o.offset===-1)return this.error=o.result.error,this.warnings.concat(o.result.warnings),-1;if(s=o.offset,this.blockLength+=o.result.blockLength,r-=o.result.blockLength,this.value.push(o.result),this.isIndefiniteForm&&o.result.constructor.NAME===Lc)break}return this.isIndefiniteForm&&(this.value[this.value.length-1].constructor.NAME===Lc?this.value.pop():this.warnings.push("No EndOfContent block encoded")),s}toBER(e,t){const r=t||new Uh;for(let i=0;i<this.value.length;i++)this.value[i].toBER(e,r);return t?dn:r.final()}toJSON(){const e={...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,value:[]};for(const t of this.value)e.value.push(t.toJSON());return e}}Vi.NAME="ConstructedValueBlock";var X9;class qt extends Ct{constructor(e={}){super(e,Vi),this.idBlock.isConstructed=!0}fromBER(e,t,r){this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm;const i=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?r:this.lenBlock.length);return i===-1?(this.error=this.valueBlock.error,i):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),i)}onAsciiEncoding(){const e=[];for(const r of this.valueBlock.value)e.push(r.toString("ascii").split(`
`).map(i=>`  ${i}`).join(`
`));const t=this.idBlock.tagClass===3?`[${this.idBlock.tagNumber}]`:this.constructor.NAME;return e.length?`${t} :
${e.join(`
`)}`:`${t} :`}}X9=qt;X.Constructed=X9;qt.NAME="CONSTRUCTED";class Z9 extends Qt{fromBER(e,t,r){return t}toBER(e){return dn}}Z9.override="EndOfContentValueBlock";var J9;class fg extends Ct{constructor(e={}){super(e,Z9),this.idBlock.tagClass=1,this.idBlock.tagNumber=0}}J9=fg;X.EndOfContent=J9;fg.NAME=Lc;var ew;class di extends Ct{constructor(e={}){super(e,Qt),this.idBlock.tagClass=1,this.idBlock.tagNumber=5}fromBER(e,t,r){return this.lenBlock.length>0&&this.warnings.push("Non-zero length of value block for Null type"),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.blockLength+=r,t+r>e.byteLength?(this.error="End of input reached before message was fully decoded (inconsistent offset and length values)",-1):t+r}toBER(e,t){const r=new ArrayBuffer(2);if(!e){const i=new Uint8Array(r);i[0]=5,i[1]=0}return t&&t.write(r),r}onAsciiEncoding(){return`${this.constructor.NAME}`}}ew=di;X.Null=ew;di.NAME="NULL";class tw extends Tn(Qt){get value(){for(const e of this.valueHexView)if(e>0)return!0;return!1}set value(e){this.valueHexView[0]=e?255:0}constructor({value:e,...t}={}){super(t),t.valueHex?this.valueHexView=H.toUint8Array(t.valueHex):this.valueHexView=new Uint8Array(1),e&&(this.value=e)}fromBER(e,t,r){const i=H.toUint8Array(e);return wi(this,i,t,r)?(this.valueHexView=i.subarray(t,t+r),r>1&&this.warnings.push("Boolean value encoded in more then 1 octet"),this.isHexOnly=!0,z9.call(this),this.blockLength=r,t+r):-1}toBER(){return this.valueHexView.slice()}toJSON(){return{...super.toJSON(),value:this.value}}}tw.NAME="BooleanValueBlock";var rw;let $h=class extends Ct{getValue(){return this.valueBlock.value}setValue(e){this.valueBlock.value=e}constructor(e={}){super(e,tw),this.idBlock.tagClass=1,this.idBlock.tagNumber=1}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.getValue}`}};rw=$h;X.Boolean=rw;$h.NAME="BOOLEAN";class nw extends Tn(Vi){constructor({isConstructed:e=!1,...t}={}){super(t),this.isConstructed=e}fromBER(e,t,r){let i=0;if(this.isConstructed){if(this.isHexOnly=!1,i=Vi.prototype.fromBER.call(this,e,t,r),i===-1)return i;for(let s=0;s<this.value.length;s++){const o=this.value[s].constructor.NAME;if(o===Lc){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, OCTET STRING may consists of OCTET STRINGs only",-1}if(o!==K9)return this.error="OCTET STRING may consists of OCTET STRINGs only",-1}}else this.isHexOnly=!0,i=super.fromBER(e,t,r),this.blockLength=r;return i}toBER(e,t){return this.isConstructed?Vi.prototype.toBER.call(this,e,t):e?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),isConstructed:this.isConstructed}}}nw.NAME="OctetStringValueBlock";var pg;let Yr=class extends Ct{constructor({idBlock:e={},lenBlock:t={},...r}={}){var i,s;(i=r.isConstructed)!==null&&i!==void 0||(r.isConstructed=!!(!((s=r.value)===null||s===void 0)&&s.length)),super({idBlock:{isConstructed:r.isConstructed,...e},lenBlock:{...t,isIndefiniteForm:!!r.isIndefiniteForm},...r},nw),this.idBlock.tagClass=1,this.idBlock.tagNumber=4}fromBER(e,t,r){if(this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,r===0)return this.idBlock.error.length===0&&(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length===0&&(this.blockLength+=this.lenBlock.blockLength),t;if(!this.valueBlock.isConstructed){const s=(e instanceof ArrayBuffer?new Uint8Array(e):e).subarray(t,t+r);try{if(s.byteLength){const o=Sa(s,0,s.byteLength);o.offset!==-1&&o.offset===r&&(this.valueBlock.value=[o.result])}}catch{}}return super.fromBER(e,t,r)}onAsciiEncoding(){if(this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length)return qt.prototype.onAsciiEncoding.call(this);const e=this.constructor.NAME,t=ee.ToHex(this.valueBlock.valueHexView);return`${e} : ${t}`}getValue(){if(!this.idBlock.isConstructed)return this.valueBlock.valueHexView.slice().buffer;const e=[];for(const t of this.valueBlock.value)t instanceof pg&&e.push(t.valueBlock.valueHexView);return H.concat(e)}};pg=Yr;X.OctetString=pg;Yr.NAME=K9;class iw extends Tn(Vi){constructor({unusedBits:e=0,isConstructed:t=!1,...r}={}){super(r),this.unusedBits=e,this.isConstructed=t,this.blockLength=this.valueHexView.byteLength}fromBER(e,t,r){if(!r)return t;let i=-1;if(this.isConstructed){if(i=Vi.prototype.fromBER.call(this,e,t,r),i===-1)return i;for(const a of this.value){const c=a.constructor.NAME;if(c===Lc){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, BIT STRING may consists of BIT STRINGs only",-1}if(c!==q9)return this.error="BIT STRING may consists of BIT STRINGs only",-1;const u=a.valueBlock;if(this.unusedBits>0&&u.unusedBits>0)return this.error='Using of "unused bits" inside constructive BIT STRING allowed for least one only',-1;this.unusedBits=u.unusedBits}return i}const s=H.toUint8Array(e);if(!wi(this,s,t,r))return-1;const o=s.subarray(t,t+r);if(this.unusedBits=o[0],this.unusedBits>7)return this.error="Unused bits for BitString must be in range 0-7",-1;if(!this.unusedBits){const a=o.subarray(1);try{if(a.byteLength){const c=Sa(a,0,a.byteLength);c.offset!==-1&&c.offset===r-1&&(this.value=[c.result])}}catch{}}return this.valueHexView=o.subarray(1),this.blockLength=o.length,t+r}toBER(e,t){if(this.isConstructed)return Vi.prototype.toBER.call(this,e,t);if(e)return new ArrayBuffer(this.valueHexView.byteLength+1);if(!this.valueHexView.byteLength)return dn;const r=new Uint8Array(this.valueHexView.length+1);return r[0]=this.unusedBits,r.set(this.valueHexView,1),r.buffer}toJSON(){return{...super.toJSON(),unusedBits:this.unusedBits,isConstructed:this.isConstructed}}}iw.NAME="BitStringValueBlock";var sw;let Is=class extends Ct{constructor({idBlock:e={},lenBlock:t={},...r}={}){var i,s;(i=r.isConstructed)!==null&&i!==void 0||(r.isConstructed=!!(!((s=r.value)===null||s===void 0)&&s.length)),super({idBlock:{isConstructed:r.isConstructed,...e},lenBlock:{...t,isIndefiniteForm:!!r.isIndefiniteForm},...r},iw),this.idBlock.tagClass=1,this.idBlock.tagNumber=3}fromBER(e,t,r){return this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,super.fromBER(e,t,r)}onAsciiEncoding(){if(this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length)return qt.prototype.onAsciiEncoding.call(this);{const e=[],t=this.valueBlock.valueHexView;for(const o of t)e.push(o.toString(2).padStart(8,"0"));const r=e.join(""),i=this.constructor.NAME,s=r.substring(0,r.length-this.valueBlock.unusedBits);return`${i} : ${s}`}}};sw=Is;X.BitString=sw;Is.NAME=q9;var ow;function NR(n,e){const t=new Uint8Array([0]),r=new Uint8Array(n),i=new Uint8Array(e);let s=r.slice(0);const o=s.length-1,a=i.slice(0),c=a.length-1;let u=0;const d=c<o?o:c;let h=0;for(let f=d;f>=0;f--,h++){switch(!0){case h<a.length:u=s[o-h]+a[c-h]+t[0];break;default:u=s[o-h]+t[0]}switch(t[0]=u/10,!0){case h>=s.length:s=E0(new Uint8Array([u%10]),s);break;default:s[o-h]=u%10}}return t[0]>0&&(s=E0(t,s)),s}function jm(n){if(n>=$a.length)for(let e=$a.length;e<=n;e++){const t=new Uint8Array([0]);let r=$a[e-1].slice(0);for(let i=r.length-1;i>=0;i--){const s=new Uint8Array([(r[i]<<1)+t[0]]);t[0]=s[0]/10,r[i]=s[0]%10}t[0]>0&&(r=E0(t,r)),$a.push(r)}return $a[n]}function LR(n,e){let t=0;const r=new Uint8Array(n),i=new Uint8Array(e),s=r.slice(0),o=s.length-1,a=i.slice(0),c=a.length-1;let u,d=0;for(let h=c;h>=0;h--,d++)switch(u=s[o-d]-a[c-d]-t,!0){case u<0:t=1,s[o-d]=u+10;break;default:t=0,s[o-d]=u}if(t>0)for(let h=o-c+1;h>=0;h--,d++)if(u=s[o-d]-t,u<0)t=1,s[o-d]=u+10;else{t=0,s[o-d]=u;break}return s.slice()}class gg extends Tn(Qt){setValueHex(){this.valueHexView.length>=4?(this.warnings.push("Too big Integer for decoding, hex only"),this.isHexOnly=!0,this._valueDec=0):(this.isHexOnly=!1,this.valueHexView.length>0&&(this._valueDec=z9.call(this)))}constructor({value:e,...t}={}){super(t),this._valueDec=0,t.valueHex&&this.setValueHex(),e!==void 0&&(this.valueDec=e)}set valueDec(e){this._valueDec=e,this.isHexOnly=!1,this.valueHexView=new Uint8Array(ER(e))}get valueDec(){return this._valueDec}fromDER(e,t,r,i=0){const s=this.fromBER(e,t,r);if(s===-1)return s;const o=this.valueHexView;return o[0]===0&&o[1]&128?this.valueHexView=o.subarray(1):i!==0&&o.length<i&&(i-o.length>1&&(i=o.length+1),this.valueHexView=o.subarray(i-o.length)),s}toDER(e=!1){const t=this.valueHexView;switch(!0){case(t[0]&128)!==0:{const r=new Uint8Array(this.valueHexView.length+1);r[0]=0,r.set(t,1),this.valueHexView=r}break;case(t[0]===0&&(t[1]&128)===0):this.valueHexView=this.valueHexView.subarray(1);break}return this.toBER(e)}fromBER(e,t,r){const i=super.fromBER(e,t,r);return i===-1||this.setValueHex(),i}toBER(e){return e?new ArrayBuffer(this.valueHexView.length):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}toString(){const e=this.valueHexView.length*8-1;let t=new Uint8Array(this.valueHexView.length*8/3),r=0,i;const s=this.valueHexView;let o="",a=!1;for(let c=s.byteLength-1;c>=0;c--){i=s[c];for(let u=0;u<8;u++){if((i&1)===1)switch(r){case e:t=LR(jm(r),t),o="-";break;default:t=NR(t,jm(r))}r++,i>>=1}}for(let c=0;c<t.length;c++)t[c]&&(a=!0),a&&(o+=Wm.charAt(t[c]));return a===!1&&(o+=Wm.charAt(0)),o}}ow=gg;gg.NAME="IntegerValueBlock";Object.defineProperty(ow.prototype,"valueHex",{set:function(n){this.valueHexView=new Uint8Array(n),this.setValueHex()},get:function(){return this.valueHexView.slice().buffer}});var ic;class ri extends Ct{constructor(e={}){super(e,gg),this.idBlock.tagClass=1,this.idBlock.tagNumber=2}toBigInt(){return dd(),BigInt(this.valueBlock.toString())}static fromBigInt(e){dd();const t=BigInt(e),r=new Uh,i=t.toString(16).replace(/^-/,""),s=new Uint8Array(ee.FromHex(i));if(t<0){const a=new Uint8Array(s.length+(s[0]&128?1:0));a[0]|=128;const u=BigInt(`0x${ee.ToHex(a)}`)+t,d=H.toUint8Array(ee.FromHex(u.toString(16)));d[0]|=128,r.write(d)}else s[0]&128&&r.write(new Uint8Array([0])),r.write(s);return new ic({valueHex:r.final()})}convertToDER(){const e=new ic({valueHex:this.valueBlock.valueHexView});return e.valueBlock.toDER(),e}convertFromDER(){return new ic({valueHex:this.valueBlock.valueHexView[0]===0?this.valueBlock.valueHexView.subarray(1):this.valueBlock.valueHexView})}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()}`}}ic=ri;X.Integer=ic;ri.NAME="INTEGER";var aw;class Hh extends ri{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=10}}aw=Hh;X.Enumerated=aw;Hh.NAME="ENUMERATED";class x0 extends Tn(Qt){constructor({valueDec:e=-1,isFirstSid:t=!1,...r}={}){super(r),this.valueDec=e,this.isFirstSid=t}fromBER(e,t,r){if(!r)return t;const i=H.toUint8Array(e);if(!wi(this,i,t,r))return-1;const s=i.subarray(t,t+r);this.valueHexView=new Uint8Array(r);for(let a=0;a<r&&(this.valueHexView[a]=s[a]&127,this.blockLength++,!!(s[a]&128));a++);const o=new Uint8Array(this.blockLength);for(let a=0;a<this.blockLength;a++)o[a]=this.valueHexView[a];return this.valueHexView=o,s[this.blockLength-1]&128?(this.error="End of input reached before message was fully decoded",-1):(this.valueHexView[0]===0&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=Yo(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),t+this.blockLength)}set valueBigInt(e){dd();let t=BigInt(e).toString(2);for(;t.length%7;)t="0"+t;const r=new Uint8Array(t.length/7);for(let i=0;i<r.length;i++)r[i]=parseInt(t.slice(i*7,i*7+7),2)+(i+1<r.length?128:0);this.fromBER(r.buffer,0,r.length)}toBER(e){if(this.isHexOnly){if(e)return new ArrayBuffer(this.valueHexView.byteLength);const i=this.valueHexView,s=new Uint8Array(this.blockLength);for(let o=0;o<this.blockLength-1;o++)s[o]=i[o]|128;return s[this.blockLength-1]=i[this.blockLength-1],s.buffer}const t=Ls(this.valueDec,7);if(t.byteLength===0)return this.error="Error during encoding SID value",dn;const r=new Uint8Array(t.byteLength);if(!e){const i=new Uint8Array(t),s=t.byteLength-1;for(let o=0;o<s;o++)r[o]=i[o]|128;r[s]=i[s]}return r}toString(){let e="";if(this.isHexOnly)e=ee.ToHex(this.valueHexView);else if(this.isFirstSid){let t=this.valueDec;this.valueDec<=39?e="0.":this.valueDec<=79?(e="1.",t-=40):(e="2.",t-=80),e+=t.toString()}else e=this.valueDec.toString();return e}toJSON(){return{...super.toJSON(),valueDec:this.valueDec,isFirstSid:this.isFirstSid}}}x0.NAME="sidBlock";class cw extends Qt{constructor({value:e=Jt,...t}={}){super(t),this.value=[],e&&this.fromString(e)}fromBER(e,t,r){let i=t;for(;r>0;){const s=new x0;if(i=s.fromBER(e,i,r),i===-1)return this.blockLength=0,this.error=s.error,i;this.value.length===0&&(s.isFirstSid=!0),this.blockLength+=s.blockLength,r-=s.blockLength,this.value.push(s)}return i}toBER(e){const t=[];for(let r=0;r<this.value.length;r++){const i=this.value[r].toBER(e);if(i.byteLength===0)return this.error=this.value[r].error,dn;t.push(i)}return dg(t)}fromString(e){this.value=[];let t=0,r=0,i="",s=!1;do if(r=e.indexOf(".",t),r===-1?i=e.substring(t):i=e.substring(t,r),t=r+1,s){const o=this.value[0];let a=0;switch(o.valueDec){case 0:break;case 1:a=40;break;case 2:a=80;break;default:this.value=[];return}const c=parseInt(i,10);if(isNaN(c))return;o.valueDec=c+a,s=!1}else{const o=new x0;if(i>Number.MAX_SAFE_INTEGER){dd();const a=BigInt(i);o.valueBigInt=a}else if(o.valueDec=parseInt(i,10),isNaN(o.valueDec))return;this.value.length||(o.isFirstSid=!0,s=!0),this.value.push(o)}while(r!==-1)}toString(){let e="",t=!1;for(let r=0;r<this.value.length;r++){t=this.value[r].isHexOnly;let i=this.value[r].toString();r!==0&&(e=`${e}.`),t?(i=`{${i}}`,this.value[r].isFirstSid?e=`2.{${i} - 80}`:e+=i):e+=i}return e}toJSON(){const e={...super.toJSON(),value:this.toString(),sidArray:[]};for(let t=0;t<this.value.length;t++)e.sidArray.push(this.value[t].toJSON());return e}}cw.NAME="ObjectIdentifierValueBlock";var lw;class $n extends Ct{getValue(){return this.valueBlock.toString()}setValue(e){this.valueBlock.fromString(e)}constructor(e={}){super(e,cw),this.idBlock.tagClass=1,this.idBlock.tagNumber=6}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}}lw=$n;X.ObjectIdentifier=lw;$n.NAME="OBJECT IDENTIFIER";class A0 extends Tn(to){constructor({valueDec:e=0,...t}={}){super(t),this.valueDec=e}fromBER(e,t,r){if(r===0)return t;const i=H.toUint8Array(e);if(!wi(this,i,t,r))return-1;const s=i.subarray(t,t+r);this.valueHexView=new Uint8Array(r);for(let a=0;a<r&&(this.valueHexView[a]=s[a]&127,this.blockLength++,!!(s[a]&128));a++);const o=new Uint8Array(this.blockLength);for(let a=0;a<this.blockLength;a++)o[a]=this.valueHexView[a];return this.valueHexView=o,s[this.blockLength-1]&128?(this.error="End of input reached before message was fully decoded",-1):(this.valueHexView[0]===0&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=Yo(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),t+this.blockLength)}toBER(e){if(this.isHexOnly){if(e)return new ArrayBuffer(this.valueHexView.byteLength);const i=this.valueHexView,s=new Uint8Array(this.blockLength);for(let o=0;o<this.blockLength-1;o++)s[o]=i[o]|128;return s[this.blockLength-1]=i[this.blockLength-1],s.buffer}const t=Ls(this.valueDec,7);if(t.byteLength===0)return this.error="Error during encoding SID value",dn;const r=new Uint8Array(t.byteLength);if(!e){const i=new Uint8Array(t),s=t.byteLength-1;for(let o=0;o<s;o++)r[o]=i[o]|128;r[s]=i[s]}return r.buffer}toString(){let e="";return this.isHexOnly?e=ee.ToHex(this.valueHexView):e=this.valueDec.toString(),e}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}}A0.NAME="relativeSidBlock";class uw extends Qt{constructor({value:e=Jt,...t}={}){super(t),this.value=[],e&&this.fromString(e)}fromBER(e,t,r){let i=t;for(;r>0;){const s=new A0;if(i=s.fromBER(e,i,r),i===-1)return this.blockLength=0,this.error=s.error,i;this.blockLength+=s.blockLength,r-=s.blockLength,this.value.push(s)}return i}toBER(e,t){const r=[];for(let i=0;i<this.value.length;i++){const s=this.value[i].toBER(e);if(s.byteLength===0)return this.error=this.value[i].error,dn;r.push(s)}return dg(r)}fromString(e){this.value=[];let t=0,r=0,i="";do{r=e.indexOf(".",t),r===-1?i=e.substring(t):i=e.substring(t,r),t=r+1;const s=new A0;if(s.valueDec=parseInt(i,10),isNaN(s.valueDec))return!0;this.value.push(s)}while(r!==-1);return!0}toString(){let e="",t=!1;for(let r=0;r<this.value.length;r++){t=this.value[r].isHexOnly;let i=this.value[r].toString();r!==0&&(e=`${e}.`),t&&(i=`{${i}}`),e+=i}return e}toJSON(){const e={...super.toJSON(),value:this.toString(),sidArray:[]};for(let t=0;t<this.value.length;t++)e.sidArray.push(this.value[t].toJSON());return e}}uw.NAME="RelativeObjectIdentifierValueBlock";var dw;class mg extends Ct{getValue(){return this.valueBlock.toString()}setValue(e){this.valueBlock.fromString(e)}constructor(e={}){super(e,uw),this.idBlock.tagClass=1,this.idBlock.tagNumber=13}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}}dw=mg;X.RelativeObjectIdentifier=dw;mg.NAME="RelativeObjectIdentifier";var hw;class lt extends qt{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=16}}hw=lt;X.Sequence=hw;lt.NAME="SEQUENCE";var fw;let kn=class extends qt{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=17}};fw=kn;X.Set=fw;kn.NAME="SET";class pw extends Tn(Qt){constructor({...e}={}){super(e),this.isHexOnly=!0,this.value=Jt}toJSON(){return{...super.toJSON(),value:this.value}}}pw.NAME="StringValueBlock";class gw extends pw{}gw.NAME="SimpleStringValueBlock";class Sr extends hg{constructor({...e}={}){super(e,gw)}fromBuffer(e){this.valueBlock.value=String.fromCharCode.apply(null,H.toUint8Array(e))}fromString(e){const t=e.length,r=this.valueBlock.valueHexView=new Uint8Array(t);for(let i=0;i<t;i++)r[i]=e.charCodeAt(i);this.valueBlock.value=e}}Sr.NAME="SIMPLE STRING";class mw extends Sr{fromBuffer(e){this.valueBlock.valueHexView=H.toUint8Array(e);try{this.valueBlock.value=ee.ToUtf8String(e)}catch(t){this.warnings.push(`Error during "decodeURIComponent": ${t}, using raw string`),this.valueBlock.value=ee.ToBinary(e)}}fromString(e){this.valueBlock.valueHexView=new Uint8Array(ee.FromUtf8String(e)),this.valueBlock.value=e}}mw.NAME="Utf8StringValueBlock";var yw;class bi extends mw{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=12}}yw=bi;X.Utf8String=yw;bi.NAME="UTF8String";class ww extends Sr{fromBuffer(e){this.valueBlock.value=ee.ToUtf16String(e),this.valueBlock.valueHexView=H.toUint8Array(e)}fromString(e){this.valueBlock.value=e,this.valueBlock.valueHexView=new Uint8Array(ee.FromUtf16String(e))}}ww.NAME="BmpStringValueBlock";var bw;class Vh extends ww{constructor({...e}={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=30}}bw=Vh;X.BmpString=bw;Vh.NAME="BMPString";class vw extends Sr{fromBuffer(e){const t=ArrayBuffer.isView(e)?e.slice().buffer:e.slice(0),r=new Uint8Array(t);for(let i=0;i<r.length;i+=4)r[i]=r[i+3],r[i+1]=r[i+2],r[i+2]=0,r[i+3]=0;this.valueBlock.value=String.fromCharCode.apply(null,new Uint32Array(t))}fromString(e){const t=e.length,r=this.valueBlock.valueHexView=new Uint8Array(t*4);for(let i=0;i<t;i++){const s=Ls(e.charCodeAt(i),8),o=new Uint8Array(s);if(o.length>4)continue;const a=4-o.length;for(let c=o.length-1;c>=0;c--)r[i*4+c+a]=o[c]}this.valueBlock.value=e}}vw.NAME="UniversalStringValueBlock";var Sw;class zh extends vw{constructor({...e}={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=28}}Sw=zh;X.UniversalString=Sw;zh.NAME="UniversalString";var Ew;class Kh extends Sr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=18}}Ew=Kh;X.NumericString=Ew;Kh.NAME="NumericString";var xw;class qh extends Sr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=19}}xw=qh;X.PrintableString=xw;qh.NAME="PrintableString";var Aw;class Wh extends Sr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=20}}Aw=Wh;X.TeletexString=Aw;Wh.NAME="TeletexString";var kw;class Gh extends Sr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=21}}kw=Gh;X.VideotexString=kw;Gh.NAME="VideotexString";var _w;class jh extends Sr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=22}}_w=jh;X.IA5String=_w;jh.NAME="IA5String";var Iw;class Qh extends Sr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=25}}Iw=Qh;X.GraphicString=Iw;Qh.NAME="GraphicString";var Cw;class ml extends Sr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=26}}Cw=ml;X.VisibleString=Cw;ml.NAME="VisibleString";var Tw;class Yh extends Sr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=27}}Tw=Yh;X.GeneralString=Tw;Yh.NAME="GeneralString";var Rw;class Xh extends Sr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=29}}Rw=Xh;X.CharacterString=Rw;Xh.NAME="CharacterString";var Pw;class yl extends ml{constructor({value:e,valueDate:t,...r}={}){if(super(r),this.year=0,this.month=0,this.day=0,this.hour=0,this.minute=0,this.second=0,e){this.fromString(e),this.valueBlock.valueHexView=new Uint8Array(e.length);for(let i=0;i<e.length;i++)this.valueBlock.valueHexView[i]=e.charCodeAt(i)}t&&(this.fromDate(t),this.valueBlock.valueHexView=new Uint8Array(this.toBuffer())),this.idBlock.tagClass=1,this.idBlock.tagNumber=23}fromBuffer(e){this.fromString(String.fromCharCode.apply(null,H.toUint8Array(e)))}toBuffer(){const e=this.toString(),t=new ArrayBuffer(e.length),r=new Uint8Array(t);for(let i=0;i<e.length;i++)r[i]=e.charCodeAt(i);return t}fromDate(e){this.year=e.getUTCFullYear(),this.month=e.getUTCMonth()+1,this.day=e.getUTCDate(),this.hour=e.getUTCHours(),this.minute=e.getUTCMinutes(),this.second=e.getUTCSeconds()}toDate(){return new Date(Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second))}fromString(e){const r=/(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})Z/ig.exec(e);if(r===null){this.error="Wrong input string for conversion";return}const i=parseInt(r[1],10);i>=50?this.year=1900+i:this.year=2e3+i,this.month=parseInt(r[2],10),this.day=parseInt(r[3],10),this.hour=parseInt(r[4],10),this.minute=parseInt(r[5],10),this.second=parseInt(r[6],10)}toString(e="iso"){if(e==="iso"){const t=new Array(7);return t[0]=fr(this.year<2e3?this.year-1900:this.year-2e3,2),t[1]=fr(this.month,2),t[2]=fr(this.day,2),t[3]=fr(this.hour,2),t[4]=fr(this.minute,2),t[5]=fr(this.second,2),t[6]="Z",t.join("")}return super.toString(e)}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.toDate().toISOString()}`}toJSON(){return{...super.toJSON(),year:this.year,month:this.month,day:this.day,hour:this.hour,minute:this.minute,second:this.second}}}Pw=yl;X.UTCTime=Pw;yl.NAME="UTCTime";var Ow;class Zh extends yl{constructor(e={}){var t;super(e),(t=this.millisecond)!==null&&t!==void 0||(this.millisecond=0),this.idBlock.tagClass=1,this.idBlock.tagNumber=24}fromDate(e){super.fromDate(e),this.millisecond=e.getUTCMilliseconds()}toDate(){const e=Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second,this.millisecond);return new Date(e)}fromString(e){let t=!1,r="",i="",s=0,o,a=0,c=0;if(e[e.length-1]==="Z")r=e.substring(0,e.length-1),t=!0;else{const h=new Number(e[e.length-1]);if(isNaN(h.valueOf()))throw new Error("Wrong input string for conversion");r=e}if(t){if(r.indexOf("+")!==-1)throw new Error("Wrong input string for conversion");if(r.indexOf("-")!==-1)throw new Error("Wrong input string for conversion")}else{let h=1,f=r.indexOf("+"),p="";if(f===-1&&(f=r.indexOf("-"),h=-1),f!==-1){if(p=r.substring(f+1),r=r.substring(0,f),p.length!==2&&p.length!==4)throw new Error("Wrong input string for conversion");let m=parseInt(p.substring(0,2),10);if(isNaN(m.valueOf()))throw new Error("Wrong input string for conversion");if(a=h*m,p.length===4){if(m=parseInt(p.substring(2,4),10),isNaN(m.valueOf()))throw new Error("Wrong input string for conversion");c=h*m}}}let u=r.indexOf(".");if(u===-1&&(u=r.indexOf(",")),u!==-1){const h=new Number(`0${r.substring(u)}`);if(isNaN(h.valueOf()))throw new Error("Wrong input string for conversion");s=h.valueOf(),i=r.substring(0,u)}else i=r;switch(!0){case i.length===8:if(o=/(\d{4})(\d{2})(\d{2})/ig,u!==-1)throw new Error("Wrong input string for conversion");break;case i.length===10:if(o=/(\d{4})(\d{2})(\d{2})(\d{2})/ig,u!==-1){let h=60*s;this.minute=Math.floor(h),h=60*(h-this.minute),this.second=Math.floor(h),h=1e3*(h-this.second),this.millisecond=Math.floor(h)}break;case i.length===12:if(o=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})/ig,u!==-1){let h=60*s;this.second=Math.floor(h),h=1e3*(h-this.second),this.millisecond=Math.floor(h)}break;case i.length===14:if(o=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/ig,u!==-1){const h=1e3*s;this.millisecond=Math.floor(h)}break;default:throw new Error("Wrong input string for conversion")}const d=o.exec(i);if(d===null)throw new Error("Wrong input string for conversion");for(let h=1;h<d.length;h++)switch(h){case 1:this.year=parseInt(d[h],10);break;case 2:this.month=parseInt(d[h],10);break;case 3:this.day=parseInt(d[h],10);break;case 4:this.hour=parseInt(d[h],10)+a;break;case 5:this.minute=parseInt(d[h],10)+c;break;case 6:this.second=parseInt(d[h],10);break;default:throw new Error("Wrong input string for conversion")}if(t===!1){const h=new Date(this.year,this.month,this.day,this.hour,this.minute,this.second,this.millisecond);this.year=h.getUTCFullYear(),this.month=h.getUTCMonth(),this.day=h.getUTCDay(),this.hour=h.getUTCHours(),this.minute=h.getUTCMinutes(),this.second=h.getUTCSeconds(),this.millisecond=h.getUTCMilliseconds()}}toString(e="iso"){if(e==="iso"){const t=[];return t.push(fr(this.year,4)),t.push(fr(this.month,2)),t.push(fr(this.day,2)),t.push(fr(this.hour,2)),t.push(fr(this.minute,2)),t.push(fr(this.second,2)),this.millisecond!==0&&(t.push("."),t.push(fr(this.millisecond,3))),t.push("Z"),t.join("")}return super.toString(e)}toJSON(){return{...super.toJSON(),millisecond:this.millisecond}}}Ow=Zh;X.GeneralizedTime=Ow;Zh.NAME="GeneralizedTime";var Dw;class yg extends bi{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=31}}Dw=yg;X.DATE=Dw;yg.NAME="DATE";var Nw;class wg extends bi{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=32}}Nw=wg;X.TimeOfDay=Nw;wg.NAME="TimeOfDay";var Lw;class bg extends bi{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=33}}Lw=bg;X.DateTime=Lw;bg.NAME="DateTime";var Bw;class vg extends bi{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=34}}Bw=vg;X.Duration=Bw;vg.NAME="Duration";var Mw;class Sg extends bi{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=14}}Mw=Sg;X.TIME=Mw;Sg.NAME="TIME";class Bs{constructor({name:e=Jt,optional:t=!1}={}){this.name=e,this.optional=t}}class Eg extends Bs{constructor({value:e=[],...t}={}){super(t),this.value=e}}class hd extends Bs{constructor({value:e=new Bs,local:t=!1,...r}={}){super(r),this.value=e,this.local=t}}class BR{get data(){return this.dataView.slice().buffer}set data(e){this.dataView=H.toUint8Array(e)}constructor({data:e=Fh}={}){this.dataView=H.toUint8Array(e)}fromBER(e,t,r){const i=t+r;return this.dataView=H.toUint8Array(e).subarray(t,i),i}toBER(e){return this.dataView.slice().buffer}}function Ni(n,e,t){if(t instanceof Eg){for(const s of t.value)if(Ni(n,e,s).verified)return{verified:!0,result:n};{const s={verified:!1,result:{error:"Wrong values for Choice type"}};return t.hasOwnProperty(df)&&(s.name=t.name),s}}if(t instanceof Bs)return t.hasOwnProperty(df)&&(n[t.name]=e),{verified:!0,result:n};if(!(n instanceof Object))return{verified:!1,result:{error:"Wrong root object"}};if(!(e instanceof Object))return{verified:!1,result:{error:"Wrong ASN.1 data"}};if(!(t instanceof Object))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(!(kR in t))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(!(TR in t.idBlock))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(!(RR in t.idBlock))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};const r=t.idBlock.toBER(!1);if(r.byteLength===0)return{verified:!1,result:{error:"Error encoding idBlock for ASN.1 schema"}};if(t.idBlock.fromBER(r,0,r.byteLength)===-1)return{verified:!1,result:{error:"Error decoding idBlock for ASN.1 schema"}};if(t.idBlock.hasOwnProperty(_R)===!1)return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(t.idBlock.tagClass!==e.idBlock.tagClass)return{verified:!1,result:n};if(t.idBlock.hasOwnProperty(IR)===!1)return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(t.idBlock.tagNumber!==e.idBlock.tagNumber)return{verified:!1,result:n};if(t.idBlock.hasOwnProperty(CR)===!1)return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(t.idBlock.isConstructed!==e.idBlock.isConstructed)return{verified:!1,result:n};if(!(AR in t.idBlock))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(t.idBlock.isHexOnly!==e.idBlock.isHexOnly)return{verified:!1,result:n};if(t.idBlock.isHexOnly){if(!(Gm in t.idBlock))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};const s=t.idBlock.valueHexView,o=e.idBlock.valueHexView;if(s.length!==o.length)return{verified:!1,result:n};for(let a=0;a<s.length;a++)if(s[a]!==o[1])return{verified:!1,result:n}}if(t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,Jt),t.name&&(n[t.name]=e)),t instanceof X.Constructed){let s=0,o={verified:!1,result:{error:"Unknown error"}},a=t.valueBlock.value.length;if(a>0&&t.valueBlock.value[0]instanceof hd&&(a=e.valueBlock.value.length),a===0)return{verified:!0,result:n};if(e.valueBlock.value.length===0&&t.valueBlock.value.length!==0){let c=!0;for(let u=0;u<t.valueBlock.value.length;u++)c=c&&(t.valueBlock.value[u].optional||!1);return c?{verified:!0,result:n}:(t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,Jt),t.name&&delete n[t.name]),n.error="Inconsistent object length",{verified:!1,result:n})}for(let c=0;c<a;c++)if(c-s>=e.valueBlock.value.length){if(t.valueBlock.value[c].optional===!1){const u={verified:!1,result:n};return n.error="Inconsistent length between ASN.1 data and schema",t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,Jt),t.name&&(delete n[t.name],u.name=t.name)),u}}else if(t.valueBlock.value[0]instanceof hd){if(o=Ni(n,e.valueBlock.value[c],t.valueBlock.value[0].value),o.verified===!1)if(t.valueBlock.value[0].optional)s++;else return t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,Jt),t.name&&delete n[t.name]),o;if(df in t.valueBlock.value[0]&&t.valueBlock.value[0].name.length>0){let u={};PR in t.valueBlock.value[0]&&t.valueBlock.value[0].local?u=e:u=n,typeof u[t.valueBlock.value[0].name]>"u"&&(u[t.valueBlock.value[0].name]=[]),u[t.valueBlock.value[0].name].push(e.valueBlock.value[c])}}else if(o=Ni(n,e.valueBlock.value[c-s],t.valueBlock.value[c]),o.verified===!1)if(t.valueBlock.value[c].optional)s++;else return t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,Jt),t.name&&delete n[t.name]),o;if(o.verified===!1){const c={verified:!1,result:n};return t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,Jt),t.name&&(delete n[t.name],c.name=t.name)),c}return{verified:!0,result:n}}if(t.primitiveSchema&&Gm in e.valueBlock){const s=Sa(e.valueBlock.valueHexView);if(s.offset===-1){const o={verified:!1,result:s.result};return t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,Jt),t.name&&(delete n[t.name],o.name=t.name)),o}return Ni(n,s.result,t.primitiveSchema)}return{verified:!0,result:n}}function MR(n,e){if(!(e instanceof Object))return{verified:!1,result:{error:"Wrong ASN.1 schema type"}};const t=Sa(H.toUint8Array(n));return t.offset===-1?{verified:!1,result:t.result}:Ni(t.result,t.result,e)}const Uw=Object.freeze(Object.defineProperty({__proto__:null,Any:Bs,BaseBlock:Ct,BaseStringBlock:hg,BitString:Is,BmpString:Vh,Boolean:$h,CharacterString:Xh,Choice:Eg,Constructed:qt,DATE:yg,DateTime:bg,Duration:vg,EndOfContent:fg,Enumerated:Hh,GeneralString:Yh,GeneralizedTime:Zh,GraphicString:Qh,HexBlock:Tn,IA5String:jh,Integer:ri,Null:di,NumericString:Kh,ObjectIdentifier:$n,OctetString:Yr,Primitive:gl,PrintableString:qh,RawData:BR,RelativeObjectIdentifier:mg,Repeated:hd,Sequence:lt,Set:kn,TIME:Sg,TeletexString:Wh,TimeOfDay:wg,UTCTime:yl,UniversalString:zh,Utf8String:bi,ValueBlock:Qt,VideotexString:Gh,ViewWriter:Uh,VisibleString:ml,compareSchema:Ni,fromBER:ti,verifySchema:MR},Symbol.toStringTag,{value:"Module"})),UR=16,k0=32,_0=1e4;async function Jh(n,e){const r=await H9().encrypt(n,e);return Zn.encode(r)}async function Qm(n,e,t){if(n.type==="RSA")return VR(n,e,t);if(n.type==="Ed25519")return FR(n,e,t);if(n.type==="secp256k1")return $R(n,e,t);if(n.type==="ECDSA")return HR(n,e,t);throw new Zs}async function FR(n,e,t="libp2p-key"){if(t==="libp2p-key")return Jh(dl(n),e);throw new O(`export format '${t}' is not supported`)}async function $R(n,e,t="libp2p-key"){if(t==="libp2p-key")return Jh(dl(n),e);throw new O("Export format is not supported")}async function HR(n,e,t="libp2p-key"){if(t==="libp2p-key")return Jh(dl(n),e);throw new O(`export format '${t}' is not supported`)}async function VR(n,e,t="pkcs-8"){if(t==="pkcs-8")return zR(n,e);if(t==="libp2p-key")return Jh(dl(n),e);throw new O("Export format is not supported")}async function zR(n,e){const t=Gt.get(),i=new lt({value:[new ri({value:0}),new lt({value:[new $n({value:"1.2.840.113549.1.1.1"}),new di]}),new Yr({valueHex:n.raw})]}).toBER(),s=new Uint8Array(i,0,i.byteLength),o=Os(UR),a=await Q8(Jp,e,o,{c:_0,dkLen:k0}),c=Os(16),u=await t.subtle.importKey("raw",a,"AES-CBC",!1,["encrypt"]),d=await t.subtle.encrypt({name:"AES-CBC",iv:c},u,s),h=new lt({value:[new Yr({valueHex:o}),new ri({value:_0}),new ri({value:k0}),new lt({value:[new $n({value:"1.2.840.113549.2.11"}),new di]})]}),f=new lt({value:[new $n({value:"1.2.840.113549.1.5.13"}),new lt({value:[new lt({value:[new $n({value:"1.2.840.113549.1.5.12"}),h]}),new lt({value:[new $n({value:"2.16.840.1.101.3.4.1.42"}),new Yr({valueHex:c})]})]})]}),m=new lt({value:[f,new Yr({valueHex:d})]}).toBER(),w=new Uint8Array(m,0,m.byteLength);return["-----BEGIN ENCRYPTED PRIVATE KEY-----",...U(w,"base64pad").split(/(.{64})/).filter(Boolean),"-----END ENCRYPTED PRIVATE KEY-----"].join(`
`)}async function Ym(n,e){try{const t=await KR(n,e);return _A(t)}catch{}if(!n.includes("BEGIN"))throw new O("Encrypted key was not a libp2p-key or a PEM file");return qR(n,e)}async function KR(n,e){const t=Zn.decode(n);return H9().decrypt(t,e)}async function qR(n,e){const t=Gt.get();let r;if(n.includes("-----BEGIN ENCRYPTED PRIVATE KEY-----")){const s=R(n.replace("-----BEGIN ENCRYPTED PRIVATE KEY-----","").replace("-----END ENCRYPTED PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:o}=ti(s),{iv:a,salt:c,iterations:u,keySize:d,cipherText:h}=WR(o),f=await Q8(Jp,e,c,{c:u,dkLen:d}),p=await t.subtle.importKey("raw",f,"AES-CBC",!1,["decrypt"]),m=sc(await t.subtle.decrypt({name:"AES-CBC",iv:a},p,h)),{result:w}=ti(m);r=Xm(w)}else if(n.includes("-----BEGIN PRIVATE KEY-----")){const s=R(n.replace("-----BEGIN PRIVATE KEY-----","").replace("-----END PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:o}=ti(s);r=Xm(o)}else throw new O("Could not parse private key from PEM data");const i=IA(r);if(i.type!=="RSA")throw new O("Could not parse RSA private key from PEM data");return i}function WR(n){const e=n.valueBlock.value[0];if(e.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.13")throw new O("Only pkcs5PBES2 encrypted private keys are supported");const r=e.valueBlock.value[1].valueBlock.value[0];if(r.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.12")throw new O("Only pkcs5PBKDF2 key derivation functions are supported");const s=r.valueBlock.value[1],o=sc(s.valueBlock.value[0].getValue());let a=_0,c=k0;if(s.valueBlock.value.length===3)a=Number(s.valueBlock.value[1].toBigInt()),c=Number(s.valueBlock.value[2].toBigInt());else if(s.valueBlock.value.length===2)throw new O("Could not derive key size and iterations from PEM file - please use @libp2p/rsa to re-import your key");const u=e.valueBlock.value[1].valueBlock.value[1],d=u.valueBlock.value[0].toString();if(d!=="OBJECT IDENTIFIER : 1.2.840.113549.3.7"){if(d!=="OBJECT IDENTIFIER : 1.3.14.3.2.7"){if(d!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.2"){if(d!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.22"){if(d!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.42")throw new O("Only AES-CBC encryption schemes are supported")}}}}const h=sc(u.valueBlock.value[1].getValue());return{cipherText:sc(n.valueBlock.value[1].getValue()),salt:o,iterations:a,keySize:c,iv:h}}function Xm(n){return sc(n.valueBlock.value[2].getValue())}function sc(n){return new Uint8Array(n,0,n.byteLength)}const GR="/pkcs8/",I0="/info/",Ha=new WeakMap,ls={minKeyLength:112/8,minSaltLength:128/8,minIterationCount:1e3},hf={dek:{keyLength:512/8,iterationCount:1e4,salt:"you should override this value with a crypto secure random number",hash:"sha2-512"}};function so(n){return n==null||typeof n!="string"?!1:n===mR(n.trim())&&n.length>0}async function vt(){const t=Math.random()*800+200;await new Promise(r=>setTimeout(r,t))}function us(n){return new Ue(GR+n)}function oo(n){return new Ue(I0+n)}async function jR(n){const e=dl(n),t=await ut.digest(e);return Mr.encode(t.bytes).substring(1)}var a6,c6;c6=Symbol.toStringTag,a6=kt;class QR{constructor(e,t){l(this,"components");l(this,"init");l(this,"log");l(this,"self");l(this,c6,"@libp2p/keychain");l(this,a6,["@libp2p/keychain"]);var i,s,o,a,c,u,d,h,f,p;if(this.components=e,this.log=e.logger.forComponent("libp2p:keychain"),this.init=un(hf,t),this.self=t.selfKey??"self",this.init.pass!=null&&((i=this.init.pass)==null?void 0:i.length)<20)throw new Error("pass must be least 20 characters");if(((s=this.init.dek)==null?void 0:s.keyLength)!=null&&this.init.dek.keyLength<ls.minKeyLength)throw new Error(`dek.keyLength must be least ${ls.minKeyLength} bytes`);if(((a=(o=this.init.dek)==null?void 0:o.salt)==null?void 0:a.length)!=null&&this.init.dek.salt.length<ls.minSaltLength)throw new Error(`dek.saltLength must be least ${ls.minSaltLength} bytes`);if(((c=this.init.dek)==null?void 0:c.iterationCount)!=null&&this.init.dek.iterationCount<ls.minIterationCount)throw new Error(`dek.iterationCount must be least ${ls.minIterationCount}`);const r=this.init.pass!=null&&((u=this.init.dek)==null?void 0:u.salt)!=null?em(this.init.pass,(d=this.init.dek)==null?void 0:d.salt,(h=this.init.dek)==null?void 0:h.iterationCount,(f=this.init.dek)==null?void 0:f.keyLength,(p=this.init.dek)==null?void 0:p.hash):"";Ha.set(this,{dek:r})}static generateOptions(){const e=Object.assign({},hf),t=Math.ceil(ls.minSaltLength/3)*3;return e.dek.salt=U(Os(t),"base64"),e}static get options(){return hf}async findKeyByName(e){if(!so(e))throw await vt(),new O(`Invalid key name '${e}'`);const t=oo(e);try{const r=await this.components.datastore.get(t);return JSON.parse(U(r))}catch(r){throw await vt(),this.log.error(r),new tr(`Key '${e}' does not exist.`)}}async findKeyById(e){try{const t={prefix:I0};for await(const r of this.components.datastore.query(t)){const i=JSON.parse(U(r.value));if(i.id===e)return i}throw new O(`Key with id '${e}' does not exist.`)}catch(t){throw await vt(),t}}async importKey(e,t){if(!so(e))throw await vt(),new O(`Invalid key name '${e}'`);if(t==null)throw await vt(),new O("Key is required");const r=us(e);if(await this.components.datastore.has(r))throw await vt(),new O(`Key '${e}' already exists`);let s,o;try{s=await jR(t);const u=Ha.get(this);if(u==null)throw new O("dek missing");const d=u.dek;o=await Qm(t,d,t.type==="RSA"?"pkcs-8":"libp2p-key")}catch(u){throw await vt(),u}const a={name:e,id:s},c=this.components.datastore.batch();return c.put(r,R(o)),c.put(oo(e),R(JSON.stringify(a))),await c.commit(),a}async exportKey(e){if(!so(e))throw await vt(),new O(`Invalid key name '${e}'`);const t=us(e);try{const r=await this.components.datastore.get(t),i=U(r),s=Ha.get(this);if(s==null)throw new O("dek missing");const o=s.dek;return await Ym(i,o)}catch(r){throw await vt(),r}}async removeKey(e){if(!so(e)||e===this.self)throw await vt(),new O(`Invalid key name '${e}'`);const t=us(e),r=await this.findKeyByName(e),i=this.components.datastore.batch();return i.delete(t),i.delete(oo(e)),await i.commit(),r}async listKeys(){const e={prefix:I0},t=[];for await(const r of this.components.datastore.query(e))t.push(JSON.parse(U(r.value)));return t}async renameKey(e,t){if(!so(e)||e===this.self)throw await vt(),new O(`Invalid old key name '${e}'`);if(!so(t)||t===this.self)throw await vt(),new O(`Invalid new key name '${t}'`);const r=us(e),i=us(t),s=oo(e),o=oo(t);if(await this.components.datastore.has(i))throw await vt(),new O(`Key '${t}' already exists`);try{const c=await this.components.datastore.get(r),u=await this.components.datastore.get(s),d=JSON.parse(U(u));d.name=t;const h=this.components.datastore.batch();return h.put(i,c),h.put(o,R(JSON.stringify(d))),h.delete(r),h.delete(s),await h.commit(),d}catch(c){throw await vt(),c}}async rotateKeychainPass(e,t){var a,c,u,d;if(typeof e!="string")throw await vt(),new O(`Invalid old pass type '${typeof e}'`);if(typeof t!="string")throw await vt(),new O(`Invalid new pass type '${typeof t}'`);if(t.length<20)throw await vt(),new O(`Invalid pass length ${t.length}`);this.log("recreating keychain");const r=Ha.get(this);if(r==null)throw new O("dek missing");const i=r.dek;this.init.pass=t;const s=t!=null&&((a=this.init.dek)==null?void 0:a.salt)!=null?em(t,this.init.dek.salt,(c=this.init.dek)==null?void 0:c.iterationCount,(u=this.init.dek)==null?void 0:u.keyLength,(d=this.init.dek)==null?void 0:d.hash):"";Ha.set(this,{dek:s});const o=await this.listKeys();for(const h of o){const f=await this.components.datastore.get(us(h.name)),p=U(f),m=await Ym(p,i),w=s.toString(),b=await Qm(m,w,m.type==="RSA"?"pkcs-8":"libp2p-key"),S=this.components.datastore.batch(),k={name:h.name,id:h.id};S.put(us(h.name),R(b)),S.put(oo(h.name),R(JSON.stringify(k))),await S.commit()}this.log("keychain reconstructed")}}function Fw(n={}){return e=>new QR(e,n)}async function YR(n,e={}){const t=e.selfKey??"self",r=Fw(e)({datastore:n,logger:Ih()});let i;return await n.has(new Ue(`/pkcs8/${t}`))?i=await r.exportKey(t):(i=await Xp(e.keyType??"Ed25519"),await r.importKey(t,i)),i}function Zm(){const n=ve();let e=!1;return{sink:async t=>{if(e)throw new Error("already piped");e=!0,n.resolve(t)},source:async function*(){yield*await n.promise}()}}function XR(){const n=Zm(),e=Zm();return[{source:n.source,sink:e.sink},{source:e.source,sink:n.sink}]}const Bc=65535,Jm=Bc-16;var l6,u6;const wl=!!((u6=(l6=globalThis.process)==null?void 0:l6.env)!=null&&u6.DUMP_SESSION_KEYS);/*! noble-ciphers - MIT License (c) 2023 Paul Miller (paulmillr.com) */function $w(n){return n instanceof Uint8Array||ArrayBuffer.isView(n)&&n.constructor.name==="Uint8Array"}function C0(n){if(typeof n!="boolean")throw new Error(`boolean expected, not ${n}`)}function ff(n){if(!Number.isSafeInteger(n)||n<0)throw new Error("positive integer expected, got "+n)}function er(n,...e){if(!$w(n))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(n.length))throw new Error("Uint8Array expected of length "+e+", got length="+n.length)}function e4(n,e=!0){if(n.destroyed)throw new Error("Hash instance has been destroyed");if(e&&n.finished)throw new Error("Hash#digest() has already been called")}function ZR(n,e){er(n);const t=e.outputLen;if(n.length<t)throw new Error("digestInto() expects output buffer of length at least "+t)}function zi(n){return new Uint32Array(n.buffer,n.byteOffset,Math.floor(n.byteLength/4))}function Xo(...n){for(let e=0;e<n.length;e++)n[e].fill(0)}function JR(n){return new DataView(n.buffer,n.byteOffset,n.byteLength)}const eP=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function tP(n){if(typeof n!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(n))}function T0(n){if(typeof n=="string")n=tP(n);else if($w(n))n=R0(n);else throw new Error("Uint8Array expected, got "+typeof n);return n}function rP(n,e){if(e==null||typeof e!="object")throw new Error("options must be defined");return Object.assign(n,e)}function nP(n,e){if(n.length!==e.length)return!1;let t=0;for(let r=0;r<n.length;r++)t|=n[r]^e[r];return t===0}const iP=(n,e)=>{function t(r,...i){if(er(r),!eP)throw new Error("Non little-endian hardware is not yet supported");if(n.nonceLength!==void 0){const d=i[0];if(!d)throw new Error("nonce / iv required");n.varSizeNonce?er(d):er(d,n.nonceLength)}const s=n.tagLength;s&&i[1]!==void 0&&er(i[1]);const o=e(r,...i),a=(d,h)=>{if(h!==void 0){if(d!==2)throw new Error("cipher output not supported");er(h)}};let c=!1;return{encrypt(d,h){if(c)throw new Error("cannot encrypt() twice with same key + nonce");return c=!0,er(d),a(o.encrypt.length,h),o.encrypt(d,h)},decrypt(d,h){if(er(d),s&&d.length<s)throw new Error("invalid ciphertext length: smaller than tagLength="+s);return a(o.decrypt.length,h),o.decrypt(d,h)}}}return Object.assign(t,n),t};function t4(n,e,t=!0){if(e===void 0)return new Uint8Array(n);if(e.length!==n)throw new Error("invalid output length, expected "+n+", got: "+e.length);if(t&&!oP(e))throw new Error("invalid output, must be aligned");return e}function r4(n,e,t,r){if(typeof n.setBigUint64=="function")return n.setBigUint64(e,t,r);const i=BigInt(32),s=BigInt(4294967295),o=Number(t>>i&s),a=Number(t&s),c=4,u=0;n.setUint32(e+c,o,r),n.setUint32(e+u,a,r)}function sP(n,e,t){C0(t);const r=new Uint8Array(16),i=JR(r);return r4(i,0,BigInt(e),t),r4(i,8,BigInt(n),t),r}function oP(n){return n.byteOffset%4===0}function R0(n){return Uint8Array.from(n)}const Hw=n=>Uint8Array.from(n.split("").map(e=>e.charCodeAt(0))),aP=Hw("expand 16-byte k"),cP=Hw("expand 32-byte k"),lP=zi(aP),uP=zi(cP);function Te(n,e){return n<<e|n>>>32-e}function P0(n){return n.byteOffset%4===0}const Xl=64,dP=16,Vw=2**32-1,n4=new Uint32Array;function hP(n,e,t,r,i,s,o,a){const c=i.length,u=new Uint8Array(Xl),d=zi(u),h=P0(i)&&P0(s),f=h?zi(i):n4,p=h?zi(s):n4;for(let m=0;m<c;o++){if(n(e,t,r,d,o,a),o>=Vw)throw new Error("arx: counter overflow");const w=Math.min(Xl,c-m);if(h&&w===Xl){const b=m/4;if(m%4!==0)throw new Error("arx: invalid block position");for(let S=0,k;S<dP;S++)k=b+S,p[k]=f[k]^d[S];m+=Xl;continue}for(let b=0,S;b<w;b++)S=m+b,s[S]=i[S]^u[b];m+=w}}function fP(n,e){const{allowShortKeys:t,extendNonceFn:r,counterLength:i,counterRight:s,rounds:o}=rP({allowShortKeys:!1,counterLength:8,counterRight:!1,rounds:20},e);if(typeof n!="function")throw new Error("core must be a function");return ff(i),ff(o),C0(s),C0(t),(a,c,u,d,h=0)=>{er(a),er(c),er(u);const f=u.length;if(d===void 0&&(d=new Uint8Array(f)),er(d),ff(h),h<0||h>=Vw)throw new Error("arx: counter overflow");if(d.length<f)throw new Error(`arx: output (${d.length}) is shorter than data (${f})`);const p=[];let m=a.length,w,b;if(m===32)p.push(w=R0(a)),b=uP;else if(m===16&&t)w=new Uint8Array(32),w.set(a),w.set(a,16),b=lP,p.push(w);else throw new Error(`arx: invalid 32-byte key, got length=${m}`);P0(c)||p.push(c=R0(c));const S=zi(w);if(r){if(c.length!==24)throw new Error("arx: extended nonce must be 24 bytes");r(b,S,zi(c.subarray(0,16)),S),c=c.subarray(16)}const k=16-i;if(k!==c.length)throw new Error(`arx: nonce must be ${k} or 16 bytes`);if(k!==12){const Q=new Uint8Array(12);Q.set(c,s?0:12-c.length),c=Q,p.push(c)}const C=zi(c);return hP(n,b,S,C,u,d,h,o),Xo(...p),d}}const St=(n,e)=>n[e++]&255|(n[e++]&255)<<8;class pP{constructor(e){this.blockLen=16,this.outputLen=16,this.buffer=new Uint8Array(16),this.r=new Uint16Array(10),this.h=new Uint16Array(10),this.pad=new Uint16Array(8),this.pos=0,this.finished=!1,e=T0(e),er(e,32);const t=St(e,0),r=St(e,2),i=St(e,4),s=St(e,6),o=St(e,8),a=St(e,10),c=St(e,12),u=St(e,14);this.r[0]=t&8191,this.r[1]=(t>>>13|r<<3)&8191,this.r[2]=(r>>>10|i<<6)&7939,this.r[3]=(i>>>7|s<<9)&8191,this.r[4]=(s>>>4|o<<12)&255,this.r[5]=o>>>1&8190,this.r[6]=(o>>>14|a<<2)&8191,this.r[7]=(a>>>11|c<<5)&8065,this.r[8]=(c>>>8|u<<8)&8191,this.r[9]=u>>>5&127;for(let d=0;d<8;d++)this.pad[d]=St(e,16+2*d)}process(e,t,r=!1){const i=r?0:2048,{h:s,r:o}=this,a=o[0],c=o[1],u=o[2],d=o[3],h=o[4],f=o[5],p=o[6],m=o[7],w=o[8],b=o[9],S=St(e,t+0),k=St(e,t+2),C=St(e,t+4),Q=St(e,t+6),re=St(e,t+8),T=St(e,t+10),Y=St(e,t+12),se=St(e,t+14);let L=s[0]+(S&8191),B=s[1]+((S>>>13|k<<3)&8191),M=s[2]+((k>>>10|C<<6)&8191),V=s[3]+((C>>>7|Q<<9)&8191),K=s[4]+((Q>>>4|re<<12)&8191),ie=s[5]+(re>>>1&8191),ae=s[6]+((re>>>14|T<<2)&8191),J=s[7]+((T>>>11|Y<<5)&8191),oe=s[8]+((Y>>>8|se<<8)&8191),ge=s[9]+(se>>>5|i),z=0,_e=z+L*a+B*(5*b)+M*(5*w)+V*(5*m)+K*(5*p);z=_e>>>13,_e&=8191,_e+=ie*(5*f)+ae*(5*h)+J*(5*d)+oe*(5*u)+ge*(5*c),z+=_e>>>13,_e&=8191;let Ve=z+L*c+B*a+M*(5*b)+V*(5*w)+K*(5*m);z=Ve>>>13,Ve&=8191,Ve+=ie*(5*p)+ae*(5*f)+J*(5*h)+oe*(5*d)+ge*(5*u),z+=Ve>>>13,Ve&=8191;let q=z+L*u+B*c+M*a+V*(5*b)+K*(5*w);z=q>>>13,q&=8191,q+=ie*(5*m)+ae*(5*p)+J*(5*f)+oe*(5*h)+ge*(5*d),z+=q>>>13,q&=8191;let Ze=z+L*d+B*u+M*c+V*a+K*(5*b);z=Ze>>>13,Ze&=8191,Ze+=ie*(5*w)+ae*(5*m)+J*(5*p)+oe*(5*f)+ge*(5*h),z+=Ze>>>13,Ze&=8191;let Hr=z+L*h+B*d+M*u+V*c+K*a;z=Hr>>>13,Hr&=8191,Hr+=ie*(5*b)+ae*(5*w)+J*(5*m)+oe*(5*p)+ge*(5*f),z+=Hr>>>13,Hr&=8191;let Ce=z+L*f+B*h+M*d+V*u+K*c;z=Ce>>>13,Ce&=8191,Ce+=ie*a+ae*(5*b)+J*(5*w)+oe*(5*m)+ge*(5*p),z+=Ce>>>13,Ce&=8191;let kr=z+L*p+B*f+M*h+V*d+K*u;z=kr>>>13,kr&=8191,kr+=ie*c+ae*a+J*(5*b)+oe*(5*w)+ge*(5*m),z+=kr>>>13,kr&=8191;let _r=z+L*m+B*p+M*f+V*h+K*d;z=_r>>>13,_r&=8191,_r+=ie*u+ae*c+J*a+oe*(5*b)+ge*(5*w),z+=_r>>>13,_r&=8191;let Ir=z+L*w+B*m+M*p+V*f+K*h;z=Ir>>>13,Ir&=8191,Ir+=ie*d+ae*u+J*c+oe*a+ge*(5*b),z+=Ir>>>13,Ir&=8191;let Vr=z+L*b+B*w+M*m+V*p+K*f;z=Vr>>>13,Vr&=8191,Vr+=ie*h+ae*d+J*u+oe*c+ge*a,z+=Vr>>>13,Vr&=8191,z=(z<<2)+z|0,z=z+_e|0,_e=z&8191,z=z>>>13,Ve+=z,s[0]=_e,s[1]=Ve,s[2]=q,s[3]=Ze,s[4]=Hr,s[5]=Ce,s[6]=kr,s[7]=_r,s[8]=Ir,s[9]=Vr}finalize(){const{h:e,pad:t}=this,r=new Uint16Array(10);let i=e[1]>>>13;e[1]&=8191;for(let a=2;a<10;a++)e[a]+=i,i=e[a]>>>13,e[a]&=8191;e[0]+=i*5,i=e[0]>>>13,e[0]&=8191,e[1]+=i,i=e[1]>>>13,e[1]&=8191,e[2]+=i,r[0]=e[0]+5,i=r[0]>>>13,r[0]&=8191;for(let a=1;a<10;a++)r[a]=e[a]+i,i=r[a]>>>13,r[a]&=8191;r[9]-=8192;let s=(i^1)-1;for(let a=0;a<10;a++)r[a]&=s;s=~s;for(let a=0;a<10;a++)e[a]=e[a]&s|r[a];e[0]=(e[0]|e[1]<<13)&65535,e[1]=(e[1]>>>3|e[2]<<10)&65535,e[2]=(e[2]>>>6|e[3]<<7)&65535,e[3]=(e[3]>>>9|e[4]<<4)&65535,e[4]=(e[4]>>>12|e[5]<<1|e[6]<<14)&65535,e[5]=(e[6]>>>2|e[7]<<11)&65535,e[6]=(e[7]>>>5|e[8]<<8)&65535,e[7]=(e[8]>>>8|e[9]<<5)&65535;let o=e[0]+t[0];e[0]=o&65535;for(let a=1;a<8;a++)o=(e[a]+t[a]|0)+(o>>>16)|0,e[a]=o&65535;Xo(r)}update(e){e4(this),e=T0(e),er(e);const{buffer:t,blockLen:r}=this,i=e.length;for(let s=0;s<i;){const o=Math.min(r-this.pos,i-s);if(o===r){for(;r<=i-s;s+=r)this.process(e,s);continue}t.set(e.subarray(s,s+o),this.pos),this.pos+=o,s+=o,this.pos===r&&(this.process(t,0,!1),this.pos=0)}return this}destroy(){Xo(this.h,this.r,this.buffer,this.pad)}digestInto(e){e4(this),ZR(e,this),this.finished=!0;const{buffer:t,h:r}=this;let{pos:i}=this;if(i){for(t[i++]=1;i<16;i++)t[i]=0;this.process(t,0,!0)}this.finalize();let s=0;for(let o=0;o<8;o++)e[s++]=r[o]>>>0,e[s++]=r[o]>>>8;return e}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const r=e.slice(0,t);return this.destroy(),r}}function gP(n){const e=(r,i)=>n(i).update(T0(r)).digest(),t=n(new Uint8Array(32));return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=r=>n(r),e}const mP=gP(n=>new pP(n));function yP(n,e,t,r,i,s=20){let o=n[0],a=n[1],c=n[2],u=n[3],d=e[0],h=e[1],f=e[2],p=e[3],m=e[4],w=e[5],b=e[6],S=e[7],k=i,C=t[0],Q=t[1],re=t[2],T=o,Y=a,se=c,L=u,B=d,M=h,V=f,K=p,ie=m,ae=w,J=b,oe=S,ge=k,z=C,_e=Q,Ve=re;for(let Ze=0;Ze<s;Ze+=2)T=T+B|0,ge=Te(ge^T,16),ie=ie+ge|0,B=Te(B^ie,12),T=T+B|0,ge=Te(ge^T,8),ie=ie+ge|0,B=Te(B^ie,7),Y=Y+M|0,z=Te(z^Y,16),ae=ae+z|0,M=Te(M^ae,12),Y=Y+M|0,z=Te(z^Y,8),ae=ae+z|0,M=Te(M^ae,7),se=se+V|0,_e=Te(_e^se,16),J=J+_e|0,V=Te(V^J,12),se=se+V|0,_e=Te(_e^se,8),J=J+_e|0,V=Te(V^J,7),L=L+K|0,Ve=Te(Ve^L,16),oe=oe+Ve|0,K=Te(K^oe,12),L=L+K|0,Ve=Te(Ve^L,8),oe=oe+Ve|0,K=Te(K^oe,7),T=T+M|0,Ve=Te(Ve^T,16),J=J+Ve|0,M=Te(M^J,12),T=T+M|0,Ve=Te(Ve^T,8),J=J+Ve|0,M=Te(M^J,7),Y=Y+V|0,ge=Te(ge^Y,16),oe=oe+ge|0,V=Te(V^oe,12),Y=Y+V|0,ge=Te(ge^Y,8),oe=oe+ge|0,V=Te(V^oe,7),se=se+K|0,z=Te(z^se,16),ie=ie+z|0,K=Te(K^ie,12),se=se+K|0,z=Te(z^se,8),ie=ie+z|0,K=Te(K^ie,7),L=L+B|0,_e=Te(_e^L,16),ae=ae+_e|0,B=Te(B^ae,12),L=L+B|0,_e=Te(_e^L,8),ae=ae+_e|0,B=Te(B^ae,7);let q=0;r[q++]=o+T|0,r[q++]=a+Y|0,r[q++]=c+se|0,r[q++]=u+L|0,r[q++]=d+B|0,r[q++]=h+M|0,r[q++]=f+V|0,r[q++]=p+K|0,r[q++]=m+ie|0,r[q++]=w+ae|0,r[q++]=b+J|0,r[q++]=S+oe|0,r[q++]=k+ge|0,r[q++]=C+z|0,r[q++]=Q+_e|0,r[q++]=re+Ve|0}const wP=fP(yP,{counterRight:!1,counterLength:4,allowShortKeys:!1}),bP=new Uint8Array(16),i4=(n,e)=>{n.update(e);const t=e.length%16;t&&n.update(bP.subarray(t))},vP=new Uint8Array(32);function s4(n,e,t,r,i){const s=n(e,t,vP),o=mP.create(s);i&&i4(o,i),i4(o,r);const a=sP(r.length,i?i.length:0,!0);o.update(a);const c=o.digest();return Xo(s,a),c}const SP=n=>(e,t,r)=>({encrypt(s,o){const a=s.length;o=t4(a+16,o,!1),o.set(s);const c=o.subarray(0,-16);n(e,t,c,c,1);const u=s4(n,e,t,c,r);return o.set(u,a),Xo(u),o},decrypt(s,o){o=t4(s.length-16,o,!1);const a=s.subarray(0,-16),c=s.subarray(-16),u=s4(n,e,t,a,r);if(!nP(c,u))throw new Error("invalid tag");return o.set(s.subarray(0,-16)),n(e,t,o,o,1),Xo(u),o}}),o4=iP({blockSize:64,nonceLength:12,tagLength:16},SP(wP));function EP(n,e,t){return Bp(n),t===void 0&&(t=new Uint8Array(n.outputLen)),Up(n,K3(t),K3(e))}const pf=Uint8Array.from([0]),a4=Uint8Array.of();function xP(n,e,t,r=32){Bp(n),gu(r);const i=n.outputLen;if(r>255*i)throw new Error("Length should be <= 255*HashLen");const s=Math.ceil(r/i);t===void 0&&(t=a4);const o=new Uint8Array(s*i),a=Up.create(n,e),c=a._cloneInto(),u=new Uint8Array(a.outputLen);for(let d=0;d<s;d++)pf[0]=d+1,c.update(d===0?a4:u).update(t).update(pf).digestInto(u),o.set(u,i*d),a._cloneInto(c);return a.destroy(),c.destroy(),a8(u,pf),o.slice(0,r)}const AP={hashSHA256(n){return _s(n.subarray())},getHKDF(n,e){const t=EP(_s,e,n),i=xP(_s,t,void 0,96),s=i.subarray(0,32),o=i.subarray(32,64),a=i.subarray(64,96);return[s,o,a]},generateX25519KeyPair(){const n=Ul.utils.randomPrivateKey();return{publicKey:Ul.getPublicKey(n),privateKey:n}},generateX25519KeyPairFromSeed(n){return{publicKey:Ul.getPublicKey(n),privateKey:n}},generateX25519SharedKey(n,e){return Ul.getSharedSecret(n.subarray(),e.subarray())},chaCha20Poly1305Encrypt(n,e,t,r){return o4(r,e,t).encrypt(n.subarray())},chaCha20Poly1305Decrypt(n,e,t,r,i){return o4(r,e,t).decrypt(n.subarray(),i)}},kP=AP;function _P(n){return{generateKeypair:n.generateX25519KeyPair,dh:(e,t)=>n.generateX25519SharedKey(e.privateKey,t).subarray(0,32),encrypt:n.chaCha20Poly1305Encrypt,decrypt:n.chaCha20Poly1305Decrypt,hash:n.hashSHA256,hkdf:n.getHKDF}}const fd=n=>{const e=yc(2);return e[0]=n>>8,e[1]=n,e};fd.bytes=2;const Iu=n=>{if(n.length<2)throw RangeError("Could not decode int16BE");if(n instanceof Uint8Array){let e=0;return e+=n[0]<<8,e+=n[1],e}return n.getUint16(0)};Iu.bytes=2;function IP(n){return{xxHandshakeSuccesses:n.registerCounter("libp2p_noise_xxhandshake_successes_total",{help:"Total count of noise xxHandshakes successes_"}),xxHandshakeErrors:n.registerCounter("libp2p_noise_xxhandshake_error_total",{help:"Total count of noise xxHandshakes errors"}),encryptedPackets:n.registerCounter("libp2p_noise_encrypted_packets_total",{help:"Total count of noise encrypted packets successfully"}),decryptedPackets:n.registerCounter("libp2p_noise_decrypted_packets_total",{help:"Total count of noise decrypted packets"}),decryptErrors:n.registerCounter("libp2p_noise_decrypt_errors_total",{help:"Total count of noise decrypt errors"})}}function zw(n,e){!e.enabled||!wl||(n?(e(`LOCAL_STATIC_PUBLIC_KEY ${U(n.publicKey,"hex")}`),e(`LOCAL_STATIC_PRIVATE_KEY ${U(n.privateKey,"hex")}`)):e("Missing local static keys."))}function Kw(n,e){!e.enabled||!wl||(n?(e(`LOCAL_PUBLIC_EPHEMERAL_KEY ${U(n.publicKey,"hex")}`),e(`LOCAL_PRIVATE_EPHEMERAL_KEY ${U(n.privateKey,"hex")}`)):e("Missing local ephemeral keys."))}function CP(n,e){!e.enabled||!wl||e(n?`REMOTE_STATIC_PUBLIC_KEY ${U(n.subarray(),"hex")}`:"Missing remote static public key.")}function qw(n,e){!e.enabled||!wl||e(n?`REMOTE_EPHEMERAL_PUBLIC_KEY ${U(n.subarray(),"hex")}`:"Missing remote ephemeral keys.")}function Ww(n,e,t){!t.enabled||!wl||(t(`CIPHER_STATE_1 ${n.n.getUint64()} ${n.k&&U(n.k,"hex")}`),t(`CIPHER_STATE_2 ${e.n.getUint64()} ${e.k&&U(e.k,"hex")}`))}function Zo(n,e){if(n.length!==e.length)throw new Error("Inputs should have the same length");const t=yc(n.length);for(let r=0;r<n.length;r++)t[r]=n[r]^e[r];return vE(t)}const hh=class hh extends Error{constructor(t="Invalid crypto exchange"){super(t);l(this,"code");this.code=hh.code}};l(hh,"code","ERR_INVALID_CRYPTO_EXCHANGE");let oc=hh;const TP=0,RP=4294967295,PP="Cipherstate has reached maximum n, a new handshake must be performed";class OP{constructor(e=TP){l(this,"n");l(this,"bytes");l(this,"view");this.n=e,this.bytes=Fe(12),this.view=new DataView(this.bytes.buffer,this.bytes.byteOffset,this.bytes.byteLength),this.view.setUint32(4,e,!0)}increment(){this.n++,this.view.setUint32(4,this.n,!0)}getBytes(){return this.bytes}getUint64(){return this.n}assertValue(){if(this.n>RP)throw new Error(PP)}}const Do=Fe(0);class Zl{constructor(e,t=void 0,r=0){l(this,"k");l(this,"n");l(this,"crypto");this.crypto=e,this.k=t,this.n=new OP(r)}hasKey(){return!!this.k}encryptWithAd(e,t){if(!this.hasKey())return t;this.n.assertValue();const r=this.crypto.encrypt(t,this.n.getBytes(),e,this.k);return this.n.increment(),r}decryptWithAd(e,t,r){if(!this.hasKey())return t;this.n.assertValue();const i=this.crypto.decrypt(t,this.n.getBytes(),e,this.k,r);return this.n.increment(),i}}class DP{constructor(e,t){l(this,"cs");l(this,"ck");l(this,"h");l(this,"crypto");this.crypto=e;const r=R(t,"utf-8");this.h=LP(e,r),this.ck=this.h,this.cs=new Zl(e)}mixKey(e){const[t,r]=this.crypto.hkdf(this.ck,e);this.ck=t,this.cs=new Zl(this.crypto,r)}mixHash(e){this.h=this.crypto.hash(new Ee(this.h,e))}encryptAndHash(e){const t=this.cs.encryptWithAd(this.h,e);return this.mixHash(t),t}decryptAndHash(e){const t=this.cs.decryptWithAd(this.h,e);return this.mixHash(e),t}split(){const[e,t]=this.crypto.hkdf(this.ck,Do);return[new Zl(this.crypto,e),new Zl(this.crypto,t)]}}class NP{constructor(e){l(this,"ss");l(this,"s");l(this,"e");l(this,"rs");l(this,"re");l(this,"initiator");l(this,"crypto");const{crypto:t,protocolName:r,prologue:i,initiator:s,s:o,e:a,rs:c,re:u}=e;this.crypto=t,this.ss=new DP(t,r),this.ss.mixHash(i),this.initiator=s,this.s=o,this.e=a,this.rs=c,this.re=u}writeE(){if(this.e)throw new Error("ephemeral keypair is already set");const e=this.crypto.generateKeypair();return this.ss.mixHash(e.publicKey),this.e=e,e.publicKey}writeS(){if(!this.s)throw new Error("static keypair is not set");return this.ss.encryptAndHash(this.s.publicKey)}writeEE(){if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.re))}writeES(){if(this.initiator){if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.rs)throw new Error("remote static public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.rs))}else{if(!this.s)throw new Error("static keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.s,this.re))}}writeSE(){if(this.initiator){if(!this.s)throw new Error("static keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.s,this.re))}else{if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.rs)throw new Error("remote static public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.rs))}}readE(e,t=0){if(this.re)throw new Error("remote ephemeral public key is already set");if(e.byteLength<t+32)throw new Error("message is not long enough");this.re=e.sublist(t,t+32),this.ss.mixHash(this.re)}readS(e,t=0){if(this.rs)throw new Error("remote static public key is already set");const r=32+(this.ss.cs.hasKey()?16:0);if(e.byteLength<t+r)throw new Error("message is not long enough");const i=e.sublist(t,t+r);return this.rs=this.ss.decryptAndHash(i),r}readEE(){this.writeEE()}readES(){this.writeES()}readSE(){this.writeSE()}}class Gw extends NP{writeMessageA(e){return new Ee(this.writeE(),this.ss.encryptAndHash(e))}writeMessageB(e){const t=this.writeE();this.writeEE();const r=this.writeS();return this.writeES(),new Ee(t,r,this.ss.encryptAndHash(e))}writeMessageC(e){const t=this.writeS();return this.writeSE(),new Ee(t,this.ss.encryptAndHash(e))}readMessageA(e){try{return this.readE(e),this.ss.decryptAndHash(e.sublist(32))}catch(t){throw new oc(`handshake stage 0 validation fail: ${t.message}`)}}readMessageB(e){try{this.readE(e),this.readEE();const t=this.readS(e,32);return this.readES(),this.ss.decryptAndHash(e.sublist(32+t))}catch(t){throw new oc(`handshake stage 1 validation fail: ${t.message}`)}}readMessageC(e){try{const t=this.readS(e);return this.readSE(),this.ss.decryptAndHash(e.sublist(t))}catch(t){throw new oc(`handshake stage 2 validation fail: ${t.message}`)}}}function LP(n,e){if(e.length<=32){const t=Fe(32);return t.set(e),t}else return n.hash(e)}var pd;(function(n){let e;n.codec=()=>(e==null&&(e=me((t,r,i={})=>{if(i.lengthDelimited!==!1&&r.fork(),t.webtransportCerthashes!=null)for(const s of t.webtransportCerthashes)r.uint32(10),r.bytes(s);if(t.streamMuxers!=null)for(const s of t.streamMuxers)r.uint32(18),r.string(s);i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{var a,c;const s={webtransportCerthashes:[],streamMuxers:[]},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const u=t.uint32();switch(u>>>3){case 1:{if(((a=i.limits)==null?void 0:a.webtransportCerthashes)!=null&&s.webtransportCerthashes.length===i.limits.webtransportCerthashes)throw new It('Decode error - map field "webtransportCerthashes" had too many elements');s.webtransportCerthashes.push(t.bytes());break}case 2:{if(((c=i.limits)==null?void 0:c.streamMuxers)!=null&&s.streamMuxers.length===i.limits.streamMuxers)throw new It('Decode error - map field "streamMuxers" had too many elements');s.streamMuxers.push(t.string());break}default:{t.skipType(u&7);break}}}return s})),e),n.encode=t=>ye(t,n.codec()),n.decode=(t,r)=>we(t,n.codec(),r)})(pd||(pd={}));var gd;(function(n){let e;n.codec=()=>(e==null&&(e=me((t,r,i={})=>{i.lengthDelimited!==!1&&r.fork(),t.identityKey!=null&&t.identityKey.byteLength>0&&(r.uint32(10),r.bytes(t.identityKey)),t.identitySig!=null&&t.identitySig.byteLength>0&&(r.uint32(18),r.bytes(t.identitySig)),t.extensions!=null&&(r.uint32(34),pd.codec().encode(t.extensions,r)),i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{var a;const s={identityKey:Fe(0),identitySig:Fe(0)},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const c=t.uint32();switch(c>>>3){case 1:{s.identityKey=t.bytes();break}case 2:{s.identitySig=t.bytes();break}case 4:{s.extensions=pd.codec().decode(t,t.uint32(),{limits:(a=i.limits)==null?void 0:a.extensions});break}default:{t.skipType(c&7);break}}}return s})),e),n.encode=t=>ye(t,n.codec()),n.decode=(t,r)=>we(t,n.codec(),r)})(gd||(gd={}));async function jw(n,e,t){const r=await n.sign(Yw(e));return gd.encode({identityKey:en(n.publicKey),identitySig:r,extensions:t})}async function Qw(n,e,t){try{const r=gd.decode(n),i=on(r.identityKey);if((t==null?void 0:t.equals(i))===!1)throw new Error(`Payload identity key ${i} does not match expected remote identity key ${t}`);if(!e)throw new Error("Remote static does not exist");const s=Yw(e);if(!await i.verify(s,r.identitySig))throw new Error("Invalid payload signature");return r}catch(r){throw new c8(r.message)}}function Yw(n){const e=R("noise-libp2p-static-key:");return n instanceof Uint8Array?sr([e,n],e.length+n.length):(n.prepend(e),n)}async function BP(n,e){const{log:t,connection:r,crypto:i,privateKey:s,prologue:o,s:a,remoteIdentityKey:c,extensions:u}=n,d=await jw(s,a.publicKey,u),h=new Gw({crypto:i,protocolName:"Noise_XX_25519_ChaChaPoly_SHA256",initiator:!0,prologue:o,s:a});zw(h.s,t),t.trace("Stage 0 - Initiator starting to send first message."),await r.write(h.writeMessageA(Do),e),t.trace("Stage 0 - Initiator finished sending first message."),Kw(h.e,t),t.trace("Stage 1 - Initiator waiting to receive first message from responder...");const f=h.readMessageB(await r.read(e));t.trace("Stage 1 - Initiator received the message."),qw(h.re,t),CP(h.rs,t),t.trace("Initiator going to check remote's signature...");const p=await Qw(f,h.rs,c);t.trace("All good with the signature!"),t.trace("Stage 2 - Initiator sending third handshake message."),await r.write(h.writeMessageC(d),e),t.trace("Stage 2 - Initiator sent message with signed payload.");const[m,w]=h.ss.split();return Ww(m,w,t),{payload:p,encrypt:b=>m.encryptWithAd(Do,b),decrypt:(b,S)=>w.decryptWithAd(Do,b,S)}}async function MP(n,e){const{log:t,connection:r,crypto:i,privateKey:s,prologue:o,s:a,remoteIdentityKey:c,extensions:u}=n,d=await jw(s,a.publicKey,u),h=new Gw({crypto:i,protocolName:"Noise_XX_25519_ChaChaPoly_SHA256",initiator:!1,prologue:o,s:a});zw(h.s,t),t.trace("Stage 0 - Responder waiting to receive first message."),h.readMessageA(await r.read(e)),t.trace("Stage 0 - Responder received first message."),qw(h.re,t),t.trace("Stage 1 - Responder sending out first message with signed payload and static key."),await r.write(h.writeMessageB(d),e),t.trace("Stage 1 - Responder sent the second handshake message with signed payload."),Kw(h.e,t),t.trace("Stage 2 - Responder waiting for third handshake message...");const f=h.readMessageC(await r.read(e));t.trace("Stage 2 - Responder received the message, finished handshake.");const p=await Qw(f,h.rs,c),[m,w]=h.ss.split();return Ww(m,w,t),{payload:p,encrypt:b=>w.encryptWithAd(Do,b),decrypt:(b,S)=>m.decryptWithAd(Do,b,S)}}const c4=16;function UP(n,e){return async function*(t){for await(const r of t)for(let i=0;i<r.length;i+=Jm){let s=i+Jm;s>r.length&&(s=r.length);let o;r instanceof Uint8Array?o=n.encrypt(r.subarray(i,s)):o=n.encrypt(r.sublist(i,s)),e==null||e.encryptedPackets.increment(),yield new Ee(fd(o.byteLength),o)}}}function FP(n,e){return async function*(t){for await(const r of t)for(let i=0;i<r.length;i+=Bc){let s=i+Bc;if(s>r.length&&(s=r.length),s-c4<i)throw new Error("Invalid chunk");const o=r.sublist(i,s),a=r.subarray(i,s-c4);try{const c=n.decrypt(o,a);e==null||e.decryptedPackets.increment(),yield c}catch(c){throw e==null||e.decryptErrors.increment(),c}}}}var d6,h6;h6=Symbol.toStringTag,d6=kt;class $P{constructor(e,t={}){l(this,"protocol","/noise");l(this,"crypto");l(this,"prologue");l(this,"staticKey");l(this,"extensions");l(this,"metrics");l(this,"components");l(this,h6,"@chainsafe/libp2p-noise");l(this,d6,["@libp2p/connection-encryption","@chainsafe/libp2p-noise"]);const{staticNoiseKey:r,extensions:i,crypto:s,prologueBytes:o}=t,{metrics:a}=e;this.components=e;const c=s??kP;this.crypto=_P(c),this.extensions={webtransportCerthashes:[],...i},this.metrics=a?IP(a):void 0,r?this.staticKey=c.generateX25519KeyPairFromSeed(r):this.staticKey=c.generateX25519KeyPair(),this.prologue=o??Fe(0)}async secureOutbound(e,t){var a,c;const r=Qo(e,{lengthEncoder:fd,lengthDecoder:Iu,maxDataLength:Bc}),i=await this.performHandshakeInitiator(r,this.components.privateKey,(a=t==null?void 0:t.remotePeer)==null?void 0:a.publicKey,t),s=await this.createSecureConnection(r,i);e.source=s.source,e.sink=s.sink;const o=on(i.payload.identityKey);return{conn:e,remoteExtensions:i.payload.extensions,remotePeer:Go(o),streamMuxer:(t==null?void 0:t.skipStreamMuxerNegotiation)===!0?void 0:this.getStreamMuxer((c=i.payload.extensions)==null?void 0:c.streamMuxers)}}getStreamMuxer(e){if(e==null||e.length===0)return;const t=this.components.upgrader.getStreamMuxers();if(t!=null)for(const r of e){const i=t.get(r);if(i!=null)return i}if(e.length)throw new FE("Early muxer negotiation was requested but the initiator and responder had no common muxers")}async secureInbound(e,t){var a,c;const r=Qo(e,{lengthEncoder:fd,lengthDecoder:Iu,maxDataLength:Bc}),i=await this.performHandshakeResponder(r,this.components.privateKey,(a=t==null?void 0:t.remotePeer)==null?void 0:a.publicKey,t),s=await this.createSecureConnection(r,i);e.source=s.source,e.sink=s.sink;const o=on(i.payload.identityKey);return{conn:e,remoteExtensions:i.payload.extensions,remotePeer:Go(o),streamMuxer:(t==null?void 0:t.skipStreamMuxerNegotiation)===!0?void 0:this.getStreamMuxer((c=i.payload.extensions)==null?void 0:c.streamMuxers)}}async performHandshakeInitiator(e,t,r,i){var a,c;let s;const o=(i==null?void 0:i.skipStreamMuxerNegotiation)===!0?[]:[...this.components.upgrader.getStreamMuxers().keys()];try{s=await BP({connection:e,privateKey:t,remoteIdentityKey:r,log:this.components.logger.forComponent("libp2p:noise:xxhandshake"),crypto:this.crypto,prologue:this.prologue,s:this.staticKey,extensions:{streamMuxers:o,webtransportCerthashes:[],...this.extensions}},i),(a=this.metrics)==null||a.xxHandshakeSuccesses.increment()}catch(u){throw(c=this.metrics)==null||c.xxHandshakeErrors.increment(),u}return s}async performHandshakeResponder(e,t,r,i){var a,c;let s;const o=(i==null?void 0:i.skipStreamMuxerNegotiation)===!0?[]:[...this.components.upgrader.getStreamMuxers().keys()];try{s=await MP({connection:e,privateKey:t,remoteIdentityKey:r,log:this.components.logger.forComponent("libp2p:noise:xxhandshake"),crypto:this.crypto,prologue:this.prologue,s:this.staticKey,extensions:{streamMuxers:o,webtransportCerthashes:[],...this.extensions}},i),(a=this.metrics)==null||a.xxHandshakeSuccesses.increment()}catch(u){throw(c=this.metrics)==null||c.xxHandshakeErrors.increment(),u}return s}async createSecureConnection(e,t){const[r,i]=XR(),s=e.unwrap();return await _t(r,UP(t,this.metrics),s,o=>kc(o,{lengthDecoder:Iu}),FP(t,this.metrics),r),i}}function Xw(n={}){return e=>new $P(e,n)}function xg(n){if(n!=null){if(typeof n[Symbol.iterator]=="function")return n[Symbol.iterator]();if(typeof n[Symbol.asyncIterator]=="function")return n[Symbol.asyncIterator]();if(typeof n.next=="function")return n}throw new Error("argument is not an iterator or iterable")}class vs extends Error{constructor(e="The frame was invalid"){super(e),this.name="InvalidFrameError"}}l(vs,"name","InvalidFrameError");class Ag extends Error{constructor(e="Unrequested ping error"){super(e),this.name="UnrequestedPingError"}}l(Ag,"name","UnrequestedPingError");class kg extends Error{constructor(e="Unrequested ping error"){super(e),this.name="NotMatchingPingError"}}l(kg,"name","NotMatchingPingError");class Zw extends Error{constructor(e="Invalid state"){super(e),this.name="InvalidStateError"}}l(Zw,"name","InvalidStateError");class Jw extends Error{constructor(e="Strean already exists"){super(e),this.name="StreamAlreadyExistsError"}}l(Jw,"name","StreamAlreadyExistsError");class eb extends Error{constructor(e="Decode invalid version"){super(e),this.name="DecodeInvalidVersionError"}}l(eb,"name","DecodeInvalidVersionError");class tb extends Error{constructor(e="Both clients"){super(e),this.name="BothClientsError"}}l(tb,"name","BothClientsError");class _g extends Error{constructor(e="Receive window exceeded"){super(e),this.name="ReceiveWindowExceededError"}}l(_g,"name","ReceiveWindowExceededError");const HP=new Set([vs.name,Ag.name,kg.name,Jw.name,eb.name,tb.name,_g.name]),Ig=256*1024,VP=16*1024*1024,zP={enableKeepAlive:!0,keepAliveInterval:3e4,maxInboundStreams:1e3,maxOutboundStreams:1e3,initialStreamWindowSize:Ig,maxStreamWindowSize:VP,maxMessageSize:64*1024};function KP(n){if(n.keepAliveInterval<=0)throw new O("keep-alive interval must be positive");if(n.maxInboundStreams<0)throw new O("max inbound streams must be larger or equal 0");if(n.maxOutboundStreams<0)throw new O("max outbound streams must be larger or equal 0");if(n.initialStreamWindowSize<Ig)throw new O("InitialStreamWindowSize must be larger or equal 256 kB");if(n.maxStreamWindowSize<n.initialStreamWindowSize)throw new O("MaxStreamWindowSize must be larger than the InitialStreamWindowSize");if(n.maxStreamWindowSize>2**32-1)throw new O("MaxStreamWindowSize must be less than equal MAX_UINT32");if(n.maxMessageSize<1024)throw new O("MaxMessageSize must be greater than a kilobyte")}var ft;(function(n){n[n.Data=0]="Data",n[n.WindowUpdate=1]="WindowUpdate",n[n.Ping=2]="Ping",n[n.GoAway=3]="GoAway"})(ft||(ft={}));var tt;(function(n){n[n.SYN=1]="SYN",n[n.ACK=2]="ACK",n[n.FIN=4]="FIN",n[n.RST=8]="RST"})(tt||(tt={}));Object.values(tt).filter(n=>typeof n!="string");const qP=0;var mn;(function(n){n[n.NormalTermination=0]="NormalTermination",n[n.ProtocolError=1]="ProtocolError",n[n.InternalError=2]="InternalError"})(mn||(mn={}));const ac=12,l4=2**24;function WP(n){if(n[0]!==qP)throw new vs("Invalid frame version");return{type:n[1],flag:(n[2]<<8)+n[3],streamID:n[4]*l4+(n[5]<<16)+(n[6]<<8)+n[7],length:n[8]*l4+(n[9]<<16)+(n[10]<<8)+n[11]}}let GP=class{constructor(e){l(this,"source");l(this,"buffer");l(this,"frameInProgress");this.source=jP(e),this.buffer=new Ee,this.frameInProgress=!1}async*emitFrames(){for await(const e of this.source)for(this.buffer.append(e);;){const t=this.readHeader();if(t===void 0)break;const{type:r,length:i}=t;r===ft.Data?(this.frameInProgress=!0,yield{header:t,readData:this.readBytes.bind(this,i)}):yield{header:t}}}readHeader(){if(this.frameInProgress)throw new Zw("decoding frame already in progress");if(this.buffer.length<ac)return;const e=WP(this.buffer.subarray(0,ac));return this.buffer.consume(ac),e}async readBytes(e){if(this.buffer.length<e){for await(const r of this.source)if(this.buffer.append(r),this.buffer.length>=e)break}const t=this.buffer.sublist(0,e);return this.buffer.consume(e),this.frameInProgress=!1,t}};function jP(n){if(n[Symbol.iterator]!==void 0){const e=n[Symbol.iterator]();return e.return=void 0,{[Symbol.iterator](){return e}}}else if(n[Symbol.asyncIterator]!==void 0){const e=n[Symbol.asyncIterator]();return e.return=void 0,{[Symbol.asyncIterator](){return e}}}else throw new Error("a source must be either an iterable or an async iterable")}function u4(n){const e=new Uint8Array(ac);return e[1]=n.type,e[2]=n.flag>>>8,e[3]=n.flag,e[4]=n.streamID>>>24,e[5]=n.streamID>>>16,e[6]=n.streamID>>>8,e[7]=n.streamID,e[8]=n.length>>>24,e[9]=n.length>>>16,e[10]=n.length>>>8,e[11]=n.length,e}function QP(n){return n==null?!1:typeof n.then=="function"&&typeof n.catch=="function"&&typeof n.finally=="function"}function rb(n,e){var r,i;const t=(i=(r=xg(n)).return)==null?void 0:i.call(r);QP(t)&&t.catch(s=>{e.error("could not cause iterator to return",s)})}const YP=5e3;function gf(n){return n==null?!1:typeof n.then=="function"&&typeof n.catch=="function"&&typeof n.finally=="function"}class Cg{constructor(e){l(this,"id");l(this,"direction");l(this,"timeline");l(this,"protocol");l(this,"metadata");l(this,"source");l(this,"status");l(this,"readStatus");l(this,"writeStatus");l(this,"log");l(this,"sinkController");l(this,"sinkEnd");l(this,"closed");l(this,"endErr");l(this,"streamSource");l(this,"onEnd");l(this,"onCloseRead");l(this,"onCloseWrite");l(this,"onReset");l(this,"onAbort");l(this,"sendCloseWriteTimeout");l(this,"sendingData");this.sinkController=new AbortController,this.sinkEnd=ve(),this.closed=ve(),this.log=e.log,this.status="open",this.readStatus="ready",this.writeStatus="ready",this.id=e.id,this.metadata=e.metadata??{},this.direction=e.direction,this.timeline={open:Date.now()},this.sendCloseWriteTimeout=e.sendCloseWriteTimeout??YP,this.onEnd=e.onEnd,this.onCloseRead=e.onCloseRead,this.onCloseWrite=e.onCloseWrite,this.onReset=e.onReset,this.onAbort=e.onAbort,this.source=this.streamSource=cn({onEnd:t=>{t!=null?this.log.trace("source ended with error",t):this.log.trace("source ended"),this.onSourceEnd(t)}}),this.sink=this.sink.bind(this)}async sink(e){if(this.writeStatus!=="ready")throw new zu(`writable end state is "${this.writeStatus}" not "ready"`);try{this.writeStatus="writing";const t={signal:this.sinkController.signal};if(this.direction==="outbound"){const i=this.sendNewStream(t);gf(i)&&await i}const r=()=>{rb(e,this.log)};try{this.sinkController.signal.addEventListener("abort",r),this.log.trace("sink reading from source");for await(let i of e){i=i instanceof Uint8Array?new Ee(i):i;const s=this.sendData(i,t);gf(s)&&(this.sendingData=ve(),await s,this.sendingData.resolve(),this.sendingData=void 0)}}finally{this.sinkController.signal.removeEventListener("abort",r)}this.log.trace('sink finished reading from source, write status is "%s"',this.writeStatus),this.writeStatus==="writing"&&(this.writeStatus="closing",this.log.trace("send close write to remote"),await this.sendCloseWrite({signal:AbortSignal.timeout(this.sendCloseWriteTimeout)}),this.writeStatus="closed"),this.onSinkEnd()}catch(t){throw this.log.trace("sink ended with error, calling abort with error",t),this.abort(t),t}finally{this.log.trace("resolve sink end"),this.sinkEnd.resolve()}}onSourceEnd(e){var t;this.timeline.closeRead==null&&(this.timeline.closeRead=Date.now(),this.readStatus="closed",e!=null&&this.endErr==null&&(this.endErr=e),(t=this.onCloseRead)==null||t.call(this),this.timeline.closeWrite!=null?(this.log.trace("source and sink ended"),this.timeline.close=Date.now(),this.status!=="aborted"&&this.status!=="reset"&&(this.status="closed"),this.onEnd!=null&&this.onEnd(this.endErr),this.closed.resolve()):this.log.trace("source ended, waiting for sink to end"))}onSinkEnd(e){var t;this.timeline.closeWrite==null&&(this.timeline.closeWrite=Date.now(),this.writeStatus="closed",e!=null&&this.endErr==null&&(this.endErr=e),(t=this.onCloseWrite)==null||t.call(this),this.timeline.closeRead!=null?(this.log.trace("sink and source ended"),this.timeline.close=Date.now(),this.status!=="aborted"&&this.status!=="reset"&&(this.status="closed"),this.onEnd!=null&&this.onEnd(this.endErr),this.closed.resolve()):this.log.trace("sink ended, waiting for source to end"))}async close(e){this.status==="open"&&(this.log.trace("closing gracefully"),this.status="closing",await yt(Promise.all([this.closeWrite(e),this.closeRead(e),this.closed.promise]),e==null?void 0:e.signal),this.status="closed",this.log.trace("closed gracefully"))}async closeRead(e={}){if(this.readStatus==="closing"||this.readStatus==="closed")return;this.log.trace('closing readable end of stream with starting read status "%s"',this.readStatus);const t=this.readStatus;this.readStatus="closing",this.status!=="reset"&&this.status!=="aborted"&&this.timeline.closeRead==null&&(this.log.trace("send close read to remote"),await this.sendCloseRead(e)),t==="ready"&&(this.log.trace("ending internal source queue with %d queued bytes",this.streamSource.readableLength),this.streamSource.end()),this.log.trace("closed readable end of stream")}async closeWrite(e={}){this.writeStatus==="closing"||this.writeStatus==="closed"||(this.log.trace('closing writable end of stream with starting write status "%s"',this.writeStatus),this.writeStatus==="ready"&&(this.log.trace("sink was never sunk, sink an empty array"),await yt(this.sink([]),e.signal)),this.writeStatus==="writing"&&(this.sendingData!=null&&await yt(this.sendingData.promise,e.signal),this.log.trace("aborting source passed to .sink"),this.sinkController.abort(),await yt(this.sinkEnd.promise,e.signal)),this.writeStatus="closed",this.log.trace("closed writable end of stream"))}abort(e){var r;if(this.status==="closed"||this.status==="aborted"||this.status==="reset")return;this.log("abort with error",e),this.log("try to send reset to remote");const t=this.sendReset();gf(t)&&t.catch(i=>{this.log.error("error sending reset message",i)}),this.status="aborted",this.timeline.abort=Date.now(),this._closeSinkAndSource(e),(r=this.onAbort)==null||r.call(this,e)}reset(){var t;if(this.status==="closed"||this.status==="aborted"||this.status==="reset")return;const e=new u8("stream reset");this.status="reset",this.timeline.reset=Date.now(),this._closeSinkAndSource(e),(t=this.onReset)==null||t.call(this)}_closeSinkAndSource(e){this._closeSink(e),this._closeSource(e)}_closeSink(e){this.writeStatus==="writing"&&(this.log.trace("end sink source"),this.sinkController.abort()),this.onSinkEnd(e)}_closeSource(e){this.readStatus!=="closing"&&this.readStatus!=="closed"&&(this.log.trace("ending source with %d bytes to be read by consumer",this.streamSource.readableLength),this.readStatus="closing",this.streamSource.end(e))}remoteCloseWrite(){if(this.readStatus==="closing"||this.readStatus==="closed"){this.log("received remote close write but local source is already closed");return}this.log.trace("remote close write"),this._closeSource()}remoteCloseRead(){if(this.writeStatus==="closing"||this.writeStatus==="closed"){this.log("received remote close read but local sink is already closed");return}this.log.trace("remote close read"),this._closeSink()}destroy(){if(this.status==="closed"||this.status==="aborted"||this.status==="reset"){this.log("received destroy but we are already closed");return}this.log.trace("stream destroyed"),this._closeSinkAndSource()}sourcePush(e){this.streamSource.push(e)}sourceReadableLength(){return this.streamSource.readableLength}}var Qr;(function(n){n[n.Init=0]="Init",n[n.SYNSent=1]="SYNSent",n[n.SYNReceived=2]="SYNReceived",n[n.Established=3]="Established",n[n.Finished=4]="Finished"})(Qr||(Qr={}));class XP extends Cg{constructor(t){super({...t,onEnd:r=>{var i;this.state=Qr.Finished,(i=t.onEnd)==null||i.call(t,r)}});l(this,"name");l(this,"state");l(this,"config");l(this,"_id");l(this,"sendWindowCapacity");l(this,"sendWindowCapacityUpdate");l(this,"recvWindow");l(this,"recvWindowCapacity");l(this,"epochStart");l(this,"getRTT");l(this,"sendFrame");this.config=t.config,this._id=parseInt(t.id,10),this.name=t.name,this.state=t.state,this.sendWindowCapacity=Ig,this.recvWindow=this.config.initialStreamWindowSize,this.recvWindowCapacity=this.recvWindow,this.epochStart=Date.now(),this.getRTT=t.getRTT,this.sendFrame=t.sendFrame,this.source=Zu(this.source,()=>{this.sendWindowUpdate()})}async sendNewStream(){}async sendData(t,r={}){var i,s;for(t=t.sublist();t.byteLength!==0;){if(this.sendWindowCapacity===0&&((i=this.log)==null||i.trace("wait for send window capacity, status %s",this.status),await this.waitForSendWindowCapacity(r),this.status==="closed"||this.status==="aborted"||this.status==="reset")){(s=this.log)==null||s.trace("%s while waiting for send window capacity",this.status);return}const o=Math.min(this.sendWindowCapacity,this.config.maxMessageSize-ac,t.length),a=this.getSendFlags();this.sendFrame({type:ft.Data,flag:a,streamID:this._id,length:o},t.sublist(0,o)),this.sendWindowCapacity-=o,t.consume(o)}}async sendReset(){this.sendFrame({type:ft.WindowUpdate,flag:tt.RST,streamID:this._id,length:0})}async sendCloseWrite(){const t=this.getSendFlags()|tt.FIN;this.sendFrame({type:ft.WindowUpdate,flag:t,streamID:this._id,length:0})}async sendCloseRead(){}async waitForSendWindowCapacity(t={}){var o,a;if(this.sendWindowCapacity>0)return;let r,i;const s=()=>{this.status==="open"||this.status==="closing"?i(new ci("Stream aborted")):r()};(o=t.signal)==null||o.addEventListener("abort",s);try{await new Promise((c,u)=>{this.sendWindowCapacityUpdate=()=>{c()},i=u,r=c})}finally{(a=t.signal)==null||a.removeEventListener("abort",s)}}handleWindowUpdate(t){var i,s;(i=this.log)==null||i.trace("stream received window update id=%s",this._id),this.processFlags(t.flag);const r=this.sendWindowCapacity;this.sendWindowCapacity+=t.length,r===0&&t.length>0&&((s=this.sendWindowCapacityUpdate)==null||s.call(this))}async handleData(t,r){var s;if((s=this.log)==null||s.trace("stream received data id=%s",this._id),this.processFlags(t.flag),this.recvWindowCapacity<t.length)throw new _g("Receive window exceeded");const i=await r();this.recvWindowCapacity-=t.length,this.sourcePush(i)}processFlags(t){(t&tt.ACK)===tt.ACK&&this.state===Qr.SYNSent&&(this.state=Qr.Established),(t&tt.FIN)===tt.FIN&&this.remoteCloseWrite(),(t&tt.RST)===tt.RST&&this.reset()}getSendFlags(){switch(this.state){case Qr.Init:return this.state=Qr.SYNSent,tt.SYN;case Qr.SYNReceived:return this.state=Qr.Established,tt.ACK;default:return 0}}sendWindowUpdate(){const t=this.getSendFlags(),r=Date.now(),i=this.getRTT();if(t===0&&i>-1&&r-this.epochStart<i*4&&(this.recvWindow=Math.min(this.recvWindow*2,this.config.maxStreamWindowSize)),this.recvWindowCapacity>=this.recvWindow&&t===0)return;const s=this.recvWindow-this.recvWindowCapacity;this.recvWindowCapacity=this.recvWindow,this.epochStart=r,this.sendFrame({type:ft.WindowUpdate,flag:t,streamID:this._id,length:s})}}const nb="/yamux/1.0.0",ZP=500;var f6,p6;p6=Symbol.toStringTag,f6=kt;class JP{constructor(e,t={}){l(this,"protocol",nb);l(this,"_components");l(this,"_init");l(this,p6,"@chainsafe/libp2p-yamux");l(this,f6,["@libp2p/stream-multiplexing"]);this._components=e,this._init=t}createStreamMuxer(e){return new eO(this._components,{...this._init,...e})}}class eO{constructor(e,t){l(this,"protocol",nb);l(this,"source");l(this,"sink");l(this,"config");l(this,"log");l(this,"logger");l(this,"closeController");l(this,"nextStreamID");l(this,"_streams");l(this,"nextPingID");l(this,"activePing");l(this,"rtt");l(this,"client");l(this,"localGoAway");l(this,"remoteGoAway");l(this,"numInboundStreams");l(this,"numOutboundStreams");l(this,"onIncomingStream");l(this,"onStreamEnd");var r;this.client=t.direction==="outbound",this.config={...zP,...t},this.logger=e.logger,this.log=this.logger.forComponent("libp2p:yamux"),KP(this.config),this.closeController=new AbortController,this.closeController.signal,this.onIncomingStream=t.onIncomingStream,this.onStreamEnd=t.onStreamEnd,this._streams=new Map,this.source=cn({onEnd:()=>{var i;(i=this.log)==null||i.trace("muxer source ended"),this._streams.forEach(s=>{s.destroy()})}}),this.sink=async i=>{var c,u,d;const s=()=>{const h=xg(i);if(h.return!=null){const f=h.return();tO(f)&&f.catch(p=>{var m;(m=this.log)==null||m.call(this,"could not cause sink source to return",p)})}};let o,a;try{const h=new GP(i);try{this.closeController.signal.addEventListener("abort",s);for await(const f of h.emitFrames())await this.handleFrame(f.header,f.readData)}finally{this.closeController.signal.removeEventListener("abort",s)}o=mn.NormalTermination}catch(h){HP.has(h.name)?((c=this.log)==null||c.error("protocol error in sink",h),o=mn.ProtocolError):((u=this.log)==null||u.error("internal error in sink",h),o=mn.InternalError),a=h}(d=this.log)==null||d.trace("muxer sink ended"),a!=null?this.abort(a,o):await this.close({reason:o})},this.numInboundStreams=0,this.numOutboundStreams=0,this.nextStreamID=this.client?1:2,this.nextPingID=0,this.rtt=-1,(r=this.log)==null||r.trace("muxer created"),this.config.enableKeepAlive&&this.keepAliveLoop().catch(i=>{var s;return(s=this.log)==null?void 0:s.error("keepalive error: %s",i)}),this.ping().catch(i=>{var s;return(s=this.log)==null?void 0:s.error("ping error: %s",i)})}get streams(){return Array.from(this._streams.values())}newStream(e){var i;if(this.remoteGoAway!==void 0)throw new ps("Muxer closed remotely");if(this.localGoAway!==void 0)throw new ps("Muxer closed locally");const t=this.nextStreamID;if(this.nextStreamID+=2,this.numOutboundStreams>=this.config.maxOutboundStreams)throw new Eh("max outbound streams exceeded");(i=this.log)==null||i.trace("new outgoing stream id=%s",t);const r=this._newStream(t,e,Qr.Init,"outbound");return this._streams.set(t,r),this.numOutboundStreams++,r.sendWindowUpdate(),r}async ping(){if(this.remoteGoAway!==void 0)throw new ps("Muxer closed remotely");if(this.localGoAway!==void 0)throw new ps("Muxer closed locally");if(this.activePing===void 0){let e=()=>{};this.activePing={id:this.nextPingID++,promise:new Promise((i,s)=>{const o=()=>{s(new ps("Muxer closed locally"))};this.closeController.signal.addEventListener("abort",o,{once:!0}),e=()=>{this.closeController.signal.removeEventListener("abort",o),i()}}),resolve:e};const t=Date.now();this.sendPing(this.activePing.id);try{await this.activePing.promise}finally{delete this.activePing}const r=Date.now();this.rtt=r-t}else await this.activePing.promise;return this.rtt}getRTT(){return this.rtt}async close(e={}){var r;if(this.closeController.signal.aborted)return;const t=(e==null?void 0:e.reason)??mn.NormalTermination;if((r=this.log)==null||r.trace("muxer close reason=%s",t),e.signal==null){const i=AbortSignal.timeout(ZP);e={...e,signal:i}}try{await Promise.all([...this._streams.values()].map(async i=>i.close(e))),this.sendGoAway(t),this._closeMuxer()}catch(i){this.abort(i)}}abort(e,t){var r;if(!this.closeController.signal.aborted){t=t??mn.InternalError,(r=this.log)==null||r.error("muxer abort reason=%s error=%s",t,e);for(const i of this._streams.values())i.abort(e);this.sendGoAway(t),this._closeMuxer()}}isClosed(){return this.closeController.signal.aborted}_closeMuxer(){this.closeController.abort(),this.source.end()}_newStream(e,t,r,i){if(this._streams.get(e)!=null)throw new O("Stream already exists with that id");const s=new XP({id:e.toString(),name:t,state:r,direction:i,sendFrame:this.sendFrame.bind(this),onEnd:()=>{var o;this.closeStream(e),(o=this.onStreamEnd)==null||o.call(this,s)},log:this.logger.forComponent(`libp2p:yamux:${i}:${e}`),config:this.config,getRTT:this.getRTT.bind(this)});return s}closeStream(e){this.client===(e%2===0)?this.numInboundStreams--:this.numOutboundStreams--,this._streams.delete(e)}async keepAliveLoop(){var e;for((e=this.log)==null||e.trace("muxer keepalive enabled interval=%s",this.config.keepAliveInterval);;){let t;try{await yt(new Promise(r=>{t=setTimeout(r,this.config.keepAliveInterval)}),this.closeController.signal),this.ping().catch(r=>{var i;return(i=this.log)==null?void 0:i.error("ping error: %s",r)})}catch{clearInterval(t);return}}}async handleFrame(e,t){var o;const{streamID:r,type:i,length:s}=e;if((o=this.log)==null||o.trace("received frame %o",e),r===0)switch(i){case ft.Ping:{this.handlePing(e);return}case ft.GoAway:{this.handleGoAway(s);return}default:throw new vs("Invalid frame type")}else switch(e.type){case ft.Data:case ft.WindowUpdate:{await this.handleStreamMessage(e,t);return}default:throw new vs("Invalid frame type")}}handlePing(e){var t,r;if(e.flag===tt.SYN)(t=this.log)==null||t.trace("received ping request pingId=%s",e.length),this.sendPing(e.length,tt.ACK);else if(e.flag===tt.ACK)(r=this.log)==null||r.trace("received ping response pingId=%s",e.length),this.handlePingResponse(e.length);else throw new vs("Invalid frame flag")}handlePingResponse(e){if(this.activePing===void 0)throw new Ag("ping not requested");if(this.activePing.id!==e)throw new kg("ping doesn't match our id");this.activePing.resolve()}handleGoAway(e){var t;(t=this.log)==null||t.trace("received GoAway reason=%s",mn[e]??"unknown"),this.remoteGoAway=e;for(const r of this._streams.values())r.reset();this._closeMuxer()}async handleStreamMessage(e,t){var a,c;const{streamID:r,flag:i,type:s}=e;(i&tt.SYN)===tt.SYN&&this.incomingStream(r);const o=this._streams.get(r);if(o===void 0){if(s===ft.Data){if((a=this.log)==null||a.call(this,"discarding data for stream id=%s",r),t===void 0)throw new Error("unreachable");await t()}else(c=this.log)==null||c.trace("frame for missing stream id=%s",r);return}switch(s){case ft.WindowUpdate:{o.handleWindowUpdate(e);return}case ft.Data:{if(t===void 0)throw new Error("unreachable");await o.handleData(e,t);return}default:throw new Error("unreachable")}}incomingStream(e){var r,i,s;if(this.client!==(e%2===0))throw new O("Both endpoints are clients");if(this._streams.has(e))return;if((r=this.log)==null||r.trace("new incoming stream id=%s",e),this.localGoAway!==void 0){this.sendFrame({type:ft.WindowUpdate,flag:tt.RST,streamID:e,length:0});return}if(this.numInboundStreams>=this.config.maxInboundStreams){(i=this.log)==null||i.call(this,"maxIncomingStreams exceeded, forcing stream reset"),this.sendFrame({type:ft.WindowUpdate,flag:tt.RST,streamID:e,length:0});return}const t=this._newStream(e,void 0,Qr.SYNReceived,"inbound");this.numInboundStreams++,this._streams.set(e,t),(s=this.onIncomingStream)==null||s.call(this,t)}sendFrame(e,t){var r;if((r=this.log)==null||r.trace("sending frame %o",e),e.type===ft.Data){if(t===void 0)throw new vs("Invalid frame");this.source.push(new Ee(u4(e),t))}else this.source.push(u4(e))}sendPing(e,t=tt.SYN){var r,i;t===tt.SYN?(r=this.log)==null||r.trace("sending ping request pingId=%s",e):(i=this.log)==null||i.trace("sending ping response pingId=%s",e),this.sendFrame({type:ft.Ping,flag:t,streamID:0,length:e})}sendGoAway(e=mn.NormalTermination){var t;(t=this.log)==null||t.call(this,"sending GoAway reason=%s",mn[e]),this.localGoAway=e,this.sendFrame({type:ft.GoAway,flag:0,streamID:0,length:e})}}function tO(n){return n!=null&&typeof n.then=="function"}function rO(n={}){return e=>new JP(e,n)}function ib(n){try{for(const{code:e,value:t}of n.getComponents())if(t!=null&&e===Ts)return a_("2000::/3",t)}catch{}return!1}function nO(n,e,t){let r,i,s=!1;function o(){const u={signal:i.signal};if((t==null?void 0:t.timeout)!=null){const d=Le([i.signal,AbortSignal.timeout(t.timeout)]);u.signal=d}s=!0,Promise.resolve().then(async()=>{await n(u)}).catch(()=>{}).finally(()=>{s=!1,!i.signal.aborted&&(r=setTimeout(o,e))})}const a=xc(o,(t==null?void 0:t.debounce)??100);let c=!1;return{setInterval:u=>{e!==u&&(e=u,r!=null&&(clearTimeout(r),r=setTimeout(o,e)))},setTimeout:u=>{t??(t={}),t.timeout=u},run:()=>{s||(clearTimeout(r),a())},start:()=>{c||(c=!0,i=new AbortController,i.signal,(t==null?void 0:t.runImmediately)===!0?queueMicrotask(()=>{o()}):r=setTimeout(o,e))},stop:()=>{clearTimeout(r),i==null||i.abort(),c=!1}}}function Mt(n,e){const t=Qo(n,e),r={read:async(i,s)=>{const o=await t.read(s);return i.decode(o)},write:async(i,s,o)=>{await t.write(s.encode(i),o)},writeV:async(i,s,o)=>{await t.writeV(i.map(a=>s.encode(a)),o)},pb:i=>({read:async s=>r.read(i,s),write:async(s,o)=>r.write(s,i,o),writeV:async(s,o)=>r.writeV(s,i,o),unwrap:()=>r}),unwrap:()=>t.unwrap()};return r}const iO="libp2p",sO="autonat",oO="1.0.0",aO=3e4,cO=2,lO=20,uO=80,dO=8192;var Qe;(function(n){(function(i){i.DIAL="DIAL",i.DIAL_RESPONSE="DIAL_RESPONSE"})(n.MessageType||(n.MessageType={}));let e;(function(i){i[i.DIAL=0]="DIAL",i[i.DIAL_RESPONSE=1]="DIAL_RESPONSE"})(e||(e={})),function(i){i.codec=()=>Wt(e)}(n.MessageType||(n.MessageType={})),function(i){i.OK="OK",i.E_DIAL_ERROR="E_DIAL_ERROR",i.E_DIAL_REFUSED="E_DIAL_REFUSED",i.E_BAD_REQUEST="E_BAD_REQUEST",i.E_INTERNAL_ERROR="E_INTERNAL_ERROR"}(n.ResponseStatus||(n.ResponseStatus={}));let t;(function(i){i[i.OK=0]="OK",i[i.E_DIAL_ERROR=100]="E_DIAL_ERROR",i[i.E_DIAL_REFUSED=101]="E_DIAL_REFUSED",i[i.E_BAD_REQUEST=200]="E_BAD_REQUEST",i[i.E_INTERNAL_ERROR=300]="E_INTERNAL_ERROR"})(t||(t={})),function(i){i.codec=()=>Wt(t)}(n.ResponseStatus||(n.ResponseStatus={})),function(i){let s;i.codec=()=>(s==null&&(s=me((o,a,c={})=>{if(c.lengthDelimited!==!1&&a.fork(),o.id!=null&&(a.uint32(10),a.bytes(o.id)),o.addrs!=null)for(const u of o.addrs)a.uint32(18),a.bytes(u);c.lengthDelimited!==!1&&a.ldelim()},(o,a,c={})=>{var h;const u={addrs:[]},d=a==null?o.len:o.pos+a;for(;o.pos<d;){const f=o.uint32();switch(f>>>3){case 1:{u.id=o.bytes();break}case 2:{if(((h=c.limits)==null?void 0:h.addrs)!=null&&u.addrs.length===c.limits.addrs)throw new It('Decode error - map field "addrs" had too many elements');u.addrs.push(o.bytes());break}default:{o.skipType(f&7);break}}}return u})),s),i.encode=o=>ye(o,i.codec()),i.decode=(o,a)=>we(o,i.codec(),a)}(n.PeerInfo||(n.PeerInfo={})),function(i){let s;i.codec=()=>(s==null&&(s=me((o,a,c={})=>{c.lengthDelimited!==!1&&a.fork(),o.peer!=null&&(a.uint32(10),n.PeerInfo.codec().encode(o.peer,a)),c.lengthDelimited!==!1&&a.ldelim()},(o,a,c={})=>{var h;const u={},d=a==null?o.len:o.pos+a;for(;o.pos<d;){const f=o.uint32();switch(f>>>3){case 1:{u.peer=n.PeerInfo.codec().decode(o,o.uint32(),{limits:(h=c.limits)==null?void 0:h.peer});break}default:{o.skipType(f&7);break}}}return u})),s),i.encode=o=>ye(o,i.codec()),i.decode=(o,a)=>we(o,i.codec(),a)}(n.Dial||(n.Dial={})),function(i){let s;i.codec=()=>(s==null&&(s=me((o,a,c={})=>{c.lengthDelimited!==!1&&a.fork(),o.status!=null&&(a.uint32(8),n.ResponseStatus.codec().encode(o.status,a)),o.statusText!=null&&(a.uint32(18),a.string(o.statusText)),o.addr!=null&&(a.uint32(26),a.bytes(o.addr)),c.lengthDelimited!==!1&&a.ldelim()},(o,a,c={})=>{const u={},d=a==null?o.len:o.pos+a;for(;o.pos<d;){const h=o.uint32();switch(h>>>3){case 1:{u.status=n.ResponseStatus.codec().decode(o);break}case 2:{u.statusText=o.string();break}case 3:{u.addr=o.bytes();break}default:{o.skipType(h&7);break}}}return u})),s),i.encode=o=>ye(o,i.codec()),i.decode=(o,a)=>we(o,i.codec(),a)}(n.DialResponse||(n.DialResponse={}));let r;n.codec=()=>(r==null&&(r=me((i,s,o={})=>{o.lengthDelimited!==!1&&s.fork(),i.type!=null&&(s.uint32(8),n.MessageType.codec().encode(i.type,s)),i.dial!=null&&(s.uint32(18),n.Dial.codec().encode(i.dial,s)),i.dialResponse!=null&&(s.uint32(26),n.DialResponse.codec().encode(i.dialResponse,s)),o.lengthDelimited!==!1&&s.ldelim()},(i,s,o={})=>{var u,d;const a={},c=s==null?i.len:i.pos+s;for(;i.pos<c;){const h=i.uint32();switch(h>>>3){case 1:{a.type=n.MessageType.codec().decode(i);break}case 2:{a.dial=n.Dial.codec().decode(i,i.uint32(),{limits:(u=o.limits)==null?void 0:u.dial});break}case 3:{a.dialResponse=n.DialResponse.codec().decode(i,i.uint32(),{limits:(d=o.limits)==null?void 0:d.dialResponse});break}default:{i.skipType(h&7);break}}}return a})),r),n.encode=i=>ye(i,n.codec()),n.decode=(i,s)=>we(i,n.codec(),s)})(Qe||(Qe={}));const hO=4,fO=8;var g6,m6;class pO{constructor(e,t){l(this,"components");l(this,"protocol");l(this,"timeout");l(this,"maxInboundStreams");l(this,"maxOutboundStreams");l(this,"maxMessageSize");l(this,"started");l(this,"log");l(this,"topologyId");l(this,"dialResults");l(this,"findPeers");l(this,"addressFilter");l(this,"connectionThreshold");l(this,m6,"@libp2p/autonat");l(this,g6,["@libp2p/autonat"]);this.components=e,this.log=e.logger.forComponent("libp2p:auto-nat"),this.started=!1,this.protocol=`/${t.protocolPrefix??iO}/${sO}/${oO}`,this.timeout=t.timeout??aO,this.maxInboundStreams=t.maxInboundStreams??cO,this.maxOutboundStreams=t.maxOutboundStreams??lO,this.connectionThreshold=t.connectionThreshold??uO,this.maxMessageSize=t.maxMessageSize??dO,this.dialResults=an({name:"libp2p_autonat_dial_results",metrics:e.metrics}),this.findPeers=nO(this.findRandomPeers.bind(this),6e4),this.addressFilter=Qi(1024)}get[(m6=Symbol.toStringTag,g6=kt,Ps)](){return["@libp2p/identify"]}isStarted(){return this.started}async start(){this.started||(await this.components.registrar.handle(this.protocol,e=>{this.handleIncomingAutonatStream(e).catch(t=>{this.log.error("error handling incoming autonat stream - %e",t)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}),this.topologyId=await this.components.registrar.register(this.protocol,{onConnect:(e,t)=>{this.verifyExternalAddresses(t).catch(r=>{this.log.error("could not verify addresses - %e",r)})}}),this.findPeers.start(),this.started=!0)}async stop(){await this.components.registrar.unhandle(this.protocol),this.topologyId!=null&&await this.components.registrar.unhandle(this.topologyId),this.dialResults.clear(),this.findPeers.stop(),this.started=!1}allAddressesAreVerified(){return this.components.addressManager.getAddressesWithMetadata().every(e=>e.expires>Date.now()?!0:e.verified)}async findRandomPeers(e){if(this.allAddressesAreVerified())return;const t=Le([AbortSignal.timeout(1e4),e==null?void 0:e.signal]);try{this.log("starting random walk to find peers to run AutoNAT");for await(const r of this.components.randomWalk.walk({signal:t})){if(!await this.components.connectionManager.isDialable(r.multiaddrs)){this.log.trace("random peer %p was not dialable %s",r.id,r.multiaddrs.map(i=>i.toString()).join(", "));continue}try{this.log.trace("dial random peer %p",r.id),await this.components.connectionManager.openConnection(r.multiaddrs,{signal:t})}catch{}if(this.allAddressesAreVerified()){this.log("stopping random walk, all addresses are verified");return}if(!this.hasConnectionCapacity()){this.log("stopping random walk, too close to max connections");return}}}catch{}}async handleIncomingAutonatStream(e){const t=AbortSignal.timeout(this.timeout),r=Mt(e.stream,{maxDataLength:this.maxMessageSize}).pb(Qe);try{const i=await r.read({signal:t}),s=await this.handleAutonatMessage(i,e.connection,{signal:t});await r.write(s,{signal:t}),await r.unwrap().unwrap().close({signal:t})}catch(i){this.log.error("error handling incoming autonat stream - %e",i),e.stream.abort(i)}}async handleAutonatMessage(e,t,r){const i=this.components.addressManager.getAddresses().map(h=>h.toOptions().host),s=e.dial;if(s==null)return this.log.error("dial was missing from message"),{type:Qe.MessageType.DIAL_RESPONSE,dialResponse:{status:Qe.ResponseStatus.E_BAD_REQUEST,statusText:"No Dial message found in message"}};let o;const a=s.peer;if((a==null?void 0:a.id)==null)return this.log.error("PeerId missing from message"),{type:Qe.MessageType.DIAL_RESPONSE,dialResponse:{status:Qe.ResponseStatus.E_BAD_REQUEST,statusText:"missing peer info"}};try{const h=Pt(a.id);o=ln(h)}catch(h){return this.log.error("invalid PeerId - %e",h),{type:Qe.MessageType.DIAL_RESPONSE,dialResponse:{status:Qe.ResponseStatus.E_BAD_REQUEST,statusText:"bad peer id"}}}if(this.log("incoming request from %p",o),!t.remotePeer.equals(o))return this.log("target peer %p did not equal sending peer %p",o,t.remotePeer),{type:Qe.MessageType.DIAL_RESPONSE,dialResponse:{status:Qe.ResponseStatus.E_BAD_REQUEST,statusText:"peer id mismatch"}};const c=a.addrs.map(h=>fe(h)).filter(h=>{try{const f=h.toOptions();return Ns(h)?!1:f.host!==t.remoteAddr.toOptions().host?(this.log.trace("not dialing %a - target host did not match remote host %a",h,t.remoteAddr),!1):i.includes(f.host)?!1:this.components.transportManager.dialTransportForMultiaddr(h)==null?(this.log.trace("not dialing %a - transport unsupported",h),!1):!0}catch{return!1}}).map(h=>(h.getPeerId()==null&&(h=h.encapsulate(`/p2p/${o.toString()}`)),h));if(c.length===0)return this.log("refused to dial all multiaddrs for %p from message",o),{type:Qe.MessageType.DIAL_RESPONSE,dialResponse:{status:Qe.ResponseStatus.E_DIAL_REFUSED,statusText:"no dialable addresses"}};this.log("dial multiaddrs %s for peer %p",c.map(h=>h.toString()).join(", "),o);let u="",d=c[0];for(const h of c){let f;d=h;try{if(f=await this.components.connectionManager.openConnection(h,r),!f.remoteAddr.equals(h))throw this.log.error("tried to dial %a but dialed %a",h,f.remoteAddr),new Error("Unexpected remote address");return this.log("successfully dialed %p via %a",o,h),{type:Qe.MessageType.DIAL_RESPONSE,dialResponse:{status:Qe.ResponseStatus.OK,addr:f.remoteAddr.decapsulateCode(ba("p2p").code).bytes}}}catch(p){this.log.error("could not dial %p - %e",o,p),u=p.message}finally{f!=null&&await f.close()}}return{type:Qe.MessageType.DIAL_RESPONSE,dialResponse:{status:Qe.ResponseStatus.E_DIAL_ERROR,statusText:u,addr:d.bytes}}}getFirstUnverifiedMultiaddr(e,t){var i,s;const r=this.components.addressManager.getAddressesWithMetadata().sort((o,a)=>o.type==="observed"&&a.type!=="observed"?1:a.type==="observed"&&o.type!=="observed"?-1:0).filter(o=>!(!(o.expires<Date.now())||o.multiaddr.toOptions().family===6&&(!t||!ib(o.multiaddr))||Ns(o.multiaddr)));for(const o of r){const a=o.multiaddr.toString();let c=this.dialResults.get(a);if(c!=null){if(c.networkSegments.includes(e)){this.log.trace("%a already has a network segment result from %s",c.multiaddr,e);continue}if(c.queue.size>10){this.log.trace("%a already has enough peers queued",c.multiaddr);continue}}if(c==null){const u=o.expires<Date.now();if(u&&((s=(i=this.addressFilter).remove)==null||s.call(i,a)),this.addressFilter.has(a))continue;this.addressFilter.add(a),this.log.trace("creating dial result %s %s",u?"to revalidate":"for",a),c={multiaddr:o.multiaddr,success:0,failure:0,networkSegments:[],verifyingPeers:BA(),queue:new Gi({concurrency:3,maxSize:50}),type:o.type,lastVerified:o.lastVerified},this.dialResults.set(a,c)}return c}}removeOutdatedMultiaddrResults(){const e=new Set(this.components.addressManager.getAddressesWithMetadata().filter(({expires:t})=>t<Date.now()).map(({multiaddr:t})=>t.toString()));for(const t of this.dialResults.keys())e.has(t)||(this.log.trace("remove results for %a",t),this.dialResults.delete(t))}async verifyExternalAddresses(e){if(!this.isStarted())return;this.removeOutdatedMultiaddrResults();const r=(await this.components.peerStore.get(e.remotePeer)).addresses.some(({multiaddr:o})=>o.toOptions().family===6),i=this.getNetworkSegment(e.remoteAddr),s=this.getFirstUnverifiedMultiaddr(i,r);if(s==null){this.log.trace("no unverified public addresses found for peer %p to verify, not requesting verification",e.remotePeer);return}if(!this.hasConnectionCapacity()){s.lastVerified!=null?(this.log("automatically re-verifying %a because we are too close to the connection limit",s.multiaddr),this.confirmAddress(s)):this.log("skipping verifying %a because we are too close to the connection limit",s.multiaddr);return}s.queue.add(async o=>{await this.askPeerToVerify(e,i,o)},{peerId:e.remotePeer,multiaddr:s.multiaddr}).catch(o=>{(s==null?void 0:s.result)==null&&this.log.error("error from %p verifying address %a - %e",e.remotePeer,s==null?void 0:s.multiaddr,o)})}async askPeerToVerify(e,t,r){let i=this.dialResults.get(r.multiaddr.toString());if(i==null){this.log("%a was verified while %p was queued",r.multiaddr,e.remotePeer);return}const s=AbortSignal.timeout(this.timeout);this.log.trace("asking %p to verify multiaddr %s",e.remotePeer,r.multiaddr);const o=await e.newStream(this.protocol,{signal:s});try{const a=Mt(o).pb(Qe),[,c]=await Promise.all([a.write({type:Qe.MessageType.DIAL,dial:{peer:{id:this.components.peerId.toMultihash().bytes,addrs:[r.multiaddr.bytes]}}},{signal:s}),a.read({signal:s})]);if(c.type!==Qe.MessageType.DIAL_RESPONSE||c.dialResponse==null){this.log("invalid autonat response from %p - %j",e.remotePeer,c);return}const u=c.dialResponse.status;if(this.log.trace("autonat response from %p for %a is %s",e.remotePeer,r.multiaddr,u),u!==Qe.ResponseStatus.OK&&u!==Qe.ResponseStatus.E_DIAL_ERROR)return;if(i=this.dialResults.get(r.multiaddr.toString()),i==null){this.log.trace("peer reported %a as %s but there is no result object",r.multiaddr,c.dialResponse.status);return}if(i.networkSegments.includes(t)){this.log.trace("%a results included network segment %s",r.multiaddr,t);return}if(i.result!=null){this.log.trace("already resolved result for %a, ignoring response from",r.multiaddr,e.remotePeer);return}if(i.verifyingPeers.has(e.remotePeer)){this.log.trace("peer %p has already verified %a, ignoring response",e.remotePeer,r.multiaddr);return}if(i.verifyingPeers.add(e.remotePeer),i.networkSegments.push(t),u===Qe.ResponseStatus.OK){if(i.success++,i.type!=="observed"){this.confirmAddress(i);return}}else u===Qe.ResponseStatus.E_DIAL_ERROR&&i.failure++;this.log("%a success %d failure %d",i.multiaddr,i.success,i.failure),i.success===hO&&this.confirmAddress(i),i.failure===fO&&this.unconfirmAddress(i)}finally{try{await o.close({signal:s})}catch(a){o.abort(a)}}}hasConnectionCapacity(){const t=this.components.connectionManager.getConnections().length,r=this.components.connectionManager.getMaxConnections();return t/r*100<this.connectionThreshold}confirmAddress(e){this.log("%s address %a is externally dialable",e.type,e.multiaddr),this.components.addressManager.confirmObservedAddr(e.multiaddr),this.dialResults.delete(e.multiaddr.toString()),e.result=!0,e.queue.abort()}unconfirmAddress(e){this.log("%s address %a is not externally dialable",e.type,e.multiaddr),this.components.addressManager.removeObservedAddr(e.multiaddr),this.dialResults.delete(e.multiaddr.toString()),e.result=!1,e.queue.abort()}getNetworkSegment(e){const t=e.toOptions();return t.family===4?t.host.split(".")[0].padStart(3,"0"):t.host.split(":")[0].padStart(4,"0")}}function gO(n={}){return e=>new pO(e,n)}const mO=G("dns4"),yO=G("dns6"),wO=G("dnsaddr"),Ms=at(G("dns"),wO,mO,yO),e1=at(G("ip4"),G("ip6")),Jo=at(ce(e1,G("tcp")),ce(Ms,G("tcp"))),t1=ce(e1,G("udp")),bO=ce(t1,G("utp")),vO=ce(t1,G("quic")),SO=ce(t1,G("quic-v1")),O0=at(ce(Jo,G("ws")),ce(Ms,G("ws"))),md=at(ce(O0,G("p2p")),O0),D0=at(ce(Jo,G("wss")),ce(Ms,G("wss")),ce(Jo,G("tls"),G("ws")),ce(Ms,G("tls"),G("ws"))),yd=at(ce(D0,G("p2p")),D0),N0=at(ce(Jo,G("http")),ce(e1,G("http")),ce(Ms,G("http"))),L0=at(ce(Jo,G("https")),ce(e1,G("https")),ce(Ms,G("https"))),d4=ce(t1,G("webrtc-direct"),G("certhash")),sb=at(ce(d4,G("p2p")),d4),h4=ce(SO,G("webtransport"),G("certhash"),G("certhash")),ob=at(ce(h4,G("p2p")),h4),ab=at(ce(md,G("p2p-webrtc-star"),G("p2p")),ce(yd,G("p2p-webrtc-star"),G("p2p")),ce(md,G("p2p-webrtc-star")),ce(yd,G("p2p-webrtc-star")));at(ce(md,G("p2p-websocket-star"),G("p2p")),ce(yd,G("p2p-websocket-star"),G("p2p")),ce(md,G("p2p-websocket-star")),ce(yd,G("p2p-websocket-star")));const cb=at(ce(N0,G("p2p-webrtc-direct"),G("p2p")),ce(L0,G("p2p-webrtc-direct"),G("p2p")),ce(N0,G("p2p-webrtc-direct")),ce(L0,G("p2p-webrtc-direct"))),Us=at(O0,D0,N0,L0,ab,cb,Jo,bO,vO,Ms,sb,ob);at(ce(Us,G("p2p-stardust"),G("p2p")),ce(Us,G("p2p-stardust")));const Li=at(ce(Us,G("p2p")),ab,cb,sb,ob,G("p2p")),f4=at(ce(Li,G("p2p-circuit"),Li),ce(Li,G("p2p-circuit")),ce(G("p2p-circuit"),Li),ce(Us,G("p2p-circuit")),ce(G("p2p-circuit"),Us),G("p2p-circuit")),lb=()=>at(ce(f4,lb),f4),ms=lb(),EO=at(ce(ms,Li,ms),ce(Li,ms),ce(ms,Li),ms,Li);at(ce(ms,G("webrtc"),G("p2p")),ce(ms,G("webrtc")),ce(Us,G("webrtc"),G("p2p")),ce(Us,G("webrtc")),G("webrtc"));function ub(n){function e(t){let r;try{r=fe(t)}catch{return!1}const i=n(r.protoNames());return i===null?!1:i===!0||i===!1?i:i.length===0}return e}function ce(...n){function e(t){if(t.length<n.length)return null;let r=t;return n.some(i=>(r=typeof i=="function"?i().partialMatch(t):i.partialMatch(t),Array.isArray(r)&&(t=r),r===null)),r}return{toString:function(){return"{ "+n.join(" ")+" }"},input:n,matches:ub(e),partialMatch:e}}function at(...n){function e(r){let i=null;return n.some(s=>{const o=typeof s=="function"?s().partialMatch(r):s.partialMatch(r);return o!=null?(i=o,!0):!1}),i}return{toString:function(){return"{ "+n.join(" ")+" }"},input:n,matches:ub(e),partialMatch:e}}function G(n){const e=n;function t(i){let s;try{s=fe(i)}catch{return!1}const o=s.protoNames();return o.length===1&&o[0]===e}function r(i){return i.length===0?null:i[0]===e?i.slice(1):null}return{toString:function(){return e},matches:t,partialMatch:r}}const xO="bootstrap",AO=50,kO=1e3;var y6,w6,b6,v6;class db extends(v6=ot,b6=Vu,w6=Symbol.toStringTag,y6=kt,v6){constructor(t,r={list:[]}){if(r.list==null||r.list.length===0)throw new Error("Bootstrap requires a list of peer addresses");super();l(this,"log");l(this,"timer");l(this,"list");l(this,"timeout");l(this,"components");l(this,"_init");l(this,b6,this);l(this,w6,"@libp2p/bootstrap");l(this,y6,["@libp2p/peer-discovery"]);this.components=t,this.log=t.logger.forComponent("libp2p:bootstrap"),this.timeout=r.timeout??kO,this.list=[];for(const i of r.list){if(!EO.matches(i)){this.log.error("Invalid multiaddr");continue}const s=fe(i),o=s.getPeerId();if(o==null){this.log.error("Invalid bootstrap multiaddr without peer id");continue}const a={id:Ur(o),multiaddrs:[s]};this.list.push(a)}this._init=r}isStarted(){return!!this.timer}start(){this.isStarted()||(this.log("Starting bootstrap node discovery, discovering peers after %s ms",this.timeout),this.timer=setTimeout(()=>{this._discoverBootstrapPeers().catch(t=>{this.log.error(t)})},this.timeout))}async _discoverBootstrapPeers(){if(this.timer!=null)for(const t of this.list){if(await this.components.peerStore.merge(t.id,{tags:{[this._init.tagName??xO]:{value:this._init.tagValue??AO,ttl:this._init.tagTTL}},multiaddrs:t.multiaddrs}),this.timer==null)return;this.safeDispatchEvent("peer",{detail:t}),this.components.connectionManager.openConnection(t.id).catch(r=>{this.log.error("could not dial bootstrap peer %p",t.id,r)})}}stop(){this.timer!=null&&clearTimeout(this.timer),this.timer=void 0}}l(db,"tag","bootstrap");function _O(n){return e=>new db(e,n)}const IO=290,CO=1,hb=2e3,TO=100,Jl=`${yh}-circuit-relay`;BigInt(1<<17);const wd="/libp2p/circuit/relay/0.2.0/hop",p4="/libp2p/circuit/relay/0.2.0/stop",g4=300,RO=4096,PO=.001;var ea;(function(n){(function(r){r.RESERVE="RESERVE",r.CONNECT="CONNECT",r.STATUS="STATUS"})(n.Type||(n.Type={}));let e;(function(r){r[r.RESERVE=0]="RESERVE",r[r.CONNECT=1]="CONNECT",r[r.STATUS=2]="STATUS"})(e||(e={})),function(r){r.codec=()=>Wt(e)}(n.Type||(n.Type={}));let t;n.codec=()=>(t==null&&(t=me((r,i,s={})=>{s.lengthDelimited!==!1&&i.fork(),r.type!=null&&(i.uint32(8),n.Type.codec().encode(r.type,i)),r.peer!=null&&(i.uint32(18),ta.codec().encode(r.peer,i)),r.reservation!=null&&(i.uint32(26),bd.codec().encode(r.reservation,i)),r.limit!=null&&(i.uint32(34),ra.codec().encode(r.limit,i)),r.status!=null&&(i.uint32(40),$t.codec().encode(r.status,i)),s.lengthDelimited!==!1&&i.ldelim()},(r,i,s={})=>{var c,u,d;const o={},a=i==null?r.len:r.pos+i;for(;r.pos<a;){const h=r.uint32();switch(h>>>3){case 1:{o.type=n.Type.codec().decode(r);break}case 2:{o.peer=ta.codec().decode(r,r.uint32(),{limits:(c=s.limits)==null?void 0:c.peer});break}case 3:{o.reservation=bd.codec().decode(r,r.uint32(),{limits:(u=s.limits)==null?void 0:u.reservation});break}case 4:{o.limit=ra.codec().decode(r,r.uint32(),{limits:(d=s.limits)==null?void 0:d.limit});break}case 5:{o.status=$t.codec().decode(r);break}default:{r.skipType(h&7);break}}}return o})),t),n.encode=r=>ye(r,n.codec()),n.decode=(r,i)=>we(r,n.codec(),i)})(ea||(ea={}));var Ln;(function(n){(function(r){r.CONNECT="CONNECT",r.STATUS="STATUS"})(n.Type||(n.Type={}));let e;(function(r){r[r.CONNECT=0]="CONNECT",r[r.STATUS=1]="STATUS"})(e||(e={})),function(r){r.codec=()=>Wt(e)}(n.Type||(n.Type={}));let t;n.codec=()=>(t==null&&(t=me((r,i,s={})=>{s.lengthDelimited!==!1&&i.fork(),r.type!=null&&(i.uint32(8),n.Type.codec().encode(r.type,i)),r.peer!=null&&(i.uint32(18),ta.codec().encode(r.peer,i)),r.limit!=null&&(i.uint32(26),ra.codec().encode(r.limit,i)),r.status!=null&&(i.uint32(32),$t.codec().encode(r.status,i)),s.lengthDelimited!==!1&&i.ldelim()},(r,i,s={})=>{var c,u;const o={},a=i==null?r.len:r.pos+i;for(;r.pos<a;){const d=r.uint32();switch(d>>>3){case 1:{o.type=n.Type.codec().decode(r);break}case 2:{o.peer=ta.codec().decode(r,r.uint32(),{limits:(c=s.limits)==null?void 0:c.peer});break}case 3:{o.limit=ra.codec().decode(r,r.uint32(),{limits:(u=s.limits)==null?void 0:u.limit});break}case 4:{o.status=$t.codec().decode(r);break}default:{r.skipType(d&7);break}}}return o})),t),n.encode=r=>ye(r,n.codec()),n.decode=(r,i)=>we(r,n.codec(),i)})(Ln||(Ln={}));var ta;(function(n){let e;n.codec=()=>(e==null&&(e=me((t,r,i={})=>{if(i.lengthDelimited!==!1&&r.fork(),t.id!=null&&t.id.byteLength>0&&(r.uint32(10),r.bytes(t.id)),t.addrs!=null)for(const s of t.addrs)r.uint32(18),r.bytes(s);i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{var a;const s={id:Fe(0),addrs:[]},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const c=t.uint32();switch(c>>>3){case 1:{s.id=t.bytes();break}case 2:{if(((a=i.limits)==null?void 0:a.addrs)!=null&&s.addrs.length===i.limits.addrs)throw new It('Decode error - map field "addrs" had too many elements');s.addrs.push(t.bytes());break}default:{t.skipType(c&7);break}}}return s})),e),n.encode=t=>ye(t,n.codec()),n.decode=(t,r)=>we(t,n.codec(),r)})(ta||(ta={}));var bd;(function(n){let e;n.codec=()=>(e==null&&(e=me((t,r,i={})=>{if(i.lengthDelimited!==!1&&r.fork(),t.expire!=null&&t.expire!==0n&&(r.uint32(8),r.uint64(t.expire)),t.addrs!=null)for(const s of t.addrs)r.uint32(18),r.bytes(s);t.voucher!=null&&(r.uint32(26),Sd.codec().encode(t.voucher,r)),i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{var a,c;const s={expire:0n,addrs:[]},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const u=t.uint32();switch(u>>>3){case 1:{s.expire=t.uint64();break}case 2:{if(((a=i.limits)==null?void 0:a.addrs)!=null&&s.addrs.length===i.limits.addrs)throw new It('Decode error - map field "addrs" had too many elements');s.addrs.push(t.bytes());break}case 3:{s.voucher=Sd.codec().decode(t,t.uint32(),{limits:(c=i.limits)==null?void 0:c.voucher});break}default:{t.skipType(u&7);break}}}return s})),e),n.encode=t=>ye(t,n.codec()),n.decode=(t,r)=>we(t,n.codec(),r)})(bd||(bd={}));var ra;(function(n){let e;n.codec=()=>(e==null&&(e=me((t,r,i={})=>{i.lengthDelimited!==!1&&r.fork(),t.duration!=null&&(r.uint32(8),r.uint32(t.duration)),t.data!=null&&(r.uint32(16),r.uint64(t.data)),i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{const s={},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.duration=t.uint32();break}case 2:{s.data=t.uint64();break}default:{t.skipType(a&7);break}}}return s})),e),n.encode=t=>ye(t,n.codec()),n.decode=(t,r)=>we(t,n.codec(),r)})(ra||(ra={}));var $t;(function(n){n.UNUSED="UNUSED",n.OK="OK",n.RESERVATION_REFUSED="RESERVATION_REFUSED",n.RESOURCE_LIMIT_EXCEEDED="RESOURCE_LIMIT_EXCEEDED",n.PERMISSION_DENIED="PERMISSION_DENIED",n.CONNECTION_FAILED="CONNECTION_FAILED",n.NO_RESERVATION="NO_RESERVATION",n.MALFORMED_MESSAGE="MALFORMED_MESSAGE",n.UNEXPECTED_MESSAGE="UNEXPECTED_MESSAGE"})($t||($t={}));var B0;(function(n){n[n.UNUSED=0]="UNUSED",n[n.OK=100]="OK",n[n.RESERVATION_REFUSED=200]="RESERVATION_REFUSED",n[n.RESOURCE_LIMIT_EXCEEDED=201]="RESOURCE_LIMIT_EXCEEDED",n[n.PERMISSION_DENIED=202]="PERMISSION_DENIED",n[n.CONNECTION_FAILED=203]="CONNECTION_FAILED",n[n.NO_RESERVATION=204]="NO_RESERVATION",n[n.MALFORMED_MESSAGE=400]="MALFORMED_MESSAGE",n[n.UNEXPECTED_MESSAGE=401]="UNEXPECTED_MESSAGE"})(B0||(B0={}));(function(n){n.codec=()=>Wt(B0)})($t||($t={}));var vd;(function(n){let e;n.codec=()=>(e==null&&(e=me((t,r,i={})=>{i.lengthDelimited!==!1&&r.fork(),t.relay!=null&&t.relay.byteLength>0&&(r.uint32(10),r.bytes(t.relay)),t.peer!=null&&t.peer.byteLength>0&&(r.uint32(18),r.bytes(t.peer)),t.expiration!=null&&t.expiration!==0n&&(r.uint32(24),r.uint64(t.expiration)),i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{const s={relay:Fe(0),peer:Fe(0),expiration:0n},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.relay=t.bytes();break}case 2:{s.peer=t.bytes();break}case 3:{s.expiration=t.uint64();break}default:{t.skipType(a&7);break}}}return s})),e),n.encode=t=>ye(t,n.codec()),n.decode=(t,r)=>we(t,n.codec(),r)})(vd||(vd={}));var Sd;(function(n){let e;n.codec=()=>(e==null&&(e=me((t,r,i={})=>{i.lengthDelimited!==!1&&r.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(r.uint32(10),r.bytes(t.publicKey)),t.payloadType!=null&&t.payloadType.byteLength>0&&(r.uint32(18),r.bytes(t.payloadType)),t.payload!=null&&(r.uint32(26),vd.codec().encode(t.payload,r)),t.signature!=null&&t.signature.byteLength>0&&(r.uint32(42),r.bytes(t.signature)),i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{var a;const s={publicKey:Fe(0),payloadType:Fe(0),signature:Fe(0)},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const c=t.uint32();switch(c>>>3){case 1:{s.publicKey=t.bytes();break}case 2:{s.payloadType=t.bytes();break}case 3:{s.payload=vd.codec().decode(t,t.uint32(),{limits:(a=i.limits)==null?void 0:a.payload});break}case 5:{s.signature=t.bytes();break}default:{t.skipType(c&7);break}}}return s})),e),n.encode=t=>ye(t,n.codec()),n.decode=(t,r)=>we(t,n.codec(),r)})(Sd||(Sd={}));class M0 extends Error{constructor(){super(...arguments);l(this,"name","HadEnoughRelaysError")}}l(M0,"name","HadEnoughRelaysError");class fb extends Error{constructor(){super(...arguments);l(this,"name","DoubleRelayError")}}l(fb,"name","DoubleRelayError");class pb extends Error{constructor(){super(...arguments);l(this,"name","RelayQueueFullError")}}l(pb,"name","RelayQueueFullError");function m4(n){const e=n*BigInt(1e3),t=new Date().getTime();return Number(e-BigInt(t))}class y4{constructor(e){l(this,"expires");l(this,"bytes");(e==null?void 0:e.duration)!=null&&(e==null?void 0:e.duration)!==0&&(this.expires=Date.now()+e.duration*1e3),this.bytes=e==null?void 0:e.data,this.bytes===0n&&(this.bytes=void 0),this.onData=this.onData.bind(this)}onData(e){this.bytes!=null&&(this.bytes-=BigInt(e.byteLength),this.bytes<0n&&(this.bytes=0n))}getLimits(){if(this.expires==null&&this.bytes==null)return;const e={};if(this.bytes!=null){const t=this;Object.defineProperty(e,"bytes",{get(){return t.bytes}})}if(this.expires!=null){const t=this;Object.defineProperty(e,"seconds",{get(){return Math.round(((t.expires??0)-Date.now())/1e3)}})}return e}}const gb=He(Be(q7.matchers[0],Ke(il))),mb=He(Ke(il));function w4(n){const{stream:e,remoteAddr:t,log:r,onDataRead:i,onDataWrite:s}=n;let o=!1,a=!1;const c=e.close.bind(e);e.close=async p=>{await c(p),f(!0)};const u=e.abort.bind(e);e.abort=p=>{u(p),f(!0)};const d=e.sink.bind(e);e.sink=async p=>{try{await d(_t(p,m=>Zu(m,w=>s==null?void 0:s(w))))}catch(m){h.log.error("errored - %e",m),m.type!=="aborted"&&h.log.error("%s error in sink - %e",t,m)}finally{a=!0,f()}};const h={log:r.newScope("stream-to-maconn"),sink:e.sink,source:async function*(){try{for await(const p of e.source)i==null||i(p),yield p}finally{o=!0,f()}}(),remoteAddr:t,timeline:{open:Date.now(),close:void 0},close:e.close,abort:e.abort};function f(p){p===!0&&(o=!0,a=!0),o&&a&&h.timeline.close==null&&(h.timeline.close=Date.now())}return h}class OO extends ot{constructor(t,r={}){super();l(this,"components");l(this,"started");l(this,"running");l(this,"topologyId");l(this,"log");l(this,"discoveryController");l(this,"filter");l(this,"queue");this.log=t.logger.forComponent("libp2p:circuit-relay:discover-relays"),this.components=t,this.started=!1,this.running=!1,this.filter=r.filter,this.discoveryController=new AbortController,this.discoveryController.signal,this.dialPeer=this.dialPeer.bind(this),this.onPeer=this.onPeer.bind(this)}isStarted(){return this.started}async start(){this.topologyId=await this.components.registrar.register(wd,{filter:this.filter,onConnect:t=>{var r,i;this.log.trace("discovered relay %p queue (length: %d, active %d)",t,(r=this.queue)==null?void 0:r.size,(i=this.queue)==null?void 0:i.running),this.safeDispatchEvent("relay:discover",{detail:t})}}),this.started=!0}stop(){this.topologyId!=null&&this.components.registrar.unregister(this.topologyId),this.running&&this.stopDiscovery(),this.started=!1}startDiscovery(){this.running||(this.log("start discovery"),this.running=!0,this.discoveryController=new AbortController,this.discoveryController.signal,this.components.events.addEventListener("peer:discovery",this.onPeer),Promise.resolve().then(async()=>{var i;this.log("searching peer store for relays");const t=await this.components.peerStore.all({filters:[s=>s.protocols.includes(wd)],orders:[()=>Math.random()<.5?1:-1,(s,o)=>{const a=b4(s),c=b4(o);return a>c?-1:c>a?1:0}]});for(const s of t)this.log.trace("found relay peer %p in peer store",s.id),this.safeDispatchEvent("relay:discover",{detail:s.id});this.log("found %d relay peers in peer store",t.length);const r=this.queue=new Gi({concurrency:5});this.log("start random walk");for await(const s of this.components.randomWalk.walk({signal:this.discoveryController.signal})){if(this.log.trace("found random peer %p",s.id),r.has(s.id)){this.log.trace("random peer %p was already in queue",s.id);continue}if(((i=this.components.connectionManager.getConnections(s.id))==null?void 0:i.length)>0){this.log.trace("random peer %p was already connected",s.id);continue}if(!await this.components.connectionManager.isDialable(s.multiaddrs)){this.log.trace("random peer %p was not dialable",s.id,s.multiaddrs.map(o=>o.toString()));continue}r.queued>10&&(this.log.trace("wait for space in queue for %p",s.id),await r.onSizeLessThan(10,{signal:this.discoveryController.signal})),this.log("adding random peer %p to dial queue (length: %d, active %d)",s.id,r.size,r.running),r.add(this.dialPeer,{peerId:s.id,signal:this.discoveryController.signal}).catch(o=>{this.log.error("error opening connection to random peer %p",s.id,o)})}this.log("stop random walk"),await r.onIdle()}).catch(t=>{this.discoveryController.signal.aborted||this.log.error("failed when finding relays on the network",t)}))}stopDiscovery(){var t,r;this.log("stop discovery"),this.running=!1,(t=this.discoveryController)==null||t.abort(),(r=this.queue)==null||r.clear(),this.components.events.removeEventListener("peer:discovery",this.onPeer)}onPeer(t){this.log.trace("maybe dialing discovered peer %p - %e",t.detail.id),this.maybeDialPeer(t).catch(r=>{this.log.trace("error dialing discovered peer %p - %e",t.detail.id,r)})}async maybeDialPeer(t){var s,o;if(this.queue==null)return;const r=t.detail.id,i=t.detail.multiaddrs;if(this.queue.has(r)){this.log.trace("random peer %p was already in queue",r);return}if(((s=this.components.connectionManager.getConnections(r))==null?void 0:s.length)>0){this.log.trace("random peer %p was already connected",r);return}if(!await this.components.connectionManager.isDialable(i)){this.log.trace("random peer %p was not dialable",r);return}(o=this.queue)==null||o.add(this.dialPeer,{peerId:t.detail.id,signal:this.discoveryController.signal}).catch(a=>{this.log.error("error opening connection to discovered peer %p",t.detail.id,a)})}async dialPeer({peerId:t,signal:r}){const i=Le([AbortSignal.timeout(5e3),r]);try{await this.components.connectionManager.openConnection(t,{signal:i})}finally{i.clear()}}}function b4(n){const e=n.metadata.get("last-dial-success");return e==null?0:new Date(U(e)).getTime()}class DO extends ot{constructor(t,r={}){super();l(this,"connectionManager");l(this,"addressManager");l(this,"reservationStore");l(this,"listeningAddrs");l(this,"log");l(this,"listenTimeout");l(this,"reservationId");l(this,"relay");l(this,"_onRemoveRelayPeer",t=>{var r,i;this.log("relay removed %p our relay %p",t.detail.relay,this.relay,(r=this.relay)==null?void 0:r.equals(t.detail.relay)),((i=this.relay)==null?void 0:i.equals(t.detail.relay))===!0&&(this.log("relay peer removed %p",t.detail.relay),this.listeningAddrs.forEach(s=>{this.addressManager.removeObservedAddr(s)}),this.listeningAddrs=[],this.safeDispatchEvent("listening"))});l(this,"_onAddRelayPeer",t=>{const{details:r}=t.detail;r.type!=="configured"&&r.id===this.reservationId&&this.addedRelay(t.detail)});this.log=t.logger.forComponent("libp2p:circuit-relay:transport:listener"),this.connectionManager=t.connectionManager,this.addressManager=t.addressManager,this.reservationStore=t.reservationStore,this.listeningAddrs=[],this.listenTimeout=r.listenTimeout??hb,this.reservationStore.addEventListener("relay:removed",this._onRemoveRelayPeer),this.reservationStore.addEventListener("relay:created-reservation",this._onAddRelayPeer)}async listen(t){if(mb.exactMatch(t))this.log("searching for circuit relay servers"),this.reservationId=this.reservationStore.reserveRelay();else if(gb.exactMatch(t)){this.log("listen on specific relay server %a",t);const r=AbortSignal.timeout(this.listenTimeout),i=t.decapsulate("/p2p-circuit"),s=await this.connectionManager.openConnection(i,{signal:r});if(!this.reservationStore.hasReservation(s.remotePeer)){this.log("making reservation on peer %p",s.remotePeer);const o=await this.reservationStore.addRelay(s.remotePeer,"configured");this.addedRelay(o)}}else throw new Ku(`Could not listen on p2p-circuit address "${t}"`)}getAddrs(){return[...this.listeningAddrs.values()].flat()}updateAnnounceAddrs(){}async close(){this.reservationStore.cancelReservations(),this.listeningAddrs=[],this.reservationStore.removeEventListener("relay:removed",this._onRemoveRelayPeer),queueMicrotask(()=>{this.safeDispatchEvent("close")})}addedRelay(t){this.log("relay peer added %p",t.relay),this.relay=t.relay,this.listeningAddrs=t.details.reservation.addrs.map(r=>fe(r).encapsulate("/p2p-circuit")),this.listeningAddrs.forEach(r=>{this.addressManager.confirmObservedAddr(r,{type:"transport"})}),queueMicrotask(()=>{this.safeDispatchEvent("listening")})}}function NO(n){return new DO(n)}const LO=60*1e3*10,BO=60*1e3*5,MO=30*1e3;var nr,yb,Xa,Za;class UO extends ot{constructor(t,r){super();pe(this,nr);l(this,"peerId");l(this,"connectionManager");l(this,"peerStore");l(this,"events");l(this,"reserveQueue");l(this,"reservations");l(this,"pendingReservations");l(this,"maxReservationQueueLength");l(this,"reservationCompletionTimeout");l(this,"started");l(this,"log");l(this,"relayFilter");this.log=t.logger.forComponent("libp2p:circuit-relay:transport:reservation-store"),this.peerId=t.peerId,this.connectionManager=t.connectionManager,this.peerStore=t.peerStore,this.events=t.events,this.reservations=new eo,this.pendingReservations=[],this.maxReservationQueueLength=(r==null?void 0:r.maxReservationQueueLength)??TO,this.reservationCompletionTimeout=(r==null?void 0:r.reservationCompletionTimeout)??hb,this.started=!1,this.relayFilter=Qi(100),this.reserveQueue=new Gi({concurrency:(r==null?void 0:r.reservationConcurrency)??CO,metricName:"libp2p_relay_reservation_queue",metrics:t.metrics}),this.events.addEventListener("connection:close",i=>{[...this.reservations.values()].find(o=>o.connection===i.detail.id)!=null&&D(this,nr,Xa).call(this,i.detail.remotePeer).catch(o=>{this.log("could not remove relay %p - %e",i.detail,o)})})}isStarted(){return this.started}start(){this.started=!0}afterStart(){Promise.resolve().then(async()=>{const t=await this.peerStore.all({filters:[r=>r.tags.has(Jl)]});this.log("removing tag from %d old relays",t.length),await Promise.all(t.map(async r=>{await this.peerStore.merge(r.id,{tags:{[Jl]:void 0}})})),this.log("redialing %d old relays",t.length),await Promise.all(t.map(async r=>this.addRelay(r.id,"discovered"))),D(this,nr,Za).call(this)}).catch(t=>{this.log.error(t)})}stop(){this.reserveQueue.clear(),this.reservations.forEach(({timeout:t})=>{clearTimeout(t)}),this.reservations.clear(),this.started=!1}reserveRelay(){const t=SE();return this.pendingReservations.push(t),D(this,nr,Za).call(this),t}async addRelay(t,r){if(this.peerId.equals(t))throw this.log.trace("not trying to use self as relay"),new Ku("Cannot use self as relay");if(this.reserveQueue.size>this.maxReservationQueueLength)throw new pb("The reservation queue is full");const i=this.reserveQueue.find(t);if(i!=null)return this.log.trace("potential relay peer %p is already in the reservation queue",t),i.join();if(this.relayFilter.has(t.toMultihash().bytes))throw new Ku("The relay was previously invalid");return this.log.trace("try to reserve relay slot with %p",t),this.reserveQueue.add(async()=>{const s=Date.now();try{const o=this.reservations.get(t);if(o!=null){const w=this.connectionManager.getConnections(t);let b=!1;if(w.length===0&&this.log("already have relay reservation with %p but we are no longer connected",t),w.map(S=>S.id).includes(o.connection)&&(this.log("already have relay reservation with %p and the original connection is still open",t),b=!0),b&&m4(o.reservation.expire)>LO)return this.log("already have relay reservation with %p but we are still connected and it does not expire soon",t),{relay:t,details:o};await D(this,nr,Xa).call(this,t)}if(r==="discovered"&&this.pendingReservations.length===0)throw new M0("Not making reservation on discovered relay because we do not need any more relays");const a=AbortSignal.timeout(this.reservationCompletionTimeout);const c=await this.connectionManager.openConnection(t,{signal:a});if(Yi.matches(c.remoteAddr))throw new fb("not creating reservation over relayed connection");const u=await D(this,nr,yb).call(this,c,{signal:a}),d=m4(u.expire);this.log("created reservation on relay peer %p, expiry date is %s",t,new Date(Date.now()+d).toString());const h=Math.min(Math.max(d-BO,MO),Math.pow(2,31)-1),f=setTimeout(()=>{this.log("refresh reservation to relay %p",t),this.addRelay(t,r).catch(async w=>{this.log.error("could not refresh reservation to relay %p - %e",t,w),await D(this,nr,Xa).call(this,t)}).catch(w=>{this.log.error("could not remove expired reservation to relay %p - %e",t,w)})},h);let p;if(r==="discovered"){const w=this.pendingReservations.pop();if(w==null)throw new M0("Made reservation on relay but did not need any more discovered relays");p={timeout:f,reservation:u,type:r,connection:c.id,id:w}}else p={timeout:f,reservation:u,type:r,connection:c.id};this.reservations.set(t,p),await this.peerStore.merge(t,{tags:{[Jl]:{value:1,ttl:d}}}),D(this,nr,Za).call(this);const m={relay:t,details:p};return this.safeDispatchEvent("relay:created-reservation",{detail:m}),m}catch(o){throw r==="discovered"&&o.name==="HadEnoughRelaysError"||this.log.error("could not reserve slot on %p after %dms - %e",t,Date.now()-s,o),(o.name==="DialError"||o.name==="UnsupportedProtocolError")&&this.relayFilter.add(t.toMultihash().bytes),D(this,nr,Xa).call(this,t).catch(a=>{this.log.error("could not remove reservation on %p after reserving slot failed - %e",t,a)}),o}},{peerId:t})}hasReservation(t){return this.reservations.has(t)}getReservation(t){var r;return(r=this.reservations.get(t))==null?void 0:r.reservation}reservationCount(t){return t==null?this.reservations.size:[...this.reservations.values()].reduce((r,i)=>(i.type===t&&r++,r),0)}cancelReservations(){[...this.reservations.values()].forEach(t=>{clearTimeout(t.timeout)}),this.reservations.clear()}}nr=new WeakSet,yb=async function(t,r){var u;(u=r.signal)==null||u.throwIfAborted(),this.log("requesting reservation from %p",t.remotePeer);const i=await t.newStream(wd,r),o=Mt(i).pb(ea);this.log.trace("send RESERVE to %p",t.remotePeer),await o.write({type:ea.Type.RESERVE},r);let a;try{this.log.trace("reading response from %p",t.remotePeer),a=await o.read(r)}catch(d){throw i.abort(d),d}finally{i.status!=="closed"&&await i.close(r)}if(this.log.trace("read response %o",a),a.status===$t.OK&&a.reservation!=null){const d=new Set;d.add(t.remoteAddr.toString());for(const h of a.reservation.addrs){let f=fe(h);f.getPeerId()==null&&(f=f.encapsulate(`/p2p/${t.remotePeer}`)),f=fe(f.toString().replace(`/p2p/${t.remotePeer}/p2p/${t.remotePeer}`,`/p2p/${t.remotePeer}`)),d.add(f.toString())}return a.reservation.addrs=[...d].map(h=>fe(h).bytes),a.reservation}const c=`reservation failed with status ${a.status??"undefined"}`;throw this.log.error(c),new Error(c)},Xa=async function(t){const r=this.reservations.get(t);r!=null&&(this.log("removing relay reservation with %p from local store",t),clearTimeout(r.timeout),this.reservations.delete(t),r.type==="discovered"&&this.pendingReservations.push(r.id),await this.peerStore.merge(t,{tags:{[Jl]:void 0}}),this.safeDispatchEvent("relay:removed",{detail:{relay:t,details:r}}),D(this,nr,Za).call(this))},Za=function(){if(this.pendingReservations.length===0){this.log.trace("have discovered enough relays"),this.reserveQueue.clear(),this.safeDispatchEvent("relay:found-enough-relays");return}this.relayFilter=Qi(100),this.log("not discovered enough relays %d/%d",this.reservations.size,this.pendingReservations.length),this.safeDispatchEvent("relay:not-enough-relays")};const FO=n=>{if(n.peer==null)return!1;try{n.peer.addrs.forEach(fe)}catch{return!1}return!0},v4={maxInboundStopStreams:g4,maxOutboundStopStreams:g4};var S6,E6,x6,A6;class $O{constructor(e,t={}){l(this,"discovery");l(this,"registrar");l(this,"peerStore");l(this,"connectionManager");l(this,"transportManager");l(this,"peerId");l(this,"upgrader");l(this,"addressManager");l(this,"connectionGater");l(this,"reservationStore");l(this,"logger");l(this,"maxInboundStopStreams");l(this,"maxOutboundStopStreams");l(this,"started");l(this,"log");l(this,"shutdownController");l(this,A6,"@libp2p/circuit-relay-v2-transport");l(this,x6,["@libp2p/transport","@libp2p/circuit-relay-v2-transport"]);l(this,S6,!0);this.log=e.logger.forComponent("libp2p:circuit-relay:transport"),this.registrar=e.registrar,this.peerStore=e.peerStore,this.connectionManager=e.connectionManager,this.transportManager=e.transportManager,this.logger=e.logger,this.peerId=e.peerId,this.upgrader=e.upgrader,this.addressManager=e.addressManager,this.connectionGater=e.connectionGater,this.maxInboundStopStreams=t.maxInboundStopStreams??v4.maxInboundStopStreams,this.maxOutboundStopStreams=t.maxOutboundStopStreams??v4.maxOutboundStopStreams,this.shutdownController=new AbortController,this.discovery=new OO(e,{filter:t.discoveryFilter??jA(RO,PO)}),this.discovery.addEventListener("relay:discover",r=>{this.reservationStore.addRelay(r.detail,"discovered").catch(i=>{i.name!=="HadEnoughRelaysError"&&i.name!=="RelayQueueFullError"&&this.log.error("could not add discovered relay %p",r.detail,i)})}),this.reservationStore=new UO(e,t),this.reservationStore.addEventListener("relay:not-enough-relays",()=>{var r;(r=this.discovery)==null||r.startDiscovery()}),this.reservationStore.addEventListener("relay:found-enough-relays",()=>{var r;(r=this.discovery)==null||r.stopDiscovery()}),this.started=!1}get[(A6=Symbol.toStringTag,x6=kt,E6=Ps,S6=wh,E6)](){return this.discovery!=null?["@libp2p/identify"]:[]}isStarted(){return this.started}async start(){this.shutdownController=new AbortController,this.shutdownController.signal,await this.registrar.handle(p4,e=>{const t=this.upgrader.createInboundAbortSignal(this.shutdownController.signal);this.onStop(e,t).catch(r=>{this.log.error("error while handling STOP protocol",r),e.stream.abort(r)}).finally(()=>{t.clear()})},{maxInboundStreams:this.maxInboundStopStreams,maxOutboundStreams:this.maxOutboundStopStreams,runOnLimitedConnection:!0}),await li(this.discovery,this.reservationStore),this.started=!0}async stop(){this.shutdownController.abort(),await rs(this.discovery,this.reservationStore),await this.registrar.unhandle(p4),this.started=!1}async dial(e,t){var p,m,w,b,S,k;if(e.protoCodes().filter(C=>C===IO).length!==1){const C="Invalid circuit relay address";throw this.log.error(C,e),new Io(C)}const r=e.toString().split("/p2p-circuit"),i=fe(r[0]),s=fe(r[r.length-1]),o=i.getPeerId(),a=s.getPeerId();if(o==null||a==null){const C=`ircuit relay dial to ${e.toString()} failed as address did not have both relay and destination PeerIDs`;throw this.log.error(`c${C}`),new Io(`C${C}`)}const c=Ur(o),u=Ur(a);let h=this.connectionManager.getConnections(c)[0];h==null?(await this.peerStore.merge(c,{multiaddrs:[i]}),(p=t.onProgress)==null||p.call(t,new N("circuit-relay:open-connection")),h=await this.connectionManager.openConnection(c,t)):(m=t.onProgress)==null||m.call(t,new N("circuit-relay:reuse-connection"));let f;try{(w=t.onProgress)==null||w.call(t,new N("circuit-relay:open-hop-stream")),f=await h.newStream(wd,t);const C=Mt(f),Q=C.pb(ea);(b=t.onProgress)==null||b.call(t,new N("circuit-relay:write-connect-message")),await Q.write({type:ea.Type.CONNECT,peer:{id:u.toMultihash().bytes,addrs:[fe(s).bytes]}},t),(S=t.onProgress)==null||S.call(t,new N("circuit-relay:read-connect-response"));const re=await Q.read(t);if(re.status!==$t.OK)throw new qe(`failed to connect via relay with status ${((k=re==null?void 0:re.status)==null?void 0:k.toString())??"undefined"}`);const T=new y4(re.limit),Y=w4({stream:C.unwrap(),remoteAddr:e,localAddr:i.encapsulate(`/p2p-circuit/p2p/${this.peerId.toString()}`),log:this.log,onDataRead:T.onData,onDataWrite:T.onData}),se=await this.upgrader.upgradeOutbound(Y,{...t,limits:T.getLimits()});return se.log("outbound relayed connection established to %p with limits %o, over connection %s",se.remotePeer,re.limit??"none",h.id),se}catch(C){throw this.log.error("circuit relay dial to destination %p via relay %p failed",u,c,C),f==null||f.abort(C),C}}createListener(e){return NO({peerId:this.peerId,connectionManager:this.connectionManager,addressManager:this.addressManager,reservationStore:this.reservationStore,logger:this.logger})}listenFilter(e){return e=Array.isArray(e)?e:[e],e.filter(t=>gb.exactMatch(t)||mb.exactMatch(t))}dialFilter(e){return e=Array.isArray(e)?e:[e],e.filter(t=>Yi.exactMatch(t))}async onStop({connection:e,stream:t},r){var d,h;if(!this.reservationStore.hasReservation(e.remotePeer))try{this.log("dialed via relay we did not have a reservation on, start listening on that relay address"),await this.transportManager.listen([e.remoteAddr.encapsulate("/p2p-circuit")])}catch(f){this.log.error("failed to listen on a relay peer we were dialed via but did not have a reservation on",f)}const i=Mt(t).pb(Ln),s=await i.read({signal:r});if(this.log("new circuit relay v2 stop stream from %p with type %s",e.remotePeer,s.type),(s==null?void 0:s.type)===void 0){this.log.error("type was missing from circuit v2 stop protocol request from %s",e.remotePeer),await i.write({type:Ln.Type.STATUS,status:$t.MALFORMED_MESSAGE},{signal:r}),await t.close();return}if(s.type!==Ln.Type.CONNECT){this.log.error("invalid stop connect request via peer %p",e.remotePeer),await i.write({type:Ln.Type.STATUS,status:$t.UNEXPECTED_MESSAGE},{signal:r}),await t.close();return}if(!FO(s)){this.log.error("invalid stop connect request via peer %p",e.remotePeer),await i.write({type:Ln.Type.STATUS,status:$t.MALFORMED_MESSAGE},{signal:r}),await t.close({signal:r});return}const o=ln(Pt(s.peer.id));if(await((h=(d=this.connectionGater).denyInboundRelayedConnection)==null?void 0:h.call(d,e.remotePeer,o))===!0){this.log.error("connection gater denied inbound relayed connection from %p",e.remotePeer),await i.write({type:Ln.Type.STATUS,status:$t.PERMISSION_DENIED},{signal:r}),await t.close({signal:r});return}this.log.trace("sending success response to %p",e.remotePeer),await i.write({type:Ln.Type.STATUS,status:$t.OK},{signal:r});const a=new y4(s.limit),c=e.remoteAddr.encapsulate(`/p2p-circuit/p2p/${o.toString()}`);this.addressManager.getAddresses()[0];const u=w4({stream:i.unwrap().unwrap(),remoteAddr:c,log:this.log,onDataRead:a.onData,onDataWrite:a.onData});await this.upgrader.upgradeInbound(u,{limits:a.getLimits(),signal:r}),u.log("inbound relayed connection established to %p with limits %o, over connection %s",o,s.limit??"none",e.id)}}function HO(n={}){return e=>new $O(e,n)}var yn;(function(n){(function(r){r.UNUSED="UNUSED",r.CONNECT="CONNECT",r.SYNC="SYNC"})(n.Type||(n.Type={}));let e;(function(r){r[r.UNUSED=0]="UNUSED",r[r.CONNECT=100]="CONNECT",r[r.SYNC=300]="SYNC"})(e||(e={})),function(r){r.codec=()=>Wt(e)}(n.Type||(n.Type={}));let t;n.codec=()=>(t==null&&(t=me((r,i,s={})=>{if(s.lengthDelimited!==!1&&i.fork(),r.type!=null&&(i.uint32(8),n.Type.codec().encode(r.type,i)),r.observedAddresses!=null)for(const o of r.observedAddresses)i.uint32(18),i.bytes(o);s.lengthDelimited!==!1&&i.ldelim()},(r,i,s={})=>{var c;const o={observedAddresses:[]},a=i==null?r.len:r.pos+i;for(;r.pos<a;){const u=r.uint32();switch(u>>>3){case 1:{o.type=n.Type.codec().decode(r);break}case 2:{if(((c=s.limits)==null?void 0:c.observedAddresses)!=null&&o.observedAddresses.length===s.limits.observedAddresses)throw new It('Decode error - map field "observedAddresses" had too many elements');o.observedAddresses.push(r.bytes());break}default:{r.skipType(u&7);break}}}return o})),t),n.encode=r=>ye(r,n.codec()),n.decode=(r,i)=>we(r,n.codec(),i)})(yn||(yn={}));function S4(n,e){return Yi.matches(n)||e.dialTransportForMultiaddr(n)==null?!1:U7.matches(n)?!0:b_.matches(n)?ns(n.toOptions().host)===!1:!1}const E4=1024*4,x4=100,eu={timeout:5e3,retries:3,maxInboundStreams:1,maxOutboundStreams:1};var k6,_6;_6=Symbol.toStringTag,k6=Ps;class VO{constructor(e,t){l(this,"started");l(this,"timeout");l(this,"retries");l(this,"maxInboundStreams");l(this,"maxOutboundStreams");l(this,"peerStore");l(this,"registrar");l(this,"connectionManager");l(this,"addressManager");l(this,"transportManager");l(this,"topologyId");l(this,"log");l(this,_6,"@libp2p/dcutr");l(this,k6,["@libp2p/identify"]);this.log=e.logger.forComponent("libp2p:dcutr"),this.started=!1,this.peerStore=e.peerStore,this.registrar=e.registrar,this.addressManager=e.addressManager,this.connectionManager=e.connectionManager,this.transportManager=e.transportManager,this.timeout=t.timeout??eu.timeout,this.retries=t.retries??eu.retries,this.maxInboundStreams=t.maxInboundStreams??eu.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams??eu.maxOutboundStreams}isStarted(){return this.started}async start(){this.started||(this.topologyId=await this.registrar.register(tu,{notifyOnLimitedConnection:!0,onConnect:(e,t)=>{Yi.exactMatch(t.remoteAddr)&&t.direction==="inbound"&&this.upgradeInbound(t).catch(r=>{this.log.error("error during outgoing DCUtR attempt",r)})}}),await this.registrar.handle(tu,e=>{this.handleIncomingUpgrade(e.stream,e.connection).catch(t=>{this.log.error("error during incoming DCUtR attempt",t),e.stream.abort(t)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:!0}),this.started=!0)}async stop(){await this.registrar.unhandle(tu),this.topologyId!=null&&this.registrar.unregister(this.topologyId),this.started=!1}async upgradeInbound(e){if(await this.attemptUnilateralConnectionUpgrade(e))return;let t;for(let r=0;r<this.retries;r++){const i={signal:AbortSignal.timeout(this.timeout)};try{t=await e.newStream([tu],{signal:i.signal,runOnLimitedConnection:!0});const s=Mt(t,{maxDataLength:E4}).pb(yn);this.log("B sending connect to %p",e.remotePeer);const o=Date.now();await s.write({type:yn.Type.CONNECT,observedAddresses:this.addressManager.getAddresses().map(h=>h.bytes)},i),this.log("B receiving connect from %p",e.remotePeer);const a=await s.read(i);if(a.type!==yn.Type.CONNECT)throw this.log("A sent wrong message type"),new qe("DCUtR message type was incorrect");const c=this.getDialableMultiaddrs(a.observedAddresses);if(c.length===0)throw this.log("A did not have any dialable multiaddrs"),new qe("DCUtR connect message had no multiaddrs");const u=Date.now()-o;this.log("A sending sync, rtt %dms",u),await s.write({type:yn.Type.SYNC,observedAddresses:[]},i),this.log("A waiting for half RTT"),await k9(u/2),this.log("B dialing",c);const d=await this.connectionManager.openConnection(c,{signal:i.signal,priority:x4,force:!0,initiator:!1});this.log("DCUtR to %p succeeded to address %a, closing relayed connection",e.remotePeer,d.remoteAddr),await e.close(i);break}catch(s){if(this.log.error("error while attempting DCUtR on attempt %d of %d",r+1,this.retries,s),t==null||t.abort(s),r===this.retries)throw s}finally{t!=null&&await t.close(i)}}}async attemptUnilateralConnectionUpgrade(e){const r=(await this.peerStore.get(e.remotePeer)).addresses.map(i=>{const s=i.multiaddr;return s.getPeerId()==null?s.encapsulate(`/p2p/${e.remotePeer}`):s}).filter(i=>S4(i,this.transportManager));if(r.length>0){const i=AbortSignal.timeout(this.timeout);try{this.log("attempting unilateral connection upgrade to %a",r);const s=await this.connectionManager.openConnection(r,{signal:i,force:!0});if(Yi.exactMatch(s.remoteAddr))throw new Error("Could not open a new, non-limited, connection");return this.log("unilateral connection upgrade to %p succeeded via %a, closing relayed connection",e.remotePeer,s.remoteAddr),await e.close({signal:i}),!0}catch(s){this.log.error("unilateral connection upgrade to %p on addresses %a failed",e.remotePeer,r,s)}}else this.log("peer %p has no public addresses, not attempting unilateral connection upgrade",e.remotePeer);return!1}async handleIncomingUpgrade(e,t){const r={signal:AbortSignal.timeout(this.timeout)};try{const i=Mt(e,{maxDataLength:E4}).pb(yn);this.log("A receiving connect");const s=await i.read(r);if(s.type!==yn.Type.CONNECT)throw this.log("B sent wrong message type"),new qe("DCUtR message type was incorrect");if(s.observedAddresses.length===0)throw this.log("B sent no multiaddrs"),new qe("DCUtR connect message had no multiaddrs");const o=this.getDialableMultiaddrs(s.observedAddresses);if(o.length===0)throw this.log("B had no dialable multiaddrs"),new qe("DCUtR connect message had no dialable multiaddrs");if(this.log("A sending connect"),await i.write({type:yn.Type.CONNECT,observedAddresses:this.addressManager.getAddresses().map(u=>u.bytes)}),this.log("A receiving sync"),(await i.read(r)).type!==yn.Type.SYNC)throw new qe("DCUtR message type was incorrect");this.log("A dialing",o);const c=await this.connectionManager.openConnection(o,{signal:r.signal,priority:x4,force:!0});this.log("DCUtR to %p succeeded via %a, closing relayed connection",t.remotePeer,c.remoteAddr),await t.close(r)}catch(i){this.log.error("incoming DCUtR from %p failed",t.remotePeer,i),e.abort(i)}finally{await e.close(r)}}getDialableMultiaddrs(e){const t=[];for(const r of e)if(!(r==null||r.length===0))try{const i=fe(r);if(!S4(i,this.transportManager))continue;t.push(i)}catch{}return t}}const tu="/libp2p/dcutr";function zO(n={}){return e=>new VO(e,n)}const KO="0.1.0",qO="id",WO="id/push",GO="1.0.0",jO="1.0.0",QO=1024*8,YO=32,XO=1e3;var na;(function(n){let e;n.codec=()=>(e==null&&(e=me((t,r,i={})=>{if(i.lengthDelimited!==!1&&r.fork(),t.protocolVersion!=null&&(r.uint32(42),r.string(t.protocolVersion)),t.agentVersion!=null&&(r.uint32(50),r.string(t.agentVersion)),t.publicKey!=null&&(r.uint32(10),r.bytes(t.publicKey)),t.listenAddrs!=null)for(const s of t.listenAddrs)r.uint32(18),r.bytes(s);if(t.observedAddr!=null&&(r.uint32(34),r.bytes(t.observedAddr)),t.protocols!=null)for(const s of t.protocols)r.uint32(26),r.string(s);t.signedPeerRecord!=null&&(r.uint32(66),r.bytes(t.signedPeerRecord)),i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{var a,c;const s={listenAddrs:[],protocols:[]},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const u=t.uint32();switch(u>>>3){case 5:{s.protocolVersion=t.string();break}case 6:{s.agentVersion=t.string();break}case 1:{s.publicKey=t.bytes();break}case 2:{if(((a=i.limits)==null?void 0:a.listenAddrs)!=null&&s.listenAddrs.length===i.limits.listenAddrs)throw new It('Decode error - map field "listenAddrs" had too many elements');s.listenAddrs.push(t.bytes());break}case 4:{s.observedAddr=t.bytes();break}case 3:{if(((c=i.limits)==null?void 0:c.protocols)!=null&&s.protocols.length===i.limits.protocols)throw new It('Decode error - map field "protocols" had too many elements');s.protocols.push(t.string());break}case 8:{s.signedPeerRecord=t.bytes();break}default:{t.skipType(u&7);break}}}return s})),e),n.encode=t=>ye(t,n.codec()),n.decode=(t,r)=>we(t,n.codec(),r)})(na||(na={}));const Nr={protocolPrefix:"ipfs",timeout:5e3,maxInboundStreams:1,maxOutboundStreams:1,maxObservedAddresses:10,maxMessageSize:QO,runOnConnectionOpen:!0,runOnSelfUpdate:!0,runOnLimitedConnection:!0,concurrency:YO};function ZO(n){if(n!=null&&n.length>0)try{return fe(n)}catch{}}function JO(n,e){return e??n.userAgent}async function wb(n,e,t,r,i){if(t("received identify from %p",r.remotePeer),i==null)throw new qe("message was null or undefined");const s={};if(i.listenAddrs.length>0&&(s.addresses=i.listenAddrs.map(c=>({isCertified:!1,multiaddr:fe(c)}))),i.protocols.length>0&&(s.protocols=i.protocols),i.publicKey!=null){const c=on(i.publicKey);if(!Go(c).equals(r.remotePeer))throw new qe("public key did not match remote PeerId");s.publicKey=c}let o;if(i.signedPeerRecord!=null){t.trace("received signedPeerRecord from %p",r.remotePeer);let c=i.signedPeerRecord;const u=await Xi.openAndCertify(c,An.DOMAIN);let d=An.createFromProtobuf(u.payload);const h=hl(u.publicKey.toCID());if(!d.peerId.equals(h))throw new qe("signing key does not match PeerId in the PeerRecord");if(!r.remotePeer.equals(d.peerId))throw new qe("signing key does not match remote PeerId");let f;try{f=await n.get(d.peerId)}catch(p){if(p.name!=="NotFoundError")throw p}if(f!=null&&(s.metadata=f.metadata,f.peerRecordEnvelope!=null)){const p=Xi.createFromProtobuf(f.peerRecordEnvelope),m=An.createFromProtobuf(p.payload);m.seqNumber>=d.seqNumber&&(t("sequence number was lower or equal to existing sequence number - stored: %d received: %d",m.seqNumber,d.seqNumber),d=m,c=f.peerRecordEnvelope)}s.peerRecordEnvelope=c,s.addresses=d.multiaddrs.map(p=>({isCertified:!0,multiaddr:p})),o={seq:d.seqNumber,addresses:d.multiaddrs}}else t("%p did not send a signed peer record",r.remotePeer);if(t.trace("patching %p with",r.remotePeer,s),await n.patch(r.remotePeer,s),i.agentVersion!=null||i.protocolVersion!=null){const c={};i.agentVersion!=null&&(c.AgentVersion=R(i.agentVersion)),i.protocolVersion!=null&&(c.ProtocolVersion=R(i.protocolVersion)),t.trace("merging %p metadata",r.remotePeer,c),await n.merge(r.remotePeer,{metadata:c})}const a={peerId:r.remotePeer,protocolVersion:i.protocolVersion,agentVersion:i.agentVersion,publicKey:i.publicKey,listenAddrs:i.listenAddrs.map(c=>fe(c)),observedAddr:i.observedAddr==null?void 0:fe(i.observedAddr),protocols:i.protocols,signedPeerRecord:o,connection:r};return e.safeDispatchEvent("peer:identify",{detail:a}),a}class bb{constructor(e,t){l(this,"host");l(this,"protocol");l(this,"started");l(this,"timeout");l(this,"peerId");l(this,"privateKey");l(this,"peerStore");l(this,"registrar");l(this,"addressManager");l(this,"maxInboundStreams");l(this,"maxOutboundStreams");l(this,"maxMessageSize");l(this,"maxObservedAddresses");l(this,"events");l(this,"runOnLimitedConnection");l(this,"log");this.protocol=t.protocol,this.started=!1,this.peerId=e.peerId,this.privateKey=e.privateKey,this.peerStore=e.peerStore,this.registrar=e.registrar,this.addressManager=e.addressManager,this.events=e.events,this.log=t.log,this.timeout=t.timeout??Nr.timeout,this.maxInboundStreams=t.maxInboundStreams??Nr.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams??Nr.maxOutboundStreams,this.maxMessageSize=t.maxMessageSize??Nr.maxMessageSize,this.maxObservedAddresses=t.maxObservedAddresses??Nr.maxObservedAddresses,this.runOnLimitedConnection=t.runOnLimitedConnection??Nr.runOnLimitedConnection,this.host={protocolVersion:`${t.protocolPrefix??Nr.protocolPrefix}/${KO}`,agentVersion:JO(e.nodeInfo,t.agentVersion)}}isStarted(){return this.started}async start(){this.started||(await this.peerStore.merge(this.peerId,{metadata:{AgentVersion:R(this.host.agentVersion),ProtocolVersion:R(this.host.protocolVersion)}}),await this.registrar.handle(this.protocol,e=>{this.handleProtocol(e).catch(t=>{this.log.error(t)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnection}),this.started=!0)}async stop(){await this.registrar.unhandle(this.protocol),this.started=!1}}var I6,C6;class eD extends(C6=bb,I6=kt,C6){constructor(t,r={}){super(t,{...r,protocol:`/${r.protocolPrefix??Nr.protocolPrefix}/${WO}/${jO}`,log:t.logger.forComponent("libp2p:identify-push")});l(this,"connectionManager");l(this,"concurrency");l(this,"_push");l(this,I6,["@libp2p/identify-push"]);this.connectionManager=t.connectionManager,this.concurrency=r.concurrency??Nr.concurrency,this._push=xc(this.sendPushMessage.bind(this),r.debounce??XO),(r.runOnSelfUpdate??Nr.runOnSelfUpdate)&&t.events.addEventListener("self:peer:update",i=>{this.push().catch(s=>{this.log.error("error pushing updates to peers - %e",s)})})}async push(){this._push()}async sendPushMessage(){if(this.isStarted())try{const t=this.addressManager.getAddresses().map(h=>h.decapsulateCode(ba("p2p").code)),r=new An({peerId:this.peerId,multiaddrs:t}),i=await Xi.seal(r,this.privateKey),s=this.registrar.getProtocols(),o=await this.peerStore.get(this.peerId),a=U(o.metadata.get("AgentVersion")??R(this.host.agentVersion)),c=U(o.metadata.get("ProtocolVersion")??R(this.host.protocolVersion)),u=this;async function*d(){for(const h of u.connectionManager.getConnections()){const f=await u.peerStore.get(h.remotePeer),p=h.log.newScope("identify-push");f.protocols.includes(u.protocol)&&(yield async()=>{let m;const w=AbortSignal.timeout(u.timeout);try{m=await h.newStream(u.protocol,{signal:w,runOnLimitedConnection:u.runOnLimitedConnection}),await Mt(m,{maxDataLength:u.maxMessageSize}).pb(na).write({listenAddrs:t.map(S=>S.bytes),signedPeerRecord:i.marshal(),protocols:s,agentVersion:a,protocolVersion:c},{signal:w}),await m.close({signal:w})}catch(b){p.error("could not push identify update to peer",b),m==null||m.abort(b)}})}}await ui(Cn(d(),{concurrency:this.concurrency}))}catch(t){this.log.error("error pushing updates to peers - %e",t)}}async handleProtocol(t){const{connection:r,stream:i}=t,s=r.log.newScope("identify-push");try{if(this.peerId.equals(r.remotePeer))throw new Error("received push from ourselves?");const o={signal:AbortSignal.timeout(this.timeout)},c=await Mt(i,{maxDataLength:this.maxMessageSize}).pb(na).read(o);await i.close(o),await wb(this.peerStore,this.events,s,r,c)}catch(o){s.error("received invalid message",o),i.abort(o);return}s.trace("handled push from %p",r.remotePeer)}}var T6,R6;class tD extends(R6=bb,T6=kt,R6){constructor(t,r={}){super(t,{...r,protocol:`/${r.protocolPrefix??Nr.protocolPrefix}/${qO}/${GO}`,log:t.logger.forComponent("libp2p:identify")});l(this,T6,["@libp2p/identify"]);(r.runOnConnectionOpen??Nr.runOnConnectionOpen)&&t.events.addEventListener("connection:open",i=>{const s=i.detail;this.identify(s).catch(o=>{o.name!==cl.name&&this.log.error("error during identify trigged by connection:open",o)})})}async _identify(t,r={}){let i;if(r.signal==null){const s=AbortSignal.timeout(this.timeout);r={...r,signal:s}}try{i=await t.newStream(this.protocol,{...r,runOnLimitedConnection:this.runOnLimitedConnection});const o=await Mt(i,{maxDataLength:this.maxMessageSize}).pb(na).read(r);return await i.close(r),o}catch(s){throw i==null||i.abort(s),s}}async identify(t,r={}){const i=await this._identify(t,r),{publicKey:s,protocols:o,observedAddr:a}=i;if(s==null)throw new qe("Public key was missing from identify message");const c=on(s),u=hl(c.toCID()),d=t.log.newScope("identify");if(!t.remotePeer.equals(u))throw new qe("Identified peer does not match the expected peer");if(this.peerId.equals(u))throw new qe("Identified peer is our own peer id?");return this.maybeAddObservedAddress(a,d),d("completed for peer %p and protocols %o",u,o),wb(this.peerStore,this.events,d,t,i)}maybeAddObservedAddress(t,r){const i=ZO(t);if(i==null)return;if(r.trace("our observed address was %a",i),Ns(i)){this.log.trace("our observed address was private");return}const s=i.getComponents();if((s[0].code===Ts||s[0].code===sl&&s[1].code===Ts)&&!ib(i)){r.trace("our observed address was IPv6 but not a global unicast address");return}Ju.exactMatch(i)||(r.trace("storing the observed address"),this.addressManager.addObservedAddr(i))}async handleProtocol(t){const{connection:r,stream:i}=t,s=r.log.newScope("identify"),o=AbortSignal.timeout(this.timeout);try{const a=await this.peerStore.get(this.peerId),c=this.addressManager.getAddresses().map(f=>f.decapsulateCode(ba("p2p").code));let u=a.peerRecordEnvelope;if(c.length>0&&u==null){const f=new An({peerId:this.peerId,multiaddrs:c});u=(await Xi.seal(f,this.privateKey)).marshal().subarray()}let d=r.remoteAddr.bytes;w_.matches(r.remoteAddr)||(d=void 0),await Mt(i).pb(na).write({protocolVersion:this.host.protocolVersion,agentVersion:this.host.agentVersion,publicKey:en(this.privateKey.publicKey),listenAddrs:c.map(f=>f.bytes),signedPeerRecord:u,observedAddr:d,protocols:a.protocols},{signal:o}),await i.close({signal:o})}catch(a){s.error("could not respond to identify request",a),i.abort(a)}}}function rD(n={}){return e=>new tD(e,n)}function nD(n={}){return e=>new eD(e,n)}const Ea=1e3,Tg=60*Ea,r1=60*Tg,iD="/ipfs/kad/1.0.0",vb=48*r1,sD=24*r1,oD=10,aD=16384,cD=r1,A4=r1,lD=10*Ea,Sb=20,n1=10,uD=5*Tg,dD=Ea,hD=5*Ea,fD=5*Tg,pD=30*Ea,gD=180*Ea,k4=`${yh}-kad-dht`;var Ed;(function(n){let e;n.codec=()=>(e==null&&(e=me((t,r,i={})=>{i.lengthDelimited!==!1&&r.fork(),t.key!=null&&t.key.byteLength>0&&(r.uint32(10),r.bytes(t.key)),t.value!=null&&t.value.byteLength>0&&(r.uint32(18),r.bytes(t.value)),t.timeReceived!=null&&t.timeReceived!==""&&(r.uint32(42),r.string(t.timeReceived)),i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{const s={key:Fe(0),value:Fe(0),timeReceived:""},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.key=t.bytes();break}case 2:{s.value=t.bytes();break}case 5:{s.timeReceived=t.string();break}default:{t.skipType(a&7);break}}}return s})),e),n.encode=t=>ye(t,n.codec()),n.decode=(t,r)=>we(t,n.codec(),r)})(Ed||(Ed={}));function mD(n){const e=n.getUTCFullYear(),t=String(n.getUTCMonth()+1).padStart(2,"0"),r=String(n.getUTCDate()).padStart(2,"0"),i=String(n.getUTCHours()).padStart(2,"0"),s=String(n.getUTCMinutes()).padStart(2,"0"),o=String(n.getUTCSeconds()).padStart(2,"0"),a=n.getUTCMilliseconds(),c=String(a*1e3*1e3).padStart(9,"0");return`${e}-${t}-${r}T${i}:${s}:${o}.${c}Z`}function yD(n){const e=new RegExp("(\\d{4})-(\\d{2})-(\\d{2})T(\\d{2}):(\\d{2}):(\\d{2})\\.(\\d+)Z"),t=String(n).trim().match(e);if(t==null)throw new Error("Invalid format");const r=parseInt(t[1],10),i=parseInt(t[2],10)-1,s=parseInt(t[3],10),o=parseInt(t[4],10),a=parseInt(t[5],10),c=parseInt(t[6],10),u=parseInt(t[7].slice(0,-6),10);return new Date(Date.UTC(r,i,s,o,a,c,u))}class Nt{constructor(e,t,r){l(this,"key");l(this,"value");l(this,"timeReceived");if(!(e instanceof Uint8Array))throw new Error("key must be a Uint8Array");if(!(t instanceof Uint8Array))throw new Error("value must be a Uint8Array");this.key=e,this.value=t,this.timeReceived=r}serialize(){return Ed.encode(this.prepareSerialize())}prepareSerialize(){return{key:this.key,value:this.value,timeReceived:mD(this.timeReceived)}}static deserialize(e){const t=Ed.decode(e);return new Nt(t.key,t.value,new Date(t.timeReceived))}static fromDeserialized(e){const t=yD(e.timeReceived);if(e.key==null)throw new Error("key missing from deserialized object");if(e.value==null)throw new Error("value missing from deserialized object");return new Nt(e.key,e.value,t)}}class xd extends Error{constructor(e="Query error"){super(e),this.name="QueryError"}}class wD extends Error{constructor(e="Invalid record"){super(e),this.name="InvalidRecordError"}}class bD extends Error{constructor(e="No selector function configured for prefix"){super(e),this.name="MissingSelectorError"}}var _4;(function(n){let e;n.codec=()=>(e==null&&(e=me((t,r,i={})=>{i.lengthDelimited!==!1&&r.fork(),t.key!=null&&(r.uint32(10),r.bytes(t.key)),t.value!=null&&(r.uint32(18),r.bytes(t.value)),t.author!=null&&(r.uint32(26),r.bytes(t.author)),t.signature!=null&&(r.uint32(34),r.bytes(t.signature)),t.timeReceived!=null&&(r.uint32(42),r.string(t.timeReceived)),i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{const s={},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.key=t.bytes();break}case 2:{s.value=t.bytes();break}case 3:{s.author=t.bytes();break}case 4:{s.signature=t.bytes();break}case 5:{s.timeReceived=t.string();break}default:{t.skipType(a&7);break}}}return s})),e),n.encode=t=>ye(t,n.codec()),n.decode=(t,r)=>we(t,n.codec(),r)})(_4||(_4={}));var Ye;(function(n){n.PUT_VALUE="PUT_VALUE",n.GET_VALUE="GET_VALUE",n.ADD_PROVIDER="ADD_PROVIDER",n.GET_PROVIDERS="GET_PROVIDERS",n.FIND_NODE="FIND_NODE",n.PING="PING"})(Ye||(Ye={}));var Ad;(function(n){n[n.PUT_VALUE=0]="PUT_VALUE",n[n.GET_VALUE=1]="GET_VALUE",n[n.ADD_PROVIDER=2]="ADD_PROVIDER",n[n.GET_PROVIDERS=3]="GET_PROVIDERS",n[n.FIND_NODE=4]="FIND_NODE",n[n.PING=5]="PING"})(Ad||(Ad={}));(function(n){n.codec=()=>Wt(Ad)})(Ye||(Ye={}));var ia;(function(n){n.NOT_CONNECTED="NOT_CONNECTED",n.CONNECTED="CONNECTED",n.CAN_CONNECT="CAN_CONNECT",n.CANNOT_CONNECT="CANNOT_CONNECT"})(ia||(ia={}));var U0;(function(n){n[n.NOT_CONNECTED=0]="NOT_CONNECTED",n[n.CONNECTED=1]="CONNECTED",n[n.CAN_CONNECT=2]="CAN_CONNECT",n[n.CANNOT_CONNECT=3]="CANNOT_CONNECT"})(U0||(U0={}));(function(n){n.codec=()=>Wt(U0)})(ia||(ia={}));var lo;(function(n){let e;n.codec=()=>(e==null&&(e=me((t,r,i={})=>{if(i.lengthDelimited!==!1&&r.fork(),t.id!=null&&t.id.byteLength>0&&(r.uint32(10),r.bytes(t.id)),t.multiaddrs!=null)for(const s of t.multiaddrs)r.uint32(18),r.bytes(s);t.connection!=null&&(r.uint32(24),ia.codec().encode(t.connection,r)),i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{var a;const s={id:Fe(0),multiaddrs:[]},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const c=t.uint32();switch(c>>>3){case 1:{s.id=t.bytes();break}case 2:{if(((a=i.limits)==null?void 0:a.multiaddrs)!=null&&s.multiaddrs.length===i.limits.multiaddrs)throw new It('Decode error - map field "multiaddrs" had too many elements');s.multiaddrs.push(t.bytes());break}case 3:{s.connection=ia.codec().decode(t);break}default:{t.skipType(c&7);break}}}return s})),e),n.encode=t=>ye(t,n.codec()),n.decode=(t,r)=>we(t,n.codec(),r)})(lo||(lo={}));var No;(function(n){let e;n.codec=()=>(e==null&&(e=me((t,r,i={})=>{if(i.lengthDelimited!==!1&&r.fork(),t.type!=null&&Ad[t.type]!==0&&(r.uint32(8),Ye.codec().encode(t.type,r)),t.clusterLevel!=null&&(r.uint32(80),r.int32(t.clusterLevel)),t.key!=null&&(r.uint32(18),r.bytes(t.key)),t.record!=null&&(r.uint32(26),r.bytes(t.record)),t.closer!=null)for(const s of t.closer)r.uint32(66),lo.codec().encode(s,r);if(t.providers!=null)for(const s of t.providers)r.uint32(74),lo.codec().encode(s,r);i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{var a,c,u,d;const s={type:Ye.PUT_VALUE,closer:[],providers:[]},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const h=t.uint32();switch(h>>>3){case 1:{s.type=Ye.codec().decode(t);break}case 10:{s.clusterLevel=t.int32();break}case 2:{s.key=t.bytes();break}case 3:{s.record=t.bytes();break}case 8:{if(((a=i.limits)==null?void 0:a.closer)!=null&&s.closer.length===i.limits.closer)throw new It('Decode error - map field "closer" had too many elements');s.closer.push(lo.codec().decode(t,t.uint32(),{limits:(c=i.limits)==null?void 0:c.closer$}));break}case 9:{if(((u=i.limits)==null?void 0:u.providers)!=null&&s.providers.length===i.limits.providers)throw new It('Decode error - map field "providers" had too many elements');s.providers.push(lo.codec().decode(t,t.uint32(),{limits:(d=i.limits)==null?void 0:d.providers$}));break}default:{t.skipType(h&7);break}}}return s})),e),n.encode=t=>ye(t,n.codec()),n.decode=(t,r)=>we(t,n.codec(),r)})(No||(No={}));function I4(n,e={}){var r;const t={...n,name:"SEND_QUERY",type:0,messageName:n.type,messageType:n.type};return(r=e.onProgress)==null||r.call(e,new CustomEvent("kad-dht:query:send-query",{detail:t})),t}function F0(n,e={}){var r;const t={...n,name:"PEER_RESPONSE",type:1,messageName:n.messageType,closer:n.closer??[],providers:n.providers??[]};return(r=e.onProgress)==null||r.call(e,new CustomEvent("kad-dht:query:peer-response",{detail:t})),t}function mf(n,e={}){var r;const t={...n,name:"FINAL_PEER",type:2};return(r=e.onProgress)==null||r.call(e,new CustomEvent("kad-dht:query:final-peer",{detail:t})),t}function sa(n,e={}){var r;const t={...n,name:"QUERY_ERROR",type:3};return(r=e.onProgress)==null||r.call(e,new CustomEvent("kad-dht:query:query-error",{detail:t})),t}function C4(n,e={}){var r;const t={...n,name:"PROVIDER",type:4};return(r=e.onProgress)==null||r.call(e,new CustomEvent("kad-dht:query:provider",{detail:t})),t}function $0(n,e={}){var r;const t={...n,name:"VALUE",type:5};return(r=e.onProgress)==null||r.call(e,new CustomEvent("kad-dht:query:value",{detail:t})),t}function T4(n,e={}){var r;const t={...n,name:"DIAL_PEER",type:7};return(r=e.onProgress)==null||r.call(e,new CustomEvent("kad-dht:query:dial-peer",{detail:t})),t}function vD(n,e={}){var r;const t={...n,name:"PATH_ENDED",type:8};return(r=e.onProgress)==null||r.call(e,new CustomEvent("kad-dht:query:path-ended",{detail:t})),t}function SD(n,e,t){if(t.length===0)throw new O("No records given");const i=U(e).split("/");if(i.length<3)throw new O("Record key does not have a selector function");const s=n[i[1].toString()];if(s==null)throw new bD(`No selector function configured for key type "${i[1]}"`);return t.length===1?0:s(e,t)}function ED(n,e){return 0}const xD={pk:ED};async function Rg(n,e,t){const r=e.key,s=U(r).split("/");if(s.length<3)return;const o=n[s[1].toString()];if(o==null)throw new O(`No validator available for key type "${s[1]}"`);await o(r,e.value,t)}const AD=async(n,e,t)=>{if(!(n instanceof Uint8Array))throw new O('"key" must be a Uint8Array');if(n.byteLength<5)throw new O("Invalid public key record");if(U(n.subarray(0,4))!=="/pk/")throw new O("key was not prefixed with /pk/");const i=on(e),s=n.slice(4);if(!ke(s,i.toMultihash().bytes))throw new O("public key does not match passed in key")},kD={pk:AD},_D=R("/pk/");function ID(n){return{...n,multiaddrs:n.multiaddrs.filter(e=>{const[[t,r]]=e.stringTuples();if(t===53||t===54||t===55)return r!=="localhost";if(t!==4&&t!==6||r==null)return!1;const i=ns(r);return i==null?!0:!i})}}async function Mc(n,e){var r;const t=await ut.digest(n);return(r=e==null?void 0:e.signal)==null||r.throwIfAborted(),t.digest}async function hi(n,e){return Mc(n.toMultihash().bytes,e)}function cc(n,e){return new Ue(`${n}/${U(e,"base32")}`,!1)}function CD(n){return sr([_D,n.toMultihash().bytes])}function TD(n){return U(n.subarray(0,4))==="/pk/"}function RD(n){const e=Pt(n.subarray(4));return ln(e)}function R4(n,e){const t=new Date;return new Nt(n,e,t).serialize()}const PD=290,OD=54,DD=55,ND=56,LD=4,BD=41;function MD(n){const e=n.stringTuples();for(const t of e)if(t[0]===PD)return!1;if(e[0][0]===OD||e[0][0]===DD||e[0][0]===ND)return!0;if(e[0][0]===LD||e[0][0]===BD){const t=ns(`${e[0][1]}`);return t==null||!t}return!1}function Eb(n){const e=n.toString().split("/"),t=e.pop(),r=e.pop();if(t==null||r==null)throw new Error(`incorrectly formatted provider entry key in datastore: ${n.toString()}`);return{cid:le.createV1(Bt,Pt(R(r,"base32"))),peerId:Ur(t)}}function yf(n,e,t){const r=typeof e=="string"?e:U(e.multihash.bytes,"base32"),i=[n,r];return t!=null&&i.push(t.toString()),new Ue(i.join("/"))}function xb(n){return new Date(fh(n))}function ao(n,e,t){return async function*(...r){var a,c,u,d,h;const i=(a=e.queryTime)==null?void 0:a.timer(t),s=(c=e.errorTime)==null?void 0:c.timer(t);let o=!1;try{(u=e.queries)==null||u.increment({[t]:!0}),yield*n(...r)}catch(f){throw o=!0,s==null||s(),(d=e.errors)==null||d.increment({[t]:!0}),f}finally{(h=e.queries)==null||h.decrement({[t]:!0}),o||i==null||i()}}}function Ab(n,e,t){return async function(...r){var a,c,u,d,h;const i=(a=e==null?void 0:e.queryTime)==null?void 0:a.timer(t),s=(c=e==null?void 0:e.errorTime)==null?void 0:c.timer(t);let o=!1;try{return(u=e.queries)==null||u.increment({[t]:!0}),await n(...r)}catch(f){throw o=!0,s==null||s(),(d=e.errors)==null||d.increment({[t]:!0}),f}finally{(h=e.queries)==null||h.decrement({[t]:!0}),o||i==null||i()}}}class UD{constructor(e,t){l(this,"log");l(this,"components");l(this,"validators");l(this,"selectors");l(this,"peerRouting");l(this,"queryManager");l(this,"network");l(this,"datastorePrefix");var u,d;const{validators:r,selectors:i,peerRouting:s,queryManager:o,network:a,logPrefix:c}=t;this.components=e,this.log=e.logger.forComponent(`${c}:content-fetching`),this.datastorePrefix=`${t.datastorePrefix}/record`,this.validators=r,this.selectors=i,this.peerRouting=s,this.queryManager=o,this.network=a,this.get=((u=e.metrics)==null?void 0:u.traceFunction("libp2p.kadDHT.get",this.get.bind(this),{optionsIndex:1}))??this.get,this.put=((d=e.metrics)==null?void 0:d.traceFunction("libp2p.kadDHT.put",this.put.bind(this),{optionsIndex:2}))??this.put}async getLocal(e,t){this.log("getLocal %b",e);const r=cc(this.datastorePrefix,e);this.log("fetching record for key %k",r);const i=await this.components.datastore.get(r,t);this.log("found %k in local datastore",r);const s=Nt.deserialize(i);return await Rg(this.validators,s,t),s}async*sendCorrectionRecord(e,t,r,i){this.log("sendCorrection for %b",e);const s=R4(e,r);for(const{value:o,from:a}of t){if(ke(o,r)){this.log("record was ok");continue}if(this.components.peerId.equals(a)){try{const d=cc(this.datastorePrefix,e);this.log(`Storing corrected record for key ${d.toString()}`),await this.components.datastore.put(d,s.subarray(),i)}catch(d){this.log.error("Failed error correcting self",d)}continue}let c=!1;const u={type:Ye.PUT_VALUE,key:e,record:s};for await(const d of this.network.sendRequest(a,u,i))d.name==="PEER_RESPONSE"&&d.record!=null&&ke(d.record.value,Nt.deserialize(s).value)&&(c=!0),yield d;if(!c)throw new xd("Could not send correction");this.log.error("Failed error correcting entry")}}async*put(e,t,r){this.log("put key %b value %b",e,t);const i=R4(e,t),s=cc(this.datastorePrefix,e);this.log(`storing record for key ${s.toString()}`),await this.components.datastore.put(s,i.subarray(),r),yield*_t(this.peerRouting.getClosestPeers(e,{...r,signal:r.signal}),o=>vr(o,a=>async()=>{if(a.name!=="FINAL_PEER")return[a];const c=[],u={type:Ye.PUT_VALUE,key:e,record:i};this.log("send put to %p",a.peer.id);for await(const d of this.network.sendRequest(a.peer.id,u,{...r,path:a.path}))c.push(d),d.name==="PEER_RESPONSE"&&(d.record!=null&&ke(d.record.value,Nt.deserialize(i).value)||c.push(sa({from:a.peer.id,error:new xd("Value not put correctly"),path:d.path},r)));return c}),o=>Cn(o,{ordered:!1,concurrency:n1}),async function*(o){for await(const a of o)yield*a})}async*get(e,t){this.log("get %b",e);const r=[];for await(const a of this.getMany(e,t)){if(a.name==="VALUE"){r.push(a);continue}yield a}if(r.length===0)return;const i=r.map(a=>a.value);let s=0;try{s=SD(this.selectors,e,i)}catch(a){if(a.name!=="InvalidParametersError")throw a}const o=i[s];if(this.log("GetValue %b %b",e,o),o==null)throw new tr("Best value was not found");yield*this.sendCorrectionRecord(e,r,o,{...t,path:{index:-1,queued:0,running:0,total:0}}),yield r[s]}async*getMany(e,t={}){this.log("getMany values for %b",e);try{const s=await this.getLocal(e,t);yield $0({value:s.value,from:this.components.peerId,path:{index:-1,running:0,queued:0,total:0}},t)}catch(s){this.log("error getting local value for %b",e,s)}const r=this,i=async function*({peer:s,signal:o,path:a}){for await(const c of r.peerRouting.getValueOrPeers(s.id,e,{...t,signal:o,path:a}))yield c,c.name==="PEER_RESPONSE"&&c.record!=null&&(yield $0({from:s.id,value:c.record.value,path:a},t))};yield*this.queryManager.run(e,i,t)}}function FD(n,e){return{id:n.id.toMultihash().bytes,multiaddrs:(n.multiaddrs??[]).map(r=>r.bytes),connection:e}}function ru(n){if(n.id==null)throw new Error("Invalid peer in message");const e=Pt(n.id);return{id:ln(e),multiaddrs:(n.multiaddrs??[]).map(t=>fe(t))}}class $D{constructor(e,t){l(this,"log");l(this,"components");l(this,"network");l(this,"peerRouting");l(this,"queryManager");l(this,"routingTable");l(this,"providers");var u,d;const{network:r,peerRouting:i,queryManager:s,routingTable:o,providers:a,logPrefix:c}=t;this.components=e,this.log=e.logger.forComponent(`${c}:content-routing`),this.network=r,this.peerRouting=i,this.queryManager=s,this.routingTable=o,this.providers=a,this.findProviders=((u=e.metrics)==null?void 0:u.traceFunction("libp2p.kadDHT.findProviders",this.findProviders.bind(this),{optionsIndex:1,getAttributesFromYieldedValue:(h,f)=>(h.name==="PROVIDER"&&(f.providers??(f.providers=[]),f.providers.push(...h.providers.map(p=>p.id.toString()))),f)}))??this.findProviders,this.provide=((d=e.metrics)==null?void 0:d.traceFunction("libp2p.kadDHT.provide",this.provide.bind(this),{optionsIndex:1,getAttributesFromYieldedValue:(h,f)=>(h.name==="PEER_RESPONSE"&&h.messageName==="ADD_PROVIDER"&&(f.providers??(f.providers=[]),f.providers.push(h.from.toString())),f)}))??this.provide}async*provide(e,t,r={}){this.log("provide %s",e);const i=e.multihash.bytes;await this.providers.addProvider(e,this.components.peerId,r);const s={type:Ye.ADD_PROVIDER,key:i,providers:[FD({id:this.components.peerId,multiaddrs:t})]};let o=0;const a=this;async function*c(h){try{a.log("sending provider record for %s to %p",e,h.peer.id);for await(const f of a.network.sendMessage(h.peer.id,s,{...r,path:h.path}))f.name==="PEER_RESPONSE"&&(a.log("sent provider record for %s to %p",e,h.peer.id),o++),yield f}catch(f){a.log.error("error sending provide record to peer %p",h.peer.id,f),yield sa({from:h.peer.id,error:f,path:h.path},r)}}const u=cn({objectMode:!0}),d=new Wi({concurrency:n1});d.addEventListener("idle",()=>{u.end()}),d.addEventListener("failure",h=>{this.log.error("error publishing provider record to peer - %e",h.detail.error)}),d.add(async()=>{const h=[];for await(const f of this.peerRouting.getClosestPeers(i,r))u.push(f),f.name==="FINAL_PEER"&&h.push(f);h.forEach(f=>{d.add(async()=>{for await(const p of c(f))u.push(p)}).catch(p=>{this.log.error("error publishing provider record to peer - %e",p)})})}).catch(h=>{u.end(h)}),yield*u,this.log("sent provider records to %d peers",o)}async*findProviders(e,t){const r=this.routingTable.kBucketSize;let i=0;const s=e.multihash.bytes,o=this;this.log("findProviders %c",e);const a=await this.providers.getProviders(e,t);if(a.length>0){const d=[];for(const h of a.slice(0,r))try{const f=await this.components.peerStore.get(h,t);d.push({id:h,multiaddrs:f.addresses.map(({multiaddr:p})=>p)})}catch(f){if(f.name!=="NotFoundError")throw f;this.log("no peer store entry for %p",h)}if(yield F0({from:this.components.peerId,messageType:Ye.GET_PROVIDERS,providers:d,path:{index:-1,queued:0,running:0,total:0}},t),yield C4({from:this.components.peerId,providers:d,path:{index:-1,queued:0,running:0,total:0}},t),i+=d.length,i>=r)return}const c=async function*({peer:d,signal:h,path:f}){const p={type:Ye.GET_PROVIDERS,key:s};yield*o.network.sendRequest(d.id,p,{...t,signal:h,path:f})},u=new xn(a);for await(const d of this.queryManager.run(s,c,t))if(yield d,d.name==="PEER_RESPONSE"){this.log("Found %d provider entries for %c and %d closer peers",d.providers.length,e,d.closer.length);const h=[];for(const f of d.providers)u.has(f.id)||(u.add(f.id),h.push(f));if(h.length>0&&(yield C4({from:d.from,providers:h,path:d.path},t),i+=h.length,i>=r))return}}}class HD extends ot{constructor(t,r){var i,s,o,a;super();l(this,"log");l(this,"protocol");l(this,"running");l(this,"components");l(this,"timeout");l(this,"metrics");this.components=t,this.log=t.logger.forComponent(`${r.logPrefix}:network`),this.running=!1,this.protocol=r.protocol,this.timeout=new Nc({...r.timeout??{},metrics:t.metrics,metricName:`${r.metricsPrefix}_network_message_send_times_milliseconds`}),this.metrics={operations:(i=t.metrics)==null?void 0:i.registerCounterGroup(`${r.metricsPrefix}_outbound_rpc_requests_total`),errors:(s=t.metrics)==null?void 0:s.registerCounterGroup(`${r.metricsPrefix}_outbound_rpc_errors_total`)},this.sendRequest=((o=t.metrics)==null?void 0:o.traceFunction("libp2p.kadDHT.sendRequest",this.sendRequest.bind(this),{optionsIndex:2,getAttributesFromArgs([c,u],d){return{...d,to:c.toString(),"message type":`${u.type}`}},getAttributesFromYieldedValue:(c,u)=>(c.name==="PEER_RESPONSE"&&(c.providers.length>0&&c.providers.forEach((d,h)=>{u[`providers-${h}`]=d.id.toString()}),c.closer.length>0&&c.closer.forEach((d,h)=>{u[`closer-${h}`]=d.id.toString()})),u)}))??this.sendRequest,this.sendMessage=((a=t.metrics)==null?void 0:a.traceFunction("libp2p.kadDHT.sendMessage",this.sendMessage.bind(this),{optionsIndex:2,getAttributesFromArgs([c,u],d){return{...d,to:c.toString(),"message type":`${u.type}`}},getAttributesFromYieldedValue:(c,u)=>(c.name==="PEER_RESPONSE"&&(c.providers.length>0&&c.providers.forEach((d,h)=>{u[`providers-${h}`]=d.id.toString()}),c.closer.length>0&&c.closer.forEach((d,h)=>{u[`closer-${h}`]=d.id.toString()})),u)}))??this.sendMessage}async start(){this.running||(this.running=!0)}async stop(){this.running=!1}isStarted(){return this.running}async*sendRequest(t,r,i){var c,u,d;if(!this.running)return;const s=r.type;if(s==null)throw new O("Message type was missing");let o;const a=this.timeout.getTimeoutSignal(i);i={...i,signal:a};try{(c=this.metrics.operations)==null||c.increment({[s]:!0}),this.log("dialling %p",t),yield T4({peer:t,path:i.path},i),o=await(await this.components.connectionManager.openConnection(t,i)).newStream(this.protocol,i),this.log("sending %s to %p",r.type,t),yield I4({to:t,type:s,path:i.path},i);const f=await this._writeReadMessage(o,r,i);o.close(i).catch(p=>{this.log.error("error closing stream to %p",t,p),o==null||o.abort(p)}),yield F0({from:t,messageType:f.type,closer:f.closer.map(ru),providers:f.providers.map(ru),record:f.record==null?void 0:Nt.deserialize(f.record),path:i.path},i)}catch(h){(u=this.metrics.errors)==null||u.increment({[s]:!0}),o==null||o.abort(h),((d=i.signal)==null?void 0:d.aborted)!==!0&&this.log.error("could not send %s to %p - %e",r.type,t,h),yield sa({from:t,error:h,path:i.path},i)}finally{this.timeout.cleanUp(a)}}async*sendMessage(t,r,i){var c,u;if(!this.running)return;const s=r.type;if(s==null)throw new O("Message type was missing");let o;const a=this.timeout.getTimeoutSignal(i);i={...i,signal:a};try{(c=this.metrics.operations)==null||c.increment({[s]:!0}),this.log("dialling %p",t),yield T4({peer:t,path:i.path},i),o=await(await this.components.connectionManager.openConnection(t,i)).newStream(this.protocol,i),this.log("sending %s to %p",r.type,t),yield I4({to:t,type:s,path:i.path},i),await this._writeMessage(o,r,i),o.close(i).catch(h=>{this.log.error("error closing stream to %p",t,h),o==null||o.abort(h)}),yield F0({from:t,messageType:s,path:i.path},i)}catch(d){(u=this.metrics.errors)==null||u.increment({[s]:!0}),o==null||o.abort(d),yield sa({from:t,error:d,path:i.path},i)}finally{this.timeout.cleanUp(a)}}async _writeMessage(t,r,i){await Mt(t).write(r,No,i)}async _writeReadMessage(t,r,i){const s=Mt(t);await s.write(r,No,i);const o=await s.read(No,i);return o.closer.forEach(a=>{this.safeDispatchEvent("peer",{detail:ru(a)})}),o.providers.forEach(a=>{this.safeDispatchEvent("peer",{detail:ru(a)})}),o}}function lc(n,e){if(n.byteLength!==e.byteLength)throw new Error("Inputs should have the same length");for(let t=0;t<n.byteLength;t++)if(n[t]!==e[t])return n[t]<e[t]?-1:1;return 0}class Pg{constructor(e,t){l(this,"originDhtKey");l(this,"capacity");l(this,"peerDistances");this.originDhtKey=e,this.capacity=t,this.peerDistances=[]}get length(){return this.peerDistances.length}get peers(){return[...this.peerDistances]}async add(e,t={index:-1,queued:0,running:0,total:0},r){const i=await hi(e.id,r);this.addWithKadId(e,i,t)}addWithKadId(e,t,r={index:-1,queued:0,running:0,total:0}){if(this.peerDistances.find(o=>o.peer.id.equals(e.id))!=null)return;const i={peer:e,distance:Zo(this.originDhtKey,t),path:r};if(this.peerDistances.length===this.capacity){const o=this.peerDistances[this.peerDistances.length-1];if(o!=null&&lc(i.distance,o.distance)!==-1)return}let s=!1;for(let o=0;o<this.peerDistances.length;o++){const a=lc(this.peerDistances[o].distance,i.distance);if(a===0||a===1){s=!0,this.peerDistances.splice(o,0,i);break}}s||this.peerDistances.push(i),this.peerDistances=this.peerDistances.slice(0,this.capacity)}async isCloser(e,t){if(this.length===0)return!0;const r=await hi(e,t),i=Zo(r,this.originDhtKey),s=this.peerDistances[this.peerDistances.length-1].distance;return lc(i,s)===-1}async anyCloser(e,t){return e.length===0?!1:Promise.any(e.map(async r=>this.isCloser(r,t)))}}class VD{constructor(e,t){l(this,"log");l(this,"routingTable");l(this,"network");l(this,"validators");l(this,"queryManager");l(this,"components");var r,i;this.routingTable=t.routingTable,this.network=t.network,this.validators=t.validators,this.queryManager=t.queryManager,this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:peer-routing`),this.findPeer=((r=e.metrics)==null?void 0:r.traceFunction("libp2p.kadDHT.findPeer",this.findPeer.bind(this),{optionsIndex:1}))??this.findPeer,this.getClosestPeers=((i=e.metrics)==null?void 0:i.traceFunction("libp2p.kadDHT.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1}))??this.getClosestPeers}async findPeerLocal(e,t){let r;const i=await this.routingTable.find(e,t);if(i!=null){this.log("findPeerLocal found %p in routing table",e);try{r=await this.components.peerStore.get(i,t)}catch(s){if(s.name!=="NotFoundError")throw s}}if(r==null)try{r=await this.components.peerStore.get(e,t)}catch(s){if(s.name!=="NotFoundError")throw s}if(r!=null)return this.log("findPeerLocal found %p in peer store",e),{id:r.id,multiaddrs:r.addresses.map(s=>s.multiaddr)}}async*_getValueSingle(e,t,r){const i={type:Ye.GET_VALUE,key:t};yield*this.network.sendRequest(e,i,r)}async*getPublicKeyFromNode(e,t={}){const r=CD(e),i={index:-1,queued:0,running:0,total:0};for await(const s of this._getValueSingle(e,r,{...t,path:i}))if(yield s,s.name==="PEER_RESPONSE"&&s.record!=null){const o=on(s.record.value),a=Go(o);if(!a.equals(e))throw new Ec("public key does not match id");if(a.publicKey==null)throw new Ec("public key missing");yield $0({from:e,value:s.record.value,path:i},t)}throw new xd(`Node not responding with its public key: ${e.toString()}`)}async*findPeer(e,t={}){if(this.log("findPeer %p",e),t.useCache!==!1){const i=await this.findPeerLocal(e,t);if(i!=null){this.log("found local"),yield mf({from:this.components.peerId,peer:i,path:{index:-1,queued:0,running:0,total:0}},t);return}}let r=!1;if(t.useNetwork!==!1){const i=this,s=async function*({peer:o,signal:a,path:c}){const u={type:Ye.FIND_NODE,key:e.toMultihash().bytes};for await(const d of i.network.sendRequest(o.id,u,{...t,signal:a,path:c}))if(yield d,d.name==="PEER_RESPONSE"){const h=d.closer.find(f=>f.id.equals(e));h!=null&&(yield mf({from:d.from,peer:h,path:d.path},t))}};for await(const o of this.queryManager.run(e.toMultihash().bytes,s,t))o.name==="FINAL_PEER"&&(r=!0),yield o}if(!r)throw new tr("Not found")}async*getClosestPeers(e,t={}){this.log("getClosestPeers to %b",e);const r=await Mc(e,t),i=new Pg(r,this.routingTable.kBucketSize),s=this,o=async function*({peer:a,path:c,peerKadId:u,signal:d}){s.log("getClosestPeers asking %p",a.id);const h={type:Ye.FIND_NODE,key:e};yield*s.network.sendRequest(a.id,h,{...t,signal:d,path:c}),i.addWithKadId(a,u,c)};yield*this.queryManager.run(e,o,t),this.log("found %d peers close to %b",i.length,e);for(let{peer:a,path:c}of i.peers)try{if(a.multiaddrs.length===0&&(a=await s.components.peerStore.getInfo(a.id,t)),a.multiaddrs.length===0)continue;yield mf({from:this.components.peerId,peer:await s.components.peerStore.getInfo(a.id,t),path:{index:c.index,queued:0,running:0,total:0}},t)}catch{continue}}async*getValueOrPeers(e,t,r){for await(const i of this._getValueSingle(e,t,r)){if(i.name==="PEER_RESPONSE"&&i.record!=null)try{await this._verifyRecordOnline(i.record,r)}catch{const o="invalid record received, discarded";this.log(o),yield sa({from:i.from,error:new xd(o),path:r.path},r);continue}yield i}}async _verifyRecordOnline(e,t){if(e.timeReceived==null)throw new wD("invalid record received");await Rg(this.validators,new Nt(e.key,e.value,e.timeReceived),t)}async getClosestPeersOffline(e,t){const r=[];try{const o=Pt(e),a=ln(o),c=await this.components.peerStore.get(a,t);r.push({id:c.id,multiaddrs:c.addresses.map(({multiaddr:u})=>u)})}catch{}const i=await Mc(e,t),s=this.routingTable.closestPeers(i,t);for(const o of s)try{r.push(await this.components.peerStore.getInfo(o,t))}catch(a){if(a.name!=="NotFoundError")throw a}return r.length>0?this.log("getClosestPeersOffline returning the %d closest peer(s) %b we know",r.length,e):this.log("getClosestPeersOffline could not any peers close to %b with %d peers in the routing table",e,this.routingTable.size),r}}class zD{constructor(e,t){l(this,"log");l(this,"datastore");l(this,"datastorePrefix");this.log=e.logger.forComponent(`${t.logPrefix}:providers`),this.datastorePrefix=`${t.datastorePrefix}/provider`,this.datastore=e.datastore}async addProvider(e,t,r){this.log.trace("%p provides %s",t,e),await this.writeProviderEntry(e,t,r)}async removeProvider(e,t,r){const i=yf(this.datastorePrefix,e,t);this.log.trace("%p no longer provides %s",t,e),await this.datastore.delete(i,r)}async getProviders(e,t){this.log.trace("get providers for %c",e);const r=await this.loadProviders(e,t);return this.log.trace("got %d providers for %c",r.size,e),[...r.keys()]}async writeProviderEntry(e,t,r){var o;const i=yf(this.datastorePrefix,e,t),s=Jr(((o=r==null?void 0:r.time)==null?void 0:o.getTime())??Date.now());await this.datastore.put(i,s,r)}async loadProviders(e,t){const r=new eo,i=yf(this.datastorePrefix,e);for await(const s of this.datastore.query({prefix:i.toString()},t)){const{peerId:o}=Eb(s.key);r.set(o,xb(s.value))}return r}}const KD=n=>{const e=n.addEventListener||n.on||n.addListener,t=n.removeEventListener||n.off||n.removeListener;if(!e||!t)throw new TypeError("Emitter is not compatible");return{addListener:e.bind(n),removeListener:t.bind(n)}};function qD(n,e,t){let r;const i=new Promise((s,o)=>{var p;if(t={rejectionEvents:["error"],multiArgs:!1,resolveImmediately:!1,...t},!(t.count>=0&&(t.count===Number.POSITIVE_INFINITY||Number.isInteger(t.count))))throw new TypeError("The `count` option should be at least 0 or more");(p=t.signal)==null||p.throwIfAborted();const a=[e].flat(),c=[],{addListener:u,removeListener:d}=KD(n),h=(...m)=>{const w=t.multiArgs?m:m[0];t.filter&&!t.filter(w)||(c.push(w),t.count===c.length&&(r(),s(c)))},f=m=>{r(),o(m)};r=()=>{for(const m of a)d(m,h);for(const m of t.rejectionEvents)d(m,f)};for(const m of a)u(m,h);for(const m of t.rejectionEvents)u(m,f);t.signal&&t.signal.addEventListener("abort",()=>{f(t.signal.reason)},{once:!0}),t.resolveImmediately&&s(c)});if(i.cancel=r,typeof t.timeout=="number"){const s=Th(i,{milliseconds:t.timeout});return s.cancel=r,s}return i}function WD(n,e,t){typeof t=="function"&&(t={filter:t}),t={...t,count:1,resolveImmediately:!1};const r=qD(n,e,t),i=r.then(s=>s[0]);return i.cancel=r.cancel,i}async function*GD(n){const{key:e,startingPeers:t,ourPeerId:r,query:i,alpha:s,path:o,numPaths:a,log:c,peersSeen:u,connectionManager:d,signal:h}=n,f=cn({objectMode:!0}),p=new Wi({concurrency:s,sort:(w,b)=>lc(w.options.distance,b.options.distance)});p.addEventListener("idle",()=>{f.push(vD({path:{index:o,queued:p.queued,running:p.running,total:p.size}},n)),f.end()}),p.addEventListener("failure",w=>{c.error("error during query - %e",w.detail.error)});const m=()=>{p.abort(),f.end(new ci)};h.addEventListener("abort",m);try{let b=function(S,k){if(S==null)return;u.add(S.id.toMultihash().bytes);const C=Zo(k,w);p.add(async()=>{try{for await(const Q of i({...n,key:e,peer:S,path:{index:o,queued:p.queued,running:p.running,total:p.size},numPaths:a,peerKadId:k,signal:h})){if(Q.name==="PEER_RESPONSE")for(const re of Q.closer){if(u.has(re.id.toMultihash().bytes)){c("already seen %p in query",re.id);continue}if(r.equals(re.id)){c("not querying ourselves");continue}if(!await d.isDialable(re.multiaddrs)){c("not querying undialable peer");continue}const T=await hi(re.id,{signal:h}),Y=Zo(T,w);if(lc(Y,C)!==-1){c("skipping %p as they are not closer to %b than %p",re.id,e,S);continue}c("querying closer peer %p",re.id),b(re,T)}f.push({...Q,path:{index:o,queued:p.queued,running:p.running,total:p.size}})}}catch(Q){f.push(sa({from:S.id,error:Q,path:{index:o,queued:p.queued,running:p.running-1,total:p.size-1}},n))}},{distance:C}).catch(Q=>{c.error("error during query - %e",Q)})};const w=await Mc(e,{signal:h});await Promise.all(t.map(async S=>{b({id:S,multiaddrs:[]},await hi(S,{signal:h}))})),yield*f}finally{h.removeEventListener("abort",m)}}class jD{constructor(e,t){l(this,"disjointPaths");l(this,"alpha");l(this,"shutDownController");l(this,"running");l(this,"logger");l(this,"peerId");l(this,"connectionManager");l(this,"routingTable");l(this,"initialQuerySelfHasRun");l(this,"logPrefix");l(this,"allowQueryWithZeroPeers");this.logPrefix=t.logPrefix,this.disjointPaths=t.disjointPaths??Sb,this.alpha=t.alpha??n1,this.initialQuerySelfHasRun=t.initialQuerySelfHasRun,this.routingTable=t.routingTable,this.logger=e.logger,this.peerId=e.peerId,this.connectionManager=e.connectionManager,this.allowQueryWithZeroPeers=t.allowQueryWithZeroPeers??!1,this.shutDownController=new AbortController,this.shutDownController.signal,this.running=!1}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.shutDownController=new AbortController,this.shutDownController.signal,void 0)}async stop(){this.running=!1,this.shutDownController.abort()}async*run(e,t,r={}){if(!this.running)throw new Error("QueryManager not started");if(r.signal==null){const c=AbortSignal.timeout(gD);r={...r,signal:c}}const i=new AbortController,s=Le([this.shutDownController.signal,i.signal,r.signal]);i.signal;const o=this.logger.forComponent(`${this.logPrefix}:query:`+U(e,"base58btc"));let a=!1;try{this.routingTable.size===0&&!this.allowQueryWithZeroPeers&&(o("routing table was empty, waiting for some peers before running%s query",r.isSelfQuery===!0?" self":""),await WD(this.routingTable,"peer:add",{signal:s,filter:p=>!this.peerId.equals(p.detail)}),o("routing table has peers, continuing with%s query",r.isSelfQuery===!0?" self":"")),r.isSelfQuery!==!0&&this.initialQuerySelfHasRun!=null&&(o("waiting for initial self query before continuing"),await yt(this.initialQuerySelfHasRun.promise,s),this.initialQuerySelfHasRun=void 0),o("query:start");const c=await Mc(e,{signal:s}),u=this.routingTable.closestPeers(c,{count:this.routingTable.kBucketSize}),d=u.sort(()=>Math.random()>.5?1:-1).reduce((p,m,w)=>(p[w%this.disjointPaths].push(m),p),new Array(this.disjointPaths).fill(0).map(()=>[])).filter(p=>p.length>0);if(u.length===0){o.error("running query with no peers");return}const h=Qi(1024),f=d.map((p,m)=>GD({...r,key:e,startingPeers:p,ourPeerId:this.peerId,signal:s,query:t,path:m,numPaths:d.length,alpha:this.alpha,log:o,peersSeen:h,onProgress:r.onProgress,connectionManager:this.connectionManager}));for await(const p of $i(...f)){if(p.name==="QUERY_ERROR"&&o.error("query error",p.error),p.name==="PEER_RESPONSE")for(const m of[...p.closer,...p.providers])await this.connectionManager.isDialable(m.multiaddrs,{signal:s})&&await this.routingTable.add(m.id,{signal:s});s.throwIfAborted(),yield p}a=!0}catch(c){if(this.running)throw c}finally{a||(o("query exited early"),i.abort()),s.clear(),o("query finished")}}}function QD(n){return n[Symbol.asyncIterator]!=null}function kb(n){if(QD(n))return(async()=>{let e=0;for await(const t of n)e++;return e})();{let e=0;for(const t of n)e++;return e}}class YD{constructor(e,t){l(this,"log");l(this,"peerId");l(this,"peerRouting");l(this,"events");l(this,"count");l(this,"interval");l(this,"initialInterval");l(this,"queryTimeout");l(this,"running");l(this,"timeoutId");l(this,"controller");l(this,"initialQuerySelfHasRun");l(this,"querySelfPromise");this.peerId=e.peerId,this.log=e.logger.forComponent(`${t.logPrefix}:query-self`),this.events=e.events,this.running=!1,this.peerRouting=t.peerRouting,this.count=t.count??Sb,this.interval=t.interval??uD,this.initialInterval=t.initialInterval??dD,this.queryTimeout=t.queryTimeout??hD,this.initialQuerySelfHasRun=t.initialQuerySelfHasRun,this.querySelf=Ab(this.querySelf.bind(this),t.operationMetrics,"SELF_QUERY")}isStarted(){return this.running}start(){this.running||(this.running=!0,clearTimeout(this.timeoutId),this.timeoutId=setTimeout(()=>{this.querySelf().catch(e=>{this.log.error("error running self-query",e)})},this.initialInterval))}stop(){this.running=!1,this.timeoutId!=null&&clearTimeout(this.timeoutId),this.controller!=null&&this.controller.abort()}async querySelf(){if(!this.running){this.log("skip self-query because we are not started");return}if(this.querySelfPromise!=null)return this.log("joining existing self query"),this.querySelfPromise.promise;if(this.querySelfPromise=ve(),this.running){this.controller=new AbortController;const e=[this.controller.signal];if(this.initialQuerySelfHasRun==null){const r=AbortSignal.timeout(this.queryTimeout);e.push(r)}const t=Le(e);this.controller.signal;try{this.log("run self-query, look for %d peers timing out after %dms",this.count,this.queryTimeout);const r=Date.now(),i=await _t(this.peerRouting.getClosestPeers(this.peerId.toMultihash().bytes,{signal:t,isSelfQuery:!0}),o=>qu(o,this.count),async o=>kb(o));t==null||t.throwIfAborted();const s=Date.now()-r;this.log("self-query found %d peers in %dms",i,s),this.events.dispatchEvent(new CustomEvent("kad-dht:query:self",{detail:{peers:i,duration:s}}))}catch(r){this.log.error("self-query error",r)}finally{t.clear(),this.initialQuerySelfHasRun!=null&&(this.initialQuerySelfHasRun.resolve(),this.initialQuerySelfHasRun=void 0)}}this.querySelfPromise.resolve(),this.querySelfPromise=void 0,this.running&&(this.timeoutId=setTimeout(()=>{this.querySelf().catch(e=>{this.log.error("error running self-query",e)})},this.interval))}}class XD extends ot{constructor(t,r){super();l(this,"log");l(this,"reprovideQueue");l(this,"maxQueueSize");l(this,"datastore");l(this,"timeout");l(this,"reprovideTimeout");l(this,"running");l(this,"shutdownController");l(this,"reprovideThreshold");l(this,"contentRouting");l(this,"datastorePrefix");l(this,"addressManager");l(this,"validity");l(this,"interval");l(this,"peerId");this.log=t.logger.forComponent(`${r.logPrefix}:reprovider`),this.peerId=t.peerId,this.reprovideQueue=new Wi({concurrency:r.concurrency??oD,metrics:t.metrics,metricName:`${r.metricsPrefix}_reprovide_queue`}),this.reprovideTimeout=new Nc({...r.timeout??{},metrics:t.metrics,metricName:`${r.metricsPrefix}_reprovide_timeout_milliseconds`}),this.datastore=t.datastore,this.addressManager=t.addressManager,this.datastorePrefix=`${r.datastorePrefix}/provider`,this.reprovideThreshold=r.threshold??sD,this.maxQueueSize=r.maxQueueSize??aD,this.validity=r.validity??vb,this.interval=r.interval??cD,this.contentRouting=r.contentRouting,this.running=!1,this.reprovide=Ab(this.reprovide.bind(this),r.operationMetrics,"PROVIDE")}start(){this.running||(this.running=!0,this.shutdownController=new AbortController,this.shutdownController.signal,this.timeout=setTimeout(()=>{this.processRecords({signal:AbortSignal.timeout(A4)}).catch(t=>{this.log.error("error running process to reprovide/cleanup - %e",t)})},this.interval))}stop(){var t;this.running=!1,this.reprovideQueue.clear(),clearTimeout(this.timeout),(t=this.shutdownController)==null||t.abort()}async processRecords(t){try{this.safeDispatchEvent("reprovide:start"),this.log("starting reprovide/cleanup");for await(const r of this.datastore.query({prefix:this.datastorePrefix},t))try{const{cid:i,peerId:s}=Eb(r.key),a=xb(r.value).getTime()+this.validity,c=Date.now(),u=c>a,d=this.peerId.equals(s);this.log.trace("comparing: %d (now) < %d (expires) = %s %s",c,a,u,u?"(expired)":"(valid)"),u&&!d&&await this.datastore.delete(r.key,t),this.shouldReprovide(d,a)&&(this.log("reproviding %c as it is within the reprovide threshold (%d)",i,this.reprovideThreshold),this.queueReprovide(i).catch(h=>{this.log.error("could not reprovide %c - %e",i,h)}))}catch(i){this.log.error("error processing datastore key %s - %e",r.key,i.message)}this.log("reprovide/cleanup successful")}finally{this.safeDispatchEvent("reprovide:end"),this.running&&(this.log("queuing next re-provide/cleanup run in %d ms",this.interval),this.timeout=setTimeout(()=>{this.processRecords({signal:AbortSignal.timeout(A4)}).catch(r=>{this.log.error("error running re-provide - %e",r)})},this.interval))}}shouldReprovide(t,r){if(!t)return!1;const i=Date.now();return r<i?!0:r-i<this.reprovideThreshold}async queueReprovide(t,r){var s;if(!this.running)return;this.log.trace("waiting for queue capacity before adding %c to re-provide queue",t),await this.reprovideQueue.onSizeLessThan(this.maxQueueSize,r);const i=this.reprovideQueue.queue.find(o=>o.options.cid.equals(t));if(i!=null)return this.log.trace("not adding %c to re-provide queue - already in queue",t),i.join();this.log.trace("adding %c to re-provide queue",t),this.reprovideQueue.add(async o=>{var c;if((c=o.signal)==null||c.throwIfAborted(),!this.running)return;this.log.trace("re-providing %c",t);const a=this.reprovideTimeout.getTimeoutSignal(o);try{await this.reprovide(o.cid,o)}finally{this.reprovideTimeout.cleanUp(a)}this.log.trace("re-provided %c",t)},{signal:(s=this.shutdownController)==null?void 0:s.signal,cid:t}).catch(o=>{this.log.error("could not re-provide key %c - %e",t,o)})}async reprovide(t,r){await ui(this.contentRouting.provide(t,this.addressManager.getAddresses(),r))}}const ZD=20,JD=5e3,eN="kad-close",tN=50;class rN{constructor(e,t){l(this,"routingTable");l(this,"components");l(this,"closestPeers");l(this,"newPeers");l(this,"refreshInterval");l(this,"peerSetSize");l(this,"timeout");l(this,"closeTagName");l(this,"closeTagValue");l(this,"log");l(this,"running");this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:routing-table`),this.routingTable=t.routingTable,this.refreshInterval=t.refreshInterval??JD,this.peerSetSize=t.peerSetSize??ZD,this.closeTagName=t.closeTagName??eN,this.closeTagValue=t.closeTagValue??tN,this.closestPeers=new xn,this.onPeerPing=this.onPeerPing.bind(this),this.running=!1}async start(){if(this.running)return;this.running=!0;const e=await hi(this.components.peerId);this.newPeers=new Pg(e,this.peerSetSize),this.routingTable.addEventListener("peer:ping",this.onPeerPing),this.timeout=setInterval(()=>{this.updatePeerTags().catch(t=>{this.log.error("error updating peer tags - %e",t)})},this.refreshInterval)}stop(){this.running=!1,this.routingTable.removeEventListener("peer:ping",this.onPeerPing),clearTimeout(this.timeout)}onPeerPing(e){var t;(t=this.newPeers)==null||t.add({id:e.detail,multiaddrs:[]}).catch(r=>{this.log.error("error adding peer to distance list - %e",r)})}async updatePeerTags(){var i;const e=new xn((i=this.newPeers)==null?void 0:i.peers.map(({peer:s})=>s.id)),t=e.difference(this.closestPeers),r=this.closestPeers.difference(e);this.closestPeers=e,await Promise.all([...[...t].map(async s=>{await this.components.peerStore.merge(s,{tags:{[this.closeTagName]:{value:this.closeTagValue},[k4]:{value:1}}})}),...[...r].map(async s=>{await this.components.peerStore.merge(s,{tags:{[this.closeTagName]:void 0,[k4]:void 0}})})])}}function Cu(n){return Array.isArray(n==null?void 0:n.peers)}class nN{constructor(e,t){l(this,"peerId");l(this,"root");l(this,"localPeer");l(this,"prefixLength");l(this,"splitThreshold");l(this,"kBucketSize");l(this,"numberOfNodesToPing");l(this,"lastPingThreshold");l(this,"ping");l(this,"verify");l(this,"onAdd");l(this,"onRemove");l(this,"onMove");l(this,"addingPeerMap");this.peerId=e.peerId,this.prefixLength=t.prefixLength??oN,this.kBucketSize=t.kBucketSize??Og,this.splitThreshold=t.splitThreshold??this.kBucketSize,this.numberOfNodesToPing=t.numberOfOldContactsToPing??lN,this.lastPingThreshold=t.lastPingThreshold??fN,this.ping=t.ping,this.verify=t.verify,this.onAdd=t.onAdd,this.onRemove=t.onRemove,this.addingPeerMap=_h({name:`${t.metricsPrefix}_adding_peer_map`,metrics:e.metrics}),this.root={prefix:"",depth:0,peers:[]}}async start(){await this.addSelfPeer(this.peerId)}stop(){this.addingPeerMap.clear(),this.root={prefix:"",depth:0,peers:[]}}async addSelfPeer(e,t){this.localPeer={peerId:e,kadId:await hi(e,t),lastPing:Date.now()}}async add(e,t){const r={peerId:e,kadId:await hi(e,t),lastPing:0},i=this.addingPeerMap.get(e);if(i!=null)return i;try{const s=this._add(r,t);this.addingPeerMap.set(e,s),await s}finally{this.addingPeerMap.delete(e)}}async _add(e,t){var o;const r=this._determineBucket(e.kadId);if(this._indexOf(r,e.kadId)>-1)return;if(r.peers.length===this.splitThreshold&&r.depth<this.prefixLength){await this._split(r,t),await this._add(e,t);return}if(r.peers.length<this.kBucketSize){if(!sN(e,this.lastPingThreshold)){r.peers.push(e),await((o=this.onAdd)==null?void 0:o.call(this,e,r,t));return}await this.verify(e,t)&&(e.lastPing=Date.now(),await this._add(e,t));return}const i=r.peers.filter(a=>{var c;return!(a.peerId.equals((c=this.localPeer)==null?void 0:c.peerId)||a.lastPing>Date.now()-this.lastPingThreshold)}).sort((a,c)=>a.lastPing<c.lastPing?-1:a.lastPing>c.lastPing?1:0).slice(0,this.numberOfNodesToPing);let s=!1;for await(const a of this.ping(i,t))s=!0,await this.remove(a.kadId,t);s&&await this._add(e,t)}*closest(e,t){var i;const r=new Pg(e,(t==null?void 0:t.count)??this.kBucketSize);for(const s of this.toIterable())((i=t==null?void 0:t.exclude)==null?void 0:i.some(o=>o.equals(s.peerId)))!==!0&&r.addWithKadId({id:s.peerId,multiaddrs:[]},s.kadId);yield*vr(r.peers,({peer:s})=>s.id)}count(){function e(t){if(Cu(t))return t.peers.length;let r=0;return t.left!=null&&(r+=e(t.left)),t.right!=null&&(r+=e(t.right)),r}return e(this.root)}get(e){const t=this._determineBucket(e),r=this._indexOf(t,e);return t.peers[r]}async remove(e,t){var s;const r=this._determineBucket(e),i=this._indexOf(r,e);if(i>-1){const o=r.peers.splice(i,1)[0];await((s=this.onRemove)==null?void 0:s.call(this,o,r,t))}}*toIterable(){function*e(t){if(Cu(t)){yield*t.peers;return}yield*e(t.left),yield*e(t.right)}yield*e(this.root)}distance(e,t){return BigInt("0x"+U(Zo(e,t),"base16"))}_determineBucket(e){const t=U(e,"base2");function r(i,s=0){return Cu(i)?i:t[s]==="0"?r(i.left,s+1):r(i.right,s+1)}return r(this.root)}_indexOf(e,t){return e.peers.findIndex(r=>ke(r.kadId,t))}async _split(e,t){var s,o;const r={prefix:"0",depth:e.depth+1,peers:[]},i={prefix:"1",depth:e.depth+1,peers:[]};for(const a of e.peers)U(a.kadId,"base2")[e.depth]==="0"?(r.peers.push(a),await((s=this.onMove)==null?void 0:s.call(this,a,e,r,t))):(i.peers.push(a),await((o=this.onMove)==null?void 0:o.call(this,a,e,i,t)));iN(e,r,i)}}function iN(n,e,t){return delete n.peers,n.left=e,n.right=t,n.prefix===""&&(delete n.depth,delete n.prefix),!0}function sN(n,e){return n.lastPing<Date.now()-e}const Og=20,oN=6,aN=20,cN=100,lN=3,uN=20,dN=100,P4="kad-peer",hN=1,fN=6e5,pN=!0,gN=1e3;class mN extends ot{constructor(t,r){super();l(this,"kBucketSize");l(this,"kb");l(this,"network");l(this,"closestPeerTagger");l(this,"log");l(this,"components");l(this,"running");l(this,"pingNewContactTimeout");l(this,"pingNewContactQueue");l(this,"pingOldContactTimeout");l(this,"pingOldContactQueue");l(this,"populateFromDatastoreOnStart");l(this,"populateFromDatastoreLimit");l(this,"protocol");l(this,"peerTagName");l(this,"peerTagValue");l(this,"metrics");l(this,"shutdownController");this.components=t,this.log=t.logger.forComponent(`${r.logPrefix}:routing-table`),this.kBucketSize=r.kBucketSize??Og,this.running=!1,this.protocol=r.protocol,this.network=r.network,this.peerTagName=r.peerTagName??P4,this.peerTagValue=r.peerTagValue??hN,this.pingOldContacts=this.pingOldContacts.bind(this),this.verifyNewContact=this.verifyNewContact.bind(this),this.peerAdded=this.peerAdded.bind(this),this.peerRemoved=this.peerRemoved.bind(this),this.populateFromDatastoreOnStart=r.populateFromDatastoreOnStart??pN,this.populateFromDatastoreLimit=r.populateFromDatastoreLimit??gN,this.shutdownController=new AbortController,this.shutdownController.signal,this.pingOldContactQueue=new Gi({concurrency:r.pingOldContactConcurrency??uN,metricName:`${r.metricsPrefix}_ping_old_contact_queue`,metrics:this.components.metrics,maxSize:r.pingOldContactMaxQueueSize??dN}),this.pingOldContactTimeout=new Nc({...r.pingOldContactTimeout??{},metrics:this.components.metrics,metricName:`${r.metricsPrefix}_routing_table_ping_old_contact_time_milliseconds`}),this.pingNewContactQueue=new Gi({concurrency:r.pingNewContactConcurrency??aN,metricName:`${r.metricsPrefix}_ping_new_contact_queue`,metrics:this.components.metrics,maxSize:r.pingNewContactMaxQueueSize??cN}),this.pingNewContactTimeout=new Nc({...r.pingNewContactTimeout??{},metrics:this.components.metrics,metricName:`${r.metricsPrefix}_routing_table_ping_new_contact_time_milliseconds`}),this.kb=new nN(t,{kBucketSize:r.kBucketSize,prefixLength:r.prefixLength,splitThreshold:r.splitThreshold,numberOfOldContactsToPing:r.numberOfOldContactsToPing,lastPingThreshold:r.lastPingThreshold,ping:this.pingOldContacts,verify:this.verifyNewContact,onAdd:this.peerAdded,onRemove:this.peerRemoved,metricsPrefix:r.metricsPrefix}),this.closestPeerTagger=new rN(this.components,{logPrefix:r.logPrefix,routingTable:this,peerSetSize:r.closestPeerSetSize,refreshInterval:r.closestPeerSetRefreshInterval,closeTagName:r.closeTagName,closeTagValue:r.closeTagValue}),this.components.metrics!=null&&(this.metrics={routingTableSize:this.components.metrics.registerMetric(`${r.metricsPrefix}_routing_table_size`),routingTableKadBucketTotal:this.components.metrics.registerMetric(`${r.metricsPrefix}_routing_table_kad_bucket_total`),routingTableKadBucketAverageOccupancy:this.components.metrics.registerMetric(`${r.metricsPrefix}_routing_table_kad_bucket_average_occupancy`),routingTableKadBucketMinOccupancy:this.components.metrics.registerMetric(`${r.metricsPrefix}_routing_table_kad_bucket_min_occupancy`),routingTableKadBucketMaxOccupancy:this.components.metrics.registerMetric(`${r.metricsPrefix}_routing_table_kad_bucket_max_occupancy`),routingTableKadBucketMaxDepth:this.components.metrics.registerMetric(`${r.metricsPrefix}_routing_table_kad_bucket_max_depth`),kadBucketEvents:this.components.metrics.registerCounterGroup(`${r.metricsPrefix}_kad_bucket_events_total`)})}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.shutdownController=new AbortController,this.shutdownController.signal,await li(this.closestPeerTagger,this.kb))}async afterStart(){let t=0;Promise.resolve().then(async()=>{if(!this.populateFromDatastoreOnStart)return;const r=Le([this.shutdownController.signal,AbortSignal.timeout(2e4)]);try{for(const i of await this.components.peerStore.all({filters:[s=>s.protocols.includes(this.protocol)&&s.tags.has(P4)],limit:this.populateFromDatastoreLimit,signal:r})){if(!this.running)return;try{await this.add(i.id,{signal:r}),t++}catch{this.log("failed to add peer %p to routing table, removing kad-dht peer tags - %e"),await this.components.peerStore.merge(i.id,{tags:{[this.peerTagName]:void 0}})}}}finally{r.clear()}this.log("added %d peer store peers to the routing table",t)}).catch(r=>{this.log.error("error adding %d, peer store peers to the routing table - %e",t,r)})}async stop(){this.running=!1,await rs(this.closestPeerTagger,this.kb),this.pingOldContactQueue.abort(),this.pingNewContactQueue.abort(),this.shutdownController.abort()}async peerAdded(t,r,i){var s;this.components.peerId.equals(t.peerId)||await this.components.peerStore.merge(t.peerId,{tags:{[this.peerTagName]:{value:this.peerTagValue}}},i),this.updateMetrics(),(s=this.metrics)==null||s.kadBucketEvents.increment({peer_added:!0}),this.safeDispatchEvent("peer:add",{detail:t.peerId})}async peerRemoved(t,r,i){var s;this.components.peerId.equals(t.peerId)||await this.components.peerStore.merge(t.peerId,{tags:{[this.peerTagName]:void 0}},i),this.updateMetrics(),(s=this.metrics)==null||s.kadBucketEvents.increment({peer_removed:!0}),this.safeDispatchEvent("peer:remove",{detail:t.peerId})}async*pingOldContacts(t,r){var s;if(!this.running)return;const i=[];for(const o of t){if(this.kb.get(o.kadId)==null){this.log("asked to ping contact %p that was not in routing table",o.peerId);continue}(s=this.metrics)==null||s.kadBucketEvents.increment({ping_old_contact:!0}),i.push(async()=>{const a=this.pingOldContactQueue.find(o.peerId);if(a!=null)return this.log("asked to ping contact %p was already being pinged",o.peerId),await a.join(r)?void 0:o;if(!await this.pingOldContactQueue.add(async u=>{var f;const d=this.pingOldContactTimeout.getTimeoutSignal(),h=Le([d,this.shutdownController.signal,u==null?void 0:u.signal]);try{return await this.pingContact(o,u)}catch{return(f=this.metrics)==null||f.kadBucketEvents.increment({ping_old_contact_error:!0}),!0}finally{this.pingOldContactTimeout.cleanUp(d),h.clear()}},{peerId:o.peerId,signal:r==null?void 0:r.signal}))return o})}for await(const o of Cn(i))o!=null&&(yield o)}async verifyNewContact(t,r){var o;const i=this.pingNewContactTimeout.getTimeoutSignal(),s=Le([i,this.shutdownController.signal,r==null?void 0:r.signal]);try{const a=this.pingNewContactQueue.find(t.peerId);return a!=null?(this.log("joining existing ping to add new peer %p to routing table",t.peerId),await a.join({signal:s})):await this.pingNewContactQueue.add(async c=>{var u;return(u=this.metrics)==null||u.kadBucketEvents.increment({ping_new_contact:!0}),this.log("pinging new peer %p before adding to routing table",t.peerId),this.pingContact(t,c)},{peerId:t.peerId,signal:s})}catch{return this.log.trace("tried to add peer %p but they were not online",t.peerId),(o=this.metrics)==null||o.kadBucketEvents.increment({ping_new_contact_error:!0}),!1}finally{this.pingNewContactTimeout.cleanUp(i),s.clear()}}async pingContact(t,r){try{return this.log("pinging contact %p",t.peerId),await this.components.ping.ping(t.peerId,r),this.log("contact %p ping ok",t.peerId),this.safeDispatchEvent("peer:ping",{detail:t.peerId}),!0}catch(i){return this.log("error pinging old contact %p - %e",t.peerId,i),!1}}get size(){return this.kb==null?0:this.kb.count()}async find(t,r){var s;const i=await hi(t,r);return(s=this.kb.get(i))==null?void 0:s.peerId}closestPeer(t){const r=this.closestPeers(t,{count:1});if(r.length>0)return r[0]}closestPeers(t,r){return this.kb==null?[]:[...this.kb.closest(t,r)]}async add(t,r){if(this.kb==null)throw new Error("RoutingTable is not started");await this.kb.add(t,r)}async remove(t,r){if(this.kb==null)throw new Error("RoutingTable is not started");const i=await hi(t,r);await this.kb.remove(i,r)}updateMetrics(){if(this.metrics==null||this.kb==null)return;let t=0,r=0,i=0,s=20,o=0;function a(c){if(Cu(c)){c.depth>i&&(i=c.depth),r++,t+=c.peers.length,c.peers.length<s&&(s=c.peers.length),c.peers.length>o&&(o=c.peers.length);return}a(c.left),a(c.right)}a(this.kb.root),this.metrics.routingTableSize.update(t),this.metrics.routingTableKadBucketTotal.update(r),this.metrics.routingTableKadBucketAverageOccupancy.update(Math.round(t/r)),this.metrics.routingTableKadBucketMinOccupancy.update(s),this.metrics.routingTableKadBucketMaxOccupancy.update(o),this.metrics.routingTableKadBucketMaxDepth.update(i)}}const yN=[77591,22417,43971,28421,740,29829,71467,228973,196661,78537,27689,36431,44415,14362,19456,106025,96308,2882,49509,21149,87173,131409,75844,23676,121838,30291,17492,2953,7564,110620,129477,127283,53113,72417,165166,109690,21200,102125,24049,71504,90342,25307,72039,26812,26715,32264,133800,71161,88956,171987,51779,24425,16671,30251,186294,247761,14202,2121,8465,35024,4876,85917,169730,3638,256836,96184,943,18678,6583,52907,35807,112254,214097,18796,11595,9243,23554,887,268203,382004,24590,111335,11625,16619,29039,102425,69006,97976,92362,32552,63717,41433,128974,137630,59943,10019,13986,35430,33665,108037,43799,43280,38195,29078,58629,18265,14425,46832,235538,40830,77881,110717,58937,3463,325358,51300,47623,117252,19007,10170,20540,91237,294813,4951,79841,56232,36270,128547,69209,66275,100156,32063,73531,34439,80937,28892,44466,88595,216307,32583,49620,16605,82127,45807,21630,78726,20235,40163,111007,96926,5567,72083,21665,58844,39419,179767,48328,42662,51550,5251,37811,49608,81056,50854,55513,20922,18891,197409,164656,32593,71449,220474,58919,85682,67854,13758,35066,3565,61905,214793,119572,141419,21504,10302,27354,67003,46131,32668,15165,64871,34450,17821,2757,11452,34189,5160,12257,85523,560,53385,65887,119549,135620,312353,115979,122356,10867,193231,124537,54783,90675,120791,4715,142253,50943,17271,43358,25331,4917,120566,34580,12878,33786,160528,32523,4869,301307,104817,81491,23276,8832,97911,31265,52065,7998,49622,9715,43998,34091,84587,20664,69041,29419,53205,10838,58288,116145,6185,5154,141795,35924,21307,144738,43730,12085,8279,10002,119,133779,199668,72938,31768,39176,67875,38453,9700,44144,4121,116048,41733,12868,82669,92308,128,34262,11332,7712,90764,36141,13553,71312,77470,117314,96549,49135,23602,54468,28605,6327,62308,17171,67531,21319,14105,894,107722,46157,8503,51069,100472,45138,15246,14577,35609,191464,1757,13364,161349,32067,91705,81144,52339,5408,91066,21983,14157,100545,4372,26630,129112,1423,29676,213626,4397,88436,99190,6877,49958,26122,114348,60661,29818,293118,50042,179738,16400,163423,89627,31040,43973,36638,45952,5153,1894,109322,1898,134021,12402,112077,68309,190269,69866,31938,107383,11522,105232,11248,14868,39852,71707,186525,16530,38162,106212,11700,5130,16608,26998,59586,108399,230033,43683,48135,82179,2073,5015,196684,189293,16378,23452,8301,35640,11632,214551,29240,57644,33137,91949,55157,52384,117313,5090,17717,89668,49363,82238,241035,66216,29066,184088,97206,62820,26595,4241,135635,173672,8202,459,71355,146294,29587,3008,135385,141203,14803,6634,45094,69362,50925,546,51884,62011,83296,234584,44515,56050,89476,87751,19373,12691,149923,19794,13833,35846,87557,58339,2884,19145,25647,12224,11024,77338,64608,122297,53025,7205,36189,36294,170779,21750,7739,173883,75192,35664,224240,113121,30181,26267,27036,117827,92015,106516,55628,203549,67949,60462,60844,35911,20457,1820,920,19773,8738,73173,181993,38521,98254,76257,46008,92796,5384,26868,151566,22124,2411,15919,186872,180021,28099,152961,78811,80237,62352,102653,74259,184890,16792,123702,224945,29940,19512,75283,14059,112691,92811,233329,20411,138569,53341,109802,50600,134528,66747,5529,166531,31578,64732,67189,1596,126357,967,167999,206598,109752,119431,207825,78791,91938,10301,27311,24233,252343,28831,32812,66002,112267,90895,8786,8095,16824,22866,21813,60507,174833,19549,130985,117051,52110,6938,81923,123864,38061,919,18680,53534,46739,112893,161529,85429,26761,11900,81121,91968,15390,217947,56524,1713,6654,37089,85630,138866,61850,16491,75577,16884,98296,73523,6140,44645,6062,36366,29844,57946,37932,42472,5266,20834,19309,33753,127182,134259,35810,41805,45878,312001,14881,47757,49251,120050,44252,3708,25856,107864,120347,1228,36550,41682,34496,47025,8393,173365,246526,12894,161607,35670,90785,126572,2095,124731,157033,58694,554,12786,9642,4817,16136,47864,174698,66992,4639,69284,10625,40710,27763,51738,30404,264105,137904,109882,52487,42824,57514,2740,10479,146799,107390,16586,88038,174951,9410,16185,44158,5568,40658,46108,12763,97385,26175,108859,664,230732,67470,46663,14395,50750,141320,93140,15361,47997,55784,6791,307840,118569,107326,18056,58281,260415,54691,8790,73332,45633,7511,45674,143373,14031,11799,94491,35646,96544,14560,26049,32983,25791,83814,42094,231370,63955,139212,2359,169908,3108,183486,105867,28197,32941,124968,26402,88267,149768,23053,3078,19091,52924,25383,19209,111548,97361,3959,24880,235061,9099,24921,161254,151405,20508,7159,34381,20133,11434,74036,19974,34769,36585,1076,22454,17354,38727,235160,111547,96454,117448,156940,91330,37299,7310,26915,117060,51369,22620,61861,322264,106850,111694,15091,2624,40345,300446,177064,1707,27389,54792,327783,132669,183543,59003,17744,20603,151134,106923,53084,71803,279424,319816,11579,21946,16728,38274,72711,5085,83391,88646,40159,25027,34680,10752,12988,54126,30365,18338,100445,230674,44874,84974,143877,123253,139372,28082,91477,144002,13096,219729,46016,50029,42377,14601,6660,58244,58978,23918,88206,113611,64452,17541,41032,10942,12021,49189,10978,40175,37156,10947,71709,106894,112538,57007,137486,150608,152719,40615,7746,279716,13101,19524,28708,40578,72320,1096,182051,94527,51275,22833,45164,81917,77519,48508,5421,140302,37845,149830,5587,27579,5357,428725,248187,6326,206760,39814,32585,89923,44341,288753,284443,96368,31201,94189,119504,20359,52073,103216,179,27934,32801,96035,34111,34309,101326,18198,20704,210266,37643,27880,141873,106e3,19414,56614,167714,66483,107885,86602,4379,20796,75467,4987,5017,118857,26003,34308,114428,29198,6686,29697,73632,3739,69795,16798,41504,7207,30722,21436,36735,28067,28545,3239,11221,36031,41889,100010,19247,317673,29495,174554,6424,129725,53845,94986,7955,59676,2604,191497,19735,102214,62954,23844,11872,179525,261436,34492,428,78404,142035,16747,17246,27578,37021,33672,57944,26056,135760,2369,61674,122066,31327,19374,157065,40553,130982,69619,71290,38855,72100,92903,95940,51422,165999,65713,57873,50726,7288,20272,2081,42326,22624,81120,57914,79352,19447,1684,72302,11774,302559,161481,96396,13692,414988,3721,79066,56627,46883,21150,11747,12184,5856,113458,176117,84416,52079,27933,3354,59765,141359,2212,216309,2555,23458,196722,142463,45701,44548,28798,19418,215,29916,9396,10574,114226,84475,13520,18694,34056,4524,90302,62930,13539,19407,77209,7728,38088,9535,2263,23875,183945,17750,26274,67172,10585,28042,22199,7478,51331,66030,26774,192929,31434,25850,50197,52926,178158,4679,181256,70184,229600,9959,105594,72158,73974,2726,35085,78087,23284,35568,51713,155676,5401,27254,11966,17569,223253,71993,103357,111477,55722,30504,26034,46774,35392,36285,214814,41143,163465,1051,16094,81044,6636,76489,179102,20712,39178,35683,125177,54219,30617,52994,25324,50123,2543,87529,58995,10688,125199,12388,60158,125481,131646,7642,133350,65874,3438,97277,101450,10075,56344,116821,50778,60547,98016,106135,13859,14255,16300,77373,173521,8285,45932,37426,4054,114295,55947,7703,39114,52,51119,128135,19714,60715,9554,50492,88180,2823,118271,52993,122625,97919,23859,37895,25040,33614,32102,20431,3577,9275,15686,43031,157741,110358,1884,40291,125391,13736,5008,64881,87336,77381,70711,43032,49155,118587,70494,4318,10168,30126,12580,10524,280104,104001,145413,2862,84140,6603,106005,13566,12780,11251,42830,571,179910,82443,13146,469,42714,32591,265217,424024,92553,54721,134100,6007,15242,114681,59030,16718,85465,200214,85982,55174,165013,23493,56964,82529,109150,32706,27568,82442,5350,14976,13165,44890,60021,21343,33978,17264,4655,22328,27819,75730,16567,55483,14510,17926,45827,150609,3704,7385,272531,161543,76904,122163,52405,2039,19165,41623,14423,228354,3369,176360,85491,7122,35789,303724,4465,13628,2233,55311,118771,20713,10006,221519,45115,71021,35650,29775,7337,10864,20665,21142,1746,15080,1624,32449,10905,105743,229797,7701,3940,22997,178467,57208,389057,39683,59403,63344,63125,54847,69691,18336,56448,3362,37202,18282,29648,138224,35867,10495,5911,28814,26653,31514,176702,26550,45621,11734,4525,40543,73944,121080,27858,155561,14887,44670,30742,8796,107455,113472,56369,75581,183777,240095,133699,153299,8768,160464,26058,49078,103971,21875,71486,44888,17156,9678,89541,123019,102337,3972,83930,21245,87852,109660,287918,183019,686,10100,39177,283941,11274,24736,26793,26214,25995,77011,141580,4070,23742,46285,46632,30700,26669,19056,35951,115575,174034,56097,35463,87425,24575,44245,38701,82317,85922,281616,100333,147697,61503,7730,84330,8530,59917,61597,17173,9092,32658,90288,193136,39023,20381,56654,31132,7779,1919,1375,117128,30819,11169,40938,23935,115201,101155,151034,4835,11231,74550,89388,59951,91704,107312,167882,115062,12732,72738,88703,464019,158267,57995,60496,737,14371,123867,4174,243339,159946,7568,16025,134556,110916,38103,191,80226,88794,29688,27230,10454,76308,57647,77409,113483,66864,14745,19808,12023,46583,84805,16015,17102,2231,20611,3547,95740,250131,34559,108894,8498,15853,159169,148920,20942,2813,93160,45188,210613,45531,52587,149062,39782,28194,57849,60965,84954,89766,84453,100927,16501,27658,165311,103841,54192,207341,19558,20084,319622,5672,205467,98462,61849,36279,13609,147177,24726,165015,209489,59591,31157,6551,117580,75060,141146,277310,21072,22023,106474,63041,137443,122965,68371,5383,42146,98961,113467,30863,23794,4843,99630,30392,82679,13699,241612,33601,93146,24319,18643,32155,95669,40440,15333,34089,67799,142144,58245,38633,114531,117400,77861,188726,5507,2568,8853,10987,107222,2663,2421,11530,13345,30075,41785,118661,104786,17459,12490,16281,71936,193555,17431,5944,71758,26485,77317,20803,367167,158,7362,93430,11735,172445,46002,11532,54482,930,62911,2235,23004,179236,4764,101859,208113,22477,55163,95579,14098,67320,162556,90709,156949,3826,57492,4025,34092,87442,104565,6718,186015,28214,14209,10039,107186,233912,58877,81637,55265,39828,6194,145813,50831,105849,4974,88319,122296,10272,197216,95714,51540,72418,23324,91555,8743,140452,250249,51666,34124,7229,38592,129641,78169,174242,22464,149964,51450,14034,10026,95376,26190,120062,14401,8700,265,31386,143573,7203,229889,61567,4227,140981,2466,72052,10787,10062,30958,6099,38471,30103,23202,208101,70847,467,58934,32271,32984,36637,24107,30771,17109,73353,13650,2098,157040,67366,66904,106018,265380,107238,18535,44025,32681,144983,62505,91295,56120,3082,77508,10322,63023,36700,81885,224127,16721,45023,239261,111272,13852,7866,149243,204199,32309,22084,42029,38316,126644,104973,14406,43454,67322,61310,15789,40285,24026,181047,6301,70927,23319,115823,27248,66693,115875,278566,63007,146844,56841,59007,87368,180001,22370,42114,80605,12022,10374,308,25079,14689,12618,63368,7936,264973,212291,136713,95999,105801,18965,32075,48700,52230,35119,96912,32992,8586,16606,101333,101812,14969,39930,759,193090,27387,42914,12937,5058,62646,64528,38624,25743,37502,3716,4435,30352,178687,26461,132611,42002,138442,35833,59582,16345,8048,60319,49349,309,47800,49739,90482,26405,34470,63786,32479,85028,39866,47846,11649,23934,29466,2816,42864,31828,7410,74885,49632,47629,111801,90749,19536,18767,105764,59606,21223,10746,76298,22220,39408,7190,79654,64856,11602,82156,272765,17079,70089,245473,51813,184407,384678,1576,122249,5064,27481,6188,25790,74361,27541,318284,45430,31488,620,93579,45723,192118,22670,51913,4162,70244,35966,26397,16199,50899,209613,121702,287507,2993,36101,132229,67345,33062,76295,118628,78705,52316,34375,107083,107454,44863,127561,33964,3073,154010,190914,55967,39074,6272,31047,5550,41123,26154,98638,47110,19998,148091,50229,31329,59900,195442,19106,61347,73497,70015,682,45850,25776,38022,148951,6288,37411,232526,109277,27286,32342,9262,5220,16651,23175,46740,129438,78614,121925,66914,88710,127952,5563,21500,34521,10739,14863,191006,62956,17359,16749,67027,56284,69134,43301,35039,58883,54466,60823,404451,75743,59856,86979,7923,34273,83785,32142,7693,268986,197428,282681,17049,22346,22990,92245,107180,3357,37104,96724,49153,7683,31197,43267,82231,164276,23696,20848,188364,22309,24821,158707,1018,22514,70922,27792,45589,59709,10765,736,35218,63479,51987,24275,63588,55361,92929,81964,4658,20122,12330,44058,13065,311456,72224,8337,211229,38979,22590,138478,52757,32595,133600,8838,31549,94412,43391,90056,1585,94802,127271,6223,31889,137038,132910,2165,57616,230152,6080,10748,36737,74579,134062,50525,180532,119270,34556,76155,82394,52595,29258,31435,87820,67996,26943,183878,38007,2410,13526,180297,69856,3503,187396,167700,7838,16701,9199,56267,3661,37407,65994,23767,5708,62508,221700,67088,86978,46776,84434,32088,5612,9149,88244,21685,95151,46750,189612,2979,506311,2594,3628,40074,105039,78243,28523,6651,38058,71999,30992,12764,68261,108991,6165,26450,61961,13400,22426,7490,60890,109623,2070,12958,50355,67979,257096,7213,42578,52121,35716,65461,7516,124758,39268,302,64712,14977,1467,219452,2840,34229,11121,21602,19270,63574,8024,1532,17331,79839,78885,52029,180767,57957,6069,91265,61380,55767,8927,32881,287603,22149,35029,68876,6428,199567,46926,13412,104132,21434,366616,45060,110046,81924,128910,45886,52821,130416,29416,77342,21762,67329,121432,79924,11724,38625,81006,102033,28338,13326,3250,82056,82526,38212,21112,12382,111495,3263,7414,86274,93490,40844,30224,45212,24019,48411,71367,24941,76729,57776,3769,38114,202019,197745,31953,237533,33270,201580,255648,100798,44741,32241,98468,106931,10085,15090,170358,33154,66787,18819,69760,25061,234005,82660,6295,131975,16874,9076,4094,25005,17740,40908,19533,220019,44330,99792,50040,19619,13950,55228,24423,31253,95308,103177,184795,28590,82285,5059,3210,75525,49894,70007,56178,10580,36051,139681,21617,98736,3555,106306,164189,37352,63915,47824,24883,145530,61904,28444,11483,19837,145446,30420,112972,85939,11835,191233,2262,20705,58630,1753,148334,1197,144714,6887,11223,107667,60879,77914,4151,57417,81594,96681,169430,1784,20444,95138,254041,27038,596,7117,72808,13759,3353,126776,21074,55322,27081,36942,39547,139830,179275,4453,713,8722,71399,19204,25785,22794,23923,104114,11291,25458,102309,88396,75288,230440,206396,104551,58447,130857,37247,94734,31548,176529,226077,65159,20104,10096,66881,94191,237909,27109,37404,1520,27421,25220,113003,23423,24884,50585,6286,231877,150800,11789,3226,90004,60642,5053,202400,61442,132531,175329,57138,30116,103847,9973,75367,16452,32360,59119,21246,10191,164804,23305,61051,37348,154530,13214,5468,50403,66754,130976,50559,80515,14436,155492,84017,5472,43107,41240,2890,90431,70188,382,76234,48040,50211,281038,237007,32115,142178,1536,22761,96429,1811,31243,1679,49143,55209,17402,235054,61494,7462,77030,34925,87609,78002,9499,9027,73289,201078,101379,63544,27666,5469,10642,30029,49816,132979,95620,58086,351930,116300,2110,2043,30845,6154,11279,16727,4122,2277,27281,4971,3650,39060,61970,65951,39674,75686,38151,11370,130809,177895,32665,63725,122267,7857,39618,118483,44792,157755,178624,136994,24260,41308,22471,12404,21707,12486,30473,52781,50246,20247,39065,909,56825,103158,128603,31542,1089,41935,32744,12428,37963,84420,33134,72921,208449,42622,168151,127335,147107,46699,38216,12591,94342,85814,31423,24944,2605,87542,67473,192551,4496,56321,91819,17630,6300,256183,114569,202090,33209,35289,34897,24967,40520,43470,5344,10199,34810,14283,10381,10017,62923,49924,23233,64539,13051,35686,19698,11570,135555,120868,44924,87065,52318,52335,47586,140906,245885,109834,78668,9065,46990,25258,72022,61243,40838,4545,146387,10537,11557,17470,36930,68104,46711,24264,79401,81043,18225,120488,24746,84338,81652,28266,13776,21878,46973,1047,230465,73357,95777,24973,210160,62210,58404,110633,169651,6937,41870,9909,26822,191062,76553,27519,96256,239070,2478,205678,67955,58532,20601,50120,19148,78501,195724,110740,8249,109665,27446,30568,57631,31425,49752,32820,65504,50079,3663,102256,219898,23849,211315,14645,4359,91767,9528,12449,49366,7941,49763,107848,8930,27086,50686,9744,10447,81935,39513,46514,1670,29229,6172,22312,137280,97759,9806,14445,22976,56458,73391,34983,93760,174219,52573,33149,59747,2429,136277,75123,165263,91040,7446,57632,48633,97140,246081,84766,151684,79918,93268,120346,54059,54875,77858,32996,103590,45276,11968,19600,25849,17159,132907,42828,16817,4913,99462,103303,27395,5737,74184,20749,21160,14377,77062,131403,158735,10999,27799,77785,9320,34366,51593,61070,33746,47048,29268,36675,30262,53297,9832,82e3,20188,122292,39917,7331,18160,68301,185935,134830,15031,4935,10004,165845,185534,46923,30109,44134,122631,18874,22903,112790,26561,18549,348902,82871,140345,255565,135390,63556,103747,145055,179600,145662,296111,61661,211987,23952,52342,126343,48450,32919,44277,82185,9591,62139,205363,376969,394874,108461,18040,120885,14798,39863,16571,16794,58271,81025,55206,14640,118656,6361,44092,85970,6262,153863,108244,180200,72264,79947,38044,10050,5735,61221,80712,5471,115689,11391,11661,184257,20010,60116,30320,19327,134598,45455,27542,18004,125092,452272,1549,91523,46567,180063,156026,2608,11174,58848,37788,65907,80194,30490,5786,40775,119519,106241,11323,156297,8425,61495,2617,29675,2425,59886,112582,49142,59618,4863,50597,86710,50650,168632,27693,85641,83643,18993,25768,84284,28090,93592,36627,312804,43381,9887,9402,100931,97165,3311,173330,66805,28935,4963,184460,3201,78102,19126,21607,37496,24938,22615,16153,32862,134792,153318,61120,6067,2812,12826,12792,23825,37559,64662,202250,102694,155488,85881,149193,46233,65383,15521,106982,11358,176786,25752,39717,34208,24510,32464,77742,39371,72028,138229,60688,71386,102834,132477,2208,11548,63670,271279,28351,30338,38620,32491,99845,143885,152266,13252,2825,178663,108097,1775,78201,14897,113573,163346,62292,171129,22183,96598,38733,64971,166776,117445,9968,146393,44677,74867,20908,97328,12761,25656,26785,9148,112344,26115,99176,110121,22437,49547,6180,79320,5835,31392,43328,33377,75870,119860,69497,80273,7325,155219,43167,111173,28347,20222,3763,71752,55041,47252,14618,28088,15012,97805,194698,54636,2036,41349,6173,96604,61530,51859,43782,13361,24334,22668,24792,7070,23441,16789,3209,36211,208475,26242,32880,122181,182407,21444,31060,88459,29929,77907,12716,10934,97005,20599,31690,8403,58445,30303,22700,10336,86731,103115,337709,72556,46788,112566,47684,67089,53548,36874,56487,41387,125985,26893,40071,106683,73712,18787,40105,72992,67246,137276,50802,36790,70328,138827,22466,39263,183295,29858,50975,9322,57397,10654,24364,30383,55799,41600,23584,127295,296610,129078,143558,244131,86397,36049,1085,80677,3820,108139,5476,34767,24683,7758,13060,7239,131671,250593,59556,103392,29810,4188,252323,39404,116877,7651,43600,40338,13554,157253,39196,25978,144387,61211,234,50104,6129,10449,93777,9240,356378,274148,4439,72970,3724,147770,78680,62570,115877,40027,40547,36817,224392,64609,34795,165027,67440,2477,37206,23431,50754,164797,46018,94995,170982,27051,7957,22767,3674,27900,56419,18930,60701,41302,2692,84749,339721,61996,111094,80221,50129,1045,8153,62945,19202,8250,37208,37418,32560,79477,41106,88569,33963,36693,5892,30570,1581,66471,49647,11922,160717,29442,5643,114865,82962,95982,132098,22633,22838,94726,54556,28566,205039,162340,33216,16849,35847,221339,94851,26533,71469,1805,3804,12935,45483,71020,36310,65381,192960,34240,35165,59773,1248,46954,155332,96864,4246,388800,16129,57133,74592,44807,442014,38203,42574,80818,91592,26377,36424,65760,977,77387,22628,147610,28018,30561,98454,6969,119628,63648,18170,36854,26601,64018,22027,37279,51395,152934,21153,9430,58760,194742,5330,55115,34158,28917,174111,13171,122326,1526,43896,66094,25325,4234,148354,11450,275,18999,112191,44365,22723,68409,8733,57746,96565,75007,14196,108844,29475,88599,177563,100792,106156,86323,93726,14248,135341,194131,40126,47099,14779,8272,39597,95983,171398,65882,28052,10393,47213,40689,22120,72212,106829,34964,109146,753,648,21660,30047,17527,181025,5619,145357,4085,216883,9359,186951,24779,53931,24545,36197,223296,62628,168101,4243,107313,30321,26642,13049,51059,31027,107912,807,73550,26551,84369,122422,165872,49754,74213,234264,33151,52014,33100,87183,22365,52500,40013,23302,5652,72723,21404,26107,48434,587,94049,168493,96418,32871,70860,31709,25128,443,71597,166253,15670,70994,26341,133675,28280,75491,54756,47955,56028,26182,11952,113272,472197,64640,110753,17919,337,50642,22576,142,87371,53391,93210,126694,15285,19642,85667,14148,1506,42092,52962,33243,11970,20734,135843,57044,58880,13002,219134,22876,64754,232519,4257,43120,321573,24799,64526,124728,52579,81472,70831,276848,17403,74359,23021,182101,74597,23744,148267,12055,7976,5349,11772,67540,167347,65318,18720,127832,108238,22828,90233,9987,259080,118185,73209,79270,13775,90100,137742,90799,70569,15699,19961,9087,67475,57872,39731,8810,134897,131868,146849,19898,3334,2281,167061,91073,60356,467742,74712,188,53179,137679,92769,29241,9537,132595,80119,1041,88962,5976,40171,44911,102859,139059,104558,98987,47761,19272,71472,113864,175377,73338,10857,23402,23758,1591,139864,5644,4076,118760,16427,134198,18853,20291,100849,37423,22038,36677,19071,195521,57445,11069,31869,55718,66882,148490,44,41296,75242,49704,166810,9906,20943,122258,49112,105667,15969,10344,6408,187694,21399,72742,58970,14867,14376,81889,41856,23225,15042,56993,16074,131389,74276,72407,53875,383108,53597,37363,68993,44854,122548,430927,198279,38430,80409,12245,2981,628,2818,17760,37437,238229,7968,46892,2200,3730,34190,65983,37959,112291,87850,70827,6522,20750,73913,111621,41652,19587,2780,58668,25916,85259,18200,168962,95781,42445,102050,7776,57662,103313,47742,96358,41964,66174,100396,29069,204735,19679,27978,7479,40264,22534,61183,36081,107436,58223,14680,23002,101311,24716,124108,12908,5646,31750,40380,14215,232799,102772,14122,96775,61398,50917,12096,149880,67833,598749,124194,155871,49216,790,14677,65319,56917,7440,145744,95701,12206,49405,129269,76199,45732,9767,11058,9047,210885,11051,7392,26307,2130,8132,147526,20802,232698,115660,50060,59789,57344,107623,80343,112676,23291,9866,160971,34032,118291,15719,59730,164911,28975,2659,58046,78480,21854,66209,53863,109085,116045,29021,46481,107552,22130,18764,70254,31272,11300,52460,43933,84738,20721,53869,190840,79673,105300,7561,321817,66924,13940,33281,101046,183181,32176,71878,5678,62924,79535,56646,40303,19559,27703,93042,73368,42187,3670,37376,46440,7023,36816,109628,20680,5940,276440,275233,170848,112093,136996,14984,20226,111441,77693,112960,48577,39370,55707,50314,123404,26570,54281,61372,123391,4857,35928,246740,132507,106646,44241,7196,92258,9825,37688,51197,303141,5590,15476,132986,10955,85782,34486,26696,7991,28813,18858,39546,11703,11365,38185,5716,93555,11925,40121,60002,6985,10976,171384,3887,43394,13337,56346,6381,252336,39573,75042,53711,1028,31781,44295,95925,131713,7214,68125,43571,70954,213234,1628,8760,13391,65485,17320,56038,1710,25248,60803,57399,19839,3870,326,281556,50945,72400,21460,316244,75619,56246,98775,481,13513,55765,50427,7388,123519,32929,57908,27124,61316,101097,57467,30228,48792,10788,20402,37318,50526,155730,34456,158065,145305,17832,43733,64052,4506,35072,205355,177028,184004,187081,68616,35938,83703,10367,36892,93186,260137,51934,89970,4985,23445,26755,21558,7948,78741,23376,124405,85594,68596,57536,49351,12619,56593,132668,99924,109728,71844,71935,196018,65464,17617,14987,89701,143773,33997,8687,22701,33258,2914,4436,72108,85610,9671,49067,2327,82988,1361,1672,44033,35777,30269,24057,10605,82236,616,15793,13919,47249,112086,116698,9484,80207,90574,33304,68624,93127,56101,42210,160929,4827,38995,38095,4701,125119,5027,33680,9236,231236,14135,87837,23318,70261,78893,30151,81482,14332,1084,74256,27532,46644,79185,3148,62615,6981,55672,31668,36825,1849,14536,37446,14738,23779,43058,162749,72199,1168,21346,5592,85932,85302,9668,18351,57135,150360,2080,228015,77953,34670,119302,151751,31009,106725,84265,45214,59289,74178,113071,263206,111009,4021,44449,188119,192629,123592,392506,292847,114487,12831,205858,9852,20780,79648,75767,357014,97721,18166,21005,67950,33226,204009,16536,2987,11335,66717,144910,47950,17262,55060,15063,2934,51038,26775,178497,66008,3427,49433,128592,20036,157553,63861,3089,23015,51210,28696,35933,49942,71135,231518,99620,17248,21835,176536,20676,16944,38700,165831,233253,295625,36723,13023,52745,10907,19423,67972,125868,95473,82875,1183,108455,52685,33417,64095,21433,52438,33191,127809,44505,211823,7810,2752,95548,162031,7185,91196,47563,61721,33359,17897,23682,42806,178101,22874,49707,199897,75419,82456,8618,11171,79712,116847,18783,44190,46564,5346,59046,95032,7893,14916,3214,26800,24172,121453,34362,10250,17408,18888,4840,68696,22831,13162,36005,32512,14800,62357,41723,45046,27247,37486,5372,2564,34261,298500,66509,133920,89138,31305,117697,19097,108304,81386,84106,23802,46411,63304,946,51417,41777,41041,19501,115864,60743,294354,37955,94165,18116,1156,17937,20645,57114,90804,58042,48643,92288,9861,2557,88546,61333,101008,12853,5148,87856,4152,144503,73841,18718,9789,147565,10846,42085,12789,30223,8993,56352,67203,2448,28215,6052,23540,126319,75933,36689,80235,23231,23561,21383,38800,77548,102798,21234,31468,158608,46188,63960,191679,8051,67014,11185,170078,42186,28827,34777,41930,212079,12421,34750,24111,110344,73918,45171,70826,141949,40063,23979,24254,37309,26724,27179,24718,83648,54938,14591,17425,29525,102675,48975,48654,12316,8929,60640,41709,50168,63264,89812,50716,48632,38755,138583,160123,55579,71829,24230,233277,46322,39650,166388,34718,24108,98252,7031,106695,62498,18258,35062,217827,78731,34824,33354,19520,60852,2432,60224,8587,2836,62955,702,20227,42285,40560,95592,62486,11094,53035,143291,18842,46177,77994,1770,9657,107422,172915,32655,128716,25886,25164,156740,119928,165875,85817,11007,89110,33956,12652,65156,180266,8494,36889,19958,20955,96,1264,118288,135769,44754,86671,5632,19026,168220,289120,33569,93821,66144,70635,7687,5642,2714,55445,56636,71545,184182,93133,7332,37389,12643,52315,22729,11014,158742,17050,152889,50178,34601,41945,52136,9948,26914,63548,95721,115951,40759,8960,158258,38938,49232,48325,42234,81523,253019,66128,40978,20048,238048,38760,62928,122560,118532,43687,137472,163689,26680,9878,17448,51035,16211,60834,36749,29178,14241,59868,150086,2305,26477,42422,34342,165341,83279,33894,14257,29928,12743,13957,125571,89134,66712,10952,16507,147839,30146,7249,16565,45399,39874,114565,215780,31990,230881,171477,102,196546,44538,10880,84948,281705,86651,10617,31395,2342,453658,43569,60561,132901,21845,17727,58556,258242,22262,58728,4008,77997,11806,37431,30599,81375,109137,185787,114085,217292,97453,169085,30593,60212,11544,102056,65580,2384,91655,4855,95725,7295,157994,16228,20669,53276,141590,105246,17334,25440,76067,17967,39321,38911,11362,28559,63807,21627,26468,85816,40120,1025,15234,58319,69516,66512,124548,75845,78873,22137,46681,51242,85683,32909,76747,35555,43396,101465,1765,73094,1077,2962,39028,66777,57831,42048,15828,13962,36041,63657,52412,5242,58846,2141,5506,219012,134451,3936,182230,17558,17153,152237,22621,49377,170216,35257,68233,65374,6510,11126,212151,7184,2480,22517,3437,33073,30156,16557,3768,55067,86829,91e3,12350,148650,66017,79424,70885,49066,28250,21369,51213,34533,11510,3258,18176,18465,84413,6315,36411,163765,4346,356,107618,598,13727,285026,162695,8749,14583,7132,63521,184253,32378,25991,5604,30961,53675,4874,84693,5086,34811,26978,56564,7904,33519,51221,113942,69253,6664,125563,22055,220680,102008,742,51930,19494,176108,44424,35123,13025,75685,11759,74335,22250,181453,131147,16984,132115,154311,11991,76452,52609,85351,196,30969,9198,74919,2529,56838,71779,29187,116304,3504,62330,41190,86153,28393,254926,104228,105189,13264,84359,3574,12415,8534,57147,10175,188174,59504,60932,66318,16407,107921,17638,99103,49278,28403,39786,145865,8462,3558,43406,142271,29139,21989,36552,93955,72365,7176,13556,106185,37957,321774,17782,129017,51154,27938,24952,1935,39366,2791,33489,41582,56078,24558,9311,5449,218786,27808,190429,68013,36020,86003,29735,3404,87348,119357,115714,2324,86796,81973,40992,43376,93621,28784,16808,36367,2517,2909,191926,24978,55303,53308,205724,60068,3098,21375,64784,23949,26579,63121,12319,80145,39967,97861,6757,70143,67642,37082,34698,69140,122883,46151,62187,80934,429,19437,135071,137885,222647,13331,154065,327,61778,74257,40116,37493,14855,85079,237641,42342,102164,199965,71204,4662,29368,5042,113914,122214,8955,13149,102503,43173,5659,163787,69003,307084,63392,171080,21390,81918,86666,36622,24126,28887,5736,28054,207170,163428,79891,346467,95363,38980,111806,80828,9200,19288,294896,114468,87405,111715,141705,7015,72754,68463,48738,243147,33397,101210,37051,98801,82847,20397,4940,185559,18716,54718,83491,11725,40803,1128,12128,23060,5174,7745,67007,46701,1571,27807,180186,256996,18975,16837,7877,212758,250379,15440,87954,57755,24719,124057,83461,258,50864,8874,29038,71289,31627,15429,9005,4061,113851,107716,82819,13651,79656,117851,17539,111446,12938,39724,190787,4352,15402,21070,62708,8539,23777,73853,13552,38810,86117,16285,56400,1718,75342,142863,29033,378,110113,180321,32586,23606,26393,160984,207987,23783,8406,16904,24596,47274,11693,46539,60524,78595,48423,31718,20170,9009,146268,15183,191060,172765,1349,138436,37365,10970,40509,225817,20021,70394,152138,21541,66559,66544,89352,2725,17258,91345,7313,3815,115868,8660,40362,4071,103524,39388,118275,21950,6549,38226,32754,209574,29201,43495,18028,20296,40597,18370,47520,202450,24134,2219,8195,69545,38041,136934,46374,19041,159811,84865,58620,846,98749,13569,30714,97246,32186,4479,27355,92973,35214,151491,75963,37631,1561,27200,238083,23182,60756,12291,25766,39355,102333,87362,65741,59906,19538,201575,48772,102938,24438,292580,39964,66366,9004,61379,50548,37622,38732,28379,68180,76622,17488,69849,5963,7219,48143,43413,55358,540,58691,29506,19245,52193,48621,5518,13048,118625,44755,191081,42061,89197,2259,60665,66994,71210,51232,3585,142096,55024,7892,8345,58653,463307,65658,64319,137941,136323,53499,12746,43492,6978,95163,29925,60175,5128,7352,41463,184756,121146,20473,18426,4598,5309,54580,14277,121151,10691,56711,43880,63409,76682,11830,172218,264898,32632,66536,81062,31649,25788,92774,60222,11100,63159,9432,224657,25240,53613,152,138620,163829,2397,85345,12501,37507,64932,38575,43522,65789,80198,78796,35226,3851,108891,73311,3060,28391,93671,39663,46142,30982,66041,37281,68157,26553,71872,81142,211527,39747,118119,22695,2859,11066,20232,168911,7933,197005,17066,111071,44434,133994,120798,12766,227798,45756,132852,29917,36076,55352,65281,129800,41958,18944,84678,18580,168093,132621,39997,54092,27740,32354,3770,114118,103242,43918,15899,18574,145944,3190,123469,219903,24169,100571,62403,16776,92779,14535,17168,16475,14304,37231,1712,28218,242754,61688,28980,1318,51359,222657,99200,67989,31772,23932,35351,201251,49041,27306,19128,40135,3986,77333,19649,120683,151927,21081,7076,78375,77501,101599,8011,89585,96715,58179,5378,102138,106793,26051,217276,4197,16297,27014,46721,13322,22806,5278,29629,70632,9647,71519,58818,40603,128530,8903,36770,56900,31483,26935,43845,34265,34920,87658,6114,84767,64250,47318,50720,19264,162514,33357,13117,6705,46696,75032,71054,87004,42035,69138,11903,99854,102328,19611,34525,69312,6431,49842,101600,133178,108751,41829,89939,225664,48916,99556,9195,130387,5960,36857,116724,53518,94002,39077,53996,6945,22261,64291,8314,152785,57588,16522,9091,5048,87671,35441,39509,1945,12423,158923,178413,37549,14095,1475,73188,62878,4819,24012,68534,42606,4010,120809,57497,59564,101758,103718,32701,80116,12345,95834,46918,21468,53213,15665,31200,3867,5140,96013,250744,21016,10069,13968,35449,180829,27683,39704,59956,22893,3115,26293,32785,75934,62445,141162,62720,2018,83638,19949,114012,95006,3330,99829,130935,309272,9565,55874,121727,37017,23586,319858,40970,27602,8625,112329,61060,100088,118525,25922,16232,1907,60671,51583,44553,80993,5262,94679,8676,940,20736,11823,3020,16476,12340,152600,97416,3703,25744,66826,16245,16876,46446,84798,74227,176020,45192,61955,75496,23946,23626,40372,26036,6149,11822,30582,16541,41914,82385,232823,40921,80773,14930,3631,7517,39619,4348,36180,126106,138939,62611,1477,113512,47321,25052,14546,118881,29060,23589,128322,36795,18401,137921,104699,267929,36194,172791,18113,4766,188215,30083,332586,94089,5805,77909,22194,68234,154976,43220,40660,70001,184893,138095,11128,103010,22663,5108,212615,8485,5565,49222,54614,26530,42639,16319,55062,152662,105595,21114,22216,10294,68158,10436,86950,7206,62115,3977,3657,59874,456,118617,18156,106663,112229,80992,17442,8217,55551,5133,34344,251927,51153,39364,201321,7816,66803,23057,156724,145664,14276,95705,979,2796,6875,13429,212525,50602,26276,28284,3424,19465,52397,46963,31420,51399,206476,92317,48851,637,100820,83349,10317,60227,21972,6908,282439,32857,224767,95629,83882,42106,87338,69757,29840,68709,37665,45244,114577,49188,175943,54009,186746,106158,70168,3358,234002,50555,9221,129338,9562,20118,32923,78479,118280,65752,4977,10474,102174,60947,129006,10570,83451,8598,8078,159367,123785,80438,16742,5905,5281,181513,42402,6977,163136,93179,42191,14968,50421,112401,105440,33456,57347,121611,4221,94954,36517,24046,27796,6255,33394,72990,135408,116627,1233,57874,25654,95419,68156,401399,313338,55208,45573,93124,119251,47200,38196,11909,130667,45391,73904,64964,167846,4137,115606,52036,62214,7969,160925,7187,1132,134835,40309,73195,64494,80472,444841,61111,26500,45323,40743,53625,52797,22659,15631,29739,36706,28841,39147,102836,26794,10536,14845,87305,45874,12241,127587,83833,57183,79722,30844,41304,84655,20825,92500,3722,25655,27811,10157,81634,31362,34088,92487,70123,22190,185100,72658,139035,192523,88241,2078,230490,44528,85638,100198,22088,29982,291233,241062,13865,4445,137791,37835,107218,31726,19718,38234,72528,23046,19177,66695,5109,17251,28077,5617,21554,47839,72425,133825,1486,73065,181275,141508,21768,62971,63082,2512,34200,9904,120309,6392,91243,68416,268253,41199,116757,138551,185526,41246,28986,4093,19057,17295,4148,245766,122360,35356,112075,20301,75441,10998,7977,19769,62922,937,63547,100196,26427,157820,20983,236696,22935,8140,90315,156004,47204,140973,7726,45097,52725,22636,23436,257282,105247,522,88389,216031,202204,46812,211666,19693,68828,81691,45925,11256,30292,372,5236,167826,88328,232776,151611,5360,82104,18841,80393,25465,18285,20320,72377,31730,33160,45803,38715,27705,37379,24163,18360,103586,4015,32305,269494,91252,20080,36567,54650,7797,57073,12650,31164,42209,6375,261663,105528,81661,106002,2800,5375,17247,43151,4442,15727,194619,100855,144898,62320,78465,39929,16454,1967,28311,61363,17219,9395,8745,121445,76939,80385,162380,22009,54191,44248,16299,122830,48151,74429,78291,64755,14238,44966,2511,17712,67954,93583,829,105899,49935,84750,11591,33185,85447,42717,27409,208542,28965,62052,52525,5597,25694,65594,16343,63224,276188,12475,9331,127507,38522,57287,24128,133161,79723,105548,133695,48917,27558,43278,46520,13778,141954,110785,83366,17715,46317,105763,66298,147013,41086,94180,16478,220447,44611,730,19722,78975,117889,125643,26254,16574,18480,65006,15806,38549,246418,46052,36056,8440,34984,30170,3163,59800,4458,115442,4283,41970,33507,104078,1653,22,121158,276486,3655,6338,24048,133421,23641,2161,24422,36006,8086,10675,181474,12307,29514,59143,14729,52509,87128,122470,19446,80852,33314,24573,119864,14237,9652,57779,6612,51851,15284,98871,90581,124466,156831,21190,22015,71380,161906,87247,69201,18392,17908,108470,72962,40719,14338,17911,95260,43339,20610,78916,20710,72451,11315,31448,17263,58853,178878,48111,116002,45497,80506,82605,85880,36300,121755,25215,36118,301929,88728,405223,276136,553,34704,212438,49970,78329,922,20711,25036,257130,38295,145369,18128,15385,30829,55656,48345,8012,3561,28004,122041,192900,58338,112508,41085,29976,87040,47117,23905,4336,92061,138880,97407,42083,172121,6256,25192,172671,5,93568,1420,12677,31605,56743,40620,6015,78415,231077,31298,80026,13902,19048,24924,170586,32955,176119,87859,36731,6773,27711,24658,26475,115216,133207,93250,95820,88522,8317,5714,124047,55219,86860,19677,23961,22928,162209,8904,225992,359835,56084,96201,29392,96558,86071,93643,55114,13347,8183,95129,82012,2017,123336,34219,115554,157159,47747,101684,41008,18735,193781,104151,226906,7552,179874,124113,31159,21162,44010,14771,51268,166128,31382,73124,77438,92830,205709,12113,1292,38937,13114,1334,2118,15597,69581,14449,21934,76618,48728,67038,14967,51495,24243,87736,147249,26720,11119,46063,43749,5843,44147,152629,133428,65703,14269,45604,57982,28672,55616,45957,8438,95433,37698,220862,132034,39456,61870,4161,26501,73560,56418,9845,4654,20916,10456,88920,119358,9015,65931,96507,48029,38534,21676,109081,43078,34943,25089,6131,28766,23665,5477,10255,16695,67,45778,42443,42770,29534,23733,100513,62617,42630,48746,14191,43753,50295,26007,8792,57243,43119,54725,164253,58250,112304,131796,25165,4651,3188,24831,47748,3705,19540,13211,102095,5593,18699,23666,32005,117571,33541,60584,74573,86311,99443,25172,27222,168938,7143,11853,53560,18834,19960,86522,28217,53266,117700,72989,34323,18721,66450,34346,74056,47217,202002,46269,9429,68582,75458,37823,82843,96652,32549,145144,27958,19820,158086,31955,201406,135379,31207,192545,12950,51704,9094,248263,76147,64028,110009,79407,89345,99284,223492,47966,26848,15359,201137,2861,110507,71231,72297,31851,118777,71039,151051,240855,16333,50766,14727,7939,4149,80908,418780,88378,59276,1327,7284,38576,79814,65820,42199,84860,49574,62596,12396,70598,40117,8648,7994,16836,7630,14047,359699,106878,525,29037,28064,13380,11675,50669,74216,103539,180314,27449,56299,172344,19274,7301,246099,32043,19422,36506,129317,6806,30140,4614,46639,66926,932,86600,6322,27847,233103,10541,39025,34887,3517,12972,26220,2031,66561,115015,48658,47596,12714,33845,3893,16165,35237,89983,14769,11962,147224,47018,29977,27979,5552,82338,86023,131368,1218,24853,237840,132193,15455,40873,3668,65351,53388,15229,59889,272245,47934,11858,34347,18038,90853,86981,300602,19343,114181,29362,84921,6095,106059,79472,38015,1206,48741,6208,8e4,21916,17423,6002,108083,24479,34931,56661,9511,26995,100694,163853,35997,81254,58321,18919,171890,86877,91341,74503,70477,53412,7027,59281,39892,131302,5864,15947,61301,67466,162369,47956,27874,35624,282324,21270,111847,102548,41482,30955,116737,28264,8592,55458,22301,75090,29821,30697,51709,3041,19208,8038,24634,30467,87509,126428,19389,18814,152686,20701,83474,45832,80891,105808,11378,153223,120770,98186,150633,49838,9141,12755,30962,5260,74490,21256,31678,65062,33326,289838,187831,20595,89768,2805,58535,10844,70085,12090,2451,138068,98544,24461,4511,6754,41684,28203,3383,65355,82833,30161,83924,234361,128424,28921,222594,33975,125491,34069,11508,67464,144226,41850,98703,34371,7901,21254,38398,65651,23549,53883,213340,123269,12028,71764,177701,28758,2623,68395,11549,15232,68603,9660,63116,36079,57093,31198,20475,48467,89984,35619,186847,107469,31389,43631,73867,41949,68841,114250,1605,30564,63403,17588,27680,99533,12641,70325,50428,73426,78379,11855,91651,72081,91720,60198,15743,12065,83398,140046,6761,46598,45900,5068,886,62448,148968,37347,19405,9680,15819,43496,63370,75667,163700,37639,3633,22774,34341,183131,134335,37200,23915,7054,14194,12970,26438,13350,285521,25594,8219,104410,91039,168804,138480,149734,15907,33818,61132,60082,4622,110187,56736,13551,73571,3945,73463,65498,17758,263266,17593,2710,27585,54469,38200,45367,63754,28881,3473,12791,98287,31895,65787,4463,94536,24951,36332,59901,28803,52130,86403,7668,181822,74831,18977,9850,177206,145485,109798,7292,31421,26280,77211,58511,12507,127004,11113,147,8729,56208,43066,79926,129937,31345,83947,39915,46146,98763,42566,1337,13192,18323,105163,80570,117753,16555,72883,11077,159438,40764,70933,83329,26066,12276,72059,21655,173836,126713,69454,153482,91585,70644,102558,110483,6764,127864,190133,3961,101798,20945,71138,82402,90884,69669,44753,923,16939,59700,164258,25969,27082,31399,43846,6306,246093,51342,6153,151581,202801,182731,56475,162188,89426,141356,14355,121815,27536,28023,65257,77523,106668,127314,24947,12790,38796,169698,23555,10725,44573,183083,42088,62716,43265,105958,32050,44067,50118,1668,3874,6243,318411,16599,1691,94999,52378,28671,216728,123258,2059,34969,69225,5913,136280,171443,141515,91662,22175,135282,80020,92270,1663,4808,4482,3495,34691,5226,109830,108512,17342,107488,11606,123190,100247,29666,146527,113014,15794,30894,13224,39585,243192,22351,9903,7836,47699,11078,25468,122291,48821,26780,122679,75521,81450,630,4895,92900,55074,74293,17441,3563,111657,103102,51613,12318,52370,36191,68245,34269,40445,41354,122901,168604,182500,62012,42557,11259,24428,115113,86345,12362,3909,78430,86852,134602,20459,47853,93879,22577,7659,3688,38555,13349,17381,56715,91639,12493,10895,92438,3142,37057,28928,2004,36427,32268,34222,209974,10432,67436,41989,173518,107930,27079,62729,30908,55558,5828,45031,14902,53546,8204,144263,60255,14520,88212,86582,109589,69356,8064,47449,8505,66558,16886,4844,52817,111260,215129,12941,91118,650,20770,6273,73089,40618,62790,2873,35002,14023,97208,19386,102646,36993,143736,135457,35385,113601,17893,32627,84439,100619,56016,6581,57264,172160,45452,111710,203627,70131,24100,322787,1996,35665,70078,22358,90922,83658,4097,63200,58499,14542,99153,52159,6615,12414,63415,31986,16823,1579,65405,137809,8841,16898,48082,259,33014,42375,12260,179850,73667,91389,98882,29532,17311,326251,41092,5928,20742,44964,48019,43505,9317,49265,6643,192712,48424,163487,19861,20113,70848,31928,105333,23685,78563,14638,54755,7158,24142,44018,20774,125255,20331,24280,10163,1285,2336,39851,4299,117269,46714,63816,87779,159624,11731,9971,990,137317,108831,50994,74554,162680,23640,131597,146962,170620,34829,91205,21184,1913,63616,18427,93136,156592,17519,67565,115882,138220,78622,88535,18115,2711,33554,109492,54298,971,24914,25863,36363,45715,27099,194995,14299,178181,111488,72395,322385,157719,130787,11897,81843,83999,11369,49280,118604,40922,61332,110343,53407,75639,40582,300440,54722,25637,13694,48248,48278,194521,56203,52779,48783,72627,10953,376,16733,280238,26351,230789,15132,25168,137270,3588,63704,73376,94031,74284,19443,159557,9697,39901,13351,119050,15406,146455,3460,29556,75195,37673,102524,92329,47289,98413,15311,100684,56345,7116,95480,11590,7200,167,23610,58426,17730,136656,27944,53151,2701,8824,103124,3017,90744,113588,53216,79736,65940,26931,498,29568,80540,143543,21292,1740,59268,16561,180816,42323,50174,40890,52866,10703,57169,4700,17191,4424,93511,49698,166650,26972,48631,165169,82879,69326,202970,4007,2376,231325,139592,22119,62851,37504,68816,58345,67398,186643,43331,277416,53749,15746,23102,17432,4793,151138,48822,54265,48203,198688,14305,54287,2291,18018,113378,123260,7180,97549,87027,120085,2920,76080,8190,102005,5641,64580,14955,59802,54028,58884,19367,81779,412567,85957,97053,103637,78871,29364,27637,141728,4767,30686,112738,130146,42745,12730,105040,14844,232,210944,36581,152317,135543,29744,3129,55647,58149,46319,27265,17499,28005,59948,7170,34138,5702,293047,110892,408,91760,218674,18469,46095,81403,14389,4610,35672,73060,11006,74848,104820,118143,190357,20043,105358,141735,5115,27093,45924,123073,52599,29433,9616,238350,78610,24851,58858,26769,31969,24613,18294,4982,32735,39639,143563,112073,202205,12567,4873,88601,44897,81503,101648,81362,34662,85277,17574,48173,21435,221188,40215,39576,80786,26544,64668,81841,10731,37733,247986,149188,127703,495,18382,54388,72446,43071,30974,198723,89608,41360,190,33045,8386,31658,19992,237838,119015,137622,50890,100913,6460,116233,267230,26621,104129,65114,14190,41542,14888,85962,23342,23041,26453,43725,71809,45186,4770,46452,53894,56616,221286,18973,9038,109299,55365,19366,26863,18808,60909,69353,41738,83463,12100,68561,72860,3980,13796,49340,12332,31311,27418,4255,53430,18976,45523,510,14224,30477,26581,4530,3651,101663,139840,22709,150861,31996,63923,120623,262522,3076,10528,2929,14672,130238,18087,9816,121894,100308,25085,55111,14565,18952,53293,2042,369988,23674,61789,133529,28783,108293,35477,47119,36448,71049,40015,33055,78598,198442,1833,159937,40654,77444,189245,113153,8621,18599,38553,35223,166072,2375,11659,21786,89523,6032,12116,63046,159398,18454,3678,32521,47626,11411,103527,38896,42946,15696,26370,10185,8413,37080,165583,4331,63555,14907,72220,50056,6623,62236,36565,49783,10049,17503,100581,55951,146244,24724,9626,17969,25524,109300,173965,99994,101056,46459,43647,53737,277968,8347,123521,74858,33829,44762,77574,877,81377,222525,123532,30602,43881,53145,2973,16284,81940,61281,127044,63620,9875,14756,114829,19032,9202,52759,119141,23928,120551,19607,3599,33401,76821,73233,117430,39968,36539,7071,5446,121735,194059,15206,45283,6706,15603,65615,1207,165723,92275,34773,104447,8396,32353,205240,164323,13600,60555,79205,25532,22907,33410,57480,107111,69630,32137,47832,70913,33161,20321,2371,117348,10714,86246,1625,11763,17900,268,78457,99175,97940,101092,86660,32221,14041,128504,125080,53744,124263,31017,13897,403,31859,21964,5633,111630,5547,77329,17961,18241,84995,25984,12983,67491,62168,47262,5241,297,51191,7351,8967,147212,82060,16821,782,11033,82431,62957,5026,43459,77963,203477,53528,6247,191852,87774,74164,215654,13467,1522,219964,28589,244104,16242,117821,67725,72570,156792,17186,15979,26990,44128,193014,35276,57125,16212,166451,68017,6905,77608,16364,53777,75921,76426,37975,26203,269296,64099,84122,12077,38533,830,4407,20139,963,43028,38902,42911,37503,83343,85045,16979,1165,60835,137387,58380,86990,110066,134540,56331,193845,81238,17922,163093,38744,110641,12502,56404,34862,26865,125964,12965,111648,25547,7771,27196,136980,9555,29551,107158,57885,18831,37705,35505,101742,13970,102109,62548,124657,23328,11124,89592,146376,248050,6241,22033,18337,80685,29898,11908,216623,67721,106162,146610,21377,15085,91552,42041,62560,122532,125336,102365,121537,142559,29693,223919,11515,110495,18776,22494,5895,185059,103592,229351,51220,100102,37027,257855,29359,54123,36066,106493,12244,79258,32002,432,56205,94836,90182,6726,14762,29391,48938,26864,38083,60364,3310,60192,14766,205567,57504,110760,22649,24666,46333,21517,3430,13135,28873,27052,158809,11597,20529,6695,23138,22960,37137,45574,6545,305877,43423,26153,24769,59844,14501,10430,134352,56169,13213,103432,49523,35181,13435,12408,129475,64620,230854,77390,51990,15653,83248,33466,44571,117828,51481,2187,10559,68019,18021,54895,48247,18354,33737,4554,108595,37288,39767,116707,9175,3726,108877,21616,83684,49862,1938,8543,276466,20134,108498,48770,102254,31914,131520,185291,100559,51890,209,19526,76471,50544,71814,99351,8172,198526,28816,20419,9109,98389,136777,76479,75596,30635,165417,48216,120220,25955,211071,39314,24308,32164,2559,146280,43403,9233,17947,90585,1786,86920,125662,2457,64741,32152,32918,122882,78538,44001,31723,56426,23375,103172,88177,145697,52506,49319,68016,31664,41488,18486,110400,7030,28241,986,109199,19900,42147,56864,65287,49183,7858,24e3,30453,840,16673,25907,68916,89927,6309,158335,36407,199737,130464,13137,59603,201778,195292,21015,42466,179062,172561,89492,11075,180407,31868,72493,20998,60217,9865,19530,39274,130266,54539,21623,12535,13505,40641,73375,4087,85633,2153,3117,70680,55788,92096,47509,98493,37490,271936,151475,3032,16171,96642,34106,78425,125761,19591,3366,19316,54508,24183,50786,194248,91528,33253,34622,108355,41741,705,3814,3883,108929,13203,67831,10142,59754,68208,29128,84820,56880,38794,24972,48571,40821,40476,18137,164254,24064,236309,79181,11282,395,39169,2013,51587,28551,9645,701,109513,115899,113566,12762,62045,58322,103726,41343,40866,244102,143816,2490,70346,40973,52618,15412,30720,104315,38917,42027,93676,17513,107418,20706,123890,13399,97727,24044,87962,65606,44250,98044,65276,74790,101473,19350,91570,1326,87790,172042,7577,100813,86896,85891,41512,108130,27794,14875,71431,12835,156250,58135,3759,22476,42176,115873,34686,56523,73643,108505,51491,20838,12721,32863,45700,29496,13700,34294,55360,29206,155942,123812,7706,163234,203,132720,49358,144431,8130,175788,35818,3270,76832,25710,54095,97274,28779,94621,74396,19092,128242,58067,20885,14670,93255,15107,63291,23654,126900,129421,59294,262659,9798,3251,67344,28600,44629,50672,29072,26999,31526,23183,49175,165843,175455,17282,175411,32022,45989,30298,90690,78118,83156,23749,35636,31317,7069,80381,94561,133756,14960,97404,6138,41065,78041,32843,16601,34123,9559,146529,123377,96395,54441,42012,84257,123541,10745,22139,106459,11720,150883,172651,154996,110538,4728,53447,25704,2009,71152,119354,21166,66604,1429,216162,8637,122250,63520,27180,29172,36124,276428,107787,77184,4680,14952,104903,24418,14793,51561,52931,8371,26342,48526,7118,92066,67280,40653,8847,34597,105438,14198,50163,61188,146286,50315,41205,170829,161496,585,197359,95056,1687,365794,91349,48507,5804,49263,5146,104902,96365,117343,132222,46084,96919,16875,8073,262381,79982,52663,13928,16056,153908,15145,109256,132308,18763,24904,167644,13618,40750,18686,147124,114709,150038,52849,2938,12568,48617,8778,5459,44202,44591,74914,17183,248689,13878,7822,80060,23116,194037,18487,2067,7798,43077,33678,244028,31320,74273,2794,19466,8218,36280,183997,48124,19416,29656,19280,98734,7715,18311,30701,133602,150307,126956,7378,2933,79903,13178,12593,86571,26604,92446,13574,44205,65699,427599,21118,8245,14407,27877,47936,33542,7916,26460,117762,21596,37818,2249,127359,209394,60044,47677,308089,36791,154971,31417,6998,150042,174360,12255,43009,29335,48739,3912,101398,53340,2580,146939,151295,45360,125275,15273,45383,27456,48761,23314,8750,60801,85823,104759,27894,123685,66968,39480,26917,55290,83305,2696,98390,57569,145853,340733,4919,20024,52268,30884,7413,203685,70989,112855,4129,50536,349518,68205,332641,159581,135361,236026,37563,176404,64899,6578,122033,63871,1850,85234,82089,66124,74145,121098,107351,12687,36881,117334,13136,14698,85933,93866,18047,32620,310,15094,46e3,88451,23632,36645,27940,87618,80520,58892,20976,27702,140090,96075,67841,103292,238964,87778,107338,17019,83427,67522,7302,8261,47570,116787,8730,80484,61772,174422,56005,131193,52875,14588,28471,59817,9586,15720,158155,51307,109734,15196,11025,59331,3884,52626,102602,84797,25158,27314,4437,20488,76214,189248,35023,114952,157376,2827,62439,102878,129749,36405,10329,109339,108633,36662,1254,13267,5470,87105,58004,15397,10434,159667,21864,52022,179464,3013,32147,31496,116832,18494,105502,129227,107267,50033,13481,9954,24267,22141,16257,116154,36185,950,115685,11305,176708,2048,178671,112573,287867,162328,497663,95170,50979,193861,50987,30368,136257,31830,46549,15119,169876,23788,17462,249887,57377,1949,35448,14791,43769,210091,3783,34612,282103,88380,245190,5457,20491,98908,11402,86899,117916,16028,162584,60644,320177,156096,31065,55876,22e3,77655,9992,23397,13757,317623,63978,215255,2443,17648,93231,27388,104529,93807,55505,140477,12046,112040,70887,40152,94365,112353,25063,114679,266061,71248,119555,15589,2244,617,14129,211431,70110,100652,7777,4383,85911,89221,21010,120615,58357,86405,37554,41647,18,15143,69662,60491,14714,186134,148344,42347,5410,168175,44535,42449,343894,129417,99682,20659,27272,140483,63455,222159,17536,13722,42637,62324,11976,114691,148109,2283,32057,182393,4295,147364,33705,2075,44303,30274,28331,63740,69740,29148,10346,44862,33716,73937,153333,12930,38784,247159,2515,41053,20256,83368,256189,54639,115240,5096,24661,175419,153552,26516,141,138176,63885,34115,47222,55709,2765,28479,38875,236608,12229,22921,77291,54426,45388,2860,57787,114579,295139,105782,17826,71066,19119,54364,69385,16568,12323,28057,33346,34919,124763,155533,101386,31644,8627,49001,303600,29868,63213,9103,77280,71333,9696,138789,37059,24823,5057,21352,32368,114208,56803,19424,10445,58514,8661,209508,26187,171838,10460,63454,14016,122504,41328,21329,46618,32493,38225,7855,31763,7945,29876,8734,6438,24205,97490,139977,130740,47323,33195,85390,57194,13813,60600,21313,96251,7699,27584,170521,139271,1363,4402,336738,129223,84983,69150,13147,3590,163929,207225,155260,55916,20288,4503,8398,98490,11773,27512,37113,84976,86558,28365,11756,116005,182148,13733,115313,47644,67208,85069,9347,14995,226141,14704,101835,41159,35314,13113,63526,214039,29978,50446,83339,17440,129441,72522,118641,97816,24907,73844,15717,118884,167255,96509,162793,30847,36849,51297,78974,77793,10427,1873,2972,9999,35074,28190,64297,146836,46298,60038,163007,108919,61219,2403,75022,127339,4233,110389,69022,9833,128097,88016,79390,222936,22570,94657,28462,56956,38803,81536,30474,152794,19566,16481,147408,74574,81895,20731,1918,1366,76367,187321,54494,24366,21690,61696,33283,107477,77499,31112,414383,74362,18463,218441,120929,59848,258629,201924,69269,454,19989,13054,59894,3623,58908,20681,35723,78523,102680,38988,184112,108087,50944,132704,52966,21699,18860,96349,201411,82697,85395,95658,5093,6427,177894,44191,32755,26961,155739,6249,31310,81030,26574,84311,120155,86730,113535,7424,48888,13516,45747,98098,20077,183995,81945,43210,26704,40420,75831,45648,11180,6855,57927,65528,124096,34851,2598,156633,107572,127352,38169,123845,60142,62722,105584,232364,23211,68120,1601,22169,89299,747,258039,80572,7258,152249,11862,101204,8834,121434,33761,19175,133142,46343,40178,48723,3589,41977,30210,38868,62257,10087,82658,87827,90646,16415,47552,351723,28298,72225,91146,272760,1701,11295,1652,109651,300747,51863,198800,29446,11794,32345,37538,22356,33102,37590,113544,37970,11478,179743,25454,103417,59905,221970,105196,145604,7817,164809,102360,16974,75840,255333,56902,6659,1954,645,59400,67769,7689,18675,5215,13793,20536,27852,3387,29523,259718,16860,94625,43143,29245,15848,233581,22685,63631,78557,22836,133302,84513,1348,51826,47129,98836,58284,1830,1749,94642,10933,6145,12506,10975,13879,103781,144434,10268,28409,32346,52968,121567,107374,77268,23686,35097,10501,155275,15303,47136,21102,168741,55332,90385,15996,84817,681,137803,25054,142275,6163,38175,8056,124296,240642,65621,4934,178205,16101,62803,60964,18230,100622,76465,44689,14545,9543,47514,16852,93380,28048,12047,107106,37575,101485,77047,57326,34819,96137,76916,6469,46264,115983,75768,87668,69942,13027,165,8373,114231,26434,52844,42799,182044,23580,146254,38081,43236,33883,146220,382894,14606,46035,36481,166621,35417,95382,2957,59384,60428,36358,66343,75378,22267,22950,83528,17577,56474,25285,4619,179691,75355,95836,53295,34588,171410,4487,14679,84208,44015,18562,109133,54101,11531,86052,174479,303157,28095,9953,35642,14564,39802,16145,77606,117406,53038,121117,53624,22062,1212,7632,127157,237292,189087,10478,127345,102515,181997,86752,87623,10966,121602,68783,68681,83042,114380,138349,191305,67176,50085,39016,1427,42384,1412,67118,122616,72389,25260,2237,13576,137346,19938,20304,2191,68759,5373,61364,238507,75814,23931,69565,38993,131741,38364,12528,87762,5679,129853,5310,186831,32653,90338,260176,389531,108118,26843,43985,50175,30563,25106,56965,18130,140428,4542,165503,117991,24219,229605,1819,129663,1240,3797,76093,18398,71339,51919,93043,27175,47060,216257,6483,35051,1217,16512,80798,129064,13225,69339,8548,237079,72298,2575,34280,51379,117910,55671,53345,247552,29486,39328,140821,34681,57045,60177,5004,90269,78522,2479,322607,48474,61296,13057,31558,4678,59271,6699,27044,31988,35944,12503,83480,4389,136508,3781,114121,70279,4488,155829,42214,2898,68191,75695,305850,45041,74344,106509,30087,17429,93292,12477,290,23080,114802,35714,18751,26554,105424,17775,2144,2412,100610,65192,113975,52975,180272,135050,129815,76238,106483,21440,63186,4260,46189,9711,28249,4169,23429,23390,8324,141585,63809,67668,38457,38063,39226,59972,1189,203916,62368,14403,16949,61767,85801,1739,40147,35049,76757,33124,62102,15780,103593,103009,53484,22952,67973,114645,6566,5245,50462,7601,8288,3513,194571,80276,1908,54592,5124,58571,2513,6800,273997,193904,1119,17991,117245,2508,129156,82366,26278,71465,63341,56943,39662,106116,94966,156875,9736,2204,122308,94418,27134,1280,24539,49022,45314,3764,50904,46424,30699,28087,293839,9400,33646,40165,822,147499,50263,116179,29085,11863,31314,5578,17797,5104,12454,1604,15342,219206,10232,67800,94261,25872,13565,90339,78971,75377,26649,41184,47695,11514,35369,20767,14227,41953,309396,148270,147938,33074,14453,27499,109019,39018,25738,240196,158931,52820,8612,95853,21524,137010,84901,70869,70021,116794,48404,38771,6732,1070,70990,187297,49140,5238,576,3564,253975,16027,16483,2811,37775,19034,25259,4053,2e3,70083,95774,19713,33431,92703,91314,42381,288770,48194,95985,3991,77418,13406,241328,245086,56533,35275,62725,9246,51924,70181,95331,16163,31410,79016,39312,120878,119371,275987,80124,27712,9186,220,23598,146167,85209,68238,282190,57048,31273,30555,80913,17594,75779,59160,135002,101219,189377,29225,96735,60126,62522,104e3,27620,86814,17240,147533,11001,5425,43682,410,49460,87270,69480,46315,59448,1816,76201,9431,11788,87960,29063,65539,47347,11678,33846,7008,196704,9895,6753,8633,120892,59970,572824,115934,6646,202559,892,48351,37611,251282,57823,67263,57750,26527,34485,90747,7685,88370,6144,64182,1709,41969,21458,62327,181657,49247,225330,122600,114574,107124,85361,111833,63243,71420,15655,191178,72430,18063,51425,54002,12364,53225,86557,18193,97580,41232,138398,67821,128724,8944,233212,101353,52099,42127,14006,120107,32789,32132,3498,18123,33758,56058,5779,128760,59888,98869,18445,84702,51911,13234,218379,20093,39031,8074,70195,20708,23462,24355,131384,60189,26390,10403,41060,7140,10781,49410,42261,87202,82566,41663,43105,60276,2768,5733,74176,28329,2297,145430,131632,83615,122915,105441,655,224102,5284,136426,67763,16294,188511,32538,61049,27893,3394,13951,159099,28542,17930,145360,9492,190122,32285,78855,26440,13570,58648,73908,4239,124561,2444,74172,53131,11468,10794,73566,11623,35343,64710,30481,4163,10328,38309,29901,10538,154377,76132,92405,24839,11679,3465,13449,11637,7824,2337,57754,1260,14458,41118,19878,38661,13416,159180,37074,163164,54137,28627,52134,184900,8520,40385,29546,30502,22386,66527,107458,6850,24022,47983,30603,35083,8934,304066,39500,9,28261,33026,77251,9374,44833,116312,34990,29236,63563,125639,135405,165398,159055,55690,88141,69643,236964,31983,25572,20436,36746,60896,31850,16179,11828,5888,3043,66368,9750,31167,7915,53111,36430,1333,64344,93659,20061,60596,180191,51630,6792,30244,43509,101058,22409,420,44210,109783,43223,27030,72477,72831,32679,29235,7675,47556,12258,39907,149412,84926,118247,24692,71717,105038,86009,45941,41189,89453,29856,52543,30627,226798,67303,59230,67415,34408,1367,99685,16867,128419,52147,4111,125381,117881,16173,44093,102224,31575,23234,24870,83790,127407,239098,3200,994,1255,100903,242275,117266,55116,38205,16140,29662,11307,40414,208793,123355,56470,4862,75600,30119,58218,70828,24075,26974,7802,192353,4851,5475,78720,66596,3409,28573,64396,30381,30690,59859,88256,5406,99945,103064,34463,37727,24238,86643,60088,4057,23741,5967,162904,38240,28356,93858,25510,122879,6897,3278,7057,11971,4400,35461,211413,21395,59615,39471,87233,55795,128426,3051,22470,41950,14705,3974,180108,80476,78442,204996,91987,15634,67610,139015,142373,35611,51134,10387,4353,153456,57749,181039,14183,68447,151532,21107,36452,20551,3186,46247,46383,129666,88736,140662,146243,2066,8360,7978,64818,106963,17896,47801,10723,114821,223295,74192,3293,3393,16987,74064,11277,91622,4270,29828,27951,387869,103235,1374,61988,120083,477,145892,128378,11779,211263,61354,18221,17869,46530,83061,108538,157981,90608,67199,95080,49064,195814,12302,66307,10348,231346,160732,112859,63633,146558,21271,31037,198802,47622,12862,95710,3910,77850,73961,85585,34752,61e3,4082,24595,103679,71107,8208,79568,150019,16615,24961,139857,32664,197366,4559,54735,32696,4126,162019,75698,13916,70108,159638,19834,9349,24675,175560,49643,18206,52459,27992,10809,88865,401975,133172,29e3,34558,30915,3658,25834,42430,36562,125265,18182,10155,40149,97082,208980,19575,60853,90529,66545,9600,789,46420,2317,88593,55595,98980,115302,5742,169155,1073,177901,3472,11189,63711,78643,65472,50459,127979,93,42202,67053,21720,157650,11145,141378,42033,22824,85705,79114,35584,15974,1510,54172,28562,12451,104226,19190,97151,73024,20948,5151,81741,21499,29006,84183,198074,54003,45120,170125,26240,35177,28389,64863,79974,60778,176915,232183,45342,2038,80253,41564,40703,32689,5430,100689,5366,23007,134279,14266,26712,73993,24934,64242,52113,102887,61801,46415,201049,54251,62133,122757,164883,30815,139966,2319,30842,766,13362,10287,134518,86111,81665,82440,28333,43019,18963,8804,161944,23439,102144,101145,80029,39052,248708,30350,117340,11878,128467,974,138625,63961,5237,74778,61834,67040,43814,13690,65947,33809,232476,115258,181745,28824,94013,9510,10246,93722,81976,7217,114383,3493,16014,69045,72692,12145,80981,9507,6692,1620,60820,330444,35474,33962,4797,7053,295463,46445,27026,12491,77988,49524,35675,90947,29114,166705,101385,133782,32704,6186,84595,176031,185623,45966,151302,63069,1699,107491,947,15458,74452,196212,6046,10498,12163,10239,35191,243951,9277,9090,29539,54460,22820,26514,112549,60372,51753,48756,21812,70861,260326,41,44222,10441,16961,48148,138771,216194,5914,52153,53400,212036,56519,26245,10117,45888,15294,138019,90913,26368,43842,42111,23348,6082,194845,161089,156206,51546,11647,30759,302912,262094,8635,78876,26535,35283,54183,31183,85484,147873,12989,5197,6356,72894,65347,20150,27370,73787,1493,45918,12366,190217,20724,13858,10981,67449,81213,7553,14115,72242,271517,11842,48310,88743,143726,22177,3290,243231,58452,62937,12592,1654,40066,33477,13751,9921,128442,15868,7106,75236,83773,10775,36938,10482,170465,17368,17469,161508,32752,98340,800,19824,264456,3901,87319,2867,26782,9630,113102,185815,24197,44584,86366,40224,3636,140916,31731,267731,9567,53678,72984,29389,27963,17106,50282,284911,60170,8322,12608,23374,89652,5268,39044,229766,8869,151350,31436,177342,12269,183212,120418,116270,2843,78888,69192,7865,184099,1086,129897,18383,70508,20242,18508,229924,124569,35749,50589,55626,9884,83115,40971,30671,18135,14452,38861,17844,201826,5549,26413,17189,13561,38539,10679,143331,3314,36785,171194,49685,187713,67506,4618,104039,17060,195080,50648,33159,19238,67559,134840,28599,157523,17130,38064,117398,94355,31918,13575,34538,40326,13997,3494,348283,62481,26862,3603,104426,244363,153709,112487,304612,199674,41239,35545,54869,293005,28223,26277,26899,4533,18518,15492,38587,80488,70485,160395,263,60162,11382,222152,4696,250751,51921,182609,10707,48463,46243,1227,49111,111564,46502,33342,56846,68541,63559,858,139927,16654,229375,76759,26478,33205,95828,23399,92945,2637,35630,28470,143992,50214,14174,21456,166191,65665,1711,21594,78019,97599,111701,36,147151,110246,189022,43021,30397,40757,131935,42065,73335,48039,26596,28984,15102,2361,7421,202167,69744,43766,52826,3642,83304,33873,75140,63169,192389,36551,92748,13039,123959,233220,21738,84447,77230,20228,187852,19095,25799,92136,108774,29237,53947,2299,118106,2687,8830,42331,202924,33667,2023,73763,30704,19363,19779,16737,35629,48081,24068,101013,162338,291912,13749,24745,328289,167679,70086,48299,23306,16732,17801,43322,54589,3586,63653,43624,53474,925,109177,251316,43805,13082,19511,86565,142182,92461,17117,101033,103319,64589,4022,4351,235897,5352,82705,107142,46391,156084,5860,61365,10558,13045,7717,18357,33922,12590,33065,6928,46993,783,46937,67846,8952,26295,6107,119656,18799,17458,50747,4229,179559,112727,118080,20683,41464,125468,51560,49749,44231,7359,35339,62988,136487,67015,5208,29150,24956,105186,48858,6143,18097,6972,16404,73489,58742,97196,36357,164616,5834,32267,13746,147733,15113,132091,34127,106298,39729,106426,22294,9780,15602,36213,71502,42808,66802,599,60755,5851,39120,67363,108623,126368,72770,91263,32486,30596,151717,7951,52002,43103,11768,68942,40901,39344,24037,127500,116890,48403,16926,86750,17745,48648,159545,34460,58419,5634,114317,67865,31462,23352,24010,98185,125708,69686,68337,13610,26271,70691,2980,4768,27225,102402,75453,28106,8104,6931,1176,6274,6475,112635,22498,6176,238686,26832,28893,90319,14441,15682,15087,39517,45270,109134,104440,45965,47645,81772,7876,52683,87720,12898,4505,185665,2769,113401,15664,57592,105229,137381,97059,119268,6876,43309,33886,128363,35476,144249,67013,143587,83367,25703,91436,59347,53236,2289,16519,19844,46309,58558,99834,23313,218816,231303,36388,51333,183535,109792,139277,54306,90139,18235,8275,32710,37677,82464,86025,92204,88842,117723,37570,128723,234242,76350,73795,34896,148247,58424,11105,11744,45746,63372,17118,49772,199520,81902,38004,22911,33752,3125,1995,53792,4689,26909,108150,146062,69674,41811,161444,84855,8999,28561,16731,93937,3189,21967,24890,22943,1356,145300,51569,28802,517,118679,31703,40607,48098,108854,25003,10233,73969,177495,5248,24516,215347,146192,48712,60626,69188,40735,5866,586,101541,6509,47590,52129,5969,222045,110933,25733,24223,65339,62812,2414,155418,35819,16022,78423,43138,20995,128255,240673,46745,236093,72176,57085,97841,61248,107,36068,193177,105427,55726,215229,20446,47228,100420,87091,14429,121708,23605,21157,187721,21880,2997,203976,99166,95068,25877,7724,98925,83401,4829,13182,18229,13718,239662,38653,116505,153497,30589,89029,38962,181302,43853,78872,180301,4786,248240,7401,106136,112590,77745,19731,60880,77789,125748,135487,5975,48627,34084,12419,215770,47557,254582,10364,106495,21856,67539,88981,38805,21428,48732,42316,12149,16078,52808,25327,51322,33850,51147,12253,122354,46077,56483,254553,115417,81834,150991,94662,86668,7381,12841,100650,18218,15741,22372,68294,50705,15535,84660,61887,22553,72299,31361,24824,17743,46820,64288,31582,77006,111674,116384,30760,80920,86149,77192,51979,79691,60342,122805,103800,240873,160744,233114,78962,54920,8608,3484,316104,72548,24337,5088,230040,21926,10172,36838,26,86221,83458,102176,12062,17571,41929,41170,28428,68239,41750,103930,2634,18313,53019,34825,97837,63115,24606,73157,152474,14715,91439,37033,109806,140259,30668,174760,380,135597,95673,136073,65073,134249,13829,17279,122305,4420,46444,10237,64848,203623,70728,10349,182885,65075,24519,25783,40318,34139,22222,63394,55266,102764,41422,20126,65100,90408,53640,35128,48932,11192,38935,96839,34782,39492,19396,41332,6250,5511,19492,51304,25936,104466,54099,73771,86115,5080,7669,30891,111700,13931,25276,72289,135447,14820,258641,25265,31005,281179,75286,393,95359,14623,13584,6680,101227,80173,44933,76666,54542,13244,39348,458,25379,109451,134348,81143,6959,65554,12027,51311,8716,57589,140731,28467,23316,17272,30458,25980,55229,77197,83798,28302,114784,7428,34548,26241,14712,39336,103304,18928,54080,12870,334,87722,15208,16895,142098,114262,39820,83913,57817,28682,7721,14900,108672,11250,62246,42849,415188,1724,26555,24549,25505,26443,107450,145899,61035,43528,6901,60726,65906,267741,21338,147590,42079,18924,73017,135236,15393,5206,4026,84185,1531,5988,113890,82647,303391,7386,69844,71611,189865,76523,31877,13315,19314,198575,32821,1928,67641,25913,104475,103489,3297,70391,18406,15446,113347,19295,93790,27856,1792,167471,116449,8541,4408,41757,63233,25765,86680,64501,27034,24816,34975,6079,4486,49693,36229,16917,21581,62426,27862,11612,54284,35702,194034,355,24277,48262,87411,70504,310164,118018,12516,47559,43502,57433,107139,9290,66533,80863,14634,34312,91725,28606,21342,67241,72355,43244,375789,37402,174015,105070,8342,44167,67494,1890,16365,11723,271002,1865,47918,8350,45564,27742,25110,125803,8553,49504,81925,62211,4534,15491,19011,80373,206920,667,102405,128623,245524,5553,113309,192739,65766,19567,22832,261958,29679,21293,71134,20962,105123,24721,860,21752,33448,18372,157167,94822,35770,173224,232737,75729,28937,46828,28062,25453,5207,140366,36665,30652,6169,67920,150458,92040,23186,184604,92330,20891,176492,49427,27828,38305,42495,143982,49560,25503,90043,29747,65328,47830,12932,11068,77721,9003,25213,94205,140426,46090,89945,138173,192691,33329,112232,129905,35709,27514,1841,19957,31411,127476,53572,17497,173549,55063,175135,19841,69314,5192,237921,117660,150697,4060,273045,50414,98940,65348,153665,164423,58804,156695,48994,213928,86036,28608,8355,39574,34540,16927,135680,18374,151587,10830,53805,16878,16623,4282,48030,8537,14986,46102,13062,72897,72,33050,108227,39451,45935,651,113320,40535,95176,57450,48843,5003,19019,10407,211163,3848,1068,4988,32091,30095,41692,15099,43602,107434,50744,7627,171349,16313,150832,352665,207750,33937,38256,51091,156e3,87889,90663,84175,24908,114900,50365,31494,83829,5398,169342,47521,54818,18935,8356,43094,41212,174536,10082,92550,6678,60614,23355,69721,14796,34149,128830,58187,3179,208,40325,28399,225029,401412,51150,31580,207268,6657,10993,69818,64282,289845,23308,12961,38447,6681,52944,31855,2572,47646,120728,179148,37240,45196,218274,4816,3695,21961,50084,35209,18073,51452,27004,6100,33941,1377,84831,171214,85,141510,9078,99227,32610,6417,11718,49868,65579,87902,73018,49062,46280,61742,21512,40862,107733,15941,29168,157765,144919,14487,5767,158014,140070,7241,573,71584,16921,223566,40331,179473,35081,47926,140885,41508,52104,59180,42310,32811,29048,123517,102413,80208,10104,14746,12649,153641,126022,37965,113017,4171,83,142592,2809,6362,50416,71323,116894,260776,16204,1524,5760,30351,12658,20703,54403,36083,45408,74772,4946,14485,50759,111222,10890,2195,167147,92962,130534,16283,177256,35016,15472,210156,151187,73922,117691,43250,52051,37392,24811,24358,30830,5775,818,21969,1476,127322,151783,58392,31021,106913,65215,89407,90802,28531,11690,20234,95249,44602,37256,18707,11928,5161,4410,26571,51903,49768,22008,25252,65780,209499,68769,203726,13249,137363,48845,86823,6658,5674,31881,1083,1823,108676,34518,166752,13791,14287,91576,91429,8665,11529,26401,16191,91972,30964,5254,28486,54697,79613,66520,18447,22870,45203,194466,22822,51703,12278,76716,44595,73455,33546,12235,144843,36154,51247,11116,33040,3180,225753,60864,1972,28469,12891,28879,10338,144157,56294,353058,38302,41447,87532,110616,27065,168438,6557,1213,50804,144643,24817,2390,136531,38174,247513,16190,4059,122791,131994,137430,39506,57650,16305,5188,54309,106128,20628,88071,67394,395446,250285,66176,91254,1399,114196,43915,60230,44853,27206,106353,43013,18733,345105,226453,51202,16607,57106,117175,35492,10476,89598,127439,15187,39624,13688,61570,10615,31111,59370,6238,175252,32143,224492,41388,95408,34384,148238,78307,38959,9340,160091,61443,15737,11216,41244,170,38299,102443,113097,26382,14027,33707,3957,76300,66160,19431,18900,6952,1717,108656,82206,188021,257335,27295,43999,41210,31777,46956,57457,12657,11489,15697,48060,204748,53583,82422,284790,30503,137341,8120,19615,220311,15991,10217,63424,9808,67431,70976,98221,4491,15177,28535,144789,751,13230,2394,1504,33977,132104,30316,22230,931,97193,185240,24826,22687,174322,15307,22988,1390,188745,180325,29580,59068,74903,18994,29195,79,15436,7622,38462,11566,138710,44828,45774,37768,99236,68137,84083,19282,22698,17134,74807,126662,173497,46248,16938,119735,3212,28292,213652,49013,9975,32180,45660,86250,4801,68788,95490,77482,113751,11994,44624,94452,46839,128497,100316,5798,58588,73184,202987,65417,37790,88524,1606,43156,97964,105717,34947,11203,100060,37742,130074,93653,107799,94311,196106,41347,8035,10780,16390,27883,118236,167395,1979,25006,19375,31628,18916,144723,78502,114047,103107,86492,107686,5844,20934,206963,23556,22591,16562,146333,20167,10471,117434,33085,2863,9740,36669,41849,37271,22790,18209,28979,8231,12952,54408,21731,25130,45208,55748,138120,75826,414,29593,9925,292865,25999,683,123149,7036,92159,86055,61827,103680,23176,54918,58466,57578,13305,5709,86479,16697,31064,17660,200919,10770,49793,33423,32370,52047,16488,62555,6459,8426,83493,7763,59725,82812,18628,67760,79405,68557,9612,7673,28102,56517,69620,171797,32458,29541,15870,81109,32080,207644,71495,21202,11039,91036,61230,2810,130800,32260,4613,60590,37112,75214,33979,126402,155062,30642,63875,12810,194463,82799,47664,16725,36685,43367,61099,449,172150,102867,21691,301838,36745,7130,18671,57316,34852,38034,54182,35578,65900,99486,19771,3456,2658,16914,99866,28390,28109,8262,21147,34353,20006,4228,137085,1675,203023,283196,198286,214375,163329,290603,152574,40471,83506,30068,14730,23177,131539,34759,27668,32178,71896,104799,116305,85430,119262,42860,25160,8911,23428,49437,105322,6519,16203,6349,74711,1230,38045,8540,75165,44736,25909,51026,317034,4984,32281,91312,27060,44431,17817,45363,155937,239085,35697,59784,91993,29531,126740,213757,76560,167776,285273,24262,8237,65030,41160,74437,48804,118916,13159,37842,1031,75349,1478,11655,108777,23435,277425,101734,67469,70231,124711,43532,28514,65526,54956,1e3,21882,17728,25302,40952,52214,149632,1999,2111,3259,63362,89961,220561,39777,26335,9063,10572,12416,34551,34623,38604,24723,5947,15588,69927,66252,119177,69173,46629,28714,70715,212408,20521,406913,74380,11716,50659,50862,37009,88460,130101,7210,53853,538,65120,151950,55806,163748,52837,13153,21100,16674,64536,6091,138201,44837,58547,3723,163,2177,32288,85454,34033,8497,14282,25742,10535,10741,79559,117493,243787,49337,100718,79495,40139,42956,7551,55433,15421,31509,23034,45081,547,61176,53434,328001,8470,36263,30145,4519,74173,53935,11845,73774,60211,78025,3,4102,73782,109293,315332,48412,26683,13714,6865,20128,18490,104141,325,39470,171970,115860,15707,7268,73301,74336,31370,2368,111827,107757,136231,142844,97138,96638,84053,38691,23801,1588,10573,122098,77039,240,186135,146101,11996,18143,112963,46171,155836,348769,47795,121213,116266,132515,3344,144804,31286,99187,255838,129694,35894,48779,55235,148582,71967,65282,15174,13920,47080,6147,108242,157593,125025,7136,1286,28957,127956,28402,98813,20805,7532,109417,40610,5041,32958,15142,18408,108596,33543,50517,27748,80114,233434,91447,487,37094,100048,30541,43477,10639,89862,155868,37667,8726,60684,237903,73408,99589,12190,38739,97348,3914,13594,2680,149016,13907,30171,28343,23530,115225,61104,35821,147679,14337,4297,244282,24085,326976,56428,7851,21303,131620,71446,83253,68692,111870,5224,15813,38197,49026,45057,13660,3306,76345,40671,27905,91072,996,68527,62085,91351,122634,55109,168209,2024,27560,112707,17352,8306,167115,169921,166958,5031,46020,11844,67284,19130,76185,6920,32849,5450,14610,22451,21002,17392,31872,66682,84796,13709,40210,59898,12029,8719,53564,21462,91884,21647,88379,194428,12754,37797,132826,160016,22567,54383,53186,77611,31107,8339,4694,19185,90355,23597,17222,140675,28442,23668,55977,9128,61555,28774,155229,17658,9390,24379,69357,15752,127381,239631,62460,93181,55913,45133,140155,18676,25249,33164,29581,82837,67223,22362,29975,7317,52813,1943,29613,20012,207130,49617,49651,5636,15334,36313,29226,28084,95247,72072,19e3,224932,15811,114,32127,38097,37508,88507,37225,27359,91626,12193,69279,20608,11055,88156,92808,2152,57259,55275,72789,24475,104414,1708,9882,3818,48661,66897,1631,34806,227930,85815,87753,18321,250664,72733,25107,206797,50891,8082,196411,92596,96764,152823,65514,22819,387277,62176,51225,40329,15563,189,3659,73670,64357,51793,275136,33482,86653,74615,67058,11318,125720,15388,22388,8267,1730,102663,170910,40784,7144,85373,13040,7088,94309,583,44224,140424,77439,18496,164026,36578,4722,9151,5824,63365,26510,35199,40500,79277,32495,44614,35233,9566,203293,152144,7097,2330,183480,98629,13423,330887,44130,68600,30939,97829,31012,345465,56747,94879,4939,160027,149761,99423,46099,32251,15332,8761,96094,128555,5763,235318,222223,55729,30241,55420,201746,3987,81382,8259,49325,23287,7719,24633,251100,92311,18591,110533,64759,170260,393860,7175,21144,132887,3593,75346,101277,91109,16387,259187,11627,57459,173829,44694,55780,49797,89192,120443,62622,3904,14814,23887,1027,112258,64955,99800,11132,66353,36202,48624,18158,88481,96882,43059,11040,2455,7077,21651,181159,99126,100434,61388,68186,19161,110468,120052,8819,55324,41494,7014,37689,3618,87729,92615,207943,9823,128657,12587,15857,6379,67628,51216,71775,157617,63244,1503,3864,218754,110864,5769,21492,7243,1192,87921,85529,31512,18537,42698,35350,73510,84474,34301,8991,21013,35034,566,38832,19838,35586,37216,39413,55006,12178,59742,856,84563,6900,25632,17437,49786,30723,13847,70845,4044,7843,23944,235976,55530,48942,6518,20939,73769,192653,52936,95207,23895,132542,142982,22632,87452,48042,54018,178468,10728,26230,23559,363,81269,142012,5718,346258,31456,84333,246476,51018,66692,101804,120570,39962,30373,70593,2864,60541,19425,54209,104092,7201,31545,48018,25865,15442,46257,40443,8328,6451,111782,47527,97754,33046,470,245116,31095,39,91934,87208,73470,36708,36521,12801,70624,36272,8892,79768,12427,55454,103756,5908,52390,62962,22720,141138,94634,41689,128402,126390,6628,106394,35527,134394,82727,254651,194502,148064,89549,3202,28359,957,21954,27906,49840,142747,8307,24206,48978,1186,71728,133038,71474,91306,6333,110959,74600,70387,18983,62609,56057,22970,1147,135850,1321,28834,3578,59715,102227,32827,81415,99952,55636,257598,390,22702,35701,85872,402916,39216,189795,14929,19467,10112,144422,61514,5279,63421,134686,41436,8424,51925,10598,132295,124416,4604,194739,210929,57866,31829,51626,50007,9976,91878,61906,56168,81906,60918,61859,40017,23059,16887,40927,62064,12785,32893,32913,21782,93965,20169,44387,79084,38463,11457,93950,27127,157050,2697,337088,5116,54128,48255,33279,8821,27352,25515,124022,65710,28906,38557,33390,1722,104435,72215,38551,12094,30978,25113,6671,37355,175109,42862,98024,65406,221276,59624,118012,64637,78760,86697,21426,1639,40350,12584,67193,84144,31396,7863,143011,69629,63112,9454,28666,65798,46372,134721,6314,51402,30837,151922,2847,38676,38008,92823,136245,17540,5504,109295,205242,37606,5211,214892,1586,20670,208711,137743,19328,40652,16995,20023,14657,154919,34422,12996,13918,38221,47690,16398,2959,37680,89122,6721,198469,91876,172043,83898,101992,26084,94570,3635,76958,22853,76497,38266,176590,168403,44464,142840,79180,184594,1984,41806,83147,11985,6546,366068,59732,24533,271505,8736,39084,222992,93429,28962,58985,86665,8432,30028,14548,32439,54424,165029,55175,27458,69046,121277,46168,33732,20661,24581,135574,123110,37556,79260,72611,16957,12939,46162,58238,44907,72936,253758,41324,32518,96480,11949,124438,65280,43256,34107,53533,43531,37037,28366,45970,32741,173438,6121,194202,62969,26355,30314,58370,28455,1848,50519,82830,90393,21761,295490,10936,256940,133568,44050,20269,4089,27457,21610,219460,36743,14821,101388,52005,13124,30979,140816,167362,26054,18458,60789,34917,40447,26606,33422,9066,3452,83614,5761,20263,137238,25038,91310,101,52322,74548,42572,38084,214054,186568,31802,17665,30620,141936,37730,14420,4265,187218,49640,188208,51441,55388,96452,66659,40869,42039,60967,221027,19234,178581,29105,96050,9165,196118,157335,3738,40354,117436,2965,34136,59659,15570,50843,230035,31444,71260,43886,18316,5387,38500,168508,17406,32174,8828,103373,143806,90367,3560,18719,122310,16508,26719,2541,105429,6645,37998,73190,10591,235916,49737,87112,233941,53188,32193,79154,4544,52905,126477,7580,63501,57314,3216,31337,6541,103083,60846,49,9756,15481,1355,43840,14319,13743,27486,10222,73114,230718,418644,16706,6674,279748,23058,45273,295831,86306,2743,5535,88773,21829,35253,120938,31153,3169,16839,42847,8751,80974,33942,36867,35514,16485,26474,77775,56877,5391,48346,3882,108713,31403,27804,55248,26235,43821,136104,40118,175507,28034,203908,18732,1788,34030,106427,36958,54359,7251,44936,15356,69139,455,157915,22173,140291,50348,43275,82066,49621,54952,15216,36226,96695,66855,6936,1987,8227,196087,4631,68827,99004,47541,110265,17953,147605,110242,58520,31312,38724,329975,642,3155,34497,75937,6207,73843,6120,17249,51429,117746,3218,910,68961,319671,14938,29555,34700,1649,66673,72268,9655,76800,153087,6941,210168,27130,35398,1780,73242,3135,56689,19556,165307,8765,35967,121458,13333,70453,17350,117253,22265,13340,44265,39869,441,3742,135025,23581,33309,16543,17731,13291,157637,283005,21408,101360,63887,52312,83873,5338,233779,23759,186949,34531,177320,38069,156465,91004,19353,59852,68160,14891,1338,1072,29823,1950,28901,81407,313445,73038,84807,162348,240257,37162,138934,16111,58013,41253,102951,16457,96056,19541,56402,67217,41638,94381,89674,29481,37456,80815,151579,13937,13683,132537,19699,134545,67020,29816,222341,141235,427578,48868,129557,233342,23077,87871,16213,18728,16184,9469,37913,19680,2798,171356,178328,13216,50049,72690,71904,124644,55455,7504,29052,41036,266546,19899,30391,188755,8659,59469,16,104298,112943,53865,76203,138226,68857,139953,14125,107625,119795,173133,4398,50273,48808,54390,16466,122086,31835,67035,50971,48859,7508,46427,66477,73021,84615,39985,83076,46779,201569,53336,36443,60865,168164,143810,51393,25548,169307,32896,24485,38424,21837,29087,275813,51674,6714,64883,46169,187369,55186,76192,12852,12018,62134,31067,118303,16542,12125,10579,4928,26291,43854,7091,10946,253716,109062,39283,17261,113012,258512,47764,125126,32646,55892,80279,201623,149872,3192,385,1208,48750,5376,58738,22335,5427,82416,47811,32435,143086,38930,94128,59975,156037,37977,38224,62485,7698,50405,71027,16462,21559,136153,34131,107506,162069,63703,3101,215029,40407,4178,3774,9187,80019,17880,97926,67579,2600,18405,8351,47924,86638,70820,92206,86453,29610,42241,119200,3198,15466,67813,57863,35454,4779,99518,4649,104641,144269,33730,38073,65864,6838,109456,193298,154007,5623,45741,30846,182578,25573,157224,1543,58575,138703,146140,44971,49356,18275,59064,20300,13122,11848,24453,11973,9797,86843,2919,25530,49210,1130,161220,76788,75373,85604,34926,36014,17777,17255,51533,11676,92226,51845,119859,21525,5936,18507,28050,1140,31418,14857,34207,47859,10750,36382,32079,106909,59426,87757,38393,110042,15965,97104,33757,35344,97993,53979,33651,45407,41884,82515,173089,7177,58371,35365,47543,51927,35587,10670,23544,29306,84233,39976,76076,62097,9007,8668,28119,78281,120790,19835,143020,54968,18670,64959,20649,34469,42570,33001,136570,87796,120044,1106,58700,63951,127623,12805,83057,40212,31773,49850,7361,54336,347524,101314,23751,19569,48791,29174,49369,20467,7465,75842,38281,623,112457,60210,28849,51003,94720,6426,90047,85560,43761,3579,85105,34607,90410,118528,7224,42907,111163,18168,6960,161135,191298,5247,100584,127552,171568,20121,91173,12636,54615,20199,63730,98105,2396,40387,14438,125012,4765,33235,12865,45299,37728,82098,77872,114037,59253,19675,24838,398016,102561,11446,17069,57508,178277,65836,99941,26114,2585,271882,136866,50126,11027,155648,118367,14585,8910,123015,335383,40434,41016,53021,14439,87098,176860,201543,121888,2358,9286,5739,22666,54270,37884,169381,33984,93859,16124,89364,72207,51639,76366,99029,65812,2198,12147,174891,194289,6986,30252,88822,21284,11445,288337,160821,33034,100869,43852,25761,52882,1144,103809,1924,84458,86079,43411,13542,139276,18141,34978,41298,7276,26481,173800,33210,17951,142652,33616,33677,2210,19941,98568,2486,192414,80136,12058,235883,50963,249638,29572,27221,47034,6124,72107,63346,97620,158513,299699,40388,23235,37176,224244,198386,121323,67992,23827,63170,17838,106622,158590,26807,5345,23489,91891,55474,74834,37981,13058,5977,72552,34706,26828,145172,19904,21367,34043,960,77092,91381,4733,47446,7680,41697,5170,16960,14741,46101,13656,473,51842,37433,11103,11551,121951,13191,97536,165932,50397,51628,129028,9069,44885,6590,59195,47045,32940,225472,90345,21833,13303,29407,96615,141951,5198,6028,18395,7181,3861,14966,156358,167182,36529,55253,25942,173153,30959,27261,50691,150176,162201,38467,48462,80602,42163,118482,168,108756,26011,17166,54149,456538,22512,91374,13816,90358,131615,18132,226707,1824,28139,26860,42253,93877,77351,65575,8980,80574,22020,27948,40422,91324,76376,13528,39281,91685,82215,122541,144066,1983,193851,17283,26320,2739,194978,4790,26845,42627,61300,65815,174612,55133,4200,191130,79771,158321,52280,166796,221620,62461,11278,4067,88152,83409,31717,121367,13522,47325,37945,10406,174348,249321,154101,64912,29938,51775,17220,15776,166138,78890,84425,54121,42861,16368,24572,291647,10197,32073,22651,11677,97509,26952,35787,18424,41910,71614,94977,72318,41594,70024,275419,37702,60199,7335,39107,61315,18271,18394,33768,87884,104277,123724,7277,56288,71981,189803,49320,3352,6798,14240,8954,69220,94433,57372,28620,68863,193727,85575,42309,41667,67689,42081,22543,44824,12719,28540,114236,101553,27638,27296,4300,5353,4663,19379,94098,3758,95888,95144,80344,87320,28447,259518,12718,71391,152731,37063,24132,31911,104896,15672,103782,1521,4945,72541,23717,122632,15619,87175,206120,29428,189780,61416,28350,44457,972,1175,47233,198738,95789,41907,21953,97034,59341,22864,53713,16873,32971,20693,20954,31336,21477,16169,38370,16412,9019,3841,24599,21938,17085,6484,81198,76413,5849,72514,12320,65247,276175,37234,59796,52642,16312,57349,198507,94148,46134,18958,125552,1747,18725,151873,14901,5490,68287,29470,3689,64794,40814,26018,25692,54450,2703,88278,124886,173087,174e3,24159,179477,24276,46004,201876,209202,445,52876,31948,30206,157610,39180,18439,44124,50469,5774,96278,222758,200216,50290,45486,20435,46986,46276,140133,142326,15569,13363,47522,92583,2182,7135,16853,22998,30272,4952,63263,35623,39096,53789,44864,20053,110392,124213,4630,16087,28221,127787,25839,77481,44693,13464,113146,6983,27069,55717,50102,4760,7107,26186,66507,59145,36032,104182,71328,29425,64317,50781,47465,94298,69706,74899,22754,120756,25108,93077,56834,73286,39928,16218,41699,176763,7555,70819,50083,26895,23315,26014,16773,123079,41712,5719,31516,90427,158540,85051,183128,40864,27505,55392,9058,45224,96857,30901,136622,96557,56304,120061,11501,151448,5773,89743,7769,86069,2935,18471,41628,10114,33660,110170,49479,26745,92846,33221,26731,18795,87076,8550,2100,29972,120289,3077,72490,33784,2630,208722,50861,63483,79029,6419,39467,14302,45286,64207,9686,67513,44170,1050,77246,59266,17055,53801,7150,11111,42432,4278,94579,362117,36175,42902,41933,39002,98489,22913,74161,84773,57036,17556,162288,74485,178760,93867,73635,128860,50362,261,67455,80001,46080,35662,4368,25247,19230,74393,22588,1822,27682,235324,13798,85998,13194,235067,23514,71669,147632,23191,134748,214683,105101,1518,25489,247114,7380,54842,26922,3971,26361,20844,68642,170517,77339,123255,8963,77818,150998,48466,36806,2732,23261,11741,236162,18243,126216,28690,50546,16385,92760,197383,246558,201295,88255,67588,71687,176076,172653,169058,33906,63747,24835,157621,43338,30050,46152,132741,2770,51371,94835,6614,15112,11749,56936,1250,19027,399017,58036,100215,23388,55815,308768,124152,94803,9521,64186,8971,28,30427,62163,7616,103838,35079,29203,131235,7743,17389,10882,37420,61460,228512,85363,41581,131077,62822,119647,10130,54445,26925,19968,29016,24446,74028,24176,61448,67185,9254,8563,119129,9771,99184,37716,39514,10532,221512,258753,218630,55980,23394,32141,61924,66749,32411,3741,36475,26678,77010,44946,91203,128749,116953,20476,49625,53116,13735,102335,29376,51946,83407,67892,59212,34685,21083,1546,112982,32972,74397,1078,190545,16082,86140,58591,89611,101531,10061,105104,76319,20035,17551,52611,169061,190842,100780,23907,90413,115619,9675,34710,193435,49443,129734,11183,258877,16318,136182,126808,44635,27304,192375,2599,125648,47051,12091,23814,721,58800,40137,66726,97930,60877,74487,7942,54326,9841,41428,13762,8211,85383,6950,99177,79806,201786,296464,124087,13144,29741,41721,47634,55088,254286,106408,17041,99064,12942,64086,45233,14005,2612,55827,255,7984,13980,38574,12776,46654,73499,249951,2101,26676,25996,132326,116415,119062,50449,31033,23038,11589,179252,20007,14860,129270,21143,17796,144715,60106,70758,69842,34674,282133,44014,16774,57268,38528,24053,46373,201667,28327,471023,51889,102667,21193,114909,84132,69317,96723,67969,16134,68145,15058,28765,32035,2524,101089,98664,25045,76571,14957,86040,118506,262428,154764,81573,39681,283900,73287,127825,544,80448,52347,38512,175971,15180,45467,33086,46552,48894,81107,43213,36672,54025,76703,8053,7608,13299,56619,20752,238099,54164,105133,1444,32942,953,37564,8e3,66316,119463,106817,404,13667,149108,128597,31267,10269,49836,106150,1484,52330,76965,160486,171648,38456,31263,22424,37738,66245,67467,143369,60471,75610,20895,115528,86070,60854,40796,49347,18989,15030,11371,37578,15779,79867,10187,86462,46402,155626,93200,40229,7090,57547,108053,99598,11088,47505,41218,206017,2173,20988,30219,22919,80563,57566,42369,93141,41675,2407,182519,120495,27154,16702,29456,14349,7958,16688,117177,140375,42467,261919,74916,153569,10836,34742,49526,7621,105997,12212,2270,392377,7755,17959,25086,232152,138791,33847,13860,35316,5811,1344,71259,50452,207539,92635,50359,5821,33674,30255,2086,2587,96264,17543,42,6029,9580,43007,139248,82831,12917,29607,25786,51467,42137,85161,100698,31561,88989,121990,278500,3602,109344,37982,15279,116442,28936,30880,87894,58079,128661,126731,67392,28051,146885,4861,16216,97344,42827,147561,153948,22684,21335,47685,1853,43349,15185,59642,10229,25520,187921,108972,5579,98037,24945,6697,19193,63734,137934,75056,89740,19767,224268,56138,63643,151661,39313,70618,84031,89723,84074,13703,85626,35460,8867,64845,3439,57906,99776,63968,49270,81130,34356,16210,23547,36446,34090,140028,72439,2221,22163,57058,363492,113754,18913,95451,48663,54464,54037,176097,68425,3023,34906,29482,117389,341780,80431,58330,16753,92616,60907,94846,147486,4498,48646,7773,46801,7778,18946,464978,47558,33223,177444,7328,15626,63337,94700,11743,9351,255024,39098,16447,42647,96230,39769,58840,10068,63439,35800,65843,58823,413844,9156,51258,7434,61791,85018,6872,3692,28096,7121,33024,6009,75532,31997,192535,9661,3304,9547,14753,31987,25314,55689,15896,20430,39472,31340,99744,25398,115569,54883,28719,205423,23071,57855,64638,149867,25671,82403,37616,20668,39989,77996,74948,140555,175248,64810,36515,46595,4958,248773,24045,28728,136673,168704,20804,114833,100325,27135,21205,96151,153134,45992,7093,13992,76047,1980,19432,145001,75159,87462,17710,1013,45556,34297,144882,20648,26061,11319,129567,108555,18872,464580,33386,22717,65948,167189,5603,135042,79542,8801,202632,18114,91882,5973,5239,67315,4431,60916,47819,71693,32597,32606,18183,45072,80329,76385,24749,51305,40314,156514,14693,130345,13168,66214,18029,12858,34801,27628,14544,10823,40522,40185,33739,148694,23548,9923,61012,28859,17933,19442,34364,99849,164107,141167,30629,21054,6744,36491,8096,42474,41706,155060,30650,10600,163442,1143,96655,61390,52359,7559,51568,64256,203854,4467,22453,14504,436398,7878,6980,8293,63610,293747,16167,35763,19627,147603,15419,18032,110744,51346,33681,54571,40472,48615,39073,21604,13754,173027,92560,11083,47299,63062,11813,52007,29883,9734,139722,15953,1550,20651,13616,49306,16113,90089,92326,7584,30712,72424,164858,6831,152871,55746,197721,34167,196442,6022,112107,55215,7538,123381,4920,43539,77165,8939,50392,34192,20225,79762,22505,58667,40770,29788,97180,82835,4568,8579,13273,363569,35898,49983,436,36598,3237,131691,62418,35591,8101,4073,379438,65218,76072,33887,2968,27573,212619,288680,68278,72851,150504,217896,6913,121339,22017,35340,51072,43616,75043,31437,10833,81487,4364,22968,41454,106687,85446,19863,109625,149241,524,141850,214404,54376,657,237023,9401,108137,53800,32474,49712,53334,126876,27337,45552,177696,8269,15036,12097,42240,2328,125374,119295,99715,2500,19624,39441,27220,102691,60957,94543,39101,18566,67362,13975,78230,25017,34017,239007,90027,39351,41681,35354,43822,1043,916,58587,141983,94818,38799,75459,41114,67432,16195,36606,59568,22272,126769,31424,68659,12287,134302,257977,5756,207285,95637,47248,117689,19583,77451,22373,12200,54993,117118,34244,29386,34562,53819,71267,64172,77665,49368,7716,59301,25749,45426,194789,17297,2650,1766,32501,45198,20403,20984,6600,14171,94604,19037,5402,29896,9938,59935,109708,88081,145182,44844,39167,352626,164173,35374,45982,6122,154,73419,220487,53834,53601,17992,8609,229321,5610,68098,66815,71012,95069,140968,27396,8957,134489,24656,86659,56598,134852,17316,123838,255436,6613,41610,138033,81452,32023,32396,123687,63398,8693,29712,30407,19296,121188,3551,36099,20032,111948,56624,16547,27453,35916,15378,52039,56849,13489,22214,73177,53097,277349,2157,14029,187886,10260,141743,246460,91880,50869,3788,49486,133566,54950,33120,129337,53768,18333,9525,26902,312251,10297,9020,70759,16647,112432,59260,84609,9818,82766,73569,468,46001,75780,55028,52106,11498,43645,108069,17150,17753,29417,16705,31799,9606,289,122254,115975,8620,6133,255357,56908,14456,133464,43554,79224,11247,29630,160,12756,25464,65960,350428,62521,321796,100359,67358,35169,46172,113128,48988,88868,31094,33266,6847,60887,98188,49659,69117,92977,220228,13947,80181,35103,62170,97351,13475,2440,199768,19498,36597,46971,25234,67806,62881,84717,73648,181966,10488,94149,21550,26655,63436,48375,14405,165650,9621,24439,28043,42735,4490,29963,56674,45373,1934,262446,50855,67098,26898,5261,52696,40644,33900,9440,180286,87162,22940,19704,26936,69769,10254,101759,27406,12243,48e3,73926,113215,54935,5726,192787,4312,106216,9366,11550,52949,23457,212271,277152,133895,108374,6191,96477,29980,218916,58024,54696,40853,91124,65894,91170,65908,252552,6793,29212,15389,44516,122515,52617,35058,9017,103536,39510,49136,19242,130652,662077,74699,47024,31422,8517,73351,24399,13867,128360,4810,4434,61779,111983,61036,17798,110240,59722,102960,39688,10001,23803,23039,176498,56659,44814,134295,17188,77577,74466,226175,102472,154333,63900,111747,18062,41171,79669,32773,408933,42562,28931,30907,107388,43487,2946,240310,23938,24354,319,184983,7927,6488,1422,10790,68809,68209,64775,4361,202,17123,59634,51200,44391,18188,17843,2619,74278,3230,9540,47187,21702,36274,56894,43907,16310,34790,16866,6150,5561,13587,107545,108873,126867,86986,28640,33427,19017,5762,80637,17430,46903,2047,131055,25958,13558,5444,47152,13900,44563,122857,45348,70863,39593,54332,38068,33637,318,40310,143467,18502,24520,11377,62013,28942,27246,28269,83545,17999,59015,90707,30065,15161,34720,1263,37008,2012,6060,98575,92933,5721,299,199555,24578,29223,2985,743,115825,109523,136657,47454,26378,53586,3733,174945,93340,244456,5693,37386,28782,89767,27545,23573,18798,136425,34320,84778,20041,48453,38215,7477,71958,40621,8773,5874,187927,105965,51100,43533,18083,8443,10180,43597,2003,183999,69689,12216,129696,146188,62389,34044,68410,12765,43273,26949,266807,3345,34477,79197,5688,47539,213110,21634,22257,50092,32222,42346,39530,63668,98,134978,74022,5152,59088,174145,37220,9934,9545,118937,5724,87240,19875,15784,40143,23263,87513,181654,285152,37881,263241,4966,43934,10433,186657,6470,74416,225854,25908,142677,246262,32280,6192,75890,45546,143264,135305,29742,47013,77787,11732,126658,8763,37950,21806,57557,113464,89465,108995,164574,23894,22996,23169,15369,23117,17642,130607,40503,36239,280990,44666,9981,40427,147487,26869,168452,32886,32991,46798,240839,15111,70502,65697,88548,44145,28701,48767,31139,206777,35659,181164,166262,14554,171445,31786,66523,76607,17956,6507,31279,90476,116611,167918,6560,1243,115324,80128,41867,55897,187323,37069,32596,189444,145931,13390,105530,65709,26805,6999,55714,41300,22915,68951,22138,21120,22264,10058,19945,33635,56123,99085,10032,5818,6016,46649,57476,35264,94413,112522,262288,93686,83038,14341,23204,28807,66084,77987,6101,126673,7133,38126,5923,122091,170240,97772,46874,215746,43948,41622,3272,55596,8332,146411,251315,13533,8561,81521,115449,48616,175175,2063,186556,3036,134537,75772,29728,82360,22973,186559,86348,89100,38388,82297,45610,2613,87082,9986,177812,57884,23591,47485,42543,33582,44713,74439,257444,252451,31825,35631,38540,33066,5147,13973,4343,51830,70378,22827,26448,95560,36896,241741,48067,203953,298860,61620,20450,3220,67272,6586,107662,100160,108684,6929,57226,4762,7457,1320,40404,77204,99309,62750,208653,59977,44e3,74315,34332,5819,172217,64904,114077,18147,84012,1791,98456,90930,21446,116669,103938,7422,85140,59713,5768,326211,16239,75411,13229,29398,10758,236107,1539,112472,95979,152154,151294,306,21196,38146,10700,6891,84282,109646,56492,40539,6589,119491,51354,30685,140209,136906,29622,73617,49553,70525,51671,166869,139616,74395,37439,49595,45678,11959,33211,86560,52434,9282,62690,112155,130810,5243,108261,99970,265613,72551,80049,6391,33365,90721,66737,69872,87011,1860,9032,112544,60905,37371,89015,140351,19076,850,373531,2802,36725,218795,72062,28990,16550,24614,7815,6187,26336,33373,32162,42791,73555,32062,23386,10244,56392,49442,27076,136262,12412,14883,1134,33675,97153,199281,15608,100152,74072,47942,254301,36451,16026,10687,65067,56708,254030,30290,50490,13864,57941,259331,35588,23485,43486,24869,21620,92971,22072,88645,1048,182050,13343,32452,14825,19509,3325,216938,45740,99716,189082,53740,78245,25609,24311,176777,47340,308354,40669,66085,14102,125339,9225,128709,97207,1271,200933,78439,113451,88975,18324,46521,11819,18570,141756,72512,170020,52754,63550,118515,103073,93330,32736,50499,14722,31600,68452,398867,29316,172786,18417,104924,2606,5670,84818,16288,67106,59580,82929,607401,291,85829,359,15897,35830,50696,65630,52672,22115,356968,29895,40837,231192,34024,38957,26722,406,23335,124952,72068,68804,13268,147101,164740,276569,162596,66943,11569,26654,66358,4777,23229,102127,5848,978,2921,59666,5371,28212,90108,42938,39320,2499,4271,108792,33510,125072,71653,65239,38250,66357,38577,13964,86251,35708,50755,36010,29448,12209,3844,38222,206337,100876,67827,137088,14167,252225,84163,195270,1306,5703,54198,779,46802,22028,51124,86759,70560,113164,35685,162145,45471,34561,422,2611,6464,47486,19223,38246,9191,18331,89942,243642,212364,15893,17518,22617,6409,30046,126182,59716,36560,104428,18846,26592,19458,50793,147333,30826,1388,27647,10922,14495,33545,19269,135828,39727,41601,46931,233379,49169,131130,182112,16276,82381,118209,142445,128310,19672,28740,82907,33436,3118,102206,28723,24819,41937,38854,5157,3881,111491,1142,9776,421673,152241,29309,14961,87854,6054,15424,3796,82656,54996,2108,55367,239450,154525,9643,118103,106041,64601,68549,48707,30266,25772,18740,9462,229669,91798,112152,191327,14493,72828,8175,66636,236474,25817,87351,129027,76653,20422,22983,71240,27846,44661,12399,46158,77704,53101,35032,11072,17300,109294,33638,24408,1895,11241,760,17584,82479,125877,63150,141075,34259,23274,81698,15732,43577,48340,91584,14688,16379,24481,150280,96420,262050,48635,43727,61819,56268,72003,88178,17281,79912,13218,122519,125295,166396,11811,2171,118930,67746,17636,178278,174656,95661,173039,83845,79689,17473,98555,127696,203415,54730,22925,232239,9309,12136,175026,20740,180188,10747,39816,314017,266131,10040,175732,112550,220651,31974,37393,888,23008,86799,4303,64905,148467,75337,251,3284,370102,50264,9835,5438,23655,4481,29851,329,12855,7162,64931,78141,12804,42372,296771,83547,18624,34874,86271,3360,48665,77735,88767,11463,63527,28889,22258,29140,194315,113924,25499,6406,31334,1845,4802,49184,43455,35469,127594,92970,61038,115005,38840,87761,106838,8811,20572,55637,11162,96721,132425,108925,2948,125457,36356,3502,75270,27622,127192,2561,123095,49394,61155,16897,110064,9699,89448,53356,19628,220310,21622,83036,9885,112214,6087,26713,17901,161912,91492,3440,68594,9266,92238,8087,6866,150194,72175,80701,13459,31836,43243,239700,95846,44749,50647,21945,230538,120612,132371,244604,5193,105637,34661,41341,68775,85393,1874,8771,33718,49672,77403,595452,99507,6490,58895,128742,7704,39239,73217,43816,62824,37804,199976,22361,80005,87514,94832,14089,4574,139975,59142,75523,100268,43906,53442,15152,2547,186002,17011,19513,204282,3343,60568,128318,119250,4298,51871,41336,71759,21921,45074,98169,145889,99427,11350,1237,5520,28799,7803,53702,21026,136352,38293,128690,12158,90132,44600,10184,26957,39459,126025,78904,82999,59373,39301,150198,120529,153042,20177,50089,14764,271571,30530,123161,38975,101562,22941,5648,124654,109243,69817,71675,49162,106884,21241,107795,30258,16572,188262,141456,7688,60718,8271,11044,32440,104608,103419,236109,93156,43293,128929,42107,67180,25201,115254,185488,130954,72813,167547,20537,39969,38432,22582,184022,1139,27199,5655,17767,97412,122606,209377,27070,35871,326617,188954,42680,73512,80911,22629,3011,95021,315242,157737,383,41821,41808,19335,27950,15674,25677,110950,35375,76835,59108,57370,35262,16569,160415,37706,78086,32041,49691,137143,9782,172080,50148,77917,6323,10110,69172,17711,21795,59511,76184,135114,31046,132319,59105,157578,20549,80778,57649,158421,65143,4575,72235,21899,10797,92745,34035,106079,80159,4508,78304,25350,75457,46458,32937,25623,47,8531,104751,84953,8138,36508,187199,66310,115274,13253,32461,38536,1916,42007,187160,35055,26325,84394,35963,94216,45590,97782],nu=15;class wN{constructor(e,t){l(this,"log");l(this,"peerRouting");l(this,"routingTable");l(this,"refreshInterval");l(this,"refreshQueryTimeout");l(this,"commonPrefixLengthRefreshedAt");l(this,"refreshTimeoutId");const{peerRouting:r,routingTable:i,refreshInterval:s,refreshQueryTimeout:o,logPrefix:a}=t;this.log=e.logger.forComponent(`${a}:routing-table:refresh`),this.peerRouting=r,this.routingTable=i,this.refreshInterval=s??fD,this.refreshQueryTimeout=o??pD,this.commonPrefixLengthRefreshedAt=[],this.refreshTable=this.refreshTable.bind(this)}async afterStart(){this.log(`refreshing routing table every ${this.refreshInterval}ms`),this.refreshTable(!0)}async stop(){this.refreshTimeoutId!=null&&clearTimeout(this.refreshTimeoutId)}refreshTable(e=!1,t){this.log("refreshing routing table");const r=this._maxCommonPrefix(),i=this._getTrackedCommonPrefixLengthsForRefresh(r);this.log(`max common prefix length ${r}`),this.log(`tracked CPLs [ ${i.map(s=>s.toISOString()).join(", ")} ]`),Promise.all(i.map(async(s,o)=>{try{if(await this._refreshCommonPrefixLength(o,s,e,t),this._numPeersForCpl(r)===0){const a=Math.min(2*(o+1),i.length-1);for(let c=o+1;c<a+1;c++)try{await this._refreshCommonPrefixLength(c,s,e,t)}catch(u){this.log.error(u)}}}catch(a){this.log.error(a)}})).catch(s=>{this.log.error(s)}).then(()=>{this.refreshTimeoutId=setTimeout(this.refreshTable,this.refreshInterval),this.refreshTimeoutId.unref!=null&&this.refreshTimeoutId.unref()}).catch(s=>{this.log.error(s)})}async _refreshCommonPrefixLength(e,t,r,i){if(!r&&t.getTime()>Date.now()-this.refreshInterval){this.log("not running refresh for cpl %s as time since last refresh not above interval",e);return}const s=this._generateRandomPeerId(e);this.log("starting refreshing cpl %s with key %p (routing table size was %s)",e,s,this.routingTable.size);const o=Le([i==null?void 0:i.signal,AbortSignal.timeout(this.refreshQueryTimeout)]);try{const a=await kb(this.peerRouting.getClosestPeers(s.toMultihash().bytes,{signal:o}));this.log(`found ${a} peers that were close to imaginary peer %p`,s),this.log("finished refreshing cpl %s with key %p (routing table size is now %s)",e,s,this.routingTable.size)}finally{o.clear()}}_getTrackedCommonPrefixLengthsForRefresh(e){e>nu&&(e=nu);const t=[];for(let r=0;r<=e;r++)t[r]=this.commonPrefixLengthRefreshedAt[r]??new Date;return t}_generateRandomPeerId(e){if(this.routingTable.kb==null)throw new Error("Routing table not started");if(this.routingTable.kb.localPeer==null)throw new Error("Local peer not set");const t=Os(2),r=(t[1]<<8)+t[0],i=this._makePeerId(this.routingTable.kb.localPeer.kadId,r,e),s=Pt(i);return ln(s)}_makePeerId(e,t,r){if(r>nu)throw new Error(`Cannot generate peer ID for common prefix length greater than ${nu}`);const o=new DataView(e.buffer,e.byteOffset,e.byteLength).getUint16(0,!1)^32768>>r,a=65535<<16-(r+1),c=o&a|t&~a,u=yN[c],d=new ArrayBuffer(34),h=new DataView(d,0,d.byteLength);return h.setUint8(0,ut.code),h.setUint8(1,32),h.setUint32(2,u,!1),new Uint8Array(h.buffer,h.byteOffset,h.byteLength)}_maxCommonPrefix(){let e=0;for(const t of this._prefixLengths())t>e&&(e=t);return e}_numPeersForCpl(e){let t=0;for(const r of this._prefixLengths())r===e&&t++;return t}*_prefixLengths(){var e;if(((e=this.routingTable.kb)==null?void 0:e.localPeer)!=null)for(const{kadId:t}of this.routingTable.kb.toIterable()){const r=Zo(this.routingTable.kb.localPeer.kadId,t);let i=0;for(const s of r)if(s===0)i++;else break;yield i}}}class bN{constructor(e,t){l(this,"peerId");l(this,"providers");l(this,"peerStore");l(this,"log");this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:add-provider`),this.peerId=e.peerId,this.providers=t.providers,this.peerStore=e.peerStore}async handle(e,t){if(t.key==null||t.key.length===0)throw new qe("Missing key");let r;try{r=le.decode(t.key)}catch{throw new qe("Invalid CID")}(t.providers==null||t.providers.length===0)&&this.log.error("no providers found in message"),this.log("%p asked us, %p to store provider record for for %c",e,this.peerId,r),await Promise.all(t.providers.map(async i=>{const s=Pt(i.id),o=ln(s),a=i.multiaddrs.map(c=>fe(c));if(!e.equals(o)){this.log("invalid provider peer %p from %p",i.id,e);return}if(i.multiaddrs.length<1){this.log("no valid addresses for provider %p. Ignore",e);return}this.log.trace("received provider %p for %s (addrs %s)",e,r,a),await this.providers.addProvider(r,o),await this.peerStore.merge(o,{multiaddrs:a})}))}}class vN{constructor(e,t){l(this,"peerRouting");l(this,"peerInfoMapper");l(this,"peerId");l(this,"addressManager");l(this,"log");const{peerRouting:r,logPrefix:i}=t;this.log=e.logger.forComponent(`${i}:rpc:handlers:find-node`),this.peerId=e.peerId,this.addressManager=e.addressManager,this.peerRouting=r,this.peerInfoMapper=t.peerInfoMapper}async handle(e,t){this.log("incoming request from %p for peers close to %b",e,t.key);try{if(t.key==null)throw new qe("Invalid FIND_NODE message received - key was missing");const r=await this.peerRouting.getClosestPeersOffline(t.key,{exclude:[e,this.peerId]});ke(this.peerId.toMultihash().bytes,t.key)&&r.push({id:this.peerId,multiaddrs:this.addressManager.getAddresses().map(s=>s.decapsulateCode(ba("p2p").code))});const i={type:Ye.FIND_NODE,clusterLevel:t.clusterLevel,closer:r.map(this.peerInfoMapper).filter(({multiaddrs:s})=>s.length).map(s=>({id:s.id.toMultihash().bytes,multiaddrs:s.multiaddrs.map(o=>o.bytes)})),providers:[]};return i.closer.length===0?this.log("could not find any peers closer to %b for %p",t.key,e):this.log("found %d peers close to %b for %p",i.closer.length,t.key,e),i}catch(r){throw this.log("error during finding peers closer to %b for %p - %e",t.key,e,r),r}}}class SN{constructor(e,t){l(this,"peerId");l(this,"peerRouting");l(this,"providers");l(this,"peerStore");l(this,"peerInfoMapper");l(this,"log");const{peerRouting:r,providers:i,logPrefix:s}=t;this.log=e.logger.forComponent(`${s}:rpc:handlers:get-providers`),this.peerId=e.peerId,this.peerStore=e.peerStore,this.peerRouting=r,this.providers=i,this.peerInfoMapper=t.peerInfoMapper}async handle(e,t){if(t.key==null)throw new qe("Invalid GET_PROVIDERS message received - key was missing");let r;try{r=le.decode(t.key)}catch{throw new qe("Invalid CID")}this.log("%p asking for providers for %s",e,r);const[i,s]=await Promise.all([wc(vr(await this.providers.getProviders(r),async a=>{const c=await this.peerStore.get(a);return{id:c.id,multiaddrs:c.addresses.map(({multiaddr:d})=>d)}})),this.peerRouting.getClosestPeersOffline(t.key)]),o={type:Ye.GET_PROVIDERS,key:t.key,clusterLevel:t.clusterLevel,closer:s.map(this.peerInfoMapper).filter(({id:a,multiaddrs:c})=>c.length>0).map(a=>({id:a.id.toMultihash().bytes,multiaddrs:a.multiaddrs.map(c=>c.bytes)})),providers:i.map(this.peerInfoMapper).filter(({id:a,multiaddrs:c})=>c.length>0).map(a=>({id:a.id.toMultihash().bytes,multiaddrs:a.multiaddrs.map(c=>c.bytes)}))};return this.log("got %s providers %s closerPeers",o.providers.length,o.closer.length),o}async _getAddresses(e){return[]}}class EN{constructor(e,t){l(this,"peerStore");l(this,"datastore");l(this,"peerRouting");l(this,"log");l(this,"datastorePrefix");this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:get-value`),this.datastorePrefix=`${t.datastorePrefix}/record`,this.peerStore=e.peerStore,this.datastore=e.datastore,this.peerRouting=t.peerRouting}async handle(e,t){const r=t.key;if(this.log("%p asked for key %b",e,r),r==null||r.length===0)throw new qe("Invalid key");const i={type:Ye.GET_VALUE,key:r,clusterLevel:t.clusterLevel,closer:[],providers:[]};if(TD(r)){this.log("is public key");const a=RD(r);let c;try{const u=await this.peerStore.get(a);if(u.id.publicKey==null)throw new tr("No public key found in key book");c=en(u.id.publicKey)}catch(u){if(u.name!=="NotFoundError")throw u}if(c!=null)return this.log("returning found public key"),i.record=new Nt(r,c,new Date).serialize(),i}const[s,o]=await Promise.all([this._checkLocalDatastore(r),this.peerRouting.getClosestPeersOffline(r)]);return s!=null&&(this.log("had record for %b in local datastore",r),i.record=s.serialize()),o.length>0&&(this.log("had %s closer peers in routing table",o.length),i.closer=o.map(a=>({id:a.id.toMultihash().bytes,multiaddrs:a.multiaddrs.map(c=>c.bytes)}))),i}async _checkLocalDatastore(e){this.log("checkLocalDatastore looking for %b",e);const t=cc(this.datastorePrefix,e);let r;try{r=await this.datastore.get(t)}catch(s){if(s.name==="NotFoundError")return;throw s}const i=Nt.deserialize(r);if(i.timeReceived==null||Date.now()-i.timeReceived.getTime()>vb){await this.datastore.delete(t);return}return i}}class xN{constructor(e,t){l(this,"log");this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:ping`)}async handle(e,t){return this.log("ping from %p",e),t}}class AN{constructor(e,t){l(this,"components");l(this,"validators");l(this,"log");l(this,"datastorePrefix");const{validators:r}=t;this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:put-value`),this.datastorePrefix=`${t.datastorePrefix}/record`,this.validators=r}async handle(e,t){const r=t.key;if(this.log("%p asked us to store value for key %b",e,r),t.record==null){const i=`Empty record from: ${e.toString()}`;throw this.log.error(i),new qe(i)}try{const i=Nt.deserialize(t.record);await Rg(this.validators,i),i.timeReceived=new Date;const s=cc(this.datastorePrefix,i.key);await this.components.datastore.put(s,i.serialize().subarray()),this.log("put record for %b into datastore under key %k",r,s)}catch(i){this.log("did not put record for key %b into datastore %o",r,i)}return t}}class kN{constructor(e,t){l(this,"handlers");l(this,"log");l(this,"metrics");l(this,"incomingMessageTimeout");var r,i,s;this.metrics={operations:(r=e.metrics)==null?void 0:r.registerCounterGroup(`${t.metricsPrefix}_inbound_rpc_requests_total`),errors:(i=e.metrics)==null?void 0:i.registerCounterGroup(`${t.metricsPrefix}_inbound_rpc_errors_total`),rpcTime:(s=e.metrics)==null?void 0:s.registerMetricGroup(`${t.metricsPrefix}_inbound_rpc_time_seconds`,{label:"operation"})},this.log=e.logger.forComponent(`${t.logPrefix}:rpc`),this.incomingMessageTimeout=t.incomingMessageTimeout??1e4,this.handlers={[Ye.GET_VALUE.toString()]:new EN(e,t),[Ye.PUT_VALUE.toString()]:new AN(e,t),[Ye.FIND_NODE.toString()]:new vN(e,t),[Ye.ADD_PROVIDER.toString()]:new bN(e,t),[Ye.GET_PROVIDERS.toString()]:new SN(e,t),[Ye.PING.toString()]:new xN(e,t)}}async handleMessage(e,t){var i,s;const r=this.handlers[t.type];if(r==null){this.log.error(`no handler found for message type: ${t.type}`);return}try{return(i=this.metrics.operations)==null||i.increment({[t.type]:!0}),await r.handle(e,t)}catch{(s=this.metrics.errors)==null||s.increment({[t.type]:!0})}}onIncomingStream(e){const t="unknown";Promise.resolve().then(async()=>{var c,u,d,h;const{stream:r,connection:i}=e,s=()=>{r.abort(new ll)};let o=AbortSignal.timeout(this.incomingMessageTimeout);o.addEventListener("abort",s);const a=Mt(r).pb(No);try{for(;;){const f=await a.read({signal:o}),p=(u=(c=this.metrics)==null?void 0:c.rpcTime)==null?void 0:u.timer(f.type.toString()),m=(h=(d=this.metrics)==null?void 0:d.rpcTime)==null?void 0:h.timer(f.type.toString());let w=!1;try{this.log("incoming %s from %p",f.type,i.remotePeer);const b=await this.handleMessage(i.remotePeer,f);b!=null&&await a.write(b,{signal:o})}catch(b){throw w=!0,m==null||m(),b}finally{w||p==null||p()}o.removeEventListener("abort",s),o=AbortSignal.timeout(this.incomingMessageTimeout),o.addEventListener("abort",s)}}catch(f){r.abort(f)}}).catch(r=>{this.log.error("error handling %s RPC message from %p - %e",t,e.connection.remotePeer,r)})}}class _N extends ot{constructor(t,r){super();l(this,"log");l(this,"components");l(this,"protocol");l(this,"running");l(this,"registrarId");const{protocol:i,logPrefix:s}=r;this.components=t,this.log=t.logger.forComponent(`${s}:topology-listener`),this.running=!1,this.protocol=i}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.registrarId=await this.components.registrar.register(this.protocol,{onConnect:t=>{this.log("observed peer %p with protocol %s",t,this.protocol),this.dispatchEvent(new CustomEvent("peer",{detail:t}))}}))}async stop(){this.running=!1,this.registrarId!=null&&(this.components.registrar.unregister(this.registrarId),this.registrarId=void 0)}}class IN{constructor(e){l(this,"dht");this.dht=e}async provide(e,t={}){await ui(this.dht.provide(e,t))}async cancelReprovide(e){await this.dht.cancelReprovide(e)}async*findProviders(e,t={}){for await(const r of this.dht.findProviders(e,t))r.name==="PROVIDER"&&(yield*r.providers)}async put(e,t,r){await ui(this.dht.put(e,t,r))}async get(e,t){for await(const r of this.dht.get(e,t))if(r.name==="VALUE")return r.value;throw new tr("Could not find value for key")}}class CN{constructor(e){l(this,"dht");this.dht=e}async findPeer(e,t={}){for await(const r of this.dht.findPeer(e,t))if(r.name==="FINAL_PEER")return r.peer;throw new tr("Peer not found")}async*getClosestPeers(e,t={}){for await(const r of this.dht.getClosestPeers(e,t))r.name==="FINAL_PEER"&&(yield r.peer)}}const TN=32,RN=64;var P6,O6,D6;class PN extends ot{constructor(t,r={}){var u,d,h,f;super();l(this,"k");l(this,"a");l(this,"d");l(this,"protocol");l(this,"routingTable");l(this,"providers");l(this,"network");l(this,"peerRouting");l(this,"components");l(this,"log");l(this,"running");l(this,"clientMode");l(this,"validators");l(this,"selectors");l(this,"queryManager");l(this,"contentFetching");l(this,"contentRouting");l(this,"routingTableRefresh");l(this,"rpc");l(this,"topologyListener");l(this,"querySelf");l(this,"maxInboundStreams");l(this,"maxOutboundStreams");l(this,"dhtContentRouting");l(this,"dhtPeerRouting");l(this,"peerInfoMapper");l(this,"reprovider");l(this,"onPeerConnectTimeout");l(this,D6,"@libp2p/kad-dht");l(this,O6,["@libp2p/content-routing","@libp2p/peer-routing","@libp2p/peer-discovery","@libp2p/kad-dht"]);l(this,P6,["@libp2p/identify","@libp2p/ping"]);const i=r.logPrefix??"libp2p:kad-dht",s=r.datastorePrefix??"/dht",o=r.metricsPrefix??"libp2p_kad_dht",a={queries:(u=t.metrics)==null?void 0:u.registerMetricGroup(`${o}_operations_total`,{label:"operation"}),errors:(d=t.metrics)==null?void 0:d.registerCounterGroup(`${o}_operation_errors_total`,{label:"operation"}),queryTime:(h=t.metrics)==null?void 0:h.registerMetricGroup(`${o}_operation_time_seconds`,{label:"operation"}),errorTime:(f=t.metrics)==null?void 0:f.registerMetricGroup(`${o}_operation_error_time_seconds`,{label:"operation"})};this.running=!1,this.components=t,this.log=t.logger.forComponent(i),this.k=r.kBucketSize??Og,this.a=r.alpha??n1,this.d=r.disjointPaths??this.a,this.protocol=r.protocol??iD,this.clientMode=r.clientMode??!0,this.maxInboundStreams=r.maxInboundStreams??TN,this.maxOutboundStreams=r.maxOutboundStreams??RN,this.peerInfoMapper=r.peerInfoMapper??ID,this.onPeerConnectTimeout=r.onPeerConnectTimeout??lD,this.providers=new zD(t,{...r.providers,logPrefix:i,datastorePrefix:s}),this.validators={...kD,...r.validators},this.selectors={...xD,...r.selectors},this.network=new HD(t,{protocol:this.protocol,logPrefix:i,metricsPrefix:o}),this.routingTable=new mN(t,{kBucketSize:this.k,pingOldContactTimeout:r.pingOldContactTimeout,pingOldContactConcurrency:r.pingOldContactConcurrency,pingOldContactMaxQueueSize:r.pingOldContactMaxQueueSize,pingNewContactTimeout:r.pingNewContactTimeout,pingNewContactConcurrency:r.pingNewContactConcurrency,pingNewContactMaxQueueSize:r.pingNewContactMaxQueueSize,protocol:this.protocol,logPrefix:i,metricsPrefix:o,prefixLength:r.prefixLength,splitThreshold:r.kBucketSplitThreshold,network:this.network});const c=ve();r.allowQueryWithZeroPeers===!0&&c.resolve(),this.queryManager=new jD(t,{disjointPaths:this.d,alpha:this.a,logPrefix:i,metricsPrefix:o,initialQuerySelfHasRun:c,routingTable:this.routingTable,allowQueryWithZeroPeers:r.allowQueryWithZeroPeers}),this.peerRouting=new VD(t,{routingTable:this.routingTable,network:this.network,validators:this.validators,queryManager:this.queryManager,logPrefix:i}),this.contentFetching=new UD(t,{validators:this.validators,selectors:this.selectors,peerRouting:this.peerRouting,queryManager:this.queryManager,network:this.network,logPrefix:i,datastorePrefix:s}),this.contentRouting=new $D(t,{network:this.network,peerRouting:this.peerRouting,queryManager:this.queryManager,routingTable:this.routingTable,providers:this.providers,logPrefix:i}),this.routingTableRefresh=new wN(t,{peerRouting:this.peerRouting,routingTable:this.routingTable,logPrefix:i}),this.rpc=new kN(t,{routingTable:this.routingTable,providers:this.providers,peerRouting:this.peerRouting,validators:this.validators,logPrefix:i,metricsPrefix:o,datastorePrefix:s,peerInfoMapper:this.peerInfoMapper}),this.topologyListener=new _N(t,{protocol:this.protocol,logPrefix:i}),this.querySelf=new YD(t,{peerRouting:this.peerRouting,interval:r.querySelfInterval,initialInterval:r.initialQuerySelfInterval,logPrefix:i,initialQuerySelfHasRun:c,operationMetrics:a}),this.reprovider=new XD(t,{...r.reprovide,logPrefix:i,metricsPrefix:o,datastorePrefix:s,contentRouting:this.contentRouting,operationMetrics:a}),this.network.addEventListener("peer",p=>{const m=p.detail;this.onPeerConnect(m).catch(w=>{this.log.error("could not add %p to routing table",m.id,w)}),this.dispatchEvent(new CustomEvent("peer",{detail:m}))}),this.topologyListener.addEventListener("peer",p=>{const m=p.detail;Promise.resolve().then(async()=>{const w=await this.components.peerStore.get(m),b={id:m,multiaddrs:w.addresses.map(({multiaddr:S})=>S),protocols:w.protocols};await this.onPeerConnect(b)}).catch(w=>{this.log.error("could not add %p to routing table - %e - %e",m,w)})}),this.dhtPeerRouting=new CN(this),this.dhtContentRouting=new IN(this),r.clientMode==null&&t.events.addEventListener("self:peer:update",p=>{this.log("received update of self-peer info"),Promise.resolve().then(async()=>{const m=p.detail.peer.addresses.some(({multiaddr:b})=>MD(b)),w=this.getMode();m&&w==="client"?await this.setMode("server"):w==="server"&&!m&&await this.setMode("client")}).catch(m=>{this.log.error("error setting dht server mode",m)})}),this.get=ao(this.get.bind(this),a,"GET_VALUE"),this.findProviders=ao(this.findProviders.bind(this),a,"FIND_PROVIDERS"),this.findPeer=ao(this.findPeer.bind(this),a,"FIND_PEER"),this.getClosestPeers=ao(this.getClosestPeers.bind(this),a,"GET_CLOSEST_PEERS"),this.provide=ao(this.provide.bind(this),a,"PROVIDE"),this.put=ao(this.put.bind(this),a,"PUT_VALUE")}get[(D6=Symbol.toStringTag,O6=kt,P6=Ps,bc)](){return this.dhtContentRouting}get[vc](){return this.dhtPeerRouting}get[Vu](){return this}async onPeerConnect(t){if(this.log.trace("peer %p connected",t.id),t=this.peerInfoMapper(t),t.multiaddrs.length===0){this.log.trace("ignoring %p as there were no valid addresses in %s after filtering",t.id,t.multiaddrs.map(i=>i.toString()));return}const r=AbortSignal.timeout(this.onPeerConnectTimeout);try{await this.routingTable.add(t.id,{signal:r})}catch(i){this.log.error("could not add %p to routing table",t.id,i)}}isStarted(){return this.running}getMode(){return this.clientMode?"client":"server"}async setMode(t,r){if(t===this.getMode()&&(r==null?void 0:r.force)!==!0){this.log("already in %s mode",t);return}if(await this.components.registrar.unhandle(this.protocol,r),t===this.getMode()&&(r==null?void 0:r.force)!==!0){this.log("already in %s mode",t);return}t==="client"?(this.log("enabling client mode while in %s mode",this.getMode()),this.clientMode=!0):(this.log("enabling server mode while in %s mode",this.getMode()),this.clientMode=!1,await this.components.registrar.handle(this.protocol,this.rpc.onIncomingStream.bind(this.rpc),{signal:r==null?void 0:r.signal,maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}))}async start(){this.running||(this.running=!0,await this.setMode(this.clientMode?"client":"server",{force:!0}),await li(this.routingTable,this.queryManager,this.network,this.topologyListener,this.routingTableRefresh,this.reprovider),await li(this.querySelf))}async stop(){this.running=!1,await rs(this.querySelf,this.queryManager,this.network,this.routingTable,this.routingTableRefresh,this.topologyListener,this.reprovider)}async*put(t,r,i={}){yield*this.contentFetching.put(t,r,i)}async*get(t,r={}){yield*this.contentFetching.get(t,r)}async*provide(t,r={}){yield*this.contentRouting.provide(t,this.components.addressManager.getAddresses(),r)}async cancelReprovide(t,r){await this.providers.removeProvider(t,this.components.peerId,r)}async*findProviders(t,r={}){yield*this.contentRouting.findProviders(t,r)}async*findPeer(t,r={}){yield*this.peerRouting.findPeer(t,r)}async*getClosestPeers(t,r={}){yield*this.peerRouting.getClosestPeers(t,r)}async refreshRoutingTable(t){this.routingTableRefresh.refreshTable(!0,t)}}var O4;(function(n){n[n.SEND_QUERY=0]="SEND_QUERY",n[n.PEER_RESPONSE=1]="PEER_RESPONSE",n[n.FINAL_PEER=2]="FINAL_PEER",n[n.QUERY_ERROR=3]="QUERY_ERROR",n[n.PROVIDER=4]="PROVIDER",n[n.VALUE=5]="VALUE",n[n.ADD_PEER=6]="ADD_PEER",n[n.DIAL_PEER=7]="DIAL_PEER",n[n.PATH_ENDED=8]="PATH_ENDED"})(O4||(O4={}));function ON(n={}){return e=>new PN(e,n)}var Re;(function(n){n[n.NEW_STREAM=0]="NEW_STREAM",n[n.MESSAGE_RECEIVER=1]="MESSAGE_RECEIVER",n[n.MESSAGE_INITIATOR=2]="MESSAGE_INITIATOR",n[n.CLOSE_RECEIVER=3]="CLOSE_RECEIVER",n[n.CLOSE_INITIATOR=4]="CLOSE_INITIATOR",n[n.RESET_RECEIVER=5]="RESET_RECEIVER",n[n.RESET_INITIATOR=6]="RESET_INITIATOR"})(Re||(Re={}));const Dg=Object.freeze({0:"NEW_STREAM",1:"MESSAGE_RECEIVER",2:"MESSAGE_INITIATOR",3:"CLOSE_RECEIVER",4:"CLOSE_INITIATOR",5:"RESET_RECEIVER",6:"RESET_INITIATOR"}),D4=Object.freeze({NEW_STREAM:Re.NEW_STREAM,MESSAGE:Re.MESSAGE_INITIATOR,CLOSE:Re.CLOSE_INITIATOR,RESET:Re.RESET_INITIATOR}),DN=Object.freeze({MESSAGE:Re.MESSAGE_RECEIVER,CLOSE:Re.CLOSE_RECEIVER,RESET:Re.RESET_RECEIVER}),_b=1<<20,NN=4<<20;class LN{constructor(e=_b,t=NN){l(this,"_buffer");l(this,"_headerInfo");l(this,"_maxMessageSize");l(this,"_maxUnprocessedMessageQueueSize");this._buffer=new Ee,this._headerInfo=null,this._maxMessageSize=e,this._maxUnprocessedMessageQueueSize=t}write(e){if(e==null||e.length===0)return[];if(this._buffer.append(e),this._buffer.byteLength>this._maxUnprocessedMessageQueueSize)throw new qe("Unprocessed message queue size too large!");const t=[];for(;this._buffer.length!==0;){if(this._headerInfo==null)try{this._headerInfo=this._decodeHeader(this._buffer)}catch(u){if(u.name==="InvalidMessageError")throw u;break}const{id:r,type:i,length:s,offset:o}=this._headerInfo;if(this._buffer.length-o<s)break;const c={id:r,type:i};(i===Re.NEW_STREAM||i===Re.MESSAGE_INITIATOR||i===Re.MESSAGE_RECEIVER)&&(c.data=this._buffer.sublist(o,o+s)),t.push(c),this._buffer.consume(o+s),this._headerInfo=null}return t}_decodeHeader(e){const{value:t,offset:r}=L4(e),{value:i,offset:s}=L4(e,r),o=t&7;if(Dg[o]==null)throw new Error(`Invalid type received: ${o}`);if(i>this._maxMessageSize)throw new qe("Message size too large");return{id:t>>3,type:o,offset:r+s,length:i}}}const BN=128,N4=127;function L4(n,e=0){let t=0,r=0,i=e,s;const o=n.length;do{if(i>=o||r>49)throw e=0,new RangeError("Could not decode varint");s=n.get(i++),t+=r<28?(s&N4)<<r:(s&N4)*Math.pow(2,r),r+=7}while(s>=BN);return e=i-e,{value:t,offset:e}}const wf=10*1024;class MN{constructor(){l(this,"_pool");l(this,"_poolOffset");this._pool=yc(wf),this._poolOffset=0}write(e,t){const r=this._pool;let i=this._poolOffset;Jr(e.id<<3|e.type,r,i),i+=Ht(e.id<<3|e.type),(e.type===Re.NEW_STREAM||e.type===Re.MESSAGE_INITIATOR||e.type===Re.MESSAGE_RECEIVER)&&e.data!=null?(Jr(e.data.length,r,i),i+=Ht(e.data.length)):(Jr(0,r,i),i+=Ht(0));const s=r.subarray(this._poolOffset,i);wf-i<100?(this._pool=yc(wf),this._poolOffset=0):this._poolOffset=i,t.append(s),(e.type===Re.NEW_STREAM||e.type===Re.MESSAGE_INITIATOR||e.type===Re.MESSAGE_RECEIVER)&&e.data!=null&&t.append(e.data)}}const UN=new MN;async function*FN(n){for await(const e of n){const t=new Ee;UN.write(e,t),yield t}}class $N extends Error{constructor(e="Stream input buffer error"){super(e),this.name="StreamInputBufferError"}}class HN extends Cg{constructor(t){super(t);l(this,"name");l(this,"streamId");l(this,"send");l(this,"types");l(this,"maxDataSize");this.types=t.direction==="outbound"?D4:DN,this.send=t.send,this.name=t.name,this.streamId=t.streamId,this.maxDataSize=t.maxDataSize}async sendNewStream(){await this.send({id:this.streamId,type:D4.NEW_STREAM,data:new Ee(R(this.name))})}async sendData(t){for(t=t.sublist();t.byteLength>0;){const r=Math.min(t.byteLength,this.maxDataSize);await this.send({id:this.streamId,type:this.types.MESSAGE,data:t.sublist(0,r)}),t.consume(r)}}async sendReset(){await this.send({id:this.streamId,type:this.types.RESET})}async sendCloseWrite(){await this.send({id:this.streamId,type:this.types.CLOSE})}async sendCloseRead(){}}function VN(n){const{id:e,name:t,send:r,onEnd:i,type:s="initiator",maxMsgSize:o=_b}=n,a=s==="initiator"?"outbound":"inbound";return new HN({id:s==="initiator"?`i${e}`:`r${e}`,streamId:e,name:`${t??e}`,direction:a,maxDataSize:o,onEnd:i,send:r,log:n.log.newScope(`${a}:${e}`)})}const zN=1024,KN=1024,qN=1024*1024*4,WN=5,GN=500;function B4(n){const e={...n,type:`${Dg[n.type]} (${n.type})`};return n.type===Re.NEW_STREAM&&(e.data=U(n.data instanceof Uint8Array?n.data:n.data.subarray())),(n.type===Re.MESSAGE_INITIATOR||n.type===Re.MESSAGE_RECEIVER)&&(e.data=U(n.data instanceof Uint8Array?n.data:n.data.subarray(),"base16")),e}class jN{constructor(e,t){l(this,"protocol","/mplex/6.7.0");l(this,"sink");l(this,"source");l(this,"log");l(this,"_streamId");l(this,"_streams");l(this,"_init");l(this,"_source");l(this,"closeController");l(this,"rateLimiter");l(this,"closeTimeout");l(this,"logger");var r;t=t??{},this.log=((r=t.log)==null?void 0:r.newScope("mplex"))??e.logger.forComponent("libp2p:mplex"),this.logger=e.logger,this._streamId=0,this._streams={initiators:new Map,receivers:new Map},this._init=t,this.closeTimeout=t.closeTimeout??GN,this.sink=this._createSink(),this._source=cn({objectMode:!0,onEnd:()=>{for(const i of this._streams.initiators.values())i.destroy();for(const i of this._streams.receivers.values())i.destroy()}}),this.source=_t(this._source,i=>FN(i)),this.closeController=new AbortController,this.rateLimiter=new _9({points:t.disconnectThreshold??WN,duration:1})}get streams(){const e=[];for(const t of this._streams.initiators.values())e.push(t);for(const t of this._streams.receivers.values())e.push(t);return e}newStream(e){if(this.closeController.signal.aborted)throw new ps("Muxer already closed");const t=this._streamId++;e=e==null?t.toString():e.toString();const r=this._streams.initiators;return this._newStream({id:t,name:e,type:"initiator",registry:r})}async close(e){if(this.closeController.signal.aborted)return;const t=(e==null?void 0:e.signal)??AbortSignal.timeout(this.closeTimeout);try{await Promise.all(this.streams.map(async r=>r.close({signal:t}))),this._source.end(),await this._source.onEmpty({signal:t}),this.closeController.abort()}catch(r){this.abort(r)}}abort(e){this.closeController.signal.aborted||(this.streams.forEach(t=>{t.abort(e)}),this.closeController.abort(e))}_newReceiverStream(e){const{id:t,name:r}=e,i=this._streams.receivers;return this._newStream({id:t,name:r,type:"receiver",registry:i})}_newStream(e){const{id:t,name:r,type:i,registry:s}=e;if(this.log("new %s stream %s",i,t),i==="initiator"&&this._streams.initiators.size===(this._init.maxOutboundStreams??KN))throw new Eh("Too many outbound streams open");if(s.has(t))throw new Error(`${i} stream ${t} already exists!`);const c=VN({id:t,name:r,send:async u=>{this.log.enabled&&this.log.trace("%s stream %s send",i,t,B4(u)),this._source.push(u)},type:i,onEnd:()=>{this.log("%s stream with id %s and protocol %s ended",i,t,c.protocol),s.delete(t),this._init.onStreamEnd!=null&&this._init.onStreamEnd(c)},maxMsgSize:this._init.maxMsgSize,log:this.log});return s.set(t,c),c}_createSink(){return async t=>{const r=()=>{rb(t,this.log)};this.closeController.signal.addEventListener("abort",r);try{const i=new LN(this._init.maxMsgSize,this._init.maxUnprocessedMessageQueueSize);for await(const s of t)for(const o of i.write(s))await this._handleIncoming(o);this._source.end()}catch(i){this.log("error in sink",i),this._source.end(i)}finally{this.closeController.signal.removeEventListener("abort",r)}}}async _handleIncoming(e){const{id:t,type:r}=e;if(this.log.enabled&&this.log.trace("incoming message",B4(e)),e.type===Re.NEW_STREAM){if(this._streams.receivers.size===(this._init.maxInboundStreams??zN)){this.log("too many inbound streams open"),this._source.push({id:t,type:Re.RESET_RECEIVER});try{await this.rateLimiter.consume("new-stream",1)}catch{this.log("rate limit hit when opening too many new streams over the inbound stream limit - closing remote connection"),this.abort(new Error("Too many open streams"));return}return}const a=this._newReceiverStream({id:t,name:U(e.data instanceof Uint8Array?e.data:e.data.subarray())});this._init.onIncomingStream!=null&&this._init.onIncomingStream(a);return}const s=((r&1)===1?this._streams.initiators:this._streams.receivers).get(t);if(s==null){this.log("missing stream %s for message type %s",t,Dg[r]);try{await this.rateLimiter.consume("missing-stream",1)}catch{this.log("rate limit hit when receiving messages for streams that do not exist - closing remote connection"),this.abort(new Error("Too many messages for missing streams"));return}return}const o=this._init.maxStreamBufferSize??qN;try{switch(r){case Re.MESSAGE_INITIATOR:case Re.MESSAGE_RECEIVER:if(s.sourceReadableLength()>o)throw this._source.push({id:e.id,type:r===Re.MESSAGE_INITIATOR?Re.RESET_RECEIVER:Re.RESET_INITIATOR}),new $N("Input buffer full - increase Mplex maxBufferSize to accommodate slow consumers");s.sourcePush(e.data);break;case Re.CLOSE_INITIATOR:case Re.CLOSE_RECEIVER:s.remoteCloseWrite();break;case Re.RESET_INITIATOR:case Re.RESET_RECEIVER:s.reset();break;default:this.log("unknown message type %s",r)}}catch(a){this.log.error("error while processing message",a),s.abort(a)}}}var N6,L6;L6=Symbol.toStringTag,N6=kt;class QN{constructor(e,t={}){l(this,"protocol","/mplex/6.7.0");l(this,"_init");l(this,"components");l(this,L6,"@libp2p/mplex");l(this,N6,["@libp2p/stream-multiplexing"]);this.components=e,this._init=t}createStreamMuxer(e){return new jN(this.components,{...e,...this._init})}}function YN(n={}){return e=>new QN(e,n)}const bf=32,XN="1.0.0",ZN="ping",JN="ipfs",eL=1e4,tL=2,rL=1;var B6,M6;M6=Symbol.toStringTag,B6=kt;class nL{constructor(e,t={}){l(this,"protocol");l(this,"components");l(this,"started");l(this,"timeout");l(this,"maxInboundStreams");l(this,"maxOutboundStreams");l(this,"runOnLimitedConnection");l(this,M6,"@libp2p/ping");l(this,B6,["@libp2p/ping"]);this.components=e,this.started=!1,this.protocol=`/${t.protocolPrefix??JN}/${ZN}/${XN}`,this.timeout=t.timeout??eL,this.maxInboundStreams=t.maxInboundStreams??tL,this.maxOutboundStreams=t.maxOutboundStreams??rL,this.runOnLimitedConnection=t.runOnLimitedConnection??!0,this.handleMessage=this.handleMessage.bind(this)}async start(){await this.components.registrar.handle(this.protocol,this.handleMessage,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnection}),this.started=!0}async stop(){await this.components.registrar.unhandle(this.protocol),this.started=!1}isStarted(){return this.started}handleMessage(e){const t=e.connection.log.newScope("ping");t.trace("ping from %p",e.connection.remotePeer);const{stream:r}=e,i=Date.now(),s=ud(r);let o=!1;Promise.resolve().then(async()=>{for(;;){const a=AbortSignal.timeout(this.timeout);a.addEventListener("abort",()=>{r==null||r.abort(new ll("ping timeout"))});const c=await s.read({bytes:bf,signal:a});await s.write(c,{signal:a}),o=!0}}).catch(a=>{o&&a.name==="UnexpectedEOFError"&&r.readStatus!=="ready"||(t.error("ping from %p failed with error - %e",e.connection.remotePeer,a),r==null||r.abort(a))}).finally(()=>{const a=Date.now()-i;t("ping from %p complete in %dms",e.connection.remotePeer,a);const c=AbortSignal.timeout(this.timeout);r.close({signal:c}).catch(u=>{t.error("error closing ping stream from %p - %e",e.connection.remotePeer,u),r==null||r.abort(u)})})}async ping(e,t={}){const r=Date.now(),i=Os(bf),s=await this.components.connectionManager.openConnection(e,t),o=s.log.newScope("ping");let a;if(t.signal==null){const c=AbortSignal.timeout(this.timeout);t={...t,signal:c}}try{a=await s.newStream(this.protocol,{...t,runOnLimitedConnection:this.runOnLimitedConnection});const c=ud(a),[,u]=await Promise.all([c.write(i,t),c.read({...t,bytes:bf})]),d=Date.now()-r;if(!ke(i,u.subarray()))throw new h8(`Received wrong ping ack after ${d}ms`);return o("ping %p complete in %dms",s.remotePeer,d),d}catch(c){throw o.error("error while pinging %p",s.remotePeer,c),a==null||a.abort(c),c}finally{a!=null&&await a.close(t)}}}function iL(n={}){return e=>new nL(e,n)}var Xt;(function(n){(function(r){r.FIN="FIN",r.STOP_SENDING="STOP_SENDING",r.RESET="RESET",r.FIN_ACK="FIN_ACK"})(n.Flag||(n.Flag={}));let e;(function(r){r[r.FIN=0]="FIN",r[r.STOP_SENDING=1]="STOP_SENDING",r[r.RESET=2]="RESET",r[r.FIN_ACK=3]="FIN_ACK"})(e||(e={})),function(r){r.codec=()=>Wt(e)}(n.Flag||(n.Flag={}));let t;n.codec=()=>(t==null&&(t=me((r,i,s={})=>{s.lengthDelimited!==!1&&i.fork(),r.flag!=null&&(i.uint32(8),n.Flag.codec().encode(r.flag,i)),r.message!=null&&(i.uint32(18),i.bytes(r.message)),s.lengthDelimited!==!1&&i.ldelim()},(r,i,s={})=>{const o={},a=i==null?r.len:r.pos+i;for(;r.pos<a;){const c=r.uint32();switch(c>>>3){case 1:{o.flag=n.Flag.codec().decode(r);break}case 2:{o.message=r.bytes();break}default:{r.skipType(c&7);break}}}return o})),t),n.encode=r=>ye(r,n.codec()),n.decode=(r,i)=>we(r,n.codec(),i)})(Xt||(Xt={}));const sL=["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478","stun:stun.cloudflare.com:3478","stun:stun.services.mozilla.com:3478"],M4=Array.from("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890"),oL="libp2p+webrtc+v1/",aL=466,cL=2*1024*1024,lL=30*1e3,i1=16*1024;function uL(n=i1){const e=Ht(n-Ht(n)),t=1+Ht(Object.keys(Xt.Flag).length-1),r=1,i=n-e-t-r,s=Ht(i);return e+t+r+s}const dL=uL(),hL=5e3,fL=5e3,pL=3e4,Ib="/webrtc",H0="/webrtc-signaling/0.0.1",gL="/libp2p/webrtc-direct/certificate",mL="webrtc-direct-certificate-private-key",yL=12096e5,U4=864e5,F4=DE(),Ng=F4!=null&&F4.name==="firefox",Cb=async function*(){},Tb=async n=>{};function wL(n,e,t=pL,r){n.readyState==="open"&&Promise.resolve().then(async()=>{if(n.bufferedAmount>0){r.log("%s drain channel with %d buffered bytes",e,n.bufferedAmount);const i=ve();let s=!1;n.bufferedAmountLowThreshold=0;const o=()=>{s||(r.log("%s drain channel closed before drain",e),i.resolve())};n.addEventListener("close",o,{once:!0}),n.addEventListener("bufferedamountlow",()=>{s=!0,n.removeEventListener("close",o),i.resolve()}),await Th(i.promise,{milliseconds:t})}}).then(async()=>{n.readyState==="open"&&n.close()}).catch(i=>{r.log.error("error closing outbound stream",i)})}async function $4(n){return n=n??{},typeof n=="function"&&(n=await n()),n.iceServers=n.iceServers??sL.map(e=>({urls:[e]})),n}const bL=(n=32)=>oL+[...Array(n)].map(()=>M4.at(Math.floor(Math.random()*M4.length))).join("");class V0{constructor(e,t){l(this,"log");l(this,"peerConnection");l(this,"remoteAddr");l(this,"timeline");l(this,"metrics");l(this,"source",Cb());l(this,"sink",Tb);this.log=e.logger.forComponent("libp2p:webrtc:maconn"),this.remoteAddr=t.remoteAddr,this.timeline=t.timeline,this.peerConnection=t.peerConnection;const r=this.peerConnection,i=r.connectionState;this.peerConnection.onconnectionstatechange=()=>{this.log.trace("peer connection state change",r.connectionState,"initial state",i),(r.connectionState==="disconnected"||r.connectionState==="failed"||r.connectionState==="closed")&&(this.timeline.close=Date.now())}}async close(e){var t;this.log.trace("closing connection"),this.peerConnection.close(),this.timeline.close=Date.now(),(t=this.metrics)==null||t.increment({close:!0})}abort(e){var t;this.log.error("closing connection due to error",e),this.peerConnection.close(),this.timeline.close=Date.now(),(t=this.metrics)==null||t.increment({abort:!0})}}class vL extends Cg{constructor(t){const r=t.onEnd;t.onEnd=s=>{this.log.trace('readable and writeable ends closed with status "%s"',this.status),Promise.resolve(async()=>{if(!(this.timeline.abort!=null||this.timeline.reset!==null))try{await Th(this.receiveFinAck.promise,{milliseconds:this.finAckTimeout})}catch(o){this.log.error("error receiving FIN_ACK",o)}}).then(()=>{this.incomingData.end(),r==null||r(s)}).catch(o=>{this.log.error("error ending stream",o)}).finally(()=>{this.channel.close()})};super(t);l(this,"channel");l(this,"incomingData");l(this,"maxBufferedAmount");l(this,"bufferedAmountLowEventTimeout");l(this,"maxMessageSize");l(this,"receiveFinAck");l(this,"finAckTimeout");l(this,"openTimeout");l(this,"closeController");switch(this.channel=t.channel,this.channel.binaryType="arraybuffer",this.incomingData=cn(),this.bufferedAmountLowEventTimeout=t.bufferedAmountLowEventTimeout??lL,this.maxBufferedAmount=t.maxBufferedAmount??cL,this.maxMessageSize=(t.maxMessageSize??i1)-dL,this.receiveFinAck=ve(),this.finAckTimeout=t.closeTimeout??hL,this.openTimeout=t.openTimeout??fL,this.closeController=new AbortController,this.channel.readyState){case"open":this.timeline.open=new Date().getTime();break;case"closed":case"closing":(this.timeline.close===void 0||this.timeline.close===0)&&(this.timeline.close=Date.now());break;case"connecting":break;default:throw this.log.error("unknown datachannel state %s",this.channel.readyState),new zu("Unknown datachannel state")}this.channel.onopen=s=>{this.timeline.open=new Date().getTime()},this.channel.onclose=s=>{this.log.trace("received onclose event"),this.closeController.abort(),this.receiveFinAck.resolve(),this.close().catch(o=>{this.log.error("error closing stream after channel closed",o)})},this.channel.onerror=s=>{this.log.trace("received onerror event"),this.closeController.abort();const o=s.error;this.abort(o)},this.channel.onmessage=async s=>{const{data:o}=s;o===null||o.byteLength===0||this.incomingData.push(new Uint8Array(o,0,o.byteLength))};const i=this;Promise.resolve().then(async()=>{for await(const s of kc(this.incomingData)){const o=i.processIncomingProtobuf(s);o!=null&&i.sourcePush(new Ee(o))}}).catch(s=>{this.log.error("error processing incoming data channel messages",s)})}sendNewStream(){}async _sendMessage(t,r=!0){if(this.channel.readyState==="closed"||this.channel.readyState==="closing")throw new zu(`Invalid datachannel state - ${this.channel.readyState}`);if(this.channel.readyState!=="open"){const i=AbortSignal.timeout(this.openTimeout),s=Le([this.closeController.signal,i]);try{this.log('channel state is "%s" and not "open", waiting for "open" event before sending data',this.channel.readyState),await Vt(this.channel,"open",s)}finally{s.clear()}this.log('channel state is now "%s", sending data',this.channel.readyState)}if(r&&this.channel.bufferedAmount>this.maxBufferedAmount){const i=AbortSignal.timeout(this.bufferedAmountLowEventTimeout),s=Le([this.closeController.signal,i]);try{this.log('channel buffer is %d, wait for "bufferedamountlow" event',this.channel.bufferedAmount),await Vt(this.channel,"bufferedamountlow",s)}catch(o){throw i.aborted?new ll(`Timed out waiting for DataChannel buffer to clear after ${this.bufferedAmountLowEventTimeout}ms`):o}finally{s.clear()}}try{this.log.trace('sending message, channel state "%s"',this.channel.readyState),this.channel.send(t.subarray())}catch(i){this.log.error("error while sending message",i)}}async sendData(t){const r=t.byteLength;for(t=t.sublist();t.byteLength>0;){const i=Math.min(t.byteLength,this.maxMessageSize),s=t.subarray(0,i),o=Xt.encode({message:s}),a=Ac.single(o);this.log.trace("sending %d/%d bytes on channel",s.byteLength,r),await this._sendMessage(a),t.consume(i)}this.log.trace('finished sending data, channel state "%s"',this.channel.readyState)}async sendReset(){try{await this._sendFlag(Xt.Flag.RESET)}catch(t){this.log.error("failed to send reset - %e",t)}finally{this.channel.close()}}async sendCloseWrite(t){if(this.channel.readyState!=="open"){this.receiveFinAck.resolve();return}if(await this._sendFlag(Xt.Flag.FIN)){this.log.trace("awaiting FIN_ACK");try{await yt(this.receiveFinAck.promise,t==null?void 0:t.signal,{errorMessage:"sending close-write was aborted before FIN_ACK was received",errorName:"FinAckNotReceivedError"})}catch(i){this.log.error("failed to await FIN_ACK",i)}}else this.log.trace("sending FIN failed, not awaiting FIN_ACK");this.receiveFinAck.resolve()}async sendCloseRead(){this.channel.readyState==="open"&&await this._sendFlag(Xt.Flag.STOP_SENDING)}processIncomingProtobuf(t){const r=Xt.decode(t);if(r.flag!==void 0&&(this.log.trace('incoming flag %s, write status "%s", read status "%s"',r.flag,this.writeStatus,this.readStatus),r.flag===Xt.Flag.FIN&&(this.remoteCloseWrite(),this.log.trace("sending FIN_ACK"),this._sendFlag(Xt.Flag.FIN_ACK).catch(i=>{this.log.error("error sending FIN_ACK immediately",i)})),r.flag===Xt.Flag.RESET&&this.reset(),r.flag===Xt.Flag.STOP_SENDING&&this.remoteCloseRead(),r.flag===Xt.Flag.FIN_ACK&&(this.log.trace("received FIN_ACK"),this.receiveFinAck.resolve())),this.readStatus==="ready")return r.message}async _sendFlag(t){if(this.channel.readyState!=="open")return this.log.trace('not sending flag %s because channel is "%s" and not "open"',t.toString(),this.channel.readyState),!1;this.log.trace("sending flag %s",t.toString());const r=Xt.encode({flag:t}),i=Ac.single(r);try{return await this._sendMessage(i,!1),!0}catch(s){this.log.error("could not send flag %s - %e",t.toString(),s)}return!1}}function kd(n){const{channel:e,direction:t,handshake:r}=n;return new vL({...n,id:`${e.id}`,log:n.log.newScope(`${r===!0?"handshake":t}:${e.id}`)})}class Lg{constructor(e,t){l(this,"protocol");l(this,"peerConnection");l(this,"bufferedStreams",[]);l(this,"metrics");l(this,"dataChannelOptions");l(this,"components");l(this,"log");this.components=e,this.peerConnection=t.peerConnection,this.metrics=t.metrics,this.protocol=t.protocol??Ib,this.dataChannelOptions=t.dataChannelOptions??{},this.log=e.logger.forComponent("libp2p:webrtc:muxerfactory"),this.peerConnection.ondatachannel=({channel:r})=>{if(this.log.trace('incoming early datachannel with channel id %d and label "%s"',r.id),r.label==="init"){this.log.trace("closing early init channel"),r.close();return}const i={},s=kd({channel:r,direction:"inbound",onEnd:o=>{i.onEnd(o)},log:this.log,...this.dataChannelOptions});i.stream=s,i.channel=r,i.onEnd=()=>{this.bufferedStreams=this.bufferedStreams.filter(o=>o.stream.id!==s.id)},this.bufferedStreams.push(i)}}createStreamMuxer(e){return new SL(this.components,{...e,peerConnection:this.peerConnection,dataChannelOptions:this.dataChannelOptions,metrics:this.metrics,streams:this.bufferedStreams,protocol:this.protocol})}}var Ko,Tu;class SL{constructor(e,t){pe(this,Ko);l(this,"init");l(this,"streams");l(this,"protocol");l(this,"log");l(this,"peerConnection");l(this,"dataChannelOptions");l(this,"metrics");l(this,"logger");l(this,"source",Cb());l(this,"sink",Tb);var r;this.init=t,this.log=((r=t.log)==null?void 0:r.newScope("muxer"))??e.logger.forComponent("libp2p:webrtc:muxer"),this.logger=e.logger,this.streams=t.streams.map(i=>i.stream),this.peerConnection=t.peerConnection,this.protocol=t.protocol??Ib,this.metrics=t.metrics,this.dataChannelOptions=t.dataChannelOptions??{},this.peerConnection.ondatachannel=({channel:i})=>{var a,c;if(this.log.trace("incoming datachannel with channel id %d",i.id),i.label==="init"){this.log.trace("closing init channel"),i.close();return}const s=i.id,o=kd({channel:i,direction:"inbound",onEnd:()=>{D(this,Ko,Tu).call(this,o,i),this.log("incoming channel %s ended",s)},log:this.log,...this.dataChannelOptions});this.streams.push(o),(a=this.metrics)==null||a.increment({incoming_stream:!0}),(c=t==null?void 0:t.onIncomingStream)==null||c.call(t,o)},this.init.streams.length>0&&queueMicrotask(()=>{this.init.streams.forEach(i=>{var s,o,a;i.onEnd=()=>{this.log("incoming early channel %s ended with state %s",i.channel.id,i.channel.readyState),D(this,Ko,Tu).call(this,i.stream,i.channel)},(s=this.metrics)==null||s.increment({incoming_stream:!0}),(a=(o=this.init)==null?void 0:o.onIncomingStream)==null||a.call(o,i.stream)})})}async close(e){try{await Promise.all(this.streams.map(async t=>t.close(e)))}catch(t){this.abort(t)}}abort(e){for(const t of this.streams)t.abort(e)}newStream(){var i;const e=this.peerConnection.createDataChannel(""),t=e.id;this.log.trace("opened outgoing datachannel with channel id %s",t);const r=kd({channel:e,direction:"outbound",onEnd:()=>{D(this,Ko,Tu).call(this,r,e),this.log("outgoing channel %s ended",t)},log:this.log,...this.dataChannelOptions});return this.streams.push(r),(i=this.metrics)==null||i.increment({outgoing_stream:!0}),r}}Ko=new WeakSet,Tu=function(e,t){var r,i,s;this.log.trace("stream %s %s %s onEnd",e.direction,e.id,e.protocol),wL(t,`${e.direction} ${e.id} ${e.protocol}`,this.dataChannelOptions.drainTimeout,{log:this.log}),this.streams=this.streams.filter(o=>o.id!==e.id),(r=this.metrics)==null||r.increment({stream_end:!0}),(s=(i=this.init)==null?void 0:i.onStreamEnd)==null||s.call(i,e)};const Rb=globalThis.RTCPeerConnection,Pb=globalThis.RTCSessionDescription,EL=globalThis.RTCIceCandidate;class bl extends Error{constructor(e){super(`WebRTC transport error: ${e}`),this.name="WebRTCTransportError"}}class Bi extends bl{constructor(e="SDP handshake failed"){super(e),this.name="SDPHandshakeFailedError"}}class xL extends bl{constructor(e,t){super(`Invalid fingerprint "${e}" within ${t}`),this.name="WebRTC/InvalidFingerprintError"}}class AL extends bl{constructor(e){super(`A method (${e}) was called though it has been intentionally left unimplemented.`),this.name="WebRTC/UnimplementedError"}}class kL extends bl{constructor(e){super(`unsupported hash algorithm code: ${e} please see the codes at https://github.com/multiformats/multicodec/blob/master/table.csv `),this.name="WebRTC/UnsupportedHashAlgorithmError"}}var Xr;(function(n){(function(r){r.SDP_OFFER="SDP_OFFER",r.SDP_ANSWER="SDP_ANSWER",r.ICE_CANDIDATE="ICE_CANDIDATE"})(n.Type||(n.Type={}));let e;(function(r){r[r.SDP_OFFER=0]="SDP_OFFER",r[r.SDP_ANSWER=1]="SDP_ANSWER",r[r.ICE_CANDIDATE=2]="ICE_CANDIDATE"})(e||(e={})),function(r){r.codec=()=>Wt(e)}(n.Type||(n.Type={}));let t;n.codec=()=>(t==null&&(t=me((r,i,s={})=>{s.lengthDelimited!==!1&&i.fork(),r.type!=null&&(i.uint32(8),n.Type.codec().encode(r.type,i)),r.data!=null&&(i.uint32(18),i.string(r.data)),s.lengthDelimited!==!1&&i.ldelim()},(r,i,s={})=>{const o={},a=i==null?r.len:r.pos+i;for(;r.pos<a;){const c=r.uint32();switch(c>>>3){case 1:{o.type=n.Type.codec().decode(r);break}case 2:{o.data=r.string();break}default:{r.skipType(c&7);break}}}return o})),t),n.encode=r=>ye(r,n.codec()),n.decode=(r,i)=>we(r,n.codec(),i)})(Xr||(Xr={}));const Ob=async(n,e,t)=>{var r,i,s,o;try{const a=ve();for(_L(n,a);;){const c=await Promise.race([a.promise,e.read({signal:t.signal}).catch(()=>{})]);if(c==null){(r=t.signal)==null||r.throwIfAborted();break}if(c.type!==Xr.Type.ICE_CANDIDATE)throw new qe("ICE candidate message expected");const u=JSON.parse(c.data??"null");if(u===""||u===null){(i=t.onProgress)==null||i.call(t,new N("webrtc:end-of-ice-candidates")),t.log.trace("end-of-candidates received");continue}const d=new EL(u);t.log.trace("%s received new ICE candidate %o",t.direction,u);try{(s=t.onProgress)==null||s.call(t,new N("webrtc:add-ice-candidate",d.candidate)),await n.addIceCandidate(d)}catch(h){t.log.error("%s bad candidate received",t.direction,u,h)}}}catch(a){if(t.log.error("%s error parsing ICE candidate",t.direction,a),((o=t.signal)==null?void 0:o.aborted)===!0&&Bg(n)!=="connected")throw a}};function Bg(n){return Ng?n.iceConnectionState:n.connectionState}function _L(n,e){n[Ng?"oniceconnectionstatechange":"onconnectionstatechange"]=t=>{switch(Bg(n)){case"connected":e.resolve();break;case"failed":case"disconnected":case"closed":e.reject(new bh("RTCPeerConnection was closed"));break}}}async function IL({rtcConfiguration:n,dataChannel:e,signal:t,metrics:r,multiaddr:i,connectionManager:s,transportManager:o,log:a,logger:c,onProgress:u}){const{circuitAddress:d,targetPeer:h}=RL(i);r==null||r.dialerEvents.increment({open:!0}),a.trace("dialing circuit address: %a",d);const f=s.getConnections(h);let p;f.length===0?(u==null||u(new N("webrtc:dial-relay")),p=await o.dial(d,{signal:t,onProgress:u})):(u==null||u(new N("webrtc:reuse-relay-connection")),p=f[0]),u==null||u(new N("webrtc:open-signaling-stream"));const m=await p.newStream(H0,{signal:t,runOnLimitedConnection:!0}),w=Mt(m).pb(Xr),b=new Rb(n),S=new Lg({logger:c},{peerConnection:b,dataChannelOptions:e});try{const k=b.createDataChannel("init");b.onicecandidate=({candidate:T})=>{const Y=JSON.stringify((T==null?void 0:T.toJSON())??null);a.trace("initiator sending ICE candidate %o",T),w.write({type:Xr.Type.ICE_CANDIDATE,data:Y},{signal:t}).catch(se=>{a.error("error sending ICE candidate",se)})},b.onicecandidateerror=T=>{a.error("initiator ICE candidate error",T)};const C=await b.createOffer().catch(T=>{throw a.error("could not execute createOffer",T),new Bi("Failed to set createOffer")});a.trace("initiator send SDP offer %s",C.sdp),u==null||u(new N("webrtc:send-sdp-offer")),await w.write({type:Xr.Type.SDP_OFFER,data:C.sdp},{signal:t}),await b.setLocalDescription(C).catch(T=>{throw a.error("could not execute setLocalDescription",T),new Bi("Failed to set localDescription")}),u==null||u(new N("webrtc:read-sdp-answer")),a.trace("initiator read SDP answer");const Q=await w.read({signal:t});if(Q.type!==Xr.Type.SDP_ANSWER)throw new Bi("Remote should send an SDP answer");a.trace("initiator received SDP answer %s",Q.data);const re=new Pb({type:"answer",sdp:Q.data});return await b.setRemoteDescription(re).catch(T=>{throw a.error("could not execute setRemoteDescription",T),new Bi("Failed to set remoteDescription")}),a.trace("initiator read candidates until connected"),u==null||u(new N("webrtc:read-ice-candidates")),await Ob(b,w,{direction:"initiator",signal:t,log:a,onProgress:u}),a.trace("initiator connected, closing init channel"),k.close(),u==null||u(new N("webrtc:close-signaling-stream")),a.trace("closing signaling channel"),await m.close({signal:t}),a.trace("initiator connected to remote address %s",i),{remoteAddress:i,peerConnection:b,muxerFactory:S}}catch(k){throw a.error("outgoing signaling error",k),b.close(),m.abort(k),k}finally{b.onicecandidate=null,b.onicecandidateerror=null}}const H4=He(q7.matchers[0],Ke(il));class Mg extends ot{constructor(t,r){super();l(this,"transportManager");l(this,"shutdownController");l(this,"events");this.transportManager=t.transportManager,this.events=t.events,this.shutdownController=r.shutdownController,this.onTransportListening=this.onTransportListening.bind(this)}async listen(){this.events.addEventListener("transport:listening",this.onTransportListening)}onTransportListening(t){t.detail.getAddrs().filter(i=>H4.exactMatch(i)).map(i=>i.encapsulate("/webrtc")).length>0&&this.safeDispatchEvent("listening")}getAddrs(){return this.transportManager.getListeners().filter(t=>!(t instanceof Mg)).map(t=>t.getAddrs().filter(r=>H4.exactMatch(r)).map(r=>r.encapsulate("/webrtc"))).flat()}updateAnnounceAddrs(){}async close(){this.events.removeEventListener("transport:listening",this.onTransportListening),this.shutdownController.abort(),queueMicrotask(()=>{this.safeDispatchEvent("close")})}}async function CL({peerConnection:n,stream:e,signal:t,connection:r,log:i}){i.trace("new inbound signaling stream");const s=Mt(e).pb(Xr);try{n.onicecandidate=({candidate:d})=>{const h=JSON.stringify((d==null?void 0:d.toJSON())??null);i.trace("recipient sending ICE candidate %s",h),s.write({type:Xr.Type.ICE_CANDIDATE,data:h},{signal:t}).catch(f=>{i.error("error sending ICE candidate",f)})},i.trace("recipient read SDP offer");const a=await s.read({signal:t});if(a.type!==Xr.Type.SDP_OFFER)throw new Bi(`expected message type SDP_OFFER, received: ${a.type??"undefined"} `);i.trace("recipient received SDP offer %s",a.data);const c=new Pb({type:"offer",sdp:a.data});await n.setRemoteDescription(c).catch(d=>{throw i.error("could not execute setRemoteDescription",d),new Bi("Failed to set remoteDescription")});const u=await n.createAnswer().catch(d=>{throw i.error("could not execute createAnswer",d),new Bi("Failed to create answer")});i.trace("recipient send SDP answer %s",u.sdp),await s.write({type:Xr.Type.SDP_ANSWER,data:u.sdp},{signal:t}),await n.setLocalDescription(u).catch(d=>{throw i.error("could not execute setLocalDescription",d),new Bi("Failed to set localDescription")}),i.trace("recipient read candidates until connected"),await Ob(n,s,{direction:"recipient",signal:t,log:i})}catch(a){if(Bg(n)!=="connected")throw i.error("error while handling signaling stream from peer %a",r.remoteAddr,a),n.close(),a;i("error while handling signaling stream from peer %a, ignoring as the RTCPeerConnection is already connected",r.remoteAddr,a)}const o=fe(`/webrtc/p2p/${r.remoteAddr.getPeerId()}`);return i.trace("recipient connected to remote address %s",o),{remoteAddress:o}}var U6,F6,$6,H6;H6=wh,$6=Symbol.toStringTag,F6=kt,U6=Ps;class TL{constructor(e,t={}){l(this,"components");l(this,"init");l(this,"log");l(this,"_started",!1);l(this,"metrics");l(this,"shutdownController");l(this,H6,!0);l(this,$6,"@libp2p/webrtc");l(this,F6,["@libp2p/transport"]);l(this,U6,["@libp2p/identify","@libp2p/circuit-relay-v2-transport"]);this.components=e,this.init=t,this.log=e.logger.forComponent("libp2p:webrtc"),this.shutdownController=new AbortController,this.shutdownController.signal,e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webrtc_dialer_events_total",{label:"event",help:"Total count of WebRTC dialer events by type"}),listenerEvents:e.metrics.registerCounterGroup("libp2p_webrtc_listener_events_total",{label:"event",help:"Total count of WebRTC listener events by type"})})}isStarted(){return this._started}async start(){await this.components.registrar.handle(H0,e=>{const t=this.components.upgrader.createInboundAbortSignal(this.shutdownController.signal);this._onProtocol(e,t).catch(r=>{this.log.error("failed to handle incoming connect from %p",e.connection.remotePeer,r)}).finally(()=>{t.clear()})},{runOnLimitedConnection:!0}),this._started=!0}async stop(){await this.components.registrar.unhandle(H0),this._started=!1}createListener(e){return new Mg(this.components,{shutdownController:this.shutdownController})}listenFilter(e){return e.filter(d0.exactMatch)}dialFilter(e){return this.listenFilter(e)}async dial(e,t){var c;this.log.trace("dialing address: %a",e);const{remoteAddress:r,peerConnection:i,muxerFactory:s}=await IL({rtcConfiguration:await $4(this.init.rtcConfiguration),dataChannel:this.init.dataChannel,multiaddr:e,dataChannelOptions:this.init.dataChannel,signal:t.signal,connectionManager:this.components.connectionManager,transportManager:this.components.transportManager,log:this.log,logger:this.components.logger,onProgress:t.onProgress}),o=new V0(this.components,{peerConnection:i,timeline:{open:Date.now()},remoteAddr:r,metrics:(c=this.metrics)==null?void 0:c.dialerEvents}),a=await t.upgrader.upgradeOutbound(o,{skipProtection:!0,skipEncryption:!0,muxerFactory:s,onProgress:t.onProgress,signal:t.signal});return this._closeOnShutdown(i,o),a}async _onProtocol({connection:e,stream:t},r){var o;const i=new Rb(await $4(this.init.rtcConfiguration)),s=new Lg(this.components,{peerConnection:i,dataChannelOptions:this.init.dataChannel});try{const{remoteAddress:a}=await CL({peerConnection:i,connection:e,stream:t,signal:r,log:this.log});await t.close({signal:r});const c=new V0(this.components,{peerConnection:i,timeline:{open:new Date().getTime()},remoteAddr:a,metrics:(o=this.metrics)==null?void 0:o.listenerEvents});await this.components.upgrader.upgradeInbound(c,{skipEncryption:!0,skipProtection:!0,muxerFactory:s,signal:r}),this._closeOnShutdown(i,c)}catch(a){throw this.log.error("incoming signaling error",a),i.close(),t.abort(a),a}}_closeOnShutdown(e,t){const r=()=>{t.close().catch(i=>{this.log.error("could not close WebRTCMultiaddrConnection",i)})};this.shutdownController.signal.addEventListener("abort",r),e.addEventListener("close",()=>{this.shutdownController.signal.removeEventListener("abort",r)})}}function RL(n){const e=n.getComponents().filter(({name:r})=>r==="p2p").map(({value:r})=>r).pop();if(e==null)throw new O("Destination peer id was missing");return{circuitAddress:fe(n.getComponents().filter(({name:r})=>r!=="webrtc")),targetPeer:Ur(e)}}/*! *****************************************************************************
Copyright (C) Microsoft. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */var V4;(function(n){(function(e){var t=typeof globalThis=="object"?globalThis:typeof Xf=="object"?Xf:typeof self=="object"?self:typeof this=="object"?this:a(),r=i(n);typeof t.Reflect<"u"&&(r=i(t.Reflect,r)),e(r,t),typeof t.Reflect>"u"&&(t.Reflect=n);function i(c,u){return function(d,h){Object.defineProperty(c,d,{configurable:!0,writable:!0,value:h}),u&&u(d,h)}}function s(){try{return Function("return this;")()}catch{}}function o(){try{return(0,eval)("(function() { return this; })()")}catch{}}function a(){return s()||o()}})(function(e,t){var r=Object.prototype.hasOwnProperty,i=typeof Symbol=="function",s=i&&typeof Symbol.toPrimitive<"u"?Symbol.toPrimitive:"@@toPrimitive",o=i&&typeof Symbol.iterator<"u"?Symbol.iterator:"@@iterator",a=typeof Object.create=="function",c={__proto__:[]}instanceof Array,u=!a&&!c,d={create:a?function(){return H1(Object.create(null))}:c?function(){return H1({__proto__:null})}:function(){return H1({})},has:u?function(E,x){return r.call(E,x)}:function(E,x){return x in E},get:u?function(E,x){return r.call(E,x)?E[x]:void 0}:function(E,x){return E[x]}},h=Object.getPrototypeOf(Function),f=typeof Map=="function"&&typeof Map.prototype.entries=="function"?Map:XS(),p=typeof Set=="function"&&typeof Set.prototype.entries=="function"?Set:ZS(),m=typeof WeakMap=="function"?WeakMap:JS(),w=i?Symbol.for("@reflect-metadata:registry"):void 0,b=jS(),S=QS(b);function k(E,x,_,$){if(q(_)){if(!Na(E))throw new TypeError;if(!La(x))throw new TypeError;return V(E,x)}else{if(!Na(E))throw new TypeError;if(!Ce(x))throw new TypeError;if(!Ce($)&&!q($)&&!Ze($))throw new TypeError;return Ze($)&&($=void 0),_=Cr(_),K(E,x,_,$)}}e("decorate",k);function C(E,x){function _($,ue){if(!Ce($))throw new TypeError;if(!q(ue)&&!WS(ue))throw new TypeError;ge(E,x,$,ue)}return _}e("metadata",C);function Q(E,x,_,$){if(!Ce(_))throw new TypeError;return q($)||($=Cr($)),ge(E,x,_,$)}e("defineMetadata",Q);function re(E,x,_){if(!Ce(x))throw new TypeError;return q(_)||(_=Cr(_)),ie(E,x,_)}e("hasMetadata",re);function T(E,x,_){if(!Ce(x))throw new TypeError;return q(_)||(_=Cr(_)),ae(E,x,_)}e("hasOwnMetadata",T);function Y(E,x,_){if(!Ce(x))throw new TypeError;return q(_)||(_=Cr(_)),J(E,x,_)}e("getMetadata",Y);function se(E,x,_){if(!Ce(x))throw new TypeError;return q(_)||(_=Cr(_)),oe(E,x,_)}e("getOwnMetadata",se);function L(E,x){if(!Ce(E))throw new TypeError;return q(x)||(x=Cr(x)),z(E,x)}e("getMetadataKeys",L);function B(E,x){if(!Ce(E))throw new TypeError;return q(x)||(x=Cr(x)),_e(E,x)}e("getOwnMetadataKeys",B);function M(E,x,_){if(!Ce(x))throw new TypeError;if(q(_)||(_=Cr(_)),!Ce(x))throw new TypeError;q(_)||(_=Cr(_));var $=Ba(x,_,!1);return q($)?!1:$.OrdinaryDeleteMetadata(E,x,_)}e("deleteMetadata",M);function V(E,x){for(var _=E.length-1;_>=0;--_){var $=E[_],ue=$(x);if(!q(ue)&&!Ze(ue)){if(!La(ue))throw new TypeError;x=ue}}return x}function K(E,x,_,$){for(var ue=E.length-1;ue>=0;--ue){var nt=E[ue],ht=nt(x,_,$);if(!q(ht)&&!Ze(ht)){if(!Ce(ht))throw new TypeError;$=ht}}return $}function ie(E,x,_){var $=ae(E,x,_);if($)return!0;var ue=$1(x);return Ze(ue)?!1:ie(E,ue,_)}function ae(E,x,_){var $=Ba(x,_,!1);return q($)?!1:Ir($.OrdinaryHasOwnMetadata(E,x,_))}function J(E,x,_){var $=ae(E,x,_);if($)return oe(E,x,_);var ue=$1(x);if(!Ze(ue))return J(E,ue,_)}function oe(E,x,_){var $=Ba(x,_,!1);if(!q($))return $.OrdinaryGetOwnMetadata(E,x,_)}function ge(E,x,_,$){var ue=Ba(_,$,!0);ue.OrdinaryDefineOwnMetadata(E,x,_,$)}function z(E,x){var _=_e(E,x),$=$1(E);if($===null)return _;var ue=z($,x);if(ue.length<=0)return _;if(_.length<=0)return ue;for(var nt=new p,ht=[],be=0,W=_;be<W.length;be++){var Z=W[be],te=nt.has(Z);te||(nt.add(Z),ht.push(Z))}for(var ne=0,xe=ue;ne<xe.length;ne++){var Z=xe[ne],te=nt.has(Z);te||(nt.add(Z),ht.push(Z))}return ht}function _e(E,x){var _=Ba(E,x,!1);return _?_.OrdinaryOwnMetadataKeys(E,x):[]}function Ve(E){if(E===null)return 1;switch(typeof E){case"undefined":return 0;case"boolean":return 2;case"string":return 3;case"symbol":return 4;case"number":return 5;case"object":return E===null?1:6;default:return 6}}function q(E){return E===void 0}function Ze(E){return E===null}function Hr(E){return typeof E=="symbol"}function Ce(E){return typeof E=="object"?E!==null:typeof E=="function"}function kr(E,x){switch(Ve(E)){case 0:return E;case 1:return E;case 2:return E;case 3:return E;case 4:return E;case 5:return E}var _="string",$=D3(E,s);if($!==void 0){var ue=$.call(E,_);if(Ce(ue))throw new TypeError;return ue}return _r(E)}function _r(E,x){var _,$,ue;{var nt=E.toString;if(as(nt)){var $=nt.call(E);if(!Ce($))return $}var _=E.valueOf;if(as(_)){var $=_.call(E);if(!Ce($))return $}}throw new TypeError}function Ir(E){return!!E}function Vr(E){return""+E}function Cr(E){var x=kr(E);return Hr(x)?x:Vr(x)}function Na(E){return Array.isArray?Array.isArray(E):E instanceof Object?E instanceof Array:Object.prototype.toString.call(E)==="[object Array]"}function as(E){return typeof E=="function"}function La(E){return typeof E=="function"}function WS(E){switch(Ve(E)){case 3:return!0;case 4:return!0;default:return!1}}function F1(E,x){return E===x||E!==E&&x!==x}function D3(E,x){var _=E[x];if(_!=null){if(!as(_))throw new TypeError;return _}}function N3(E){var x=D3(E,o);if(!as(x))throw new TypeError;var _=x.call(E);if(!Ce(_))throw new TypeError;return _}function L3(E){return E.value}function B3(E){var x=E.next();return x.done?!1:x}function M3(E){var x=E.return;x&&x.call(E)}function $1(E){var x=Object.getPrototypeOf(E);if(typeof E!="function"||E===h||x!==h)return x;var _=E.prototype,$=_&&Object.getPrototypeOf(_);if($==null||$===Object.prototype)return x;var ue=$.constructor;return typeof ue!="function"||ue===E?x:ue}function GS(){var E;!q(w)&&typeof t.Reflect<"u"&&!(w in t.Reflect)&&typeof t.Reflect.defineMetadata=="function"&&(E=YS(t.Reflect));var x,_,$,ue=new m,nt={registerProvider:ht,getProvider:W,setProvider:te};return nt;function ht(ne){if(!Object.isExtensible(nt))throw new Error("Cannot add provider to a frozen registry.");switch(!0){case E===ne:break;case q(x):x=ne;break;case x===ne:break;case q(_):_=ne;break;case _===ne:break;default:$===void 0&&($=new p),$.add(ne);break}}function be(ne,xe){if(!q(x)){if(x.isProviderFor(ne,xe))return x;if(!q(_)){if(_.isProviderFor(ne,xe))return x;if(!q($))for(var We=N3($);;){var it=B3(We);if(!it)return;var zr=L3(it);if(zr.isProviderFor(ne,xe))return M3(We),zr}}}if(!q(E)&&E.isProviderFor(ne,xe))return E}function W(ne,xe){var We=ue.get(ne),it;return q(We)||(it=We.get(xe)),q(it)&&(it=be(ne,xe),q(it)||(q(We)&&(We=new f,ue.set(ne,We)),We.set(xe,it))),it}function Z(ne){if(q(ne))throw new TypeError;return x===ne||_===ne||!q($)&&$.has(ne)}function te(ne,xe,We){if(!Z(We))throw new Error("Metadata provider not registered.");var it=W(ne,xe);if(it!==We){if(!q(it))return!1;var zr=ue.get(ne);q(zr)&&(zr=new f,ue.set(ne,zr)),zr.set(xe,We)}return!0}}function jS(){var E;return!q(w)&&Ce(t.Reflect)&&Object.isExtensible(t.Reflect)&&(E=t.Reflect[w]),q(E)&&(E=GS()),!q(w)&&Ce(t.Reflect)&&Object.isExtensible(t.Reflect)&&Object.defineProperty(t.Reflect,w,{enumerable:!1,configurable:!1,writable:!1,value:E}),E}function QS(E){var x=new m,_={isProviderFor:function(Z,te){var ne=x.get(Z);return q(ne)?!1:ne.has(te)},OrdinaryDefineOwnMetadata:ht,OrdinaryHasOwnMetadata:ue,OrdinaryGetOwnMetadata:nt,OrdinaryOwnMetadataKeys:be,OrdinaryDeleteMetadata:W};return b.registerProvider(_),_;function $(Z,te,ne){var xe=x.get(Z),We=!1;if(q(xe)){if(!ne)return;xe=new f,x.set(Z,xe),We=!0}var it=xe.get(te);if(q(it)){if(!ne)return;if(it=new f,xe.set(te,it),!E.setProvider(Z,te,_))throw xe.delete(te),We&&x.delete(Z),new Error("Wrong provider for target.")}return it}function ue(Z,te,ne){var xe=$(te,ne,!1);return q(xe)?!1:Ir(xe.has(Z))}function nt(Z,te,ne){var xe=$(te,ne,!1);if(!q(xe))return xe.get(Z)}function ht(Z,te,ne,xe){var We=$(ne,xe,!0);We.set(Z,te)}function be(Z,te){var ne=[],xe=$(Z,te,!1);if(q(xe))return ne;for(var We=xe.keys(),it=N3(We),zr=0;;){var U3=B3(it);if(!U3)return ne.length=zr,ne;var eE=L3(U3);try{ne[zr]=eE}catch(tE){try{M3(it)}finally{throw tE}}zr++}}function W(Z,te,ne){var xe=$(te,ne,!1);if(q(xe)||!xe.delete(Z))return!1;if(xe.size===0){var We=x.get(te);q(We)||(We.delete(ne),We.size===0&&x.delete(We))}return!0}}function YS(E){var x=E.defineMetadata,_=E.hasOwnMetadata,$=E.getOwnMetadata,ue=E.getOwnMetadataKeys,nt=E.deleteMetadata,ht=new m,be={isProviderFor:function(W,Z){var te=ht.get(W);return!q(te)&&te.has(Z)?!0:ue(W,Z).length?(q(te)&&(te=new p,ht.set(W,te)),te.add(Z),!0):!1},OrdinaryDefineOwnMetadata:x,OrdinaryHasOwnMetadata:_,OrdinaryGetOwnMetadata:$,OrdinaryOwnMetadataKeys:ue,OrdinaryDeleteMetadata:nt};return be}function Ba(E,x,_){var $=b.getProvider(E,x);if(!q($))return $;if(_){if(b.setProvider(E,x,S))return S;throw new Error("Illegal state.")}}function XS(){var E={},x=[],_=function(){function be(W,Z,te){this._index=0,this._keys=W,this._values=Z,this._selector=te}return be.prototype["@@iterator"]=function(){return this},be.prototype[o]=function(){return this},be.prototype.next=function(){var W=this._index;if(W>=0&&W<this._keys.length){var Z=this._selector(this._keys[W],this._values[W]);return W+1>=this._keys.length?(this._index=-1,this._keys=x,this._values=x):this._index++,{value:Z,done:!1}}return{value:void 0,done:!0}},be.prototype.throw=function(W){throw this._index>=0&&(this._index=-1,this._keys=x,this._values=x),W},be.prototype.return=function(W){return this._index>=0&&(this._index=-1,this._keys=x,this._values=x),{value:W,done:!0}},be}(),$=function(){function be(){this._keys=[],this._values=[],this._cacheKey=E,this._cacheIndex=-2}return Object.defineProperty(be.prototype,"size",{get:function(){return this._keys.length},enumerable:!0,configurable:!0}),be.prototype.has=function(W){return this._find(W,!1)>=0},be.prototype.get=function(W){var Z=this._find(W,!1);return Z>=0?this._values[Z]:void 0},be.prototype.set=function(W,Z){var te=this._find(W,!0);return this._values[te]=Z,this},be.prototype.delete=function(W){var Z=this._find(W,!1);if(Z>=0){for(var te=this._keys.length,ne=Z+1;ne<te;ne++)this._keys[ne-1]=this._keys[ne],this._values[ne-1]=this._values[ne];return this._keys.length--,this._values.length--,F1(W,this._cacheKey)&&(this._cacheKey=E,this._cacheIndex=-2),!0}return!1},be.prototype.clear=function(){this._keys.length=0,this._values.length=0,this._cacheKey=E,this._cacheIndex=-2},be.prototype.keys=function(){return new _(this._keys,this._values,ue)},be.prototype.values=function(){return new _(this._keys,this._values,nt)},be.prototype.entries=function(){return new _(this._keys,this._values,ht)},be.prototype["@@iterator"]=function(){return this.entries()},be.prototype[o]=function(){return this.entries()},be.prototype._find=function(W,Z){if(!F1(this._cacheKey,W)){this._cacheIndex=-1;for(var te=0;te<this._keys.length;te++)if(F1(this._keys[te],W)){this._cacheIndex=te;break}}return this._cacheIndex<0&&Z&&(this._cacheIndex=this._keys.length,this._keys.push(W),this._values.push(void 0)),this._cacheIndex},be}();return $;function ue(be,W){return be}function nt(be,W){return W}function ht(be,W){return[be,W]}}function ZS(){var E=function(){function x(){this._map=new f}return Object.defineProperty(x.prototype,"size",{get:function(){return this._map.size},enumerable:!0,configurable:!0}),x.prototype.has=function(_){return this._map.has(_)},x.prototype.add=function(_){return this._map.set(_,_),this},x.prototype.delete=function(_){return this._map.delete(_)},x.prototype.clear=function(){this._map.clear()},x.prototype.keys=function(){return this._map.keys()},x.prototype.values=function(){return this._map.keys()},x.prototype.entries=function(){return this._map.entries()},x.prototype["@@iterator"]=function(){return this.keys()},x.prototype[o]=function(){return this.keys()},x}();return E}function JS(){var E=16,x=d.create(),_=$();return function(){function W(){this._key=$()}return W.prototype.has=function(Z){var te=ue(Z,!1);return te!==void 0?d.has(te,this._key):!1},W.prototype.get=function(Z){var te=ue(Z,!1);return te!==void 0?d.get(te,this._key):void 0},W.prototype.set=function(Z,te){var ne=ue(Z,!0);return ne[this._key]=te,this},W.prototype.delete=function(Z){var te=ue(Z,!1);return te!==void 0?delete te[this._key]:!1},W.prototype.clear=function(){this._key=$()},W}();function $(){var W;do W="@@WeakMap@@"+be();while(d.has(x,W));return x[W]=!0,W}function ue(W,Z){if(!r.call(W,_)){if(!Z)return;Object.defineProperty(W,_,{value:d.create()})}return W[_]}function nt(W,Z){for(var te=0;te<Z;++te)W[te]=Math.random()*255|0;return W}function ht(W){if(typeof Uint8Array=="function"){var Z=new Uint8Array(W);return typeof crypto<"u"?crypto.getRandomValues(Z):typeof msCrypto<"u"?msCrypto.getRandomValues(Z):nt(Z,W),Z}return nt(new Array(W),W)}function be(){var W=ht(E);W[6]=W[6]&79|64,W[8]=W[8]&191|128;for(var Z="",te=0;te<E;++te){var ne=W[te];(te===4||te===6||te===8)&&(Z+="-"),ne<16&&(Z+="0"),Z+=ne.toString(16).toLowerCase()}return Z}}function H1(E){return E.__=void 0,delete E.__,E}})})(V4||(V4={}));var I;(function(n){n[n.Sequence=0]="Sequence",n[n.Set=1]="Set",n[n.Choice=2]="Choice"})(I||(I={}));var v;(function(n){n[n.Any=1]="Any",n[n.Boolean=2]="Boolean",n[n.OctetString=3]="OctetString",n[n.BitString=4]="BitString",n[n.Integer=5]="Integer",n[n.Enumerated=6]="Enumerated",n[n.ObjectIdentifier=7]="ObjectIdentifier",n[n.Utf8String=8]="Utf8String",n[n.BmpString=9]="BmpString",n[n.UniversalString=10]="UniversalString",n[n.NumericString=11]="NumericString",n[n.PrintableString=12]="PrintableString",n[n.TeletexString=13]="TeletexString",n[n.VideotexString=14]="VideotexString",n[n.IA5String=15]="IA5String",n[n.GraphicString=16]="GraphicString",n[n.VisibleString=17]="VisibleString",n[n.GeneralString=18]="GeneralString",n[n.CharacterString=19]="CharacterString",n[n.UTCTime=20]="UTCTime",n[n.GeneralizedTime=21]="GeneralizedTime",n[n.DATE=22]="DATE",n[n.TimeOfDay=23]="TimeOfDay",n[n.DateTime=24]="DateTime",n[n.Duration=25]="Duration",n[n.TIME=26]="TIME",n[n.Null=27]="Null"})(v||(v={}));class s1{constructor(e,t=0){if(this.unusedBits=0,this.value=new ArrayBuffer(0),e)if(typeof e=="number")this.fromNumber(e);else if(H.isBufferSource(e))this.unusedBits=t,this.value=H.toArrayBuffer(e);else throw TypeError("Unsupported type of 'params' argument for BitString")}fromASN(e){if(!(e instanceof Is))throw new TypeError("Argument 'asn' is not instance of ASN.1 BitString");return this.unusedBits=e.valueBlock.unusedBits,this.value=e.valueBlock.valueHex,this}toASN(){return new Is({unusedBits:this.unusedBits,valueHex:this.value})}toSchema(e){return new Is({name:e})}toNumber(){let e="";const t=new Uint8Array(this.value);for(const r of t)e+=r.toString(2).padStart(8,"0");return e=e.split("").reverse().join(""),this.unusedBits&&(e=e.slice(this.unusedBits).padStart(this.unusedBits,"0")),parseInt(e,2)}fromNumber(e){let t=e.toString(2);const r=t.length+7>>3;this.unusedBits=(r<<3)-t.length;const i=new Uint8Array(r);t=t.padStart(r<<3,"0").split("").reverse().join("");let s=0;for(;s<r;)i[s]=parseInt(t.slice(s<<3,(s<<3)+8),2),s++;this.value=i.buffer}}class Ie{get byteLength(){return this.buffer.byteLength}get byteOffset(){return 0}constructor(e){typeof e=="number"?this.buffer=new ArrayBuffer(e):H.isBufferSource(e)?this.buffer=H.toArrayBuffer(e):Array.isArray(e)?this.buffer=new Uint8Array(e):this.buffer=new ArrayBuffer(0)}fromASN(e){if(!(e instanceof Yr))throw new TypeError("Argument 'asn' is not instance of ASN.1 OctetString");return this.buffer=e.valueBlock.valueHex,this}toASN(){return new Yr({valueHex:this.buffer})}toSchema(e){return new Yr({name:e})}}const PL={fromASN:n=>n instanceof di?null:n.valueBeforeDecodeView,toASN:n=>{if(n===null)return new di;const e=ti(n);if(e.result.error)throw new Error(e.result.error);return e.result}},OL={fromASN:n=>n.valueBlock.valueHexView.byteLength>=4?n.valueBlock.toString():n.valueBlock.valueDec,toASN:n=>new ri({value:+n})},DL={fromASN:n=>n.valueBlock.valueDec,toASN:n=>new Hh({value:n})},je={fromASN:n=>n.valueBlock.valueHexView,toASN:n=>new ri({valueHex:n})},NL={fromASN:n=>n.valueBlock.valueHexView,toASN:n=>new Is({valueHex:n})},LL={fromASN:n=>n.valueBlock.toString(),toASN:n=>new $n({value:n})},BL={fromASN:n=>n.valueBlock.value,toASN:n=>new $h({value:n})},_d={fromASN:n=>n.valueBlock.valueHexView,toASN:n=>new Yr({valueHex:n})},ML={fromASN:n=>new Ie(n.getValue()),toASN:n=>n.toASN()};function $r(n){return{fromASN:e=>e.valueBlock.value,toASN:e=>new n({value:e})}}const Db=$r(bi),UL=$r(Vh),FL=$r(zh),$L=$r(Kh),HL=$r(qh),VL=$r(Wh),zL=$r(Gh),KL=$r(jh),qL=$r(Qh),WL=$r(ml),GL=$r(Yh),jL=$r(Xh),QL={fromASN:n=>n.toDate(),toASN:n=>new yl({valueDate:n})},YL={fromASN:n=>n.toDate(),toASN:n=>new Zh({valueDate:n})},XL={fromASN:()=>null,toASN:()=>new di};function uc(n){switch(n){case v.Any:return PL;case v.BitString:return NL;case v.BmpString:return UL;case v.Boolean:return BL;case v.CharacterString:return jL;case v.Enumerated:return DL;case v.GeneralString:return GL;case v.GeneralizedTime:return YL;case v.GraphicString:return qL;case v.IA5String:return KL;case v.Integer:return OL;case v.Null:return XL;case v.NumericString:return $L;case v.ObjectIdentifier:return LL;case v.OctetString:return _d;case v.PrintableString:return HL;case v.TeletexString:return VL;case v.UTCTime:return QL;case v.UniversalString:return FL;case v.Utf8String:return Db;case v.VideotexString:return zL;case v.VisibleString:return WL;default:return null}}function Xn(n){return typeof n=="function"&&n.prototype?n.prototype.toASN&&n.prototype.fromASN?!0:Xn(n.prototype):!!(n&&typeof n=="object"&&"toASN"in n&&"fromASN"in n)}function Nb(n){var e;if(n){const t=Object.getPrototypeOf(n);return((e=t==null?void 0:t.prototype)===null||e===void 0?void 0:e.constructor)===Array?!0:Nb(t)}return!1}function ZL(n,e){if(!(n&&e)||n.byteLength!==e.byteLength)return!1;const t=new Uint8Array(n),r=new Uint8Array(e);for(let i=0;i<n.byteLength;i++)if(t[i]!==r[i])return!1;return!0}class JL{constructor(){this.items=new WeakMap}has(e){return this.items.has(e)}get(e,t=!1){const r=this.items.get(e);if(!r)throw new Error(`Cannot get schema for '${e.prototype.constructor.name}' target`);if(t&&!r.schema)throw new Error(`Schema '${e.prototype.constructor.name}' doesn't contain ASN.1 schema. Call 'AsnSchemaStorage.cache'.`);return r}cache(e){const t=this.get(e);t.schema||(t.schema=this.create(e,!0))}createDefault(e){const t={type:I.Sequence,items:{}},r=this.findParentSchema(e);return r&&(Object.assign(t,r),t.items=Object.assign({},t.items,r.items)),t}create(e,t){const r=this.items.get(e)||this.createDefault(e),i=[];for(const s in r.items){const o=r.items[s],a=t?s:"";let c;if(typeof o.type=="number"){const d=v[o.type],h=Uw[d];if(!h)throw new Error(`Cannot get ASN1 class by name '${d}'`);c=new h({name:a})}else Xn(o.type)?c=new o.type().toSchema(a):o.optional?this.get(o.type).type===I.Choice?c=new Bs({name:a}):(c=this.create(o.type,!1),c.name=a):c=new Bs({name:a});const u=!!o.optional||o.defaultValue!==void 0;if(o.repeated){c.name="";const d=o.repeated==="set"?kn:lt;c=new d({name:"",value:[new hd({name:a,value:c})]})}if(o.context!==null&&o.context!==void 0)if(o.implicit)if(typeof o.type=="number"||Xn(o.type)){const d=o.repeated?qt:gl;i.push(new d({name:a,optional:u,idBlock:{tagClass:3,tagNumber:o.context}}))}else{this.cache(o.type);const d=!!o.repeated;let h=d?c:this.get(o.type,!0).schema;h="valueBlock"in h?h.valueBlock.value:h.value,i.push(new qt({name:d?"":a,optional:u,idBlock:{tagClass:3,tagNumber:o.context},value:h}))}else i.push(new qt({optional:u,idBlock:{tagClass:3,tagNumber:o.context},value:[c]}));else c.optional=u,i.push(c)}switch(r.type){case I.Sequence:return new lt({value:i,name:""});case I.Set:return new kn({value:i,name:""});case I.Choice:return new Eg({value:i,name:""});default:throw new Error("Unsupported ASN1 type in use")}}set(e,t){return this.items.set(e,t),this}findParentSchema(e){const t=Object.getPrototypeOf(e);return t?this.items.get(t)||this.findParentSchema(t):null}}const pt=new JL,P=n=>e=>{let t;pt.has(e)?t=pt.get(e):(t=pt.createDefault(e),pt.set(e,t)),Object.assign(t,n)},y=n=>(e,t)=>{let r;pt.has(e.constructor)?r=pt.get(e.constructor):(r=pt.createDefault(e.constructor),pt.set(e.constructor,r));const i=Object.assign({},n);if(typeof i.type=="number"&&!i.converter){const s=uc(n.type);if(!s)throw new Error(`Cannot get default converter for property '${t}' of ${e.constructor.name}`);i.converter=s}r.items[t]=i};class Va extends Error{constructor(){super(...arguments),this.schemas=[]}}class eB{static parse(e,t){const r=ti(e);if(r.result.error)throw new Error(r.result.error);return this.fromASN(r.result,t)}static fromASN(e,t){try{if(Xn(t))return new t().fromASN(e);const r=pt.get(t);pt.cache(t);let i=r.schema;const s=this.handleChoiceTypes(e,r,t,i);if(s!=null&&s.result)return s.result;s!=null&&s.targetSchema&&(i=s.targetSchema);const o=this.handleSequenceTypes(e,r,t,i);if(o&&"isManualMapping"in o)return o.result;const a=o,c=new t;return Nb(t)?this.handleArrayTypes(e,r,t):(this.processSchemaItems(r,a,c),c)}catch(r){throw r instanceof Va&&r.schemas.push(t.name),r}}static handleChoiceTypes(e,t,r,i){if(e.constructor===qt&&t.type===I.Choice&&e.idBlock.tagClass===3)for(const s in t.items){const o=t.items[s];if(o.context===e.idBlock.tagNumber&&o.implicit&&typeof o.type=="function"&&pt.has(o.type)){const a=pt.get(o.type);if(a&&a.type===I.Sequence){const c=new lt;if("value"in e.valueBlock&&Array.isArray(e.valueBlock.value)&&"value"in c.valueBlock){c.valueBlock.value=e.valueBlock.value;const u=this.fromASN(c,o.type),d=new r;return d[s]=u,{result:d}}}}}else if(e.constructor===qt&&t.type!==I.Choice){const s=new qt({idBlock:{tagClass:3,tagNumber:e.idBlock.tagNumber},value:t.schema.valueBlock.value});for(const o in t.items)delete e[o];return{targetSchema:s}}return null}static handleSequenceTypes(e,t,r,i){if(t.type===I.Sequence){if(Object.keys(t.items).filter(a=>{const c=t.items[a];return c.optional&&typeof c.type=="function"&&pt.has(c.type)&&pt.get(c.type).type===I.Choice}).length>0&&"value"in e.valueBlock&&Array.isArray(e.valueBlock.value)&&r.name==="CertReqMsg")return this.handleManualMapping(e,t,r);const o=Ni({},e,i);if(!o.verified)throw new Va(`Data does not match to ${r.name} ASN1 schema. ${o.result.error}`);return o}else{const s=Ni({},e,i);if(!s.verified)throw new Va(`Data does not match to ${r.name} ASN1 schema. ${s.result.error}`);return s}}static handleManualMapping(e,t,r){const i=new r,s=e.valueBlock.value,o=Object.keys(t.items);let a=0;for(let c=0;c<o.length;c++){const u=o[c],d=t.items[u];if(a>=s.length)break;if(d.repeated){i[u]=this.processRepeatedField(s,a,d);break}else if(typeof d.type=="number")i[u]=this.processPrimitiveField(s[a],d),a++;else if(this.isOptionalChoiceField(d)){const h=this.processOptionalChoiceField(s[a],d);h.processed&&(i[u]=h.value,a++)}else i[u]=this.fromASN(s[a],d.type),a++}return{result:i,verified:!0,isManualMapping:!0}}static processRepeatedField(e,t,r){let i=e.slice(t);if(i.length===1&&i[0].constructor.name==="Sequence"){const s=i[0];s.valueBlock&&s.valueBlock.value&&Array.isArray(s.valueBlock.value)&&(i=s.valueBlock.value)}if(typeof r.type=="number"){const s=uc(r.type);if(!s)throw new Error(`No converter for ASN.1 type ${r.type}`);return i.filter(o=>o&&o.valueBlock).map(o=>{try{return s.fromASN(o)}catch{return}}).filter(o=>o!==void 0)}else return i.filter(s=>s&&s.valueBlock).map(s=>{try{return this.fromASN(s,r.type)}catch{return}}).filter(s=>s!==void 0)}static processPrimitiveField(e,t){const r=uc(t.type);if(!r)throw new Error(`No converter for ASN.1 type ${t.type}`);return r.fromASN(e)}static isOptionalChoiceField(e){return e.optional&&typeof e.type=="function"&&pt.has(e.type)&&pt.get(e.type).type===I.Choice}static processOptionalChoiceField(e,t){try{return{processed:!0,value:this.fromASN(e,t.type)}}catch(r){if(r instanceof Va&&/Wrong values for Choice type/.test(r.message))return{processed:!1};throw r}}static handleArrayTypes(e,t,r){if(!("value"in e.valueBlock&&Array.isArray(e.valueBlock.value)))throw new Error("Cannot get items from the ASN.1 parsed value. ASN.1 object is not constructed.");const i=t.itemType;if(typeof i=="number"){const s=uc(i);if(!s)throw new Error(`Cannot get default converter for array item of ${r.name} ASN1 schema`);return r.from(e.valueBlock.value,o=>s.fromASN(o))}else return r.from(e.valueBlock.value,s=>this.fromASN(s,i))}static processSchemaItems(e,t,r){for(const i in e.items){const s=t.result[i];if(!s)continue;const o=e.items[i],a=o.type;typeof a=="number"||Xn(a)?r[i]=this.processPrimitiveSchemaItem(s,o,a):r[i]=this.processComplexSchemaItem(s,o,a)}}static processPrimitiveSchemaItem(e,t,r){var i;const s=(i=t.converter)!==null&&i!==void 0?i:Xn(r)?new r:null;if(!s)throw new Error("Converter is empty");return t.repeated?this.processRepeatedPrimitiveItem(e,t,s):this.processSinglePrimitiveItem(e,t,r,s)}static processRepeatedPrimitiveItem(e,t,r){if(t.implicit){const i=t.repeated==="sequence"?lt:kn,s=new i;s.valueBlock=e.valueBlock;const o=ti(s.toBER(!1));if(o.offset===-1)throw new Error(`Cannot parse the child item. ${o.result.error}`);if(!("value"in o.result.valueBlock&&Array.isArray(o.result.valueBlock.value)))throw new Error("Cannot get items from the ASN.1 parsed value. ASN.1 object is not constructed.");const a=o.result.valueBlock.value;return Array.from(a,c=>r.fromASN(c))}else return Array.from(e,i=>r.fromASN(i))}static processSinglePrimitiveItem(e,t,r,i){let s=e;if(t.implicit){let o;if(Xn(r))o=new r().toSchema("");else{const a=v[r],c=Uw[a];if(!c)throw new Error(`Cannot get '${a}' class from asn1js module`);o=new c}o.valueBlock=s.valueBlock,s=ti(o.toBER(!1)).result}return i.fromASN(s)}static processComplexSchemaItem(e,t,r){if(t.repeated){if(!Array.isArray(e))throw new Error("Cannot get list of items from the ASN.1 parsed value. ASN.1 value should be iterable.");return Array.from(e,i=>this.fromASN(i,r))}else{const i=this.handleImplicitTagging(e,t,r);if(this.isOptionalChoiceField(t))try{return this.fromASN(i,r)}catch(s){if(s instanceof Va&&/Wrong values for Choice type/.test(s.message))return;throw s}else return this.fromASN(i,r)}}static handleImplicitTagging(e,t,r){if(t.implicit&&typeof t.context=="number"){const i=pt.get(r);if(i.type===I.Sequence){const s=new lt;if("value"in e.valueBlock&&Array.isArray(e.valueBlock.value)&&"value"in s.valueBlock)return s.valueBlock.value=e.valueBlock.value,s}else if(i.type===I.Set){const s=new kn;if("value"in e.valueBlock&&Array.isArray(e.valueBlock.value)&&"value"in s.valueBlock)return s.valueBlock.value=e.valueBlock.value,s}}return e}}class Ug{static serialize(e){return e instanceof Ct?e.toBER(!1):this.toASN(e).toBER(!1)}static toASN(e){if(e&&typeof e=="object"&&Xn(e))return e.toASN();if(!(e&&typeof e=="object"))throw new TypeError("Parameter 1 should be type of Object.");const t=e.constructor,r=pt.get(t);pt.cache(t);let i=[];if(r.itemType){if(!Array.isArray(e))throw new TypeError("Parameter 1 should be type of Array.");if(typeof r.itemType=="number"){const o=uc(r.itemType);if(!o)throw new Error(`Cannot get default converter for array item of ${t.name} ASN1 schema`);i=e.map(a=>o.toASN(a))}else i=e.map(o=>this.toAsnItem({type:r.itemType},"[]",t,o))}else for(const o in r.items){const a=r.items[o],c=e[o];if(c===void 0||a.defaultValue===c||typeof a.defaultValue=="object"&&typeof c=="object"&&ZL(this.serialize(a.defaultValue),this.serialize(c)))continue;const u=Ug.toAsnItem(a,o,t,c);if(typeof a.context=="number")if(a.implicit)if(!a.repeated&&(typeof a.type=="number"||Xn(a.type))){const d={};d.valueHex=u instanceof di?u.valueBeforeDecodeView:u.valueBlock.toBER(),i.push(new gl({optional:a.optional,idBlock:{tagClass:3,tagNumber:a.context},...d}))}else i.push(new qt({optional:a.optional,idBlock:{tagClass:3,tagNumber:a.context},value:u.valueBlock.value}));else i.push(new qt({optional:a.optional,idBlock:{tagClass:3,tagNumber:a.context},value:[u]}));else a.repeated?i=i.concat(u):i.push(u)}let s;switch(r.type){case I.Sequence:s=new lt({value:i});break;case I.Set:s=new kn({value:i});break;case I.Choice:if(!i[0])throw new Error(`Schema '${t.name}' has wrong data. Choice cannot be empty.`);s=i[0];break}return s}static toAsnItem(e,t,r,i){let s;if(typeof e.type=="number"){const o=e.converter;if(!o)throw new Error(`Property '${t}' doesn't have converter for type ${v[e.type]} in schema '${r.name}'`);if(e.repeated){if(!Array.isArray(i))throw new TypeError("Parameter 'objProp' should be type of Array.");const a=Array.from(i,u=>o.toASN(u)),c=e.repeated==="sequence"?lt:kn;s=new c({value:a})}else s=o.toASN(i)}else if(e.repeated){if(!Array.isArray(i))throw new TypeError("Parameter 'objProp' should be type of Array.");const o=Array.from(i,c=>this.toASN(c)),a=e.repeated==="sequence"?lt:kn;s=new a({value:o})}else s=this.toASN(i);return s}}class Me extends Array{constructor(e=[]){if(typeof e=="number")super(e);else{super();for(const t of e)this.push(t)}}}class F{static serialize(e){return Ug.serialize(e)}static parse(e,t){return eB.parse(e,t)}static toString(e){const t=H.isBufferSource(e)?H.toArrayBuffer(e):F.serialize(e),r=ti(t);if(r.offset===-1)throw new Error(`Cannot decode ASN.1 data. ${r.result.error}`);return r.result.toString()}}class z4{static isIPv4(e){return/^(\d{1,3}\.){3}\d{1,3}$/.test(e)}static parseIPv4(e){const t=e.split(".");if(t.length!==4)throw new Error("Invalid IPv4 address");return t.map(r=>{const i=parseInt(r,10);if(isNaN(i)||i<0||i>255)throw new Error("Invalid IPv4 address part");return i})}static parseIPv6(e){const r=this.expandIPv6(e).split(":");if(r.length!==8)throw new Error("Invalid IPv6 address");return r.reduce((i,s)=>{const o=parseInt(s,16);if(isNaN(o)||o<0||o>65535)throw new Error("Invalid IPv6 address part");return i.push(o>>8&255),i.push(o&255),i},[])}static expandIPv6(e){if(!e.includes("::"))return e;const t=e.split("::");if(t.length>2)throw new Error("Invalid IPv6 address");const r=t[0]?t[0].split(":"):[],i=t[1]?t[1].split(":"):[],s=8-(r.length+i.length);if(s<0)throw new Error("Invalid IPv6 address");return[...r,...Array(s).fill("0"),...i].join(":")}static formatIPv6(e){const t=[];for(let r=0;r<16;r+=2)t.push((e[r]<<8|e[r+1]).toString(16));return this.compressIPv6(t.join(":"))}static compressIPv6(e){const t=e.split(":");let r=-1,i=0,s=-1,o=0;for(let a=0;a<t.length;a++)t[a]==="0"?(s===-1&&(s=a),o++):(o>i&&(r=s,i=o),s=-1,o=0);if(o>i&&(r=s,i=o),i>1){const a=t.slice(0,r).join(":"),c=t.slice(r+i).join(":");return`${a}::${c}`}return e}static parseCIDR(e){const[t,r]=e.split("/"),i=parseInt(r,10);if(this.isIPv4(t)){if(i<0||i>32)throw new Error("Invalid IPv4 prefix length");return[this.parseIPv4(t),i]}else{if(i<0||i>128)throw new Error("Invalid IPv6 prefix length");return[this.parseIPv6(t),i]}}static decodeIP(e){if(e.length===64&&parseInt(e,16)===0)return"::/0";if(e.length!==16)return e;const t=parseInt(e.slice(8),16).toString(2).split("").reduce((i,s)=>i+ +s,0);let r=e.slice(0,8).replace(/(.{2})/g,i=>`${parseInt(i,16)}.`);return r=r.slice(0,-1),`${r}/${t}`}static toString(e){const t=new Uint8Array(e);if(t.length===4)return Array.from(t).join(".");if(t.length===16)return this.formatIPv6(t);if(t.length===8||t.length===32){const r=t.length/2,i=t.slice(0,r),s=t.slice(r);if(t.every(c=>c===0))return t.length===8?"0.0.0.0/0":"::/0";const a=s.reduce((c,u)=>c+(u.toString(2).match(/1/g)||[]).length,0);return t.length===8?`${Array.from(i).join(".")}/${a}`:`${this.formatIPv6(i)}/${a}`}return this.decodeIP(ee.ToHex(e))}static fromString(e){if(e.includes("/")){const[r,i]=this.parseCIDR(e),s=new Uint8Array(r.length);let o=i;for(let c=0;c<s.length;c++)o>=8?(s[c]=255,o-=8):o>0&&(s[c]=255<<8-o,o=0);const a=new Uint8Array(r.length*2);return a.set(r,0),a.set(s,r.length),a.buffer}const t=this.isIPv4(e)?this.parseIPv4(e):this.parseIPv6(e);return new Uint8Array(t).buffer}}var z0,K0,q0;let Tt=class{constructor(e={}){Object.assign(this,e)}toString(){return this.bmpString||this.printableString||this.teletexString||this.universalString||this.utf8String||""}};g([y({type:v.TeletexString})],Tt.prototype,"teletexString",void 0);g([y({type:v.PrintableString})],Tt.prototype,"printableString",void 0);g([y({type:v.UniversalString})],Tt.prototype,"universalString",void 0);g([y({type:v.Utf8String})],Tt.prototype,"utf8String",void 0);g([y({type:v.BmpString})],Tt.prototype,"bmpString",void 0);Tt=g([P({type:I.Choice})],Tt);let oa=class extends Tt{constructor(e={}){super(e),Object.assign(this,e)}toString(){return this.ia5String||(this.anyValue?ee.ToHex(this.anyValue):super.toString())}};g([y({type:v.IA5String})],oa.prototype,"ia5String",void 0);g([y({type:v.Any})],oa.prototype,"anyValue",void 0);oa=g([P({type:I.Choice})],oa);class o1{constructor(e={}){this.type="",this.value=new oa,Object.assign(this,e)}}g([y({type:v.ObjectIdentifier})],o1.prototype,"type",void 0);g([y({type:oa})],o1.prototype,"value",void 0);let aa=z0=class extends Me{constructor(e){super(e),Object.setPrototypeOf(this,z0.prototype)}};aa=z0=g([P({type:I.Set,itemType:o1})],aa);let W0=K0=class extends Me{constructor(e){super(e),Object.setPrototypeOf(this,K0.prototype)}};W0=K0=g([P({type:I.Sequence,itemType:aa})],W0);let st=q0=class extends W0{constructor(e){super(e),Object.setPrototypeOf(this,q0.prototype)}};st=q0=g([P({type:I.Sequence})],st);const tB={fromASN:n=>z4.toString(_d.fromASN(n)),toASN:n=>_d.toASN(z4.fromString(n))};class Uc{constructor(e={}){this.typeId="",this.value=new ArrayBuffer(0),Object.assign(this,e)}}g([y({type:v.ObjectIdentifier})],Uc.prototype,"typeId",void 0);g([y({type:v.Any,context:0})],Uc.prototype,"value",void 0);class Fg{constructor(e={}){this.partyName=new Tt,Object.assign(this,e)}}g([y({type:Tt,optional:!0,context:0,implicit:!0})],Fg.prototype,"nameAssigner",void 0);g([y({type:Tt,context:1,implicit:!0})],Fg.prototype,"partyName",void 0);let he=class{constructor(e={}){Object.assign(this,e)}};g([y({type:Uc,context:0,implicit:!0})],he.prototype,"otherName",void 0);g([y({type:v.IA5String,context:1,implicit:!0})],he.prototype,"rfc822Name",void 0);g([y({type:v.IA5String,context:2,implicit:!0})],he.prototype,"dNSName",void 0);g([y({type:v.Any,context:3,implicit:!0})],he.prototype,"x400Address",void 0);g([y({type:st,context:4,implicit:!1})],he.prototype,"directoryName",void 0);g([y({type:Fg,context:5})],he.prototype,"ediPartyName",void 0);g([y({type:v.IA5String,context:6,implicit:!0})],he.prototype,"uniformResourceIdentifier",void 0);g([y({type:v.OctetString,context:7,implicit:!0,converter:tB})],he.prototype,"iPAddress",void 0);g([y({type:v.ObjectIdentifier,context:8,implicit:!0})],he.prototype,"registeredID",void 0);he=g([P({type:I.Choice})],he);const $g="1.3.6.1.5.5.7",rB=`${$g}.1`,xa=`${$g}.3`,a1=`${$g}.48`,K4=`${a1}.1`,q4=`${a1}.2`,W4=`${a1}.3`,G4=`${a1}.5`,vi="2.5.29";var G0;const j0=`${rB}.1`;class vl{constructor(e={}){this.accessMethod="",this.accessLocation=new he,Object.assign(this,e)}}g([y({type:v.ObjectIdentifier})],vl.prototype,"accessMethod",void 0);g([y({type:he})],vl.prototype,"accessLocation",void 0);let uo=G0=class extends Me{constructor(e){super(e),Object.setPrototypeOf(this,G0.prototype)}};uo=G0=g([P({type:I.Sequence,itemType:vl})],uo);const Q0=`${vi}.35`;class Hg extends Ie{}class Ss{constructor(e={}){e&&Object.assign(this,e)}}g([y({type:Hg,context:0,optional:!0,implicit:!0})],Ss.prototype,"keyIdentifier",void 0);g([y({type:he,context:1,optional:!0,implicit:!0,repeated:"sequence"})],Ss.prototype,"authorityCertIssuer",void 0);g([y({type:v.Integer,context:2,optional:!0,implicit:!0,converter:je})],Ss.prototype,"authorityCertSerialNumber",void 0);const Lb=`${vi}.19`;class Id{constructor(e={}){this.cA=!1,Object.assign(this,e)}}g([y({type:v.Boolean,defaultValue:!1})],Id.prototype,"cA",void 0);g([y({type:v.Integer,optional:!0})],Id.prototype,"pathLenConstraint",void 0);var Y0;let Lt=Y0=class extends Me{constructor(e){super(e),Object.setPrototypeOf(this,Y0.prototype)}};Lt=Y0=g([P({type:I.Sequence,itemType:he})],Lt);var X0;let j4=X0=class extends Lt{constructor(e){super(e),Object.setPrototypeOf(this,X0.prototype)}};j4=X0=g([P({type:I.Sequence})],j4);var Z0;const Bb=`${vi}.32`;let fi=class{constructor(e={}){Object.assign(this,e)}toString(){return this.ia5String||this.visibleString||this.bmpString||this.utf8String||""}};g([y({type:v.IA5String})],fi.prototype,"ia5String",void 0);g([y({type:v.VisibleString})],fi.prototype,"visibleString",void 0);g([y({type:v.BmpString})],fi.prototype,"bmpString",void 0);g([y({type:v.Utf8String})],fi.prototype,"utf8String",void 0);fi=g([P({type:I.Choice})],fi);class Vg{constructor(e={}){this.organization=new fi,this.noticeNumbers=[],Object.assign(this,e)}}g([y({type:fi})],Vg.prototype,"organization",void 0);g([y({type:v.Integer,repeated:"sequence"})],Vg.prototype,"noticeNumbers",void 0);class zg{constructor(e={}){Object.assign(this,e)}}g([y({type:Vg,optional:!0})],zg.prototype,"noticeRef",void 0);g([y({type:fi,optional:!0})],zg.prototype,"explicitText",void 0);let Cd=class{constructor(e={}){Object.assign(this,e)}};g([y({type:v.IA5String})],Cd.prototype,"cPSuri",void 0);g([y({type:zg})],Cd.prototype,"userNotice",void 0);Cd=g([P({type:I.Choice})],Cd);class Kg{constructor(e={}){this.policyQualifierId="",this.qualifier=new ArrayBuffer(0),Object.assign(this,e)}}g([y({type:v.ObjectIdentifier})],Kg.prototype,"policyQualifierId",void 0);g([y({type:v.Any})],Kg.prototype,"qualifier",void 0);class c1{constructor(e={}){this.policyIdentifier="",Object.assign(this,e)}}g([y({type:v.ObjectIdentifier})],c1.prototype,"policyIdentifier",void 0);g([y({type:Kg,repeated:"sequence",optional:!0})],c1.prototype,"policyQualifiers",void 0);let Td=Z0=class extends Me{constructor(e){super(e),Object.setPrototypeOf(this,Z0.prototype)}};Td=Z0=g([P({type:I.Sequence,itemType:c1})],Td);let Rd=class{constructor(e=0){this.value=e}};g([y({type:v.Integer})],Rd.prototype,"value",void 0);Rd=g([P({type:I.Choice})],Rd);let Q4=class extends Rd{};Q4=g([P({type:I.Choice})],Q4);var J0;const e2=`${vi}.31`;var Wr;(function(n){n[n.unused=1]="unused",n[n.keyCompromise=2]="keyCompromise",n[n.cACompromise=4]="cACompromise",n[n.affiliationChanged=8]="affiliationChanged",n[n.superseded=16]="superseded",n[n.cessationOfOperation=32]="cessationOfOperation",n[n.certificateHold=64]="certificateHold",n[n.privilegeWithdrawn=128]="privilegeWithdrawn",n[n.aACompromise=256]="aACompromise"})(Wr||(Wr={}));class Mb extends s1{toJSON(){const e=[],t=this.toNumber();return t&Wr.aACompromise&&e.push("aACompromise"),t&Wr.affiliationChanged&&e.push("affiliationChanged"),t&Wr.cACompromise&&e.push("cACompromise"),t&Wr.certificateHold&&e.push("certificateHold"),t&Wr.cessationOfOperation&&e.push("cessationOfOperation"),t&Wr.keyCompromise&&e.push("keyCompromise"),t&Wr.privilegeWithdrawn&&e.push("privilegeWithdrawn"),t&Wr.superseded&&e.push("superseded"),t&Wr.unused&&e.push("unused"),e}toString(){return`[${this.toJSON().join(", ")}]`}}let Fs=class{constructor(e={}){Object.assign(this,e)}};g([y({type:he,context:0,repeated:"sequence",implicit:!0})],Fs.prototype,"fullName",void 0);g([y({type:aa,context:1,implicit:!0})],Fs.prototype,"nameRelativeToCRLIssuer",void 0);Fs=g([P({type:I.Choice})],Fs);class Aa{constructor(e={}){Object.assign(this,e)}}g([y({type:Fs,context:0,optional:!0})],Aa.prototype,"distributionPoint",void 0);g([y({type:Mb,context:1,optional:!0,implicit:!0})],Aa.prototype,"reasons",void 0);g([y({type:he,context:2,optional:!0,repeated:"sequence",implicit:!0})],Aa.prototype,"cRLIssuer",void 0);let Lo=J0=class extends Me{constructor(e){super(e),Object.setPrototypeOf(this,J0.prototype)}};Lo=J0=g([P({type:I.Sequence,itemType:Aa})],Lo);var t2;let Y4=t2=class extends Lo{constructor(e){super(e),Object.setPrototypeOf(this,t2.prototype)}};Y4=t2=g([P({type:I.Sequence,itemType:Aa})],Y4);class Dt{constructor(e={}){this.onlyContainsUserCerts=Dt.ONLY,this.onlyContainsCACerts=Dt.ONLY,this.indirectCRL=Dt.ONLY,this.onlyContainsAttributeCerts=Dt.ONLY,Object.assign(this,e)}}Dt.ONLY=!1;g([y({type:Fs,context:0,optional:!0})],Dt.prototype,"distributionPoint",void 0);g([y({type:v.Boolean,context:1,defaultValue:Dt.ONLY,implicit:!0})],Dt.prototype,"onlyContainsUserCerts",void 0);g([y({type:v.Boolean,context:2,defaultValue:Dt.ONLY,implicit:!0})],Dt.prototype,"onlyContainsCACerts",void 0);g([y({type:Mb,context:3,optional:!0,implicit:!0})],Dt.prototype,"onlySomeReasons",void 0);g([y({type:v.Boolean,context:4,defaultValue:Dt.ONLY,implicit:!0})],Dt.prototype,"indirectCRL",void 0);g([y({type:v.Boolean,context:5,defaultValue:Dt.ONLY,implicit:!0})],Dt.prototype,"onlyContainsAttributeCerts",void 0);var dc;(function(n){n[n.unspecified=0]="unspecified",n[n.keyCompromise=1]="keyCompromise",n[n.cACompromise=2]="cACompromise",n[n.affiliationChanged=3]="affiliationChanged",n[n.superseded=4]="superseded",n[n.cessationOfOperation=5]="cessationOfOperation",n[n.certificateHold=6]="certificateHold",n[n.removeFromCRL=8]="removeFromCRL",n[n.privilegeWithdrawn=9]="privilegeWithdrawn",n[n.aACompromise=10]="aACompromise"})(dc||(dc={}));let r2=class{constructor(e=dc.unspecified){this.reason=dc.unspecified,this.reason=e}toJSON(){return dc[this.reason]}toString(){return this.toJSON()}};g([y({type:v.Enumerated})],r2.prototype,"reason",void 0);r2=g([P({type:I.Choice})],r2);var n2;const Ub=`${vi}.37`;let Pd=n2=class extends Me{constructor(e){super(e),Object.setPrototypeOf(this,n2.prototype)}};Pd=n2=g([P({type:I.Sequence,itemType:v.ObjectIdentifier})],Pd);const nB=`${xa}.1`,iB=`${xa}.2`,sB=`${xa}.3`,oB=`${xa}.4`,aB=`${xa}.8`,cB=`${xa}.9`;let i2=class{constructor(e=new ArrayBuffer(0)){this.value=e}};g([y({type:v.Integer,converter:je})],i2.prototype,"value",void 0);i2=g([P({type:I.Choice})],i2);let s2=class{constructor(e){this.value=new Date,e&&(this.value=e)}};g([y({type:v.GeneralizedTime})],s2.prototype,"value",void 0);s2=g([P({type:I.Choice})],s2);var o2;const Fb=`${vi}.18`;let X4=o2=class extends Lt{constructor(e){super(e),Object.setPrototypeOf(this,o2.prototype)}};X4=o2=g([P({type:I.Sequence})],X4);const $b=`${vi}.15`;var Gr;(function(n){n[n.digitalSignature=1]="digitalSignature",n[n.nonRepudiation=2]="nonRepudiation",n[n.keyEncipherment=4]="keyEncipherment",n[n.dataEncipherment=8]="dataEncipherment",n[n.keyAgreement=16]="keyAgreement",n[n.keyCertSign=32]="keyCertSign",n[n.cRLSign=64]="cRLSign",n[n.encipherOnly=128]="encipherOnly",n[n.decipherOnly=256]="decipherOnly"})(Gr||(Gr={}));class vf extends s1{toJSON(){const e=this.toNumber(),t=[];return e&Gr.cRLSign&&t.push("crlSign"),e&Gr.dataEncipherment&&t.push("dataEncipherment"),e&Gr.decipherOnly&&t.push("decipherOnly"),e&Gr.digitalSignature&&t.push("digitalSignature"),e&Gr.encipherOnly&&t.push("encipherOnly"),e&Gr.keyAgreement&&t.push("keyAgreement"),e&Gr.keyCertSign&&t.push("keyCertSign"),e&Gr.keyEncipherment&&t.push("keyEncipherment"),e&Gr.nonRepudiation&&t.push("nonRepudiation"),t}toString(){return`[${this.toJSON().join(", ")}]`}}var a2;class l1{constructor(e={}){this.base=new he,this.minimum=0,Object.assign(this,e)}}g([y({type:he})],l1.prototype,"base",void 0);g([y({type:v.Integer,context:0,defaultValue:0,implicit:!0})],l1.prototype,"minimum",void 0);g([y({type:v.Integer,context:1,optional:!0,implicit:!0})],l1.prototype,"maximum",void 0);let Od=a2=class extends Me{constructor(e){super(e),Object.setPrototypeOf(this,a2.prototype)}};Od=a2=g([P({type:I.Sequence,itemType:l1})],Od);class Hb{constructor(e={}){Object.assign(this,e)}}g([y({type:Od,context:0,optional:!0,implicit:!0})],Hb.prototype,"permittedSubtrees",void 0);g([y({type:Od,context:1,optional:!0,implicit:!0})],Hb.prototype,"excludedSubtrees",void 0);class Vb{constructor(e={}){Object.assign(this,e)}}g([y({type:v.Integer,context:0,implicit:!0,optional:!0,converter:je})],Vb.prototype,"requireExplicitPolicy",void 0);g([y({type:v.Integer,context:1,implicit:!0,optional:!0,converter:je})],Vb.prototype,"inhibitPolicyMapping",void 0);var c2;class qg{constructor(e={}){this.issuerDomainPolicy="",this.subjectDomainPolicy="",Object.assign(this,e)}}g([y({type:v.ObjectIdentifier})],qg.prototype,"issuerDomainPolicy",void 0);g([y({type:v.ObjectIdentifier})],qg.prototype,"subjectDomainPolicy",void 0);let Z4=c2=class extends Me{constructor(e){super(e),Object.setPrototypeOf(this,c2.prototype)}};Z4=c2=g([P({type:I.Sequence,itemType:qg})],Z4);var l2;const zb=`${vi}.17`;let u2=l2=class extends Lt{constructor(e){super(e),Object.setPrototypeOf(this,l2.prototype)}};u2=l2=g([P({type:I.Sequence})],u2);let pi=class{constructor(e={}){this.type="",this.values=[],Object.assign(this,e)}};g([y({type:v.ObjectIdentifier})],pi.prototype,"type",void 0);g([y({type:v.Any,repeated:"set"})],pi.prototype,"values",void 0);var d2;let J4=d2=class extends Me{constructor(e){super(e),Object.setPrototypeOf(this,d2.prototype)}};J4=d2=g([P({type:I.Sequence,itemType:pi})],J4);const Kb=`${vi}.14`;class Ki extends Hg{}class qb{constructor(e={}){Object.assign(this,e)}}g([y({type:v.GeneralizedTime,context:0,implicit:!0,optional:!0})],qb.prototype,"notBefore",void 0);g([y({type:v.GeneralizedTime,context:1,implicit:!0,optional:!0})],qb.prototype,"notAfter",void 0);var hc;(function(n){n[n.keyUpdateAllowed=1]="keyUpdateAllowed",n[n.newExtensions=2]="newExtensions",n[n.pKIXCertificate=4]="pKIXCertificate"})(hc||(hc={}));class Wb extends s1{toJSON(){const e=[],t=this.toNumber();return t&hc.pKIXCertificate&&e.push("pKIXCertificate"),t&hc.newExtensions&&e.push("newExtensions"),t&hc.keyUpdateAllowed&&e.push("keyUpdateAllowed"),e}toString(){return`[${this.toJSON().join(", ")}]`}}class Gb{constructor(e={}){this.entrustVers="",this.entrustInfoFlags=new Wb,Object.assign(this,e)}}g([y({type:v.GeneralString})],Gb.prototype,"entrustVers",void 0);g([y({type:Wb})],Gb.prototype,"entrustInfoFlags",void 0);var h2;let ey=h2=class extends Me{constructor(e){super(e),Object.setPrototypeOf(this,h2.prototype)}};ey=h2=g([P({type:I.Sequence,itemType:vl})],ey);class j{constructor(e={}){this.algorithm="",Object.assign(this,e)}isEqual(e){return e instanceof j&&e.algorithm==this.algorithm&&(e.parameters&&this.parameters&&V9(e.parameters,this.parameters)||e.parameters===this.parameters)}}g([y({type:v.ObjectIdentifier})],j.prototype,"algorithm",void 0);g([y({type:v.Any,optional:!0})],j.prototype,"parameters",void 0);class Zr{constructor(e={}){this.algorithm=new j,this.subjectPublicKey=new ArrayBuffer(0),Object.assign(this,e)}}g([y({type:j})],Zr.prototype,"algorithm",void 0);g([y({type:v.BitString})],Zr.prototype,"subjectPublicKey",void 0);let xt=class{constructor(e){if(e)if(typeof e=="string"||typeof e=="number"||e instanceof Date){const t=new Date(e);t.getUTCFullYear()>2049?this.generalTime=t:this.utcTime=t}else Object.assign(this,e)}getTime(){const e=this.utcTime||this.generalTime;if(!e)throw new Error("Cannot get time from CHOICE object");return e}};g([y({type:v.UTCTime})],xt.prototype,"utcTime",void 0);g([y({type:v.GeneralizedTime})],xt.prototype,"generalTime",void 0);xt=g([P({type:I.Choice})],xt);class Sl{constructor(e){this.notBefore=new xt(new Date),this.notAfter=new xt(new Date),e&&(this.notBefore=new xt(e.notBefore),this.notAfter=new xt(e.notAfter))}}g([y({type:xt})],Sl.prototype,"notBefore",void 0);g([y({type:xt})],Sl.prototype,"notAfter",void 0);var f2;let Fr=class jb{constructor(e={}){this.extnID="",this.critical=jb.CRITICAL,this.extnValue=new Ie,Object.assign(this,e)}};Fr.CRITICAL=!1;g([y({type:v.ObjectIdentifier})],Fr.prototype,"extnID",void 0);g([y({type:v.Boolean,defaultValue:Fr.CRITICAL})],Fr.prototype,"critical",void 0);g([y({type:Ie})],Fr.prototype,"extnValue",void 0);let Zi=f2=class extends Me{constructor(e){super(e),Object.setPrototypeOf(this,f2.prototype)}};Zi=f2=g([P({type:I.Sequence,itemType:Fr})],Zi);var $s;(function(n){n[n.v1=0]="v1",n[n.v2=1]="v2",n[n.v3=2]="v3"})($s||($s={}));class Er{constructor(e={}){this.version=$s.v1,this.serialNumber=new ArrayBuffer(0),this.signature=new j,this.issuer=new st,this.validity=new Sl,this.subject=new st,this.subjectPublicKeyInfo=new Zr,Object.assign(this,e)}}g([y({type:v.Integer,context:0,defaultValue:$s.v1})],Er.prototype,"version",void 0);g([y({type:v.Integer,converter:je})],Er.prototype,"serialNumber",void 0);g([y({type:j})],Er.prototype,"signature",void 0);g([y({type:st})],Er.prototype,"issuer",void 0);g([y({type:Sl})],Er.prototype,"validity",void 0);g([y({type:st})],Er.prototype,"subject",void 0);g([y({type:Zr})],Er.prototype,"subjectPublicKeyInfo",void 0);g([y({type:v.BitString,context:1,implicit:!0,optional:!0})],Er.prototype,"issuerUniqueID",void 0);g([y({type:v.BitString,context:2,implicit:!0,optional:!0})],Er.prototype,"subjectUniqueID",void 0);g([y({type:Zi,context:3,optional:!0})],Er.prototype,"extensions",void 0);class Hs{constructor(e={}){this.tbsCertificate=new Er,this.signatureAlgorithm=new j,this.signatureValue=new ArrayBuffer(0),Object.assign(this,e)}}g([y({type:Er})],Hs.prototype,"tbsCertificate",void 0);g([y({type:j})],Hs.prototype,"signatureAlgorithm",void 0);g([y({type:v.BitString})],Hs.prototype,"signatureValue",void 0);class u1{constructor(e={}){this.userCertificate=new ArrayBuffer(0),this.revocationDate=new xt,Object.assign(this,e)}}g([y({type:v.Integer,converter:je})],u1.prototype,"userCertificate",void 0);g([y({type:xt})],u1.prototype,"revocationDate",void 0);g([y({type:Fr,optional:!0,repeated:"sequence"})],u1.prototype,"crlEntryExtensions",void 0);class Si{constructor(e={}){this.signature=new j,this.issuer=new st,this.thisUpdate=new xt,Object.assign(this,e)}}g([y({type:v.Integer,optional:!0})],Si.prototype,"version",void 0);g([y({type:j})],Si.prototype,"signature",void 0);g([y({type:st})],Si.prototype,"issuer",void 0);g([y({type:xt})],Si.prototype,"thisUpdate",void 0);g([y({type:xt,optional:!0})],Si.prototype,"nextUpdate",void 0);g([y({type:u1,repeated:"sequence",optional:!0})],Si.prototype,"revokedCertificates",void 0);g([y({type:Fr,optional:!0,context:0,repeated:"sequence"})],Si.prototype,"crlExtensions",void 0);class Wg{constructor(e={}){this.tbsCertList=new Si,this.signatureAlgorithm=new j,this.signature=new ArrayBuffer(0),Object.assign(this,e)}}g([y({type:Si})],Wg.prototype,"tbsCertList",void 0);g([y({type:j})],Wg.prototype,"signatureAlgorithm",void 0);g([y({type:v.BitString})],Wg.prototype,"signature",void 0);class ka{constructor(e={}){this.issuer=new st,this.serialNumber=new ArrayBuffer(0),Object.assign(this,e)}}g([y({type:st})],ka.prototype,"issuer",void 0);g([y({type:v.Integer,converter:je})],ka.prototype,"serialNumber",void 0);let ca=class{constructor(e={}){Object.assign(this,e)}};g([y({type:Ki,context:0,implicit:!0})],ca.prototype,"subjectKeyIdentifier",void 0);g([y({type:ka})],ca.prototype,"issuerAndSerialNumber",void 0);ca=g([P({type:I.Choice})],ca);var gi;(function(n){n[n.v0=0]="v0",n[n.v1=1]="v1",n[n.v2=2]="v2",n[n.v3=3]="v3",n[n.v4=4]="v4",n[n.v5=5]="v5"})(gi||(gi={}));let Fc=class extends j{};Fc=g([P({type:I.Sequence})],Fc);let Dd=class extends j{};Dd=g([P({type:I.Sequence})],Dd);let In=class extends j{};In=g([P({type:I.Sequence})],In);let Nd=class extends j{};Nd=g([P({type:I.Sequence})],Nd);let ty=class extends j{};ty=g([P({type:I.Sequence})],ty);let p2=class extends j{};p2=g([P({type:I.Sequence})],p2);let _a=class{constructor(e={}){this.attrType="",this.attrValues=[],Object.assign(this,e)}};g([y({type:v.ObjectIdentifier})],_a.prototype,"attrType",void 0);g([y({type:v.Any,repeated:"set"})],_a.prototype,"attrValues",void 0);var g2;class Rn{constructor(e={}){this.version=gi.v0,this.sid=new ca,this.digestAlgorithm=new Fc,this.signatureAlgorithm=new Dd,this.signature=new Ie,Object.assign(this,e)}}g([y({type:v.Integer})],Rn.prototype,"version",void 0);g([y({type:ca})],Rn.prototype,"sid",void 0);g([y({type:Fc})],Rn.prototype,"digestAlgorithm",void 0);g([y({type:_a,repeated:"set",context:0,implicit:!0,optional:!0})],Rn.prototype,"signedAttrs",void 0);g([y({type:Dd})],Rn.prototype,"signatureAlgorithm",void 0);g([y({type:Ie})],Rn.prototype,"signature",void 0);g([y({type:_a,repeated:"set",context:1,implicit:!0,optional:!0})],Rn.prototype,"unsignedAttrs",void 0);let Ld=g2=class extends Me{constructor(e){super(e),Object.setPrototypeOf(this,g2.prototype)}};Ld=g2=g([P({type:I.Set,itemType:Rn})],Ld);let ry=class extends xt{};ry=g([P({type:I.Choice})],ry);let ny=class extends Rn{};ny=g([P({type:I.Sequence})],ny);class Gg{constructor(e={}){this.acIssuer=new he,this.acSerial=0,this.attrs=[],Object.assign(this,e)}}g([y({type:he})],Gg.prototype,"acIssuer",void 0);g([y({type:v.Integer})],Gg.prototype,"acSerial",void 0);g([y({type:pi,repeated:"sequence"})],Gg.prototype,"attrs",void 0);var m2;let Bd=m2=class extends Me{constructor(e){super(e),Object.setPrototypeOf(this,m2.prototype)}};Bd=m2=g([P({type:I.Sequence,itemType:v.ObjectIdentifier})],Bd);class d1{constructor(e={}){this.permitUnSpecified=!0,Object.assign(this,e)}}g([y({type:v.Integer,optional:!0})],d1.prototype,"pathLenConstraint",void 0);g([y({type:Bd,implicit:!0,context:0,optional:!0})],d1.prototype,"permittedAttrs",void 0);g([y({type:Bd,implicit:!0,context:1,optional:!0})],d1.prototype,"excludedAttrs",void 0);g([y({type:v.Boolean,defaultValue:!0})],d1.prototype,"permitUnSpecified",void 0);class ro{constructor(e={}){this.issuer=new Lt,this.serial=new ArrayBuffer(0),this.issuerUID=new ArrayBuffer(0),Object.assign(this,e)}}g([y({type:Lt})],ro.prototype,"issuer",void 0);g([y({type:v.Integer,converter:je})],ro.prototype,"serial",void 0);g([y({type:v.BitString,optional:!0})],ro.prototype,"issuerUID",void 0);var y2;(function(n){n[n.publicKey=0]="publicKey",n[n.publicKeyCert=1]="publicKeyCert",n[n.otherObjectTypes=2]="otherObjectTypes"})(y2||(y2={}));class no{constructor(e={}){this.digestedObjectType=y2.publicKey,this.digestAlgorithm=new j,this.objectDigest=new ArrayBuffer(0),Object.assign(this,e)}}g([y({type:v.Enumerated})],no.prototype,"digestedObjectType",void 0);g([y({type:v.ObjectIdentifier,optional:!0})],no.prototype,"otherObjectTypeID",void 0);g([y({type:j})],no.prototype,"digestAlgorithm",void 0);g([y({type:v.BitString})],no.prototype,"objectDigest",void 0);class h1{constructor(e={}){Object.assign(this,e)}}g([y({type:Lt,optional:!0})],h1.prototype,"issuerName",void 0);g([y({type:ro,context:0,implicit:!0,optional:!0})],h1.prototype,"baseCertificateID",void 0);g([y({type:no,context:1,implicit:!0,optional:!0})],h1.prototype,"objectDigestInfo",void 0);let la=class{constructor(e={}){Object.assign(this,e)}};g([y({type:he,repeated:"sequence"})],la.prototype,"v1Form",void 0);g([y({type:h1,context:0,implicit:!0})],la.prototype,"v2Form",void 0);la=g([P({type:I.Choice})],la);class f1{constructor(e={}){this.notBeforeTime=new Date,this.notAfterTime=new Date,Object.assign(this,e)}}g([y({type:v.GeneralizedTime})],f1.prototype,"notBeforeTime",void 0);g([y({type:v.GeneralizedTime})],f1.prototype,"notAfterTime",void 0);class El{constructor(e={}){Object.assign(this,e)}}g([y({type:ro,implicit:!0,context:0,optional:!0})],El.prototype,"baseCertificateID",void 0);g([y({type:Lt,implicit:!0,context:1,optional:!0})],El.prototype,"entityName",void 0);g([y({type:no,implicit:!0,context:2,optional:!0})],El.prototype,"objectDigestInfo",void 0);var w2;(function(n){n[n.v2=1]="v2"})(w2||(w2={}));class hn{constructor(e={}){this.version=w2.v2,this.holder=new El,this.issuer=new la,this.signature=new j,this.serialNumber=new ArrayBuffer(0),this.attrCertValidityPeriod=new f1,this.attributes=[],Object.assign(this,e)}}g([y({type:v.Integer})],hn.prototype,"version",void 0);g([y({type:El})],hn.prototype,"holder",void 0);g([y({type:la})],hn.prototype,"issuer",void 0);g([y({type:j})],hn.prototype,"signature",void 0);g([y({type:v.Integer,converter:je})],hn.prototype,"serialNumber",void 0);g([y({type:f1})],hn.prototype,"attrCertValidityPeriod",void 0);g([y({type:pi,repeated:"sequence"})],hn.prototype,"attributes",void 0);g([y({type:v.BitString,optional:!0})],hn.prototype,"issuerUniqueID",void 0);g([y({type:Zi,optional:!0})],hn.prototype,"extensions",void 0);class p1{constructor(e={}){this.acinfo=new hn,this.signatureAlgorithm=new j,this.signatureValue=new ArrayBuffer(0),Object.assign(this,e)}}g([y({type:hn})],p1.prototype,"acinfo",void 0);g([y({type:j})],p1.prototype,"signatureAlgorithm",void 0);g([y({type:v.BitString})],p1.prototype,"signatureValue",void 0);var Md;(function(n){n[n.unmarked=1]="unmarked",n[n.unclassified=2]="unclassified",n[n.restricted=4]="restricted",n[n.confidential=8]="confidential",n[n.secret=16]="secret",n[n.topSecret=32]="topSecret"})(Md||(Md={}));class b2 extends s1{}class jg{constructor(e={}){this.type="",this.value=new ArrayBuffer(0),Object.assign(this,e)}}g([y({type:v.ObjectIdentifier,implicit:!0,context:0})],jg.prototype,"type",void 0);g([y({type:v.Any,implicit:!0,context:1})],jg.prototype,"value",void 0);class Qg{constructor(e={}){this.policyId="",this.classList=new b2(Md.unclassified),Object.assign(this,e)}}g([y({type:v.ObjectIdentifier})],Qg.prototype,"policyId",void 0);g([y({type:b2,defaultValue:new b2(Md.unclassified)})],Qg.prototype,"classList",void 0);g([y({type:jg,repeated:"set"})],Qg.prototype,"securityCategories",void 0);class g1{constructor(e={}){Object.assign(this,e)}}g([y({type:Ie})],g1.prototype,"cotets",void 0);g([y({type:v.ObjectIdentifier})],g1.prototype,"oid",void 0);g([y({type:v.Utf8String})],g1.prototype,"string",void 0);class Qb{constructor(e={}){this.values=[],Object.assign(this,e)}}g([y({type:Lt,implicit:!0,context:0,optional:!0})],Qb.prototype,"policyAuthority",void 0);g([y({type:g1,repeated:"sequence"})],Qb.prototype,"values",void 0);var v2;class m1{constructor(e={}){this.targetCertificate=new ro,Object.assign(this,e)}}g([y({type:ro})],m1.prototype,"targetCertificate",void 0);g([y({type:he,optional:!0})],m1.prototype,"targetName",void 0);g([y({type:no,optional:!0})],m1.prototype,"certDigestInfo",void 0);let ua=class{constructor(e={}){Object.assign(this,e)}};g([y({type:he,context:0,implicit:!0})],ua.prototype,"targetName",void 0);g([y({type:he,context:1,implicit:!0})],ua.prototype,"targetGroup",void 0);g([y({type:m1,context:2,implicit:!0})],ua.prototype,"targetCert",void 0);ua=g([P({type:I.Choice})],ua);let S2=v2=class extends Me{constructor(e){super(e),Object.setPrototypeOf(this,v2.prototype)}};S2=v2=g([P({type:I.Sequence,itemType:ua})],S2);var E2;let iy=E2=class extends Me{constructor(e){super(e),Object.setPrototypeOf(this,E2.prototype)}};iy=E2=g([P({type:I.Sequence,itemType:S2})],iy);class Yb{constructor(e={}){Object.assign(this,e)}}g([y({type:Lt,implicit:!0,context:0,optional:!0})],Yb.prototype,"roleAuthority",void 0);g([y({type:he,implicit:!0,context:1})],Yb.prototype,"roleName",void 0);class Yg{constructor(e={}){this.service=new he,this.ident=new he,Object.assign(this,e)}}g([y({type:he})],Yg.prototype,"service",void 0);g([y({type:he})],Yg.prototype,"ident",void 0);g([y({type:Ie,optional:!0})],Yg.prototype,"authInfo",void 0);var x2;class Xg{constructor(e={}){this.otherCertFormat="",this.otherCert=new ArrayBuffer(0),Object.assign(this,e)}}g([y({type:v.ObjectIdentifier})],Xg.prototype,"otherCertFormat",void 0);g([y({type:v.Any})],Xg.prototype,"otherCert",void 0);let da=class{constructor(e={}){Object.assign(this,e)}};g([y({type:Hs})],da.prototype,"certificate",void 0);g([y({type:p1,context:2,implicit:!0})],da.prototype,"v2AttrCert",void 0);g([y({type:Xg,context:3,implicit:!0})],da.prototype,"other",void 0);da=g([P({type:I.Choice})],da);let Ud=x2=class extends Me{constructor(e){super(e),Object.setPrototypeOf(this,x2.prototype)}};Ud=x2=g([P({type:I.Set,itemType:da})],Ud);class Ia{constructor(e={}){this.contentType="",this.content=new ArrayBuffer(0),Object.assign(this,e)}}g([y({type:v.ObjectIdentifier})],Ia.prototype,"contentType",void 0);g([y({type:v.Any,context:0})],Ia.prototype,"content",void 0);let $c=class{constructor(e={}){Object.assign(this,e)}};g([y({type:Ie})],$c.prototype,"single",void 0);g([y({type:v.Any})],$c.prototype,"any",void 0);$c=g([P({type:I.Choice})],$c);class y1{constructor(e={}){this.eContentType="",Object.assign(this,e)}}g([y({type:v.ObjectIdentifier})],y1.prototype,"eContentType",void 0);g([y({type:$c,context:0,optional:!0})],y1.prototype,"eContent",void 0);let Hc=class{constructor(e={}){Object.assign(this,e)}};g([y({type:Ie,context:0,implicit:!0,optional:!0})],Hc.prototype,"value",void 0);g([y({type:Ie,converter:ML,context:0,implicit:!0,optional:!0,repeated:"sequence"})],Hc.prototype,"constructedValue",void 0);Hc=g([P({type:I.Choice})],Hc);class xl{constructor(e={}){this.contentType="",this.contentEncryptionAlgorithm=new Nd,Object.assign(this,e)}}g([y({type:v.ObjectIdentifier})],xl.prototype,"contentType",void 0);g([y({type:Nd})],xl.prototype,"contentEncryptionAlgorithm",void 0);g([y({type:Hc,optional:!0})],xl.prototype,"encryptedContent",void 0);class w1{constructor(e={}){this.keyAttrId="",Object.assign(this,e)}}g([y({type:v.ObjectIdentifier})],w1.prototype,"keyAttrId",void 0);g([y({type:v.Any,optional:!0})],w1.prototype,"keyAttr",void 0);var A2;class b1{constructor(e={}){this.subjectKeyIdentifier=new Ki,Object.assign(this,e)}}g([y({type:Ki})],b1.prototype,"subjectKeyIdentifier",void 0);g([y({type:v.GeneralizedTime,optional:!0})],b1.prototype,"date",void 0);g([y({type:w1,optional:!0})],b1.prototype,"other",void 0);let ha=class{constructor(e={}){Object.assign(this,e)}};g([y({type:b1,context:0,implicit:!0,optional:!0})],ha.prototype,"rKeyId",void 0);g([y({type:ka,optional:!0})],ha.prototype,"issuerAndSerialNumber",void 0);ha=g([P({type:I.Choice})],ha);class Zg{constructor(e={}){this.rid=new ha,this.encryptedKey=new Ie,Object.assign(this,e)}}g([y({type:ha})],Zg.prototype,"rid",void 0);g([y({type:Ie})],Zg.prototype,"encryptedKey",void 0);let Fd=A2=class extends Me{constructor(e){super(e),Object.setPrototypeOf(this,A2.prototype)}};Fd=A2=g([P({type:I.Sequence,itemType:Zg})],Fd);class Jg{constructor(e={}){this.algorithm=new j,this.publicKey=new ArrayBuffer(0),Object.assign(this,e)}}g([y({type:j})],Jg.prototype,"algorithm",void 0);g([y({type:v.BitString})],Jg.prototype,"publicKey",void 0);let Vs=class{constructor(e={}){Object.assign(this,e)}};g([y({type:Ki,context:0,implicit:!0,optional:!0})],Vs.prototype,"subjectKeyIdentifier",void 0);g([y({type:Jg,context:1,implicit:!0,optional:!0})],Vs.prototype,"originatorKey",void 0);g([y({type:ka,optional:!0})],Vs.prototype,"issuerAndSerialNumber",void 0);Vs=g([P({type:I.Choice})],Vs);class Ca{constructor(e={}){this.version=gi.v3,this.originator=new Vs,this.keyEncryptionAlgorithm=new In,this.recipientEncryptedKeys=new Fd,Object.assign(this,e)}}g([y({type:v.Integer})],Ca.prototype,"version",void 0);g([y({type:Vs,context:0})],Ca.prototype,"originator",void 0);g([y({type:Ie,context:1,optional:!0})],Ca.prototype,"ukm",void 0);g([y({type:In})],Ca.prototype,"keyEncryptionAlgorithm",void 0);g([y({type:Fd})],Ca.prototype,"recipientEncryptedKeys",void 0);let fa=class{constructor(e={}){Object.assign(this,e)}};g([y({type:Ki,context:0,implicit:!0})],fa.prototype,"subjectKeyIdentifier",void 0);g([y({type:ka})],fa.prototype,"issuerAndSerialNumber",void 0);fa=g([P({type:I.Choice})],fa);class Al{constructor(e={}){this.version=gi.v0,this.rid=new fa,this.keyEncryptionAlgorithm=new In,this.encryptedKey=new Ie,Object.assign(this,e)}}g([y({type:v.Integer})],Al.prototype,"version",void 0);g([y({type:fa})],Al.prototype,"rid",void 0);g([y({type:In})],Al.prototype,"keyEncryptionAlgorithm",void 0);g([y({type:Ie})],Al.prototype,"encryptedKey",void 0);class kl{constructor(e={}){this.keyIdentifier=new Ie,Object.assign(this,e)}}g([y({type:Ie})],kl.prototype,"keyIdentifier",void 0);g([y({type:v.GeneralizedTime,optional:!0})],kl.prototype,"date",void 0);g([y({type:w1,optional:!0})],kl.prototype,"other",void 0);class _l{constructor(e={}){this.version=gi.v4,this.kekid=new kl,this.keyEncryptionAlgorithm=new In,this.encryptedKey=new Ie,Object.assign(this,e)}}g([y({type:v.Integer})],_l.prototype,"version",void 0);g([y({type:kl})],_l.prototype,"kekid",void 0);g([y({type:In})],_l.prototype,"keyEncryptionAlgorithm",void 0);g([y({type:Ie})],_l.prototype,"encryptedKey",void 0);class Il{constructor(e={}){this.version=gi.v0,this.keyEncryptionAlgorithm=new In,this.encryptedKey=new Ie,Object.assign(this,e)}}g([y({type:v.Integer})],Il.prototype,"version",void 0);g([y({type:p2,context:0,optional:!0})],Il.prototype,"keyDerivationAlgorithm",void 0);g([y({type:In})],Il.prototype,"keyEncryptionAlgorithm",void 0);g([y({type:Ie})],Il.prototype,"encryptedKey",void 0);class e3{constructor(e={}){this.oriType="",this.oriValue=new ArrayBuffer(0),Object.assign(this,e)}}g([y({type:v.ObjectIdentifier})],e3.prototype,"oriType",void 0);g([y({type:v.Any})],e3.prototype,"oriValue",void 0);let Ji=class{constructor(e={}){Object.assign(this,e)}};g([y({type:Al,optional:!0})],Ji.prototype,"ktri",void 0);g([y({type:Ca,context:1,implicit:!0,optional:!0})],Ji.prototype,"kari",void 0);g([y({type:_l,context:2,implicit:!0,optional:!0})],Ji.prototype,"kekri",void 0);g([y({type:Il,context:3,implicit:!0,optional:!0})],Ji.prototype,"pwri",void 0);g([y({type:e3,context:4,implicit:!0,optional:!0})],Ji.prototype,"ori",void 0);Ji=g([P({type:I.Choice})],Ji);var k2;let $d=k2=class extends Me{constructor(e){super(e),Object.setPrototypeOf(this,k2.prototype)}};$d=k2=g([P({type:I.Set,itemType:Ji})],$d);var _2;class v1{constructor(e={}){this.otherRevInfoFormat="",this.otherRevInfo=new ArrayBuffer(0),Object.assign(this,e)}}g([y({type:v.ObjectIdentifier})],v1.prototype,"otherRevInfoFormat",void 0);g([y({type:v.Any})],v1.prototype,"otherRevInfo",void 0);let Hd=class{constructor(e={}){this.other=new v1,Object.assign(this,e)}};g([y({type:v1,context:1,implicit:!0})],Hd.prototype,"other",void 0);Hd=g([P({type:I.Choice})],Hd);let Vd=_2=class extends Me{constructor(e){super(e),Object.setPrototypeOf(this,_2.prototype)}};Vd=_2=g([P({type:I.Set,itemType:Hd})],Vd);class t3{constructor(e={}){Object.assign(this,e)}}g([y({type:Ud,context:0,implicit:!0,optional:!0})],t3.prototype,"certs",void 0);g([y({type:Vd,context:1,implicit:!0,optional:!0})],t3.prototype,"crls",void 0);var I2;let C2=I2=class extends Me{constructor(e){super(e),Object.setPrototypeOf(this,I2.prototype)}};C2=I2=g([P({type:I.Set,itemType:_a})],C2);class Cl{constructor(e={}){this.version=gi.v0,this.recipientInfos=new $d,this.encryptedContentInfo=new xl,Object.assign(this,e)}}g([y({type:v.Integer})],Cl.prototype,"version",void 0);g([y({type:t3,context:0,implicit:!0,optional:!0})],Cl.prototype,"originatorInfo",void 0);g([y({type:$d})],Cl.prototype,"recipientInfos",void 0);g([y({type:xl})],Cl.prototype,"encryptedContentInfo",void 0);g([y({type:C2,context:1,implicit:!0,optional:!0})],Cl.prototype,"unprotectedAttrs",void 0);const lB="1.2.840.113549.1.7.2";var T2;let zd=T2=class extends Me{constructor(e){super(e),Object.setPrototypeOf(this,T2.prototype)}};zd=T2=g([P({type:I.Set,itemType:Fc})],zd);class Ta{constructor(e={}){this.version=gi.v0,this.digestAlgorithms=new zd,this.encapContentInfo=new y1,this.signerInfos=new Ld,Object.assign(this,e)}}g([y({type:v.Integer})],Ta.prototype,"version",void 0);g([y({type:zd})],Ta.prototype,"digestAlgorithms",void 0);g([y({type:y1})],Ta.prototype,"encapContentInfo",void 0);g([y({type:Ud,context:0,implicit:!0,optional:!0})],Ta.prototype,"certificates",void 0);g([y({type:Vd,context:1,implicit:!0,optional:!0})],Ta.prototype,"crls",void 0);g([y({type:Ld})],Ta.prototype,"signerInfos",void 0);const Vc="1.2.840.10045.2.1",r3="1.2.840.10045.4.1",Xb="1.2.840.10045.4.3.1",n3="1.2.840.10045.4.3.2",i3="1.2.840.10045.4.3.3",s3="1.2.840.10045.4.3.4",sy="1.2.840.10045.3.1.7",oy="1.3.132.0.34",ay="1.3.132.0.35";function Tl(n){return new j({algorithm:n})}const uB=Tl(r3);Tl(Xb);const dB=Tl(n3),hB=Tl(i3),fB=Tl(s3);let zc=class{constructor(e={}){Object.assign(this,e)}};g([y({type:v.ObjectIdentifier})],zc.prototype,"fieldType",void 0);g([y({type:v.Any})],zc.prototype,"parameters",void 0);zc=g([P({type:I.Sequence})],zc);class pB extends Ie{}let pa=class{constructor(e={}){Object.assign(this,e)}};g([y({type:v.OctetString})],pa.prototype,"a",void 0);g([y({type:v.OctetString})],pa.prototype,"b",void 0);g([y({type:v.BitString,optional:!0})],pa.prototype,"seed",void 0);pa=g([P({type:I.Sequence})],pa);var R2;(function(n){n[n.ecpVer1=1]="ecpVer1"})(R2||(R2={}));let mi=class{constructor(e={}){this.version=R2.ecpVer1,Object.assign(this,e)}};g([y({type:v.Integer})],mi.prototype,"version",void 0);g([y({type:zc})],mi.prototype,"fieldID",void 0);g([y({type:pa})],mi.prototype,"curve",void 0);g([y({type:pB})],mi.prototype,"base",void 0);g([y({type:v.Integer,converter:je})],mi.prototype,"order",void 0);g([y({type:v.Integer,optional:!0})],mi.prototype,"cofactor",void 0);mi=g([P({type:I.Sequence})],mi);let es=class{constructor(e={}){Object.assign(this,e)}};g([y({type:v.ObjectIdentifier})],es.prototype,"namedCurve",void 0);g([y({type:v.Null})],es.prototype,"implicitCurve",void 0);g([y({type:mi})],es.prototype,"specifiedCurve",void 0);es=g([P({type:I.Choice})],es);class S1{constructor(e={}){this.version=1,this.privateKey=new Ie,Object.assign(this,e)}}g([y({type:v.Integer})],S1.prototype,"version",void 0);g([y({type:Ie})],S1.prototype,"privateKey",void 0);g([y({type:es,context:0,optional:!0})],S1.prototype,"parameters",void 0);g([y({type:v.BitString,context:1,optional:!0})],S1.prototype,"publicKey",void 0);class Kd{constructor(e={}){this.r=new ArrayBuffer(0),this.s=new ArrayBuffer(0),Object.assign(this,e)}}g([y({type:v.Integer,converter:je})],Kd.prototype,"r",void 0);g([y({type:v.Integer,converter:je})],Kd.prototype,"s",void 0);const lr="1.2.840.113549.1.1",zs=`${lr}.1`,gB=`${lr}.7`,mB=`${lr}.9`,fc=`${lr}.10`,yB=`${lr}.2`,wB=`${lr}.4`,qd=`${lr}.5`,bB=`${lr}.14`,P2=`${lr}.11`,Wd=`${lr}.12`,Gd=`${lr}.13`,Zb=`${lr}.15`,Jb=`${lr}.16`,jd="1.3.14.3.2.26",ev="2.16.840.1.101.3.4.2.4",Qd="2.16.840.1.101.3.4.2.1",Yd="2.16.840.1.101.3.4.2.2",Xd="2.16.840.1.101.3.4.2.3",vB="2.16.840.1.101.3.4.2.5",SB="2.16.840.1.101.3.4.2.6",EB="1.2.840.113549.2.2",xB="1.2.840.113549.2.5",E1=`${lr}.8`;function gt(n){return new j({algorithm:n,parameters:null})}gt(EB);gt(xB);const Ks=gt(jd);gt(ev);gt(Qd);gt(Yd);gt(Xd);gt(vB);gt(SB);const tv=new j({algorithm:E1,parameters:F.serialize(Ks)}),rv=new j({algorithm:mB,parameters:F.serialize(_d.toASN(new Uint8Array([218,57,163,238,94,107,75,13,50,85,191,239,149,96,24,144,175,216,7,9]).buffer))});gt(zs);gt(yB);gt(wB);gt(qd);gt(Zb);gt(Jb);gt(Wd);gt(Gd);gt(Zb);gt(Jb);class x1{constructor(e={}){this.hashAlgorithm=new j(Ks),this.maskGenAlgorithm=new j({algorithm:E1,parameters:F.serialize(Ks)}),this.pSourceAlgorithm=new j(rv),Object.assign(this,e)}}g([y({type:j,context:0,defaultValue:Ks})],x1.prototype,"hashAlgorithm",void 0);g([y({type:j,context:1,defaultValue:tv})],x1.prototype,"maskGenAlgorithm",void 0);g([y({type:j,context:2,defaultValue:rv})],x1.prototype,"pSourceAlgorithm",void 0);new j({algorithm:gB,parameters:F.serialize(new x1)});class qs{constructor(e={}){this.hashAlgorithm=new j(Ks),this.maskGenAlgorithm=new j({algorithm:E1,parameters:F.serialize(Ks)}),this.saltLength=20,this.trailerField=1,Object.assign(this,e)}}g([y({type:j,context:0,defaultValue:Ks})],qs.prototype,"hashAlgorithm",void 0);g([y({type:j,context:1,defaultValue:tv})],qs.prototype,"maskGenAlgorithm",void 0);g([y({type:v.Integer,context:2,defaultValue:20})],qs.prototype,"saltLength",void 0);g([y({type:v.Integer,context:3,defaultValue:1})],qs.prototype,"trailerField",void 0);new j({algorithm:fc,parameters:F.serialize(new qs)});class A1{constructor(e={}){this.digestAlgorithm=new j,this.digest=new Ie,Object.assign(this,e)}}g([y({type:j})],A1.prototype,"digestAlgorithm",void 0);g([y({type:Ie})],A1.prototype,"digest",void 0);var O2;class k1{constructor(e={}){this.prime=new ArrayBuffer(0),this.exponent=new ArrayBuffer(0),this.coefficient=new ArrayBuffer(0),Object.assign(this,e)}}g([y({type:v.Integer,converter:je})],k1.prototype,"prime",void 0);g([y({type:v.Integer,converter:je})],k1.prototype,"exponent",void 0);g([y({type:v.Integer,converter:je})],k1.prototype,"coefficient",void 0);let D2=O2=class extends Me{constructor(e){super(e),Object.setPrototypeOf(this,O2.prototype)}};D2=O2=g([P({type:I.Sequence,itemType:k1})],D2);class Pn{constructor(e={}){this.version=0,this.modulus=new ArrayBuffer(0),this.publicExponent=new ArrayBuffer(0),this.privateExponent=new ArrayBuffer(0),this.prime1=new ArrayBuffer(0),this.prime2=new ArrayBuffer(0),this.exponent1=new ArrayBuffer(0),this.exponent2=new ArrayBuffer(0),this.coefficient=new ArrayBuffer(0),Object.assign(this,e)}}g([y({type:v.Integer})],Pn.prototype,"version",void 0);g([y({type:v.Integer,converter:je})],Pn.prototype,"modulus",void 0);g([y({type:v.Integer,converter:je})],Pn.prototype,"publicExponent",void 0);g([y({type:v.Integer,converter:je})],Pn.prototype,"privateExponent",void 0);g([y({type:v.Integer,converter:je})],Pn.prototype,"prime1",void 0);g([y({type:v.Integer,converter:je})],Pn.prototype,"prime2",void 0);g([y({type:v.Integer,converter:je})],Pn.prototype,"exponent1",void 0);g([y({type:v.Integer,converter:je})],Pn.prototype,"exponent2",void 0);g([y({type:v.Integer,converter:je})],Pn.prototype,"coefficient",void 0);g([y({type:D2,optional:!0})],Pn.prototype,"otherPrimeInfos",void 0);class o3{constructor(e={}){this.modulus=new ArrayBuffer(0),this.publicExponent=new ArrayBuffer(0),Object.assign(this,e)}}g([y({type:v.Integer,converter:je})],o3.prototype,"modulus",void 0);g([y({type:v.Integer,converter:je})],o3.prototype,"publicExponent",void 0);var N2;(function(n){n[n.Transient=0]="Transient",n[n.Singleton=1]="Singleton",n[n.ResolutionScoped=2]="ResolutionScoped",n[n.ContainerScoped=3]="ContainerScoped"})(N2||(N2={}));const Yt=N2;var AB="injectionTokens";function kB(n){var e=Reflect.getMetadata("design:paramtypes",n)||[],t=Reflect.getOwnMetadata(AB,n)||{};return Object.keys(t).forEach(function(r){e[+r]=t[r]}),e}function nv(n){return!!n.useClass}function L2(n){return!!n.useFactory}var iv=function(){function n(e){this.wrap=e,this.reflectMethods=["get","getPrototypeOf","setPrototypeOf","getOwnPropertyDescriptor","defineProperty","has","set","deleteProperty","apply","construct","ownKeys"]}return n.prototype.createProxy=function(e){var t=this,r={},i=!1,s,o=function(){return i||(s=e(t.wrap()),i=!0),s};return new Proxy(r,this.createHandler(o))},n.prototype.createHandler=function(e){var t={},r=function(i){t[i]=function(){for(var s=[],o=0;o<arguments.length;o++)s[o]=arguments[o];s[0]=e();var a=Reflect[i];return a.apply(void 0,fs(s))}};return this.reflectMethods.forEach(r),t},n}();function co(n){return typeof n=="string"||typeof n=="symbol"}function _B(n){return typeof n=="object"&&"token"in n&&"multiple"in n}function cy(n){return typeof n=="object"&&"token"in n&&"transform"in n}function IB(n){return typeof n=="function"||n instanceof iv}function Ru(n){return!!n.useToken}function Pu(n){return n.useValue!=null}function CB(n){return nv(n)||Pu(n)||Ru(n)||L2(n)}var a3=function(){function n(){this._registryMap=new Map}return n.prototype.entries=function(){return this._registryMap.entries()},n.prototype.getAll=function(e){return this.ensure(e),this._registryMap.get(e)},n.prototype.get=function(e){this.ensure(e);var t=this._registryMap.get(e);return t[t.length-1]||null},n.prototype.set=function(e,t){this.ensure(e),this._registryMap.get(e).push(t)},n.prototype.setAll=function(e,t){this._registryMap.set(e,t)},n.prototype.has=function(e){return this.ensure(e),this._registryMap.get(e).length>0},n.prototype.clear=function(){this._registryMap.clear()},n.prototype.ensure=function(e){this._registryMap.has(e)||this._registryMap.set(e,[])},n}(),TB=function(n){Mp(e,n);function e(){return n!==null&&n.apply(this,arguments)||this}return e}(a3),iu=function(){function n(){this.scopedResolutions=new Map}return n}();function RB(n,e){if(n===null)return"at position #"+e;var t=n.split(",")[e].trim();return'"'+t+'" at position #'+e}function PB(n,e,t){return t===void 0&&(t="    "),fs([n],e.message.split(`
`).map(function(r){return t+r})).join(`
`)}function OB(n,e,t){var r=Zf(n.toString().match(/constructor\(([\w, ]+)\)/)||[],2),i=r[1],s=i===void 0?null:i,o=RB(s,e);return PB("Cannot inject the dependency "+o+' of "'+n.name+'" constructor. Reason:',t)}function DB(n){if(typeof n.dispose!="function")return!1;var e=n.dispose;return!(e.length>0)}var NB=function(n){Mp(e,n);function e(){return n!==null&&n.apply(this,arguments)||this}return e}(a3),LB=function(n){Mp(e,n);function e(){return n!==null&&n.apply(this,arguments)||this}return e}(a3),BB=function(){function n(){this.preResolution=new NB,this.postResolution=new LB}return n}(),sv=new Map,MB=function(){function n(e){this.parent=e,this._registry=new TB,this.interceptors=new BB,this.disposed=!1,this.disposables=new Set}return n.prototype.register=function(e,t,r){r===void 0&&(r={lifecycle:Yt.Transient}),this.ensureNotDisposed();var i;if(CB(t)?i=t:i={useClass:t},Ru(i))for(var s=[e],o=i;o!=null;){var a=o.useToken;if(s.includes(a))throw new Error("Token registration cycle detected! "+fs(s,[a]).join(" -> "));s.push(a);var c=this._registry.get(a);c&&Ru(c.provider)?o=c.provider:o=null}if((r.lifecycle===Yt.Singleton||r.lifecycle==Yt.ContainerScoped||r.lifecycle==Yt.ResolutionScoped)&&(Pu(i)||L2(i)))throw new Error('Cannot use lifecycle "'+Yt[r.lifecycle]+'" with ValueProviders or FactoryProviders');return this._registry.set(e,{provider:i,options:r}),this},n.prototype.registerType=function(e,t){return this.ensureNotDisposed(),co(t)?this.register(e,{useToken:t}):this.register(e,{useClass:t})},n.prototype.registerInstance=function(e,t){return this.ensureNotDisposed(),this.register(e,{useValue:t})},n.prototype.registerSingleton=function(e,t){if(this.ensureNotDisposed(),co(e)){if(co(t))return this.register(e,{useToken:t},{lifecycle:Yt.Singleton});if(t)return this.register(e,{useClass:t},{lifecycle:Yt.Singleton});throw new Error('Cannot register a type name as a singleton without a "to" token')}var r=e;return t&&!co(t)&&(r=t),this.register(e,{useClass:r},{lifecycle:Yt.Singleton})},n.prototype.resolve=function(e,t,r){t===void 0&&(t=new iu),r===void 0&&(r=!1),this.ensureNotDisposed();var i=this.getRegistration(e);if(!i&&co(e)){if(r)return;throw new Error('Attempted to resolve unregistered dependency token: "'+e.toString()+'"')}if(this.executePreResolutionInterceptor(e,"Single"),i){var s=this.resolveRegistration(i,t);return this.executePostResolutionInterceptor(e,s,"Single"),s}if(IB(e)){var s=this.construct(e,t);return this.executePostResolutionInterceptor(e,s,"Single"),s}throw new Error("Attempted to construct an undefined constructor. Could mean a circular dependency problem. Try using `delay` function.")},n.prototype.executePreResolutionInterceptor=function(e,t){var r,i;if(this.interceptors.preResolution.has(e)){var s=[];try{for(var o=Fl(this.interceptors.preResolution.getAll(e)),a=o.next();!a.done;a=o.next()){var c=a.value;c.options.frequency!="Once"&&s.push(c),c.callback(e,t)}}catch(u){r={error:u}}finally{try{a&&!a.done&&(i=o.return)&&i.call(o)}finally{if(r)throw r.error}}this.interceptors.preResolution.setAll(e,s)}},n.prototype.executePostResolutionInterceptor=function(e,t,r){var i,s;if(this.interceptors.postResolution.has(e)){var o=[];try{for(var a=Fl(this.interceptors.postResolution.getAll(e)),c=a.next();!c.done;c=a.next()){var u=c.value;u.options.frequency!="Once"&&o.push(u),u.callback(e,t,r)}}catch(d){i={error:d}}finally{try{c&&!c.done&&(s=a.return)&&s.call(a)}finally{if(i)throw i.error}}this.interceptors.postResolution.setAll(e,o)}},n.prototype.resolveRegistration=function(e,t){if(this.ensureNotDisposed(),e.options.lifecycle===Yt.ResolutionScoped&&t.scopedResolutions.has(e))return t.scopedResolutions.get(e);var r=e.options.lifecycle===Yt.Singleton,i=e.options.lifecycle===Yt.ContainerScoped,s=r||i,o;return Pu(e.provider)?o=e.provider.useValue:Ru(e.provider)?o=s?e.instance||(e.instance=this.resolve(e.provider.useToken,t)):this.resolve(e.provider.useToken,t):nv(e.provider)?o=s?e.instance||(e.instance=this.construct(e.provider.useClass,t)):this.construct(e.provider.useClass,t):L2(e.provider)?o=e.provider.useFactory(this):o=this.construct(e.provider,t),e.options.lifecycle===Yt.ResolutionScoped&&t.scopedResolutions.set(e,o),o},n.prototype.resolveAll=function(e,t,r){var i=this;t===void 0&&(t=new iu),r===void 0&&(r=!1),this.ensureNotDisposed();var s=this.getAllRegistrations(e);if(!s&&co(e)){if(r)return[];throw new Error('Attempted to resolve unregistered dependency token: "'+e.toString()+'"')}if(this.executePreResolutionInterceptor(e,"All"),s){var o=s.map(function(c){return i.resolveRegistration(c,t)});return this.executePostResolutionInterceptor(e,o,"All"),o}var a=[this.construct(e,t)];return this.executePostResolutionInterceptor(e,a,"All"),a},n.prototype.isRegistered=function(e,t){return t===void 0&&(t=!1),this.ensureNotDisposed(),this._registry.has(e)||t&&(this.parent||!1)&&this.parent.isRegistered(e,!0)},n.prototype.reset=function(){this.ensureNotDisposed(),this._registry.clear(),this.interceptors.preResolution.clear(),this.interceptors.postResolution.clear()},n.prototype.clearInstances=function(){var e,t;this.ensureNotDisposed();try{for(var r=Fl(this._registry.entries()),i=r.next();!i.done;i=r.next()){var s=Zf(i.value,2),o=s[0],a=s[1];this._registry.setAll(o,a.filter(function(c){return!Pu(c.provider)}).map(function(c){return c.instance=void 0,c}))}}catch(c){e={error:c}}finally{try{i&&!i.done&&(t=r.return)&&t.call(r)}finally{if(e)throw e.error}}},n.prototype.createChildContainer=function(){var e,t;this.ensureNotDisposed();var r=new n(this);try{for(var i=Fl(this._registry.entries()),s=i.next();!s.done;s=i.next()){var o=Zf(s.value,2),a=o[0],c=o[1];c.some(function(u){var d=u.options;return d.lifecycle===Yt.ContainerScoped})&&r._registry.setAll(a,c.map(function(u){return u.options.lifecycle===Yt.ContainerScoped?{provider:u.provider,options:u.options}:u}))}}catch(u){e={error:u}}finally{try{s&&!s.done&&(t=i.return)&&t.call(i)}finally{if(e)throw e.error}}return r},n.prototype.beforeResolution=function(e,t,r){r===void 0&&(r={frequency:"Always"}),this.interceptors.preResolution.set(e,{callback:t,options:r})},n.prototype.afterResolution=function(e,t,r){r===void 0&&(r={frequency:"Always"}),this.interceptors.postResolution.set(e,{callback:t,options:r})},n.prototype.dispose=function(){return NE(this,void 0,void 0,function(){var e;return LE(this,function(t){switch(t.label){case 0:return this.disposed=!0,e=[],this.disposables.forEach(function(r){var i=r.dispose();i&&e.push(i)}),[4,Promise.all(e)];case 1:return t.sent(),[2]}})})},n.prototype.getRegistration=function(e){return this.isRegistered(e)?this._registry.get(e):this.parent?this.parent.getRegistration(e):null},n.prototype.getAllRegistrations=function(e){return this.isRegistered(e)?this._registry.getAll(e):this.parent?this.parent.getAllRegistrations(e):null},n.prototype.construct=function(e,t){var r=this;if(e instanceof iv)return e.createProxy(function(s){return r.resolve(s,t)});var i=function(){var s=sv.get(e);if(!s||s.length===0){if(e.length===0)return new e;throw new Error('TypeInfo not known for "'+e.name+'"')}var o=s.map(r.resolveParams(t,e));return new(e.bind.apply(e,fs([void 0],o)))}();return DB(i)&&this.disposables.add(i),i},n.prototype.resolveParams=function(e,t){var r=this;return function(i,s){var o,a,c;try{return _B(i)?cy(i)?i.multiple?(o=r.resolve(i.transform)).transform.apply(o,fs([r.resolveAll(i.token,new iu,i.isOptional)],i.transformArgs)):(a=r.resolve(i.transform)).transform.apply(a,fs([r.resolve(i.token,e,i.isOptional)],i.transformArgs)):i.multiple?r.resolveAll(i.token,new iu,i.isOptional):r.resolve(i.token,e,i.isOptional):cy(i)?(c=r.resolve(i.transform,e)).transform.apply(c,fs([r.resolve(i.token,e)],i.transformArgs)):r.resolve(i,e)}catch(u){throw new Error(OB(t,s,u))}}},n.prototype.ensureNotDisposed=function(){if(this.disposed)throw new Error("This container has been disposed, you cannot interact with a disposed container")},n}(),Rt=new MB;function _1(n){return function(e){sv.set(e,kB(e))}}if(typeof Reflect>"u"||!Reflect.getMetadata)throw new Error(`tsyringe requires a reflect polyfill. Please add 'import "reflect-metadata"' to the top of your entry point.`);var B2;class I1{constructor(e={}){this.attrId="",this.attrValues=[],Object.assign(e)}}g([y({type:v.ObjectIdentifier})],I1.prototype,"attrId",void 0);g([y({type:v.Any,repeated:"set"})],I1.prototype,"attrValues",void 0);let ly=B2=class extends Me{constructor(e){super(e),Object.setPrototypeOf(this,B2.prototype)}};ly=B2=g([P({type:I.Sequence,itemType:I1})],ly);var M2;let uy=M2=class extends Me{constructor(e){super(e),Object.setPrototypeOf(this,M2.prototype)}};uy=M2=g([P({type:I.Sequence,itemType:Ia})],uy);class ov{constructor(e={}){this.certId="",this.certValue=new ArrayBuffer(0),Object.assign(this,e)}}g([y({type:v.ObjectIdentifier})],ov.prototype,"certId",void 0);g([y({type:v.Any,context:0})],ov.prototype,"certValue",void 0);class av{constructor(e={}){this.crlId="",this.crltValue=new ArrayBuffer(0),Object.assign(this,e)}}g([y({type:v.ObjectIdentifier})],av.prototype,"crlId",void 0);g([y({type:v.Any,context:0})],av.prototype,"crltValue",void 0);class cv extends Ie{}let C1=class{constructor(e={}){this.encryptionAlgorithm=new j,this.encryptedData=new cv,Object.assign(this,e)}};g([y({type:j})],C1.prototype,"encryptionAlgorithm",void 0);g([y({type:cv})],C1.prototype,"encryptedData",void 0);var U2,F2;(function(n){n[n.v1=0]="v1"})(F2||(F2={}));class lv extends Ie{}let $2=U2=class extends Me{constructor(e){super(e),Object.setPrototypeOf(this,U2.prototype)}};$2=U2=g([P({type:I.Sequence,itemType:pi})],$2);class Rl{constructor(e={}){this.version=F2.v1,this.privateKeyAlgorithm=new j,this.privateKey=new lv,Object.assign(this,e)}}g([y({type:v.Integer})],Rl.prototype,"version",void 0);g([y({type:j})],Rl.prototype,"privateKeyAlgorithm",void 0);g([y({type:lv})],Rl.prototype,"privateKey",void 0);g([y({type:$2,implicit:!0,context:0,optional:!0})],Rl.prototype,"attributes",void 0);let dy=class extends Rl{};dy=g([P({type:I.Sequence})],dy);let hy=class extends C1{};hy=g([P({type:I.Sequence})],hy);class uv{constructor(e={}){this.secretTypeId="",this.secretValue=new ArrayBuffer(0),Object.assign(this,e)}}g([y({type:v.ObjectIdentifier})],uv.prototype,"secretTypeId",void 0);g([y({type:v.Any,context:0})],uv.prototype,"secretValue",void 0);class Pl{constructor(e={}){this.mac=new A1,this.macSalt=new Ie,this.iterations=1,Object.assign(this,e)}}g([y({type:A1})],Pl.prototype,"mac",void 0);g([y({type:Ie})],Pl.prototype,"macSalt",void 0);g([y({type:v.Integer,defaultValue:1})],Pl.prototype,"iterations",void 0);class T1{constructor(e={}){this.version=3,this.authSafe=new Ia,this.macData=new Pl,Object.assign(this,e)}}g([y({type:v.Integer})],T1.prototype,"version",void 0);g([y({type:Ia})],T1.prototype,"authSafe",void 0);g([y({type:Pl,optional:!0})],T1.prototype,"macData",void 0);var H2;class R1{constructor(e={}){this.bagId="",this.bagValue=new ArrayBuffer(0),Object.assign(this,e)}}g([y({type:v.ObjectIdentifier})],R1.prototype,"bagId",void 0);g([y({type:v.Any,context:0})],R1.prototype,"bagValue",void 0);g([y({type:I1,repeated:"set",optional:!0})],R1.prototype,"bagAttributes",void 0);let fy=H2=class extends Me{constructor(e){super(e),Object.setPrototypeOf(this,H2.prototype)}};fy=H2=g([P({type:I.Sequence,itemType:R1})],fy);var V2,z2,K2;const dv="1.2.840.113549.1.9",hv=`${dv}.7`,c3=`${dv}.14`;let Zd=class extends Tt{constructor(e={}){super(e)}toString(){return this.ia5String||super.toString()}};g([y({type:v.IA5String})],Zd.prototype,"ia5String",void 0);Zd=g([P({type:I.Choice})],Zd);let py=class extends Ia{};py=g([P({type:I.Sequence})],py);let gy=class extends T1{};gy=g([P({type:I.Sequence})],gy);let my=class extends C1{};my=g([P({type:I.Sequence})],my);let q2=class{constructor(e=""){this.value=e}toString(){return this.value}};g([y({type:v.IA5String})],q2.prototype,"value",void 0);q2=g([P({type:I.Choice})],q2);let yy=class extends Zd{};yy=g([P({type:I.Choice})],yy);let wy=class extends Tt{};wy=g([P({type:I.Choice})],wy);let W2=class{constructor(e=new Date){this.value=e}};g([y({type:v.GeneralizedTime})],W2.prototype,"value",void 0);W2=g([P({type:I.Choice})],W2);let by=class extends Tt{};by=g([P({type:I.Choice})],by);let G2=class{constructor(e="M"){this.value=e}toString(){return this.value}};g([y({type:v.PrintableString})],G2.prototype,"value",void 0);G2=g([P({type:I.Choice})],G2);let Jd=class{constructor(e=""){this.value=e}toString(){return this.value}};g([y({type:v.PrintableString})],Jd.prototype,"value",void 0);Jd=g([P({type:I.Choice})],Jd);let vy=class extends Jd{};vy=g([P({type:I.Choice})],vy);let Sy=class extends Tt{};Sy=g([P({type:I.Choice})],Sy);let j2=class{constructor(e=""){this.value=e}toString(){return this.value}};g([y({type:v.ObjectIdentifier})],j2.prototype,"value",void 0);j2=g([P({type:I.Choice})],j2);let Ey=class extends xt{};Ey=g([P({type:I.Choice})],Ey);let Q2=class{constructor(e=0){this.value=e}toString(){return this.value.toString()}};g([y({type:v.Integer})],Q2.prototype,"value",void 0);Q2=g([P({type:I.Choice})],Q2);let xy=class extends Rn{};xy=g([P({type:I.Sequence})],xy);let eh=class extends Tt{};eh=g([P({type:I.Choice})],eh);let Ay=V2=class extends Zi{constructor(e){super(e),Object.setPrototypeOf(this,V2.prototype)}};Ay=V2=g([P({type:I.Sequence})],Ay);let ky=z2=class extends Me{constructor(e){super(e),Object.setPrototypeOf(this,z2.prototype)}};ky=z2=g([P({type:I.Set,itemType:_a})],ky);let Y2=class{constructor(e=""){this.value=e}toString(){return this.value}};g([y({type:v.BmpString})],Y2.prototype,"value",void 0);Y2=g([P({type:I.Choice})],Y2);let X2=class extends j{};X2=g([P({type:I.Sequence})],X2);let _y=K2=class extends Me{constructor(e){super(e),Object.setPrototypeOf(this,K2.prototype)}};_y=K2=g([P({type:I.Sequence,itemType:X2})],_y);var Z2;let th=Z2=class extends Me{constructor(e){super(e),Object.setPrototypeOf(this,Z2.prototype)}};th=Z2=g([P({type:I.Sequence,itemType:pi})],th);class Ra{constructor(e={}){this.version=0,this.subject=new st,this.subjectPKInfo=new Zr,this.attributes=new th,Object.assign(this,e)}}g([y({type:v.Integer})],Ra.prototype,"version",void 0);g([y({type:st})],Ra.prototype,"subject",void 0);g([y({type:Zr})],Ra.prototype,"subjectPKInfo",void 0);g([y({type:th,implicit:!0,context:0})],Ra.prototype,"attributes",void 0);class Kc{constructor(e={}){this.certificationRequestInfo=new Ra,this.signatureAlgorithm=new j,this.signature=new ArrayBuffer(0),Object.assign(this,e)}}g([y({type:Ra})],Kc.prototype,"certificationRequestInfo",void 0);g([y({type:j})],Kc.prototype,"signatureAlgorithm",void 0);g([y({type:v.BitString})],Kc.prototype,"signature",void 0);/*!
 * MIT License
 * 
 * Copyright (c) Peculiar Ventures. All rights reserved.
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 * 
 */const Ol="crypto.algorithm";class UB{getAlgorithms(){return Rt.resolveAll(Ol)}toAsnAlgorithm(e){({...e});for(const t of this.getAlgorithms()){const r=t.toAsnAlgorithm(e);if(r)return r}if(/^[0-9.]+$/.test(e.name)){const t=new j({algorithm:e.name});if("parameters"in e){const r=e;t.parameters=r.parameters}return t}throw new Error("Cannot convert WebCrypto algorithm to ASN.1 algorithm")}toWebAlgorithm(e){for(const r of this.getAlgorithms()){const i=r.toWebAlgorithm(e);if(i)return i}return{name:e.algorithm,parameters:e.parameters}}}const Ws="crypto.algorithmProvider";Rt.registerSingleton(Ws,UB);var Ou;const ur="1.3.36.3.3.2.8.1.1",Iy=`${ur}.1`,Cy=`${ur}.2`,Ty=`${ur}.3`,Ry=`${ur}.4`,Py=`${ur}.5`,Oy=`${ur}.6`,Dy=`${ur}.7`,Ny=`${ur}.8`,Ly=`${ur}.9`,By=`${ur}.10`,My=`${ur}.11`,Uy=`${ur}.12`,Fy=`${ur}.13`,$y=`${ur}.14`,Hy="brainpoolP160r1",Vy="brainpoolP160t1",zy="brainpoolP192r1",Ky="brainpoolP192t1",qy="brainpoolP224r1",Wy="brainpoolP224t1",Gy="brainpoolP256r1",jy="brainpoolP256t1",Qy="brainpoolP320r1",Yy="brainpoolP320t1",Xy="brainpoolP384r1",Zy="brainpoolP384t1",Jy="brainpoolP512r1",e5="brainpoolP512t1",Je="ECDSA";let qc=Ou=class{toAsnAlgorithm(e){switch(e.name.toLowerCase()){case Je.toLowerCase():if("hash"in e)switch((typeof e.hash=="string"?e.hash:e.hash.name).toLowerCase()){case"sha-1":return uB;case"sha-256":return dB;case"sha-384":return hB;case"sha-512":return fB}else if("namedCurve"in e){let t="";switch(e.namedCurve){case"P-256":t=sy;break;case"K-256":t=Ou.SECP256K1;break;case"P-384":t=oy;break;case"P-521":t=ay;break;case Hy:t=Iy;break;case Vy:t=Cy;break;case zy:t=Ty;break;case Ky:t=Ry;break;case qy:t=Py;break;case Wy:t=Oy;break;case Gy:t=Dy;break;case jy:t=Ny;break;case Qy:t=Ly;break;case Yy:t=By;break;case Xy:t=My;break;case Zy:t=Uy;break;case Jy:t=Fy;break;case e5:t=$y;break}if(t)return new j({algorithm:Vc,parameters:F.serialize(new es({namedCurve:t}))})}}return null}toWebAlgorithm(e){switch(e.algorithm){case r3:return{name:Je,hash:{name:"SHA-1"}};case n3:return{name:Je,hash:{name:"SHA-256"}};case i3:return{name:Je,hash:{name:"SHA-384"}};case s3:return{name:Je,hash:{name:"SHA-512"}};case Vc:{if(!e.parameters)throw new TypeError("Cannot get required parameters from EC algorithm");switch(F.parse(e.parameters,es).namedCurve){case sy:return{name:Je,namedCurve:"P-256"};case Ou.SECP256K1:return{name:Je,namedCurve:"K-256"};case oy:return{name:Je,namedCurve:"P-384"};case ay:return{name:Je,namedCurve:"P-521"};case Iy:return{name:Je,namedCurve:Hy};case Cy:return{name:Je,namedCurve:Vy};case Ty:return{name:Je,namedCurve:zy};case Ry:return{name:Je,namedCurve:Ky};case Py:return{name:Je,namedCurve:qy};case Oy:return{name:Je,namedCurve:Wy};case Dy:return{name:Je,namedCurve:Gy};case Ny:return{name:Je,namedCurve:jy};case Ly:return{name:Je,namedCurve:Qy};case By:return{name:Je,namedCurve:Yy};case My:return{name:Je,namedCurve:Xy};case Uy:return{name:Je,namedCurve:Zy};case Fy:return{name:Je,namedCurve:Jy};case $y:return{name:Je,namedCurve:e5}}}}return null}};qc.SECP256K1="1.3.132.0.10";qc=Ou=g([_1()],qc);Rt.registerSingleton(Ol,qc);const fv=Symbol("name"),pv=Symbol("value");class Oe{constructor(e,t={},r=""){this[fv]=e,this[pv]=r;for(const i in t)this[i]=t[i]}}Oe.NAME=fv;Oe.VALUE=pv;class FB{static toTextObject(e){const t=new Oe("Algorithm Identifier",{},is.toString(e.algorithm));if(e.parameters)switch(e.algorithm){case Vc:{const r=new qc().toWebAlgorithm(e);r&&"namedCurve"in r?t["Named Curve"]=r.namedCurve:t.Parameters=e.parameters;break}default:t.Parameters=e.parameters}return t}}class is{static toString(e){const t=this.items[e];return t||e}}is.items={[jd]:"sha1",[ev]:"sha224",[Qd]:"sha256",[Yd]:"sha384",[Xd]:"sha512",[zs]:"rsaEncryption",[qd]:"sha1WithRSAEncryption",[bB]:"sha224WithRSAEncryption",[P2]:"sha256WithRSAEncryption",[Wd]:"sha384WithRSAEncryption",[Gd]:"sha512WithRSAEncryption",[Vc]:"ecPublicKey",[r3]:"ecdsaWithSHA1",[Xb]:"ecdsaWithSHA224",[n3]:"ecdsaWithSHA256",[i3]:"ecdsaWithSHA384",[s3]:"ecdsaWithSHA512",[nB]:"TLS WWW server authentication",[iB]:"TLS WWW client authentication",[sB]:"Code Signing",[oB]:"E-mail Protection",[aB]:"Time Stamping",[cB]:"OCSP Signing",[lB]:"Signed Data"};class Gs{static serialize(e){return this.serializeObj(e).join(`
`)}static pad(e=0){return"".padStart(2*e," ")}static serializeObj(e,t=0){const r=[];let i=this.pad(t++),s="";const o=e[Oe.VALUE];o&&(s=` ${o}`),r.push(`${i}${e[Oe.NAME]}:${s}`),i=this.pad(t);for(const a in e){if(typeof a=="symbol")continue;const c=e[a],u=a?`${a}: `:"";if(typeof c=="string"||typeof c=="number"||typeof c=="boolean")r.push(`${i}${u}${c}`);else if(c instanceof Date)r.push(`${i}${u}${c.toUTCString()}`);else if(Array.isArray(c))for(const d of c)d[Oe.NAME]=a,r.push(...this.serializeObj(d,t));else if(c instanceof Oe)c[Oe.NAME]=a,r.push(...this.serializeObj(c,t));else if(H.isBufferSource(c))a?(r.push(`${i}${u}`),r.push(...this.serializeBufferSource(c,t+1))):r.push(...this.serializeBufferSource(c,t));else if("toTextObject"in c){const d=c.toTextObject();d[Oe.NAME]=a,r.push(...this.serializeObj(d,t))}else throw new TypeError("Cannot serialize data in text format. Unsupported type.")}return r}static serializeBufferSource(e,t=0){const r=this.pad(t),i=H.toUint8Array(e),s=[];for(let o=0;o<i.length;){const a=[];for(let c=0;c<16&&o<i.length;c++){c===8&&a.push("");const u=i[o++].toString(16).padStart(2,"0");a.push(u)}s.push(`${r}${a.join(" ")}`)}return s}static serializeAlgorithm(e){return this.algorithmSerializer.toTextObject(e)}}Gs.oidSerializer=is;Gs.algorithmSerializer=FB;class ss{constructor(...e){if(e.length===1){const t=e[0];this.rawData=F.serialize(t),this.onInit(t)}else{const t=F.parse(e[0],e[1]);this.rawData=H.toArrayBuffer(e[0]),this.onInit(t)}}equal(e){return e instanceof ss?V9(e.rawData,this.rawData):!1}toString(e="text"){switch(e){case"asn":return F.toString(this.rawData);case"text":return Gs.serialize(this.toTextObject());case"hex":return ee.ToHex(this.rawData);case"base64":return ee.ToBase64(this.rawData);case"base64url":return ee.ToBase64Url(this.rawData);default:throw TypeError("Argument 'format' is unsupported value")}}getTextName(){return this.constructor.NAME}toTextObject(){const e=this.toTextObjectEmpty();return e[""]=this.rawData,e}toTextObjectEmpty(e){return new Oe(this.getTextName(),{},e)}}ss.NAME="ASN";class xr extends ss{constructor(...e){let t;H.isBufferSource(e[0])?t=H.toArrayBuffer(e[0]):t=F.serialize(new Fr({extnID:e[0],critical:e[1],extnValue:new Ie(H.toArrayBuffer(e[2]))})),super(t,Fr)}onInit(e){this.type=e.extnID,this.critical=e.critical,this.value=e.extnValue.buffer}toTextObject(){const e=this.toTextObjectWithoutValue();return e[""]=this.value,e}toTextObjectWithoutValue(){const e=this.toTextObjectEmpty(this.critical?"critical":void 0);return e[Oe.NAME]===xr.NAME&&(e[Oe.NAME]=is.toString(this.type)),e}}var gv;class Mi{static isCryptoKeyPair(e){return e&&e.privateKey&&e.publicKey}static isCryptoKey(e){return e&&e.usages&&e.type&&e.algorithm&&e.extractable!==void 0}constructor(){this.items=new Map,this[gv]="CryptoProvider",typeof self<"u"&&typeof crypto<"u"?this.set(Mi.DEFAULT,crypto):typeof global<"u"&&global.crypto&&global.crypto.subtle&&this.set(Mi.DEFAULT,global.crypto)}clear(){this.items.clear()}delete(e){return this.items.delete(e)}forEach(e,t){return this.items.forEach(e,t)}has(e){return this.items.has(e)}get size(){return this.items.size}entries(){return this.items.entries()}keys(){return this.items.keys()}values(){return this.items.values()}[Symbol.iterator](){return this.items[Symbol.iterator]()}get(e=Mi.DEFAULT){const t=this.items.get(e.toLowerCase());if(!t)throw new Error(`Cannot get Crypto by name '${e}'`);return t}set(e,t){if(typeof e=="string"){if(!t)throw new TypeError("Argument 'value' is required");this.items.set(e.toLowerCase(),t)}else this.items.set(Mi.DEFAULT,e);return this}}gv=Symbol.toStringTag;Mi.DEFAULT="default";const Et=new Mi,$B=/^[0-2](?:\.[1-9][0-9]*)+$/;function HB(n){return new RegExp($B).test(n)}class mv{constructor(e={}){this.items={};for(const t in e)this.register(t,e[t])}get(e){return this.items[e]||null}findId(e){return HB(e)?e:this.get(e)}register(e,t){this.items[e]=t,this.items[t]=e}}const or=new mv;or.register("CN","2.5.4.3");or.register("L","2.5.4.7");or.register("ST","2.5.4.8");or.register("O","2.5.4.10");or.register("OU","2.5.4.11");or.register("C","2.5.4.6");or.register("DC","0.9.2342.19200300.100.1.25");or.register("E","1.2.840.113549.1.9.1");or.register("G","2.5.4.42");or.register("I","2.5.4.43");or.register("SN","2.5.4.4");or.register("T","2.5.4.12");function VB(n,e){return`\\${ee.ToHex(ee.FromUtf8String(e)).toUpperCase()}`}function zB(n){return n.replace(/([,+"\\<>;])/g,"\\$1").replace(/^([ #])/,"\\$1").replace(/([ ]$)/,"\\$1").replace(/([\r\n\t])/,VB)}class Lr{static isASCII(e){for(let t=0;t<e.length;t++)if(e.charCodeAt(t)>255)return!1;return!0}static isPrintableString(e){return/^[A-Za-z0-9 '()+,-./:=?]*$/g.test(e)}constructor(e,t={}){this.extraNames=new mv,this.asn=new st;for(const r in t)if(Object.prototype.hasOwnProperty.call(t,r)){const i=t[r];this.extraNames.register(r,i)}typeof e=="string"?this.asn=this.fromString(e):e instanceof st?this.asn=e:H.isBufferSource(e)?this.asn=F.parse(e,st):this.asn=this.fromJSON(e)}getField(e){const t=this.extraNames.findId(e)||or.findId(e),r=[];for(const i of this.asn)for(const s of i)s.type===t&&r.push(s.value.toString());return r}getName(e){return this.extraNames.get(e)||or.get(e)}toString(){return this.asn.map(e=>e.map(t=>{const r=this.getName(t.type)||t.type,i=t.value.anyValue?`#${ee.ToHex(t.value.anyValue)}`:zB(t.value.toString());return`${r}=${i}`}).join("+")).join(", ")}toJSON(){var e;const t=[];for(const r of this.asn){const i={};for(const s of r){const o=this.getName(s.type)||s.type;(e=i[o])!==null&&e!==void 0||(i[o]=[]),i[o].push(s.value.anyValue?`#${ee.ToHex(s.value.anyValue)}`:s.value.toString())}t.push(i)}return t}fromString(e){const t=new st,r=/(\d\.[\d.]*\d|[A-Za-z]+)=((?:"")|(?:".*?[^\\]")|(?:[^,+"\\](?=[,+]|$))|(?:[^,+].*?(?:[^\\][,+]))|(?:))([,+])?/g;let i=null,s=",";for(;i=r.exec(`${e},`);){let[,o,a]=i;const c=a[a.length-1];(c===","||c==="+")&&(a=a.slice(0,a.length-1),i[3]=c);const u=i[3];o=this.getTypeOid(o);const d=this.createAttribute(o,a);s==="+"?t[t.length-1].push(d):t.push(new aa([d])),s=u}return t}fromJSON(e){const t=new st;for(const r of e){const i=new aa;for(const s in r){const o=this.getTypeOid(s),a=r[s];for(const c of a){const u=this.createAttribute(o,c);i.push(u)}}t.push(i)}return t}getTypeOid(e){if(/[\d.]+/.test(e)||(e=this.getName(e)||""),!e)throw new Error(`Cannot get OID for name type '${e}'`);return e}createAttribute(e,t){const r=new o1({type:e});if(typeof t=="object")for(const i in t)switch(i){case"ia5String":r.value.ia5String=t[i];break;case"utf8String":r.value.utf8String=t[i];break;case"universalString":r.value.universalString=t[i];break;case"bmpString":r.value.bmpString=t[i];break;case"printableString":r.value.printableString=t[i];break}else if(t[0]==="#")r.value.anyValue=ee.FromHex(t.slice(1));else{const i=this.processStringValue(t);e===this.getName("E")||e===this.getName("DC")?r.value.ia5String=i:Lr.isPrintableString(i)?r.value.printableString=i:r.value.utf8String=i}return r}processStringValue(e){const t=/"(.*?[^\\])?"/.exec(e);return t&&(e=t[1]),e.replace(/\\0a/ig,`
`).replace(/\\0d/ig,"\r").replace(/\\0g/ig,"	").replace(/\\(.)/g,"$1")}toArrayBuffer(){return F.serialize(this.asn)}async getThumbprint(...e){var t;let r,i="SHA-1";return e.length>=1&&!(!((t=e[0])===null||t===void 0)&&t.subtle)?(i=e[0]||i,r=e[1]||Et.get()):r=e[0]||Et.get(),await r.subtle.digest(i,this.toArrayBuffer())}}const yv="Cannot initialize GeneralName from ASN.1 data.",t5=`${yv} Unsupported string format in use.`,KB=`${yv} Value doesn't match to GUID regular expression.`,r5=/^([0-9a-f]{8})-?([0-9a-f]{4})-?([0-9a-f]{4})-?([0-9a-f]{4})-?([0-9a-f]{12})$/i,n5="1.3.6.1.4.1.311.25.1",i5="1.3.6.1.4.1.311.20.2.3",Sf="dns",Ef="dn",xf="email",Af="ip",kf="url",_f="guid",If="upn",su="id";class Ui extends ss{constructor(...e){let t;if(e.length===2)switch(e[0]){case Ef:{const r=new Lr(e[1]).toArrayBuffer(),i=F.parse(r,st);t=new he({directoryName:i});break}case Sf:t=new he({dNSName:e[1]});break;case xf:t=new he({rfc822Name:e[1]});break;case _f:{const r=new RegExp(r5,"i").exec(e[1]);if(!r)throw new Error("Cannot parse GUID value. Value doesn't match to regular expression");const i=r.slice(1).map((s,o)=>o<3?ee.ToHex(new Uint8Array(ee.FromHex(s)).reverse()):s).join("");t=new he({otherName:new Uc({typeId:n5,value:F.serialize(new Ie(ee.FromHex(i)))})});break}case Af:t=new he({iPAddress:e[1]});break;case su:t=new he({registeredID:e[1]});break;case If:{t=new he({otherName:new Uc({typeId:i5,value:F.serialize(Db.toASN(e[1]))})});break}case kf:t=new he({uniformResourceIdentifier:e[1]});break;default:throw new Error("Cannot create GeneralName. Unsupported type of the name")}else H.isBufferSource(e[0])?t=F.parse(e[0],he):t=e[0];super(t)}onInit(e){if(e.dNSName!=null)this.type=Sf,this.value=e.dNSName;else if(e.rfc822Name!=null)this.type=xf,this.value=e.rfc822Name;else if(e.iPAddress!=null)this.type=Af,this.value=e.iPAddress;else if(e.uniformResourceIdentifier!=null)this.type=kf,this.value=e.uniformResourceIdentifier;else if(e.registeredID!=null)this.type=su,this.value=e.registeredID;else if(e.directoryName!=null)this.type=Ef,this.value=new Lr(e.directoryName).toString();else if(e.otherName!=null)if(e.otherName.typeId===n5){this.type=_f;const t=F.parse(e.otherName.value,Ie),r=new RegExp(r5,"i").exec(ee.ToHex(t));if(!r)throw new Error(KB);this.value=r.slice(1).map((i,s)=>s<3?ee.ToHex(new Uint8Array(ee.FromHex(i)).reverse()):i).join("-")}else if(e.otherName.typeId===i5)this.type=If,this.value=F.parse(e.otherName.value,Tt).toString();else throw new Error(t5);else throw new Error(t5)}toJSON(){return{type:this.type,value:this.value}}toTextObject(){let e;switch(this.type){case Ef:case Sf:case _f:case Af:case su:case If:case kf:e=this.type.toUpperCase();break;case xf:e="Email";break;default:throw new Error("Unsupported GeneralName type")}let t=this.value;return this.type===su&&(t=is.toString(t)),new Oe(e,void 0,t)}}class js extends ss{constructor(e){let t;if(e instanceof Lt)t=e;else if(Array.isArray(e)){const r=[];for(const i of e)if(i instanceof he)r.push(i);else{const s=F.parse(new Ui(i.type,i.value).rawData,he);r.push(s)}t=new Lt(r)}else if(H.isBufferSource(e))t=F.parse(e,Lt);else throw new Error("Cannot initialize GeneralNames. Incorrect incoming arguments");super(t)}onInit(e){const t=[];for(const r of e){let i=null;try{i=new Ui(r)}catch{continue}t.push(i)}this.items=t}toJSON(){return this.items.map(e=>e.toJSON())}toTextObject(){const e=super.toTextObjectEmpty();for(const t of this.items){const r=t.toTextObject();let i=e[r[Oe.NAME]];Array.isArray(i)||(i=[],e[r[Oe.NAME]]=i),i.push(r)}return e}}js.NAME="GeneralNames";const pc="-{5}",Wc="\\n",qB=`[^${Wc}]+`,WB=`${pc}BEGIN (${qB}(?=${pc}))${pc}`,GB=`${pc}END \\1${pc}`,ga="\\n",jB=`[^:${Wc}]+`,QB=`(?:[^${Wc}]+${ga}(?: +[^${Wc}]+${ga})*)`,YB="[a-zA-Z0-9=+/]+",XB=`(?:${YB}${ga})+`,s5=`${WB}${ga}(?:((?:${jB}: ${QB})+))?${ga}?(${XB})${GB}`;class gr{static isPem(e){return typeof e=="string"&&new RegExp(s5,"g").test(e.replace(/\r/g,""))}static decodeWithHeaders(e){e=e.replace(/\r/g,"");const t=new RegExp(s5,"g"),r=[];let i=null;for(;i=t.exec(e);){const s=i[3].replace(new RegExp(`[${Wc}]+`,"g"),""),o={type:i[1],headers:[],rawData:ee.FromBase64(s)},a=i[2];if(a){const c=a.split(new RegExp(ga,"g"));let u=null;for(const d of c){const[h,f]=d.split(/:(.*)/);if(f===void 0){if(!u)throw new Error("Cannot parse PEM string. Incorrect header value");u.value+=h.trim()}else u&&o.headers.push(u),u={key:h,value:f.trim()}}u&&o.headers.push(u)}r.push(o)}return r}static decode(e){return this.decodeWithHeaders(e).map(r=>r.rawData)}static decodeFirst(e){const t=this.decode(e);if(!t.length)throw new RangeError("PEM string doesn't contain any objects");return t[0]}static encode(e,t){if(Array.isArray(e)){const r=new Array;return t?e.forEach(i=>{if(!H.isBufferSource(i))throw new TypeError("Cannot encode array of BufferSource in PEM format. Not all items of the array are BufferSource");r.push(this.encodeStruct({type:t,rawData:H.toArrayBuffer(i)}))}):e.forEach(i=>{if(!("type"in i))throw new TypeError("Cannot encode array of PemStruct in PEM format. Not all items of the array are PemStrut");r.push(this.encodeStruct(i))}),r.join(`
`)}else{if(!t)throw new Error("Required argument 'tag' is missed");return this.encodeStruct({type:t,rawData:H.toArrayBuffer(e)})}}static encodeStruct(e){var t;const r=e.type.toLocaleUpperCase(),i=[];if(i.push(`-----BEGIN ${r}-----`),!((t=e.headers)===null||t===void 0)&&t.length){for(const u of e.headers)i.push(`${u.key}: ${u.value}`);i.push("")}const s=ee.ToBase64(e.rawData);let o,a=0;const c=Array();for(;a<s.length&&(s.length-a<64?o=s.substring(a):(o=s.substring(a,a+64),a+=64),o.length!==0);)if(c.push(o),o.length<64)break;return i.push(...c),i.push(`-----END ${r}-----`),i.join(`
`)}}gr.CertificateTag="CERTIFICATE";gr.CrlTag="CRL";gr.CertificateRequestTag="CERTIFICATE REQUEST";gr.PublicKeyTag="PUBLIC KEY";gr.PrivateKeyTag="PRIVATE KEY";class yi extends ss{static isAsnEncoded(e){return H.isBufferSource(e)||typeof e=="string"}static toArrayBuffer(e){if(typeof e=="string"){if(gr.isPem(e))return gr.decode(e)[0];if(ee.isHex(e))return ee.FromHex(e);if(ee.isBase64(e))return ee.FromBase64(e);if(ee.isBase64Url(e))return ee.FromBase64Url(e);throw new TypeError("Unsupported format of 'raw' argument. Must be one of DER, PEM, HEX, Base64, or Base4Url")}else{const t=ee.ToBinary(e);return gr.isPem(t)?gr.decode(t)[0]:ee.isHex(t)?ee.FromHex(t):ee.isBase64(t)?ee.FromBase64(t):ee.isBase64Url(t)?ee.FromBase64Url(t):H.toArrayBuffer(e)}}constructor(...e){yi.isAsnEncoded(e[0])?super(yi.toArrayBuffer(e[0]),e[1]):super(e[0])}toString(e="pem"){switch(e){case"pem":return gr.encode(this.rawData,this.tag);default:return super.toString(e)}}}class tn extends yi{static async create(e,t=Et.get()){if(e instanceof tn)return e;if(Mi.isCryptoKey(e)){if(e.type!=="public")throw new TypeError("Public key is required");const r=await t.subtle.exportKey("spki",e);return new tn(r)}else{if(e.publicKey)return e.publicKey;if(H.isBufferSource(e))return new tn(e);throw new TypeError("Unsupported PublicKeyType")}}constructor(e){yi.isAsnEncoded(e)?super(e,Zr):super(e),this.tag=gr.PublicKeyTag}async export(...e){let t,r=["verify"],i={hash:"SHA-256",...this.algorithm};e.length>1?(i=e[0]||i,r=e[1]||r,t=e[2]||Et.get()):t=e[0]||Et.get();let s=this.rawData;const o=F.parse(this.rawData,Zr);return o.algorithm.algorithm===fc&&(s=ZB(o,s)),t.subtle.importKey("spki",s,i,!0,r)}onInit(e){const t=Rt.resolve(Ws),r=this.algorithm=t.toWebAlgorithm(e.algorithm);switch(e.algorithm.algorithm){case zs:{const i=F.parse(e.subjectPublicKey,o3),s=H.toUint8Array(i.modulus);r.publicExponent=H.toUint8Array(i.publicExponent),r.modulusLength=(s[0]?s:s.slice(1)).byteLength<<3;break}}}async getThumbprint(...e){var t;let r,i="SHA-1";return e.length>=1&&!(!((t=e[0])===null||t===void 0)&&t.subtle)?(i=e[0]||i,r=e[1]||Et.get()):r=e[0]||Et.get(),await r.subtle.digest(i,this.rawData)}async getKeyIdentifier(...e){let t,r="SHA-1";e.length===1?typeof e[0]=="string"?(r=e[0],t=Et.get()):t=e[0]:e.length===2?(r=e[0],t=e[1]):t=Et.get();const i=F.parse(this.rawData,Zr);return await t.subtle.digest(r,i.subjectPublicKey)}toTextObject(){const e=this.toTextObjectEmpty(),t=F.parse(this.rawData,Zr);switch(e.Algorithm=Gs.serializeAlgorithm(t.algorithm),t.algorithm.algorithm){case Vc:e["EC Point"]=t.subjectPublicKey;break;case zs:default:e["Raw Data"]=t.subjectPublicKey}return e}}function ZB(n,e){return n.algorithm=new j({algorithm:zs,parameters:null}),e=F.serialize(n),e}class Gc extends xr{static async create(e,t=!1,r=Et.get()){if("name"in e&&"serialNumber"in e)return new Gc(e,t);const s=await(await tn.create(e,r)).getKeyIdentifier(r);return new Gc(ee.ToHex(s),t)}constructor(...e){if(H.isBufferSource(e[0]))super(e[0]);else if(typeof e[0]=="string"){const t=new Ss({keyIdentifier:new Hg(ee.FromHex(e[0]))});super(Q0,e[1],F.serialize(t))}else{const t=e[0],r=t.name instanceof js?F.parse(t.name.rawData,Lt):t.name,i=new Ss({authorityCertIssuer:r,authorityCertSerialNumber:ee.FromHex(t.serialNumber)});super(Q0,e[1],F.serialize(i))}}onInit(e){super.onInit(e);const t=F.parse(e.extnValue,Ss);t.keyIdentifier&&(this.keyId=ee.ToHex(t.keyIdentifier)),(t.authorityCertIssuer||t.authorityCertSerialNumber)&&(this.certId={name:t.authorityCertIssuer||[],serialNumber:t.authorityCertSerialNumber?ee.ToHex(t.authorityCertSerialNumber):""})}toTextObject(){const e=this.toTextObjectWithoutValue(),t=F.parse(this.value,Ss);return t.authorityCertIssuer&&(e["Authority Issuer"]=new js(t.authorityCertIssuer).toTextObject()),t.authorityCertSerialNumber&&(e["Authority Serial Number"]=t.authorityCertSerialNumber),t.keyIdentifier&&(e[""]=t.keyIdentifier),e}}Gc.NAME="Authority Key Identifier";class l3 extends xr{constructor(...e){if(H.isBufferSource(e[0])){super(e[0]);const t=F.parse(this.value,Id);this.ca=t.cA,this.pathLength=t.pathLenConstraint}else{const t=new Id({cA:e[0],pathLenConstraint:e[1]});super(Lb,e[2],F.serialize(t)),this.ca=e[0],this.pathLength=e[1]}}toTextObject(){const e=this.toTextObjectWithoutValue();return this.ca&&(e.CA=this.ca),this.pathLength!==void 0&&(e["Path Length"]=this.pathLength),e}}l3.NAME="Basic Constraints";var o5;(function(n){n.serverAuth="1.3.6.1.5.5.7.3.1",n.clientAuth="1.3.6.1.5.5.7.3.2",n.codeSigning="1.3.6.1.5.5.7.3.3",n.emailProtection="1.3.6.1.5.5.7.3.4",n.timeStamping="1.3.6.1.5.5.7.3.8",n.ocspSigning="1.3.6.1.5.5.7.3.9"})(o5||(o5={}));class wv extends xr{constructor(...e){if(H.isBufferSource(e[0])){super(e[0]);const t=F.parse(this.value,Pd);this.usages=t.map(r=>r)}else{const t=new Pd(e[0]);super(Ub,e[1],F.serialize(t)),this.usages=e[0]}}toTextObject(){const e=this.toTextObjectWithoutValue();return e[""]=this.usages.map(t=>is.toString(t)).join(", "),e}}wv.NAME="Extended Key Usages";var a5;(function(n){n[n.digitalSignature=1]="digitalSignature",n[n.nonRepudiation=2]="nonRepudiation",n[n.keyEncipherment=4]="keyEncipherment",n[n.dataEncipherment=8]="dataEncipherment",n[n.keyAgreement=16]="keyAgreement",n[n.keyCertSign=32]="keyCertSign",n[n.cRLSign=64]="cRLSign",n[n.encipherOnly=128]="encipherOnly",n[n.decipherOnly=256]="decipherOnly"})(a5||(a5={}));class bv extends xr{constructor(...e){if(H.isBufferSource(e[0])){super(e[0]);const t=F.parse(this.value,vf);this.usages=t.toNumber()}else{const t=new vf(e[0]);super($b,e[1],F.serialize(t)),this.usages=e[0]}}toTextObject(){const e=this.toTextObjectWithoutValue(),t=F.parse(this.value,vf);return e[""]=t.toJSON().join(", "),e}}bv.NAME="Key Usages";class P1 extends xr{static async create(e,t=!1,r=Et.get()){const s=await(await tn.create(e,r)).getKeyIdentifier(r);return new P1(ee.ToHex(s),t)}constructor(...e){if(H.isBufferSource(e[0])){super(e[0]);const t=F.parse(this.value,Ki);this.keyId=ee.ToHex(t)}else{const t=typeof e[0]=="string"?ee.FromHex(e[0]):e[0],r=new Ki(t);super(Kb,e[1],F.serialize(r)),this.keyId=ee.ToHex(t)}}toTextObject(){const e=this.toTextObjectWithoutValue(),t=F.parse(this.value,Ki);return e[""]=t,e}}P1.NAME="Subject Key Identifier";class vv extends xr{constructor(...e){H.isBufferSource(e[0])?super(e[0]):super(zb,e[1],new js(e[0]||[]).rawData)}onInit(e){super.onInit(e);const t=F.parse(e.extnValue,u2);this.names=new js(t)}toTextObject(){const e=this.toTextObjectWithoutValue(),t=this.names.toTextObject();for(const r in t)e[r]=t[r];return e}}vv.NAME="Subject Alternative Name";class Ar{static register(e,t){this.items.set(e,t)}static create(e){const t=new xr(e),r=this.items.get(t.type);return r?new r(e):t}}Ar.items=new Map;class Sv extends xr{constructor(...e){var t;if(H.isBufferSource(e[0])){super(e[0]);const r=F.parse(this.value,Td);this.policies=r.map(i=>i.policyIdentifier)}else{const r=e[0],i=(t=e[1])!==null&&t!==void 0?t:!1,s=new Td(r.map(o=>new c1({policyIdentifier:o})));super(Bb,i,F.serialize(s)),this.policies=r}}toTextObject(){const e=this.toTextObjectWithoutValue();return e.Policy=this.policies.map(t=>new Oe("",{},is.toString(t))),e}}Sv.NAME="Certificate Policies";Ar.register(Bb,Sv);class Ev extends xr{constructor(...e){var t;if(H.isBufferSource(e[0]))super(e[0]);else if(Array.isArray(e[0])&&typeof e[0][0]=="string"){const i=e[0].map(o=>new Aa({distributionPoint:new Fs({fullName:[new he({uniformResourceIdentifier:o})]})})),s=new Lo(i);super(e2,e[1],F.serialize(s))}else{const r=new Lo(e[0]);super(e2,e[1],F.serialize(r))}(t=this.distributionPoints)!==null&&t!==void 0||(this.distributionPoints=[])}onInit(e){super.onInit(e);const t=F.parse(e.extnValue,Lo);this.distributionPoints=t}toTextObject(){const e=this.toTextObjectWithoutValue();return e["Distribution Point"]=this.distributionPoints.map(t=>{var r;const i={};return t.distributionPoint&&(i[""]=(r=t.distributionPoint.fullName)===null||r===void 0?void 0:r.map(s=>new Ui(s).toString()).join(", ")),t.reasons&&(i.Reasons=t.reasons.toString()),t.cRLIssuer&&(i["CRL Issuer"]=t.cRLIssuer.map(s=>s.toString()).join(", ")),i}),e}}Ev.NAME="CRL Distribution Points";class xv extends xr{constructor(...e){var t,r,i,s;if(H.isBufferSource(e[0]))super(e[0]);else if(e[0]instanceof uo){const o=new uo(e[0]);super(j0,e[1],F.serialize(o))}else{const o=e[0],a=new uo;au(a,o,K4,"ocsp"),au(a,o,q4,"caIssuers"),au(a,o,W4,"timeStamping"),au(a,o,G4,"caRepository"),super(j0,e[1],F.serialize(a))}(t=this.ocsp)!==null&&t!==void 0||(this.ocsp=[]),(r=this.caIssuers)!==null&&r!==void 0||(this.caIssuers=[]),(i=this.timeStamping)!==null&&i!==void 0||(this.timeStamping=[]),(s=this.caRepository)!==null&&s!==void 0||(this.caRepository=[])}onInit(e){super.onInit(e),this.ocsp=[],this.caIssuers=[],this.timeStamping=[],this.caRepository=[],F.parse(e.extnValue,uo).forEach(r=>{switch(r.accessMethod){case K4:this.ocsp.push(new Ui(r.accessLocation));break;case q4:this.caIssuers.push(new Ui(r.accessLocation));break;case W4:this.timeStamping.push(new Ui(r.accessLocation));break;case G4:this.caRepository.push(new Ui(r.accessLocation));break}})}toTextObject(){const e=this.toTextObjectWithoutValue();return this.ocsp.length&&ou(e,"OCSP",this.ocsp),this.caIssuers.length&&ou(e,"CA Issuers",this.caIssuers),this.timeStamping.length&&ou(e,"Time Stamping",this.timeStamping),this.caRepository.length&&ou(e,"CA Repository",this.caRepository),e}}xv.NAME="Authority Info Access";function ou(n,e,t){if(t.length===1)n[e]=t[0].toTextObject();else{const r=new Oe("");t.forEach((i,s)=>{const o=i.toTextObject(),a=`${o[Oe.NAME]} ${s+1}`;let c=r[a];Array.isArray(c)||(c=[],r[a]=c),c.push(o)}),n[e]=r}}function au(n,e,t,r){const i=e[r];i&&(Array.isArray(i)?i:[i]).forEach(o=>{typeof o=="string"&&(o=new Ui("url",o)),n.push(new vl({accessMethod:t,accessLocation:F.parse(o.rawData,he)}))})}class Av extends xr{constructor(...e){H.isBufferSource(e[0])?super(e[0]):super(Fb,e[1],new js(e[0]||[]).rawData)}onInit(e){super.onInit(e);const t=F.parse(e.extnValue,Lt);this.names=new js(t)}toTextObject(){const e=this.toTextObjectWithoutValue(),t=this.names.toTextObject();for(const r in t)e[r]=t[r];return e}}Av.NAME="Issuer Alternative Name";class Pa extends ss{constructor(...e){let t;if(H.isBufferSource(e[0]))t=H.toArrayBuffer(e[0]);else{const r=e[0],i=Array.isArray(e[1])?e[1].map(s=>H.toArrayBuffer(s)):[];t=F.serialize(new pi({type:r,values:i}))}super(t,pi)}onInit(e){this.type=e.type,this.values=e.values}toTextObject(){const e=this.toTextObjectWithoutValue();return e.Value=this.values.map(t=>new Oe("",{"":t})),e}toTextObjectWithoutValue(){const e=this.toTextObjectEmpty();return e[Oe.NAME]===Pa.NAME&&(e[Oe.NAME]=is.toString(this.type)),e}}Pa.NAME="Attribute";class kv extends Pa{constructor(...e){var t;if(H.isBufferSource(e[0]))super(e[0]);else{const r=new eh({printableString:e[0]});super(hv,[F.serialize(r)])}(t=this.password)!==null&&t!==void 0||(this.password="")}onInit(e){if(super.onInit(e),this.values[0]){const t=F.parse(this.values[0],eh);this.password=t.toString()}}toTextObject(){const e=this.toTextObjectWithoutValue();return e[Oe.VALUE]=this.password,e}}kv.NAME="Challenge Password";class u3 extends Pa{constructor(...e){var t;if(H.isBufferSource(e[0]))super(e[0]);else{const r=e[0],i=new Zi;for(const s of r)i.push(F.parse(s.rawData,Fr));super(c3,[F.serialize(i)])}(t=this.items)!==null&&t!==void 0||(this.items=[])}onInit(e){if(super.onInit(e),this.values[0]){const t=F.parse(this.values[0],Zi);this.items=t.map(r=>Ar.create(F.serialize(r)))}}toTextObject(){const e=this.toTextObjectWithoutValue(),t=this.items.map(r=>r.toTextObject());for(const r of t)e[r[Oe.NAME]]=r;return e}}u3.NAME="Extensions";class O1{static register(e,t){this.items.set(e,t)}static create(e){const t=new Pa(e),r=this.items.get(t.type);return r?new r(e):t}}O1.items=new Map;const Dl="crypto.signatureFormatter";class JB{toAsnSignature(e,t){return H.toArrayBuffer(t)}toWebSignature(e,t){return H.toArrayBuffer(t)}}var Du;let J2=Du=class{static createPssParams(e,t){const r=Du.getHashAlgorithm(e);return r?new qs({hashAlgorithm:r,maskGenAlgorithm:new j({algorithm:E1,parameters:F.serialize(r)}),saltLength:t}):null}static getHashAlgorithm(e){const t=Rt.resolve(Ws);return typeof e=="string"?t.toAsnAlgorithm({name:e}):typeof e=="object"&&e&&"name"in e?t.toAsnAlgorithm(e):null}toAsnAlgorithm(e){switch(e.name.toLowerCase()){case"rsassa-pkcs1-v1_5":if("hash"in e){let t;if(typeof e.hash=="string")t=e.hash;else if(e.hash&&typeof e.hash=="object"&&"name"in e.hash&&typeof e.hash.name=="string")t=e.hash.name.toUpperCase();else throw new Error("Cannot get hash algorithm name");switch(t.toLowerCase()){case"sha-1":return new j({algorithm:qd,parameters:null});case"sha-256":return new j({algorithm:P2,parameters:null});case"sha-384":return new j({algorithm:Wd,parameters:null});case"sha-512":return new j({algorithm:Gd,parameters:null})}}else return new j({algorithm:zs,parameters:null});break;case"rsa-pss":if("hash"in e){if(!("saltLength"in e&&typeof e.saltLength=="number"))throw new Error("Cannot get 'saltLength' from 'alg' argument");const t=Du.createPssParams(e.hash,e.saltLength);if(!t)throw new Error("Cannot create PSS parameters");return new j({algorithm:fc,parameters:F.serialize(t)})}else return new j({algorithm:fc,parameters:null})}return null}toWebAlgorithm(e){switch(e.algorithm){case zs:return{name:"RSASSA-PKCS1-v1_5"};case qd:return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-1"}};case P2:return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};case Wd:return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-384"}};case Gd:return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-512"}};case fc:if(e.parameters){const t=F.parse(e.parameters,qs);return{name:"RSA-PSS",hash:Rt.resolve(Ws).toWebAlgorithm(t.hashAlgorithm),saltLength:t.saltLength}}else return{name:"RSA-PSS"}}return null}};J2=Du=g([_1()],J2);Rt.registerSingleton(Ol,J2);let ep=class{toAsnAlgorithm(e){switch(e.name.toLowerCase()){case"sha-1":return new j({algorithm:jd});case"sha-256":return new j({algorithm:Qd});case"sha-384":return new j({algorithm:Yd});case"sha-512":return new j({algorithm:Xd})}return null}toWebAlgorithm(e){switch(e.algorithm){case jd:return{name:"SHA-1"};case Qd:return{name:"SHA-256"};case Yd:return{name:"SHA-384"};case Xd:return{name:"SHA-512"}}return null}};ep=g([_1()],ep);Rt.registerSingleton(Ol,ep);class Br{addPadding(e,t){const r=H.toUint8Array(t),i=new Uint8Array(e);return i.set(r,e-r.length),i}removePadding(e,t=!1){let r=H.toUint8Array(e);for(let i=0;i<r.length;i++)if(r[i]){r=r.slice(i);break}if(t&&r[0]>127){const i=new Uint8Array(r.length+1);return i.set(r,1),i.buffer}return r.buffer}toAsnSignature(e,t){if(e.name==="ECDSA"){const r=e.namedCurve,i=Br.namedCurveSize.get(r)||Br.defaultNamedCurveSize,s=new Kd,o=H.toUint8Array(t);return s.r=this.removePadding(o.slice(0,i),!0),s.s=this.removePadding(o.slice(i,i+i),!0),F.serialize(s)}return null}toWebSignature(e,t){if(e.name==="ECDSA"){const r=F.parse(t,Kd),i=e.namedCurve,s=Br.namedCurveSize.get(i)||Br.defaultNamedCurveSize,o=this.addPadding(s,this.removePadding(r.r)),a=this.addPadding(s,this.removePadding(r.s));return SR(o,a)}return null}}Br.namedCurveSize=new Map;Br.defaultNamedCurveSize=32;const Cf="1.3.101.110",c5="1.3.101.111",Tf="1.3.101.112",l5="1.3.101.113";let tp=class{toAsnAlgorithm(e){let t=null;switch(e.name.toLowerCase()){case"ed25519":t=Tf;break;case"x25519":t=Cf;break;case"eddsa":switch(e.namedCurve.toLowerCase()){case"ed25519":t=Tf;break;case"ed448":t=l5;break}break;case"ecdh-es":switch(e.namedCurve.toLowerCase()){case"x25519":t=Cf;break;case"x448":t=c5;break}}return t?new j({algorithm:t}):null}toWebAlgorithm(e){switch(e.algorithm){case Tf:return{name:"Ed25519"};case l5:return{name:"EdDSA",namedCurve:"Ed448"};case Cf:return{name:"X25519"};case c5:return{name:"ECDH-ES",namedCurve:"X448"}}return null}};tp=g([_1()],tp);Rt.registerSingleton(Ol,tp);class eM extends yi{constructor(e){yi.isAsnEncoded(e)?super(e,Kc):super(e),this.tag=gr.CertificateRequestTag}onInit(e){this.tbs=F.serialize(e.certificationRequestInfo),this.publicKey=new tn(e.certificationRequestInfo.subjectPKInfo);const t=Rt.resolve(Ws);this.signatureAlgorithm=t.toWebAlgorithm(e.signatureAlgorithm),this.signature=e.signature,this.attributes=e.certificationRequestInfo.attributes.map(i=>O1.create(F.serialize(i)));const r=this.getAttribute(c3);this.extensions=[],r instanceof u3&&(this.extensions=r.items),this.subjectName=new Lr(e.certificationRequestInfo.subject),this.subject=this.subjectName.toString()}getAttribute(e){for(const t of this.attributes)if(t.type===e)return t;return null}getAttributes(e){return this.attributes.filter(t=>t.type===e)}getExtension(e){for(const t of this.extensions)if(t.type===e)return t;return null}getExtensions(e){return this.extensions.filter(t=>t.type===e)}async verify(e=Et.get()){const t={...this.publicKey.algorithm,...this.signatureAlgorithm},r=await this.publicKey.export(t,["verify"],e),i=Rt.resolveAll(Dl).reverse();let s=null;for(const a of i)if(s=a.toWebSignature(t,this.signature),s)break;if(!s)throw Error("Cannot convert WebCrypto signature value to ASN.1 format");return await e.subtle.verify(this.signatureAlgorithm,r,s,this.tbs)}toTextObject(){const e=this.toTextObjectEmpty(),t=F.parse(this.rawData,Kc),r=t.certificationRequestInfo,i=new Oe("",{Version:`${$s[r.version]} (${r.version})`,Subject:this.subject,"Subject Public Key Info":this.publicKey});if(this.attributes.length){const s=new Oe("");for(const o of this.attributes){const a=o.toTextObject();s[a[Oe.NAME]]=a}i.Attributes=s}return e.Data=i,e.Signature=new Oe("",{Algorithm:Gs.serializeAlgorithm(t.signatureAlgorithm),"":t.signature}),e}}eM.NAME="PKCS#10 Certificate Request";class d3 extends yi{constructor(e){yi.isAsnEncoded(e)?super(e,Hs):super(e),this.tag=gr.CertificateTag}onInit(e){const t=e.tbsCertificate;this.tbs=F.serialize(t);let r=new Uint8Array(t.serialNumber);r.length>1&&r[0]===0&&r[1]>127&&(r=r.slice(1)),this.serialNumber=ee.ToHex(r),this.subjectName=new Lr(t.subject),this.subject=new Lr(t.subject).toString(),this.issuerName=new Lr(t.issuer),this.issuer=this.issuerName.toString();const i=Rt.resolve(Ws);this.signatureAlgorithm=i.toWebAlgorithm(e.signatureAlgorithm),this.signature=e.signatureValue;const s=t.validity.notBefore.utcTime||t.validity.notBefore.generalTime;if(!s)throw new Error("Cannot get 'notBefore' value");this.notBefore=s;const o=t.validity.notAfter.utcTime||t.validity.notAfter.generalTime;if(!o)throw new Error("Cannot get 'notAfter' value");this.notAfter=o,this.extensions=[],t.extensions&&(this.extensions=t.extensions.map(a=>Ar.create(F.serialize(a)))),this.publicKey=new tn(t.subjectPublicKeyInfo)}getExtension(e){for(const t of this.extensions)if(typeof e=="string"){if(t.type===e)return t}else if(t instanceof e)return t;return null}getExtensions(e){return this.extensions.filter(t=>typeof e=="string"?t.type===e:t instanceof e)}async verify(e={},t=Et.get()){let r,i;const s=e.publicKey;try{if(!s)r={...this.publicKey.algorithm,...this.signatureAlgorithm},i=await this.publicKey.export(r,["verify"],t);else if("publicKey"in s)r={...s.publicKey.algorithm,...this.signatureAlgorithm},i=await s.publicKey.export(r,["verify"],t);else if(s instanceof tn)r={...s.algorithm,...this.signatureAlgorithm},i=await s.export(r,["verify"],t);else if(H.isBufferSource(s)){const u=new tn(s);r={...u.algorithm,...this.signatureAlgorithm},i=await u.export(r,["verify"],t)}else r={...s.algorithm,...this.signatureAlgorithm},i=s}catch{return!1}const o=Rt.resolveAll(Dl).reverse();let a=null;for(const u of o)if(a=u.toWebSignature(r,this.signature),a)break;if(!a)throw Error("Cannot convert ASN.1 signature value to WebCrypto format");const c=await t.subtle.verify(this.signatureAlgorithm,i,a,this.tbs);if(e.signatureOnly)return c;{const d=(e.date||new Date).getTime();return c&&this.notBefore.getTime()<d&&d<this.notAfter.getTime()}}async getThumbprint(...e){let t,r="SHA-1";return e[0]&&(e[0].subtle?t=e[0]:(r=e[0]||r,t=e[1])),t??(t=Et.get()),await t.subtle.digest(r,this.rawData)}async isSelfSigned(e=Et.get()){return this.subject===this.issuer&&await this.verify({signatureOnly:!0},e)}toTextObject(){const e=this.toTextObjectEmpty(),t=F.parse(this.rawData,Hs),r=t.tbsCertificate,i=new Oe("",{Version:`${$s[r.version]} (${r.version})`,"Serial Number":r.serialNumber,"Signature Algorithm":Gs.serializeAlgorithm(r.signature),Issuer:this.issuer,Validity:new Oe("",{"Not Before":r.validity.notBefore.getTime(),"Not After":r.validity.notAfter.getTime()}),Subject:this.subject,"Subject Public Key Info":this.publicKey});if(r.issuerUniqueID&&(i["Issuer Unique ID"]=r.issuerUniqueID),r.subjectUniqueID&&(i["Subject Unique ID"]=r.subjectUniqueID),this.extensions.length){const s=new Oe("");for(const o of this.extensions){const a=o.toTextObject();s[a[Oe.NAME]]=a}i.Extensions=s}return e.Data=i,e.Signature=new Oe("",{Algorithm:Gs.serializeAlgorithm(t.signatureAlgorithm),"":t.signatureValue}),e}}d3.NAME="Certificate";class tM{static async createSelfSigned(e,t=Et.get()){if(!e.keys.privateKey)throw new Error("Bad field 'keys' in 'params' argument. 'privateKey' is empty");if(!e.keys.publicKey)throw new Error("Bad field 'keys' in 'params' argument. 'publicKey' is empty");return this.create({serialNumber:e.serialNumber,subject:e.name,issuer:e.name,notBefore:e.notBefore,notAfter:e.notAfter,publicKey:e.keys.publicKey,signingKey:e.keys.privateKey,signingAlgorithm:e.signingAlgorithm,extensions:e.extensions},t)}static async create(e,t=Et.get()){var r;let i;e.publicKey instanceof tn?i=e.publicKey.rawData:"publicKey"in e.publicKey?i=e.publicKey.publicKey.rawData:H.isBufferSource(e.publicKey)?i=e.publicKey:i=await t.subtle.exportKey("spki",e.publicKey);let s=e.serialNumber?H.toUint8Array(ee.FromHex(e.serialNumber)):void 0;s=this.generateSerialNumber(s,t);const o=e.notBefore||new Date,a=e.notAfter||new Date(o.getTime()+31536e6),c=new Hs({tbsCertificate:new Er({version:$s.v3,serialNumber:s,validity:new Sl({notBefore:o,notAfter:a}),extensions:new Zi(((r=e.extensions)===null||r===void 0?void 0:r.map(b=>F.parse(b.rawData,Fr)))||[]),subjectPublicKeyInfo:F.parse(i,Zr)})});if(e.subject){const b=e.subject instanceof Lr?e.subject:new Lr(e.subject);c.tbsCertificate.subject=F.parse(b.toArrayBuffer(),st)}if(e.issuer){const b=e.issuer instanceof Lr?e.issuer:new Lr(e.issuer);c.tbsCertificate.issuer=F.parse(b.toArrayBuffer(),st)}const u={hash:"SHA-256"},d="signingKey"in e?{...u,...e.signingAlgorithm,...e.signingKey.algorithm}:{...u,...e.signingAlgorithm},h=Rt.resolve(Ws);c.tbsCertificate.signature=c.signatureAlgorithm=h.toAsnAlgorithm(d);const f=F.serialize(c.tbsCertificate),p="signingKey"in e?await t.subtle.sign(d,e.signingKey,f):e.signature,m=Rt.resolveAll(Dl).reverse();let w=null;for(const b of m)if(w=b.toAsnSignature(d,p),w)break;if(!w)throw Error("Cannot convert ASN.1 signature value to WebCrypto format");return c.signatureValue=w,new d3(F.serialize(c))}static generateSerialNumber(e,t){let r=e&&e.length&&e.some(s=>s>0)?new Uint8Array(e):void 0;r||(r=t.getRandomValues(new Uint8Array(16)));let i=0;for(;i<r.length-1&&r[i]===0;)i++;if(r=r.slice(i),r[0]>127){const s=new Uint8Array(r.length+1);s[0]=0,s.set(r,1),r=s}return r}}var u5;(function(n){n[n.unspecified=0]="unspecified",n[n.keyCompromise=1]="keyCompromise",n[n.cACompromise=2]="cACompromise",n[n.affiliationChanged=3]="affiliationChanged",n[n.superseded=4]="superseded",n[n.cessationOfOperation=5]="cessationOfOperation",n[n.certificateHold=6]="certificateHold",n[n.removeFromCRL=8]="removeFromCRL",n[n.privilegeWithdrawn=9]="privilegeWithdrawn",n[n.aACompromise=10]="aACompromise"})(u5||(u5={}));Ar.register(Lb,l3);Ar.register(Ub,wv);Ar.register($b,bv);Ar.register(Kb,P1);Ar.register(Q0,Gc);Ar.register(zb,vv);Ar.register(e2,Ev);Ar.register(j0,xv);Ar.register(Fb,Av);O1.register(hv,kv);O1.register(c3,u3);Rt.registerSingleton(Dl,JB);Rt.registerSingleton(Dl,Br);Br.namedCurveSize.set("P-256",32);Br.namedCurveSize.set("K-256",32);Br.namedCurveSize.set("P-384",48);Br.namedCurveSize.set("P-521",66);class rM extends ot{async listen(){throw new AL("WebRTCTransport.createListener")}getAddrs(){return[]}updateAnnounceAddrs(){}async close(){}}const _v=Object.values(EE).map(n=>n.decoder).reduce((n,e)=>n.or(e)),nM=/^a=fingerprint:(?:\w+-[0-9]+)\s(?<fingerprint>(:?[0-9a-fA-F]{2})+)$/m;function iM(n){var t;if(n==null)return;const e=n.match(nM);return(t=e==null?void 0:e.groups)==null?void 0:t.fingerprint}function Iv(n){const t=n.stringTuples().filter(r=>r[0]===aL).map(r=>r[1])[0];if(t===void 0||t==="")throw new O(`Couldn't find a certhash component of multiaddr: ${n.toString()}`);return t}function sM(n){return Pt(_v.decode(n))}function oM(n){const e=sM(Iv(n)),t=cM(e.code),r=e.digest.reduce((s,o)=>s+o.toString(16).padStart(2,"0"),""),i=r.match(/.{1,2}/g);if(i==null)throw new xL(r,n.toString());return`${t} ${i.join(":").toUpperCase()}`}function aM(n){const e=n.split(":").map(i=>parseInt(i,16)),t=Uint8Array.from(e),r=rl(ut.code,t);return fe(`/certhash/${r8.encode(r.bytes)}`)}function cM(n){switch(n){case 17:return"sha-1";case 18:return"sha-256";case 19:return"sha-512";default:throw new kL(n)}}function lM(n,e){const{host:t,port:r,family:i}=n.toOptions(),s=oM(n);return{type:"answer",sdp:`v=0
o=- 0 0 IN IP${i} ${t}
s=-
t=0 0
a=ice-lite
m=application ${r} UDP/DTLS/SCTP webrtc-datachannel
c=IN IP${i} ${t}
a=mid:0
a=ice-options:ice2
a=ice-ufrag:${e}
a=ice-pwd:${e}
a=fingerprint:${s}
a=setup:passive
a=sctp-port:5000
a=max-message-size:${i1}
a=candidate:1467250027 1 UDP 1467250027 ${t} ${r} typ host
a=end-of-candidates
`}}function uM(n,e){const{host:t,port:r,family:i}=n.toOptions();return{type:"offer",sdp:`v=0
o=- 0 0 IN IP${i} ${t}
s=-
c=IN IP${i} ${t}
t=0 0
a=ice-options:ice2,trickle
m=application ${r} UDP/DTLS/SCTP webrtc-datachannel
a=mid:0
a=setup:active
a=ice-ufrag:${e}
a=ice-pwd:${e}
a=fingerprint:sha-256 00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00
a=sctp-port:5000
a=max-message-size:${i1}
a=candidate:1467250027 1 UDP 1467250027 ${t} ${r} typ host
a=end-of-candidates
`}}function d5(n,e){if(n.sdp===void 0)throw new O("Can't munge a missing SDP");const t=n.sdp.includes(`\r
`)?`\r
`:`
`;return n.sdp=n.sdp.replace(/\na=ice-ufrag:[^\n]*\n/,`
a=ice-ufrag:`+e+t).replace(/\na=ice-pwd:[^\n]*\n/,`
a=ice-pwd:`+e+t),n}const Rf=R("libp2p-webrtc-noise:");function dM(n,e,t){const r=n.trim().toLowerCase().replaceAll(":",""),i=R(r,"hex"),s=rl(ut.code,i),o=_v.decode(Iv(e)),a=Rf.byteLength+s.bytes.byteLength+o.byteLength;return t==="server"?sr([Rf,o,s.bytes],a):sr([Rf,s.bytes,o],a)}const hM=Ng?"iceconnectionstatechange":"connectionstatechange";async function fM(n,e,t){var i,s,o;const r=n.createDataChannel("",{negotiated:!0,id:0});try{if(t.role==="client"){t.log.trace("client creating local offer");const m=await n.createOffer();t.log.trace("client created local offer %s",m.sdp);const w=d5(m,e);t.log.trace("client setting local offer %s",w.sdp),await n.setLocalDescription(w);const b=lM(t.remoteAddr,e);t.log.trace("client setting server description %s",b.sdp),await n.setRemoteDescription(b)}else{const m=uM(t.remoteAddr,e);t.log.trace("server setting client %s %s",m.type,m.sdp),await n.setRemoteDescription(m),t.log.trace("server creating local answer");const w=await n.createAnswer();t.log.trace("server created local answer");const b=d5(w,e);t.log.trace("server setting local description %s",w.sdp),await n.setLocalDescription(b)}if(r.readyState!=="open"&&(t.log.trace("%s wait for handshake channel to open, starting status %s",t.role,r.readyState),await Vt(r,"open",t.signal)),t.log.trace("%s handshake channel opened",t.role),t.role==="server"){const m=((i=n.remoteFingerprint())==null?void 0:i.value)??"";t.remoteAddr=t.remoteAddr.encapsulate(aM(m))}const a=iM((s=n.localDescription)==null?void 0:s.sdp);if(a==null)throw new bl("Could not get fingerprint from local description sdp");t.log.trace("%s performing noise handshake",t.role);const c=dM(a,t.remoteAddr,t.role),u=Xw({prologueBytes:c})(t),d=kd({channel:r,direction:"outbound",handshake:!0,log:t.log,...t.dataChannel??{}}),h=new V0(t,{peerConnection:n,remoteAddr:t.remoteAddr,timeline:{open:Date.now()},metrics:t.events});n.addEventListener(hM,()=>{switch(n.connectionState){case"failed":case"disconnected":case"closed":h.close().catch(m=>{t.log.error("error closing connection",m),h.abort(m)});break;default:break}}),(o=t.events)==null||o.increment({peer_connection:!0});const f=new Lg(t,{peerConnection:n,metrics:t.events,dataChannelOptions:t.dataChannel});if(t.role==="client")return t.log.trace("%s secure inbound",t.role),await u.secureInbound(d,{remotePeer:t.remotePeerId,signal:t.signal,skipStreamMuxerNegotiation:!0}),t.log.trace("%s upgrade outbound",t.role),await t.upgrader.upgradeOutbound(h,{skipProtection:!0,skipEncryption:!0,muxerFactory:f,signal:t.signal});t.log.trace("%s secure outbound",t.role);const p=await u.secureOutbound(d,{remotePeer:t.remotePeerId,signal:t.signal,skipStreamMuxerNegotiation:!0});h.remoteAddr=h.remoteAddr.encapsulate(`/p2p/${p.remotePeer}`),t.log.trace("%s upgrade inbound",t.role),await t.upgrader.upgradeInbound(h,{skipProtection:!0,skipEncryption:!0,muxerFactory:f,signal:t.signal})}catch(a){throw r.close(),a}}async function pM(n,e,t,r){r==null&&(r=await RTCPeerConnection.generateCertificate({name:"ECDSA",namedCurve:"P-256"}));const i=typeof t=="function"?await t():t;return new RTCPeerConnection({...i??{},certificates:[r]})}async function gM(n){const e=await H8(n),t=await crypto.subtle.exportKey("pkcs8",e.privateKey);return["-----BEGIN PRIVATE KEY-----",...U(new Uint8Array(t),"base64pad").split(/(.{64})/).filter(Boolean),"-----END PRIVATE KEY-----"].join(`
`)}var V6,z6,K6;K6=wh,z6=Symbol.toStringTag,V6=kt;class mM{constructor(e,t={}){l(this,"log");l(this,"metrics");l(this,"components");l(this,"init");l(this,"certificate");l(this,"privateKey");l(this,"emitter");l(this,"renewCertificateTask");l(this,K6,!0);l(this,z6,"@libp2p/webrtc-direct");l(this,V6,["@libp2p/transport"]);if(this.log=e.logger.forComponent("libp2p:webrtc-direct"),this.components=e,this.init=t,this.emitter=new ot,t.certificateLifespan!=null&&t.certificateRenewalThreshold!=null&&t.certificateRenewalThreshold>=t.certificateLifespan)throw new O("Certificate renewal threshold must be less than certificate lifespan");e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webrtc-direct_dialer_events_total",{label:"event",help:"Total count of WebRTC-direct dial events by type"})})}async start(){this.certificate=await this.getCertificate()}async stop(){this.renewCertificateTask!=null&&clearTimeout(this.renewCertificateTask),this.certificate=void 0}async dial(e,t){var a;this.log("dial %a",e),t.signal.throwIfAborted();let r;const i=e.getPeerId();i!=null&&(r=Ur(i));const s=bL(),o=await pM("client",s,typeof this.init.rtcConfiguration=="function"?await this.init.rtcConfiguration():this.init.rtcConfiguration??{});try{return await fM(o,s,{role:"client",log:this.log,logger:this.components.logger,metrics:this.components.metrics,events:(a=this.metrics)==null?void 0:a.dialerEvents,signal:t.signal,remoteAddr:e,dataChannel:this.init.dataChannel,upgrader:t.upgrader,peerId:this.components.peerId,remotePeerId:r,privateKey:this.components.privateKey})}catch(c){throw o.close(),c}}createListener(e){if(this.certificate==null)throw new Rs;return new rM(this.components,{...this.init,...e,certificate:this.certificate,emitter:this.emitter})}listenFilter(e){return e.filter(u0.exactMatch)}dialFilter(e){return this.listenFilter(e)}async getCertificate(e){if(yM(this.init.certificate))return this.log("using provided TLS certificate"),this.init.certificate;const t=await this.loadOrCreatePrivateKey(),{pem:r,certhash:i}=await this.loadOrCreateCertificate(t,e);return{privateKey:await gM(t),pem:r,certhash:i}}async loadOrCreatePrivateKey(){if(this.privateKey!=null)return this.privateKey;const e=this.init.certificateKeychainName??mL,t=this.getKeychain();try{if(t==null)throw this.log("no keychain configured - not checking for stored private key"),new tr;this.log.trace("checking for stored private key"),this.privateKey=await t.exportKey(e)}catch(r){if(r.name!=="NotFoundError")throw r;this.log.trace("generating private key"),this.privateKey=await Xp("ECDSA","P-256"),t!=null?(this.log.trace("storing private key"),await t.importKey(e,this.privateKey)):this.log("no keychain configured - not storing private key")}return this.privateKey}async loadOrCreateCertificate(e,t){if(this.certificate!=null&&t!==!0)return this.certificate;let r;const i=new Ue(this.init.certificateDatastoreKey??gL),s=await H8(e);try{if(t===!0)throw this.log.trace("forcing renewal of TLS certificate"),new tr;this.log.trace("checking for stored TLS certificate"),r=await this.loadCertificate(i,s)}catch(a){if(a.name!=="NotFoundError")throw a;this.log.trace("generating new TLS certificate"),r=await this.createCertificate(i,s)}let o=r.notAfter.getTime()-(this.init.certificateRenewalThreshold??U4)-Date.now();return o<0&&(o=100),this.log("will renew TLS certificate after %d ms",o),this.renewCertificateTask=setTimeout(()=>{this.log("renewing TLS certificate"),this.getCertificate(!0).then(a=>{this.certificate=a,this.emitter.safeDispatchEvent("certificate:renew",{detail:a})}).catch(a=>{this.log.error("could not renew certificate - %e",a)})},o),{pem:r.toString("pem"),certhash:r8.encode((await ut.digest(new Uint8Array(r.rawData))).bytes)}}async loadCertificate(e,t){const r=await this.components.datastore.get(e),i=new d3(r),s=i.notAfter.getTime()-(this.init.certificateRenewalThreshold??U4);if(Date.now()>s)throw this.log("stored TLS certificate has expired"),new tr;this.log("loaded certificate, expires in %d ms",s);const o=await i.publicKey.export(crypto),a=await crypto.subtle.exportKey("raw",o),c=await crypto.subtle.exportKey("raw",t.publicKey);if(!ke(new Uint8Array(a,0,a.byteLength),new Uint8Array(c,0,c.byteLength)))throw this.log("stored TLS certificate public key did not match public key from private key"),new tr;return this.log("loaded certificate, expiry time is %o",s),i}async createCertificate(e,t){const r=new Date,i=new Date(Date.now()+(this.init.certificateLifespan??yL));r.setMilliseconds(0),i.setMilliseconds(0);const s=await tM.createSelfSigned({serialNumber:(BigInt(Math.random().toString().replace(".",""))*100000n).toString(16),name:"CN=example.com, C=US, L=CA, O=example, ST=CA",notBefore:r,notAfter:i,keys:t,extensions:[new l3(!1,void 0,!0)]},crypto);return this.getKeychain()!=null?(this.log.trace("storing TLS certificate"),await this.components.datastore.put(e,R(s.toString("pem")))):this.log("no keychain is configured so not storing TLS certificate since the private key will not be reused"),s}getKeychain(){try{return this.components.keychain}catch{}}}function yM(n){return n==null?!1:typeof n.privateKey=="string"&&typeof n.pem=="string"&&typeof n.certhash=="string"}function Cv(n){return e=>new mM(e,n)}function wM(n){return e=>new TL(e,n)}const bM=async n=>{if(n.readyState>=2)throw new Error("socket closed");n.readyState!==1&&await new Promise((e,t)=>{function r(){n.removeEventListener("open",i),n.removeEventListener("error",s)}function i(){r(),e()}function s(o){r(),t(o.error??new Error(`connect ECONNREFUSED ${n.url}`))}n.addEventListener("open",i),n.addEventListener("error",s)})},vM=(n,e)=>(e=e??{},e.closeOnEnd=e.closeOnEnd!==!1,async r=>{for await(const i of r){try{await bM(n)}catch(s){if(s.message==="socket closed")break;throw s}if(n.readyState===n.CLOSING||n.readyState===n.CLOSED)break;n.send(i)}e.closeOnEnd!=null&&n.readyState<=1&&await new Promise((i,s)=>{n.addEventListener("close",o=>{if(o.wasClean||o.code===1006)i();else{const a=Object.assign(new Error("ws error"),{event:o});s(a)}}),setTimeout(()=>{n.close()})})});var D1={},N1={};Object.defineProperty(N1,"__esModule",{value:!0});class SM{constructor(){this.pullQueue=[],this.pushQueue=[],this.eventHandlers={},this.isPaused=!1,this.isStopped=!1}push(e){if(this.isStopped)return;const t={value:e,done:!1};if(this.pullQueue.length){const r=this.pullQueue.shift();r&&r.resolve(t)}else this.pushQueue.push(Promise.resolve(t)),this.highWaterMark!==void 0&&this.pushQueue.length>=this.highWaterMark&&!this.isPaused&&(this.isPaused=!0,this.eventHandlers.highWater?this.eventHandlers.highWater():console&&console.warn(`EventIterator queue reached ${this.pushQueue.length} items`))}stop(){if(!this.isStopped){this.isStopped=!0,this.remove();for(const e of this.pullQueue)e.resolve({value:void 0,done:!0});this.pullQueue.length=0}}fail(e){if(!this.isStopped)if(this.isStopped=!0,this.remove(),this.pullQueue.length){for(const t of this.pullQueue)t.reject(e);this.pullQueue.length=0}else{const t=Promise.reject(e);t.catch(()=>{}),this.pushQueue.push(t)}}remove(){Promise.resolve().then(()=>{this.removeCallback&&this.removeCallback()})}[Symbol.asyncIterator](){return{next:e=>{const t=this.pushQueue.shift();return t?(this.lowWaterMark!==void 0&&this.pushQueue.length<=this.lowWaterMark&&this.isPaused&&(this.isPaused=!1,this.eventHandlers.lowWater&&this.eventHandlers.lowWater()),t):this.isStopped?Promise.resolve({value:void 0,done:!0}):new Promise((r,i)=>{this.pullQueue.push({resolve:r,reject:i})})},return:()=>(this.isStopped=!0,this.pushQueue.length=0,this.remove(),Promise.resolve({value:void 0,done:!0}))}}}let Tv=class{constructor(e,{highWaterMark:t=100,lowWaterMark:r=1}={}){const i=new SM;i.highWaterMark=t,i.lowWaterMark=r,i.removeCallback=e({push:s=>i.push(s),stop:()=>i.stop(),fail:s=>i.fail(s),on:(s,o)=>{i.eventHandlers[s]=o}})||(()=>{}),this[Symbol.asyncIterator]=()=>i[Symbol.asyncIterator](),Object.freeze(this)}};N1.EventIterator=Tv;N1.default=Tv;Object.defineProperty(D1,"__esModule",{value:!0});const h3=N1;var EM=D1.EventIterator=h3.EventIterator;function xM(n,e,t){return new h3.EventIterator(({push:r})=>(this.addEventListener(n,r,e),()=>this.removeEventListener(n,r,e)),t)}D1.subscribe=xM;D1.default=h3.EventIterator;function h5(n){var e;return n instanceof ArrayBuffer||((e=n==null?void 0:n.constructor)==null?void 0:e.name)==="ArrayBuffer"&&typeof(n==null?void 0:n.byteLength)=="number"}const AM=n=>{n.binaryType="arraybuffer";const e=async()=>{await new Promise((s,o)=>{if(r){s();return}if(i!=null){o(i);return}const a=d=>{n.removeEventListener("open",c),n.removeEventListener("error",u),d()},c=()=>{a(s)},u=d=>{a(()=>{o(d.error??new Error(`connect ECONNREFUSED ${n.url}`))})};n.addEventListener("open",c),n.addEventListener("error",u)})},t=async function*(){const s=new EM(({push:o,stop:a,fail:c})=>{const u=h=>{let f=null;typeof h.data=="string"&&(f=R(h.data)),h5(h.data)&&(f=new Uint8Array(h.data)),h.data instanceof Uint8Array&&(f=h.data),f!=null&&o(f)},d=h=>{c(h.error??new Error("Socket error"))};return n.addEventListener("message",u),n.addEventListener("error",d),n.addEventListener("close",a),()=>{n.removeEventListener("message",u),n.removeEventListener("error",d),n.removeEventListener("close",a)}},{highWaterMark:1/0});await e();for await(const o of s)yield h5(o)?new Uint8Array(o):o}();let r=n.readyState===1,i;return n.addEventListener("open",()=>{r=!0,i=null}),n.addEventListener("close",()=>{r=!1,i=null}),n.addEventListener("error",s=>{r||(i=s.error??new Error(`connect ECONNREFUSED ${n.url}`))}),Object.assign(t,{connected:e})},kM=(n,e)=>{e=e??{};const t=AM(n);let r=e.remoteAddress,i=e.remotePort;if(n.url!=null)try{const o=new URL(n.url);r=o.hostname,i=parseInt(o.port,10)}catch{}if(r==null||i==null)throw new Error("Remote connection did not have address and/or port");return{sink:vM(n,e),source:t,connected:async()=>{await t.connected()},close:async()=>{(n.readyState===n.CONNECTING||n.readyState===n.OPEN)&&await new Promise(o=>{n.addEventListener("close",()=>{o()}),n.close()})},destroy:()=>{n.terminate!=null?n.terminate():n.close()},remoteAddress:r,remotePort:i,socket:n}},_M=WebSocket,IM={"http:":"ws:","https:":"wss:"},f5="ws:",CM=(n,e)=>{if(n.startsWith("//")&&(n=`${(e==null?void 0:e.protocol)??f5}${n}`),n.startsWith("/")&&e!=null){const r=e.protocol??f5,i=e.host,s=e.port!=null&&(i==null?void 0:i.endsWith(`:${e.port}`))!==!0?`:${e.port}`:"";n=`${r}//${i}${s}${n}`}const t=new URL(n);for(const[r,i]of Object.entries(IM))t.protocol===r&&(t.protocol=i);return t};function TM(n,e){const t=typeof window>"u"?void 0:window.location;e=e??{};const r=CM(n,t),i=new _M(r.toString(),e.websocket);return kM(i,e)}function RM(n){return n.filter(e=>ed.exactMatch(e)||Dc.exactMatch(e))}function PM(){throw new Error("WebSocket Servers can not be created in the browser!")}const OM=500;function DM(n,e,t){const r=t.metrics,i=t.metricPrefix??"",s={log:t.logger.forComponent("libp2p:websockets:connection"),async sink(c){try{await n.sink(async function*(){for await(const u of c)u instanceof Uint8Array?yield u:yield u.subarray()}())}catch(u){u.type!=="aborted"&&s.log.error(u)}},source:n.source,remoteAddr:e,timeline:{open:Date.now()},async close(c={}){var h,f;const u=Date.now();if(c.signal==null){const p=AbortSignal.timeout(OM);c={...c,signal:p}}const d=()=>{const{host:p,port:m}=s.remoteAddr.toOptions();s.log("timeout closing stream to %s:%s after %dms, destroying it manually",p,m,Date.now()-u),this.abort(new ci("Socket close timeout"))};(h=c.signal)==null||h.addEventListener("abort",d);try{await n.close()}catch(p){s.log.error("error closing WebSocket gracefully - %e",p),this.abort(p)}finally{(f=c.signal)==null||f.removeEventListener("abort",d),s.timeline.close=Date.now()}},abort(c){s.log.error("destroying WebSocket after error - %e",c),n.destroy(),s.timeline.close=Date.now(),r==null||r.increment({[`${i}error`]:!0})}};let o=!1;const a=n.socket.close.bind(n.socket);return n.socket.close=(...c)=>(o=!0,a(...c)),n.socket.addEventListener("close",c=>{if(s.log('closed %s, code %d, reason "%s", wasClean %s',o?"locally":"by remote",c.code,c.reason,c.wasClean),!c.wasClean){s.abort(new bh(`${o?"Local":"Remote"} did not close WebSocket cleanly`));return}r==null||r.increment({[`${i}close`]:!0}),s.timeline.close=Date.now()},{once:!0}),s}var q6,W6,G6;G6=wh,W6=Symbol.toStringTag,q6=kt;class NM{constructor(e,t={}){l(this,"log");l(this,"init");l(this,"logger");l(this,"metrics");l(this,"components");l(this,G6,!0);l(this,W6,"@libp2p/websockets");l(this,q6,["@libp2p/transport"]);this.log=e.logger.forComponent("libp2p:websockets"),this.logger=e.logger,this.components=e,this.init=t,e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_websockets_dialer_events_total",{label:"event",help:"Total count of WebSockets dialer events by type"})})}async dial(e,t){var o;this.log("dialing %s",e),t=t??{};const r=await this._connect(e,t),i=DM(r,e,{logger:this.logger,metrics:(o=this.metrics)==null?void 0:o.dialerEvents});this.log("new outbound connection %s",i.remoteAddr);const s=await t.upgrader.upgradeOutbound(i,t);return this.log("outbound connection %s upgraded",i.remoteAddr),s}async _connect(e,t){var o,a,c,u,d;(o=t==null?void 0:t.signal)==null||o.throwIfAborted();const r=e.toOptions();this.log("dialing %s:%s",r.host,r.port);const i=ve(),s=TM(Pp(e),this.init);s.socket.addEventListener("error",()=>{var f;const h=new bh(`Could not connect to ${e.toString()}`);this.log.error("connection error:",h),(f=this.metrics)==null||f.dialerEvents.increment({error:!0}),i.reject(h)});try{(a=t.onProgress)==null||a.call(t,new N("websockets:open-connection")),await yt(Promise.race([s.connected(),i.promise]),t.signal)}catch(h){throw(c=t.signal)!=null&&c.aborted&&((u=this.metrics)==null||u.dialerEvents.increment({abort:!0})),s.close().catch(f=>{this.log.error("error closing raw socket",f)}),h}return this.log("connected %s",e),(d=this.metrics)==null||d.dialerEvents.increment({connect:!0}),s}createListener(e){return PM({logger:this.logger,events:this.components.events,metrics:this.components.metrics},{...this.init,...e})}listenFilter(e){var t,r;return e=Array.isArray(e)?e:[e],((t=this.init)==null?void 0:t.filter)!=null?(r=this.init)==null?void 0:r.filter(e):RM(e)}dialFilter(e){return this.listenFilter(e)}}function Rv(n={}){return e=>new NM(e,n)}function Pv(n,e){const t=e.map((r,i)=>({record:Hi(r),index:i}));return t.sort((r,i)=>{const s=r.record.sequence,o=i.record.sequence;if(s>o)return-1;if(s<o)return 1;if(r.record.validityType===br.ValidityType.EOL&&i.record.validityType===br.ValidityType.EOL){const a=rd.fromString(r.record.validity).toDate(),c=rd.fromString(i.record.validity).toDate();if(a.getTime()>c.getTime())return-1;if(a.getTime()<c.getTime())return 1}return 0}),t[0].index}const LM="5.5.1",BM="helia",MM={list:["/dnsaddr/bootstrap.libp2p.io/p2p/QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZg5gBMjTezGAJN","/dnsaddr/bootstrap.libp2p.io/p2p/QmbLHAnMoJPWSCR5Zhtx6BHJX9KiKNN6tpvbUcqanj75Nb","/dnsaddr/bootstrap.libp2p.io/p2p/QmcZf59bWwK5XFi76CZX8cbJ4BhTzzA3gU1ZjYZcYW3dwt","/dnsaddr/va1.bootstrap.libp2p.io/p2p/12D3KooWKnDdG3iXw9eTFijk3EWSunZcFi54Zka4wmtqtt6rPxc8","/ip4/104.131.131.82/tcp/4001/p2p/QmaCpDMGvV2BGHeYERUEnRQAwe3N8SzbUtfsmvsqQLuvuJ"]};function Ov(n={}){const e=`${BM}/${LM} ${U9()}`;return{privateKey:n.privateKey,dns:n.dns,nodeInfo:{userAgent:e},addresses:{listen:["/p2p-circuit","/webrtc"]},transports:[HO(),wM(),Cv(),Rv()],connectionEncrypters:[Xw()],streamMuxers:[rO(),YN()],peerDiscovery:[_O(MM)],services:{autoNAT:gO(),dcutr:zO(),delegatedRouting:()=>d9("https://delegated-ipfs.dev",iI()),dht:ON({clientMode:!0,validators:{ipns:nc},selectors:{ipns:Pv}}),identify:rD(),identifyPush:nD(),keychain:Fw(n.keychain),ping:iL()}}}async function UM(n){const e=n.libp2p??{};e.privateKey==null&&n.datastore!=null&&(e.privateKey=await YR(n.datastore,n.keychain));const t=Ov(e);return t.datastore=t.datastore??n.datastore,await $9({...t,...e,start:!1})}async function FM(n={}){const e=n.datastore??new m9,t=n.blockstore??new CI;let r;return JT(n.libp2p)?r=n.libp2p:r=await UM({...n,libp2p:{dns:n.dns,...n.libp2p,start:void 0},datastore:e}),{...n,libp2p:r,datastore:e,blockstore:t,blockBrokers:n.blockBrokers??[Z7(),D7()],routers:n.routers??[g9(r),p9()],metrics:r.metrics}}async function $M(n={}){const e=await FM(n),t=new $k(e);return e.start!==!1&&await t.start(),t}function HM(){const n=Ov();n.start=!1,n.addresses={listen:[]},n.transports=[Cv(),Rv()],n.peerDiscovery=[];const e={dcutr:n.services.dcutr,identify:n.services.identify,keychain:n.services.keychain,ping:n.services.ping};return{...n,start:!1,services:e}}class Dv extends Error{constructor(e="DNSLink not found"){super(e),this.name="DNSLinkNotFoundError"}}l(Dv,"name","DNSLinkNotFoundError");class Nv extends Error{constructor(e="Records failed validation"){super(e),this.name="RecordsFailedValidationError"}}l(Nv,"name","RecordsFailedValidationError");class Lv extends Error{constructor(e="Unsupported multibase prefix"){super(e),this.name="UnsupportedMultibasePrefixError"}}l(Lv,"name","UnsupportedMultibasePrefixError");class Bv extends Error{constructor(e="Unsupported multihash codec"){super(e),this.name="UnsupportedMultihashCodecError"}}l(Bv,"name","UnsupportedMultihashCodecError");class Mv extends Error{constructor(e="Invalid value"){super(e),this.name="InvalidValueError"}}l(Mv,"name","InvalidValueError");const VM=32;async function p5(n,e,t,r,i={}){if(e===0)throw new Error("recursion limit exceeded");r("query %s for TXT and CNAME records",n);const s=await t.query(n,{...i,types:[_n.TXT]}),o=((s==null?void 0:s.Answer)??[]).sort((u,d)=>u.data.localeCompare(d.data));r("found %d TXT records for %s",o.length,n);for(const u of o)try{let d=u.data;if(d.startsWith('"')&&d.endsWith('"')&&(d=d.substring(1,d.length-1)),!d.startsWith("dnslink="))continue;r("%s TXT %s",u.name,d),d=d.replace("dnslink=","");const[,h,f,...p]=d.split("/");if(h==="ipfs")try{return{value:`/ipfs/${le.parse(f)}${p.length>0?`/${p.join("/")}`:""}`,answer:u}}catch{}else if(h==="ipns"){try{let m;return f.charAt(0)==="1"||f.charAt(0)==="Q"?m=gh(f):m=Dp(le.parse(f)),{value:`/ipns/${m}${p.length>0?`/${p.join("/")}`:""}`,answer:u}}catch{}return await Nu(f,e-1,t,r,i)}else{if(h==="dnslink")return await Nu(f,e-1,t,r,i);r('unknown protocol "%s" in DNSLink record for domain: %s',h,n);continue}}catch(d){r.error("could not parse DNS link record for domain %s, %s",n,u.data,d)}r("no DNSLink records found for %s, falling back to CNAME",n);const a=await t.query(n,{...i,types:[_n.CNAME]}),c=((a==null?void 0:a.Answer)??[]).sort((u,d)=>u.data.localeCompare(d.data));r("found %d CNAME records for %s",c.length,n);for(const u of c)try{return await Nu(u.data,e-1,t,r,i)}catch(d){r.error("domain %s cname %s had no DNSLink records",n,u.data,d)}throw new Dv(`No DNSLink records found for domain: ${n}`)}async function Nu(n,e,t,r,i={}){if(e===0)throw new Error("recursion limit exceeded");n.startsWith("_dnslink.")||(n=`_dnslink.${n}`);try{return await p5(n,e,t,r,i)}catch(s){if(s.code!=="ENOTFOUND"&&s.code!=="ENODATA"&&s.name!=="DNSLinkNotFoundError"&&s.name!=="NotFoundError")throw s;return n.startsWith("_dnslink.")?n=n.replace("_dnslink.",""):n=`_dnslink.${n}`,p5(n,e,t,r,i)}}async function zM(n,e,t,r={}){return Nu(n,r.maxRecursiveDepth??VM,e,t,r)}class KM{constructor(e){l(this,"routing");this.routing=e}async put(e,t,r={}){var i;try{await this.routing.put(e,t,r)}catch(s){throw(i=r.onProgress)==null||i.call(r,new N("ipns:routing:helia:error",s)),s}}async get(e,t={}){var r;try{return await this.routing.get(e,t)}catch(i){throw(r=t.onProgress)==null||r.call(t,new N("ipns:routing:helia:error",i)),i}}}function qM(n){return new KM(n)}function cu(n){return new Ue("/dht/record/"+U(n,"base32"),!1)}function WM(n){return{async put(e,t,r={}){var i,s;try{const o=cu(e);try{const c=await n.get(o),u=Nt.deserialize(c);if(ke(u.value,t))return}catch(c){if(c.name!=="NotFoundError")throw c}const a=new Nt(e,t,new Date);(i=r.onProgress)==null||i.call(r,new N("ipns:routing:datastore:put")),await n.put(o,a.serialize(),r)}catch(o){throw(s=r.onProgress)==null||s.call(r,new N("ipns:routing:datastore:error",o)),o}},async get(e,t={}){var r,i;try{const s=cu(e);(r=t.onProgress)==null||r.call(t,new N("ipns:routing:datastore:get"));const o=await n.get(s,t),a=Nt.deserialize(o);return{record:a.value,created:a.timeReceived}}catch(s){throw(i=t.onProgress)==null||i.call(t,new N("ipns:routing:datastore:error",s)),s}},async has(e,t={}){const r=cu(e);return n.has(r,t)},async delete(e,t){const r=cu(e);return n.delete(r,t)}}}const GM=0,jM=18,g5="/ipns/";function m5(n,e){return n.code===e}const On=Ut("helia:ipns"),Uv=60*1e3,Fv=60*Uv,QM=48*Fv,Pf=23*Fv,y5=BigInt(Uv)*5000000n,w5={[Cs.prefix]:Cs,[Mr.prefix]:Mr};var Ys,rp,$v;class YM{constructor(e,t=[]){pe(this,Ys);l(this,"routers");l(this,"localStore");l(this,"timeout");l(this,"dns");l(this,"log");this.routers=[qM(e.routing),...t],this.localStore=WM(e.datastore),this.dns=e.dns,this.log=e.logger.forComponent("helia:ipns")}async publish(e,t,r={}){var i;try{let s=1n;const o=rc(e.publicKey.toMultihash());if(await this.localStore.has(o,r)){const{record:d}=await this.localStore.get(o,r);s=Hi(d).sequence+1n}const a=r.ttl!=null?BigInt(r.ttl)*1000000n:y5,c=await Q_(e,t,s,r.lifetime??QM,{...r,ttlNs:a}),u=nd(c);return await this.localStore.put(o,u,r),r.offline!==!0&&await Promise.all(this.routers.map(async d=>{await d.put(o,u,r)})),c}catch(s){throw(i=r.onProgress)==null||i.call(r,new N("ipns:publish:error",s)),s}}async resolve(e,t={}){const r=Xk(e)?e.toMultihash():e,i=rc(r),s=await D(this,Ys,$v).call(this,i,t);return{...await D(this,Ys,rp).call(this,s.value,t),record:s}}async resolveDNSLink(e,t={}){const r=await zM(e,this.dns,this.log,t);return{...await D(this,Ys,rp).call(this,r.value,t),answer:r.answer}}republish(e={}){var r;if(this.timeout!=null)throw new Error("Republish is already running");(r=e.signal)==null||r.addEventListener("abort",()=>{clearTimeout(this.timeout)});async function t(){var c;const i=Date.now();(c=e.onProgress)==null||c.call(e,new N("ipns:republish:start"));const o=Date.now()-i;let a=Pf-o;a<0&&(a=e.interval??Pf),setTimeout(()=>{t().catch(u=>{On.error("error republishing",u)})},a)}this.timeout=setTimeout(()=>{t().catch(i=>{On.error("error republishing",i)})},e.interval??Pf)}async republishRecord(e,t,r={}){var s,o;let i;try{if(i=(s=o9(t))==null?void 0:s.toMultihash(),i==null)if(typeof e=="string"){e.startsWith(g5)&&(e=e.slice(g5.length));try{i=gh(e).toMultihash()}catch(u){throw new Error(`Invalid string key: ${u.message}`)}}else i=e;if(i==null)throw new Error("No public key multihash found to determine the routing key");const a=rc(i),c=nd(t);await nc(a,c),await this.localStore.put(a,c,r),r.offline!==!0&&await Promise.all(this.routers.map(async u=>{await u.put(a,c,r)}))}catch(a){throw(o=r.onProgress)==null||o.call(r,new N("ipns:republish:error",{key:i,record:t,err:a})),a}}}Ys=new WeakSet,rp=async function(e,t={}){const r=e.split("/");try{const i=r[1];if(i==="ipns"){const s=r[2],o=s.substring(0,1);let a;if(o==="1"||o==="Q")a=Mr.decode(`z${s}`);else if(w5[o]!=null)a=w5[o].decode(s);else throw new Lv(`Unsupported multibase prefix "${o}"`);let c;try{c=Pt(a)}catch{c=le.decode(a).multihash}if(!m5(c,GM)&&!m5(c,jM))throw new Bv(`Unsupported multihash codec "${c.code}"`);const{cid:u}=await this.resolve(c,t),d=r.slice(3).join("/");return{cid:u,path:d}}else if(i==="ipfs"){const s=le.parse(r[2]),o=r.slice(3).join("/");return{cid:s,path:o}}}catch(i){On.error("error parsing ipfs path",i)}throw On.error("invalid ipfs path %s",e),new Mv("Invalid value")},$v=async function(e,t={}){const r=[];if(await this.localStore.has(e,t))if(On("record is present in the cache"),t.nocache!==!0)try{const{record:a,created:c}=await this.localStore.get(e,t);this.log("record retrieved from cache"),await nc(e,a),this.log("record was valid");const u=Hi(a),d=Number((u.ttl??y5)/1000000n);if(c.getTime()+d>Date.now())return this.log("record TTL was valid"),u;if(t.offline===!0)return this.log("record TTL has been reached but we are resolving offline-only, returning record"),u;this.log("record TTL has been reached, searching routing for updates"),r.push(a)}catch(a){this.log("cached record was invalid",a),await this.localStore.delete(e,t)}else On("ignoring local cache due to nocache=true option");if(t.offline===!0)throw new Fi("Record was not present in the cache or has expired");On("did not have record locally");let s=0;if(await Promise.all(this.routers.map(async a=>{let c;try{c=await a.get(e,{...t,validate:!1})}catch(u){On.error("error finding IPNS record",u);return}try{await nc(e,c),r.push(c)}catch(u){s++,On.error("error finding IPNS record",u)}})),r.length===0)throw s>0?new Nv(`${s>1?`${s} records`:"Record"} found for routing key ${s>1?"were":"was"} invalid`):new Fi("Could not find record for routing key");const o=r[Pv(e,r)];return await this.localStore.put(e,o,t),Hi(o)};function XM(n,{routers:e=[]}={}){return new YM(n,e)}var Dr,ze,et,Pi,tl,Oi,Pe,np,qr,Vv,ip,sp,op,zv,ap;class Hv extends Map{constructor(t={}){super();pe(this,Pe);pe(this,Dr,0);pe(this,ze,new Map);pe(this,et,new Map);pe(this,Pi);pe(this,tl);pe(this,Oi);if(!(t.maxSize&&t.maxSize>0))throw new TypeError("`maxSize` must be a number greater than 0");if(typeof t.maxAge=="number"&&t.maxAge===0)throw new TypeError("`maxAge` must be a number greater than 0");Ae(this,Pi,t.maxSize),Ae(this,tl,t.maxAge||Number.POSITIVE_INFINITY),Ae(this,Oi,t.onEviction)}get __oldCache(){return A(this,et)}get(t){if(A(this,ze).has(t)){const r=A(this,ze).get(t);return D(this,Pe,ip).call(this,t,r)}if(A(this,et).has(t)){const r=A(this,et).get(t);if(D(this,Pe,qr).call(this,t,r)===!1)return D(this,Pe,zv).call(this,t,r),r.value}}set(t,r,{maxAge:i=A(this,tl)}={}){const s=typeof i=="number"&&i!==Number.POSITIVE_INFINITY?Date.now()+i:void 0;return A(this,ze).has(t)?A(this,ze).set(t,{value:r,expiry:s}):D(this,Pe,op).call(this,t,{value:r,expiry:s}),this}has(t){return A(this,ze).has(t)?!D(this,Pe,qr).call(this,t,A(this,ze).get(t)):A(this,et).has(t)?!D(this,Pe,qr).call(this,t,A(this,et).get(t)):!1}peek(t){if(A(this,ze).has(t))return D(this,Pe,sp).call(this,t,A(this,ze));if(A(this,et).has(t))return D(this,Pe,sp).call(this,t,A(this,et))}expiresIn(t){const r=A(this,ze).get(t)??A(this,et).get(t);if(r)return r.expiry?r.expiry-Date.now():Number.POSITIVE_INFINITY}delete(t){const r=A(this,ze).delete(t);return r&&Tr(this,Dr)._--,A(this,et).delete(t)||r}clear(){A(this,ze).clear(),A(this,et).clear(),Ae(this,Dr,0)}resize(t){if(!(t&&t>0))throw new TypeError("`maxSize` must be a number greater than 0");const r=[...D(this,Pe,ap).call(this)],i=r.length-t;i<0?(Ae(this,ze,new Map(r)),Ae(this,et,new Map),Ae(this,Dr,r.length)):(i>0&&D(this,Pe,np).call(this,r.slice(0,i)),Ae(this,et,new Map(r.slice(i))),Ae(this,ze,new Map),Ae(this,Dr,0)),Ae(this,Pi,t)}*keys(){for(const[t]of this)yield t}*values(){for(const[,t]of this)yield t}*[Symbol.iterator](){for(const t of A(this,ze)){const[r,i]=t;D(this,Pe,qr).call(this,r,i)===!1&&(yield[r,i.value])}for(const t of A(this,et)){const[r,i]=t;A(this,ze).has(r)||D(this,Pe,qr).call(this,r,i)===!1&&(yield[r,i.value])}}*entriesDescending(){let t=[...A(this,ze)];for(let r=t.length-1;r>=0;--r){const i=t[r],[s,o]=i;D(this,Pe,qr).call(this,s,o)===!1&&(yield[s,o.value])}t=[...A(this,et)];for(let r=t.length-1;r>=0;--r){const i=t[r],[s,o]=i;A(this,ze).has(s)||D(this,Pe,qr).call(this,s,o)===!1&&(yield[s,o.value])}}*entriesAscending(){for(const[t,r]of D(this,Pe,ap).call(this))yield[t,r.value]}get size(){if(!A(this,Dr))return A(this,et).size;let t=0;for(const r of A(this,et).keys())A(this,ze).has(r)||t++;return Math.min(A(this,Dr)+t,A(this,Pi))}get maxSize(){return A(this,Pi)}entries(){return this.entriesAscending()}forEach(t,r=this){for(const[i,s]of this.entriesAscending())t.call(r,s,i,this)}get[Symbol.toStringTag](){return"QuickLRU"}toString(){return`QuickLRU(${this.size}/${this.maxSize})`}[Symbol.for("nodejs.util.inspect.custom")](){return this.toString()}}Dr=new WeakMap,ze=new WeakMap,et=new WeakMap,Pi=new WeakMap,tl=new WeakMap,Oi=new WeakMap,Pe=new WeakSet,np=function(t){if(typeof A(this,Oi)=="function")for(const[r,i]of t)A(this,Oi).call(this,r,i.value)},qr=function(t,r){return typeof r.expiry=="number"&&r.expiry<=Date.now()?(typeof A(this,Oi)=="function"&&A(this,Oi).call(this,t,r.value),this.delete(t)):!1},Vv=function(t,r){if(D(this,Pe,qr).call(this,t,r)===!1)return r.value},ip=function(t,r){return r.expiry?D(this,Pe,Vv).call(this,t,r):r.value},sp=function(t,r){const i=r.get(t);return D(this,Pe,ip).call(this,t,i)},op=function(t,r){A(this,ze).set(t,r),Tr(this,Dr)._++,A(this,Dr)>=A(this,Pi)&&(Ae(this,Dr,0),D(this,Pe,np).call(this,A(this,et)),Ae(this,et,A(this,ze)),Ae(this,ze,new Map))},zv=function(t,r){A(this,et).delete(t),D(this,Pe,op).call(this,t,r)},ap=function*(){for(const t of A(this,et)){const[r,i]=t;A(this,ze).has(r)||D(this,Pe,qr).call(this,r,i)===!1&&(yield t)}for(const t of A(this,ze)){const[r,i]=t;D(this,Pe,qr).call(this,r,i)===!1&&(yield t)}};function f3(n,e={}){const t=xg(n),r={_cancelled:!1,async start(){this._cancelled=!1},async pull(i){try{const{value:s,done:o}=await t.next();if(this._cancelled)return;if(o===!0){i.close();return}i.enqueue(s)}catch(s){i.error(s)}},cancel(){this._cancelled=!0}};return new globalThis.ReadableStream(r,e)}class rr extends Error{constructor(e="Invalid range request"){super(e),this.name="InvalidRangeError"}}l(rr,"name","InvalidRangeError");var jf;let ZM=(jf=class extends Error{constructor(e="No content found"){super(e),this.name="NoContentError"}},l(jf,"name","NoContentError"),jf);class Kv extends Error{constructor(e="Subdomain not supported"){super(e),this.name="SubdomainNotSupportedError"}}l(Kv,"name","SubdomainNotSupportedError");function JM(n,e){if(n==null)return;if(n instanceof Headers)return n.get(e)??void 0;if(Array.isArray(n)){const r=n.find(([i])=>i.toLowerCase()===e.toLowerCase());return r==null?void 0:r[1]}const t=Object.keys(n).find(r=>r.toLowerCase()===e.toLowerCase());if(t!=null)return n[t]}function eU(n,e,t){if((n??0)>(e??1/0))throw new rr("Invalid range: Range-start index is greater than range-end index.");if(n!=null&&(e??0)>=(t??1/0))throw new rr("Invalid range: Range-end index is greater than or equal to the size of the file.");if(n==null&&(e??0)>(t??1/0))throw new rr("Invalid range: Range-end index is greater than the size of the file.");if(n!=null&&n<0)throw new rr("Invalid range: Range-start index cannot be negative.");if(n!=null&&e!=null)return{byteSize:e-n+1,start:n,end:e};if(n==null&&e!=null)return t==null?{end:e}:e===t?{byteSize:t,start:0,end:t-1}:{byteSize:e,start:t-e,end:t-1};if(n!=null&&e==null){if(t==null)return{start:n};const r=t-1;return{byteSize:t-n,start:n,end:r}}return{byteSize:t,start:0,end:t!=null?t-1:0}}function tU({ttl:n,protocol:e,response:t}){if(t.headers.has("cache-control"))return;let r;e==="ipfs"?r="public, max-age=29030400, immutable":n==null?r="public, max-age=300":r=`public, max-age=${n}`,t.headers.set("cache-control",r)}function Of({byteStart:n,byteEnd:e,byteSize:t}){const r=t??"*";if((e??0)>=(t??1/0))throw new rr("Invalid range: Range-end index is greater than or equal to the size of the file.");if((n??0)>=(t??1/0))throw new rr("Invalid range: Range-start index is greater than or equal to the size of the file.");if(n!=null&&e==null)return t==null?`bytes */${r}`:`bytes ${n}-${t-1}/${t}`;if(n==null&&e!=null){if(t==null)return`bytes */${r}`;const i=t-1;return`bytes ${i-e+1}-${i}/${t}`}return n==null&&e==null?`bytes */${r}`:`bytes ${n}-${e}/${r}`}function qv(n,e){e!=null&&n.headers.set("X-Ipfs-Roots",rU(e))}function rU(n){return n.map(e=>e.toV1().toString()).join(",")}function nU(n){return typeof n=="string"?n.length:n instanceof ArrayBuffer||n instanceof Uint8Array?n.byteLength:n instanceof Blob?n.size:(n instanceof ReadableStream,null)}function iU(n){if(!n.startsWith("bytes="))throw new rr("Invalid range request");const t=n.substring(6).split(",").map(i=>i.trim()),r=[];for(const i of t){const s=i.match(/^(?<start>\d+)?-(?<end>\d+)?$/);if((s==null?void 0:s.groups)==null)throw new rr(`Invalid range specification: ${i}`);const{start:o,end:a}=s.groups;r.push({start:o??null,end:a??null})}if(r.length===0)throw new rr("No valid ranges found");return{ranges:r}}class sU{constructor(e,t){l(this,"headers");l(this,"isRangeRequest");l(this,"_fileSize");l(this,"_body",null);l(this,"rangeRequestHeader");l(this,"log");l(this,"multiPartBoundary");l(this,"requestRanges",[]);l(this,"byteRanges",[]);l(this,"isMultiRangeRequest",!1);l(this,"_isValidRangeRequest",!1);if(this.headers=t,this.log=e.forComponent("helia:verified-fetch:byte-range-context"),this.rangeRequestHeader=JM(this.headers,"Range"),this.rangeRequestHeader!=null){this.isRangeRequest=!0,this.log.trace("range request detected");try{const{ranges:r}=iU(this.rangeRequestHeader);this.isMultiRangeRequest=r.length>1,this.requestRanges=r.map(i=>({start:i.start!=null?parseInt(i.start):null,end:i.end!=null?parseInt(i.end):null})),this.multiPartBoundary=`multipart_byteranges_${Math.floor(Math.random()*1e9)}`}catch(r){this.log.error("error parsing range request header - %e",r),this.requestRanges=[]}this.setOffsetDetails()}else this.log.trace("no range request detected"),this.isRangeRequest=!1}getByteRanges(){return this.byteRanges}setBody(e,t="application/octet-stream"){typeof e=="function"?this._body=this.createRangeStream(e,t):(this._body=e,this.setFileSize(this._fileSize??nU(e))),this.log.trace("set request body with fileSize %o",this._fileSize)}getBody(e){const t=this._body;if(t==null)return this.log.trace("body is null"),t;if(!this.isRangeRequest||!this.isValidRangeRequest)return this.log.trace("returning body unmodified for non-range, or invalid range, request"),t;if(this.isMultiRangeRequest)return this._body instanceof ReadableStream?this._body:f3(this.getMultipartBody(e));if(this.byteRanges.length>0){const r=this.byteRanges[0];return t instanceof ReadableStream?t:((r.start!=null||r.end!=null)&&this.log.trace("returning body with byteStart=%o, byteEnd=%o, byteSize=%o",r.start,r.end,r.size),this.getSlicedBody(t,r))}return this.log.error("returning unmodified body for valid range request"),t}getSlicedBody(e,t){const r=t.start??0;let i;return t.end!=null&&t.start!=null?i=t.end-t.start+1:i=void 0,this.log.trace("slicing body with offset=%o and length=%o",r,i),typeof e=="string"||e instanceof Blob||e instanceof ArrayBuffer||e instanceof Uint8Array?e.slice(r,i!==void 0?r+i:void 0):e}setFileSize(e){this._fileSize=e!=null?Number(e):null,this._isValidRangeRequest=!1,this.log.trace("set _fileSize to %o",this._fileSize),this.setOffsetDetails()}getFileSize(){return this._fileSize}isValidByteStart(e,t){return!(e!=null&&(e<0||this._fileSize!=null&&e>=this._fileSize||t!=null&&e>t))}isValidByteEnd(e,t){if(t!=null){if(t<0)return this.log.trace("invalid range request, byteEnd is less than 0"),!1;if(this._fileSize!=null&&t>=this._fileSize)return this.log.trace("invalid range request, byteEnd is greater than fileSize"),!1;if(e!=null&&t<e)return this.log.trace("invalid range request, byteEnd is less than byteStart"),!1}return!0}isValidByteRange(e){return this.log.trace("validating byte range: %o",e),e.start!=null&&!this.isValidByteStart(e.start,e.end)?(this.log.trace("invalid range request, byteStart is less than 0 or greater than fileSize"),!1):e.end!=null&&!this.isValidByteEnd(e.start,e.end)?(this.log.trace("invalid range request, byteEnd is less than 0 or greater than fileSize"),!1):!0}get isValidRangeRequest(){return this._isValidRangeRequest?!0:this.isRangeRequest?this.byteRanges.length===0?(this.log.trace("invalid range request, no valid ranges"),!1):this.byteRanges.every(t=>this.isValidByteRange(t))?(this._isValidRangeRequest=!0,!0):(this.log.trace("invalid range request, not all ranges are valid"),!1):!1}getLength(e){if(!this.isValidRangeRequest){this.log.error("cannot get length for invalid range request");return}if(!(this.isMultiRangeRequest&&e==null))return e??(e=this.byteRanges[0]),this.log.trace("getting length for range: %o",e),e.end!=null&&e.start!=null?e.end-e.start+1:e.end!=null?e.end+1:e.size}setOffsetDetails(){if(this.requestRanges.length===0){this.log.trace("no request ranges defined");return}try{this.byteRanges=this.requestRanges.map(e=>{const{start:t,end:r,byteSize:i}=eU(e.start??void 0,e.end??void 0,this._fileSize??void 0);return{start:t,end:r,size:i}}),this.log.trace("set byte ranges: %o",this.byteRanges)}catch(e){this.log.error("error setting offset details: %o",e),this.byteRanges=[]}}async convertToUint8Array(e){if(typeof e=="string")return new TextEncoder().encode(e);if("arrayBuffer"in e&&typeof e.arrayBuffer=="function"){const t=await e.arrayBuffer();return new Uint8Array(t)}if("byteLength"in e&&!("buffer"in e))return new Uint8Array(e);if("buffer"in e&&"byteLength"in e&&"byteOffset"in e)return e;throw new Error("Unsupported content type for multipart response")}async*getMultipartBody(e="application/octet-stream"){const t=this._body;if(t instanceof ReadableStream)return t;if(t===null)throw new Error("Cannot create multipart body from null");const r=new TextEncoder;for(const i of this.byteRanges){if(i.start===void 0||i.end===void 0)continue;const s=`\r
--${this.multiPartBoundary}\r
Content-Type: ${e}\r
Content-Range: ${Of({byteStart:i.start,byteEnd:i.end,byteSize:this._fileSize??void 0})}\r
\r
`;yield r.encode(s);const o=this.getSlicedBodyForRange(t,i.start,i.end);yield await this.convertToUint8Array(o)}yield r.encode(`\r
--${this.multiPartBoundary}--`)}getSlicedBodyForRange(e,t,r){const i=t,s=r-t+1;return this.log.trace("slicing body with offset=%o and length=%o",i,s),typeof e=="string"||e instanceof Blob||e instanceof ArrayBuffer||e instanceof Uint8Array?e.slice(i,i+s):e}getContentType(){if(this.isMultiRangeRequest&&this.isValidRangeRequest)return`multipart/byteranges; boundary=${this.multiPartBoundary}`}get contentRangeHeaderValue(){if(!this.isValidRangeRequest)throw this.log.error("cannot get contentRangeHeaderValue for invalid range request"),new rr("Invalid range request");if(this.isMultiRangeRequest)throw this.log.error("contentRangeHeaderValue should not be called for multipart responses"),new rr("Content-Range header not applicable for multipart responses");if(this.byteRanges.length>0){const e=this.byteRanges[0];return Of({byteStart:e.start,byteEnd:e.end,byteSize:this._fileSize??void 0})}throw new rr("No valid ranges found")}createRangeStream(e,t){const r=new TextEncoder,i=this.byteRanges,s=this.multiPartBoundary,o=this._fileSize,a=this.log,c=this.isMultiRangeRequest;if(i.length===0)throw a.error("Cannot create range stream with no byte ranges"),new rr("No valid ranges found");return new ReadableStream({async start(u){try{for(const d of i){if(c){const h=`\r
--${s}\r
Content-Type: ${t}\r
Content-Range: ${Of({byteStart:d.start,byteEnd:d.end,byteSize:o??void 0})}\r
\r
`;u.enqueue(r.encode(h))}try{const h=e(d);for await(const f of h)u.enqueue(f)}catch(h){throw a.error("Error processing range %o: %o",d,h),h}}c&&u.enqueue(r.encode(`\r
--${s}--`)),u.close()}catch(d){a.error("Error processing range(s): %o",d),u.error(d)}}})}}function p3(n,e,t){Object.defineProperty(n,e,{enumerable:!0,configurable:!1,set:()=>{},get:()=>t})}function Ei(n,e){p3(n,"type",e)}function xi(n,e){p3(n,"url",e)}function Wv(n){p3(n,"redirected",!0)}function oU(n,e,t){const r=new Response(e,{...t??{},status:200,statusText:"OK"});return(t==null?void 0:t.redirected)===!0&&Wv(r),Ei(r,"basic"),xi(r,n),r}function g3(n,e,t){const r=new Response(e,{status:502,statusText:"Bad Gateway"});return Ei(r,"basic"),xi(r,n),r}function Gv(n,e,t){const r=new Response(e,{status:501,statusText:"Not Implemented"});return r.headers.set("X-Content-Type-Options","nosniff"),Ei(r,"basic"),xi(r,n),r}function jc(n,e,t){const r=new Response(e,{status:406,statusText:"Not Acceptable"});return Ei(r,"basic"),xi(r,n),r}function jv(n,e,t){const r=new Response(e,{status:404,statusText:"Not Found"});return Ei(r,"basic"),xi(r,n),r}function aU(n){return Array.isArray(n)&&n.every(e=>e instanceof Error)}function cp(n,e,t){let r,i;aU(e)?(r=e[e.length-1].stack,i=e.map(a=>({message:a.message,stack:a.stack??""}))):e instanceof Error&&(r=e.stack,i=[{message:e.message,stack:e.stack??""}]);const s=JSON.stringify({stack:r,errors:i}),o=new Response(s,{status:400,statusText:"Bad Request",headers:{"Content-Type":"application/json"}});return Ei(o,"basic"),xi(o,n),o}function lp(n,e,t){const r=new Response(null,{status:301,statusText:"Moved Permanently",headers:{location:e}});return Ei(r,"basic"),xi(r,n),r}function io(n,e,{byteRangeContext:t,log:r},i){if(!t.isRangeRequest)return oU(n,e,i);if(!t.isValidRangeRequest)return rh(n,e,i);let s;try{const o=new Headers(i==null?void 0:i.headers),a=t.getContentType();a!=null?o.set("content-type",a):t.isMultiRangeRequest?o.set("content-type","multipart/byteranges"):o.set("content-range",t.contentRangeHeaderValue),s=new Response(e,{...i??{},status:206,statusText:"Partial Content",headers:o})}catch(o){return r==null||r.error("failed to create range response",o),rh(n,e,i)}return(i==null?void 0:i.redirected)===!0&&Wv(s),Ei(s,"basic"),xi(s,n),s}function rh(n,e,t){const r=new Response(e,{...t??{},status:416,statusText:"Requested Range Not Satisfiable"});return Ei(r,"basic"),xi(r,n),r}class Ai{constructor(e){l(this,"codes",[]);l(this,"pluginOptions");l(this,"_log");this.pluginOptions=e}get log(){return this._log==null&&(this._log=this.pluginOptions.logger.forComponent(this.id)),this._log}}class cU extends Ai{constructor(){super(...arguments);l(this,"id","byte-range-context-plugin")}canHandle(t){return t.byteRangeContext==null}async handle(t){var r;return t.byteRangeContext=new sU(this.pluginOptions.logger,(r=t.options)==null?void 0:r.headers),t.modified++,t.byteRangeContext.isRangeRequest&&!t.byteRangeContext.isValidRangeRequest?rh(t.resource):null}}const lU=1,uU=112,dU=85;class Qv{async*export(e,t){for(const[,r]of t.links())yield r}}class hU{constructor(e){l(this,"target");this.target=e}isTarget(e){return this.target.equals(e)}async*traverse(e,t){for(const[,r]of t.links())yield r}}var si,up,Lu;class fU{constructor(e,t){pe(this,si);l(this,"components");l(this,"log");this.components=e,this.log=e.logger.forComponent("helia:car")}async import(e,t){await ui(this.components.blockstore.putMany(vr(e.blocks(),({cid:r,bytes:i})=>({cid:r,block:i})),t))}async export(e,t,r){const i=ve(),s=Array.isArray(e)?e:[e],o={currentPath:[],pathsToTarget:null},a=r==null?void 0:r.traversal,c=(r==null?void 0:r.exporter)??new Qv,u=new fl({concurrency:lU});let d=!1;u.on("idle",()=>{var h;if(d)i.resolve();else if(!d&&((h=o.pathsToTarget)==null?void 0:h.length)===s.length){this.log.trace("starting export of blocks to the car file"),d=!0;for(const f of o.pathsToTarget){const p=f.length-1,m=f[p];f.slice(0,-1).forEach(w=>{u.add(async()=>{await D(this,si,Lu).call(this,{cid:w,queue:u,writer:t,strategy:c,options:r,recursive:!1})}).catch(b=>{this.log.error("error during queue operation - %e",b)})}),u.add(async()=>{await D(this,si,Lu).call(this,{cid:m,queue:u,writer:t,strategy:c,options:r})}).catch(w=>{this.log.error("error during queue operation - %e",w)})}}else this.log.trace("no paths to target, skipping export"),i.reject(new Error("Could not traverse to target CID(s)"))}),u.on("error",h=>{u.clear(),i.reject(h)});for(const h of s)u.add(async()=>{this.log.trace("traversing dag from %c",h),await D(this,si,up).call(this,{cid:h,queue:u,strategy:a??new hU(h),traversalContext:o,parentPath:[],options:r})}).catch(f=>{this.log.error("error during queue operation - %e",f)});try{await i.promise}finally{await t.close()}}async*stream(e,t){const{writer:r,out:i}=s8.create(e);this.export(e,r,t).catch(s=>{this.log.error("error during streaming export - %e",s)});for await(const s of i)yield s}}si=new WeakSet,up=async function({cid:e,queue:t,strategy:r,traversalContext:i,parentPath:s,options:o}){const a=[...s,e];if(r.isTarget(e)){i.pathsToTarget=i.pathsToTarget??[],i.pathsToTarget.push([...a]),this.log.trace("found path to target %c",e);return}const c=await this.components.getCodec(e.code),u=await this.components.blockstore.get(e,o),d=Yf({bytes:u,cid:e,codec:c});for await(const h of r.traverse(e,d))t.add(async()=>{await D(this,si,up).call(this,{cid:h,queue:t,strategy:r,traversalContext:i,parentPath:a??[],options:o})}).catch(f=>{this.log.error("error during traversal queue operation - %e",f)})},Lu=async function({cid:e,queue:t,writer:r,strategy:i,options:s,recursive:o=!0}){var u,d;if(((u=s==null?void 0:s.blockFilter)==null?void 0:u.has(e.multihash.bytes))===!0)return;const a=await this.components.getCodec(e.code),c=await this.components.blockstore.get(e,s);if((d=s==null?void 0:s.blockFilter)==null||d.add(e.multihash.bytes),await r.put({cid:e,bytes:c}),o){const h=Yf({bytes:c,cid:e,codec:a});for await(const f of i.export(e,h))t.add(async()=>{await D(this,si,Lu).call(this,{cid:f,queue:t,writer:r,strategy:i,options:s})}).catch(p=>{this.log.error("error during export queue operation - %e",p)})}};class b5{async*export(e,t){}}var Ka;let pU=(Ka=class extends Error{constructor(){super(...arguments);l(this,"code","ERR_NOT_UNIXFS");l(this,"message","Not a UnixFS node");l(this,"name","NotUnixFSError")}},l(Ka,"code","ERR_NOT_UNIXFS"),l(Ka,"message","Not a UnixFS node"),l(Ka,"name","NotUnixFSError"),Ka);class gU{async*export(e,t){if(e.code!==uU&&e.code!==dU)throw new pU("Target CID was not UnixFS - use the SubGraphExporter to export arbitrary graphs");for(const[,r]of t.links())yield r}}class mU{constructor(e){l(this,"pathToTarget");l(this,"target");this.pathToTarget=e,this.target=e[e.length-1]}isTarget(e){return this.target.equals(e)}async*traverse(e,t){const r=this.pathToTarget.indexOf(e);yield this.pathToTarget[r+1]}}const go=class go extends Error{constructor(t="Invalid type"){super(t);l(this,"name",go.name);l(this,"code",go.code)}};l(go,"name","InvalidTypeError"),l(go,"code","ERR_INVALID_TYPE");let nh=go;const mo=class mo extends Error{constructor(t="Invalid message"){super(t);l(this,"name",mo.name);l(this,"code",mo.code)}};l(mo,"name","InvalidUnixFSMessageError"),l(mo,"code","ERR_INVALID_MESSAGE");let dp=mo;var wn;(function(n){(function(r){r.Raw="Raw",r.Directory="Directory",r.File="File",r.Metadata="Metadata",r.Symlink="Symlink",r.HAMTShard="HAMTShard"})(n.DataType||(n.DataType={}));let e;(function(r){r[r.Raw=0]="Raw",r[r.Directory=1]="Directory",r[r.File=2]="File",r[r.Metadata=3]="Metadata",r[r.Symlink=4]="Symlink",r[r.HAMTShard=5]="HAMTShard"})(e||(e={})),function(r){r.codec=()=>Wt(e)}(n.DataType||(n.DataType={}));let t;n.codec=()=>(t==null&&(t=me((r,i,s={})=>{if(s.lengthDelimited!==!1&&i.fork(),r.Type!=null&&(i.uint32(8),n.DataType.codec().encode(r.Type,i)),r.Data!=null&&(i.uint32(18),i.bytes(r.Data)),r.filesize!=null&&(i.uint32(24),i.uint64(r.filesize)),r.blocksizes!=null)for(const o of r.blocksizes)i.uint32(32),i.uint64(o);r.hashType!=null&&(i.uint32(40),i.uint64(r.hashType)),r.fanout!=null&&(i.uint32(48),i.uint64(r.fanout)),r.mode!=null&&(i.uint32(56),i.uint32(r.mode)),r.mtime!=null&&(i.uint32(66),ih.codec().encode(r.mtime,i)),s.lengthDelimited!==!1&&i.ldelim()},(r,i)=>{const s={blocksizes:[]},o=i==null?r.len:r.pos+i;for(;r.pos<o;){const a=r.uint32();switch(a>>>3){case 1:s.Type=n.DataType.codec().decode(r);break;case 2:s.Data=r.bytes();break;case 3:s.filesize=r.uint64();break;case 4:s.blocksizes.push(r.uint64());break;case 5:s.hashType=r.uint64();break;case 6:s.fanout=r.uint64();break;case 7:s.mode=r.uint32();break;case 8:s.mtime=ih.codec().decode(r,r.uint32());break;default:r.skipType(a&7);break}}return s})),t),n.encode=r=>ye(r,n.codec()),n.decode=r=>we(r,n.codec())})(wn||(wn={}));var ih;(function(n){let e;n.codec=()=>(e==null&&(e=me((t,r,i={})=>{i.lengthDelimited!==!1&&r.fork(),t.Seconds!=null&&(r.uint32(8),r.int64(t.Seconds)),t.FractionalNanoseconds!=null&&(r.uint32(21),r.fixed32(t.FractionalNanoseconds)),i.lengthDelimited!==!1&&r.ldelim()},(t,r)=>{const i={},s=r==null?t.len:t.pos+r;for(;t.pos<s;){const o=t.uint32();switch(o>>>3){case 1:i.Seconds=t.int64();break;case 2:i.FractionalNanoseconds=t.fixed32();break;default:t.skipType(o&7);break}}return i})),e),n.encode=t=>ye(t,n.codec()),n.decode=t=>we(t,n.codec())})(ih||(ih={}));var v5;(function(n){let e;n.codec=()=>(e==null&&(e=me((t,r,i={})=>{i.lengthDelimited!==!1&&r.fork(),t.MimeType!=null&&(r.uint32(10),r.string(t.MimeType)),i.lengthDelimited!==!1&&r.ldelim()},(t,r)=>{const i={},s=r==null?t.len:t.pos+r;for(;t.pos<s;){const o=t.uint32();switch(o>>>3){case 1:i.MimeType=t.string();break;default:t.skipType(o&7);break}}return i})),e),n.encode=t=>ye(t,n.codec()),n.decode=t=>we(t,n.codec())})(v5||(v5={}));const S5={Raw:"raw",Directory:"directory",File:"file",Metadata:"metadata",Symlink:"symlink",HAMTShard:"hamt-sharded-directory"},yU=["directory","hamt-sharded-directory"],E5=parseInt("0644",8),x5=parseInt("0755",8),A5=BigInt(1024);let Se=class Yv{constructor(e={type:"file"}){l(this,"type");l(this,"data");l(this,"blockSizes");l(this,"hashType");l(this,"fanout");l(this,"mtime");l(this,"_mode");l(this,"_originalMode");const{type:t,data:r,blockSizes:i,hashType:s,fanout:o,mtime:a,mode:c}=e;if(t!=null&&!Object.values(S5).includes(t))throw new nh("Type: "+t+" is not valid");this.type=t??"file",this.data=r,this.hashType=s,this.fanout=o,this.blockSizes=i??[],this._originalMode=0,this.mode=c,this.mtime=a}static unmarshal(e){const t=wn.decode(e);if(t.fanout!=null&&t.fanout>A5)throw new dp(`Fanout size was too large - ${t.fanout} > ${A5}`);const r=new Yv({type:S5[t.Type!=null?t.Type.toString():"File"],data:t.Data,blockSizes:t.blocksizes,mode:t.mode,mtime:t.mtime!=null?{secs:t.mtime.Seconds??0n,nsecs:t.mtime.FractionalNanoseconds}:void 0,fanout:t.fanout});return r._originalMode=t.mode??0,r}set mode(e){e==null?this._mode=this.isDirectory()?x5:E5:this._mode=e&4095}get mode(){return this._mode}isDirectory(){return yU.includes(this.type)}addBlockSize(e){this.blockSizes.push(e)}removeBlockSize(e){this.blockSizes.splice(e,1)}fileSize(){if(this.isDirectory())return 0n;let e=0n;return this.blockSizes.forEach(t=>{e+=t}),this.data!=null&&(e+=BigInt(this.data.length)),e}marshal(){let e;switch(this.type){case"raw":e=wn.DataType.Raw;break;case"directory":e=wn.DataType.Directory;break;case"file":e=wn.DataType.File;break;case"metadata":e=wn.DataType.Metadata;break;case"symlink":e=wn.DataType.Symlink;break;case"hamt-sharded-directory":e=wn.DataType.HAMTShard;break;default:throw new nh(`Type: ${e} is not valid`)}let t=this.data;(this.data==null||this.data.length===0)&&(t=void 0);let r;this.mode!=null&&(r=this._originalMode&4294963200|(this.mode??0),r===E5&&!this.isDirectory()&&(r=void 0),r===x5&&this.isDirectory()&&(r=void 0));let i;return this.mtime!=null&&(i={Seconds:this.mtime.secs,FractionalNanoseconds:this.mtime.nsecs}),wn.encode({Type:e,Data:t,filesize:this.isDirectory()?void 0:this.fileSize(),blocksizes:this.blockSizes,hashType:this.hashType,fanout:this.fanout,mode:r,mtime:i})}};function wU(n,e={}){return new fU(n,e)}function bU({cid:n,ipfsPath:e,query:t}){return t.filename!=null?t.filename:`${e.replace(/\/ipfs\//,"").replace(/\/ipns\//,"").replace(/\//g,"_")}.car`}function vU({query:n}){const e=n["dag-scope"];return e==="all"||e==="entity"||e==="block"?e:"all"}class SU extends Ai{constructor(){super(...arguments);l(this,"id","car-plugin")}canHandle(t){var r;return this.log("checking if we can handle %c with accept %s",t.cid,t.accept),t.byteRangeContext==null||t.pathDetails==null?!1:((r=t.accept)==null?void 0:r.startsWith("application/vnd.ipld.car"))===!0||t.query.format==="car"}async handle(t){const{options:r,pathDetails:i,cid:s}=t;if(i==null)throw new Error("attempted to handle request for car with no path details");const{getBlockstore:o,helia:a}=this.pluginOptions;t.reqFormat="car",t.query.download=!0,t.query.filename=bU(t);const c=o(s,t.resource,(r==null?void 0:r.session)??!0,r),u=wU({blockstore:c,getCodec:a.getCodec,logger:a.logger}),d=i.ipfsRoots.filter(k=>!k.equals(s)),h={...r};d.length>0&&(h.traversal=new mU(d));const f=vU(t),p=i.terminalElement.cid??s;f==="block"?h.exporter=new b5:f==="entity"?p.code===At?h.exporter=new gU:h.exporter=new b5:h.exporter=new Qv;const{writer:m,out:w}=s8.create(p),b=async function*(){for await(const k of w)yield k};u.export(s,m,h).catch(k=>{this.log.error("error exporting car - %e",k)}),t.byteRangeContext.setBody(f3(b()));const S=io(t.resource,t.byteRangeContext.getBody("application/vnd.ipld.car; version=1"),{byteRangeContext:t.byteRangeContext,log:this.log});return S.headers.set("content-type",t.byteRangeContext.getContentType()??"application/vnd.ipld.car; version=1"),S}}function EU(n){const e=hs(n,{allowIndefinite:!1,coerceUndefinedToNull:!1,allowNaN:!1,allowInfinity:!1,strict:!0,useMaps:!1,rejectDuplicateMapKeys:!0,allowBigInt:!1});return new TextDecoder().decode(xE(e))}class ki extends Error{constructor(t,r,i){super(t);l(this,"name");l(this,"code");this.name=r,this.code=i}}let Oa=class extends ki{constructor(e="not a Unixfs node"){super(e,"NotUnixFSError","ERR_NOT_UNIXFS")}};class Qs extends ki{constructor(e="invalid PBNode"){super(e,"InvalidPBNodeError","ERR_INVALID_PB_NODE")}}class m3 extends ki{constructor(e="unknown error"){super(e,"InvalidPBNodeError","ERR_UNKNOWN_ERROR")}}class Xv extends ki{constructor(e="path already exists"){super(e,"AlreadyExistsError","ERR_ALREADY_EXISTS")}}class Zv extends ki{constructor(e="path does not exist"){super(e,"DoesNotExistError","ERR_DOES_NOT_EXIST")}}class Jv extends ki{constructor(e="no content"){super(e,"NoContentError","ERR_NO_CONTENT")}}class xU extends ki{constructor(e="not a file"){super(e,"NotAFileError","ERR_NOT_A_FILE")}}class y3 extends ki{constructor(e="not a directory"){super(e,"NotADirectoryError","ERR_NOT_A_DIRECTORY")}}let rn=class extends ki{constructor(e="invalid parameters"){super(e,"InvalidParametersError","ERR_INVALID_PARAMETERS")}};var Vn;let AU=(Vn=class extends Error{constructor(t="Bad path"){super(t);l(this,"name",Vn.name);l(this,"code",Vn.code)}},l(Vn,"name","BadPathError"),l(Vn,"code","ERR_BAD_PATH"),Vn);var zn;let ma=(zn=class extends Error{constructor(t="Not found"){super(t);l(this,"name",zn.name);l(this,"code",zn.code)}},l(zn,"name","NotFoundError"),l(zn,"code","ERR_NOT_FOUND"),zn);var Kn;let kU=(Kn=class extends Error{constructor(t="No resolver"){super(t);l(this,"name",Kn.name);l(this,"code",Kn.code)}},l(Kn,"name","NoResolverError"),l(Kn,"code","ERR_NO_RESOLVER"),Kn);var qn;let yr=(qn=class extends Error{constructor(t="Not UnixFS"){super(t);l(this,"name",qn.name);l(this,"code",qn.code)}},l(qn,"name","NotUnixFSError"),l(qn,"code","ERR_NOT_UNIXFS"),qn);var Wn;let _U=(Wn=class extends Error{constructor(t="Over read"){super(t);l(this,"name",Wn.name);l(this,"code",Wn.code)}},l(Wn,"name","OverReadError"),l(Wn,"code","ERR_OVER_READ"),Wn);var Gn;let IU=(Gn=class extends Error{constructor(t="Under read"){super(t);l(this,"name",Gn.name);l(this,"code",Gn.code)}},l(Gn,"name","UnderReadError"),l(Gn,"code","ERR_UNDER_READ"),Gn);var jn;let CU=(jn=class extends Error{constructor(t="No Property found"){super(t);l(this,"name",jn.name);l(this,"code",jn.code)}},l(jn,"name","NoPropError"),l(jn,"code","ERR_NO_PROP"),jn);var Qn;let lu=(Qn=class extends Error{constructor(t="Invalid parameters"){super(t);l(this,"name",Qn.name);l(this,"code",Qn.code)}},l(Qn,"name","InvalidParametersError"),l(Qn,"code","ERR_INVALID_PARAMS"),Qn);function w3(n,e,t,r,i,s,o){let a=n,c=i;for(;s.length>0;){const u=s[0];if(u in a){s.shift(),c=`${c}/${u}`;const d=le.asCID(a[u]);if(d!=null)return{entry:{type:"object",name:r,path:i,cid:t,node:e,depth:o,size:BigInt(e.length),content:async function*(){yield n}},next:{cid:d,name:u,path:c,toResolve:s}};a=a[u]}else throw new CU(`No property named ${u} found in node ${t}`)}return{entry:{type:"object",name:r,path:i,cid:t,node:e,depth:o,size:BigInt(e.length),content:async function*(){yield n}}}}const TU=async(n,e,t,r,i,s,o,a)=>{const c=await o.get(n,a),u=mh(c);return w3(u,c,n,e,t,r,s)},RU=async(n,e,t,r,i,s,o,a)=>{const c=await o.get(n,a),u=Lp(c);return w3(u,c,n,e,t,r,s)};function sh(n,e,t,r){const i=BigInt(n.length),s=BigInt(e+i);return t>=s||r<e?new Uint8Array(0):(r>=e&&r<s&&(n=n.subarray(0,Number(r-e))),t>=e&&t<s&&(n=n.subarray(Number(t-e))),n)}const b3=(n,e=0,t=n)=>{const r=BigInt(n),i=BigInt(e??0);let s=BigInt(t);if(s!==r&&(s=i+s),s>r&&(s=r),i<0n)throw new lu("Offset must be greater than or equal to 0");if(i>r)throw new lu("Offset must be less than the file size");if(s<0n)throw new lu("Length must be greater than or equal to 0");if(s>r)throw new lu("Length must be less than the file size");return{start:i,end:s}},PU=n=>{async function*e(t={}){var o;const{start:r,end:i}=b3(n.length,t.offset,t.length),s=sh(n,0n,r,i);(o=t.onProgress)==null||o.call(t,new N("unixfs:exporter:progress:identity",{bytesRead:BigInt(s.byteLength),totalBytes:i-r,fileSize:BigInt(n.byteLength)})),yield s}return e},OU=async(n,e,t,r,i,s,o,a)=>{if(r.length>0)throw new ma(`No link named ${t} found in raw node ${n}`);const c=Pt(n.multihash.bytes);return{entry:{type:"identity",name:e,path:t,cid:n,content:PU(c.digest),depth:s,size:BigInt(c.digest.length),node:c.digest}}},DU=async(n,e,t,r,i,s,o,a)=>{const c=await o.get(n,a),u=n8(c);return w3(u,c,n,e,t,r,s)},NU=n=>{async function*e(t={}){var o;const{start:r,end:i}=b3(n.length,t.offset,t.length),s=sh(n,0n,r,i);(o=t.onProgress)==null||o.call(t,new N("unixfs:exporter:progress:raw",{bytesRead:BigInt(s.byteLength),totalBytes:i-r,fileSize:BigInt(n.byteLength)})),yield s}return e},LU=async(n,e,t,r,i,s,o,a)=>{if(r.length>0)throw new ma(`No link named ${t} found in raw node ${n}`);const c=await o.get(n,a);return{entry:{type:"raw",name:e,path:t,cid:n,content:NU(c),depth:s,size:BigInt(c.length),node:c}}},uu=7;var BU=class{constructor(){this._bitArrays=[],this._data=[],this._length=0,this._changedLength=!1,this._changedData=!1}set(e,t){let r=this._internalPositionFor(e,!1);if(t===void 0)r!==-1&&(this._unsetInternalPos(r),this._unsetBit(e),this._changedLength=!0,this._changedData=!0);else{let i=!1;r===-1?(r=this._data.length,this._setBit(e),this._changedData=!0):i=!0,this._setInternalPos(r,e,t,i),this._changedLength=!0}}unset(e){this.set(e,void 0)}get(e){this._sortData();const t=this._internalPositionFor(e,!0);if(t!==-1)return this._data[t][1]}push(e){return this.set(this.length,e),this.length}get length(){if(this._sortData(),this._changedLength){const e=this._data[this._data.length-1];this._length=e?e[0]+1:0,this._changedLength=!1}return this._length}forEach(e){let t=0;for(;t<this.length;)e(this.get(t),t,this),t++}map(e){let t=0,r=new Array(this.length);for(;t<this.length;)r[t]=e(this.get(t),t,this),t++;return r}reduce(e,t){let r=0,i=t;for(;r<this.length;){const s=this.get(r);i=e(i,s,r),r++}return i}find(e){let t=0,r,i;for(;t<this.length&&!r;)i=this.get(t),r=e(i),t++;return r?i:void 0}_internalPositionFor(e,t){const r=this._bytePosFor(e,t);if(r>=this._bitArrays.length)return-1;const i=this._bitArrays[r],s=e-r*uu;if(!((i&1<<s)>0))return-1;const a=this._bitArrays.slice(0,r).reduce(MU,0),c=~(4294967295<<s+1),u=eS(i&c);return a+u-1}_bytePosFor(e,t){const r=Math.floor(e/uu),i=r+1;for(;!t&&this._bitArrays.length<i;)this._bitArrays.push(0);return r}_setBit(e){const t=this._bytePosFor(e,!1);this._bitArrays[t]|=1<<e-t*uu}_unsetBit(e){const t=this._bytePosFor(e,!1);this._bitArrays[t]&=~(1<<e-t*uu)}_setInternalPos(e,t,r,i){const s=this._data,o=[t,r];if(i)this._sortData(),s[e]=o;else{if(s.length)if(s[s.length-1][0]>=t)s.push(o);else if(s[0][0]<=t)s.unshift(o);else{const a=Math.round(s.length/2);this._data=s.slice(0,a).concat(o).concat(s.slice(a))}else this._data.push(o);this._changedData=!0,this._changedLength=!0}}_unsetInternalPos(e){this._data.splice(e,1)}_sortData(){this._changedData&&this._data.sort(UU),this._changedData=!1}bitField(){const e=[];let t=8,r=0,i=0,s;const o=this._bitArrays.slice();for(;o.length||r;){r===0&&(s=o.shift(),r=7);const c=Math.min(r,t),u=~(255<<c),d=s&u;i|=d<<8-t,s=s>>>c,r-=c,t-=c,(!t||!r&&!o.length)&&(e.push(i),i=0,t=8)}for(var a=e.length-1;a>0&&e[a]===0;a--)e.pop();return e}compactArray(){return this._sortData(),this._data.map(FU)}};function MU(n,e){return n+eS(e)}function eS(n){let e=n;return e=e-(e>>1&1431655765),e=(e&858993459)+(e>>2&858993459),(e+(e>>4)&252645135)*16843009>>24}function UU(n,e){return n[0]-e[0]}function FU(n){return n[1]}const oh=ol(BU);class Ot{constructor(e,t,r=0){l(this,"_options");l(this,"_popCount");l(this,"_parent");l(this,"_posAtParent");l(this,"_children");l(this,"key");this._options=e,this._popCount=0,this._parent=t,this._posAtParent=r,this._children=new oh,this.key=null}async put(e,t){const r=await this._findNewBucketAndPos(e);r.bucket._putAt(r,e,t)}async get(e){const t=await this._findChild(e);if(t!=null)return t.value}async del(e){const t=await this._findPlace(e),r=t.bucket._at(t.pos);r!=null&&r.key===e&&t.bucket._delAt(t.pos)}leafCount(){return this._children.compactArray().reduce((t,r)=>r instanceof Ot?t+r.leafCount():t+1,0)}childrenCount(){return this._children.length}onlyChild(){return this._children.get(0)}*eachLeafSeries(){const e=this._children.compactArray();for(const t of e)t instanceof Ot?yield*t.eachLeafSeries():yield t}serialize(e,t){const r=[];return t(this._children.reduce((i,s,o)=>(s!=null&&(s instanceof Ot?i.push(s.serialize(e,t)):i.push(e(s,o))),i),r))}async asyncTransform(e,t){return tS(this,e,t)}toJSON(){return this.serialize(HU,VU)}prettyPrint(){return JSON.stringify(this.toJSON(),null,"  ")}tableSize(){return Math.pow(2,this._options.bits)}async _findChild(e){const t=await this._findPlace(e),r=t.bucket._at(t.pos);if(!(r instanceof Ot)&&r!=null&&r.key===e)return r}async _findPlace(e){const t=this._options.hash(typeof e=="string"?R(e):e),r=await t.take(this._options.bits),i=this._children.get(r);return i instanceof Ot?i._findPlace(t):{bucket:this,pos:r,hash:t,existingChild:i}}async _findNewBucketAndPos(e){const t=await this._findPlace(e);if(t.existingChild!=null&&t.existingChild.key!==e){const r=new Ot(this._options,t.bucket,t.pos);t.bucket._putObjectAt(t.pos,r);const i=await r._findPlace(t.existingChild.hash);return i.bucket._putAt(i,t.existingChild.key,t.existingChild.value),r._findNewBucketAndPos(t.hash)}return t}_putAt(e,t,r){this._putObjectAt(e.pos,{key:t,value:r,hash:e.hash})}_putObjectAt(e,t){this._children.get(e)==null&&this._popCount++,this._children.set(e,t)}_delAt(e){if(e===-1)throw new Error("Invalid position");this._children.get(e)!=null&&this._popCount--,this._children.unset(e),this._level()}_level(){if(this._parent!=null&&this._popCount<=1)if(this._popCount===1){const e=this._children.find($U);if(e!=null&&!(e instanceof Ot)){const t=e.hash;t.untake(this._options.bits);const r={pos:this._posAtParent,hash:t,bucket:this._parent};this._parent._putAt(r,e.key,e.value)}}else this._parent._delAt(this._posAtParent)}_at(e){return this._children.get(e)}}function $U(n){return!!n}function HU(n,e){return n.key}function VU(n){return n}async function tS(n,e,t){const r=[];for(const i of n._children.compactArray())if(i instanceof Ot)await tS(i,e,t);else{const s=await e(i);r.push({bitField:n._children.bitField(),children:s})}return t(r)}const zU=[255,254,252,248,240,224,192,128],KU=[1,3,7,15,31,63,127,255];let qU=class{constructor(e){l(this,"_value");l(this,"_currentBytePos");l(this,"_currentBitPos");this._value=e,this._currentBytePos=e.length-1,this._currentBitPos=7}availableBits(){return this._currentBitPos+1+this._currentBytePos*8}totalBits(){return this._value.length*8}take(e){let t=e,r=0;for(;t>0&&this._haveBits();){const i=this._value[this._currentBytePos],s=this._currentBitPos+1,o=Math.min(s,t),a=WU(i,s-o,o);r=(r<<o)+a,t-=o,this._currentBitPos-=o,this._currentBitPos<0&&(this._currentBitPos=7,this._currentBytePos--)}return r}untake(e){for(this._currentBitPos+=e;this._currentBitPos>7;)this._currentBitPos-=8,this._currentBytePos+=1}_haveBits(){return this._currentBytePos>=0}};function WU(n,e,t){const r=GU(e,t);return(n&r)>>>e}function GU(n,e){return zU[n]&KU[Math.min(e+n-1,7)]}function jU(n){function e(t){return t instanceof k5?t:new k5(t,n)}return e}let k5=class{constructor(e,t){l(this,"_value");l(this,"_hashFn");l(this,"_depth");l(this,"_availableBits");l(this,"_currentBufferIndex");l(this,"_buffers");if(!(e instanceof Uint8Array))throw new Error("can only hash Uint8Arrays");this._value=e,this._hashFn=t,this._depth=-1,this._availableBits=0,this._currentBufferIndex=0,this._buffers=[]}async take(e){let t=e;for(;this._availableBits<t;)await this._produceMoreBits();let r=0;for(;t>0;){const i=this._buffers[this._currentBufferIndex],s=Math.min(i.availableBits(),t),o=i.take(s);r=(r<<s)+o,t-=s,this._availableBits-=s,i.availableBits()===0&&this._currentBufferIndex++}return r}untake(e){let t=e;for(;t>0;){const r=this._buffers[this._currentBufferIndex],i=Math.min(r.totalBits()-r.availableBits(),t);r.untake(i),t-=i,this._availableBits+=i,this._currentBufferIndex>0&&r.totalBits()===r.availableBits()&&(this._depth--,this._currentBufferIndex--)}}async _produceMoreBits(){this._depth++;const e=this._depth>0?sr([this._value,Uint8Array.from([this._depth])]):this._value,t=await this._hashFn(e),r=new qU(t);this._buffers.push(r),this._availableBits+=r.availableBits()}};function L1(n){if(n==null||n.hashFn==null)throw new Error("please define an options.hashFn");const e={bits:n.bits??8,hash:jU(n.hashFn)};return new Ot(e)}const QU=async function(n){return(await al.encode(n)).slice(0,8).reverse()},YU=async(n,e,t)=>{const r=(e.tableSize()-1).toString(16).length;await Promise.all(n.map(async i=>{if(i.Name==null)throw new Error("Unexpected Link without a Name");if(i.Name.length===r){const s=parseInt(i.Name,16);e._putObjectAt(s,new Ot({hash:t._options.hash,bits:t._options.bits},e,s));return}await t.put(i.Name.substring(2),!0)}))},_5=(n,e)=>n.toString(16).toUpperCase().padStart(e,"0").substring(0,e),XU=n=>{let e=n.bucket;const t=[];for(;e._parent!=null;)t.push(e),e=e._parent;return t.push(e),t.reverse()},rS=async(n,e,t,r,i)=>{if(r==null){if(n.Data==null)throw new yr("no data in PBNode");let h;try{h=Se.unmarshal(n.Data)}catch(p){throw new yr(p.message)}if(h.type!=="hamt-sharded-directory")throw new yr("not a HAMT");if(h.fanout==null)throw new yr("missing fanout");const f=L1({hashFn:QU,bits:Math.log2(Number(h.fanout))});r={rootBucket:f,hamtDepth:1,lastBucket:f}}const s=(r.lastBucket.tableSize()-1).toString(16).length;await YU(n.Links,r.lastBucket,r.rootBucket);const o=await r.rootBucket._findNewBucketAndPos(e);let a=_5(o.pos,s);const c=XU(o);c.length>r.hamtDepth&&(r.lastBucket=c[r.hamtDepth],a=_5(r.lastBucket._posAtParent,s));const u=n.Links.find(h=>{if(h.Name==null)return!1;const f=h.Name.substring(0,s),p=h.Name.substring(s);return!(f!==a||p!==""&&p!==e)});if(u==null)return;if(u.Name!=null&&u.Name.substring(s)===e)return u.Hash;r.hamtDepth++;const d=await t.get(u.Hash,i);return n=cr(d),rS(n,e,t,r,i)},ZU=(n,e,t,r,i,s,o)=>{async function*a(c={}){var f;const u=c.offset??0,d=c.length??e.Links.length,h=e.Links.slice(u,d);(f=c.onProgress)==null||f.call(c,new N("unixfs:exporter:walk:directory",{cid:n})),yield*_t(h,p=>vr(p,m=>async()=>{const w=m.Name??"",b=`${r}/${w}`;return(await i(m.Hash,w,b,[],s+1,o,c)).entry}),p=>Cn(p,{ordered:!0,concurrency:c.blockReadConcurrency}),p=>Mn(p,m=>m!=null))}return a};async function nS(n,e,t,r,i,s,o){if(e instanceof Uint8Array){const u=sh(e,r,i,s);t.push(u);return}if(e.Data==null)throw new yr("no data in PBNode");let a;try{a=Se.unmarshal(e.Data)}catch(u){throw new yr(u.message)}if(a.data!=null){const u=a.data,d=sh(u,r,i,s);t.push(d),r+=BigInt(d.byteLength)}const c=[];if(e.Links.length!==a.blockSizes.length)throw new yr("Inconsistent block sizes and dag links");for(let u=0;u<e.Links.length;u++){const d=e.Links[u],h=r,f=h+a.blockSizes[u];if((i>=h&&i<f||s>=h&&s<=f||i<h&&s>f)&&c.push({link:d,blockStart:r}),r=f,r>s)break}await _t(c,u=>vr(u,d=>async()=>{const h=await n.get(d.link.Hash,o);return{...d,block:h}}),u=>Cn(u,{ordered:!0,concurrency:o.blockReadConcurrency}),async u=>{for await(const{link:d,block:h,blockStart:f}of u){let p;switch(d.Hash.code){case At:p=cr(h);break;case Bt:p=h;break;default:t.end(new yr(`Unsupported codec: ${d.Hash.code}`));return}const m=new fl({concurrency:1});m.on("error",w=>{t.end(w)}),m.add(async()=>{var w;(w=o.onProgress)==null||w.call(o,new N("unixfs:exporter:walk:file",{cid:d.Hash})),await nS(n,p,t,f,i,s,o)}),await m.onIdle()}}),r>=s&&t.end()}const I5=(n,e,t,r,i,s,o)=>{async function*a(c={}){var w,b;const u=t.fileSize();if(u===void 0)throw new Error("File was a directory");const{start:d,end:h}=b3(u,c.offset,c.length);if(h===0n)return;let f=0n;const p=h-d,m=cn();(w=c.onProgress)==null||w.call(c,new N("unixfs:exporter:walk:file",{cid:n})),nS(o,e,m,0n,d,h,c).catch(S=>{m.end(S)});for await(const S of m)if(S!=null){if(f+=BigInt(S.byteLength),f>p)throw m.end(),new _U("Read too many bytes - the file size reported by the UnixFS data in the root node may be incorrect");f===p&&m.end(),(b=c.onProgress)==null||b.call(c,new N("unixfs:exporter:progress:unixfs:file",{bytesRead:f,totalBytes:p,fileSize:u})),yield S}if(f<p)throw new IU("Traversed entire DAG but did not read enough bytes")}return a},JU=(n,e,t,r,i,s,o)=>{function a(c={}){var u;return(u=c.onProgress)==null||u.call(c,new N("unixfs:exporter:walk:hamt-sharded-directory",{cid:n})),iS(e,r,i,s,o,c)}return a};async function*iS(n,e,t,r,i,s){const o=n.Links;if(n.Data==null)throw new yr("no data in PBNode");let a;try{a=Se.unmarshal(n.Data)}catch(d){throw new yr(d.message)}if(a.fanout==null)throw new yr("missing fanout");const c=(a.fanout-1n).toString(16).length,u=_t(o,d=>vr(d,h=>async()=>{var p;const f=h.Name!=null?h.Name.substring(c):null;if(f!=null&&f!==""){const m=await t(h.Hash,f,`${e}/${f}`,[],r+1,i,s);return{entries:m.entry==null?[]:[m.entry]}}else{const m=await i.get(h.Hash,s);return n=cr(m),(p=s.onProgress)==null||p.call(s,new N("unixfs:exporter:walk:hamt-sharded-directory",{cid:h.Hash})),{entries:iS(n,e,t,r,i,s)}}}),d=>Cn(d,{ordered:!0,concurrency:s.blockReadConcurrency}));for await(const{entries:d}of u)yield*d}const eF=(n,e)=>{const t=n.Links.find(r=>r.Name===e);return t==null?void 0:t.Hash},tF={raw:I5,file:I5,directory:ZU,"hamt-sharded-directory":JU,metadata:(n,e,t,r,i,s,o)=>()=>[],symlink:(n,e,t,r,i,s,o)=>()=>[]},rF=async(n,e,t,r,i,s,o,a)=>{const c=await o.get(n,a),u=cr(c);let d,h;if(e==null&&(e=n.toString()),u.Data==null)throw new yr("no data in PBNode");try{d=Se.unmarshal(u.Data)}catch(p){throw new yr(p.message)}if(t==null&&(t=e),r.length>0){let p;if((d==null?void 0:d.type)==="hamt-sharded-directory"?p=await rS(u,r[0],o):p=eF(u,r[0]),p==null)throw new ma("file does not exist");const m=r.shift(),w=`${t}/${m}`;h={cid:p,toResolve:r,name:m??"",path:w}}const f=tF[d.type](n,u,d,t,i,s,o);if(f==null)throw new ma("could not find content exporter");return d.isDirectory()?{entry:{type:"directory",name:e,path:t,cid:n,content:f,unixfs:d,depth:s,node:u,size:d.fileSize()},next:h}:{entry:{type:"file",name:e,path:t,cid:n,content:f,unixfs:d,depth:s,node:u,size:d.fileSize()},next:h}},nF={[At]:rF,[Bt]:LU,[oi]:TU,[ks]:RU,[nn.code]:OU,[qo]:DU},sS=async(n,e,t,r,i,s,o)=>{const a=nF[n.code];if(a==null)throw new kU(`No resolver for code ${n.code}`);return a(n,e,t,r,sS,i,s,o)},iF=(n="")=>(n.trim().match(/([^\\^/]|\\\/)+/g)??[]).filter(Boolean),sF=n=>{if(n instanceof Uint8Array)return{cid:le.decode(n),toResolve:[]};const e=le.asCID(n);if(e!=null)return{cid:e,toResolve:[]};if(typeof n=="string"){n.indexOf("/ipfs/")===0&&(n=n.substring(6));const t=iF(n);return{cid:le.parse(t[0]),toResolve:t.slice(1)}}throw new AU(`Unknown path type ${n}`)};async function*oS(n,e,t={}){let{cid:r,toResolve:i}=sF(n),s=r.toString(),o=s;const a=i.length;for(;;){const c=await sS(r,s,o,i,a,e,t);if(c.entry==null&&c.next==null)throw new ma(`Could not resolve ${n}`);if(c.entry!=null&&(yield c.entry),c.next==null)return;i=c.next.toResolve,r=c.next.cid,s=c.next.name,o=c.next.path}}async function ah(n,e,t={}){const r=await Xs(oS(n,e,t));if(r==null)throw new ma(`Could not resolve ${n}`);return r}async function*oF(n,e,t={}){const r=await ah(n,e,t);if(r==null)return;if(yield r,r.type==="directory")for await(const s of i(r,t))yield s;async function*i(s,o){for await(const a of s.content(o))yield a,!(a instanceof Uint8Array)&&a.type==="directory"&&(yield*i(a,o))}}async function aF(n,e,t){const r=[];let i;for await(const s of oS(e,n,t))r.push(s.cid),i=s;if(i==null)throw new Zv("No terminal element found");return{ipfsRoots:r,terminalElement:i}}function C5(n){return n.type==="object"}async function cF({cid:n,path:e,resource:t,options:r,blockstore:i,log:s}){var o,a;try{return await aF(i,`${n.toString()}/${e}`,r)}catch(c){if((o=r==null?void 0:r.signal)!=null&&o.aborted)throw new Jn((a=r==null?void 0:r.signal)==null?void 0:a.reason);return["ERR_NO_PROP","ERR_NO_TERMINAL_ELEMENT","ERR_NOT_FOUND"].includes(c.code)?jv(t):(s.error("error walking path %s",e,c),g3(t,"Error walking path"))}}class lF extends Ai{constructor(){super(...arguments);l(this,"id","dag-cbor-plugin");l(this,"codes",[oi])}canHandle({cid:t,accept:r,pathDetails:i,byteRangeContext:s,plugins:o}){return this.log("checking if we can handle %c with accept %s",t,r),i==null||!C5(i.terminalElement)||t.code!==oi||s==null||r!=null&&r.includes("text/html")&&o.includes("dag-cbor-plugin-html-preview")?!1:C5(i.terminalElement)}async handle(t){const{cid:r,path:i,resource:s,accept:o,pathDetails:{terminalElement:a,ipfsRoots:c}}=t;this.log.trace("fetching %c/%s",r,i);const u=a.node;let d;if(o==="application/octet-stream"||o==="application/vnd.ipld.dag-cbor"||o==="application/cbor")d=u;else if(o==="application/vnd.ipld.dag-json")try{const p=mh(u);d=AE(p)}catch(p){return this.log.error("could not transform %c to application/vnd.ipld.dag-json",p),jc(s)}else try{d=EU(u)}catch(p){if(o==="application/json")return this.log('could not decode DAG-CBOR as JSON-safe, but the client sent "Accept: application/json"',p),jc(s);this.log("could not decode DAG-CBOR as JSON-safe, falling back to `application/octet-stream`",p),d=u}t.byteRangeContext.setBody(d);const h=o??(d instanceof Uint8Array?"application/octet-stream":"application/json"),f=io(s,t.byteRangeContext.getBody(h),{byteRangeContext:t.byteRangeContext,log:this.log});return f.headers.set("content-type",t.byteRangeContext.getContentType()??h),this.log.trace('setting content type to "%s"',t.byteRangeContext.getContentType()??h),qv(f,c),f}}function uF(n){return n[Symbol.asyncIterator]!=null}function aS(n,e=1){return e=Number(e),uF(n)?async function*(){let t=[];if(e<1&&(e=1),e!==Math.round(e))throw new Error("Batch size must be an integer");for await(const r of n)for(t.push(r);t.length>=e;)yield t.slice(0,e),t=t.slice(e);for(;t.length>0;)yield t.slice(0,e),t=t.slice(e)}():function*(){let t=[];if(e<1&&(e=1),e!==Math.round(e))throw new Error("Batch size must be an integer");for(const r of n)for(t.push(r);t.length>=e;)yield t.slice(0,e),t=t.slice(e);for(;t.length>0;)yield t.slice(0,e),t=t.slice(e)}()}async function*cS(n,e=1){for await(const t of aS(n,e)){const r=t.map(async i=>i().then(s=>({ok:!0,value:s}),s=>({ok:!1,err:s})));for(let i=0;i<r.length;i++){const s=await r[i];if(s.ok)yield s.value;else throw s.err}}}const dF=262144,lS=(n={})=>{const e=n.chunkSize??dF;return async function*(r){let i=new Ee,s=0,o=!1;for await(const a of r)for(i.append(a),s+=a.length;s>=e;)if(yield i.slice(0,e),o=!0,e===i.length)i=new Ee,s=0;else{const c=new Ee;c.append(i.sublist(e)),i=c,s-=e}(!o||s>0)&&(yield i.subarray(0,s))}},ya=async(n,e,t)=>{t.codec==null&&(t.codec=nl);const r=await ut.digest(n),i=le.create(t.cidVersion,t.codec.code,r);return await e.put(i,n,t),i};function hF(n){return async function*(t,r){let i=0n;for await(let s of t.content)yield async()=>{var u;let o;const a={codec:nl,cidVersion:n.cidVersion,onProgress:n.onProgress};n.rawLeaves?(a.codec=j6,a.cidVersion=1):(o=new Se({type:n.leafType,data:s}),s=dt({Data:o.marshal(),Links:[]}));const c=await ya(s,r,a);return i+=BigInt(s.byteLength),(u=n.onProgress)==null||u.call(n,new N("unixfs:importer:progress:file:write",{bytesWritten:i,cid:c,path:t.path})),{cid:c,unixfs:o,size:BigInt(s.length),block:s}}}}var Yn;let fF=(Yn=class extends Error{constructor(t="Invalid parameters"){super(t);l(this,"name",Yn.name);l(this,"code",Yn.code)}},l(Yn,"name","InvalidParametersError"),l(Yn,"code","ERR_INVALID_PARAMS"),Yn);const yo=class yo extends Error{constructor(t="Invalid content"){super(t);l(this,"name",yo.name);l(this,"code",yo.code)}};l(yo,"name","InvalidContentError"),l(yo,"code","ERR_INVALID_CONTENT");let wa=yo;const pF=async(n,e,t)=>{const r=new Se({type:"directory",mtime:n.mtime,mode:n.mode}),i=dt(sn({Data:r.marshal()})),s=await ya(i,e,t),o=n.path;return{cid:s,path:o,unixfs:r,size:BigInt(i.length),originalPath:n.originalPath,block:i}};async function*gF(n,e,t){let r=-1,i;for await(const s of cS(t.bufferImporter(n,e),t.blockWriteConcurrency)){if(r++,r===0){i={...s,single:!0};continue}else r===1&&i!=null&&(yield{...i,block:void 0,single:void 0},i=void 0);yield{...s,block:void 0}}i!=null&&(yield i)}function T5(n){return n.single===!0}const mF=(n,e,t)=>async function(i){var d,h;if(i.length===1&&T5(i[0])&&t.reduceSingleLeafToSelf){const f=i[0];let p=f.block;return T5(f)&&(n.mtime!==void 0||n.mode!==void 0)&&(f.unixfs=new Se({type:"file",mtime:n.mtime,mode:n.mode,data:f.block}),p={Data:f.unixfs.marshal(),Links:[]},f.block=dt(sn(p)),f.cid=await ya(f.block,e,{...t,cidVersion:t.cidVersion}),f.size=BigInt(f.block.length)),(d=t.onProgress)==null||d.call(t,new N("unixfs:importer:progress:file:layout",{cid:f.cid,path:f.originalPath})),{cid:f.cid,path:n.path,unixfs:f.unixfs,size:f.size,originalPath:f.originalPath}}const s=new Se({type:"file",mtime:n.mtime,mode:n.mode}),o=i.filter(f=>{var p,m;return f.cid.code===Bt&&f.size>0||f.unixfs!=null&&f.unixfs.data==null&&f.unixfs.fileSize()>0n?!0:!!((m=(p=f.unixfs)==null?void 0:p.data)!=null&&m.length)}).map(f=>{var p,m;return f.cid.code===Bt?(s.addBlockSize(f.size),{Name:"",Tsize:Number(f.size),Hash:f.cid}):(((p=f.unixfs)==null?void 0:p.data)==null?s.addBlockSize(((m=f.unixfs)==null?void 0:m.fileSize())??0n):s.addBlockSize(BigInt(f.unixfs.data.length)),{Name:"",Tsize:Number(f.size),Hash:f.cid})}),a={Data:s.marshal(),Links:o},c=dt(sn(a)),u=await ya(c,e,t);return(h=t.onProgress)==null||h.call(t,new N("unixfs:importer:progress:file:layout",{cid:u,path:n.originalPath})),{cid:u,path:n.path,unixfs:s,size:BigInt(c.length+a.Links.reduce((f,p)=>f+(p.Tsize??0),0)),originalPath:n.originalPath,block:c}},yF=async(n,e,t)=>t.layout(gF(n,e,t),mF(n,e,t));function wF(n){return Symbol.iterator in n}function bF(n){return Symbol.asyncIterator in n}function vF(n){try{if(n instanceof Uint8Array)return async function*(){yield n}();if(wF(n))return async function*(){yield*n}();if(bF(n))return n}catch{throw new wa("Content was invalid")}throw new wa("Content was invalid")}function SF(n){return async function*(t,r){for await(const i of t){let s;if(i.path!=null&&(s=i.path,i.path=i.path.split("/").filter(o=>o!=null&&o!==".").join("/")),EF(i)){const o={path:i.path,mtime:i.mtime,mode:i.mode,content:async function*(){var u;let c=0n;for await(const d of n.chunker(n.chunkValidator(vF(i.content)))){const h=BigInt(d.byteLength);c+=h,(u=n.onProgress)==null||u.call(n,new N("unixfs:importer:progress:file:read",{bytesRead:c,chunkSize:h,path:i.path})),yield d}}(),originalPath:s},a=n.fileBuilder??yF;yield async()=>a(o,r,n)}else if(i.path!=null){const o={path:i.path,mtime:i.mtime,mode:i.mode,originalPath:s},a=n.dirBuilder??pF;yield async()=>a(o,r,n)}else throw new Error("Import candidate must have content or path or both")}}}function EF(n){return n.content!=null}const xF=()=>async function*(e){for await(const t of e){if(t.length===void 0)throw new wa("Content was invalid");if(typeof t=="string"||t instanceof String)yield R(t.toString());else if(Array.isArray(t))yield Uint8Array.from(t);else if(t instanceof Uint8Array)yield t;else throw new wa("Content was invalid")}},AF=174;function uS(n){const e=(n==null?void 0:n.maxChildrenPerNode)??AF;return async function t(r,i){const s=[];for await(const o of aS(r,e))s.push(await i(o));return s.length>1?t(s,i):s[0]}}let Qc=class{constructor(e,t){l(this,"options");l(this,"root");l(this,"dir");l(this,"path");l(this,"dirty");l(this,"flat");l(this,"parent");l(this,"parentKey");l(this,"unixfs");l(this,"mode");l(this,"mtime");l(this,"cid");l(this,"size");l(this,"nodeSize");this.options=t??{},this.root=e.root,this.dir=e.dir,this.path=e.path,this.dirty=e.dirty,this.flat=e.flat,this.parent=e.parent,this.parentKey=e.parentKey,this.unixfs=e.unixfs,this.mode=e.mode,this.mtime=e.mtime}};const hp=le.parse("QmUNLLsPACCz1vLxQVkXqqLX5R1X345qqfHbsf67hvA3Nn"),fp=le.parse("zdj7WbTaiJT1fgatdet9Ei9iDB5hdCxkbVyhyh8YTUnXMiwYi");class v3 extends Qc{constructor(t,r){super(t,r);l(this,"_children");this._children=new Map}async put(t,r){this.cid=void 0,this.size=void 0,this.nodeSize=void 0,this._children.set(t,r)}async get(t){return Promise.resolve(this._children.get(t))}childCount(){return this._children.size}directChildrenCount(){return this.childCount()}onlyChild(){return this._children.values().next().value}*eachChildSeries(){for(const[t,r]of this._children.entries())yield{key:t,child:r}}estimateNodeSize(){if(this.nodeSize!==void 0)return this.nodeSize;this.nodeSize=0;for(const[t,r]of this._children.entries())r.size!=null&&r.cid!=null&&(this.nodeSize+=t.length+(this.options.cidVersion===1?fp.bytes.byteLength:hp.bytes.byteLength));return this.nodeSize}async*flush(t){const r=[];for(const[u,d]of this._children.entries()){let h=d;if(d instanceof Qc)for await(const f of d.flush(t))h=f,yield f;h.size!=null&&h.cid!=null&&r.push({Name:u,Tsize:Number(h.size),Hash:h.cid})}const i=new Se({type:"directory",mtime:this.mtime,mode:this.mode}),s={Data:i.marshal(),Links:r},o=dt(sn(s)),a=await ya(o,t,this.options),c=o.length+s.Links.reduce((u,d)=>u+(d.Tsize??0),0);this.cid=a,this.size=c,yield{cid:a,unixfs:i,path:this.path,size:BigInt(c)}}}async function kF(n){return(await al.encode(n)).slice(0,8).reverse()}const dS=BigInt(34),_F=8;let IF=class extends Qc{constructor(t,r){super(t,r);l(this,"_bucket");this._bucket=L1({hashFn:kF,bits:r.shardFanoutBits??_F})}async put(t,r){this.cid=void 0,this.size=void 0,this.nodeSize=void 0,await this._bucket.put(t,r)}async get(t){return this._bucket.get(t)}childCount(){return this._bucket.leafCount()}directChildrenCount(){return this._bucket.childrenCount()}onlyChild(){return this._bucket.onlyChild()}*eachChildSeries(){for(const{key:t,value:r}of this._bucket.eachLeafSeries())yield{key:t,child:r}}estimateNodeSize(){return this.nodeSize!==void 0?this.nodeSize:(this.nodeSize=fS(this._bucket,this,this.options),this.nodeSize)}async*flush(t){for await(const r of hS(this._bucket,t,this,this.options))yield{...r,path:this.path}}};async function*hS(n,e,t,r){const i=n._children,s=(n.tableSize()-1).toString(16).length,o=[];let a=0n;for(let m=0;m<i.length;m++){const w=i.get(m);if(w==null)continue;const b=m.toString(16).toUpperCase().padStart(s,"0");if(w instanceof Ot){let S;for await(const k of hS(w,e,null,r))S=k;if(S==null)throw new Error("Could not flush sharded directory, no subshard found");o.push({Name:b,Tsize:Number(S.size),Hash:S.cid}),a+=S.size}else if(CF(w.value)){const S=w.value;let k;for await(const Q of S.flush(e))k=Q,yield k;if(k==null)throw new Error("Did not flush dir");const C=b+w.key;o.push({Name:C,Tsize:Number(k.size),Hash:k.cid}),a+=k.size}else{const S=w.value;if(S.cid==null)continue;const k=b+w.key,C=S.size;o.push({Name:k,Tsize:Number(C),Hash:S.cid}),a+=BigInt(C??0)}}const c=Uint8Array.from(i.bitField().reverse()),u=new Se({type:"hamt-sharded-directory",data:c,fanout:BigInt(n.tableSize()),hashType:dS,mtime:t==null?void 0:t.mtime,mode:t==null?void 0:t.mode}),d={Data:u.marshal(),Links:o},h=dt(sn(d)),f=await ya(h,e,r),p=BigInt(h.byteLength)+a;yield{cid:f,unixfs:u,size:p}}function CF(n){return typeof n.flush=="function"}function fS(n,e,t){const r=n._children,i=(n.tableSize()-1).toString(16).length,s=[];for(let u=0;u<r.length;u++){const d=r.get(u);if(d==null)continue;const h=u.toString(16).toUpperCase().padStart(i,"0");if(d instanceof Ot){const f=fS(d,null,t);s.push({Name:h,Tsize:Number(f),Hash:t.cidVersion===0?hp:fp})}else if(typeof d.value.flush=="function"){const p=d.value.nodeSize();s.push({Name:h+d.key,Tsize:Number(p),Hash:t.cidVersion===0?hp:fp})}else{const f=d.value;if(f.cid==null)continue;const p=h+d.key,m=f.size;s.push({Name:p,Tsize:Number(m),Hash:f.cid})}}const o=Uint8Array.from(r.bitField().reverse()),a=new Se({type:"hamt-sharded-directory",data:o,fanout:BigInt(n.tableSize()),hashType:dS,mtime:e==null?void 0:e.mtime,mode:e==null?void 0:e.mode});return dt(sn({Data:a.marshal(),Links:s})).length}async function pS(n,e,t,r){let i=e;e instanceof v3&&e.estimateNodeSize()>t&&(i=await TF(e,r));const s=i.parent;if(s!=null){if(i!==e){if(n!=null&&(n.parent=i),i.parentKey==null)throw new Error("No parent key found");await s.put(i.parentKey,i)}return pS(i,s,t,r)}return i}async function TF(n,e){const t=new IF({root:n.root,dir:!0,parent:n.parent,parentKey:n.parentKey,path:n.path,dirty:n.dirty,flat:!1,mtime:n.mtime,mode:n.mode},e);for(const{key:r,child:i}of n.eachChildSeries())await t.put(r,i);return t}const RF=(n="")=>n.split(new RegExp("(?<!\\\\)\\/")).filter(Boolean);async function PF(n,e,t){var a,c;const r=RF(n.path??""),i=r.length-1;let s=e,o="";for(let u=0;u<r.length;u++){const d=r[u];o+=`${o!==""?"/":""}${d}`;const h=u===i;if(s.dirty=!0,s.cid=void 0,s.size=void 0,h)await s.put(d,n),e=await pS(null,s,t.shardSplitThresholdBytes,t);else{let f=await s.get(d);(f==null||!(f instanceof Qc))&&(f=new v3({root:!1,dir:!0,parent:s,parentKey:d,path:o,dirty:!0,flat:!0,mtime:(a=f==null?void 0:f.unixfs)==null?void 0:a.mtime,mode:(c=f==null?void 0:f.unixfs)==null?void 0:c.mode},t)),await s.put(d,f),s=f}}return e}async function*R5(n,e){var t;if(!(n instanceof Qc)){((t=n.unixfs)==null?void 0:t.isDirectory())===!0&&(yield n);return}yield*n.flush(e)}function OF(n){return async function*(t,r){var a;let i=new v3({root:!0,dir:!0,path:"",dirty:!0,flat:!0},n),s,o=!1;for await(const c of t){if(c==null)continue;const u=`${c.originalPath??""}`.split("/")[0];u!=null&&u!==""&&(s==null?(s=u,o=!0):s!==u&&(o=!1)),i=await PF(c,i,n),((a=c.unixfs)==null?void 0:a.isDirectory())!==!0&&(yield c)}if(n.wrapWithDirectory||o&&i.childCount()>1)yield*R5(i,r);else for(const c of i.eachChildSeries())c!=null&&(yield*R5(c.child,r))}}async function*B1(n,e,t={}){let r;Symbol.asyncIterator in n||Symbol.iterator in n?r=n:r=[n];const i=t.wrapWithDirectory??!1,s=t.shardSplitThresholdBytes??262144,o=t.shardFanoutBits??8,a=t.cidVersion??1,c=t.rawLeaves??!0,u=t.leafType??"file",d=t.fileImportConcurrency??50,h=t.blockWriteConcurrency??10,f=t.reduceSingleLeafToSelf??!0,p=t.chunker??lS(),m=t.chunkValidator??xF(),w=t.dagBuilder??SF({chunker:p,chunkValidator:m,wrapWithDirectory:i,layout:t.layout??uS(),bufferImporter:t.bufferImporter??hF({cidVersion:a,rawLeaves:c,leafType:u,onProgress:t.onProgress}),blockWriteConcurrency:h,reduceSingleLeafToSelf:f,cidVersion:a,onProgress:t.onProgress,dirBuilder:t.dirBuilder,fileBuilder:t.fileBuilder}),b=t.treeBuilder??OF({wrapWithDirectory:i,shardSplitThresholdBytes:s,shardFanoutBits:o,cidVersion:a,onProgress:t.onProgress});for await(const S of b(cS(w(r,e),d),e))yield{cid:S.cid,path:S.path,unixfs:S.unixfs,size:S.size}}async function gS(n,e,t={}){const r=await Op(B1([n],e,t));if(r==null)throw new fF("Nothing imported");return r}async function DF(n,e,t={}){return gS({content:n},e,t)}async function NF(n,e,t={}){return gS({content:n},e,t)}const Nl={cidVersion:1,rawLeaves:!0,layout:uS({maxChildrenPerNode:1024}),chunker:lS({chunkSize:1048576})};async function*S3(n,e,t={}){yield*B1(n,e,{...Nl,...t})}async function LF(n,e,t={}){const{cid:r}=await DF(n,e,{...Nl,...t});return r}async function BF(n,e,t={}){const{cid:r}=await NF(n,e,{...Nl,...t});return r}async function MF(n,e,t={}){if(n.path==null)throw new rn("path is required");if(n.content==null)throw new rn("content is required");const r=await Xs(S3([n],e,{...Nl,...t,wrapWithDirectory:!0}));if(r==null)throw new rn("Nothing imported");return r.cid}async function UF(n,e,t={}){if(n.content!=null)throw new rn("Directories cannot have content, use addFile instead");const i=await(n.path==null?Op:Xs)(S3([{...n,path:n.path??"-"}],e,{...Nl,...t,wrapWithDirectory:n.path!=null}));if(i==null)throw new rn("Nothing imported");return i.cid}const wo=class wo extends Error{constructor(t="Bad path"){super(t);l(this,"name",wo.name);l(this,"code",wo.code)}};l(wo,"name","BadPathError"),l(wo,"code","ERR_BAD_PATH");let pp=wo;const bo=class bo extends Error{constructor(t="Not found"){super(t);l(this,"name",bo.name);l(this,"code",bo.code)}};l(bo,"name","NotFoundError"),l(bo,"code","ERR_NOT_FOUND");let ts=bo;const vo=class vo extends Error{constructor(t="No resolver"){super(t);l(this,"name",vo.name);l(this,"code",vo.code)}};l(vo,"name","NoResolverError"),l(vo,"code","ERR_NO_RESOLVER");let gp=vo;const So=class So extends Error{constructor(t="Not UnixFS"){super(t);l(this,"name",So.name);l(this,"code",So.code)}};l(So,"name","NotUnixFSError"),l(So,"code","ERR_NOT_UNIXFS");let zt=So;const Eo=class Eo extends Error{constructor(t="Over read"){super(t);l(this,"name",Eo.name);l(this,"code",Eo.code)}};l(Eo,"name","OverReadError"),l(Eo,"code","ERR_OVER_READ");let mp=Eo;const xo=class xo extends Error{constructor(t="Under read"){super(t);l(this,"name",xo.name);l(this,"code",xo.code)}};l(xo,"name","UnderReadError"),l(xo,"code","ERR_UNDER_READ");let yp=xo;const Ao=class Ao extends Error{constructor(t="No Property found"){super(t);l(this,"name",Ao.name);l(this,"code",Ao.code)}};l(Ao,"name","NoPropError"),l(Ao,"code","ERR_NO_PROP");let wp=Ao;const ko=class ko extends Error{constructor(t="Invalid parameters"){super(t);l(this,"name",ko.name);l(this,"code",ko.code)}};l(ko,"name","InvalidParametersError"),l(ko,"code","ERR_INVALID_PARAMS");let ho=ko;function E3(n,e,t,r,i,s,o){let a=n,c=i;for(;s.length>0;){const u=s[0];if(u in a){s.shift(),c=`${c}/${u}`;const d=le.asCID(a[u]);if(d!=null)return{entry:{type:"object",name:r,path:i,cid:t,node:e,depth:o,size:BigInt(e.length),content:async function*(){yield n}},next:{cid:d,name:u,path:c,toResolve:s}};a=a[u]}else throw new wp(`No property named ${u} found in node ${t}`)}return{entry:{type:"object",name:r,path:i,cid:t,node:e,depth:o,size:BigInt(e.length),content:async function*(){yield n}}}}const FF=async(n,e,t,r,i,s,o,a)=>{const c=await o.get(n,a),u=mh(c);return E3(u,c,n,e,t,r,s)},$F=async(n,e,t,r,i,s,o,a)=>{const c=await o.get(n,a),u=Lp(c);return E3(u,c,n,e,t,r,s)};function ch(n,e,t,r){const i=BigInt(n.length),s=BigInt(e+i);return t>=s||r<e?new Uint8Array(0):(r>=e&&r<s&&(n=n.subarray(0,Number(r-e))),t>=e&&t<s&&(n=n.subarray(Number(t-e))),n)}const x3=(n,e=0,t=n)=>{const r=BigInt(n),i=BigInt(e??0);let s=BigInt(t);if(s!==r&&(s=i+s),s>r&&(s=r),i<0n)throw new ho("Offset must be greater than or equal to 0");if(i>r)throw new ho("Offset must be less than the file size");if(s<0n)throw new ho("Length must be greater than or equal to 0");if(s>r)throw new ho("Length must be less than the file size");return{start:i,end:s}},HF=n=>{async function*e(t={}){var o;const{start:r,end:i}=x3(n.length,t.offset,t.length),s=ch(n,0n,r,i);(o=t.onProgress)==null||o.call(t,new N("unixfs:exporter:progress:identity",{bytesRead:BigInt(s.byteLength),totalBytes:i-r,fileSize:BigInt(n.byteLength)})),yield s}return e},VF=async(n,e,t,r,i,s,o,a)=>{if(r.length>0)throw new ts(`No link named ${t} found in raw node ${n}`);const c=Pt(n.multihash.bytes);return{entry:{type:"identity",name:e,path:t,cid:n,content:HF(c.digest),depth:s,size:BigInt(c.digest.length),node:c.digest}}},zF=async(n,e,t,r,i,s,o,a)=>{const c=await o.get(n,a),u=n8(c);return E3(u,c,n,e,t,r,s)},KF=n=>{async function*e(t={}){var o;const{start:r,end:i}=x3(n.length,t.offset,t.length),s=ch(n,0n,r,i);(o=t.onProgress)==null||o.call(t,new N("unixfs:exporter:progress:raw",{bytesRead:BigInt(s.byteLength),totalBytes:i-r,fileSize:BigInt(n.byteLength)})),yield s}return e},qF=async(n,e,t,r,i,s,o,a)=>{if(r.length>0)throw new ts(`No link named ${t} found in raw node ${n}`);const c=await o.get(n,a);return{entry:{type:"raw",name:e,path:t,cid:n,content:KF(c),depth:s,size:BigInt(c.length),node:c}}},WF=async function(n){return(await al.encode(n)).slice(0,8).reverse()},GF=async(n,e,t)=>{const r=(e.tableSize()-1).toString(16).length;await Promise.all(n.map(async i=>{if(i.Name==null)throw new Error("Unexpected Link without a Name");if(i.Name.length===r){const s=parseInt(i.Name,16);e._putObjectAt(s,new Ot({hash:t._options.hash,bits:t._options.bits},e,s));return}await t.put(i.Name.substring(2),!0)}))},P5=(n,e)=>n.toString(16).toUpperCase().padStart(e,"0").substring(0,e),jF=n=>{let e=n.bucket;const t=[];for(;e._parent!=null;)t.push(e),e=e._parent;return t.push(e),t.reverse()},mS=async(n,e,t,r,i)=>{if(r==null){if(n.Data==null)throw new zt("no data in PBNode");let h;try{h=Se.unmarshal(n.Data)}catch(p){throw new zt(p.message)}if(h.type!=="hamt-sharded-directory")throw new zt("not a HAMT");if(h.fanout==null)throw new zt("missing fanout");const f=L1({hashFn:WF,bits:Math.log2(Number(h.fanout))});r={rootBucket:f,hamtDepth:1,lastBucket:f}}const s=(r.lastBucket.tableSize()-1).toString(16).length;await GF(n.Links,r.lastBucket,r.rootBucket);const o=await r.rootBucket._findNewBucketAndPos(e);let a=P5(o.pos,s);const c=jF(o);c.length>r.hamtDepth&&(r.lastBucket=c[r.hamtDepth],a=P5(r.lastBucket._posAtParent,s));const u=n.Links.find(h=>{if(h.Name==null)return!1;const f=h.Name.substring(0,s),p=h.Name.substring(s);return!(f!==a||p!==""&&p!==e)});if(u==null)return;if(u.Name!=null&&u.Name.substring(s)===e)return u.Hash;r.hamtDepth++;const d=await t.get(u.Hash,i);return n=cr(d),mS(n,e,t,r,i)};function A3(n){return(n==null?void 0:n.extended)===!1}const QF=(n,e,t,r,i,s,o)=>{async function*a(c={}){var f;const u=c.offset??0,d=c.length??e.Links.length,h=e.Links.slice(u,d);(f=c.onProgress)==null||f.call(c,new N("unixfs:exporter:walk:directory",{cid:n})),yield*_t(h,p=>vr(p,m=>async()=>{const w=m.Name??"",b=`${r}/${w}`;return A3(c)?{cid:m.Hash,name:w,path:b}:(await i(m.Hash,w,b,[],s+1,o,c)).entry}),p=>Cn(p,{ordered:!0,concurrency:c.blockReadConcurrency}),p=>Mn(p,m=>m!=null))}return a};async function yS(n,e,t,r,i,s,o){if(e instanceof Uint8Array){const u=ch(e,r,i,s);t.push(u);return}if(e.Data==null)throw new zt("no data in PBNode");let a;try{a=Se.unmarshal(e.Data)}catch(u){throw new zt(u.message)}if(a.data!=null){const u=a.data,d=ch(u,r,i,s);t.push(d),r+=BigInt(d.byteLength)}const c=[];if(e.Links.length!==a.blockSizes.length)throw new zt("Inconsistent block sizes and dag links");for(let u=0;u<e.Links.length;u++){const d=e.Links[u],h=r,f=h+a.blockSizes[u];if((i>=h&&i<f||s>=h&&s<=f||i<h&&s>f)&&c.push({link:d,blockStart:r}),r=f,r>s)break}await _t(c,u=>vr(u,d=>async()=>{const h=await n.get(d.link.Hash,o);return{...d,block:h}}),u=>Cn(u,{ordered:!0,concurrency:o.blockReadConcurrency}),async u=>{for await(const{link:d,block:h,blockStart:f}of u){let p;switch(d.Hash.code){case At:p=cr(h);break;case Bt:p=h;break;default:t.end(new zt(`Unsupported codec: ${d.Hash.code}`));return}const m=new fl({concurrency:1});m.on("error",w=>{t.end(w)}),m.add(async()=>{var w;(w=o.onProgress)==null||w.call(o,new N("unixfs:exporter:walk:file",{cid:d.Hash})),await yS(n,p,t,f,i,s,o)}),await m.onIdle()}}),r>=s&&t.end()}const O5=(n,e,t,r,i,s,o)=>{async function*a(c={}){var w,b;const u=t.fileSize();if(u===void 0)throw new Error("File was a directory");const{start:d,end:h}=x3(u,c.offset,c.length);if(h===0n)return;let f=0n;const p=h-d,m=cn();(w=c.onProgress)==null||w.call(c,new N("unixfs:exporter:walk:file",{cid:n})),yS(o,e,m,0n,d,h,c).catch(S=>{m.end(S)});for await(const S of m)if(S!=null){if(f+=BigInt(S.byteLength),f>p)throw m.end(),new mp("Read too many bytes - the file size reported by the UnixFS data in the root node may be incorrect");f===p&&m.end(),(b=c.onProgress)==null||b.call(c,new N("unixfs:exporter:progress:unixfs:file",{bytesRead:f,totalBytes:p,fileSize:u})),yield S}if(f<p)throw new yp("Traversed entire DAG but did not read enough bytes")}return a},YF=(n,e,t,r,i,s,o)=>{function a(c={}){var u;return(u=c.onProgress)==null||u.call(c,new N("unixfs:exporter:walk:hamt-sharded-directory",{cid:n})),wS(e,r,i,s,o,c)}return a};async function*wS(n,e,t,r,i,s){const o=n.Links;if(n.Data==null)throw new zt("no data in PBNode");let a;try{a=Se.unmarshal(n.Data)}catch(d){throw new zt(d.message)}if(a.fanout==null)throw new zt("missing fanout");const c=(a.fanout-1n).toString(16).length,u=_t(o,d=>vr(d,h=>async()=>{var p;const f=h.Name!=null?h.Name.substring(c):null;if(f!=null&&f!==""){const m=`${e}/${f}`;return A3(s)?{entries:[{cid:h.Hash,name:f,path:m}]}:{entries:[(await t(h.Hash,f,m,[],r+1,i,s)).entry].filter(Boolean)}}else{const m=await i.get(h.Hash,s);return n=cr(m),(p=s.onProgress)==null||p.call(s,new N("unixfs:exporter:walk:hamt-sharded-directory",{cid:h.Hash})),{entries:wS(n,e,t,r,i,s)}}}),d=>Cn(d,{ordered:!0,concurrency:s.blockReadConcurrency}));for await(const{entries:d}of u)yield*d}const XF=(n,e)=>{const t=n.Links.find(r=>r.Name===e);return t==null?void 0:t.Hash},ZF={raw:O5,file:O5,directory:QF,"hamt-sharded-directory":YF,metadata:(n,e,t,r,i,s,o)=>()=>[],symlink:(n,e,t,r,i,s,o)=>()=>[]},JF=async(n,e,t,r,i,s,o,a)=>{if(A3(a)&&r.length===0)return{entry:{cid:n,name:e,path:t}};const c=await o.get(n,a),u=cr(c);let d,h;if(e==null&&(e=n.toString()),u.Data==null)throw new zt("no data in PBNode");try{d=Se.unmarshal(u.Data)}catch(p){throw new zt(p.message)}if(t==null&&(t=e),r.length>0){let p;if((d==null?void 0:d.type)==="hamt-sharded-directory"?p=await mS(u,r[0],o):p=XF(u,r[0]),p==null)throw new ts("file does not exist");const m=r.shift(),w=`${t}/${m}`;h={cid:p,toResolve:r,name:m??"",path:w}}const f=ZF[d.type](n,u,d,t,i,s,o);if(f==null)throw new ts("could not find content exporter");return d.isDirectory()?{entry:{type:"directory",name:e,path:t,cid:n,content:f,unixfs:d,depth:s,node:u,size:d.fileSize()},next:h}:{entry:{type:"file",name:e,path:t,cid:n,content:f,unixfs:d,depth:s,node:u,size:d.fileSize()},next:h}},e$={[At]:JF,[Bt]:qF,[oi]:FF,[ks]:$F,[nn.code]:VF,[qo]:zF},bS=async(n,e,t,r,i,s,o)=>{const a=e$[n.code];if(a==null)throw new gp(`No resolver for code ${n.code}`);return a(n,e,t,r,bS,i,s,o)},t$=(n="")=>(n.trim().match(/([^\\^/]|\\\/)+/g)??[]).filter(Boolean),r$=n=>{if(n instanceof Uint8Array)return{cid:le.decode(n),toResolve:[]};const e=le.asCID(n);if(e!=null)return{cid:e,toResolve:[]};if(typeof n=="string"){n.indexOf("/ipfs/")===0&&(n=n.substring(6));const t=t$(n);return{cid:le.parse(t[0]),toResolve:t.slice(1)}}throw new pp(`Unknown path type ${n}`)};async function*vS(n,e,t={}){let{cid:r,toResolve:i}=r$(n),s=r.toString(),o=s;const a=i.length;for(;;){const c=await bS(r,s,o,i,a,e,t);if(c.entry==null&&c.next==null)throw new ts(`Could not resolve ${n}`);if(c.entry!=null&&(yield c.entry),c.next==null)return;i=c.next.toResolve,r=c.next.cid,s=c.next.name,o=c.next.path}}async function os(n,e,t={}){const r=await Xs(vS(n,e,t));if(r==null)throw new ts(`Could not resolve ${n}`);return r}async function*SS(n,e,t={}){const r=await os(n,e,t);if(r==null)return;if(yield r,r.type==="directory")for await(const s of i(r,t))yield s;async function*i(s,o){for await(const a of s.content(o))yield a,!(a instanceof Uint8Array)&&a.type==="directory"&&(yield*i(a,o))}}function ES(n){function e(t){return t instanceof D5?t:new D5(t,n)}return e}class D5{constructor(e,t){l(this,"_value");l(this,"_hashFn");l(this,"_depth");l(this,"_availableBits");l(this,"_currentBufferIndex");l(this,"_buffers");if(!(e instanceof Uint8Array))throw new Error("can only hash Uint8Arrays");this._value=e,this._hashFn=t,this._depth=-1,this._availableBits=0,this._currentBufferIndex=0,this._buffers=[]}async take(e){let t=e;for(;this._availableBits<t;)await this._produceMoreBits();let r=0;for(;t>0;){const i=this._buffers[this._currentBufferIndex],s=Math.min(i.availableBits(),t),o=i.take(s);r=(r<<s)+o,t-=s,this._availableBits-=s,i.availableBits()===0&&this._currentBufferIndex++}return r}untake(e){let t=e;for(;t>0;){const r=this._buffers[this._currentBufferIndex],i=Math.min(r.totalBits()-r.availableBits(),t);r.untake(i),t-=i,this._availableBits+=i,this._currentBufferIndex>0&&r.totalBits()===r.availableBits()&&(this._depth--,this._currentBufferIndex--)}}async _produceMoreBits(){this._depth++;const e=this._depth>0?sr([this._value,Uint8Array.from([this._depth])]):this._value,t=await this._hashFn(e),r=new s$(t);this._buffers.push(r),this._availableBits+=r.availableBits()}}const n$=[255,254,252,248,240,224,192,128],i$=[1,3,7,15,31,63,127,255];class s${constructor(e){l(this,"_value");l(this,"_currentBytePos");l(this,"_currentBitPos");this._value=e,this._currentBytePos=e.length-1,this._currentBitPos=7}availableBits(){return this._currentBitPos+1+this._currentBytePos*8}totalBits(){return this._value.length*8}take(e){let t=e,r=0;for(;t>0&&this._haveBits();){const i=this._value[this._currentBytePos],s=this._currentBitPos+1,o=Math.min(s,t),a=o$(i,s-o,o);r=(r<<o)+a,t-=o,this._currentBitPos-=o,this._currentBitPos<0&&(this._currentBitPos=7,this._currentBytePos--)}return r}untake(e){for(this._currentBitPos+=e;this._currentBitPos>7;)this._currentBitPos-=8,this._currentBytePos+=1}_haveBits(){return this._currentBytePos>=0}}function o$(n,e,t){const r=a$(e,t);return(n&r)>>>e}function a$(n,e){return n$[n]&i$[Math.min(e+n-1,7)]}const k3=BigInt(al.code),gc=8;async function _3(n){return(await al.encode(n)).subarray(0,8).reverse()}const Da=async(n,e,t)=>{t.codec==null&&(t.codec=nl);const r=await ut.digest(n),i=le.create(t.cidVersion,t.codec.code,r);return await e.put(i,n,{...t,signal:t.signal}),i};class c${constructor(e,t){l(this,"options");l(this,"root");l(this,"dir");l(this,"path");l(this,"dirty");l(this,"flat");l(this,"parent");l(this,"parentKey");l(this,"unixfs");l(this,"mode");l(this,"mtime");l(this,"cid");l(this,"size");l(this,"nodeSize");this.options=t??{},this.root=e.root,this.dir=e.dir,this.path=e.path,this.dirty=e.dirty,this.flat=e.flat,this.parent=e.parent,this.parentKey=e.parentKey,this.unixfs=e.unixfs,this.mode=e.mode,this.mtime=e.mtime}}class l$ extends c${constructor(t,r){super(t,r);l(this,"_bucket");this._bucket=L1({hashFn:_3,bits:8})}async put(t,r){this.cid=void 0,this.size=void 0,this.nodeSize=void 0,await this._bucket.put(t,r)}async get(t){return this._bucket.get(t)}childCount(){return this._bucket.leafCount()}directChildrenCount(){return this._bucket.childrenCount()}onlyChild(){return this._bucket.onlyChild()}async*eachChildSeries(){for(const{key:t,value:r}of this._bucket.eachLeafSeries())yield{key:t,child:r}}estimateNodeSize(){return this.nodeSize!==void 0?this.nodeSize:(this.nodeSize=AS(this._bucket,this,this.options),this.nodeSize)}async*flush(t){for await(const r of xS(this._bucket,t,this,this.options))yield{...r,path:this.path}}}async function*xS(n,e,t,r){const i=n._children,s=[];let o=0n;for(let p=0;p<i.length;p++){const m=i.get(p);if(m==null)continue;const w=p.toString(16).toUpperCase().padStart(2,"0");if(m instanceof Ot){let b;for await(const S of xS(m,e,null,r))b=S;if(b==null)throw new Error("Could not flush sharded directory, no sub-shard found");s.push({Name:w,Tsize:Number(b.size),Hash:b.cid}),o+=b.size}else if(u$(m.value)){const b=m.value;let S;for await(const C of b.flush(e))S=C,yield S;if(S==null)throw new Error("Did not flush dir");const k=w+m.key;s.push({Name:k,Tsize:Number(S.size),Hash:S.cid}),o+=S.size}else{const b=m.value;if(b.cid==null)continue;const S=w+m.key,k=b.size;s.push({Name:S,Tsize:Number(k),Hash:b.cid}),o+=BigInt(k??0)}}const a=Uint8Array.from(i.bitField().reverse()),c=new Se({type:"hamt-sharded-directory",data:a,fanout:BigInt(n.tableSize()),hashType:k3,mtime:t==null?void 0:t.mtime,mode:t==null?void 0:t.mode}),u={Data:c.marshal(),Links:s},d=dt(sn(u)),h=await Da(d,e,r),f=BigInt(d.byteLength)+o;yield{cid:h,unixfs:c,size:f}}function u$(n){return typeof n.flush=="function"}function AS(n,e,t){const r=n._children,i=[];for(let c=0;c<r.length;c++){const u=r.get(c);if(u==null)continue;const d=c.toString(16).toUpperCase().padStart(2,"0");if(u instanceof Ot){const h=AS(u,null,t);i.push({Name:d,Tsize:Number(h),Hash:t.cidVersion===0?bp:vp})}else if(typeof u.value.flush=="function"){const f=u.value.nodeSize();i.push({Name:d+u.key,Tsize:Number(f),Hash:t.cidVersion===0?bp:vp})}else{const h=u.value;if(h.cid==null)continue;const f=d+u.key,p=h.size;i.push({Name:f,Tsize:Number(p),Hash:h.cid})}}const s=Uint8Array.from(r.bitField().reverse()),o=new Se({type:"hamt-sharded-directory",data:s,fanout:BigInt(n.tableSize()),hashType:k3,mtime:e==null?void 0:e.mtime,mode:e==null?void 0:e.mode});return dt(sn({Data:o.marshal(),Links:i})).length}const bp=le.parse("QmUNLLsPACCz1vLxQVkXqqLX5R1X345qqfHbsf67hvA3Nn"),vp=le.parse("zdj7WbTaiJT1fgatdet9Ei9iDB5hdCxkbVyhyh8YTUnXMiwYi"),Sp=Ut("helia:unixfs:commands:utils:hamt-utils"),Ep=n=>n.toString(16).toUpperCase().padStart(2,"0").substring(0,2),d$=async(n,e,t)=>{const r=new l$({root:!0,dir:!0,parent:void 0,parentKey:void 0,path:"",dirty:!0,flat:!1,mtime:t.mtime,mode:t.mode},t);for(let s=0;s<e.length;s++)await r._bucket.put(e[s].name,{size:e[s].size,cid:e[s].cid});const i=await Xs(r.flush(n));if(i==null)throw new Error("Flushing shard yielded no result");return i},kS=async(n,e,t)=>{const r=Se.unmarshal(n[0].node.Data??new Uint8Array(0)),i=BigInt(Math.pow(2,gc));n.reverse();let s,o;for(let a=0;a<n.length;a++){const c=a===n.length-1,u=n[a],d=Uint8Array.from(u.children.bitField().reverse()),h=new Se({type:"hamt-sharded-directory",data:d,fanout:i,hashType:k3});c&&(h.mtime=r.mtime,h.mode=r.mode),o={Data:h.marshal(),Links:u.node.Links};const f=dt(sn(o));if(s=await Da(f,e,t),!c){const p=n[a+1];if(p==null)throw new Error("Was not operating on shard root but also had no parent?");Sp("updating link in parent sub-shard with prefix %s",p.prefix),p.node.Links=p.node.Links.filter(m=>m.Name!==p.prefix),p.node.Links.push({Name:p.prefix,Hash:s,Tsize:u.node.Links.reduce((m,w)=>m+(w.Tsize??0),f.byteLength)})}}if(s==null||o==null)throw new Error("Noting persisted");return{cid:s,node:o}},_S=async(n,e,t,r)=>{const s=ES(_3)(R(e)),o=[];for(;;){const a=await t.get(n,r),c=cr(a),u=new oh,d=await s.take(gc),h=Ep(d);o.push({prefix:h,children:u,node:c});let f;for(const m of c.Links){const w=m.Name??"";if(w.length<2)throw new Error("Invalid HAMT - link name was too short");const b=parseInt(w.substring(0,2),16);u.set(b,!0),w.startsWith(h)&&(f=m)}if(f==null){Sp("no link found with prefix %s for %s",h,e);break}const p=f.Name??"";if(p.length<2)throw new Error("Invalid HAMT - link name was too short");if(p.length===2){n=f.Hash,Sp("descend into sub-shard with prefix %s",p);continue}break}return{path:o,hash:s}};async function IS(n,e,t,r){if(n.Data==null)throw new Error("DagPB node had no data");const i=Se.unmarshal(n.Data);let s;if(i.type==="directory")s=h$(n);else if(i.type==="hamt-sharded-directory")s=await CS(n,0,t,e,r);else throw new Error("Can only estimate the size of directories or shards");return s>t}function h$(n){let e=0;for(const t of n.Links)e+=(t.Name??"").length,e+=t.Hash.version===1?vp.bytes.byteLength:bp.bytes.byteLength;return e}async function CS(n,e,t,r,i){if(e>t)return t;if(n.Data==null||!Se.unmarshal(n.Data).isDirectory())return e;for(const o of n.Links){let a=o.Name??"";if(a=a.substring(2),e+=a.length,e+=o.Hash.bytes.byteLength,o.Hash.code===At){const c=await r.get(o.Hash,i),u=cr(c);e+=await CS(u,e,t,r,i)}}return e}const Sn=Ut("helia:unixfs:components:utils:add-link");async function I3(n,e,t,r){if(n.node.Data==null)throw new rn("Invalid parent passed to addLink");if(Se.unmarshal(n.node.Data).type==="hamt-sharded-directory")return Sn("adding link to sharded directory"),g$(n,e,t,r);Sn(`adding ${e.Name} (${e.Hash}) to regular directory`);const s=await p$(n,e,t,r);if(await IS(s.node,t,r.shardSplitThresholdBytes,r)){Sn("converting directory to sharded directory");const o=await f$(s,t);s.cid=o.cid,s.node=cr(await t.get(o.cid,r))}return s}const f$=async(n,e)=>{if(n.node.Data==null)throw new rn("Invalid parent passed to convertToShardedDirectory");const t=Se.unmarshal(n.node.Data),r=await d$(e,n.node.Links.map(i=>({name:i.Name??"",size:BigInt(i.Tsize??0),cid:i.Hash})),{mode:t.mode,mtime:t.mtime,cidVersion:n.cid.version});return Sn(`converted directory to sharded directory ${r.cid}`),r},p$=async(n,e,t,r)=>{const i=n.node.Links.filter(d=>{const h=d.Name===e.Name;if(h&&!r.allowOverwriting)throw new Xv;return!h});if(i.push(e),n.node.Data==null)throw new Qs("Parent node with no data passed to addToDirectory");const s=Se.unmarshal(n.node.Data);let o;if(s.mtime!=null){const d=Date.now(),h=Math.floor(d/1e3);s.mtime={secs:BigInt(h),nsecs:(d-h*1e3)*1e3},o=s.marshal()}else o=n.node.Data;n.node=sn({Data:o,Links:i});const a=dt(n.node),c=await ut.digest(a),u=le.create(n.cid.version,At,c);return await t.put(u,a),{node:n.node,cid:u}},g$=async(n,e,t,r)=>{var h;const{path:i,hash:s}=await _S(n.cid,e.Name,t,r),o=i[i.length-1];if(o==null)throw new Error("Invalid HAMT, could not generate path");const a=o.prefix,c=parseInt(a,16);Sn("next prefix for %s is %s",e.Name,a);const u=`${a}${e.Name}`,d=o.node.Links.find(f=>(f.Name??"").startsWith(a));if(d!=null)if(Sn("link %s was present in shard",u),d.Name===u){if(!r.allowOverwriting)throw new Xv;Sn("overwriting %s in sub-shard",e.Name),o.node.Links=o.node.Links.filter(f=>f.Name!==u),o.node.Links.push({Name:u,Hash:e.Hash,Tsize:e.Tsize})}else{if(((h=d.Name)==null?void 0:h.length)===2)throw new Error("Existing link was sub-shard?!");{Sn("prefix %s already exists, creating new sub-shard",a);const f=o.node.Links.findIndex(S=>{var k;return(k=S.Name)==null?void 0:k.startsWith(a)}),p=o.node.Links.splice(f,1)[0],m=(p.Name??"").substring(2),b=ES(_3)(R(m));for(let S=0;S<i.length;S++)await b.take(gc);for(;;){const S=await b.take(gc),k=Ep(S);p.Name=`${k}${m}`;const C=await s.take(gc),Q=Ep(C);if(k===Q){const T=new oh;T.set(C,!0),i.push({prefix:Q,children:T,node:{Links:[]}});continue}const re=new oh;re.set(C,!0),re.set(S,!0),i.push({prefix:a,children:re,node:{Links:[p,{Name:`${Q}${e.Name}`,Hash:e.Hash,Tsize:e.Tsize}]}});break}}}else Sn("link %s was not present in sub-shard",u),e.Name=u,o.node.Links.push(e),o.children.set(c,!0),Sn("adding %s to existing sub-shard",u);return kS(i,t,r)};async function M1(n,e,t={}){const r=await os(n,e,t);if(r.type!=="directory")throw new y3(`${n.toString()} was not a UnixFS directory`);return{cid:n,node:r.node}}async function C3(n,e,t,r){const i=await os(n,t,r);if(i.type!=="directory"&&i.type!=="file"&&i.type!=="raw")throw new Oa(`${n.toString()} was not a UnixFS node`);return{Name:e,Tsize:i.node instanceof Uint8Array?i.node.byteLength:m$(i.node),Hash:n}}function m$(n){const e=n.Links.reduce((t,r)=>t+(r.Tsize??0),0);return dt(n).byteLength+e}const y$=Ut("helia:unixfs:components:utils:resolve");async function Ll(n,e,t,r){if(e==null||e==="")return{cid:n};const i=`/ipfs/${n}${e==null?"":`/${e}`}`,s=await wc(vS(i,t,r));if(s.length===0)throw new Zv("Could not find path in directory");return y$("resolved %s to %c",e,n),{cid:s[s.length-1].cid,path:e,segments:s}}async function lh(n,e,t,r){if(e.segments==null||e.segments.length===0)return n;let i=e.segments.pop();if(i==null)throw new Error("Insufficient segments");i.cid=n,e.segments.reverse();for(const s of e.segments){const[o,a]=await Promise.all([M1(s.cid,t,r),C3(i.cid,i.name,t,r)]);n=(await I3(o,a,t,{...r,allowOverwriting:!0,cidVersion:n.version})).cid,s.cid=n,i=s}return n}const w$=un.bind({ignoreUndefined:!0}),b$={};async function*v$(n,e,t={}){const r=w$(b$,t),i=await Ll(n,r.path,e,r),s=await os(i.cid,e,r);if(s.type!=="file"&&s.type!=="raw")throw new xU;if(s.content==null)throw new Jv;yield*s.content(r)}const Bl=262144,S$=un.bind({ignoreUndefined:!0}),E$=Ut("helia:unixfs:chmod"),x$={recursive:!1,shardSplitThresholdBytes:Bl};async function A$(n,e,t,r={}){const i=S$(x$,r),s=await Ll(n,i.path,t,r);if(E$("chmod %c %d",s.cid,e),i.recursive){const f=await _t(async function*(){for await(const p of SS(s.cid,t,r)){let m,w=[];if(p.type==="raw")m=new Se({type:"file",data:p.node});else if(p.type==="file"||p.type==="directory")m=p.unixfs,w=p.node.Links;else throw new Oa;m.mode=e;const b={Data:m.marshal(),Links:w};yield{path:p.path,content:b}}},p=>B1(p,t,{...i,dagBuilder:async function*(m,w){for await(const b of m)yield async function(){const S=b.content,k=dt(S),C=await Da(k,w,{...i,cidVersion:n.version});if(S.Data==null)throw new Qs(`${C} had no data`);const Q=Se.unmarshal(S.Data);return{cid:C,size:BigInt(k.length),path:b.path,unixfs:Q}}}}),async p=>Xs(p));if(f==null)throw new m3(`Could not chmod ${s.cid.toString()}`);return lh(f.cid,s,t,i)}const o=await t.get(s.cid,r);let a,c=[];if(s.cid.code===Bt)a=new Se({type:"file",data:o});else{const f=cr(o);if(f.Data==null)throw new Qs(`${s.cid.toString()} had no data`);c=f.Links,a=Se.unmarshal(f.Data)}a.mode=e;const u=dt({Data:a.marshal(),Links:c}),d=await ut.digest(u),h=le.create(s.cid.version,At,d);return await t.put(h,u),lh(h,s,t,i)}const k$=un.bind({ignoreUndefined:!0}),_$=Ut("helia:unixfs:cp"),I$={force:!1,shardSplitThresholdBytes:Bl};async function C$(n,e,t,r,i={}){const s=k$(I$,i);if(t.includes("/"))throw new rn("Name must not have slashes");const[o,a]=await Promise.all([M1(e,r,s),C3(n,t,r,s)]);return _$('Adding %c as "%s" to %c',n,t,e),(await I3(o,a,r,{allowOverwriting:s.force,cidVersion:e.version,...s})).cid}const T$=un.bind({ignoreUndefined:!0}),R$={};async function*P$(n,e,t={}){const r=T$(R$,t),i=await Ll(n,r.path,e,r),s=await os(i.cid,e,{...t,extended:!0});if(s.type==="file"||s.type==="raw"){t.extended===!1?yield{name:s.name,path:s.path,cid:s.cid}:yield s;return}if(s.content==null)throw new Jv;if(s.type!=="directory")throw new y3;yield*s.content(t)}const O$=un.bind({ignoreUndefined:!0}),N5=Ut("helia:unixfs:mkdir"),D$={cidVersion:1,force:!1,shardSplitThresholdBytes:Bl};async function N$(n,e,t,r={}){const i=O$(D$,r);if(e.includes("/"))throw new rn("Path must not have slashes");if((await os(n,t,r)).type!=="directory")throw new y3(`${n.toString()} was not a UnixFS directory`);N5("creating %s",e);const a={Data:new Se({type:"directory",mode:i.mode,mtime:i.mtime}).marshal(),Links:[]},c=dt(a),u=await ut.digest(c),d=le.create(i.cidVersion,At,u);await t.put(d,c);const[h,f]=await Promise.all([M1(n,t,i),C3(d,e,t,i)]);return N5("adding empty dir called %s to %c",e,n),(await I3(h,f,t,{...i,allowOverwriting:i.force})).cid}const Bu=Ut("helia:unixfs:utils:remove-link");async function L$(n,e,t,r){if(n.node.Data==null)throw new Qs("Parent node had no data");if(Se.unmarshal(n.node.Data).type==="hamt-sharded-directory"){Bu(`removing ${e} from sharded directory`);const s=await M$(n,e,t,r);return await IS(s.node,t,r.shardSplitThresholdBytes,r)?s:(Bu("converting shard to flat directory %c",n.cid),U$(s,t,r))}return Bu(`removing link ${e} regular directory`),B$(n,e,t,r)}const B$=async(n,e,t,r)=>{n.node.Links=n.node.Links.filter(o=>o.Name!==e);const i=dt(n.node),s=await Da(i,t,{...r,cidVersion:n.cid.version});return Bu(`Updated regular directory ${s}`),{node:n.node,cid:s}},M$=async(n,e,t,r)=>{const{path:i}=await _S(n.cid,e,t,r),s=i[i.length-1];if(s==null)throw new Error("Invalid HAMT, could not generate path");const o=s.node.Links.filter(u=>(u.Name??"").substring(2)===e).map(u=>u.Name).pop();if(o==null)throw new Error("File not found");const a=o.substring(0,2),c=parseInt(a,16);if(s.node.Links=s.node.Links.filter(u=>u.Name!==o),s.children.unset(c),s.node.Links.length===1)for(;i.length!==1;){const u=i[i.length-1];if(u==null||u.node.Links.length>1)break;i.pop();const d=i[i.length-1];if(d==null)break;const h=u.node.Links[0];d.node.Links=d.node.Links.filter(f=>!(f.Name??"").startsWith(d.prefix)),d.node.Links.push({Hash:h.Hash,Name:`${d.prefix}${(h.Name??"").substring(2)}`,Tsize:h.Tsize})}return kS(i,t,r)},U$=async(n,e,t)=>{if(n.node.Data==null)throw new rn("Invalid parent passed to convertToFlatDirectory");const r={Links:[]},i=await os(n.cid,e);if(i.type!=="directory")throw new Error("Unexpected node type");for await(const c of i.content()){let u=0;c.node instanceof Uint8Array?u=c.node.byteLength:u=dt(c.node).length,r.Links.push({Hash:c.cid,Name:c.name,Tsize:u})}const s=Se.unmarshal(n.node.Data);r.Data=new Se({type:"directory",mode:s.mode,mtime:s.mtime}).marshal();const o=dt(sn(r));return{cid:await Da(o,e,{codec:nl,cidVersion:n.cid.version,signal:t.signal}),node:r}},F$=un.bind({ignoreUndefined:!0}),$$=Ut("helia:unixfs:rm"),H$={shardSplitThresholdBytes:Bl};async function V$(n,e,t,r={}){const i=F$(H$,r);if(e.includes("/"))throw new rn("Name must not have slashes");const s=await M1(n,t,i);return $$("Removing %s from %c",e,n),(await L$(s,e,t,{...i,cidVersion:n.version})).cid}const TS=1877,U1=1604,z$=un.bind({ignoreUndefined:!0}),K$=Ut("helia:unixfs:stat"),q$={};async function W$(n,e,t={}){const r=z$(q$,t),i=await Ll(n,t.path,e,r);K$("stat %c",i.cid);const s=await os(i.cid,e,r);if(s.type==="raw")return t.extended===!0?Y$(s):Q$(s);if(s.type==="file"||s.type==="directory")return t.extended===!0?j$(s,e,t.filter??new J8({filterSize:1024}),t):G$(s);throw new Oa}function G$(n){return{type:n.type,cid:n.cid,unixfs:n.unixfs,mode:n.unixfs.mode??(n.unixfs.isDirectory()?TS:U1),mtime:n.unixfs.mtime,size:n.unixfs.fileSize()}}async function j$(n,e,t,r){const i=await RS(n.cid,e,!1,t,r);return{type:n.type,cid:n.cid,unixfs:n.unixfs,size:n.unixfs.isDirectory()?i.dirSize:n.unixfs.fileSize(),mode:n.unixfs.mode??(n.unixfs.isDirectory()?TS:U1),mtime:n.unixfs.mtime,localSize:i.localSize,dagSize:i.dagSize,deduplicatedDagSize:i.deduplicatedDagSize,blocks:i.blocks,uniqueBlocks:i.uniqueBlocks}}function Q$(n){return{type:n.type,cid:n.cid,unixfs:void 0,mode:U1,mtime:void 0,size:BigInt(n.node.byteLength)}}function Y$(n){return{type:n.type,cid:n.cid,unixfs:void 0,mode:U1,mtime:void 0,size:BigInt(n.node.byteLength),localSize:BigInt(n.node.byteLength),dagSize:BigInt(n.node.byteLength),deduplicatedDagSize:BigInt(n.node.byteLength),blocks:1n,uniqueBlocks:1n}}async function RS(n,e,t,r,i){const s={dirSize:0n,localSize:0n,dagSize:0n,deduplicatedDagSize:0n,blocks:0n,uniqueBlocks:0n};try{const o=r.has(n.bytes);r.add(n.bytes);const a=await e.get(n,i);if(s.blocks++,s.dagSize+=BigInt(a.byteLength),o||(s.uniqueBlocks++,s.deduplicatedDagSize+=BigInt(a.byteLength)),n.code===Bt)s.localSize+=BigInt(a.byteLength),t&&(s.dirSize+=BigInt(a.byteLength));else if(n.code===At){const c=cr(a);let u;if(c.Data!=null&&(u=Se.unmarshal(c.Data)),c.Links.length>0){for(const d of c.Links){const h=await RS(d.Hash,e,X$(d,u),r,i);s.localSize+=h.localSize,s.dagSize+=h.dagSize,s.deduplicatedDagSize+=h.deduplicatedDagSize,s.blocks+=h.blocks,s.uniqueBlocks+=h.uniqueBlocks,s.dirSize+=h.dirSize}t&&u!=null&&(s.dirSize+=u.fileSize())}else{if(u==null)throw new Qs(`PBNode ${n.toString()} had no data`);u.data!=null&&(s.localSize+=BigInt(u.data.byteLength??0)),t&&(s.dirSize+=u.fileSize())}}else throw new m3(`${n.toString()} was neither DAG_PB nor RAW`)}catch(o){if(o.name!=="NotFoundError"||i.offline!==!0)throw o}return s}function X$(n,e){if(e==null)return!1;const t=n.Name;return t==null?!1:e.type==="directory"?!0:e.type==="hamt-sharded-directory"&&t.length>2}const Z$=un.bind({ignoreUndefined:!0}),J$=Ut("helia:unixfs:touch"),eH={recursive:!1,shardSplitThresholdBytes:Bl};async function tH(n,e,t={}){const r=Z$(eH,t),i=await Ll(n,r.path,e,r),s=r.mtime??{secs:BigInt(Math.round(Date.now()/1e3)),nsecs:0};if(J$("touch %c %o",i.cid,s),r.recursive){const f=await _t(async function*(){for await(const p of SS(i.cid,e)){let m,w;if(p.type==="raw")m=new Se({data:p.node}),w=[];else if(p.type==="file"||p.type==="directory")m=p.unixfs,w=p.node.Links;else throw new Oa;m.mtime=s;const b={Data:m.marshal(),Links:w};yield{path:p.path,content:b}}},p=>B1(p,e,{...r,dagBuilder:async function*(m,w){for await(const b of m)yield async function(){const S=b.content,k=dt(S),C=await Da(k,w,{...r,cidVersion:n.version});if(S.Data==null)throw new Qs(`${C} had no data`);const Q=Se.unmarshal(S.Data);return{cid:C,size:BigInt(k.length),path:b.path,unixfs:Q}}}}),async p=>Xs(p));if(f==null)throw new m3(`Could not chmod ${i.cid.toString()}`);return lh(f.cid,i,e,r)}const o=await e.get(i.cid,t);let a,c=[];if(i.cid.code===Bt)a=new Se({data:o});else{const f=cr(o);if(c=f.Links,f.Data==null)throw new Qs(`${i.cid.toString()} had no data`);a=Se.unmarshal(f.Data)}a.mtime=s;const u=dt({Data:a.marshal(),Links:c}),d=await ut.digest(u),h=le.create(i.cid.version,At,d);return await e.put(h,u),lh(h,i,e,r)}class rH{constructor(e){l(this,"components");this.components=e}async*addAll(e,t={}){yield*S3(e,this.components.blockstore,t)}async addBytes(e,t={}){return LF(e,this.components.blockstore,t)}async addByteStream(e,t={}){return BF(e,this.components.blockstore,t)}async addFile(e,t={}){return MF(e,this.components.blockstore,t)}async addDirectory(e={},t={}){return UF(e,this.components.blockstore,t)}async*cat(e,t={}){yield*v$(e,this.components.blockstore,t)}async chmod(e,t,r={}){return A$(e,t,this.components.blockstore,r)}async cp(e,t,r,i={}){return C$(e,t,r,this.components.blockstore,i)}async*ls(e,t={}){yield*P$(e,this.components.blockstore,t)}async mkdir(e,t,r={}){return N$(e,t,this.components.blockstore,r)}async rm(e,t,r={}){return V$(e,t,this.components.blockstore,r)}async stat(e,t={}){return W$(e,this.components.blockstore,t)}async touch(e,t={}){return tH(e,this.components.blockstore,t)}}function nH(n){return new rH(n)}const xp={128:"",130:"",131:"",132:"",133:"",134:"",135:"",136:"",137:"",138:"",139:"",140:"",142:"",145:"",146:"",147:"",148:"",149:"",150:"",151:"",152:"",153:"",154:"",155:"",156:"",158:"",159:""};for(const[n,e]of Object.entries(xp));function iH(n,e="utf-8"){switch(e.toLowerCase()){case"utf-8":case"utf8":return typeof globalThis.TextDecoder<"u"?new globalThis.TextDecoder("utf-8").decode(n):sH(n);case"utf-16le":return oH(n);case"ascii":return aH(n);case"latin1":case"iso-8859-1":return cH(n);case"windows-1252":return lH(n);default:throw new RangeError(`Encoding '${e}' not supported`)}}function sH(n){let e="",t=0;for(;t<n.length;){const r=n[t++];if(r<128)e+=String.fromCharCode(r);else if(r<224){const i=n[t++]&63;e+=String.fromCharCode((r&31)<<6|i)}else if(r<240){const i=n[t++]&63,s=n[t++]&63;e+=String.fromCharCode((r&15)<<12|i<<6|s)}else{const i=n[t++]&63,s=n[t++]&63,o=n[t++]&63;let a=(r&7)<<18|i<<12|s<<6|o;a-=65536,e+=String.fromCharCode(55296+(a>>10&1023),56320+(a&1023))}}return e}function oH(n){let e="";for(let t=0;t<n.length;t+=2)e+=String.fromCharCode(n[t]|n[t+1]<<8);return e}function aH(n){return String.fromCharCode(...n.map(e=>e&127))}function cH(n){return String.fromCharCode(...n)}function lH(n){let e="";for(const t of n)t>=128&&t<=159&&xp[t]?e+=xp[t]:e+=String.fromCharCode(t);return e}function ar(n){return new DataView(n.buffer,n.byteOffset)}const uH={len:1,get(n,e){return ar(n).getUint8(e)},put(n,e,t){return ar(n).setUint8(e,t),e+1}},rt={len:2,get(n,e){return ar(n).getUint16(e,!0)},put(n,e,t){return ar(n).setUint16(e,t,!0),e+2}},za={len:2,get(n,e){return ar(n).getUint16(e)},put(n,e,t){return ar(n).setUint16(e,t),e+2}},wt={len:4,get(n,e){return ar(n).getUint32(e,!0)},put(n,e,t){return ar(n).setUint32(e,t,!0),e+4}},dH={len:4,get(n,e){return ar(n).getUint32(e)},put(n,e,t){return ar(n).setUint32(e,t),e+4}},hH={len:4,get(n,e){return ar(n).getInt32(e)},put(n,e,t){return ar(n).setInt32(e,t),e+4}},fH={len:8,get(n,e){return ar(n).getBigUint64(e,!0)},put(n,e,t){return ar(n).setBigUint64(e,t,!0),e+8}};class Un{constructor(e,t){this.len=e,this.encoding=t}get(e,t=0){const r=e.subarray(t,t+this.len);return iH(r,this.encoding)}}const pH="End-Of-Stream";class wr extends Error{constructor(){super(pH),this.name="EndOfStreamError"}}class gH extends Error{constructor(e="The operation was aborted"){super(e),this.name="AbortError"}}class PS{constructor(){this.endOfStream=!1,this.interrupted=!1,this.peekQueue=[]}async peek(e,t=!1){const r=await this.read(e,t);return this.peekQueue.push(e.subarray(0,r)),r}async read(e,t=!1){if(e.length===0)return 0;let r=this.readFromPeekBuffer(e);if(this.endOfStream||(r+=await this.readRemainderFromStream(e.subarray(r),t)),r===0&&!t)throw new wr;return r}readFromPeekBuffer(e){let t=e.length,r=0;for(;this.peekQueue.length>0&&t>0;){const i=this.peekQueue.pop();if(!i)throw new Error("peekData should be defined");const s=Math.min(i.length,t);e.set(i.subarray(0,s),r),r+=s,t-=s,s<i.length&&this.peekQueue.push(i.subarray(s))}return r}async readRemainderFromStream(e,t){let r=0;for(;r<e.length&&!this.endOfStream;){if(this.interrupted)throw new gH;const i=await this.readFromStream(e.subarray(r),t);if(i===0)break;r+=i}if(!t&&r<e.length)throw new wr;return r}}class mH extends PS{constructor(e){super(),this.reader=e}async abort(){return this.close()}async close(){this.reader.releaseLock()}}class yH extends mH{async readFromStream(e,t){if(e.length===0)return 0;const r=await this.reader.read(new Uint8Array(e.length),{min:t?void 0:e.length});return r.done&&(this.endOfStream=r.done),r.value?(e.set(r.value),r.value.length):0}}class L5 extends PS{constructor(e){super(),this.reader=e,this.buffer=null}writeChunk(e,t){const r=Math.min(t.length,e.length);return e.set(t.subarray(0,r)),r<t.length?this.buffer=t.subarray(r):this.buffer=null,r}async readFromStream(e,t){if(e.length===0)return 0;let r=0;for(this.buffer&&(r+=this.writeChunk(e,this.buffer));r<e.length&&!this.endOfStream;){const i=await this.reader.read();if(i.done){this.endOfStream=!0;break}i.value&&(r+=this.writeChunk(e.subarray(r),i.value))}if(!t&&r===0&&this.endOfStream)throw new wr;return r}abort(){return this.interrupted=!0,this.reader.cancel()}async close(){await this.abort(),this.reader.releaseLock()}}function wH(n){try{const e=n.getReader({mode:"byob"});return e instanceof ReadableStreamDefaultReader?new L5(e):new yH(e)}catch(e){if(e instanceof TypeError)return new L5(n.getReader());throw e}}class OS{constructor(e){this.numBuffer=new Uint8Array(8),this.position=0,this.onClose=e==null?void 0:e.onClose,e!=null&&e.abortSignal&&e.abortSignal.addEventListener("abort",()=>{this.abort()})}async readToken(e,t=this.position){const r=new Uint8Array(e.len);if(await this.readBuffer(r,{position:t})<e.len)throw new wr;return e.get(r,0)}async peekToken(e,t=this.position){const r=new Uint8Array(e.len);if(await this.peekBuffer(r,{position:t})<e.len)throw new wr;return e.get(r,0)}async readNumber(e){if(await this.readBuffer(this.numBuffer,{length:e.len})<e.len)throw new wr;return e.get(this.numBuffer,0)}async peekNumber(e){if(await this.peekBuffer(this.numBuffer,{length:e.len})<e.len)throw new wr;return e.get(this.numBuffer,0)}async ignore(e){if(this.fileInfo.size!==void 0){const t=this.fileInfo.size-this.position;if(e>t)return this.position+=t,t}return this.position+=e,e}async close(){var e;await this.abort(),await((e=this.onClose)==null?void 0:e.call(this))}normalizeOptions(e,t){if(!this.supportsRandomAccess()&&t&&t.position!==void 0&&t.position<this.position)throw new Error("`options.position` must be equal or greater than `tokenizer.position`");return{mayBeLess:!1,offset:0,length:e.length,position:this.position,...t}}abort(){return Promise.resolve()}}const bH=256e3;class vH extends OS{constructor(e,t){super(t),this.streamReader=e,this.fileInfo=(t==null?void 0:t.fileInfo)??{}}async readBuffer(e,t){const r=this.normalizeOptions(e,t),i=r.position-this.position;if(i>0)return await this.ignore(i),this.readBuffer(e,t);if(i<0)throw new Error("`options.position` must be equal or greater than `tokenizer.position`");if(r.length===0)return 0;const s=await this.streamReader.read(e.subarray(0,r.length),r.mayBeLess);if(this.position+=s,(!t||!t.mayBeLess)&&s<r.length)throw new wr;return s}async peekBuffer(e,t){const r=this.normalizeOptions(e,t);let i=0;if(r.position){const s=r.position-this.position;if(s>0){const o=new Uint8Array(r.length+s);return i=await this.peekBuffer(o,{mayBeLess:r.mayBeLess}),e.set(o.subarray(s)),i-s}if(s<0)throw new Error("Cannot peek from a negative offset in a stream")}if(r.length>0){try{i=await this.streamReader.peek(e.subarray(0,r.length),r.mayBeLess)}catch(s){if(t!=null&&t.mayBeLess&&s instanceof wr)return 0;throw s}if(!r.mayBeLess&&i<r.length)throw new wr}return i}async ignore(e){const t=Math.min(bH,e),r=new Uint8Array(t);let i=0;for(;i<e;){const s=e-i,o=await this.readBuffer(r,{length:Math.min(t,s)});if(o<0)return o;i+=o}return i}abort(){return this.streamReader.abort()}async close(){return this.streamReader.close()}supportsRandomAccess(){return!1}}class SH extends OS{constructor(e,t){super(t),this.uint8Array=e,this.fileInfo={...(t==null?void 0:t.fileInfo)??{},size:e.length}}async readBuffer(e,t){t!=null&&t.position&&(this.position=t.position);const r=await this.peekBuffer(e,t);return this.position+=r,r}async peekBuffer(e,t){const r=this.normalizeOptions(e,t),i=Math.min(this.uint8Array.length-r.position,r.length);if(!r.mayBeLess&&i<r.length)throw new wr;return e.set(this.uint8Array.subarray(r.position,r.position+i)),i}close(){return super.close()}supportsRandomAccess(){return!0}setPosition(e){this.position=e}}function EH(n,e){const t=wH(n),r=e??{},i=r.onClose;return r.onClose=async()=>{if(await t.close(),i)return i()},new vH(t,r)}function xH(n,e){return new SH(n,e)}var mr=Uint8Array,fo=Uint16Array,AH=Int32Array,DS=new mr([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),NS=new mr([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),kH=new mr([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),LS=function(n,e){for(var t=new fo(31),r=0;r<31;++r)t[r]=e+=1<<n[r-1];for(var i=new AH(t[30]),r=1;r<30;++r)for(var s=t[r];s<t[r+1];++s)i[s]=s-t[r]<<5|r;return{b:t,r:i}},BS=LS(DS,2),MS=BS.b,_H=BS.r;MS[28]=258,_H[258]=28;var IH=LS(NS,0),CH=IH.b,Ap=new fo(32768);for(var Ge=0;Ge<32768;++Ge){var _i=(Ge&43690)>>1|(Ge&21845)<<1;_i=(_i&52428)>>2|(_i&13107)<<2,_i=(_i&61680)>>4|(_i&3855)<<4,Ap[Ge]=((_i&65280)>>8|(_i&255)<<8)>>1}var mc=function(n,e,t){for(var r=n.length,i=0,s=new fo(e);i<r;++i)n[i]&&++s[n[i]-1];var o=new fo(e);for(i=1;i<e;++i)o[i]=o[i-1]+s[i-1]<<1;var a;if(t){a=new fo(1<<e);var c=15-e;for(i=0;i<r;++i)if(n[i])for(var u=i<<4|n[i],d=e-n[i],h=o[n[i]-1]++<<d,f=h|(1<<d)-1;h<=f;++h)a[Ap[h]>>c]=u}else for(a=new fo(r),i=0;i<r;++i)n[i]&&(a[i]=Ap[o[n[i]-1]++]>>15-n[i]);return a},Ml=new mr(288);for(var Ge=0;Ge<144;++Ge)Ml[Ge]=8;for(var Ge=144;Ge<256;++Ge)Ml[Ge]=9;for(var Ge=256;Ge<280;++Ge)Ml[Ge]=7;for(var Ge=280;Ge<288;++Ge)Ml[Ge]=8;var US=new mr(32);for(var Ge=0;Ge<32;++Ge)US[Ge]=5;var TH=mc(Ml,9,1),RH=mc(US,5,1),Df=function(n){for(var e=n[0],t=1;t<n.length;++t)n[t]>e&&(e=n[t]);return e},Kr=function(n,e,t){var r=e/8|0;return(n[r]|n[r+1]<<8)>>(e&7)&t},Nf=function(n,e){var t=e/8|0;return(n[t]|n[t+1]<<8|n[t+2]<<16)>>(e&7)},PH=function(n){return(n+7)/8|0},OH=function(n,e,t){return(t==null||t>n.length)&&(t=n.length),new mr(n.subarray(e,t))},DH=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],hr=function(n,e,t){var r=new Error(e||DH[n]);if(r.code=n,Error.captureStackTrace&&Error.captureStackTrace(r,hr),!t)throw r;return r},T3=function(n,e,t,r){var i=n.length,s=0;if(!i||e.f&&!e.l)return t||new mr(0);var o=!t,a=o||e.i!=2,c=e.i;o&&(t=new mr(i*3));var u=function(Na){var as=t.length;if(Na>as){var La=new mr(Math.max(as*2,Na));La.set(t),t=La}},d=e.f||0,h=e.p||0,f=e.b||0,p=e.l,m=e.d,w=e.m,b=e.n,S=i*8;do{if(!p){d=Kr(n,h,1);var k=Kr(n,h+1,3);if(h+=3,k)if(k==1)p=TH,m=RH,w=9,b=5;else if(k==2){var T=Kr(n,h,31)+257,Y=Kr(n,h+10,15)+4,se=T+Kr(n,h+5,31)+1;h+=14;for(var L=new mr(se),B=new mr(19),M=0;M<Y;++M)B[kH[M]]=Kr(n,h+M*3,7);h+=Y*3;for(var V=Df(B),K=(1<<V)-1,ie=mc(B,V,1),M=0;M<se;){var ae=ie[Kr(n,h,K)];h+=ae&15;var C=ae>>4;if(C<16)L[M++]=C;else{var J=0,oe=0;for(C==16?(oe=3+Kr(n,h,3),h+=2,J=L[M-1]):C==17?(oe=3+Kr(n,h,7),h+=3):C==18&&(oe=11+Kr(n,h,127),h+=7);oe--;)L[M++]=J}}var ge=L.subarray(0,T),z=L.subarray(T);w=Df(ge),b=Df(z),p=mc(ge,w,1),m=mc(z,b,1)}else hr(1);else{var C=PH(h)+4,Q=n[C-4]|n[C-3]<<8,re=C+Q;if(re>i){c&&hr(0);break}a&&u(f+Q),t.set(n.subarray(C,re),f),e.b=f+=Q,e.p=h=re*8,e.f=d;continue}if(h>S){c&&hr(0);break}}a&&u(f+131072);for(var _e=(1<<w)-1,Ve=(1<<b)-1,q=h;;q=h){var J=p[Nf(n,h)&_e],Ze=J>>4;if(h+=J&15,h>S){c&&hr(0);break}if(J||hr(2),Ze<256)t[f++]=Ze;else if(Ze==256){q=h,p=null;break}else{var Hr=Ze-254;if(Ze>264){var M=Ze-257,Ce=DS[M];Hr=Kr(n,h,(1<<Ce)-1)+MS[M],h+=Ce}var kr=m[Nf(n,h)&Ve],_r=kr>>4;kr||hr(3),h+=kr&15;var z=CH[_r];if(_r>3){var Ce=NS[_r];z+=Nf(n,h)&(1<<Ce)-1,h+=Ce}if(h>S){c&&hr(0);break}a&&u(f+131072);var Ir=f+Hr;if(f<z){var Vr=s-z,Cr=Math.min(z,Ir);for(Vr+f<0&&hr(3);f<Cr;++f)t[f]=r[Vr+f]}for(;f<Ir;++f)t[f]=t[f-z]}}e.l=p,e.p=q,e.b=f,e.f=d,p&&(d=1,e.m=w,e.d=m,e.n=b)}while(!d);return f!=t.length&&o?OH(t,0,f):t.subarray(0,f)},NH=new mr(0),LH=function(n){(n[0]!=31||n[1]!=139||n[2]!=8)&&hr(6,"invalid gzip data");var e=n[3],t=10;e&4&&(t+=(n[10]|n[11]<<8)+2);for(var r=(e>>3&1)+(e>>4&1);r>0;r-=!n[t++]);return t+(e&2)},BH=function(n){var e=n.length;return(n[e-4]|n[e-3]<<8|n[e-2]<<16|n[e-1]<<24)>>>0},MH=function(n,e){return((n[0]&15)!=8||n[0]>>4>7||(n[0]<<8|n[1])%31)&&hr(6,"invalid zlib data"),(n[1]>>5&1)==1&&hr(6,"invalid zlib data: "+(n[1]&32?"need":"unexpected")+" dictionary"),(n[1]>>3&4)+2};function UH(n,e){return T3(n,{i:2},e,e)}function FH(n,e){var t=LH(n);return t+8>n.length&&hr(6,"invalid gzip data"),T3(n.subarray(t,-8),{i:2},new mr(BH(n)),e)}function $H(n,e){return T3(n.subarray(MH(n),-4),{i:2},e,e)}function HH(n,e){return n[0]==31&&n[1]==139&&n[2]==8?FH(n,e):(n[0]&15)!=8||n[0]>>4>7||(n[0]<<8|n[1])%31?UH(n,e):$H(n,e)}var VH=typeof TextDecoder<"u"&&new TextDecoder,zH=0;try{VH.decode(NH,{stream:!0}),zH=1}catch{}const po={LocalFileHeader:67324752,DataDescriptor:134695760,CentralFileHeader:33639248,EndOfCentralDirectory:101010256},B5={get(n){return rt.get(n,6),{signature:wt.get(n,0),compressedSize:wt.get(n,8),uncompressedSize:wt.get(n,12)}},len:16},KH={get(n){const e=rt.get(n,6);return{signature:wt.get(n,0),minVersion:rt.get(n,4),dataDescriptor:!!(e&8),compressedMethod:rt.get(n,8),compressedSize:wt.get(n,18),uncompressedSize:wt.get(n,22),filenameLength:rt.get(n,26),extraFieldLength:rt.get(n,28),filename:null}},len:30},qH={get(n){return{signature:wt.get(n,0),nrOfThisDisk:rt.get(n,4),nrOfThisDiskWithTheStart:rt.get(n,6),nrOfEntriesOnThisDisk:rt.get(n,8),nrOfEntriesOfSize:rt.get(n,10),sizeOfCd:wt.get(n,12),offsetOfStartOfCd:wt.get(n,16),zipFileCommentLength:rt.get(n,20)}},len:22},WH={get(n){const e=rt.get(n,8);return{signature:wt.get(n,0),minVersion:rt.get(n,6),dataDescriptor:!!(e&8),compressedMethod:rt.get(n,10),compressedSize:wt.get(n,20),uncompressedSize:wt.get(n,24),filenameLength:rt.get(n,28),extraFieldLength:rt.get(n,30),fileCommentLength:rt.get(n,32),relativeOffsetOfLocalHeader:wt.get(n,42),filename:null}},len:46};function FS(n){const e=new Uint8Array(wt.len);return wt.put(e,0,n),e}const pn=ME("tokenizer:inflate"),Lf=256*1024,GH=FS(po.DataDescriptor),du=FS(po.EndOfCentralDirectory);class jH{constructor(e){this.tokenizer=e,this.syncBuffer=new Uint8Array(Lf)}async isZip(){return await this.peekSignature()===po.LocalFileHeader}peekSignature(){return this.tokenizer.peekToken(wt)}async findEndOfCentralDirectoryLocator(){const e=this.tokenizer,t=Math.min(16*1024,e.fileInfo.size),r=this.syncBuffer.subarray(0,t);await this.tokenizer.readBuffer(r,{position:e.fileInfo.size-t});for(let i=r.length-4;i>=0;i--)if(r[i]===du[0]&&r[i+1]===du[1]&&r[i+2]===du[2]&&r[i+3]===du[3])return e.fileInfo.size-t+i;return-1}async readCentralDirectory(){if(!this.tokenizer.supportsRandomAccess()){pn("Cannot reading central-directory without random-read support");return}pn("Reading central-directory...");const e=this.tokenizer.position,t=await this.findEndOfCentralDirectoryLocator();if(t>0){pn("Central-directory 32-bit signature found");const r=await this.tokenizer.readToken(qH,t),i=[];this.tokenizer.setPosition(r.offsetOfStartOfCd);for(let s=0;s<r.nrOfEntriesOfSize;++s){const o=await this.tokenizer.readToken(WH);if(o.signature!==po.CentralFileHeader)throw new Error("Expected Central-File-Header signature");o.filename=await this.tokenizer.readToken(new Un(o.filenameLength,"utf-8")),await this.tokenizer.ignore(o.extraFieldLength),await this.tokenizer.ignore(o.fileCommentLength),i.push(o),pn(`Add central-directory file-entry: n=${s+1}/${i.length}: filename=${i[s].filename}`)}return this.tokenizer.setPosition(e),i}this.tokenizer.setPosition(e)}async unzip(e){const t=await this.readCentralDirectory();if(t)return this.iterateOverCentralDirectory(t,e);let r=!1;do{const i=await this.readLocalFileHeader();if(!i)break;const s=e(i);r=!!s.stop;let o;if(await this.tokenizer.ignore(i.extraFieldLength),i.dataDescriptor&&i.compressedSize===0){const a=[];let c=Lf;pn("Compressed-file-size unknown, scanning for next data-descriptor-signature....");let u=-1;for(;u<0&&c===Lf;){c=await this.tokenizer.peekBuffer(this.syncBuffer,{mayBeLess:!0}),u=QH(this.syncBuffer.subarray(0,c),GH);const d=u>=0?u:c;if(s.handler){const h=new Uint8Array(d);await this.tokenizer.readBuffer(h),a.push(h)}else await this.tokenizer.ignore(d)}pn(`Found data-descriptor-signature at pos=${this.tokenizer.position}`),s.handler&&await this.inflate(i,YH(a),s.handler)}else s.handler?(pn(`Reading compressed-file-data: ${i.compressedSize} bytes`),o=new Uint8Array(i.compressedSize),await this.tokenizer.readBuffer(o),await this.inflate(i,o,s.handler)):(pn(`Ignoring compressed-file-data: ${i.compressedSize} bytes`),await this.tokenizer.ignore(i.compressedSize));if(pn(`Reading data-descriptor at pos=${this.tokenizer.position}`),i.dataDescriptor&&(await this.tokenizer.readToken(B5)).signature!==134695760)throw new Error(`Expected data-descriptor-signature at position ${this.tokenizer.position-B5.len}`)}while(!r)}async iterateOverCentralDirectory(e,t){for(const r of e){const i=t(r);if(i.handler){this.tokenizer.setPosition(r.relativeOffsetOfLocalHeader);const s=await this.readLocalFileHeader();if(s){await this.tokenizer.ignore(s.extraFieldLength);const o=new Uint8Array(r.compressedSize);await this.tokenizer.readBuffer(o),await this.inflate(s,o,i.handler)}}if(i.stop)break}}inflate(e,t,r){if(e.compressedMethod===0)return r(t);pn(`Decompress filename=${e.filename}, compressed-size=${t.length}`);const i=HH(t);return r(i)}async readLocalFileHeader(){const e=await this.tokenizer.peekToken(wt);if(e===po.LocalFileHeader){const t=await this.tokenizer.readToken(KH);return t.filename=await this.tokenizer.readToken(new Un(t.filenameLength,"utf-8")),t}if(e===po.CentralFileHeader)return!1;throw e===3759263696?new Error("Encrypted ZIP"):new Error("Unexpected signature")}}function QH(n,e){const t=n.length,r=e.length;if(r>t)return-1;for(let i=0;i<=t-r;i++){let s=!0;for(let o=0;o<r;o++)if(n[i+o]!==e[o]){s=!1;break}if(s)return i}return-1}function YH(n){const e=n.reduce((i,s)=>i+s.length,0),t=new Uint8Array(e);let r=0;for(const i of n)t.set(i,r),r+=i.length;return t}new globalThis.TextDecoder("utf8");new globalThis.TextEncoder;Array.from({length:256},(n,e)=>e.toString(16).padStart(2,"0"));function M5(n){const{byteLength:e}=n;if(e===6)return n.getUint16(0)*2**32+n.getUint32(2);if(e===5)return n.getUint8(0)*2**32+n.getUint32(1);if(e===4)return n.getUint32(0);if(e===3)return n.getUint8(0)*2**16+n.getUint16(1);if(e===2)return n.getUint16(0);if(e===1)return n.getUint8(0)}function XH(n,e){const t=n.length,r=e.length;if(r===0||r>t)return-1;const i=t-r;for(let s=0;s<=i;s++){let o=!0;for(let a=0;a<r;a++)if(n[s+a]!==e[a]){o=!1;break}if(o)return s}return-1}function ZH(n,e){return XH(n,e)!==-1}function JH(n){return[...n].map(e=>e.charCodeAt(0))}function eV(n,e=0){const t=Number.parseInt(new Un(6).get(n,148).replace(/\0.*$/,"").trim(),8);if(Number.isNaN(t))return!1;let r=8*32;for(let i=e;i<e+148;i++)r+=n[i];for(let i=e+156;i<e+512;i++)r+=n[i];return t===r}const tV={get:(n,e)=>n[e+3]&127|n[e+2]<<7|n[e+1]<<14|n[e]<<21,len:4},rV=["jpg","png","apng","gif","webp","flif","xcf","cr2","cr3","orf","arw","dng","nef","rw2","raf","tif","bmp","icns","jxr","psd","indd","zip","tar","rar","gz","bz2","7z","dmg","mp4","mid","mkv","webm","mov","avi","mpg","mp2","mp3","m4a","oga","ogg","ogv","opus","flac","wav","spx","amr","pdf","epub","elf","macho","exe","swf","rtf","wasm","woff","woff2","eot","ttf","otf","ttc","ico","flv","ps","xz","sqlite","nes","crx","xpi","cab","deb","ar","rpm","Z","lz","cfb","mxf","mts","blend","bpg","docx","pptx","xlsx","3gp","3g2","j2c","jp2","jpm","jpx","mj2","aif","qcp","odt","ods","odp","xml","mobi","heic","cur","ktx","ape","wv","dcm","ics","glb","pcap","dsf","lnk","alias","voc","ac3","m4v","m4p","m4b","f4v","f4p","f4b","f4a","mie","asf","ogm","ogx","mpc","arrow","shp","aac","mp1","it","s3m","xm","ai","skp","avif","eps","lzh","pgp","asar","stl","chm","3mf","zst","jxl","vcf","jls","pst","dwg","parquet","class","arj","cpio","ace","avro","icc","fbx","vsdx","vtt","apk","drc","lz4","potx","xltx","dotx","xltm","ott","ots","otp","odg","otg","xlsm","docm","dotm","potm","pptm","jar","rm","ppsm","ppsx"],nV=["image/jpeg","image/png","image/gif","image/webp","image/flif","image/x-xcf","image/x-canon-cr2","image/x-canon-cr3","image/tiff","image/bmp","image/vnd.ms-photo","image/vnd.adobe.photoshop","application/x-indesign","application/epub+zip","application/x-xpinstall","application/vnd.ms-powerpoint.slideshow.macroenabled.12","application/vnd.oasis.opendocument.text","application/vnd.oasis.opendocument.spreadsheet","application/vnd.oasis.opendocument.presentation","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.presentationml.presentation","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.openxmlformats-officedocument.presentationml.slideshow","application/zip","application/x-tar","application/x-rar-compressed","application/gzip","application/x-bzip2","application/x-7z-compressed","application/x-apple-diskimage","application/x-apache-arrow","video/mp4","audio/midi","video/x-matroska","video/webm","video/quicktime","video/vnd.avi","audio/wav","audio/qcelp","audio/x-ms-asf","video/x-ms-asf","application/vnd.ms-asf","video/mpeg","video/3gpp","audio/mpeg","audio/mp4","video/ogg","audio/ogg","audio/ogg; codecs=opus","application/ogg","audio/x-flac","audio/ape","audio/wavpack","audio/amr","application/pdf","application/x-elf","application/x-mach-binary","application/x-msdownload","application/x-shockwave-flash","application/rtf","application/wasm","font/woff","font/woff2","application/vnd.ms-fontobject","font/ttf","font/otf","font/collection","image/x-icon","video/x-flv","application/postscript","application/eps","application/x-xz","application/x-sqlite3","application/x-nintendo-nes-rom","application/x-google-chrome-extension","application/vnd.ms-cab-compressed","application/x-deb","application/x-unix-archive","application/x-rpm","application/x-compress","application/x-lzip","application/x-cfb","application/x-mie","application/mxf","video/mp2t","application/x-blender","image/bpg","image/j2c","image/jp2","image/jpx","image/jpm","image/mj2","audio/aiff","application/xml","application/x-mobipocket-ebook","image/heif","image/heif-sequence","image/heic","image/heic-sequence","image/icns","image/ktx","application/dicom","audio/x-musepack","text/calendar","text/vcard","text/vtt","model/gltf-binary","application/vnd.tcpdump.pcap","audio/x-dsf","application/x.ms.shortcut","application/x.apple.alias","audio/x-voc","audio/vnd.dolby.dd-raw","audio/x-m4a","image/apng","image/x-olympus-orf","image/x-sony-arw","image/x-adobe-dng","image/x-nikon-nef","image/x-panasonic-rw2","image/x-fujifilm-raf","video/x-m4v","video/3gpp2","application/x-esri-shape","audio/aac","audio/x-it","audio/x-s3m","audio/x-xm","video/MP1S","video/MP2P","application/vnd.sketchup.skp","image/avif","application/x-lzh-compressed","application/pgp-encrypted","application/x-asar","model/stl","application/vnd.ms-htmlhelp","model/3mf","image/jxl","application/zstd","image/jls","application/vnd.ms-outlook","image/vnd.dwg","application/x-parquet","application/java-vm","application/x-arj","application/x-cpio","application/x-ace-compressed","application/avro","application/vnd.iccprofile","application/x.autodesk.fbx","application/vnd.visio","application/vnd.android.package-archive","application/vnd.google.draco","application/x-lz4","application/vnd.openxmlformats-officedocument.presentationml.template","application/vnd.openxmlformats-officedocument.spreadsheetml.template","application/vnd.openxmlformats-officedocument.wordprocessingml.template","application/vnd.ms-excel.template.macroenabled.12","application/vnd.oasis.opendocument.text-template","application/vnd.oasis.opendocument.spreadsheet-template","application/vnd.oasis.opendocument.presentation-template","application/vnd.oasis.opendocument.graphics","application/vnd.oasis.opendocument.graphics-template","application/vnd.ms-excel.sheet.macroenabled.12","application/vnd.ms-word.document.macroenabled.12","application/vnd.ms-word.template.macroenabled.12","application/vnd.ms-powerpoint.template.macroenabled.12","application/vnd.ms-powerpoint.presentation.macroenabled.12","application/java-archive","application/vnd.rn-realmedia"],Bf=4100;async function iV(n){return new sV().fromBuffer(n)}function Mf(n){switch(n.toLowerCase()){case"application/epub+zip":return{ext:"epub",mime:"application/epub+zip"};case"application/vnd.oasis.opendocument.text":return{ext:"odt",mime:"application/vnd.oasis.opendocument.text"};case"application/vnd.oasis.opendocument.text-template":return{ext:"ott",mime:"application/vnd.oasis.opendocument.text-template"};case"application/vnd.oasis.opendocument.spreadsheet":return{ext:"ods",mime:"application/vnd.oasis.opendocument.spreadsheet"};case"application/vnd.oasis.opendocument.spreadsheet-template":return{ext:"ots",mime:"application/vnd.oasis.opendocument.spreadsheet-template"};case"application/vnd.oasis.opendocument.presentation":return{ext:"odp",mime:"application/vnd.oasis.opendocument.presentation"};case"application/vnd.oasis.opendocument.presentation-template":return{ext:"otp",mime:"application/vnd.oasis.opendocument.presentation-template"};case"application/vnd.oasis.opendocument.graphics":return{ext:"odg",mime:"application/vnd.oasis.opendocument.graphics"};case"application/vnd.oasis.opendocument.graphics-template":return{ext:"otg",mime:"application/vnd.oasis.opendocument.graphics-template"};case"application/vnd.openxmlformats-officedocument.presentationml.slideshow":return{ext:"ppsx",mime:"application/vnd.openxmlformats-officedocument.presentationml.slideshow"};case"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":return{ext:"xlsx",mime:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"};case"application/vnd.ms-excel.sheet.macroenabled":return{ext:"xlsm",mime:"application/vnd.ms-excel.sheet.macroenabled.12"};case"application/vnd.openxmlformats-officedocument.spreadsheetml.template":return{ext:"xltx",mime:"application/vnd.openxmlformats-officedocument.spreadsheetml.template"};case"application/vnd.ms-excel.template.macroenabled":return{ext:"xltm",mime:"application/vnd.ms-excel.template.macroenabled.12"};case"application/vnd.ms-powerpoint.slideshow.macroenabled":return{ext:"ppsm",mime:"application/vnd.ms-powerpoint.slideshow.macroenabled.12"};case"application/vnd.openxmlformats-officedocument.wordprocessingml.document":return{ext:"docx",mime:"application/vnd.openxmlformats-officedocument.wordprocessingml.document"};case"application/vnd.ms-word.document.macroenabled":return{ext:"docm",mime:"application/vnd.ms-word.document.macroenabled.12"};case"application/vnd.openxmlformats-officedocument.wordprocessingml.template":return{ext:"dotx",mime:"application/vnd.openxmlformats-officedocument.wordprocessingml.template"};case"application/vnd.ms-word.template.macroenabledtemplate":return{ext:"dotm",mime:"application/vnd.ms-word.template.macroenabled.12"};case"application/vnd.openxmlformats-officedocument.presentationml.template":return{ext:"potx",mime:"application/vnd.openxmlformats-officedocument.presentationml.template"};case"application/vnd.ms-powerpoint.template.macroenabled":return{ext:"potm",mime:"application/vnd.ms-powerpoint.template.macroenabled.12"};case"application/vnd.openxmlformats-officedocument.presentationml.presentation":return{ext:"pptx",mime:"application/vnd.openxmlformats-officedocument.presentationml.presentation"};case"application/vnd.ms-powerpoint.presentation.macroenabled":return{ext:"pptm",mime:"application/vnd.ms-powerpoint.presentation.macroenabled.12"};case"application/vnd.ms-visio.drawing":return{ext:"vsdx",mime:"application/vnd.visio"};case"application/vnd.ms-package.3dmanufacturing-3dmodel+xml":return{ext:"3mf",mime:"model/3mf"}}}function gn(n,e,t){t={offset:0,...t};for(const[r,i]of e.entries())if(t.mask){if(i!==(t.mask[r]&n[r+t.offset]))return!1}else if(i!==n[r+t.offset])return!1;return!0}class sV{constructor(e){l(this,"detectConfident",async e=>{if(this.buffer=new Uint8Array(Bf),e.fileInfo.size===void 0&&(e.fileInfo.size=Number.MAX_SAFE_INTEGER),this.tokenizer=e,await e.peekBuffer(this.buffer,{length:12,mayBeLess:!0}),this.check([66,77]))return{ext:"bmp",mime:"image/bmp"};if(this.check([11,119]))return{ext:"ac3",mime:"audio/vnd.dolby.dd-raw"};if(this.check([120,1]))return{ext:"dmg",mime:"application/x-apple-diskimage"};if(this.check([77,90]))return{ext:"exe",mime:"application/x-msdownload"};if(this.check([37,33]))return await e.peekBuffer(this.buffer,{length:24,mayBeLess:!0}),this.checkString("PS-Adobe-",{offset:2})&&this.checkString(" EPSF-",{offset:14})?{ext:"eps",mime:"application/eps"}:{ext:"ps",mime:"application/postscript"};if(this.check([31,160])||this.check([31,157]))return{ext:"Z",mime:"application/x-compress"};if(this.check([199,113]))return{ext:"cpio",mime:"application/x-cpio"};if(this.check([96,234]))return{ext:"arj",mime:"application/x-arj"};if(this.check([239,187,191]))return this.tokenizer.ignore(3),this.detectConfident(e);if(this.check([71,73,70]))return{ext:"gif",mime:"image/gif"};if(this.check([73,73,188]))return{ext:"jxr",mime:"image/vnd.ms-photo"};if(this.check([31,139,8]))return{ext:"gz",mime:"application/gzip"};if(this.check([66,90,104]))return{ext:"bz2",mime:"application/x-bzip2"};if(this.checkString("ID3")){await e.ignore(6);const t=await e.readToken(tV);return e.position+t>e.fileInfo.size?{ext:"mp3",mime:"audio/mpeg"}:(await e.ignore(t),this.fromTokenizer(e))}if(this.checkString("MP+"))return{ext:"mpc",mime:"audio/x-musepack"};if((this.buffer[0]===67||this.buffer[0]===70)&&this.check([87,83],{offset:1}))return{ext:"swf",mime:"application/x-shockwave-flash"};if(this.check([255,216,255]))return this.check([247],{offset:3})?{ext:"jls",mime:"image/jls"}:{ext:"jpg",mime:"image/jpeg"};if(this.check([79,98,106,1]))return{ext:"avro",mime:"application/avro"};if(this.checkString("FLIF"))return{ext:"flif",mime:"image/flif"};if(this.checkString("8BPS"))return{ext:"psd",mime:"image/vnd.adobe.photoshop"};if(this.checkString("MPCK"))return{ext:"mpc",mime:"audio/x-musepack"};if(this.checkString("FORM"))return{ext:"aif",mime:"audio/aiff"};if(this.checkString("icns",{offset:0}))return{ext:"icns",mime:"image/icns"};if(this.check([80,75,3,4])){let t;return await new jH(e).unzip(r=>{switch(r.filename){case"META-INF/mozilla.rsa":return t={ext:"xpi",mime:"application/x-xpinstall"},{stop:!0};case"META-INF/MANIFEST.MF":return t={ext:"jar",mime:"application/java-archive"},{stop:!0};case"mimetype":return{async handler(i){const s=new TextDecoder("utf-8").decode(i).trim();t=Mf(s)},stop:!0};case"[Content_Types].xml":return{async handler(i){let s=new TextDecoder("utf-8").decode(i);const o=s.indexOf('.main+xml"');if(o===-1){const a="application/vnd.ms-package.3dmanufacturing-3dmodel+xml";s.includes(`ContentType="${a}"`)&&(t=Mf(a))}else{s=s.slice(0,Math.max(0,o));const a=s.lastIndexOf('"'),c=s.slice(Math.max(0,a+1));t=Mf(c)}},stop:!0};default:return/classes\d*\.dex/.test(r.filename)?(t={ext:"apk",mime:"application/vnd.android.package-archive"},{stop:!0}):{}}}),t??{ext:"zip",mime:"application/zip"}}if(this.checkString("OggS")){await e.ignore(28);const t=new Uint8Array(8);return await e.readBuffer(t),gn(t,[79,112,117,115,72,101,97,100])?{ext:"opus",mime:"audio/ogg; codecs=opus"}:gn(t,[128,116,104,101,111,114,97])?{ext:"ogv",mime:"video/ogg"}:gn(t,[1,118,105,100,101,111,0])?{ext:"ogm",mime:"video/ogg"}:gn(t,[127,70,76,65,67])?{ext:"oga",mime:"audio/ogg"}:gn(t,[83,112,101,101,120,32,32])?{ext:"spx",mime:"audio/ogg"}:gn(t,[1,118,111,114,98,105,115])?{ext:"ogg",mime:"audio/ogg"}:{ext:"ogx",mime:"application/ogg"}}if(this.check([80,75])&&(this.buffer[2]===3||this.buffer[2]===5||this.buffer[2]===7)&&(this.buffer[3]===4||this.buffer[3]===6||this.buffer[3]===8))return{ext:"zip",mime:"application/zip"};if(this.checkString("MThd"))return{ext:"mid",mime:"audio/midi"};if(this.checkString("wOFF")&&(this.check([0,1,0,0],{offset:4})||this.checkString("OTTO",{offset:4})))return{ext:"woff",mime:"font/woff"};if(this.checkString("wOF2")&&(this.check([0,1,0,0],{offset:4})||this.checkString("OTTO",{offset:4})))return{ext:"woff2",mime:"font/woff2"};if(this.check([212,195,178,161])||this.check([161,178,195,212]))return{ext:"pcap",mime:"application/vnd.tcpdump.pcap"};if(this.checkString("DSD "))return{ext:"dsf",mime:"audio/x-dsf"};if(this.checkString("LZIP"))return{ext:"lz",mime:"application/x-lzip"};if(this.checkString("fLaC"))return{ext:"flac",mime:"audio/x-flac"};if(this.check([66,80,71,251]))return{ext:"bpg",mime:"image/bpg"};if(this.checkString("wvpk"))return{ext:"wv",mime:"audio/wavpack"};if(this.checkString("%PDF")){try{if(await e.ignore(1350)===1350){const i=new Uint8Array(Math.min(10485760,e.fileInfo.size-1350));if(await e.readBuffer(i,{mayBeLess:!0}),ZH(i,new TextEncoder().encode("AIPrivateData")))return{ext:"ai",mime:"application/postscript"}}}catch(t){if(!(t instanceof wr))throw t}return{ext:"pdf",mime:"application/pdf"}}if(this.check([0,97,115,109]))return{ext:"wasm",mime:"application/wasm"};if(this.check([73,73])){const t=await this.readTiffHeader(!1);if(t)return t}if(this.check([77,77])){const t=await this.readTiffHeader(!0);if(t)return t}if(this.checkString("MAC "))return{ext:"ape",mime:"audio/ape"};if(this.check([26,69,223,163])){async function t(){const a=await e.peekNumber(uH);let c=128,u=0;for(;!(a&c)&&c!==0;)++u,c>>=1;const d=new Uint8Array(u+1);return await e.readBuffer(d),d}async function r(){const a=await t(),c=await t();c[0]^=128>>c.length-1;const u=Math.min(6,c.length),d=new DataView(a.buffer),h=new DataView(c.buffer,c.length-u,u);return{id:M5(d),len:M5(h)}}async function i(a){for(;a>0;){const c=await r();if(c.id===17026)return(await e.readToken(new Un(c.len))).replaceAll(/\00.*$/g,"");await e.ignore(c.len),--a}}const s=await r();switch(await i(s.len)){case"webm":return{ext:"webm",mime:"video/webm"};case"matroska":return{ext:"mkv",mime:"video/x-matroska"};default:return}}if(this.checkString("SQLi"))return{ext:"sqlite",mime:"application/x-sqlite3"};if(this.check([78,69,83,26]))return{ext:"nes",mime:"application/x-nintendo-nes-rom"};if(this.checkString("Cr24"))return{ext:"crx",mime:"application/x-google-chrome-extension"};if(this.checkString("MSCF")||this.checkString("ISc("))return{ext:"cab",mime:"application/vnd.ms-cab-compressed"};if(this.check([237,171,238,219]))return{ext:"rpm",mime:"application/x-rpm"};if(this.check([197,208,211,198]))return{ext:"eps",mime:"application/eps"};if(this.check([40,181,47,253]))return{ext:"zst",mime:"application/zstd"};if(this.check([127,69,76,70]))return{ext:"elf",mime:"application/x-elf"};if(this.check([33,66,68,78]))return{ext:"pst",mime:"application/vnd.ms-outlook"};if(this.checkString("PAR1"))return{ext:"parquet",mime:"application/x-parquet"};if(this.checkString("ttcf"))return{ext:"ttc",mime:"font/collection"};if(this.check([207,250,237,254]))return{ext:"macho",mime:"application/x-mach-binary"};if(this.check([4,34,77,24]))return{ext:"lz4",mime:"application/x-lz4"};if(this.check([79,84,84,79,0]))return{ext:"otf",mime:"font/otf"};if(this.checkString("#!AMR"))return{ext:"amr",mime:"audio/amr"};if(this.checkString("{\\rtf"))return{ext:"rtf",mime:"application/rtf"};if(this.check([70,76,86,1]))return{ext:"flv",mime:"video/x-flv"};if(this.checkString("IMPM"))return{ext:"it",mime:"audio/x-it"};if(this.checkString("-lh0-",{offset:2})||this.checkString("-lh1-",{offset:2})||this.checkString("-lh2-",{offset:2})||this.checkString("-lh3-",{offset:2})||this.checkString("-lh4-",{offset:2})||this.checkString("-lh5-",{offset:2})||this.checkString("-lh6-",{offset:2})||this.checkString("-lh7-",{offset:2})||this.checkString("-lzs-",{offset:2})||this.checkString("-lz4-",{offset:2})||this.checkString("-lz5-",{offset:2})||this.checkString("-lhd-",{offset:2}))return{ext:"lzh",mime:"application/x-lzh-compressed"};if(this.check([0,0,1,186])){if(this.check([33],{offset:4,mask:[241]}))return{ext:"mpg",mime:"video/MP1S"};if(this.check([68],{offset:4,mask:[196]}))return{ext:"mpg",mime:"video/MP2P"}}if(this.checkString("ITSF"))return{ext:"chm",mime:"application/vnd.ms-htmlhelp"};if(this.check([202,254,186,190]))return{ext:"class",mime:"application/java-vm"};if(this.checkString(".RMF"))return{ext:"rm",mime:"application/vnd.rn-realmedia"};if(this.checkString("DRACO"))return{ext:"drc",mime:"application/vnd.google.draco"};if(this.check([253,55,122,88,90,0]))return{ext:"xz",mime:"application/x-xz"};if(this.checkString("<?xml "))return{ext:"xml",mime:"application/xml"};if(this.check([55,122,188,175,39,28]))return{ext:"7z",mime:"application/x-7z-compressed"};if(this.check([82,97,114,33,26,7])&&(this.buffer[6]===0||this.buffer[6]===1))return{ext:"rar",mime:"application/x-rar-compressed"};if(this.checkString("solid "))return{ext:"stl",mime:"model/stl"};if(this.checkString("AC")){const t=new Un(4,"latin1").get(this.buffer,2);if(t.match("^d*")&&t>=1e3&&t<=1050)return{ext:"dwg",mime:"image/vnd.dwg"}}if(this.checkString("070707"))return{ext:"cpio",mime:"application/x-cpio"};if(this.checkString("BLENDER"))return{ext:"blend",mime:"application/x-blender"};if(this.checkString("!<arch>"))return await e.ignore(8),await e.readToken(new Un(13,"ascii"))==="debian-binary"?{ext:"deb",mime:"application/x-deb"}:{ext:"ar",mime:"application/x-unix-archive"};if(this.checkString("WEBVTT")&&[`
`,"\r","	"," ","\0"].some(t=>this.checkString(t,{offset:6})))return{ext:"vtt",mime:"text/vtt"};if(this.check([137,80,78,71,13,10,26,10])){await e.ignore(8);async function t(){return{length:await e.readToken(hH),type:await e.readToken(new Un(4,"latin1"))}}do{const r=await t();if(r.length<0)return;switch(r.type){case"IDAT":return{ext:"png",mime:"image/png"};case"acTL":return{ext:"apng",mime:"image/apng"};default:await e.ignore(r.length+4)}}while(e.position+8<e.fileInfo.size);return{ext:"png",mime:"image/png"}}if(this.check([65,82,82,79,87,49,0,0]))return{ext:"arrow",mime:"application/x-apache-arrow"};if(this.check([103,108,84,70,2,0,0,0]))return{ext:"glb",mime:"model/gltf-binary"};if(this.check([102,114,101,101],{offset:4})||this.check([109,100,97,116],{offset:4})||this.check([109,111,111,118],{offset:4})||this.check([119,105,100,101],{offset:4}))return{ext:"mov",mime:"video/quicktime"};if(this.check([73,73,82,79,8,0,0,0,24]))return{ext:"orf",mime:"image/x-olympus-orf"};if(this.checkString("gimp xcf "))return{ext:"xcf",mime:"image/x-xcf"};if(this.checkString("ftyp",{offset:4})&&this.buffer[8]&96){const t=new Un(4,"latin1").get(this.buffer,8).replace("\0"," ").trim();switch(t){case"avif":case"avis":return{ext:"avif",mime:"image/avif"};case"mif1":return{ext:"heic",mime:"image/heif"};case"msf1":return{ext:"heic",mime:"image/heif-sequence"};case"heic":case"heix":return{ext:"heic",mime:"image/heic"};case"hevc":case"hevx":return{ext:"heic",mime:"image/heic-sequence"};case"qt":return{ext:"mov",mime:"video/quicktime"};case"M4V":case"M4VH":case"M4VP":return{ext:"m4v",mime:"video/x-m4v"};case"M4P":return{ext:"m4p",mime:"video/mp4"};case"M4B":return{ext:"m4b",mime:"audio/mp4"};case"M4A":return{ext:"m4a",mime:"audio/x-m4a"};case"F4V":return{ext:"f4v",mime:"video/mp4"};case"F4P":return{ext:"f4p",mime:"video/mp4"};case"F4A":return{ext:"f4a",mime:"audio/mp4"};case"F4B":return{ext:"f4b",mime:"audio/mp4"};case"crx":return{ext:"cr3",mime:"image/x-canon-cr3"};default:return t.startsWith("3g")?t.startsWith("3g2")?{ext:"3g2",mime:"video/3gpp2"}:{ext:"3gp",mime:"video/3gpp"}:{ext:"mp4",mime:"video/mp4"}}}if(this.check([82,73,70,70])){if(this.checkString("WEBP",{offset:8}))return{ext:"webp",mime:"image/webp"};if(this.check([65,86,73],{offset:8}))return{ext:"avi",mime:"video/vnd.avi"};if(this.check([87,65,86,69],{offset:8}))return{ext:"wav",mime:"audio/wav"};if(this.check([81,76,67,77],{offset:8}))return{ext:"qcp",mime:"audio/qcelp"}}if(this.check([73,73,85,0,24,0,0,0,136,231,116,216]))return{ext:"rw2",mime:"image/x-panasonic-rw2"};if(this.check([48,38,178,117,142,102,207,17,166,217])){async function t(){const r=new Uint8Array(16);return await e.readBuffer(r),{id:r,size:Number(await e.readToken(fH))}}for(await e.ignore(30);e.position+24<e.fileInfo.size;){const r=await t();let i=r.size-24;if(gn(r.id,[145,7,220,183,183,169,207,17,142,230,0,192,12,32,83,101])){const s=new Uint8Array(16);if(i-=await e.readBuffer(s),gn(s,[64,158,105,248,77,91,207,17,168,253,0,128,95,92,68,43]))return{ext:"asf",mime:"audio/x-ms-asf"};if(gn(s,[192,239,25,188,77,91,207,17,168,253,0,128,95,92,68,43]))return{ext:"asf",mime:"video/x-ms-asf"};break}await e.ignore(i)}return{ext:"asf",mime:"application/vnd.ms-asf"}}if(this.check([171,75,84,88,32,49,49,187,13,10,26,10]))return{ext:"ktx",mime:"image/ktx"};if((this.check([126,16,4])||this.check([126,24,4]))&&this.check([48,77,73,69],{offset:4}))return{ext:"mie",mime:"application/x-mie"};if(this.check([39,10,0,0,0,0,0,0,0,0,0,0],{offset:2}))return{ext:"shp",mime:"application/x-esri-shape"};if(this.check([255,79,255,81]))return{ext:"j2c",mime:"image/j2c"};if(this.check([0,0,0,12,106,80,32,32,13,10,135,10]))switch(await e.ignore(20),await e.readToken(new Un(4,"ascii"))){case"jp2 ":return{ext:"jp2",mime:"image/jp2"};case"jpx ":return{ext:"jpx",mime:"image/jpx"};case"jpm ":return{ext:"jpm",mime:"image/jpm"};case"mjp2":return{ext:"mj2",mime:"image/mj2"};default:return}if(this.check([255,10])||this.check([0,0,0,12,74,88,76,32,13,10,135,10]))return{ext:"jxl",mime:"image/jxl"};if(this.check([254,255]))return this.check([0,60,0,63,0,120,0,109,0,108],{offset:2})?{ext:"xml",mime:"application/xml"}:void 0;if(this.check([208,207,17,224,161,177,26,225]))return{ext:"cfb",mime:"application/x-cfb"};if(await e.peekBuffer(this.buffer,{length:Math.min(256,e.fileInfo.size),mayBeLess:!0}),this.check([97,99,115,112],{offset:36}))return{ext:"icc",mime:"application/vnd.iccprofile"};if(this.checkString("**ACE",{offset:7})&&this.checkString("**",{offset:12}))return{ext:"ace",mime:"application/x-ace-compressed"};if(this.checkString("BEGIN:")){if(this.checkString("VCARD",{offset:6}))return{ext:"vcf",mime:"text/vcard"};if(this.checkString("VCALENDAR",{offset:6}))return{ext:"ics",mime:"text/calendar"}}if(this.checkString("FUJIFILMCCD-RAW"))return{ext:"raf",mime:"image/x-fujifilm-raf"};if(this.checkString("Extended Module:"))return{ext:"xm",mime:"audio/x-xm"};if(this.checkString("Creative Voice File"))return{ext:"voc",mime:"audio/x-voc"};if(this.check([4,0,0,0])&&this.buffer.length>=16){const t=new DataView(this.buffer.buffer).getUint32(12,!0);if(t>12&&this.buffer.length>=t+16)try{const r=new TextDecoder().decode(this.buffer.slice(16,t+16));if(JSON.parse(r).files)return{ext:"asar",mime:"application/x-asar"}}catch{}}if(this.check([6,14,43,52,2,5,1,1,13,1,2,1,1,2]))return{ext:"mxf",mime:"application/mxf"};if(this.checkString("SCRM",{offset:44}))return{ext:"s3m",mime:"audio/x-s3m"};if(this.check([71])&&this.check([71],{offset:188}))return{ext:"mts",mime:"video/mp2t"};if(this.check([71],{offset:4})&&this.check([71],{offset:196}))return{ext:"mts",mime:"video/mp2t"};if(this.check([66,79,79,75,77,79,66,73],{offset:60}))return{ext:"mobi",mime:"application/x-mobipocket-ebook"};if(this.check([68,73,67,77],{offset:128}))return{ext:"dcm",mime:"application/dicom"};if(this.check([76,0,0,0,1,20,2,0,0,0,0,0,192,0,0,0,0,0,0,70]))return{ext:"lnk",mime:"application/x.ms.shortcut"};if(this.check([98,111,111,107,0,0,0,0,109,97,114,107,0,0,0,0]))return{ext:"alias",mime:"application/x.apple.alias"};if(this.checkString("Kaydara FBX Binary  \0"))return{ext:"fbx",mime:"application/x.autodesk.fbx"};if(this.check([76,80],{offset:34})&&(this.check([0,0,1],{offset:8})||this.check([1,0,2],{offset:8})||this.check([2,0,2],{offset:8})))return{ext:"eot",mime:"application/vnd.ms-fontobject"};if(this.check([6,6,237,245,216,29,70,229,189,49,239,231,254,116,183,29]))return{ext:"indd",mime:"application/x-indesign"};if(await e.peekBuffer(this.buffer,{length:Math.min(512,e.fileInfo.size),mayBeLess:!0}),eV(this.buffer))return{ext:"tar",mime:"application/x-tar"};if(this.check([255,254]))return this.check([60,0,63,0,120,0,109,0,108,0],{offset:2})?{ext:"xml",mime:"application/xml"}:this.check([255,14,83,0,107,0,101,0,116,0,99,0,104,0,85,0,112,0,32,0,77,0,111,0,100,0,101,0,108,0],{offset:2})?{ext:"skp",mime:"application/vnd.sketchup.skp"}:void 0;if(this.checkString("-----BEGIN PGP MESSAGE-----"))return{ext:"pgp",mime:"application/pgp-encrypted"}});l(this,"detectImprecise",async e=>{if(this.buffer=new Uint8Array(Bf),await e.peekBuffer(this.buffer,{length:Math.min(8,e.fileInfo.size),mayBeLess:!0}),this.check([0,0,1,186])||this.check([0,0,1,179]))return{ext:"mpg",mime:"video/mpeg"};if(this.check([0,1,0,0,0]))return{ext:"ttf",mime:"font/ttf"};if(this.check([0,0,1,0]))return{ext:"ico",mime:"image/x-icon"};if(this.check([0,0,2,0]))return{ext:"cur",mime:"image/x-icon"};if(this.buffer.length>=2&&this.check([255,224],{offset:0,mask:[255,224]})){if(this.check([16],{offset:1,mask:[22]}))return this.check([8],{offset:1,mask:[8]})?{ext:"aac",mime:"audio/aac"}:{ext:"aac",mime:"audio/aac"};if(this.check([2],{offset:1,mask:[6]}))return{ext:"mp3",mime:"audio/mpeg"};if(this.check([4],{offset:1,mask:[6]}))return{ext:"mp2",mime:"audio/mpeg"};if(this.check([6],{offset:1,mask:[6]}))return{ext:"mp1",mime:"audio/mpeg"}}});this.detectors=[...(e==null?void 0:e.customDetectors)??[],{id:"core",detect:this.detectConfident},{id:"core.imprecise",detect:this.detectImprecise}],this.tokenizerOptions={abortSignal:e==null?void 0:e.signal}}async fromTokenizer(e){const t=e.position;for(const r of this.detectors){const i=await r.detect(e);if(i)return i;if(t!==e.position)return}}async fromBuffer(e){if(!(e instanceof Uint8Array||e instanceof ArrayBuffer))throw new TypeError(`Expected the \`input\` argument to be of type \`Uint8Array\` or \`ArrayBuffer\`, got \`${typeof e}\``);const t=e instanceof Uint8Array?e:new Uint8Array(e);if((t==null?void 0:t.length)>1)return this.fromTokenizer(xH(t,this.tokenizerOptions))}async fromBlob(e){return this.fromStream(e.stream())}async fromStream(e){const t=await EH(e,this.tokenizerOptions);try{return await this.fromTokenizer(t)}finally{await t.close()}}async toDetectionStream(e,t){const{sampleSize:r=Bf}=t;let i,s;const o=e.getReader({mode:"byob"});try{const{value:u,done:d}=await o.read(new Uint8Array(r));if(s=u,!d&&u)try{i=await this.fromBuffer(u.slice(0,r))}catch(h){if(!(h instanceof wr))throw h;i=void 0}s=u}finally{o.releaseLock()}const a=new TransformStream({async start(u){u.enqueue(s)},transform(u,d){d.enqueue(u)}}),c=e.pipeThrough(a);return c.fileType=i,c}check(e,t){return gn(this.buffer,e,t)}checkString(e,t){return this.check(JH(e),t)}async readTiffTag(e){const t=await this.tokenizer.readToken(e?za:rt);switch(this.tokenizer.ignore(10),t){case 50341:return{ext:"arw",mime:"image/x-sony-arw"};case 50706:return{ext:"dng",mime:"image/x-adobe-dng"}}}async readTiffIFD(e){const t=await this.tokenizer.readToken(e?za:rt);for(let r=0;r<t;++r){const i=await this.readTiffTag(e);if(i)return i}}async readTiffHeader(e){const t=(e?za:rt).get(this.buffer,2),r=(e?dH:wt).get(this.buffer,4);if(t===42){if(r>=6){if(this.checkString("CR",{offset:8}))return{ext:"cr2",mime:"image/x-canon-cr2"};if(r>=8){const s=(e?za:rt).get(this.buffer,8),o=(e?za:rt).get(this.buffer,10);if(s===28&&o===254||s===31&&o===11)return{ext:"nef",mime:"image/x-nikon-nef"}}}return await this.tokenizer.ignore(r),await this.readTiffIFD(e)??{ext:"tif",mime:"image/tiff"}}if(t===43)return{ext:"tif",mime:"image/tiff"}}}new Set(rV);new Set(nV);const qi=Ut("helia:verified-fetch:content-type-parser"),kp="application/octet-stream";function oV(n){return qi("checking for svg"),/^(<\?xml[^>]+>)?[^<^\w]+<svg/ig.test(n)}async function aV(n){qi("checking for json");try{return JSON.parse(n),!0}catch(e){return qi("failed to parse as json",e),!1}}function cV(n){qi("checking for text");const e=new TextDecoder("utf-8",{fatal:!0});try{return e.decode(n)}catch{return null}}async function lV(n){return qi("checking for html"),/^\s*<(?:!doctype\s+html|html|head|body)\b/i.test(n)}async function uV(n,e){var r;qi("contentTypeParser called for fileName: %s, byte size=%s",e,n.length);const t=(r=await iV(n))==null?void 0:r.mime;if(t!=null)return qi("detectedType: %s",t),t;if(qi("no detectedType"),e==null){const i=cV(n);return i!=null?oV(i)?"image/svg+xml":await aV(i)?"application/json":await lV(i)?"text/html; charset=utf-8":"text/plain; charset=utf-8":kp}switch(e.split(".").pop()){case"css":return"text/css";case"html":return"text/html; charset=utf-8";case"js":return"application/javascript";case"json":return"application/json";case"txt":return"text/plain";case"woff2":return"font/woff2";case"svg":return"image/svg+xml";case"csv":return"text/csv";case"doc":return"application/msword";case"xls":return"application/vnd.ms-excel";case"ppt":return"application/vnd.ms-powerpoint";case"msi":return"application/x-msdownload";default:return kp}}function dV(n){return(n==null?void 0:n.then)!=null}async function _p({bytes:n,path:e,contentTypeParser:t,log:r,defaultContentType:i="application/octet-stream",filename:s}){var a;let o;if(t!=null)try{let c;s==null?(c=(a=e.split("/").pop())==null?void 0:a.trim(),c=c===""||(c==null?void 0:c.split(".").length)===1?void 0:c):c=s;const u=t(n,c);if(dV(u)){const d=await u;d!=null&&(o=d)}else u!=null&&(o=u);r.trace("contentTypeParser returned %s",o)}catch(c){r.error("error parsing content type",c)}return o===kp&&(o=i),o??i}async function U5(n,e,t,r){const i=t.forComponent("helia:verified-fetch:get-stream-from-async-iterable"),s=n[Symbol.asyncIterator](),{value:o,done:a}=await s.next();if(a===!0)throw i.error("no content found for path",e),new ZM;return{stream:new ReadableStream({async start(u){var d;(d=r==null?void 0:r.onProgress)==null||d.call(r,new N("verified-fetch:request:progress:chunk")),u.enqueue(o)},async pull(u){var f,p,m;const{value:d,done:h}=await s.next();if((f=r==null?void 0:r.signal)!=null&&f.aborted){u.error(new Jn(r.signal.reason??"signal aborted by user")),u.close();return}if(h===!0){d!=null&&((p=r==null?void 0:r.onProgress)==null||p.call(r,new N("verified-fetch:request:progress:chunk")),u.enqueue(d)),u.close();return}(m=r==null?void 0:r.onProgress)==null||m.call(r,new N("verified-fetch:request:progress:chunk")),u.enqueue(d)}}),firstChunk:o}}class hV extends Ai{constructor(){super(...arguments);l(this,"id","dag-pb-plugin");l(this,"codes",[At])}canHandle({cid:t,accept:r,pathDetails:i,byteRangeContext:s}){return this.log("checking if we can handle %c with accept %s",t,r),i==null||s==null?!1:t.code===At}getRedirectUrl(t){const{resource:r,path:i}=t;if(i===""?!r.toString().endsWith("/"):!i.endsWith("/"))try{const o=new URL(r.toString());return o.pathname.endsWith("/")?null:(o.pathname=`${o.pathname}/`,o.toString())}catch{return`${r.toString()}/`}return null}async handle(t){var re,T,Y,se,L;const{cid:r,options:i,withServerTiming:s=!1,pathDetails:o,query:a}=t,{handleServerTiming:c,contentTypeParser:u,helia:d,getBlockstore:h}=this.pluginOptions,f=this.log;let p=t.resource,m=t.path,w=!1;const b=t.byteRangeContext,S=o.ipfsRoots,k=o.terminalElement;let C=k.cid;const Q=nH({...d,blockstore:h(t.cid,t.resource,(i==null?void 0:i.session)??!0,i)});if((k==null?void 0:k.type)==="directory"){const B=k.cid,M=this.getRedirectUrl(t);if(M!=null){if(f.trace("directory url normalization spec requires redirect..."),(i==null?void 0:i.redirect)==="error")throw f('could not redirect to %s as redirect option was set to "error"',M),new TypeError("Failed to fetch");if((i==null?void 0:i.redirect)==="manual")return f("returning 301 permanent redirect to %s",M),lp(p,M);f("following redirect to %s",M),p=M,w=!0}const V="index.html";try{f.trace("found directory at %c/%s, looking for index.html",r,m);const K=await c("exporter-dir","",async()=>ah(`/ipfs/${B}/${V}`,d.blockstore,{signal:i==null?void 0:i.signal,onProgress:i==null?void 0:i.onProgress}),s);f.trace("found root file at %c/%s with cid %c",B,V,K.cid),m=V,C=K.cid}catch(K){if((re=i==null?void 0:i.signal)!=null&&re.aborted)throw new Jn((T=i==null?void 0:i.signal)==null?void 0:T.reason);this.log.error("error loading path %c/%s",B,V,K),t.isDirectory=!0,t.directoryEntries=[],t.modified++,this.log.trace("attempting to get directory entries because index.html was not found");try{for await(const ie of Q.ls(B,{signal:i==null?void 0:i.signal,onProgress:i==null?void 0:i.onProgress}))t.directoryEntries.push(ie);return null}catch(ie){return f.error("error listing directory %c",B,ie),Gv("Unable to get directory contents")}}finally{(Y=i==null?void 0:i.onProgress)==null||Y.call(i,new N("verified-fetch:request:end",{cid:B,path:V}))}}try{const B=await Q.stat(C,{extended:!0,signal:AbortSignal.timeout(500)});b.setFileSize(B.size)}catch(B){f.error("error getting exact file size for %c/%s - %e",r,m,B),b.setFileSize(o.terminalElement.size),f.trace("using terminal element size of %d for %c/%s",o.terminalElement.size,r,m)}try{const B=await c("exporter-file","",async()=>ah(C,d.blockstore,{signal:i==null?void 0:i.signal,onProgress:i==null?void 0:i.onProgress}),s);let M,V;if(b.isValidRangeRequest)V=await this.handleRangeRequest(t,B);else{const ie=B.content({signal:i==null?void 0:i.signal,onProgress:i==null?void 0:i.onProgress});f("got async iterator for %c/%s",r,m);const ae=await c("stream-and-chunk","",async()=>U5(ie,m??"",this.pluginOptions.logger,{onProgress:i==null?void 0:i.onProgress,signal:i==null?void 0:i.signal}),s),J=ae.stream;M=ae.firstChunk,V=await c("get-content-type","",async()=>_p({filename:a.filename,bytes:M,path:m,contentTypeParser:u,log:f}),s),b.setBody(J)}const K=io(p,b.getBody(V),{byteRangeContext:b,log:f},{redirected:w});return K.headers.set("Content-Type",b.getContentType()??V),qv(K,S),K}catch(B){if((se=i==null?void 0:i.signal)!=null&&se.aborted)throw new Jn((L=i==null?void 0:i.signal)==null?void 0:L.reason);return f.error("error streaming %c/%s",r,m,B),b.isRangeRequest&&B.code==="ERR_INVALID_PARAMS"?rh(p):g3(p.toString(),"Unable to stream content")}}async handleRangeRequest(t,r){const{path:i,byteRangeContext:s,options:o,withServerTiming:a=!1}=t,{handleServerTiming:c,contentTypeParser:u}=this.pluginOptions,d=this.log,h=r.content({signal:o==null?void 0:o.signal,onProgress:o==null?void 0:o.onProgress,offset:0,length:8192}),{firstChunk:f}=await U5(h,i??"",this.pluginOptions.logger,{onProgress:o==null?void 0:o.onProgress,signal:o==null?void 0:o.signal}),p=await c("get-content-type","",async()=>_p({bytes:f,path:i,contentTypeParser:u,log:d}),a);return s==null||s.setBody(m=>{var w,b;if((w=o==null?void 0:o.signal)!=null&&w.aborted)throw new Jn(((b=o==null?void 0:o.signal)==null?void 0:b.reason)??"aborted while streaming");return r.content({signal:o==null?void 0:o.signal,onProgress:o==null?void 0:o.onProgress,offset:m.start??0,length:s.getLength(m)})},p),p}}class fV extends Ai{constructor(){super(...arguments);l(this,"id","dag-walk-plugin")}canHandle(t){this.log("checking if we can handle %c with accept %s",t.cid,t.accept);const{pathDetails:r,cid:i}=t;return r!=null?!1:i.code===At||i.code===oi}async handle(t){const{cid:r,resource:i,options:s,withServerTiming:o=!1}=t,{getBlockstore:a,handleServerTiming:c}=this.pluginOptions,u=a(r,i,(s==null?void 0:s.session)??!0,s),d=await c("path-walking","",async()=>cF({...t,blockstore:u,log:this.log}),o);return d instanceof Response?(this.log.trace("path walking failed"),d.status===404?d:null):(t.modified++,t.pathDetails=d,null)}}function $S(n){return n.charAt(0)==="1"||n.charAt(0)==="Q"?gh(n):Dp(le.parse(n))}class pV extends Error{constructor(t,r,i){super(r);l(this,"name","PluginError");l(this,"code");l(this,"fatal");l(this,"details");l(this,"response");this.code=t,this.fatal=(i==null?void 0:i.fatal)??!1,this.details=i==null?void 0:i.details,this.response=i==null?void 0:i.response}}class Ip extends pV{constructor(t,r,i){super(t,r,{...i,fatal:!0});l(this,"name","PluginFatalError");this.name="PluginFatalError"}}class gV extends Ai{constructor(){super(...arguments);l(this,"id","ipns-record-plugin");l(this,"codes",[])}canHandle({cid:t,accept:r,query:i,byteRangeContext:s}){return this.log("checking if we can handle %c with accept %s",t,r),s==null?!1:r==="application/vnd.ipfs.ipns-record"||i.format==="ipns-record"}async handle(t){const{resource:r,path:i,options:s}=t,{helia:o}=this.pluginOptions;if(t.reqFormat="ipns-record",i!==""||!(r.startsWith("ipns://")||r.includes(".ipns.")||r.includes("/ipns/")))throw this.log.error('invalid request for IPNS name "%s" and path "%s"',r,i),new Ip("ERR_INVALID_IPNS_NAME","Invalid IPNS name",{response:cp(r,new Error("Invalid IPNS name"))});let a;try{let p;r.startsWith("ipns://")?p=r.replace("ipns://",""):r.includes("/ipns/")?p=r.split("/ipns/")[1].split("/")[0].split("?")[0]:p=r.split(".ipns.")[0].split("://")[1],this.log.trace('trying to parse peer id from "%s"',p),a=$S(p)}catch(p){throw this.log.error("could not parse peer id from IPNS url %s",r,p),new Ip("ERR_NO_PEER_ID_FOUND","could not parse peer id from url",{response:cp(r,p)})}const c=sr([R("/ipns/"),a.toMultihash().bytes]),u=new Ue("/dht/record/"+U(c,"base32"),!1),d=await o.datastore.get(u,s),h=Nt.deserialize(d);t.byteRangeContext.setBody(h.value);const f=io(r,t.byteRangeContext.getBody("application/vnd.ipfs.ipns-record"),{byteRangeContext:t.byteRangeContext,log:this.log});return f.headers.set("content-type",t.byteRangeContext.getContentType()??"application/vnd.ipfs.ipns-record"),f}}class mV extends Ai{constructor(){super(...arguments);l(this,"id","json-plugin");l(this,"codes",[ks,qo])}canHandle({cid:t,accept:r,byteRangeContext:i}){return this.log("checking if we can handle %c with accept %s",t,r),i==null?!1:r==="application/vnd.ipld.dag-json"&&t.code!==oi?!0:ks===t.code||qo===t.code}async handle(t){var b;const{path:r,resource:i,cid:s,accept:o,options:a}=t,{getBlockstore:c}=this.pluginOptions,u=(a==null?void 0:a.session)??!0;this.log.trace("fetching %c/%s",s,r);const d=((b=t.pathDetails)==null?void 0:b.terminalElement.cid)??t.cid,f=await c(d,i,u,a).get(d,a);let p;if(o==="application/vnd.ipld.dag-cbor"||o==="application/cbor")try{const S=Lp(f);p=i8(S)}catch(S){return this.log.error("could not transform %c to application/vnd.ipld.dag-cbor",S),jc(i)}else p=f;let m;o==null?ks===s.code?m="application/vnd.ipld.dag-json":m="application/json":m=o.split(";")[0],t.byteRangeContext.setBody(p);const w=io(i,t.byteRangeContext.getBody(m),{byteRangeContext:t.byteRangeContext,log:this.log});return w.headers.set("content-type",t.byteRangeContext.getContentType()??m),t.byteRangeContext.isValidRangeRequest||w.headers.set("content-length",p.length.toString()),w}}const yV=["application/vnd.ipld.dag-json","application/vnd.ipld.raw","application/octet-stream"];function wV({headers:n,accept:e}){const r=(e??new Headers(n).get("accept")??"").split(",").map(i=>i.split(";")[0]).map(i=>i.trim());for(const i of r){if(i==="*/*")return;if(yV.includes(i??""))return i}}class bV extends Ai{constructor(){super(...arguments);l(this,"id","raw-plugin");l(this,"codes",[Bt,nn.code])}canHandle({cid:t,accept:r,query:i,byteRangeContext:s}){return this.log("checking if we can handle %c with accept %s",t,r),s==null?!1:r==="application/vnd.ipld.raw"||i.format==="raw"}async handle(t){var k;const{path:r,resource:i,cid:s,accept:o,query:a,options:c}=t,{getBlockstore:u,contentTypeParser:d}=this.pluginOptions,h=(c==null?void 0:c.session)??!0,f=this.log;if(o==="application/vnd.ipld.raw"||a.format==="raw"?(t.reqFormat="raw",t.query.download=!0,t.query.filename=t.query.filename??`${s.toString()}.bin`,f.trace("Set content disposition...")):f.trace("Did NOT set content disposition..."),r!==""&&s.code===Bt)throw f.trace("404-ing raw codec request for %c/%s",s,r),new Ip("ERR_RAW_PATHS_NOT_SUPPORTED","Raw codec does not support paths",{response:jv(i,"Raw codec does not support paths")});const p=((k=t.pathDetails)==null?void 0:k.terminalElement.cid)??t.cid,w=await u(p,i,h,c).get(p,c);t.byteRangeContext.setBody(w);const b=await _p({filename:a.filename,bytes:w,path:r,defaultContentType:wV({headers:c==null?void 0:c.headers,accept:o}),contentTypeParser:d,log:f}),S=io(i,t.byteRangeContext.getBody(b),{byteRangeContext:t.byteRangeContext,log:f},{redirected:!1});return S.headers.set("content-type",t.byteRangeContext.getContentType()??b),S}}const vV=({weak:n,reqFormat:e})=>e==="tar"||e==="car"||e==="ipns-record"||n===!0?"W/":"",SV=({reqFormat:n})=>n==null?"":n==="tar"?".x-tar":`.${n}`;function HS({cid:n,reqFormat:e,weak:t,rangeStart:r,rangeEnd:i,contentPrefix:s}){const o=vV({weak:t,reqFormat:e});let a=SV({reqFormat:e});return(r!=null||i!=null)&&(a+=`.${r??"0"}-${i??"N"}`),`${o}"${s??""}${n.toString()}${a}"`}R("ustar\0","binary");R("ustar ","binary");R(" \0","binary");var EV={COPYFILE_EXCL:1,COPYFILE_FICLONE:2,COPYFILE_FICLONE_FORCE:4,F_OK:0,O_APPEND:1024,O_CREAT:64,O_DIRECT:16384,O_DIRECTORY:65536,O_DSYNC:4096,O_EXCL:128,O_NOATIME:262144,O_NOCTTY:256,O_NOFOLLOW:131072,O_NONBLOCK:2048,O_RDONLY:0,O_RDWR:2,O_SYNC:1052672,O_TRUNC:512,O_WRONLY:1,R_OK:4,S_IFBLK:24576,S_IFCHR:8192,S_IFDIR:16384,S_IFIFO:4096,S_IFLNK:40960,S_IFMT:61440,S_IFREG:32768,S_IFSOCK:49152,S_IRGRP:32,S_IROTH:4,S_IRUSR:256,S_IRWXG:56,S_IRWXO:7,S_IRWXU:448,S_IWGRP:16,S_IWOTH:2,S_IWUSR:128,S_IXGRP:8,S_IXOTH:1,S_IXUSR:64,UV_DIRENT_BLOCK:7,UV_DIRENT_CHAR:6,UV_DIRENT_DIR:2,UV_DIRENT_FIFO:4,UV_DIRENT_FILE:1,UV_DIRENT_LINK:3,UV_DIRENT_SOCKET:5,UV_DIRENT_UNKNOWN:0,UV_FS_COPYFILE_EXCL:1,UV_FS_COPYFILE_FICLONE:2,UV_FS_COPYFILE_FICLONE_FORCE:4,UV_FS_O_FILEMAP:0,UV_FS_SYMLINK_DIR:1,UV_FS_SYMLINK_JUNCTION:2,W_OK:2,X_OK:1,RTLD_LAZY:1,RTLD_NOW:2,RTLD_GLOBAL:256,RTLD_LOCAL:0,RTLD_DEEPBIND:8,E2BIG:7,EACCES:13,EADDRINUSE:98,EADDRNOTAVAIL:99,EAFNOSUPPORT:97,EAGAIN:11,EALREADY:114,EBADF:9,EBADMSG:74,EBUSY:16,ECANCELED:125,ECHILD:10,ECONNABORTED:103,ECONNREFUSED:111,ECONNRESET:104,EDEADLK:35,EDESTADDRREQ:89,EDOM:33,EDQUOT:122,EEXIST:17,EFAULT:14,EFBIG:27,EHOSTUNREACH:113,EIDRM:43,EILSEQ:84,EINPROGRESS:115,EINTR:4,EINVAL:22,EIO:5,EISCONN:106,EISDIR:21,ELOOP:40,EMFILE:24,EMLINK:31,EMSGSIZE:90,EMULTIHOP:72,ENAMETOOLONG:36,ENETDOWN:100,ENETRESET:102,ENETUNREACH:101,ENFILE:23,ENOBUFS:105,ENODATA:61,ENODEV:19,ENOENT:2,ENOEXEC:8,ENOLCK:37,ENOLINK:67,ENOMEM:12,ENOMSG:42,ENOPROTOOPT:92,ENOSPC:28,ENOSR:63,ENOSTR:60,ENOSYS:38,ENOTCONN:107,ENOTDIR:20,ENOTEMPTY:39,ENOTSOCK:88,ENOTSUP:95,ENOTTY:25,ENXIO:6,EOPNOTSUPP:95,EOVERFLOW:75,EPERM:1,EPIPE:32,EPROTO:71,EPROTONOSUPPORT:93,EPROTOTYPE:91,ERANGE:34,EROFS:30,ESPIPE:29,ESRCH:3,ESTALE:116,ETIME:62,ETIMEDOUT:110,ETXTBSY:26,EWOULDBLOCK:11,EXDEV:18,SIGHUP:1,SIGINT:2,SIGQUIT:3,SIGILL:4,SIGTRAP:5,SIGABRT:6,SIGIOT:6,SIGBUS:7,SIGFPE:8,SIGKILL:9,SIGUSR1:10,SIGSEGV:11,SIGUSR2:12,SIGPIPE:13,SIGALRM:14,SIGTERM:15,SIGCHLD:17,SIGSTKFLT:16,SIGCONT:18,SIGSTOP:19,SIGTSTP:20,SIGTTIN:21,SIGTTOU:22,SIGURG:23,SIGXCPU:24,SIGXFSZ:25,SIGVTALRM:26,SIGPROF:27,SIGWINCH:28,SIGIO:29,SIGPOLL:29,SIGPWR:30,SIGSYS:31,SIGUNUSED:31,PRIORITY_LOW:19,PRIORITY_BELOW_NORMAL:10,PRIORITY_NORMAL:0,PRIORITY_ABOVE_NORMAL:-7,PRIORITY_HIGH:-14,PRIORITY_HIGHEST:-20,OPENSSL_VERSION_NUMBER:269488319,SSL_OP_ALL:2147485780,SSL_OP_ALLOW_NO_DHE_KEX:1024,SSL_OP_ALLOW_UNSAFE_LEGACY_RENEGOTIATION:262144,SSL_OP_CIPHER_SERVER_PREFERENCE:4194304,SSL_OP_CISCO_ANYCONNECT:32768,SSL_OP_COOKIE_EXCHANGE:8192,SSL_OP_CRYPTOPRO_TLSEXT_BUG:2147483648,SSL_OP_DONT_INSERT_EMPTY_FRAGMENTS:2048,SSL_OP_EPHEMERAL_RSA:0,SSL_OP_LEGACY_SERVER_CONNECT:4,SSL_OP_MICROSOFT_BIG_SSLV3_BUFFER:0,SSL_OP_MICROSOFT_SESS_ID_BUG:0,SSL_OP_MSIE_SSLV2_RSA_PADDING:0,SSL_OP_NETSCAPE_CA_DN_BUG:0,SSL_OP_NETSCAPE_CHALLENGE_BUG:0,SSL_OP_NETSCAPE_DEMO_CIPHER_CHANGE_BUG:0,SSL_OP_NETSCAPE_REUSE_CIPHER_CHANGE_BUG:0,SSL_OP_NO_COMPRESSION:131072,SSL_OP_NO_ENCRYPT_THEN_MAC:524288,SSL_OP_NO_QUERY_MTU:4096,SSL_OP_NO_RENEGOTIATION:1073741824,SSL_OP_NO_SESSION_RESUMPTION_ON_RENEGOTIATION:65536,SSL_OP_NO_SSLv2:0,SSL_OP_NO_SSLv3:33554432,SSL_OP_NO_TICKET:16384,SSL_OP_NO_TLSv1:67108864,SSL_OP_NO_TLSv1_1:268435456,SSL_OP_NO_TLSv1_2:134217728,SSL_OP_NO_TLSv1_3:536870912,SSL_OP_PKCS1_CHECK_1:0,SSL_OP_PKCS1_CHECK_2:0,SSL_OP_PRIORITIZE_CHACHA:2097152,SSL_OP_SINGLE_DH_USE:0,SSL_OP_SINGLE_ECDH_USE:0,SSL_OP_SSLEAY_080_CLIENT_DH_BUG:0,SSL_OP_SSLREF2_REUSE_CERT_TYPE_BUG:0,SSL_OP_TLS_BLOCK_PADDING_BUG:0,SSL_OP_TLS_D5_BUG:0,SSL_OP_TLS_ROLLBACK_BUG:8388608,ENGINE_METHOD_RSA:1,ENGINE_METHOD_DSA:2,ENGINE_METHOD_DH:4,ENGINE_METHOD_RAND:8,ENGINE_METHOD_EC:2048,ENGINE_METHOD_CIPHERS:64,ENGINE_METHOD_DIGESTS:128,ENGINE_METHOD_PKEY_METHS:512,ENGINE_METHOD_PKEY_ASN1_METHS:1024,ENGINE_METHOD_ALL:65535,ENGINE_METHOD_NONE:0,DH_CHECK_P_NOT_SAFE_PRIME:2,DH_CHECK_P_NOT_PRIME:1,DH_UNABLE_TO_CHECK_GENERATOR:4,DH_NOT_SUITABLE_GENERATOR:8,ALPN_ENABLED:1,RSA_PKCS1_PADDING:1,RSA_SSLV23_PADDING:2,RSA_NO_PADDING:3,RSA_PKCS1_OAEP_PADDING:4,RSA_X931_PADDING:5,RSA_PKCS1_PSS_PADDING:6,RSA_PSS_SALTLEN_DIGEST:-1,RSA_PSS_SALTLEN_MAX_SIGN:-2,RSA_PSS_SALTLEN_AUTO:-2,defaultCoreCipherList:"TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA384:DHE-RSA-AES256-SHA384:ECDHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA256:HIGH:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!SRP:!CAMELLIA",TLS1_VERSION:769,TLS1_1_VERSION:770,TLS1_2_VERSION:771,TLS1_3_VERSION:772,POINT_CONVERSION_COMPRESSED:2,POINT_CONVERSION_UNCOMPRESSED:4,POINT_CONVERSION_HYBRID:6,Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_VERSION_ERROR:-6,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,ZLIB_VERNUM:4784,DEFLATE:1,INFLATE:2,GZIP:3,GUNZIP:4,DEFLATERAW:5,INFLATERAW:6,UNZIP:7,BROTLI_DECODE:8,BROTLI_ENCODE:9,ZSTD_COMPRESS:10,ZSTD_DECOMPRESS:11,Z_MIN_WINDOWBITS:8,Z_MAX_WINDOWBITS:15,Z_DEFAULT_WINDOWBITS:15,Z_MIN_CHUNK:64,Z_MAX_CHUNK:null,Z_DEFAULT_CHUNK:16384,Z_MIN_MEMLEVEL:1,Z_MAX_MEMLEVEL:9,Z_DEFAULT_MEMLEVEL:8,Z_MIN_LEVEL:-1,Z_MAX_LEVEL:9,Z_DEFAULT_LEVEL:-1,BROTLI_OPERATION_PROCESS:0,BROTLI_OPERATION_FLUSH:1,BROTLI_OPERATION_FINISH:2,BROTLI_OPERATION_EMIT_METADATA:3,BROTLI_PARAM_MODE:0,BROTLI_MODE_GENERIC:0,BROTLI_MODE_TEXT:1,BROTLI_MODE_FONT:2,BROTLI_DEFAULT_MODE:0,BROTLI_PARAM_QUALITY:1,BROTLI_MIN_QUALITY:0,BROTLI_MAX_QUALITY:11,BROTLI_DEFAULT_QUALITY:11,BROTLI_PARAM_LGWIN:2,BROTLI_MIN_WINDOW_BITS:10,BROTLI_MAX_WINDOW_BITS:24,BROTLI_LARGE_MAX_WINDOW_BITS:30,BROTLI_DEFAULT_WINDOW:22,BROTLI_PARAM_LGBLOCK:3,BROTLI_MIN_INPUT_BLOCK_BITS:16,BROTLI_MAX_INPUT_BLOCK_BITS:24,BROTLI_PARAM_DISABLE_LITERAL_CONTEXT_MODELING:4,BROTLI_PARAM_SIZE_HINT:5,BROTLI_PARAM_LARGE_WINDOW:6,BROTLI_PARAM_NPOSTFIX:7,BROTLI_PARAM_NDIRECT:8,BROTLI_DECODER_RESULT_ERROR:0,BROTLI_DECODER_RESULT_SUCCESS:1,BROTLI_DECODER_RESULT_NEEDS_MORE_INPUT:2,BROTLI_DECODER_RESULT_NEEDS_MORE_OUTPUT:3,BROTLI_DECODER_PARAM_DISABLE_RING_BUFFER_REALLOCATION:0,BROTLI_DECODER_PARAM_LARGE_WINDOW:1,BROTLI_DECODER_NO_ERROR:0,BROTLI_DECODER_SUCCESS:1,BROTLI_DECODER_NEEDS_MORE_INPUT:2,BROTLI_DECODER_NEEDS_MORE_OUTPUT:3,BROTLI_DECODER_ERROR_FORMAT_EXUBERANT_NIBBLE:-1,BROTLI_DECODER_ERROR_FORMAT_RESERVED:-2,BROTLI_DECODER_ERROR_FORMAT_EXUBERANT_META_NIBBLE:-3,BROTLI_DECODER_ERROR_FORMAT_SIMPLE_HUFFMAN_ALPHABET:-4,BROTLI_DECODER_ERROR_FORMAT_SIMPLE_HUFFMAN_SAME:-5,BROTLI_DECODER_ERROR_FORMAT_CL_SPACE:-6,BROTLI_DECODER_ERROR_FORMAT_HUFFMAN_SPACE:-7,BROTLI_DECODER_ERROR_FORMAT_CONTEXT_MAP_REPEAT:-8,BROTLI_DECODER_ERROR_FORMAT_BLOCK_LENGTH_1:-9,BROTLI_DECODER_ERROR_FORMAT_BLOCK_LENGTH_2:-10,BROTLI_DECODER_ERROR_FORMAT_TRANSFORM:-11,BROTLI_DECODER_ERROR_FORMAT_DICTIONARY:-12,BROTLI_DECODER_ERROR_FORMAT_WINDOW_BITS:-13,BROTLI_DECODER_ERROR_FORMAT_PADDING_1:-14,BROTLI_DECODER_ERROR_FORMAT_PADDING_2:-15,BROTLI_DECODER_ERROR_FORMAT_DISTANCE:-16,BROTLI_DECODER_ERROR_DICTIONARY_NOT_SET:-19,BROTLI_DECODER_ERROR_INVALID_ARGUMENTS:-20,BROTLI_DECODER_ERROR_ALLOC_CONTEXT_MODES:-21,BROTLI_DECODER_ERROR_ALLOC_TREE_GROUPS:-22,BROTLI_DECODER_ERROR_ALLOC_CONTEXT_MAP:-25,BROTLI_DECODER_ERROR_ALLOC_RING_BUFFER_1:-26,BROTLI_DECODER_ERROR_ALLOC_RING_BUFFER_2:-27,BROTLI_DECODER_ERROR_ALLOC_BLOCK_TYPE_TREES:-30,BROTLI_DECODER_ERROR_UNREACHABLE:-31};const xV=ol(EV);function AV(n){return n[Symbol.asyncIterator]!=null}function kV(n){if(AV(n))return(async()=>{let r=new Uint8Array(0);for await(const i of n)r=sr([r,i],r.length+i.length);return r})();const e=[];let t=0;for(const r of n)e.push(r),t+=r.byteLength;return sr(e,t)}const _V="0000000000000000000",IV="7777777777777777777",CV=48,TV=R("ustar\0","binary"),RV=R("00","binary"),PV=parseInt("7777",8),OV=257,DV=263,NV=function(n){switch(n){case"file":return 0;case"link":return 1;case"symlink":return 2;case"character-device":return 3;case"block-device":return 4;case"directory":return 5;case"fifo":return 6;case"contiguous-file":return 7;case"pax-header":return 72;default:return 0}},LV=function(n){let e=256;for(let t=0;t<148;t++)e+=n[t];for(let t=156;t<512;t++)e+=n[t];return e},Ii=function(n,e){const t=n.toString(8);return t.length>e?R(IV.slice(0,e)+" "):R(_V.slice(0,e-t.length)+t+" ")},Uf=function(n){const e=R(n).byteLength;let t=Math.floor(Math.log(e)/Math.log(10))+1;return e+t>=Math.pow(10,t)&&t++,`${e+t}${n}`};function BV(n){let e="";n.name!=null&&(e+=Uf(" path="+n.name+`
`)),n.linkname!=null&&(e+=Uf(" linkpath="+n.linkname+`
`));const t=n.pax;if(t!=null)for(const r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e+=Uf(" "+r+"="+t[r]+`
`));return R(e)}function Cp(n){const e=new Uint8Array(512);let t=n.name,r="";if(n.typeflag===5&&t[t.length-1]!=="/"&&(t+="/"),R(t).byteLength!==t.length)return null;for(;R(t).byteLength>100;){const i=t.indexOf("/");if(i===-1)return null;r+=r!==""?"/"+t.slice(0,i):t.slice(0,i),t=t.slice(i+1)}return R(t).byteLength>100||R(r).byteLength>155||n.linkname!=null&&R(n.linkname).byteLength>100?null:(e.set(R(t),0),e.set(Ii(n.mode&PV,6),100),e.set(Ii(n.uid,6),108),e.set(Ii(n.gid,6),116),e.set(Ii(n.size,11),124),e.set(Ii(n.mtime.getTime()/1e3|0,11),136),e[156]=CV+NV(n.type),n.linkname!=null&&e.set(R(n.linkname),157),e.set(TV,OV),e.set(RV,DV),n.uname!=null&&e.set(R(n.uname),265),n.gname!=null&&e.set(R(n.gname),297),e.set(Ii(n.devmajor??0,6),329),e.set(Ii(n.devminor??0,6),337),r!=null&&e.set(R(r),345),e.set(Ii(LV(e),6),148),e)}const{S_IFMT:MV,S_IFBLK:UV,S_IFCHR:FV,S_IFDIR:$V,S_IFIFO:HV,S_IFLNK:VV}=xV,zV=parseInt("755",8),KV=parseInt("644",8),VS=new Uint8Array(1024);function qV(n=0){switch(n&MV){case UV:return"block-device";case FV:return"character-device";case $V:return"directory";case HV:return"fifo";case VV:return"symlink";default:return"file"}}function Tp(n){return n&=511,n!==0?VS.subarray(0,512-n):new Uint8Array(0)}function Ff(n){if(n.pax==null){const e=Cp(n);if(e!=null)return e}return WV(n)}function WV(n){const e=BV(n),t={name:"PaxHeader",mode:n.mode,uid:n.uid,gid:n.gid,size:e.length,mtime:n.mtime,type:"pax-header",linkname:n.linkname,uname:n.uname,gname:n.gname,devmajor:n.devmajor,devminor:n.devminor};return new Ee(Cp(t)??new Uint8Array(0),e,Tp(e.length),Cp({...t,size:n.size,type:n.type})??new Uint8Array(0)).subarray()}function F5(){return async function*(n){for await(let{header:e,body:t}of n){const r={...e,size:e.type==="symlink"?0:e.size??0,type:e.type??qV(e.mode),mode:e.mode??(e.type==="directory"?zV:KV),uid:e.uid??0,gid:e.gid??0,mtime:e.mtime??new Date};if(typeof t=="string"&&(t=R(t)),t instanceof Uint8Array||pu(t)){r.size=t.length,yield Ff(r),yield pu(t)?t.subarray():t,yield Tp(r.size);continue}if(r.type==="symlink"&&r.linkname==null){if(t==null)throw new Error("type was symlink but no linkname or body specified");r.linkname=U(await kV(t)),yield Ff(r);continue}if(yield Ff(r),r.type!=="file"&&r.type!=="contiguous-file")continue;let i=0;for await(const s of t??[])i+=s.length,yield pu(s)?s.subarray():s;if(i!==r.size)throw new Error(`size mismatch, wrote ${i} of ${r.size} bytes`);yield Tp(r.size)}yield VS}}const GV=["file","raw","directory"];function jV(n){let e,t;return(n.type==="file"||n.type==="directory")&&(e=n.unixfs.mode,t=n.unixfs.mtime!=null?new Date(Number(n.unixfs.mtime.secs*1000n)):void 0),{name:n.path,mode:e,mtime:t,size:Number(n.size),type:n.type==="directory"?"directory":"file"}}function $5(n){if(!GV.includes(n.type))throw new Oa(`${n.type} is not a UnixFS node`);const e={header:jV(n)};return(n.type==="file"||n.type==="raw")&&(e.body=n.content()),e}async function*QV(n,e,t){const r=await ah(n,e,t);if(r.type==="file"||r.type==="raw"){yield*_t([$5(r)],F5());return}if(r.type==="directory"){yield*_t(oF(n,e,t),i=>vr(i,s=>$5(s)),F5());return}throw new Oa("Not a UnixFS node")}class YV extends Ai{constructor(){super(...arguments);l(this,"id","tar-plugin");l(this,"codes",[])}canHandle({cid:t,accept:r,query:i,byteRangeContext:s}){return this.log("checking if we can handle %c with accept %s",t,r),s==null?!1:r==="application/x-tar"||i.format==="tar"}async handle(t){const{cid:r,path:i,resource:s,options:o,pathDetails:a}=t,{getBlockstore:c}=this.pluginOptions,u=(a==null?void 0:a.terminalElement.cid)??r;if(u.code!==At&&u.code!==Bt)return jc("only UnixFS data can be returned in a TAR file");t.reqFormat="tar",t.query.download=!0,t.query.filename=t.query.filename??`${u.toString()}.tar`;const d=c(u,s,o==null?void 0:o.session,o),h=f3(QV(`/ipfs/${r}/${i}`,d,o));t.byteRangeContext.setBody(h);const f=io(s,t.byteRangeContext.getBody("application/x-tar"),{byteRangeContext:t.byteRangeContext,log:this.log});return f.headers.set("content-type",t.byteRangeContext.getContentType()??"application/x-tar"),f.headers.set("etag",HS({cid:u,reqFormat:t.reqFormat,weak:!0})),f}}function XV(n){const e=ZV(n);return e===n?`filename="${n}"`:`filename="${e}"; filename*=UTF-8''${encodeURIComponent(n)}`}function ZV(n){return n.replace(/[^\x00-\x7F]/g,"_")}const JV={[oi]:["application/json","application/vnd.ipld.dag-cbor","application/cbor","application/vnd.ipld.dag-json","application/octet-stream","application/vnd.ipld.raw","application/vnd.ipfs.ipns-record","application/vnd.ipld.car","text/html"],[ks]:["application/json","application/vnd.ipld.dag-cbor","application/cbor","application/vnd.ipld.dag-json","application/octet-stream","application/vnd.ipld.raw","application/vnd.ipfs.ipns-record","application/vnd.ipld.car"],[qo]:["application/json","application/vnd.ipld.dag-cbor","application/cbor","application/vnd.ipld.dag-json","application/octet-stream","application/vnd.ipld.raw","application/vnd.ipfs.ipns-record","application/vnd.ipld.car"],[At]:["application/octet-stream","application/json","application/vnd.ipld.dag-cbor","application/cbor","application/vnd.ipld.dag-json","application/vnd.ipld.raw","application/vnd.ipfs.ipns-record","application/vnd.ipld.car","application/x-tar"],[Bt]:["application/octet-stream","application/vnd.ipld.raw","application/vnd.ipfs.ipns-record","application/vnd.ipld.dag-json","application/vnd.ipld.car","application/x-tar"]};function ez(n,e){const t=JV[n.code];if(e!=null)return tz(e,t)}function tz(n,e){const t=n.split(",").map(r=>{const i=r.trim().split(";");return{mimeType:`${i[0]}`.trim(),weight:rz(i[1])}}).sort((r,i)=>r.weight===i.weight?0:r.weight>i.weight?-1:1).map(r=>r.mimeType);for(const r of t)for(const i of e)if(r.includes(i)||r==="*/*"||r.startsWith("*/")&&i.split("/")[1]===r.split("/")[1]||r.endsWith("/*")&&i.split("/")[0]===r.split("/")[0])return i}function rz(n){if(n!=null&&(n=n.trim()),(n==null?void 0:n.startsWith("q="))!==!0)return 1;const e=parseFloat(n.replace("q=",""));return isNaN(e)?0:e}const R3={raw:"application/vnd.ipld.raw",car:"application/vnd.ipld.car","dag-json":"application/vnd.ipld.dag-json","dag-cbor":"application/vnd.ipld.dag-cbor",json:"application/json",cbor:"application/cbor","ipns-record":"application/vnd.ipfs.ipns-record",tar:"application/x-tar"};function nz(n){if(n!=null)return R3[n]}function zS(n){const e=n.get("accept");return!!(e!=null&&Object.values(R3).includes(e))}function KS(n){const e=n==null?void 0:n.format;return!!(e!=null&&Object.keys(R3).includes(e))}function iz({query:n,headers:e}){return zS(e)||KS(n)}function sz({query:n,headers:e,logger:t}){const r=t.forComponent("helia:verified-fetch:get-resolved-accept-header"),i=new Headers(e),s=i.get("accept")??void 0;if(s!=null&&r('incoming accept header "%s"',s),!iz({query:n,headers:i}))return r("no explicit IPLD content-type requested, returning incoming accept header %s",s),s;const o=nz(n==null?void 0:n.format);(n==null?void 0:n.format)!=null&&r('incoming query format "%s", mapped to %s',n.format,o);let a=s;return!zS(i)&&KS(n)&&(r("accept header not recognized, but query format provided, setting accept header to %s",o),a=o),r('resolved accept header to "%s"',a),a}async function Rp(n,e,t){const r=performance.now();try{const i=await t(),o=(performance.now()-r).toFixed(1),a=`${n};dur=${o};desc="${e}"`;return{result:i,header:a,error:null}}catch(i){const o=(performance.now()-r).toFixed(1),a=`${n};dur=${o};desc="${e}"`;return{result:null,error:i,header:a}}}class oz{constructor(e){l(this,"lru");this.lru=new Hv({maxSize:e})}get(e){return this.lru.get(e)}set(e,t,r){this.lru.set(e,t,{maxAge:Date.now()+r})}has(e){return this.get(e)!=null}remove(e){this.lru.delete(e)}clear(){this.lru.clear()}}const H5=new oz(1e3),az=/^(?<protocol>ip[fn]s):\/\/(?<cidOrPeerIdOrDnsLink>[^/?]+)\/?(?<path>[^?]*)\??(?<queryString>.*)$/,cz=/^\/(?<protocol>ip[fn]s)\/(?<cidOrPeerIdOrDnsLink>[^/?]+)\/?(?<path>[^?]*)\??(?<queryString>.*)$/,lz=/^https?:\/\/(.*[^/])\/(?<protocol>ip[fn]s)\/(?<cidOrPeerIdOrDnsLink>[^/?]+)\/?(?<path>[^?]*)\??(?<queryString>.*)$/,uz=/^https?:\/\/(?<cidOrPeerIdOrDnsLink>[^/?]+)\.(?<protocol>ip[fn]s)\.([^/?]+)\/?(?<path>[^?]*)\??(?<queryString>.*)$/;function dz(n){const e=n==null?void 0:n.protocol;if(e==null)return!1;const t=n==null?void 0:n.cidOrPeerIdOrDnsLink;if(t==null)return!1;const r=n==null?void 0:n.path,i=n==null?void 0:n.queryString;return["ipns","ipfs"].includes(e)&&typeof t=="string"&&(r==null||typeof r=="string")&&(i==null||typeof i=="string")}function P3(n){for(const e of[uz,az,lz,cz]){const t=n.match(e);if(dz(t==null?void 0:t.groups))return t.groups}throw new TypeError(`Invalid URL: ${n}, please use ipfs://, ipns://, or gateway URLs only`)}function hz(n){var i,s;if(n==null)return;const e=(i=n.answer)==null?void 0:i.TTL,t=(s=n.record)==null?void 0:s.ttl,r=t!=null?Number(t/BigInt(1e9)):void 0;return e??r}const fz=/^[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?$/;function pz(n){return fz.test(n)&&n.includes("-")&&!n.includes(".")}function gz(n){return n.replace(/--/g,"%").replace(/-/g,".").replace(/%/g,"-")}async function mz({urlString:n,ipns:e,logger:t,withServerTiming:r=!1},i){var S,k,C,Q;const s=t.forComponent("helia:verified-fetch:parse-url-string"),{protocol:o,cidOrPeerIdOrDnsLink:a,path:c,queryString:u}=P3(n);let d,h;const f=[];let p;const m=[];if(o==="ipfs")try{d=le.parse(a)}catch(re){s.error(re),f.push(new TypeError("Invalid CID for ipfs://<cid> URL"))}else if(p=H5.get(a),p!=null)d=p.cid,h=p.path,s.trace("resolved %s to %c from cache",a,d);else{s.trace("Attempting to resolve PeerId for %s",a);let re;try{re=$S(a);const T=re==null?void 0:re.publicKey;if(T==null)throw new TypeError("cidOrPeerIdOrDnsLink contains no public key");if(r){const Y=async()=>e.resolve(T,i),se=await Rp("ipns.resolve",`Resolve IPNS name ${a}`,Y);if(m.push(se),se.error!=null)throw se.error;p=se.result}else p=await e.resolve(T,i);d=p==null?void 0:p.cid,h=p==null?void 0:p.path,s.trace("resolved %s to %c",a,d)}catch(T){if((S=i==null?void 0:i.signal)!=null&&S.aborted)throw new Jn((k=i==null?void 0:i.signal)==null?void 0:k.reason);re==null?(s.error('could not parse PeerId string "%s"',a,T),f.push(new TypeError(`Could not parse PeerId in ipns url "${a}", ${T.message}`))):(s.error("could not resolve PeerId %c",re,T),f.push(new TypeError(`Could not resolve PeerId "${a}": ${T.message}`)))}if(d==null){let T=a;pz(a)&&(T=gz(a),s.trace('decoded dnslink from "%s" to "%s"',a,T)),s.trace("Attempting to resolve DNSLink for %s",T);try{if(r){const Y=await Rp("ipns.resolveDNSLink",`Resolve DNSLink ${T}`,e.resolveDNSLink.bind(e,T,i));if(m.push(Y),Y.error!=null)throw Y.error;p=Y.result}else p=await e.resolveDNSLink(T,i);d=p==null?void 0:p.cid,h=p==null?void 0:p.path,s.trace("resolved %s to %c",T,d)}catch(Y){if((C=i==null?void 0:i.signal)!=null&&C.aborted)throw new Jn((Q=i==null?void 0:i.signal)==null?void 0:Q.reason);s.error('could not resolve DnsLink for "%s"',a,Y),f.push(Y)}}}if(d==null)throw f.length===1?f[0]:(f.push(new Error(`Invalid resource. Cannot determine CID from URL "${n}".`)),f);let w=hz(p);p!=null&&(w=w??60*2,s.trace("caching %s resolved to %s with TTL: %s",a,d,w),H5.set(a,p,w*1e3));const b={};if(u!=null&&u.length>0){const re=u.split("&");for(const T of re){const[Y,se]=T.split("=");b[Y]=decodeURIComponent(se)}b.download!=null&&(b.download=b.download==="true"),b.filename!=null&&(b.filename=b.filename.toString())}return{protocol:o,cid:d,path:yz(h,c??""),query:b,ttl:w,ipfsPath:`/${o}/${a}${c!=null&&c!==""?`/${c}`:""}`,serverTimings:m}}function yz(n,e){let t="";return n!=null&&(t+=n),e.length>0&&(t=`${t.length>0?`${t}/`:t}${e}`),t=t.replace(/\/(\/)+/g,"/"),t.startsWith("/")&&(t=t.substring(1)),t.split("/").map(decodeURIComponent).join("/")}function V5(n){return n.match(/\.[a-zA-Z0-9]{1,4}$/)!=null||n.endsWith("/")?n:`${n}/`}async function wz({resource:n,options:e,logger:t,cid:r,fetch:i=globalThis.fetch}){const s=t.forComponent("helia:verified-fetch:get-redirect-response");if(typeof n!="string"||e==null||["ipfs://","ipns://"].some(d=>n.startsWith(d)))return null;const o=new Headers(e==null?void 0:e.headers),a=o.get("x-forwarded-host"),c=o.get("host");if(o.get("x-forwarded-for")==null&&a==null&&c==null)return s.trace("no redirect info found in headers"),null;s.trace("checking for redirect info");try{const d=P3(n),h=new URL(n),f=a??h.host,p=new URL(h);if(d.protocol==="ipfs"&&r.version===0?p.host=`${r.toV1()}.ipfs.${f}`:p.host=`${d.cidOrPeerIdOrDnsLink}.${d.protocol}.${f}`,(c==null?void 0:c.includes(d.protocol))===!0&&p.host.includes(c))return s.trace("request was for a subdomain already, not setting location header"),null;if(c!=null&&!p.host.includes(c))return s.trace("host header is not the same as the subdomain url host, not setting location header"),null;if(h.host===p.host)return s.trace("req url is the same as the subdomain url, not setting location header"),null;p.pathname=V5(h.pathname.replace(`/${d.cidOrPeerIdOrDnsLink}`,"").replace(`/${d.protocol}`,"")),s.trace("subdomain url %s",p.href);const m=new URL(h,`${h.protocol}//${f}`);m.pathname=V5(h.pathname),s.trace("path url %s",m.href);try{const w=await i(p,{method:"HEAD"});if(w.ok)return s("subdomain supported, redirecting to subdomain"),lp(n.toString(),p.href);throw s("subdomain not supported, subdomain failed with status %s %s",w.status,w.statusText),new Kv("subdomain not supported")}catch(w){return s("subdomain not supported",w),m.href===h.href?(s("path url is the same as the request url, not setting location header"),null):lp(n.toString(),m.href)}}catch(d){s.error("error setting location header for x-forwarded-host",d)}return null}async function bz(n,{ipns:e,logger:t},{withServerTiming:r=!1,...i}={withServerTiming:!1}){if(typeof n=="string")return mz({urlString:n,ipns:e,logger:t,withServerTiming:r},i);const s=le.asCID(n);if(s!=null)return{cid:s,protocol:"ipfs",path:"",query:{},ipfsPath:`/ipfs/${s.toString()}`,ttl:29030400,serverTimings:[]};throw new TypeError(`Invalid resource. Cannot determine CID from resource: ${n}`)}function vz(n){const e=le.asCID(n);if(e!=null)return`ipfs://${e}`;try{return`ipfs://${le.parse(n.toString())}`}catch{}const{protocol:t,cidOrPeerIdOrDnsLink:r}=P3(n.toString());return`${t}://${r}`}const Sz=100,Ez=60*1e3;function xz(n){if(n==null)return;let e;return(n==null?void 0:n.signal)===null?e=void 0:e=n==null?void 0:n.signal,{...n,signal:e}}class Az{constructor({helia:e,ipns:t},r){l(this,"helia");l(this,"ipns");l(this,"log");l(this,"contentTypeParser");l(this,"blockstoreSessions");l(this,"serverTimingHeaders",[]);l(this,"withServerTiming");l(this,"plugins",[]);var a;this.helia=e,this.log=e.logger.forComponent("helia:verified-fetch"),this.ipns=t??XM(e),this.contentTypeParser=(r==null?void 0:r.contentTypeParser)??uV,this.blockstoreSessions=new Hv({maxSize:(r==null?void 0:r.sessionCacheSize)??Sz,maxAge:(r==null?void 0:r.sessionTTLms)??Ez,onEviction:(c,u)=>{u.close()}}),this.withServerTiming=(r==null?void 0:r.withServerTiming)??!1;const i={...r,logger:kE("helia:verified-fetch"),getBlockstore:(c,u,d,h)=>this.getBlockstore(c,u,d,h),handleServerTiming:async(c,u,d)=>this.handleServerTiming(c,u,d,this.withServerTiming),helia:e,contentTypeParser:this.contentTypeParser},s=[new fV(i),new cU(i),new gV(i),new SU(i),new bV(i),new YV(i),new mV(i),new lF(i),new hV(i)],o=((a=r==null?void 0:r.plugins)==null?void 0:a.map(c=>c(i)))??[];if(o.length>0){const c=new Map(s.map(d=>[d.id,d])),u=new Map(o.map(d=>[d.id,d]));this.plugins=s.map(d=>u.get(d.id)??d),this.plugins.push(...o.filter(d=>!c.has(d.id)))}else this.plugins=s;this.log.trace("created VerifiedFetch instance")}getBlockstore(e,t,r=!0,i={}){const s=vz(t);if(!r)return this.helia.blockstore;let o=this.blockstoreSessions.get(s);return o==null&&(o=this.helia.blockstore.createSession(e,i),this.blockstoreSessions.set(s,o)),o}async handleServerTiming(e,t,r,i){if(!i)return r();const{error:s,result:o,header:a}=await Rp(e,t,r);if(this.serverTimingHeaders.push(a),s!=null)throw s;return o}handleFinalResponse(e,{query:t,cid:r,reqFormat:i,ttl:s,protocol:o,ipfsPath:a,pathDetails:c,byteRangeContext:u,options:d}={}){if(this.serverTimingHeaders.length>0){const f=this.serverTimingHeaders.join(", ");e.headers.set("Server-Timing",f),this.serverTimingHeaders=[]}if(e.headers.get("Transfer-Encoding")!=="chunked"&&u!=null){const f=u.getLength();f!=null&&(this.log.trace("Setting Content-Length from byteRangeContext: %d",f),e.headers.set("Content-Length",f.toString()))}let h;if(this.log.trace("checking for content disposition"),(t==null?void 0:t.download)===!0?h="attachment":this.log.trace("download not requested"),(t==null?void 0:t.filename)!=null?(h==null&&(h="inline"),h=`${h}; ${XV(t.filename)}`):this.log.trace("no filename specified in query"),h!=null?e.headers.set("Content-Disposition",h):this.log.trace("no content disposition specified"),r!=null&&e.headers.get("etag")==null&&e.headers.set("etag",HS({cid:(c==null?void 0:c.terminalElement.cid)??r,reqFormat:i,weak:!1})),o!=null&&tU({response:e,ttl:s,protocol:o}),a!=null&&e.headers.set("X-Ipfs-Path",a),e.headers.set("Access-Control-Allow-Origin","*"),e.headers.set("Access-Control-Allow-Methods","GET, HEAD, OPTIONS"),e.headers.set("Access-Control-Allow-Headers","Range, X-Requested-With"),e.headers.set("Access-Control-Expose-Headers","Content-Range, Content-Length, X-Ipfs-Path, X-Stream-Output"),i!=="car"?e.headers.set("Accept-Ranges","bytes"):e.headers.set("Accept-Ranges","none"),(d==null?void 0:d.method)==="HEAD"){const f=e==null?void 0:e.headers;return new Response(null,{status:200,headers:f})}return e}async runPluginPipeline(e,t=3){var a,c,u,d;let r,i=0;const s=new Set;let o=e.modified;for(;i<t;){this.log(`Starting pipeline pass #${i+1}`),i++;const h=this.plugins.filter(m=>!s.has(m.id)).filter(m=>m.canHandle(e));if(h.length===0){this.log.trace("No plugins can handle the current context.. checking by CID code");const m=this.plugins.filter(w=>w.codes.includes(e.cid.code));if(m.length>0)h.push(...m);else{this.log.trace("No plugins found that can handle request by CID code; exiting pipeline.");break}}this.log.trace("Plugins ready to handle request: ",h.map(m=>m.id).join(", "));let f=!1,p=!1;for(const m of h){try{this.log.trace("Invoking plugin:",m.id),s.add(m.id);const w=await m.handle(e);if(w!=null){r=w,p=!0;break}}catch(w){if((c=(a=e.options)==null?void 0:a.signal)!=null&&c.aborted)throw new Jn((d=(u=e.options)==null?void 0:u.signal)==null?void 0:d.reason);if(this.log.error("Error in plugin:",m.constructor.name,w),w.name==="PluginFatalError")return w.response??g3(e.resource,"Failed to fetch")}finally{const w=e.modified;f=w!==o,f&&(o=w)}if(r!=null){this.log.trace("Plugin produced final response:",m.id);break}}if(p&&r!=null)break;if(!f){this.log.trace("No context changes and no final response; exiting pipeline.");break}}return r}async fetch(e,t){var f,p,m,w,b;if(this.log("fetch %s",e),(t==null?void 0:t.method)==="OPTIONS")return this.handleFinalResponse(new Response(null,{status:200}));const r=xz(t),i=(r==null?void 0:r.withServerTiming)??this.withServerTiming;(f=r==null?void 0:r.onProgress)==null||f.call(r,new N("verified-fetch:request:start",{resource:e}));let s;try{s=await this.handleServerTiming("parse-resource","",async()=>bz(e,{ipns:this.ipns,logger:this.helia.logger},{withServerTiming:i,...r}),i),this.serverTimingHeaders.push(...s.serverTimings.map(({header:S})=>S))}catch(S){if((p=r==null?void 0:r.signal)!=null&&p.aborted)throw new Jn((m=r==null?void 0:r.signal)==null?void 0:m.reason);return this.log.error("error parsing resource %s",e,S),this.handleFinalResponse(cp(e.toString(),S))}(w=r==null?void 0:r.onProgress)==null||w.call(r,new N("verified-fetch:request:resolve",{cid:s.cid,path:s.path}));const o=sz({query:s.query,headers:r==null?void 0:r.headers,logger:this.helia.logger}),a=ez(s.cid,o);if(this.log("output type %s",a),o!=null&&a==null)return this.handleFinalResponse(jc(e.toString()));const c=(a==null?void 0:a.split(";")[0])??"application/octet-stream",u=await wz({resource:e,options:r,logger:this.helia.logger,cid:s.cid});if(u!=null)return this.handleFinalResponse(u);const d={...s,resource:e.toString(),accept:a,options:r,withServerTiming:i,onProgress:r==null?void 0:r.onProgress,modified:0,plugins:this.plugins.map(S=>S.id)};this.log.trace('finding handler for cid code "%s" and response content type "%s"',s.cid.code,c);const h=await this.runPluginPipeline(d);return(b=r==null?void 0:r.onProgress)==null||b.call(r,new N("verified-fetch:request:end",{cid:s.cid,path:s.path})),this.handleFinalResponse(h??Gv(e.toString()),d)}async start(){await this.helia.start()}async stop(){await this.helia.stop()}}let ni;const O3=async function(e,t){return ni==null&&(ni=await kz()),ni(e,t)};O3.start=async function(){await(ni==null?void 0:ni.start())};O3.stop=async function(){await(ni==null?void 0:ni.stop())};async function kz(n,e){let t;if(!_z(n)){const s=Iz(n==null?void 0:n.dnsResolvers),o=HM();o.dns=s;const a=(n==null?void 0:n.routers)??["https://delegated-ipfs.dev"];for(let d=0;d<a.length;d++){const h=a[d];o.services[`delegatedRouting${d}`]=()=>d9(h)}(n==null?void 0:n.libp2pConfig)!=null&&Object.assign(o,n.libp2pConfig),t=await $9(o);const c=[D7()],u=[g9(t)];((n==null?void 0:n.gateways)==null||n.gateways.length>0)&&(c.push(Z7({allowInsecure:n==null?void 0:n.allowInsecure,allowLocal:n==null?void 0:n.allowLocal})),u.push(p9({gateways:(n==null?void 0:n.gateways)??["https://trustless-gateway.link"]}))),n=await $M({libp2p:t,blockBrokers:c,dns:s,routers:u,hashers:n==null?void 0:n.hashers}),n.logger.forComponent("helia:verified-fetch").trace("created verified-fetch with libp2p config: %j",o)}const r=new Az({helia:n},e);async function i(s,o){return r.fetch(s,o)}return i.start=r.start.bind(r),i.stop=r.stop.bind(r),i}function _z(n){return(n==null?void 0:n.blockstore)!=null&&(n==null?void 0:n.datastore)!=null&&(n==null?void 0:n.gc)!=null&&(n==null?void 0:n.stop)!=null&&(n==null?void 0:n.start)!=null}function Iz(n){if(n!=null)return Array.isArray(n)?Xu({resolvers:{".":n}}):Xu({resolvers:n})}async function EW(n){const e=$u();n=n.filter(Boolean);const t=n.pop();await Promise.all(n.map(async r=>{const i=e.session();try{await i.run(`
        MATCH (e) WHERE elementId(e) = $equivId
        MATCH (t) WHERE elementId(t) = $targetId
        MERGE (e)-[eq:EQUALS]->(t)
        ON CREATE SET eq.mimis_id = $uuid
        RETURN $uuid
      `,{equivId:r,targetId:t,uuid:Hu()})}finally{i.close()}}))}async function xW({path:n}){const e=$u().session();try{const t="MERGE (r:Root) RETURN elementId(r) AS id",{records:[r]}=await e.run(t);let i=r.get("id");const s=[...n];for(;s.length>0;){const o=s.shift(),a=`
        MATCH (base) WHERE elementId(base) = $current
        MERGE (base)-[cont:CONTAINS { path: $elem }]->(node:Spot)
        ON CREATE SET cont.mimis_id = $contUUID
        ON CREATE SET node.mimis_id = $nodeUUID
        RETURN elementId(node) AS id
      `,{records:[c]}=await e.run(a,{current:i,elem:o,contUUID:Hu(),nodeUUID:Hu()});i=c.get("id")}return i}finally{e.close()}}const Cz={sha256:async(n,{base:e=64}={})=>(typeof n=="string"&&(n=new TextEncoder().encode(n)),await ut.digest(n))};class qS{constructor(){l(this,"ops",new Map);l(this,"rec");l(this,"exec");l(this,"last",null);l(this,"car",{readable:null,writable:null,writer:null});l(this,"blocks",[]);this.rec=this.record.bind(this),this.exec=this.execute.bind(this),this.reset()}reset(){const{readable:e,writable:t}=new TransformStream;this.car.readable=e,this.car.writable=t,this.car.writer=t.getWriter();const r=this.blocks;this.car.readable.pipeTo(new WritableStream({write(i){r.push(i)}}))}async record({statement:e,params:t}){const r={statement:e.trim(),at:new Date().toISOString(),mmid:Hu()};t&&(r.params=t),this.last&&(r.previous=this.last),console.debug({Encoding:r});const i=await i8(r),s=await Cz.sha256(i);return this.last=le.create(1,oi,s),this.ops.set(this.last.toString(),r),this.car.writer!=null&&await this.car.writer.write({cid:this.last,bytes:i}),r}set recording(e){e?this.car.writer||this.reset():this.car.writer=null}async execute({statement:e,params:t},{session:r=null,record:i=null}={}){i==null&&(i=!!this.car.writer);let s=!1;r==null&&(r=$u().session(),s=!0);try{return i&&await this.record({statement:e,params:t}),console.debug({Running:{statement:e,params:t}}),await r.run(e,t)}finally{s&&(console.debug({Closing:r}),r.close())}}async run(){const t=$u().session();try{if(this.last){let r=this.ops.get(this.last.toString())??null;do r&&(await this.execute(r,{session:t}),r=r.previous!=null?this.ops.get(r.previous.toString())??null:null);while(r)}}finally{t.close()}}generateCAR(){return Tz(this.blocks)}static async fromCID(e){typeof e=="string"&&(e=le.parse(e));const t=new qS;let r=500,i=e;do{const o=await(await O3(`ipfs://${i.toString()}`)).arrayBuffer(),a=mh(o);console.debug({max:r,cid:e.toString(),op:a}),t.ops.set(e.toString(),a),t.last==null&&(t.last=e),i=a.previous??null}while(i!=null&&r-- >0);return t}}async function Tz(n,{log:e=null}={}){e==null||e("Generating CAR URL");const t=[...n],r=new ReadableStream({pull(o){t.length>0?o.enqueue(t.shift()):o.close()}});if(!t||t.length===0)throw new Error("No blocks generated.");const i=t.at(-1);if(!i)throw new Error("No root block found.");const s=[];return await r.pipeThrough(new _E([i.cid])).pipeTo(new WritableStream({write(o){s.push(o)}})),{url:URL.createObjectURL(new Blob(s)),cid:i.cid}}export{qS as R,xW as c,EW as e,Tz as g};
