import{ct as E,cu as P,cv as u,cw as l,cx as y,cy as d,cz as f,cA as g,cB as C,cC as b,cD as p,cE as h,cF as w,cG as S,cH as k,cI as U,cJ as x}from"./DgjbO070.js";const N=0,A={paymentAsset:null,amount:null,tokenAmount:0,priceLoading:!1,error:null,exchanges:[],isLoading:!1,currentPayment:void 0,isPaymentInProgress:!1,paymentId:"",assets:[]},e=E(A),o={state:e,subscribe(t){return x(e,()=>t(e))},subscribeKey(t,s){return U(e,t,s)},resetState(){Object.assign(e,{...A})},async getAssetsForNetwork(t){const s=k(t),r=await o.getAssetsImageAndPrice(s),n=s.map(a=>{const i=a.asset==="native"?w():`${a.network}:${a.asset}`,c=r.find(m=>m.fungibles?.[0]?.address?.toLowerCase()===i.toLowerCase());return{...a,price:c?.fungibles?.[0]?.price||1,metadata:{...a.metadata,iconUrl:c?.fungibles?.[0]?.iconUrl}}});return e.assets=n,n},async getAssetsImageAndPrice(t){const s=t.map(n=>n.asset==="native"?w():`${n.network}:${n.asset}`);return await Promise.all(s.map(n=>S.fetchTokenPrice({addresses:[n]})))},getTokenAmount(){if(!e?.paymentAsset?.price)throw new Error("Cannot get token price");const t=h.bigNumber(e.amount??0).round(8),s=h.bigNumber(e.paymentAsset.price).round(8);return t.div(s).round(8).toNumber()},setAmount(t){e.amount=t,e.paymentAsset?.price&&(e.tokenAmount=o.getTokenAmount())},setPaymentAsset(t){e.paymentAsset=t},isPayWithExchangeEnabled(){return p.state.remoteFeatures?.payWithExchange||p.state.remoteFeatures?.payments||p.state.features?.pay},isPayWithExchangeSupported(){return o.isPayWithExchangeEnabled()&&u.state.activeCaipNetwork&&b.PAY_WITH_EXCHANGE_SUPPORTED_CHAIN_NAMESPACES.includes(u.state.activeCaipNetwork.chainNamespace)},async fetchExchanges(){try{const t=o.isPayWithExchangeSupported();if(!e.paymentAsset||!t){e.exchanges=[],e.isLoading=!1;return}e.isLoading=!0;const s=await C({page:N,asset:g(e.paymentAsset.network,e.paymentAsset.asset),amount:e.amount?.toString()??"0"});e.exchanges=s.exchanges.slice(0,2)}catch{throw d.showError("Unable to get exchanges"),new Error("Unable to get exchanges")}finally{e.isLoading=!1}},async getPayUrl(t,s){try{const r=Number(s.amount),n=await f({exchangeId:t,asset:g(s.network,s.asset),amount:r.toString(),recipient:`${s.network}:${s.recipient}`});return l.sendEvent({type:"track",event:"PAY_EXCHANGE_SELECTED",properties:{exchange:{id:t},configuration:{network:s.network,asset:s.asset,recipient:s.recipient,amount:r},currentPayment:{type:"exchange",exchangeId:t},source:"fund-from-exchange",headless:!1}}),n}catch(r){throw r instanceof Error&&r.message.includes("is not supported")?new Error("Asset not supported"):new Error(r.message)}},async handlePayWithExchange(t){try{const s=u.getAccountData()?.address;if(!s)throw new Error("No account connected");if(!e.paymentAsset)throw new Error("No payment asset selected");const r=y.returnOpenHref("","popupWindow","scrollbar=yes,width=480,height=720");if(!r)throw new Error("Could not create popup window");e.isPaymentInProgress=!0,e.paymentId=crypto.randomUUID(),e.currentPayment={type:"exchange",exchangeId:t};const{network:n,asset:a}=e.paymentAsset,i={network:n,asset:a,amount:e.tokenAmount,recipient:s},c=await o.getPayUrl(t,i);if(!c){try{r.close()}catch(m){console.error("Unable to close popup window",m)}throw new Error("Unable to initiate payment")}e.currentPayment.sessionId=c.sessionId,e.currentPayment.status="IN_PROGRESS",e.currentPayment.exchangeId=t,r.location.href=c.url}catch{e.error="Unable to initiate payment",d.showError(e.error)}},async waitUntilComplete({exchangeId:t,sessionId:s,paymentId:r,retries:n=20}){const a=await o.getBuyStatus(t,s,r);if(a.status==="SUCCESS"||a.status==="FAILED")return a;if(n===0)throw new Error("Unable to get deposit status");return await new Promise(i=>{setTimeout(i,5e3)}),o.waitUntilComplete({exchangeId:t,sessionId:s,paymentId:r,retries:n-1})},async getBuyStatus(t,s,r){try{if(!e.currentPayment)throw new Error("No current payment");const n=await P({sessionId:s,exchangeId:t});if(e.currentPayment.status=n.status,n.status==="SUCCESS"||n.status==="FAILED"){const a=u.getAccountData()?.address;e.currentPayment.result=n.txHash,e.isPaymentInProgress=!1,l.sendEvent({type:"track",event:n.status==="SUCCESS"?"PAY_SUCCESS":"PAY_ERROR",properties:{message:n.status==="FAILED"?y.parseError(e.error):void 0,source:"fund-from-exchange",paymentId:r,configuration:{network:e.paymentAsset?.network||"",asset:e.paymentAsset?.asset||"",recipient:a||"",amount:e.amount??0},currentPayment:{type:"exchange",exchangeId:e.currentPayment?.exchangeId,sessionId:e.currentPayment?.sessionId,result:n.txHash}}})}return n}catch{return{status:"UNKNOWN",txHash:""}}},reset(){e.currentPayment=void 0,e.isPaymentInProgress=!1,e.paymentId="",e.paymentAsset=null,e.amount=0,e.tokenAmount=0,e.priceLoading=!1,e.error=null,e.exchanges=[],e.isLoading=!1}};export{o as E};
