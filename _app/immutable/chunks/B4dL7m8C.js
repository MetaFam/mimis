import{d as E,a as x,C as V}from"./BaF23LuM.js";import{v as f}from"./BPy83UG7.js";const g={SHA2_256:18,LENGTH:32,DAG_PB:112},O=40;function w(e,n){if(!e.length)throw new Error("Unexpected end of data");const t=f.decode(e);return n.seek(f.decode.bytes),t}function R(e){const n=new DataView(e.buffer,e.byteOffset,e.byteLength);let t=0;return{version:2,characteristics:[n.getBigUint64(t,!0),n.getBigUint64(t+=8,!0)],dataOffset:Number(n.getBigUint64(t+=8,!0)),dataSize:Number(n.getBigUint64(t+=8,!0)),indexOffset:Number(n.getBigUint64(t+=8,!0))}}function U(e){f.decode(e);const n=f.decode.bytes,t=f.decode(e.subarray(f.decode.bytes)),r=f.decode.bytes;return n+r+t}const l={Null:e=>e===null?e:void 0,Int:e=>Number.isInteger(e)?e:void 0,Float:e=>typeof e=="number"&&Number.isFinite(e)?e:void 0,String:e=>typeof e=="string"?e:void 0,Bool:e=>typeof e=="boolean"?e:void 0,Bytes:e=>e instanceof Uint8Array?e:void 0,Link:e=>e!==null&&typeof e=="object"&&e.asCID===e?e:void 0,List:e=>Array.isArray(e)?e:void 0,Map:e=>e!==null&&typeof e=="object"&&e.asCID!==e&&!Array.isArray(e)&&!(e instanceof Uint8Array)?e:void 0},y={"CarV1HeaderOrV2Pragma > roots (anon) > valueType (anon)":l.Link,"CarV1HeaderOrV2Pragma > roots (anon)":e=>{if(l.List(e)!==void 0){for(let n=0;n<e.length;n++){let t=e[n];if(t=y["CarV1HeaderOrV2Pragma > roots (anon) > valueType (anon)"](t),t===void 0)return;if(t!==e[n]){const r=e.slice(0,n);for(let a=n;a<e.length;a++){let i=e[a];if(i=y["CarV1HeaderOrV2Pragma > roots (anon) > valueType (anon)"](i),i===void 0)return;r.push(i)}return r}}return e}},Int:l.Int,CarV1HeaderOrV2Pragma:e=>{if(l.Map(e)===void 0)return;const n=Object.entries(e);let t=e,r=1;for(let a=0;a<n.length;a++){const[i,o]=n[a];switch(i){case"roots":{const s=y["CarV1HeaderOrV2Pragma > roots (anon)"](e[i]);if(s===void 0)return;if(s!==o||t!==e){if(t===e){t={};for(let u=0;u<a;u++)t[n[u][0]]=n[u][1]}t.roots=s}}break;case"version":{r--;const s=y.Int(e[i]);if(s===void 0)return;if(s!==o||t!==e){if(t===e){t={};for(let u=0;u<a;u++)t[n[u][0]]=n[u][1]}t.version=s}}break;default:return}}if(!(r>0))return t}},h={"CarV1HeaderOrV2Pragma > roots (anon) > valueType (anon)":l.Link,"CarV1HeaderOrV2Pragma > roots (anon)":e=>{if(l.List(e)!==void 0){for(let n=0;n<e.length;n++){let t=e[n];if(t=h["CarV1HeaderOrV2Pragma > roots (anon) > valueType (anon)"](t),t===void 0)return;if(t!==e[n]){const r=e.slice(0,n);for(let a=n;a<e.length;a++){let i=e[a];if(i=h["CarV1HeaderOrV2Pragma > roots (anon) > valueType (anon)"](i),i===void 0)return;r.push(i)}return r}}return e}},Int:l.Int,CarV1HeaderOrV2Pragma:e=>{if(l.Map(e)===void 0)return;const n=Object.entries(e);let t=e,r=1;for(let a=0;a<n.length;a++){const[i,o]=n[a];switch(i){case"roots":{const s=h["CarV1HeaderOrV2Pragma > roots (anon)"](o);if(s===void 0)return;if(s!==o||t!==e){if(t===e){t={};for(let u=0;u<a;u++)t[n[u][0]]=n[u][1]}t.roots=s}}break;case"version":{r--;const s=h.Int(o);if(s===void 0)return;if(s!==o||t!==e){if(t===e){t={};for(let u=0;u<a;u++)t[n[u][0]]=n[u][1]}t.version=s}}break;default:return}}if(!(r>0))return t}},B={toTyped:y.CarV1HeaderOrV2Pragma,toRepresentation:h.CarV1HeaderOrV2Pragma};async function I(e,n){const t=w(await e.upTo(8),e);if(t===0)throw new Error("Invalid CAR header (zero length)");const r=await e.exactly(t,!0),a=E(r);if(B.toTyped(a)===void 0)throw new Error("Invalid CAR header format");if(a.version!==1&&a.version!==2||n!==void 0&&a.version!==n)throw new Error(`Invalid CAR version: ${a.version}${n!==void 0?` (expected ${n})`:""}`);if(a.version===1){if(!Array.isArray(a.roots))throw new Error("Invalid CAR header format");return a}if(a.roots!==void 0)throw new Error("Invalid CAR header format");const i=R(await e.exactly(O,!0));e.seek(i.dataOffset-e.pos);const o=await I(e,1);return Object.assign(o,i)}async function L(e){const n=await e.exactly(2,!1);if(n[0]===g.SHA2_256&&n[1]===g.LENGTH){const o=await e.exactly(34,!0),s=x(o);return V.create(0,g.DAG_PB,s)}const t=w(await e.upTo(8),e);if(t!==1)throw new Error(`Unexpected CID version (${t})`);const r=w(await e.upTo(8),e),a=await e.exactly(U(await e.upTo(8)),!0),i=x(a);return V.create(t,r,i)}async function H(e){const n=e.pos;let t=w(await e.upTo(8),e);if(t===0)throw new Error("Invalid CAR section (zero length)");t+=e.pos-n;const r=await L(e),a=t-Number(e.pos-n);return{cid:r,length:t,blockLength:a}}async function P(e){const{cid:n,blockLength:t}=await H(e);return{bytes:await e.exactly(t,!0),cid:n}}async function _(e){const n=e.pos,{cid:t,length:r,blockLength:a}=await H(e),i={cid:t,length:r,blockLength:a,offset:n,blockOffset:e.pos};return e.seek(i.blockLength),i}function S(e){const n=(async()=>{const t=await I(e);if(t.version===2){const r=e.pos-t.dataOffset;e=q(e,t.dataSize-r)}return t})();return{header:()=>n,async*blocks(){for(await n;(await e.upTo(8)).length>0;)yield await P(e)},async*blocksIndex(){for(await n;(await e.upTo(8)).length>0;)yield await _(e)}}}function D(e){let n=0;return{async upTo(t){return e.subarray(n,n+Math.min(t,e.length-n))},async exactly(t,r=!1){if(t>e.length-n)throw new Error("Unexpected end of data");const a=e.subarray(n,n+t);return r&&(n+=t),a},seek(t){n+=t},get pos(){return n}}}function N(e){let n=0,t=0,r=0,a=new Uint8Array(0);const i=async o=>{t=a.length-r;const s=[a.subarray(r)];for(;t<o;){const d=await e();if(d==null)break;t<0?d.length>t&&s.push(d.subarray(-t)):s.push(d),t+=d.length}a=new Uint8Array(s.reduce((d,A)=>d+A.length,0));let u=0;for(const d of s)a.set(d,u),u+=d.length;r=0};return{async upTo(o){return a.length-r<o&&await i(o),a.subarray(r,r+Math.min(a.length-r,o))},async exactly(o,s=!1){if(a.length-r<o&&await i(o),a.length-r<o)throw new Error("Unexpected end of data");const u=a.subarray(r,r+o);return s&&(n+=o,r+=o),u},seek(o){n+=o,r+=o},get pos(){return n}}}function $(e){const n=e[Symbol.asyncIterator]();async function t(){const r=await n.next();return r.done?null:r.value}return N(t)}function q(e,n){let t=0;return{async upTo(r){let a=await e.upTo(r);return a.length+t>n&&(a=a.subarray(0,n-t)),a},async exactly(r,a=!1){const i=await e.exactly(r,a);if(i.length+t>n)throw new Error("Unexpected end of data");return a&&(t+=r),i},seek(r){t+=r,e.seek(r)},get pos(){return e.pos}}}class M{constructor(n,t,r){this._version=n,this._roots=t,this._iterable=r,this._decoded=!1}get version(){return this._version}async getRoots(){return this._roots}}class v extends M{[Symbol.asyncIterator](){if(this._decoded)throw new Error("Cannot decode more than once");if(!this._iterable)throw new Error("Block iterable not found");return this._decoded=!0,this._iterable[Symbol.asyncIterator]()}static async fromBytes(n){const{version:t,roots:r,iterator:a}=await G(n);return new v(t,r,a)}static async fromIterable(n){const{version:t,roots:r,iterator:a}=await z(n);return new v(t,r,a)}}async function G(e){if(!(e instanceof Uint8Array))throw new TypeError("fromBytes() requires a Uint8Array");return T(D(e))}async function z(e){if(!e||typeof e[Symbol.asyncIterator]!="function")throw new TypeError("fromIterable() requires an async iterable");return T($(e))}async function T(e){const n=S(e),{version:t,roots:r}=await n.header();return{version:t,roots:r,iterator:n.blocks()}}const c=[];for(let e=0;e<256;++e)c.push((e+256).toString(16).slice(1));function F(e,n=0){return(c[e[n+0]]+c[e[n+1]]+c[e[n+2]]+c[e[n+3]]+"-"+c[e[n+4]]+c[e[n+5]]+"-"+c[e[n+6]]+c[e[n+7]]+"-"+c[e[n+8]]+c[e[n+9]]+"-"+c[e[n+10]]+c[e[n+11]]+c[e[n+12]]+c[e[n+13]]+c[e[n+14]]+c[e[n+15]]).toLowerCase()}let p;const K=new Uint8Array(16);function C(){if(!p){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");p=crypto.getRandomValues.bind(crypto)}return p(K)}const m={};function W(e,n,t){var a;let r;if(e)r=k(e.random??((a=e.rng)==null?void 0:a.call(e))??C(),e.msecs,e.seq,n,t);else{const i=Date.now(),o=C();Y(m,i,o),r=k(o,m.msecs,m.seq,n,t)}return n??F(r)}function Y(e,n,t){return e.msecs??(e.msecs=-1/0),e.seq??(e.seq=0),n>e.msecs?(e.seq=t[6]<<23|t[7]<<16|t[8]<<8|t[9],e.msecs=n):(e.seq=e.seq+1|0,e.seq===0&&e.msecs++),e}function k(e,n,t,r,a=0){if(e.length<16)throw new Error("Random bytes length must be >= 16");if(!r)r=new Uint8Array(16),a=0;else if(a<0||a+16>r.length)throw new RangeError(`UUID byte range ${a}:${a+15} is out of buffer bounds`);return n??(n=Date.now()),t??(t=e[6]*127<<24|e[7]<<16|e[8]<<8|e[9]),r[a++]=n/1099511627776&255,r[a++]=n/4294967296&255,r[a++]=n/16777216&255,r[a++]=n/65536&255,r[a++]=n/256&255,r[a++]=n&255,r[a++]=112|t>>>28&15,r[a++]=t>>>20&255,r[a++]=128|t>>>14&63,r[a++]=t>>>6&255,r[a++]=t<<2&255|e[10]&3,r[a++]=e[11],r[a++]=e[12],r[a++]=e[13],r[a++]=e[14],r[a++]=e[15],r}export{v as C,O as V,B as a,R as b,g as c,w as d,D as e,U as g,I as r,W as v};
