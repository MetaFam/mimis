var M=Object.defineProperty;var $=(e,t,n)=>t in e?M(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var p=(e,t,n)=>$(e,typeof t!="symbol"?t+"":t,n);import{C as d,m as z,q,b as W,f as H,e as G}from"./CXtfRil7.js";import{h as F}from"./CKxxabAx.js";import{v as h}from"./DZQaga-d.js";const l=[];for(let e=0;e<256;++e)l.push((e+256).toString(16).slice(1));function J(e,t=0){return(l[e[t+0]]+l[e[t+1]]+l[e[t+2]]+l[e[t+3]]+"-"+l[e[t+4]]+l[e[t+5]]+"-"+l[e[t+6]]+l[e[t+7]]+"-"+l[e[t+8]]+l[e[t+9]]+"-"+l[e[t+10]]+l[e[t+11]]+l[e[t+12]]+l[e[t+13]]+l[e[t+14]]+l[e[t+15]]).toLowerCase()}let E;const K=new Uint8Array(16);function Q(){if(!E){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");E=crypto.getRandomValues.bind(crypto)}return E(K)}const I={};function Ee(e,t,n){let r;{const i=Date.now(),o=Q();Y(I,i,o),r=X(o,I.msecs,I.seq,t,n)}return t??J(r)}function Y(e,t,n){return e.msecs??(e.msecs=-1/0),e.seq??(e.seq=0),t>e.msecs?(e.seq=n[6]<<23|n[7]<<16|n[8]<<8|n[9],e.msecs=t):(e.seq=e.seq+1|0,e.seq===0&&e.msecs++),e}function X(e,t,n,r,i=0){if(e.length<16)throw new Error("Random bytes length must be >= 16");if(!r)r=new Uint8Array(16),i=0;else if(i<0||i+16>r.length)throw new RangeError(`UUID byte range ${i}:${i+15} is out of buffer bounds`);return t??(t=Date.now()),n??(n=e[6]*127<<24|e[7]<<16|e[8]<<8|e[9]),r[i++]=t/1099511627776&255,r[i++]=t/4294967296&255,r[i++]=t/16777216&255,r[i++]=t/65536&255,r[i++]=t/256&255,r[i++]=t&255,r[i++]=112|n>>>28&15,r[i++]=n>>>20&255,r[i++]=128|n>>>14&63,r[i++]=n>>>6&255,r[i++]=n<<2&255|e[10]&3,r[i++]=e[11],r[i++]=e[12],r[i++]=e[13],r[i++]=e[14],r[i++]=e[15],r}function v({enumerable:e=!0,configurable:t=!1}={}){return{enumerable:e,configurable:t,writable:!1}}function*Z(e,t){if(t!=null&&typeof t=="object")if(Array.isArray(t))for(const[n,r]of t.entries()){const i=[...e,n],o=d.asCID(r);o!=null?yield[i.join("/"),o]:typeof r=="object"&&(yield*A(r,i))}else{const n=d.asCID(t);n!=null?yield[e.join("/"),n]:yield*A(t,e)}}function*A(e,t){if(e==null||e instanceof Uint8Array)return;const n=d.asCID(e);n!=null&&(yield[t.join("/"),n]);for(const[r,i]of Object.entries(e)){const o=[...t,r];yield*Z(o,i)}}function*j(e,t){if(Array.isArray(t))for(const[n,r]of t.entries()){const i=[...e,n];yield i.join("/"),typeof r=="object"&&d.asCID(r)==null&&(yield*R(r,i))}else yield*R(t,e)}function*R(e,t){if(!(e==null||typeof e!="object"))for(const[n,r]of Object.entries(e)){const i=[...t,n];yield i.join("/"),r!=null&&!(r instanceof Uint8Array)&&typeof r=="object"&&d.asCID(r)==null&&(yield*j(i,r))}}function ee(e,t){let n=e;for(const[r,i]of t.entries()){if(n=n[i],n==null)throw new Error(`Object has no property at ${t.slice(0,r+1).map(a=>`[${JSON.stringify(a)}]`).join("")}`);const o=d.asCID(n);if(o!=null)return{value:o,remaining:t.slice(r+1).join("/")}}return{value:n}}class te{constructor({cid:t,bytes:n,value:r}){p(this,"cid");p(this,"bytes");p(this,"value");p(this,"asBlock");if(t==null||n==null||typeof r>"u")throw new Error("Missing required argument");this.cid=t,this.bytes=n,this.value=r,this.asBlock=this,Object.defineProperties(this,{cid:v(),bytes:v(),value:v(),asBlock:v()})}links(){return A(this.value,[])}tree(){return R(this.value,[])}get(t="/"){return ee(this.value,t.split("/").filter(Boolean))}}function Ie({bytes:e,cid:t,value:n,codec:r}){const i=n!==void 0?n:r==null?void 0:r.decode(e);if(i===void 0)throw new Error('Missing required argument, must either provide "value" or "codec"');return new te({cid:t,bytes:e,value:i})}function ke(){const e={};return e.promise=new Promise((t,n)=>{e.resolve=t,e.reject=n}),e}var P={};function f(e,t){typeof t=="boolean"&&(t={forever:t}),this._originalTimeouts=JSON.parse(JSON.stringify(e)),this._timeouts=e,this._options=t||{},this._maxRetryTime=t&&t.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}var ne=f;f.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)};f.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null};f.prototype.retry=function(e){if(this._timeout&&clearTimeout(this._timeout),!e)return!1;var t=new Date().getTime();if(e&&t-this._operationStart>=this._maxRetryTime)return this._errors.push(e),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(e);var n=this._timeouts.shift();if(n===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),n=this._cachedTimeouts.slice(-1);else return!1;var r=this;return this._timer=setTimeout(function(){r._attempts++,r._operationTimeoutCb&&(r._timeout=setTimeout(function(){r._operationTimeoutCb(r._attempts)},r._operationTimeout),r._options.unref&&r._timeout.unref()),r._fn(r._attempts)},n),this._options.unref&&this._timer.unref(),!0};f.prototype.attempt=function(e,t){this._fn=e,t&&(t.timeout&&(this._operationTimeout=t.timeout),t.cb&&(this._operationTimeoutCb=t.cb));var n=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){n._operationTimeoutCb()},n._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)};f.prototype.try=function(e){console.log("Using RetryOperation.try() is deprecated"),this.attempt(e)};f.prototype.start=function(e){console.log("Using RetryOperation.start() is deprecated"),this.attempt(e)};f.prototype.start=f.prototype.try;f.prototype.errors=function(){return this._errors};f.prototype.attempts=function(){return this._attempts};f.prototype.mainError=function(){if(this._errors.length===0)return null;for(var e={},t=null,n=0,r=0;r<this._errors.length;r++){var i=this._errors[r],o=i.message,a=(e[o]||0)+1;e[o]=a,a>=n&&(t=i,n=a)}return t};(function(e){var t=ne;e.operation=function(n){var r=e.timeouts(n);return new t(r,{forever:n&&(n.forever||n.retries===1/0),unref:n&&n.unref,maxRetryTime:n&&n.maxRetryTime})},e.timeouts=function(n){if(n instanceof Array)return[].concat(n);var r={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var i in n)r[i]=n[i];if(r.minTimeout>r.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var o=[],a=0;a<r.retries;a++)o.push(this.createTimeout(a,r));return n&&n.forever&&!o.length&&o.push(this.createTimeout(a,r)),o.sort(function(s,u){return s-u}),o},e.createTimeout=function(n,r){var i=r.randomize?Math.random()+1:1,o=Math.round(i*Math.max(r.minTimeout,1)*Math.pow(r.factor,n));return o=Math.min(o,r.maxTimeout),o},e.wrap=function(n,r,i){if(r instanceof Array&&(i=r,r=null),!i){i=[];for(var o in n)typeof n[o]=="function"&&i.push(o)}for(var a=0;a<i.length;a++){var s=i[a],u=n[s];n[s]=(function(m){var x=e.operation(r),C=Array.prototype.slice.call(arguments,1),N=C.pop();C.push(function(D){x.retry(D)||(D&&(arguments[0]=x.mainError()),N.apply(this,arguments))}),x.attempt(function(){m.apply(n,C)})}).bind(n,u),n[s].options=r}}})(P);var re=P;const Ae=F(re),k={SHA2_256:18,LENGTH:32,DAG_PB:112},ie=40;function T(e,t){if(!e.length)throw new Error("Unexpected end of data");const n=h.decode(e);return t.seek(h.decode.bytes),n}function oe(e){const t=new DataView(e.buffer,e.byteOffset,e.byteLength);let n=0;return{version:2,characteristics:[t.getBigUint64(n,!0),t.getBigUint64(n+=8,!0)],dataOffset:Number(t.getBigUint64(n+=8,!0)),dataSize:Number(t.getBigUint64(n+=8,!0)),indexOffset:Number(t.getBigUint64(n+=8,!0))}}function ae(e){h.decode(e);const t=h.decode.bytes,n=h.decode(e.subarray(h.decode.bytes)),r=h.decode.bytes;return t+r+n}const y={Null:e=>e===null?e:void 0,Int:e=>Number.isInteger(e)?e:void 0,Float:e=>typeof e=="number"&&Number.isFinite(e)?e:void 0,String:e=>typeof e=="string"?e:void 0,Bool:e=>typeof e=="boolean"?e:void 0,Bytes:e=>e instanceof Uint8Array?e:void 0,Link:e=>e!==null&&typeof e=="object"&&e.asCID===e?e:void 0,List:e=>Array.isArray(e)?e:void 0,Map:e=>e!==null&&typeof e=="object"&&e.asCID!==e&&!Array.isArray(e)&&!(e instanceof Uint8Array)?e:void 0},w={"CarV1HeaderOrV2Pragma > roots (anon) > valueType (anon)":y.Link,"CarV1HeaderOrV2Pragma > roots (anon)":e=>{if(y.List(e)!==void 0){for(let t=0;t<e.length;t++){let n=e[t];if(n=w["CarV1HeaderOrV2Pragma > roots (anon) > valueType (anon)"](n),n===void 0)return;if(n!==e[t]){const r=e.slice(0,t);for(let i=t;i<e.length;i++){let o=e[i];if(o=w["CarV1HeaderOrV2Pragma > roots (anon) > valueType (anon)"](o),o===void 0)return;r.push(o)}return r}}return e}},Int:y.Int,CarV1HeaderOrV2Pragma:e=>{if(y.Map(e)===void 0)return;const t=Object.entries(e);let n=e,r=1;for(let i=0;i<t.length;i++){const[o,a]=t[i];switch(o){case"roots":{const s=w["CarV1HeaderOrV2Pragma > roots (anon)"](e[o]);if(s===void 0)return;if(s!==a||n!==e){if(n===e){n={};for(let u=0;u<i;u++)n[t[u][0]]=t[u][1]}n.roots=s}}break;case"version":{r--;const s=w.Int(e[o]);if(s===void 0)return;if(s!==a||n!==e){if(n===e){n={};for(let u=0;u<i;u++)n[t[u][0]]=t[u][1]}n.version=s}}break;default:return}}if(!(r>0))return n}},g={"CarV1HeaderOrV2Pragma > roots (anon) > valueType (anon)":y.Link,"CarV1HeaderOrV2Pragma > roots (anon)":e=>{if(y.List(e)!==void 0){for(let t=0;t<e.length;t++){let n=e[t];if(n=g["CarV1HeaderOrV2Pragma > roots (anon) > valueType (anon)"](n),n===void 0)return;if(n!==e[t]){const r=e.slice(0,t);for(let i=t;i<e.length;i++){let o=e[i];if(o=g["CarV1HeaderOrV2Pragma > roots (anon) > valueType (anon)"](o),o===void 0)return;r.push(o)}return r}}return e}},Int:y.Int,CarV1HeaderOrV2Pragma:e=>{if(y.Map(e)===void 0)return;const t=Object.entries(e);let n=e,r=1;for(let i=0;i<t.length;i++){const[o,a]=t[i];switch(o){case"roots":{const s=g["CarV1HeaderOrV2Pragma > roots (anon)"](a);if(s===void 0)return;if(s!==a||n!==e){if(n===e){n={};for(let u=0;u<i;u++)n[t[u][0]]=t[u][1]}n.roots=s}}break;case"version":{r--;const s=g.Int(a);if(s===void 0)return;if(s!==a||n!==e){if(n===e){n={};for(let u=0;u<i;u++)n[t[u][0]]=t[u][1]}n.version=s}}break;default:return}}if(!(r>0))return n}},se={toTyped:w.CarV1HeaderOrV2Pragma,toRepresentation:g.CarV1HeaderOrV2Pragma},ue=z(),ce={float64:!1,quickEncodeToken:q};function le(e,t=ue,n=ce){if(Array.isArray(e)){let r=0;for(const i of e)r+=le(i,t,n);return r}else{const r=t[e.type.major];if(r.encodedSize===void 0||typeof r.encodedSize!="function")throw new Error(`Encoder for ${e.type.name} does not have an encodedSize()`);return r.encodedSize(e,n)}}async function O(e,t){const n=T(await e.upTo(8),e);if(n===0)throw new Error("Invalid CAR header (zero length)");const r=await e.exactly(n,!0),i=W(r);if(se.toTyped(i)===void 0)throw new Error("Invalid CAR header format");if(i.version!==1&&i.version!==2||t!==void 0&&i.version!==t)throw new Error(`Invalid CAR version: ${i.version}${t!==void 0?` (expected ${t})`:""}`);if(i.version===1){if(!Array.isArray(i.roots))throw new Error("Invalid CAR header format");return i}if(i.roots!==void 0)throw new Error("Invalid CAR header format");const o=oe(await e.exactly(ie,!0));e.seek(o.dataOffset-e.pos);const a=await O(e,1);return Object.assign(a,o)}async function fe(e){const t=await e.exactly(2,!1);if(t[0]===k.SHA2_256&&t[1]===k.LENGTH){const a=await e.exactly(34,!0),s=H(a);return d.create(0,k.DAG_PB,s)}const n=T(await e.upTo(8),e);if(n!==1)throw new Error(`Unexpected CID version (${n})`);const r=T(await e.upTo(8),e),i=await e.exactly(ae(await e.upTo(8)),!0),o=H(i);return d.create(n,r,o)}async function S(e){const t=e.pos;let n=T(await e.upTo(8),e);if(n===0)throw new Error("Invalid CAR section (zero length)");n+=e.pos-t;const r=await fe(e),i=n-Number(e.pos-t);return{cid:r,length:n,blockLength:i}}async function de(e){const{cid:t,blockLength:n}=await S(e);return{bytes:await e.exactly(n,!0),cid:t}}async function he(e){const t=e.pos,{cid:n,length:r,blockLength:i}=await S(e),o={cid:n,length:r,blockLength:i,offset:t,blockOffset:e.pos};return e.seek(o.blockLength),o}function Re(e){const t=(async()=>{const n=await O(e);if(n.version===2){const r=e.pos-n.dataOffset;e=pe(e,n.dataSize-r)}return n})();return{header:()=>t,async*blocks(){for(await t;(await e.upTo(8)).length>0;)yield await de(e)},async*blocksIndex(){for(await t;(await e.upTo(8)).length>0;)yield await he(e)}}}function ye(e){let t=0;return{async upTo(n){return e.subarray(t,t+Math.min(n,e.length-t))},async exactly(n,r=!1){if(n>e.length-t)throw new Error("Unexpected end of data");const i=e.subarray(t,t+n);return r&&(t+=n),i},seek(n){t+=n},get pos(){return t}}}function me(e){let t=0,n=0,r=0,i=new Uint8Array(0);const o=async a=>{n=i.length-r;const s=[i.subarray(r)];for(;n<a;){const c=await e();if(c==null)break;n<0?c.length>n&&s.push(c.subarray(-n)):s.push(c),n+=c.length}i=new Uint8Array(s.reduce((c,m)=>c+m.length,0));let u=0;for(const c of s)i.set(c,u),u+=c.length;r=0};return{async upTo(a){return i.length-r<a&&await o(a),i.subarray(r,r+Math.min(i.length-r,a))},async exactly(a,s=!1){if(i.length-r<a&&await o(a),i.length-r<a)throw new Error("Unexpected end of data");const u=i.subarray(r,r+a);return s&&(t+=a,r+=a),u},seek(a){t+=a,r+=a},get pos(){return t}}}function Ve(e){const t=e[Symbol.asyncIterator]();async function n(){const r=await t.next();return r.done?null:r.value}return me(n)}function pe(e,t){let n=0;return{async upTo(r){let i=await e.upTo(r);return i.length+n>t&&(i=i.subarray(0,t-n)),i},async exactly(r,i=!1){const o=await e.exactly(r,i);if(o.length+n>t)throw new Error("Unexpected end of data");return i&&(n+=r),o},seek(r){n+=r,e.seek(r)},get pos(){return e.pos}}}const L=1;function b(e){const t=G({version:L,roots:e}),n=h.encode(t.length),r=new Uint8Array(n.length+t.length);return r.set(n,0),r.set(t,n.length),r}function we(e){return{async setRoots(t){const n=b(t);await e.write(n)},async writeBlock(t){const{cid:n,bytes:r}=t;await e.write(new Uint8Array(h.encode(n.bytes.length+r.length))),await e.write(n.bytes),r.length&&await e.write(r)},async close(){await e.end()},version(){return L}}}function _(){}function ge(){const e=[];let t=null,n=_,r=!1,i=null,o=_;const a=()=>(t||(t=new Promise(c=>{n=()=>{t=null,n=_,c()}})),t),s={write(c){e.push(c);const m=a();return o(),m},async end(){r=!0;const c=a();o(),await c}},u={async next(){const c=e.shift();return c?(e.length===0&&n(),{done:!1,value:c}):r?(n(),{done:!0,value:void 0}):(i||(i=new Promise(m=>{o=()=>(i=null,o=_,m(u.next()))})),i)}};return{writer:s,iterator:u}}class V{constructor(t,n){this._encoder=n,this._mutex=n.setRoots(t),this._ended=!1}async put(t){if(!(t.bytes instanceof Uint8Array)||!t.cid)throw new TypeError("Can only write {cid, bytes} objects");if(this._ended)throw new Error("Already closed");const n=d.asCID(t.cid);if(!n)throw new TypeError("Can only write {cid, bytes} objects");return this._mutex=this._mutex.then(()=>this._encoder.writeBlock({cid:n,bytes:t.bytes})),this._mutex}async close(){if(this._ended)throw new Error("Already closed");return await this._mutex,this._ended=!0,this._encoder.close()}version(){return this._encoder.version()}static create(t){t=ve(t);const{encoder:n,iterator:r}=B(),i=new V(t,n),o=new U(r);return{writer:i,out:o}}static createAppender(){const{encoder:t,iterator:n}=B();t.setRoots=()=>Promise.resolve();const r=new V([],t),i=new U(n);return{writer:r,out:i}}static async updateRootsInBytes(t,n){const r=ye(t);await O(r);const i=b(n);if(Number(r.pos)!==i.length)throw new Error(`updateRoots() can only overwrite a header of the same length (old header is ${r.pos} bytes, new header is ${i.length} bytes)`);return t.set(i,0),t}}class U{constructor(t){this._iterator=t}[Symbol.asyncIterator](){if(this._iterating)throw new Error("Multiple iterator not supported");return this._iterating=!0,this._iterator}}function B(){const e=ge(),{writer:t,iterator:n}=e;return{encoder:we(t),iterator:n}}function ve(e){if(e===void 0)return[];if(!Array.isArray(e)){const n=d.asCID(e);if(!n)throw new TypeError("roots must be a single CID or an array of CIDs");return[n]}const t=[];for(const n of e){const r=d.asCID(n);if(!r)throw new TypeError("roots must be a single CID or an array of CIDs");t.push(r)}return t}export{te as B,se as C,ie as V,oe as a,k as b,Ve as c,T as d,Re as e,ye as f,ae as g,V as h,Ie as i,ke as p,Ae as r,le as t,Ee as v};
