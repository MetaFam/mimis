import{a as zt,g as Di,C as he,p as al,r as Li,s as Si,c as lw,k as ii,l as xi,t as c5,d as $0,e as l5}from"./C6yTcgQs.js";import{n as b1,o as uw,q as dw,I as Ne,r as hw,A as pt,t as Ft,u as Mr,v as Aa,U as $e,w as Ku,x as Jt,y as pe,z as Le,B as ge,C as me,D as un,E as $,N as Os,T as nc,F as Wu,G as Pn,H as fw,J as pw,K as hh,L as E1,M as gw,O as mw,P as u5,Q as yw,S as ww,V as fh,W as V2,X as vw,Y as bw,Z as V0,_ as Ew,b as Fr,$ as C,a0 as Ue,a1 as ee,a2 as Xe,a3 as Sw,j as xw,R as d5,a4 as ic,a5 as ka,a6 as Is,h as er,c as qt,i as _a,a7 as q2,s as gt,a8 as h5,a9 as Re,aa as f5,ab as q0,ac as Oi,ad as vl,ae as Aw,af as p5,ag as g5,ah as m5,ai as Be,aj as ph,ak as sc,al as kw,am as _w,an as Iw,ao as ra,ap as bl,aq as Cw,ar as y5,as as H2,at as cl,au as na,av as w5,aw as v5,ax as Gu,ay as Bi,az as oc,aA as Tw,aB as Rw,aC as Pw,aD as Ow,aE as Nw,aF as H0,aG as tr,aH as Vr,aI as mt,aJ as Xn,aK as Dw,aL as ll,aM as z0,aN as z2,aO as ue,aP as Ot,aQ as rs,aR as Ia,aS as Ca,aT as K0,aU as so,aV as W0,aW as ia,aX as b5,aY as E5,aZ as qe,a_ as Lw,a$ as K2,b0 as G0,b1 as Bw,b2 as j0,b3 as Mw,b4 as ac,b5 as Fw,b6 as dn,b7 as S5,b8 as x5,b9 as Uw,ba as ur,bb as $w,bc as Vw,bd as qw,be as S1,bf as Hw,bg as ws,bh as x1,bi as zw,bj as W2,bk as Kw,bl as Ww,bm as Q0,k as A5,bn as Gw,bo as k5,bp as jw,m as _5,bq as Qw,d as hn,br as oo,l as Yw,e as it,p as qr,bs as Xw,g as El}from"./M1RXKuGZ.js";import{C as Zw}from"./F5IPwa59.js";import{p as we,i as A1,r as Jw,h as I5,v as sa}from"./Z36B0dHS.js";import{g as ao,c as G2}from"./CE1G-McA.js";import{E as ev,d as tv,_ as Ai,a as Y0,b as k1,c as Oc,e as rv,f as nv}from"./CMbgCQxV.js";import{r as iv,b as X0,t as j2,a as ul,c as C5,j as gh,y as sv,z as ov,A as av,B as Q2,l as cv}from"./DSTOT4fw.js";import{z as lv,m as T5,a as uv,h as Y2,A as X2,i as Z2,y as Tr,x as Z0}from"./Ci5bNVgp.js";import{_ as p,a as de,b as We,r as dv}from"./Cg-pzjal.js";import{r as ju}from"./2Ml8XYcV.js";import{c as hv}from"./DZWKlvqC.js";function fv(n,e,t){let r=0;for(const i of n)if(!(r<e)){if(r>t)break;if(i!==255)return!1;r++}return!0}function pv(n,e,t,r){let i=0;for(const s of n)if(!(i<t)){if(i>r)break;if(s!==e[i])return!1;i++}return!0}function gv(n){switch(n.length){case Ta:return n.join(".");case Ra:{const e=[];for(let t=0;t<n.length;t++)t%2===0&&e.push(n[t].toString(16).padStart(2,"0")+n[t+1].toString(16).padStart(2,"0"));return e.join(":")}default:throw new Error("Invalid ip length")}}function mv(n){let e=0;for(let[t,r]of n.entries()){if(r===255){e+=8;continue}for(;(r&128)!=0;)e++,r=r<<1;if((r&128)!=0)return-1;for(let i=t+1;i<n.length;i++)if(n[i]!=0)return-1;break}return e}function yv(n){let e="0x";for(const t of n)e+=(t>>4).toString(16)+(t&15).toString(16);return e}const Ta=4,Ra=16,wv=new Uint8Array([0,0,0,0,0,0,0,0,0,0,255,255]);function R5(n,e){e.length===Ra&&n.length===Ta&&fv(e,0,11)&&(e=e.slice(12)),e.length===Ta&&n.length===Ra&&pv(n,wv,0,11)&&(n=n.slice(12));const t=n.length;if(t!=e.length)throw new Error("Failed to mask ip");const r=new Uint8Array(t);for(let i=0;i<t;i++)r[i]=n[i]&e[i];return r}function vv(n,e){if(typeof e=="string"&&(e=b1(e)),e==null)throw new Error("Invalid ip");if(e.length!==n.network.length)return!1;for(let t=0;t<e.length;t++)if((n.network[t]&n.mask[t])!==(e[t]&n.mask[t]))return!1;return!0}function bv(n){const[e,t]=n.split("/");if(!e||!t)throw new Error("Failed to parse given CIDR: "+n);let r=Ta,i=uw(e);if(i==null&&(r=Ra,i=dw(e),i==null))throw new Error("Failed to parse given CIDR: "+n);const s=parseInt(t,10);if(Number.isNaN(s)||String(s).length!==t.length||s<0||s>r*8)throw new Error("Failed to parse given CIDR: "+n);const o=P5(s,8*r);return{network:R5(i,o),mask:o}}function P5(n,e){if(e!==8*Ta&&e!==8*Ra)throw new Error("Invalid CIDR mask");if(n<0||n>e)throw new Error("Invalid CIDR mask");const t=e/8,r=new Uint8Array(t);for(let i=0;i<t;i++){if(n>=8){r[i]=255,n-=8;continue}r[i]=255-(255>>n),n=0}return r}class O5{constructor(e,t){if(t==null)({network:this.network,mask:this.mask}=bv(e));else{const r=b1(e);if(r==null)throw new Error("Failed to parse network");t=String(t);const i=parseInt(t,10);if(Number.isNaN(i)||String(i).length!==t.length||i<0||i>r.length*8){const s=b1(t);if(s==null)throw new Error("Failed to parse mask");this.mask=s}else this.mask=P5(i,8*r.length);this.network=R5(r,this.mask)}}contains(e){return vv({network:this.network,mask:this.mask},e)}toString(){const e=mv(this.mask),t=e!==-1?String(e):yv(this.mask);return gv(this.network)+"/"+t}}function Ev(n,e){return new O5(n).contains(e)}function Sv(n){let e,t;if(n.getComponents().forEach(r=>{(r.name==="ip4"||r.name==="ip6")&&(t=r.value),r.name==="ipcidr"&&(e=r.value)}),e==null||t==null)throw new Error("Invalid multiaddr");return new O5(t,e)}const xv=Symbol.for("@libp2p/connection"),Ns=Symbol.for("@libp2p/content-routing");function Av(n){return n==null?!1:(n.type==="RSA"||n.type==="Ed25519"||n.type==="secp256k1"||n.type==="ECDSA")&&n.raw instanceof Uint8Array&&typeof n.equals=="function"&&typeof n.toMultihash=="function"&&typeof n.toCID=="function"&&typeof n.verify=="function"}const Sl=Symbol.for("@libp2p/peer-discovery"),Ds=Symbol.for("@libp2p/peer-routing"),Qu="keep-alive",Yu=Symbol.for("@libp2p/transport");var Pa;(function(n){n[n.FATAL_ALL=0]="FATAL_ALL",n[n.NO_FATAL=1]="NO_FATAL"})(Pa||(Pa={}));class tt extends EventTarget{#e=new Map;constructor(){super()}listenerCount(e){const t=this.#e.get(e);return t==null?0:t.length}addEventListener(e,t,r){super.addEventListener(e,t,r);let i=this.#e.get(e);i==null&&(i=[],this.#e.set(e,i)),i.push({callback:t,once:(r!==!0&&r!==!1&&r?.once)??!1})}removeEventListener(e,t,r){super.removeEventListener(e.toString(),t??null,r);let i=this.#e.get(e);i!=null&&(i=i.filter(({callback:s})=>s!==t),this.#e.set(e,i))}dispatchEvent(e){const t=super.dispatchEvent(e);let r=this.#e.get(e.type);return r==null||(r=r.filter(({once:i})=>!i),this.#e.set(e.type,r)),t}safeDispatchEvent(e,t={}){return this.dispatchEvent(new CustomEvent(e,t))}}function J0(n){return n!=null&&typeof n.start=="function"&&typeof n.stop=="function"}async function Sn(...n){const e=[];for(const t of n)J0(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStart!=null&&await t.beforeStart()})),await Promise.all(e.map(async t=>{await t.start()})),await Promise.all(e.map(async t=>{t.afterStart!=null&&await t.afterStart()}))}async function hi(...n){const e=[];for(const t of n)J0(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStop!=null&&await t.beforeStop()})),await Promise.all(e.map(async t=>{await t.stop()})),await Promise.all(e.map(async t=>{t.afterStop!=null&&await t.afterStop()}))}const St=Symbol.for("@libp2p/service-capabilities"),Mi=Symbol.for("@libp2p/service-dependencies"),kv=Symbol.for("@libp2p/service-capabilities");class xt extends Error{code="ERR_MAX_LENGTH";name="MaxLengthError"}class J2 extends Error{code="ERR_MAX_SIZE";name="MaxSizeError"}function an(n){if(isNaN(n)||n<=0)throw new Ne("random bytes length must be a Number bigger than 0");return hw(n)}class P extends Event{type;detail;constructor(e,t){super(e),this.type=e,this.detail=t}}class eg{buffer;mask;top;btm;next;constructor(e){if(!(e>0)||(e-1&e)!==0)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){const e=this.buffer[this.btm];if(e!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return this.buffer[this.btm]===void 0}}class mh{size;hwm;head;tail;constructor(e={}){this.hwm=e.splitLimit??16,this.head=new eg(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return e?.byteLength!=null?e.byteLength:1}push(e){if(e?.value!=null&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){const t=this.head;this.head=t.next=new eg(2*this.head.buffer.length),this.head.push(e)}}shift(){let e=this.tail.shift();if(e===void 0&&this.tail.next!=null){const t=this.tail.next;this.tail.next=null,this.tail=t,e=this.tail.shift()}return e?.value!=null&&(this.size-=this.calculateSize(e.value)),e}isEmpty(){return this.head.isEmpty()}}let _v=class extends Error{type;code;constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.code=t??"ABORT_ERR"}};function fn(n={}){return Iv(t=>{const r=t.shift();if(r==null)return{done:!0};if(r.error!=null)throw r.error;return{done:r.done===!0,value:r.value}},n)}function Iv(n,e){e=e??{};let t=e.onEnd,r=new mh,i,s,o,a=we();const c=async()=>{try{return r.isEmpty()?o?{done:!0}:await new Promise((w,E)=>{s=A=>{s=null,r.push(A);try{w(n(r))}catch(T){E(T)}return i}}):n(r)}finally{r.isEmpty()&&queueMicrotask(()=>{a.resolve(),a=we()})}},l=w=>s!=null?s(w):(r.push(w),i),u=w=>(r=new mh,s!=null?s({error:w}):(r.push({error:w}),i)),d=w=>{if(o)return i;if(e?.objectMode!==!0&&w?.byteLength==null)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return l({done:!1,value:w})},h=w=>o?i:(o=!0,w!=null?u(w):l({done:!0})),f=()=>(r=new mh,h(),{done:!0}),m=w=>(h(w),{done:!0});if(i={[Symbol.asyncIterator](){return this},next:c,return:f,throw:m,push:d,end:h,get readableLength(){return r.size},onEmpty:async w=>{const E=w?.signal;if(E?.throwIfAborted(),r.isEmpty())return;let A,T;E!=null&&(A=new Promise((R,ie)=>{T=()=>{ie(new _v)},E.addEventListener("abort",T)}));try{await Promise.race([a.promise,A])}finally{T!=null&&E!=null&&E?.removeEventListener("abort",T)}}},t==null)return i;const y=i;return i={[Symbol.asyncIterator](){return this},next(){return y.next()},throw(w){return y.throw(w),t!=null&&(t(w),t=void 0),{done:!0}},return(){return y.return(),t!=null&&(t(),t=void 0),{done:!0}},push:d,end(w){return y.end(w),t!=null&&(t(w),t=void 0),i},get readableLength(){return y.readableLength},onEmpty:w=>y.onEmpty(w)},i}let Ls=class extends Error{static name="AbortError";name="AbortError";constructor(e="The operation was aborted",...t){super(e,...t)}};async function Ut(n,e,t,r){const i=new Ls(r?.errorMessage);r?.errorCode!=null&&(i.code=r.errorCode);const s=r?.errorEvent??"error";return t?.aborted===!0?Promise.reject(i):new Promise((o,a)=>{function c(){wh(t,"abort",d),wh(n,e,l),wh(n,s,u)}const l=h=>{try{if(r?.filter?.(h)===!1)return}catch(f){c(),a(f);return}c(),o(h)},u=h=>{if(c(),h instanceof Error){a(h);return}a(h.detail??r?.error??new Error(`The "${r?.errorEvent}" event was emitted but the event had no '.detail' field. Pass an 'error' option to race-event to change this message.`))},d=()=>{c(),a(i)};yh(t,"abort",d),yh(n,e,l),yh(n,s,u)})}function yh(n,e,t){n!=null&&(N5(n)?n.addEventListener(e,t):n.addListener(e,t))}function wh(n,e,t){n!=null&&(N5(n)?n.removeEventListener(e,t):n.removeListener(e,t))}function N5(n){return typeof n.addEventListener=="function"&&typeof n.removeEventListener=="function"}function Oa(n,e){let t;const r=function(){const i=function(){t=void 0,n()};clearTimeout(t),t=setTimeout(i,e)};return r.start=()=>{},r.stop=()=>{clearTimeout(t)},r}class Cv extends Error{remainingPoints;msBeforeNext;consumedPoints;isFirstInDuration;constructor(e="Rate limit exceeded",t){super(e),this.name="RateLimitError",this.remainingPoints=t.remainingPoints,this.msBeforeNext=t.msBeforeNext,this.consumedPoints=t.consumedPoints,this.isFirstInDuration=t.isFirstInDuration}}let Tv=class extends Error{static name="QueueFullError";constructor(e="The queue was full"){super(e),this.name="QueueFullError"}},tg=class extends Error{type;code;constructor(e,t,r){super(e??"The operation was aborted"),this.type="aborted",this.name=r??"AbortError",this.code=t??"ABORT_ERR"}};async function ht(n,e,t){if(e==null)return n;if(e.aborted)return n.catch(()=>{}),Promise.reject(new tg(t?.errorMessage,t?.errorCode,t?.errorName));let r;const i=new tg(t?.errorMessage,t?.errorCode,t?.errorName);try{return await Promise.race([n,new Promise((s,o)=>{r=()=>{o(i)},e.addEventListener("abort",r)})])}finally{r!=null&&e.removeEventListener("abort",r)}}let Rv=class{deferred;signal;constructor(e){this.signal=e,this.deferred=we(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new pt)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}};function Pv(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}let Ov=class{id;fn;options;recipients;status;timeline;controller;constructor(e,t){this.id=Pv(),this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce((t,r)=>t&&r.signal?.aborted===!0,!0)&&(this.controller.abort(new pt),this.cleanup())}async join(e={}){const t=new Rv(e.signal);return this.recipients.push(t),e.signal?.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();const e=await ht(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(t=>{t.deferred.resolve(e)}),this.status="complete"}catch(e){this.recipients.forEach(t=>{t.deferred.reject(e)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(e=>{e.cleanup(),e.signal?.removeEventListener("abort",this.onAbort)})}},si=class extends tt{concurrency;maxSize;queue;pending;sort;constructor(e={}){super(),this.concurrency=e.concurrency??Number.POSITIVE_INFINITY,this.maxSize=e.maxSize??Number.POSITIVE_INFINITY,this.pending=0,e.metricName!=null&&e.metrics?.registerMetricGroup(e.metricName,{calculate:()=>({size:this.queue.length,running:this.pending,queued:this.queue.length-this.pending})}),this.sort=e.sort,this.queue=[],this.emitEmpty=Oa(this.emitEmpty.bind(this),1),this.emitIdle=Oa(this.emitIdle.bind(this),1)}emitEmpty(){this.size===0&&this.safeDispatchEvent("empty")}emitIdle(){this.running===0&&this.safeDispatchEvent("idle")}tryToStartAnother(){if(this.size===0)return this.emitEmpty(),this.running===0&&this.emitIdle(),!1;if(this.pending<this.concurrency){let e;for(const t of this.queue)if(t.status==="queued"){e=t;break}return e==null?!1:(this.safeDispatchEvent("active"),this.pending++,e.run().finally(()=>{for(let t=0;t<this.queue.length;t++)if(this.queue[t]===e){this.queue.splice(t,1);break}this.pending--,this.tryToStartAnother(),this.safeDispatchEvent("next")}),!0)}return!1}enqueue(e){this.queue.push(e),this.sort!=null&&this.queue.sort(this.sort)}async add(e,t){if(t?.signal?.throwIfAborted(),this.size===this.maxSize)throw new Tv;const r=new Ov(e,t);return this.enqueue(r),this.safeDispatchEvent("add"),this.tryToStartAnother(),r.join(t).then(i=>(this.safeDispatchEvent("completed",{detail:i}),this.safeDispatchEvent("success",{detail:{job:r,result:i}}),i)).catch(i=>{if(r.status==="queued"){for(let s=0;s<this.queue.length;s++)if(this.queue[s]===r){this.queue.splice(s,1);break}}throw this.safeDispatchEvent("failure",{detail:{job:r,error:i}}),i})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(e=>{e.abort(new pt)}),this.clear()}async onEmpty(e){this.size!==0&&await Ut(this,"empty",e?.signal)}async onSizeLessThan(e,t){this.size<e||await Ut(this,"next",t?.signal,{filter:()=>this.size<e})}async onIdle(e){this.pending===0&&this.size===0||await Ut(this,"idle",e?.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(e){e?.signal?.throwIfAborted();const t=fn({objectMode:!0}),r=c=>{c!=null?this.abort():this.clear(),t.end(c)},i=c=>{c.detail!=null&&t.push(c.detail)},s=c=>{r(c.detail.error)},o=()=>{r()},a=()=>{r(new pt("Queue aborted"))};this.addEventListener("completed",i),this.addEventListener("failure",s),this.addEventListener("idle",o),e?.signal?.addEventListener("abort",a);try{yield*t}finally{this.removeEventListener("completed",i),this.removeEventListener("failure",s),this.removeEventListener("idle",o),e?.signal?.removeEventListener("abort",a),r()}}};class oi extends si{has(e){return this.find(e)!=null}find(e){return this.queue.find(t=>e.equals(t.options.peerId))}}function Nv(n){return n[Symbol.asyncIterator]!=null}function xn(n){if(Nv(n))return(async()=>{for await(const e of n);})();for(const e of n);}const Dv=8,ep=1024*1024*4;let Lv=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"},D5=class extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"},Bv=class extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"},rg=class extends Error{name="UnexpectedEOFError";code="ERR_UNEXPECTED_EOF"};function L5(n){return n[Symbol.asyncIterator]!=null}function B5(n,e){if(n.byteLength>e)throw new D5("Message length too long")}const Xu=n=>{const e=Ft(n),t=Aa(e);return Mr(n,t),Xu.bytes=e,t};Xu.bytes=0;function Na(n,e){e=e??{};const t=e.lengthEncoder??Xu,r=e?.maxDataLength??ep;function*i(s){B5(s,r);const o=t(s.byteLength);o instanceof Uint8Array?yield o:yield*o,s instanceof Uint8Array?yield s:yield*s}return L5(n)?(async function*(){for await(const s of n)yield*i(s)})():(function*(){for(const s of n)yield*i(s)})()}Na.single=(n,e)=>{e=e??{};const t=e.lengthEncoder??Xu,r=e?.maxDataLength??ep;return B5(n,r),new $e(t(n.byteLength),n)};var ki;(function(n){n[n.LENGTH=0]="LENGTH",n[n.DATA=1]="DATA"})(ki||(ki={}));const tp=n=>{const e=Ku(n);return tp.bytes=Ft(e),e};tp.bytes=0;function Da(n,e){const t=new $e;let r=ki.LENGTH,i=-1;const s=e?.lengthDecoder??tp,o=e?.maxLengthLength??Dv,a=e?.maxDataLength??ep;function*c(){for(;t.byteLength>0;){if(r===ki.LENGTH)try{if(i=s(t),i<0)throw new Lv("Invalid message length");if(i>a)throw new D5("Message length too long");const l=s.bytes;t.consume(l),e?.onLength!=null&&e.onLength(i),r=ki.DATA}catch(l){if(l instanceof RangeError){if(t.byteLength>o)throw new Bv("Message length length too long");break}throw l}if(r===ki.DATA){if(t.byteLength<i)break;const l=t.sublist(0,i);t.consume(i),e?.onData!=null&&e.onData(l),yield l,r=ki.LENGTH}}}return L5(n)?(async function*(){for await(const l of n)t.append(l),yield*c();if(t.byteLength>0)throw new rg("Unexpected end of input")})():(function*(){for(const l of n)t.append(l),yield*c();if(t.byteLength>0)throw new rg("Unexpected end of input")})()}Da.fromReader=(n,e)=>{let t=1;const r=(async function*(){for(;;)try{const{done:s,value:o}=await n.next(t);if(s===!0)return;o!=null&&(yield o)}catch(s){if(s.code==="ERR_UNDER_READ")return{done:!0,value:null};throw s}finally{t=1}})();return Da(r,{...e??{},onLength:s=>{t=s}})};class Mv{readNext;haveNext;ended;nextResult;error;constructor(){this.ended=!1,this.readNext=we(),this.haveNext=we()}[Symbol.asyncIterator](){return this}async next(){if(this.nextResult==null&&await this.haveNext.promise,this.nextResult==null)throw new Error("HaveNext promise resolved but nextResult was undefined");const e=this.nextResult;return this.nextResult=void 0,this.readNext.resolve(),this.readNext=we(),e}async throw(e){return this.ended=!0,this.error=e,e!=null&&(this.haveNext.promise.catch(()=>{}),this.haveNext.reject(e)),{done:!0,value:void 0}}async return(){const e={done:!0,value:void 0};return this.ended=!0,this.nextResult=e,this.haveNext.resolve(),e}async push(e,t){await this._push(e,t)}async end(e,t){e!=null?await this.throw(e):await this._push(void 0,t)}async _push(e,t){if(e!=null&&this.ended)throw this.error??new Error("Cannot push value onto an ended pushable");for(;this.nextResult!=null;)await this.readNext.promise;e!=null?this.nextResult={done:!1,value:e}:(this.ended=!0,this.nextResult={done:!0,value:void 0}),this.haveNext.resolve(),this.haveNext=we(),await ht(this.readNext.promise,t?.signal,t)}}function M5(){return new Mv}function Fv(n){return n[Symbol.asyncIterator]!=null}async function Uv(n,e,t){try{await Promise.all(n.map(async r=>{for await(const i of r)await e.push(i,{signal:t}),t.throwIfAborted()})),await e.end(void 0,{signal:t})}catch(r){await e.end(r,{signal:t}).catch(()=>{})}}async function*$v(n){const e=new AbortController,t=M5();Uv(n,t,e.signal).catch(()=>{});try{yield*t}finally{e.abort()}}function*Vv(n){for(const e of n)yield*e}function Zn(...n){const e=[];for(const t of n)Fv(t)||e.push(t);return e.length===n.length?Vv(e):$v(n)}function rr(n,...e){if(n==null)throw new Error("Empty pipeline");if(vh(n)){const r=n;n=()=>r.source}else if(U5(n)||F5(n)){const r=n;n=()=>r}const t=[n,...e];if(t.length>1&&vh(t[t.length-1])&&(t[t.length-1]=t[t.length-1].sink),t.length>2)for(let r=1;r<t.length-1;r++)vh(t[r])&&(t[r]=Hv(t[r]));return qv(...t)}const qv=(...n)=>{let e;for(;n.length>0;)e=n.shift()(e);return e},F5=n=>n?.[Symbol.asyncIterator]!=null,U5=n=>n?.[Symbol.iterator]!=null,vh=n=>n==null?!1:n.sink!=null&&n.source!=null,Hv=n=>e=>{const t=n.sink(e);if(t?.then!=null){const r=fn({objectMode:!0});t.then(()=>{r.end()},o=>{r.end(o)});let i;const s=n.source;if(F5(s))i=async function*(){yield*s,r.end()};else if(U5(s))i=function*(){yield*s,r.end()};else throw new Error("Unknown duplex source type - must be Iterable or AsyncIterable");return Zn(r,i())}return n.source};function zv(n){return n[Symbol.asyncIterator]!=null}function xl(n,e){return zv(n)?(async function*(){let t=0;if(!(e<1)){for await(const r of n)if(yield r,t++,t===e)return}})():(function*(){let t=0;if(!(e<1)){for(const r of n)if(yield r,t++,t===e)return}})()}const Nc="/ipfs/bitswap/1.2.0",Kv=1024,Wv=1024,Gv=1024,jv=5e3,Qv=10,Yv=50,Xv=!1,Zv=3,$5=1024*1024*4,Jv=$5;var ut;(function(n){n.WantBlock="WantBlock",n.WantHave="WantHave"})(ut||(ut={}));var _1;(function(n){n[n.WantBlock=0]="WantBlock",n[n.WantHave=1]="WantHave"})(_1||(_1={}));(function(n){n.codec=()=>Jt(_1)})(ut||(ut={}));var La;(function(n){let e;n.codec=()=>(e==null&&(e=pe((t,r,i={})=>{i.lengthDelimited!==!1&&r.fork(),t.cid!=null&&t.cid.byteLength>0&&(r.uint32(10),r.bytes(t.cid)),t.priority!=null&&t.priority!==0&&(r.uint32(16),r.int32(t.priority)),t.cancel!=null&&(r.uint32(24),r.bool(t.cancel)),t.wantType!=null&&(r.uint32(32),ut.codec().encode(t.wantType,r)),t.sendDontHave!=null&&(r.uint32(40),r.bool(t.sendDontHave)),i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{const s={cid:Le(0),priority:0},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.cid=t.bytes();break}case 2:{s.priority=t.int32();break}case 3:{s.cancel=t.bool();break}case 4:{s.wantType=ut.codec().decode(t);break}case 5:{s.sendDontHave=t.bool();break}default:{t.skipType(a&7);break}}}return s})),e),n.encode=t=>ge(t,n.codec()),n.decode=(t,r)=>me(t,n.codec(),r)})(La||(La={}));var Al;(function(n){let e;n.codec=()=>(e==null&&(e=pe((t,r,i={})=>{if(i.lengthDelimited!==!1&&r.fork(),t.entries!=null)for(const s of t.entries)r.uint32(10),La.codec().encode(s,r);t.full!=null&&(r.uint32(16),r.bool(t.full)),i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{const s={entries:[]},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{if(i.limits?.entries!=null&&s.entries.length===i.limits.entries)throw new xt('Decode error - map field "entries" had too many elements');s.entries.push(La.codec().decode(t,t.uint32(),{limits:i.limits?.entries$}));break}case 2:{s.full=t.bool();break}default:{t.skipType(a&7);break}}}return s})),e),n.encode=t=>ge(t,n.codec()),n.decode=(t,r)=>me(t,n.codec(),r)})(Al||(Al={}));var Ba;(function(n){let e;n.codec=()=>(e==null&&(e=pe((t,r,i={})=>{i.lengthDelimited!==!1&&r.fork(),t.prefix!=null&&t.prefix.byteLength>0&&(r.uint32(10),r.bytes(t.prefix)),t.data!=null&&t.data.byteLength>0&&(r.uint32(18),r.bytes(t.data)),i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{const s={prefix:Le(0),data:Le(0)},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.prefix=t.bytes();break}case 2:{s.data=t.bytes();break}default:{t.skipType(a&7);break}}}return s})),e),n.encode=t=>ge(t,n.codec()),n.decode=(t,r)=>me(t,n.codec(),r)})(Ba||(Ba={}));var rn;(function(n){n.HaveBlock="HaveBlock",n.DoNotHaveBlock="DoNotHaveBlock"})(rn||(rn={}));var kl;(function(n){n[n.HaveBlock=0]="HaveBlock",n[n.DoNotHaveBlock=1]="DoNotHaveBlock"})(kl||(kl={}));(function(n){n.codec=()=>Jt(kl)})(rn||(rn={}));var Ma;(function(n){let e;n.codec=()=>(e==null&&(e=pe((t,r,i={})=>{i.lengthDelimited!==!1&&r.fork(),t.cid!=null&&t.cid.byteLength>0&&(r.uint32(10),r.bytes(t.cid)),t.type!=null&&kl[t.type]!==0&&(r.uint32(16),rn.codec().encode(t.type,r)),i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{const s={cid:Le(0),type:rn.HaveBlock},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.cid=t.bytes();break}case 2:{s.type=rn.codec().decode(t);break}default:{t.skipType(a&7);break}}}return s})),e),n.encode=t=>ge(t,n.codec()),n.decode=(t,r)=>me(t,n.codec(),r)})(Ma||(Ma={}));var Fa;(function(n){let e;n.codec=()=>(e==null&&(e=pe((t,r,i={})=>{if(i.lengthDelimited!==!1&&r.fork(),t.wantlist!=null&&(r.uint32(10),Al.codec().encode(t.wantlist,r)),t.blocks!=null)for(const s of t.blocks)r.uint32(26),Ba.codec().encode(s,r);if(t.blockPresences!=null)for(const s of t.blockPresences)r.uint32(34),Ma.codec().encode(s,r);t.pendingBytes!=null&&t.pendingBytes!==0&&(r.uint32(40),r.int32(t.pendingBytes)),i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{const s={blocks:[],blockPresences:[],pendingBytes:0},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.wantlist=Al.codec().decode(t,t.uint32(),{limits:i.limits?.wantlist});break}case 3:{if(i.limits?.blocks!=null&&s.blocks.length===i.limits.blocks)throw new xt('Decode error - map field "blocks" had too many elements');s.blocks.push(Ba.codec().decode(t,t.uint32(),{limits:i.limits?.blocks$}));break}case 4:{if(i.limits?.blockPresences!=null&&s.blockPresences.length===i.limits.blockPresences)throw new xt('Decode error - map field "blockPresences" had too many elements');s.blockPresences.push(Ma.codec().decode(t,t.uint32(),{limits:i.limits?.blockPresences$}));break}case 5:{s.pendingBytes=t.int32();break}default:{t.skipType(a&7);break}}}return s})),e),n.encode=t=>ge(t,n.codec()),n.decode=(t,r)=>me(t,n.codec(),r)})(Fa||(Fa={}));function eb(n,e){for(const[t,r]of e.wantlist.entries()){const i=n.wantlist.get(t);i!=null&&(i.priority>r.priority&&(r.priority=i.priority),r.cancel=r.cancel??i.cancel,r.wantType=r.wantType??i.wantType,r.sendDontHave=r.sendDontHave??i.sendDontHave),n.wantlist.set(t,r)}for(const[t,r]of e.blockPresences.entries())n.blockPresences.set(t,r);for(const[t,r]of e.blocks.entries())n.blocks.set(t,r);return e.full&&!n.full&&(n.full=!0),n}class tb extends Error{static name="BlockTooLargeError";constructor(e="Block too large"){super(e),this.name="BlockTooLargeError"}}const rb=4193648,nb=rb+16;function*ib(n,e){const t=[...n.wantlist.values()],r=[...n.blockPresences.values()],i=[...n.blocks.values()];let s=0,o=0,a=0,c=!1;for(;;){const l={wantlist:{full:n.full??!1,entries:[]},blockPresences:[],blocks:[],pendingBytes:0};let u=Fa.encode(l).byteLength,{added:d,hasMore:h,newSize:f}=bh(i,l.blocks,a,e,u,sb);a+=d,u=f;const m=h;({added:d,hasMore:h,newSize:f}=bh(r,l.blockPresences,o,e,u,ob)),o+=d,u=f;const y=h;if({added:d,hasMore:h,newSize:f}=bh(t,l.wantlist.entries,s,e,u,ab),s+=d,u=f,c=!m&&!y&&!h,c||(l.wantlist.full=!1),yield Fa.encode(l),c)break}}function bh(n,e,t,r,i,s){let o=0,a=!1;for(let c=t;c<n.length;c++){const l=n[c],u=s(l);if(u>nb)throw new tb("Cannot send block as after encoding it is over the max message size");const d=i+u;if(d>r){a=!0;break}e.push(l),o++,i=d}return{hasMore:a,added:o,newSize:i}}function sb(n){return rp(3,Ba.encode(n))}function ob(n){return rp(4,Ma.encode(n))}function ab(n){return rp(1,La.encode(n))}function rp(n,e){const t=Ft(n),r=Ft(e.byteLength);return t+r+e.byteLength}let cb=class extends tt{log;libp2p;routing;protocols;running;maxInboundStreams;maxOutboundStreams;messageReceiveTimeout;registrarIds;metrics;sendQueue;runOnLimitedConnections;maxOutgoingMessageSize;maxIncomingMessageSize;constructor(e,t={}){super(),this.log=e.logger.forComponent("helia:bitswap:network"),this.libp2p=e.libp2p,this.routing=e.routing,this.protocols=t.protocols??[Nc],this.registrarIds=[],this.running=!1,this._onStream=this._onStream.bind(this),this.maxInboundStreams=t.maxInboundStreams??Wv,this.maxOutboundStreams=t.maxOutboundStreams??Gv,this.messageReceiveTimeout=t.messageReceiveTimeout??jv,this.runOnLimitedConnections=t.runOnLimitedConnections??Xv,this.maxIncomingMessageSize=t.maxIncomingMessageSize??$5,this.maxOutgoingMessageSize=t.maxOutgoingMessageSize??t.maxIncomingMessageSize??Jv,this.metrics={blocksSent:e.metrics?.registerCounter("helia_bitswap_sent_blocks_total"),dataSent:e.metrics?.registerCounter("helia_bitswap_sent_data_bytes_total")},this.sendQueue=new oi({concurrency:t.messageSendConcurrency??Yv,metrics:e.metrics,metricName:"helia_bitswap_message_send_queue"}),this.sendQueue.addEventListener("error",r=>{this.log.error("error sending wantlist to peer",r.detail)})}async start(){if(this.running)return;this.running=!0,await this.libp2p.handle(this.protocols,this._onStream,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnections});const e={onConnect:t=>{this.safeDispatchEvent("peer:connected",{detail:t})},onDisconnect:t=>{this.safeDispatchEvent("peer:disconnected",{detail:t})}};this.registrarIds=[];for(const t of this.protocols)this.registrarIds.push(await this.libp2p.register(t,e));this.libp2p.getConnections().forEach(t=>{this.safeDispatchEvent("peer:connected",{detail:t.remotePeer})})}async stop(){if(this.running=!1,await this.libp2p.unhandle(this.protocols),this.registrarIds!=null){for(const e of this.registrarIds)this.libp2p.unregister(e);this.registrarIds=[]}}_onStream(e){if(!this.running)return;const{stream:t,connection:r}=e;Promise.resolve().then(async()=>{this.log("incoming new bitswap %s stream from %p",t.protocol,r.remotePeer);const i=()=>{t.status==="open"?t.abort(new nc(`Incoming Bitswap stream timed out after ${this.messageReceiveTimeout}ms`)):this.log("stream aborted with status %s",t.status)};let s=AbortSignal.timeout(this.messageReceiveTimeout);s.addEventListener("abort",i),await t.closeWrite(),await rr(t,o=>Da(o,{maxDataLength:this.maxIncomingMessageSize}),async o=>{for await(const a of o)try{const c=Fa.decode(a);this.log("incoming new bitswap %s message from %p on stream",t.protocol,r.remotePeer,t.id),this.safeDispatchEvent("bitswap:message",{detail:{peer:r.remotePeer,message:c}}),s.removeEventListener("abort",i),s=AbortSignal.timeout(this.messageReceiveTimeout),s.addEventListener("abort",i)}catch(c){this.log.error("error reading incoming bitswap message from %p on stream",r.remotePeer,t.id,c),t.abort(c);break}})}).catch(i=>{this.log.error("error handling incoming stream from %p",r.remotePeer,i),t.abort(i)})}async*findProviders(e,t){t?.onProgress?.(new P("bitswap:network:find-providers",e));for await(const r of this.routing.findProviders(e,t))await this.libp2p.isDialable(r.multiaddrs,{runOnLimitedConnection:this.runOnLimitedConnections})&&(yield r)}async findAndConnect(e,t){t?.providers!=null&&await Promise.all(t.providers.map(async r=>this.connectTo(r).catch(i=>{this.log.error("could not connect to supplied provider - %e",i)}))),await xn(un(xl(this.findProviders(e,t),t?.maxProviders??Zv),async r=>this.connectTo(r.id,t))).catch(r=>{this.log.error(r)})}async sendMessage(e,t,r){if(!this.running)throw new Error("network isn't running");const i=this.sendQueue.queue.find(s=>e.equals(s.options.peerId)&&s.status==="queued");if(i!=null){i.options.message=eb(i.options.message,t),await i.join({signal:r?.signal});return}await this.sendQueue.add(async s=>{const o=s?.message;if(o==null)throw new $("No message to send");this.log("sendMessage to %p",e),s?.onProgress?.(new P("bitswap:network:send-wantlist",e));const a=await this.libp2p.dialProtocol(e,Nc,s);await a.closeRead();try{await rr(ib(o,this.maxOutgoingMessageSize),c=>Na(c),a),await a.close(s)}catch(c){s?.onProgress?.(new P("bitswap:network:send-wantlist:error",{peer:e,error:c})),this.log.error("error sending message to %p",e,c),a.abort(c)}this._updateSentStats(o.blocks)},{peerId:e,signal:r?.signal,message:t})}async connectTo(e,t){if(!this.running)throw new Os("Network isn't running");t?.onProgress?.(new P("bitswap:network:dial",e));const[r]=await Promise.all([this.libp2p.dial(e,t),Ut(this.libp2p,"peer:identify",t?.signal,{filter:i=>{if(!i.detail.peerId.equals(e))return!1;if(i.detail.protocols.includes(Nc))return!0;throw new Wu(`${e} did not support ${Nc}`)}})]);return r}_updateSentStats(e){let t=0;for(const r of e.values())t+=r.data.byteLength;this.metrics.dataSent?.increment(t),this.metrics.blocksSent?.increment(e.size)}};function oa(n,e){const t={[Symbol.iterator]:()=>t,next:()=>{const r=n.next(),i=r.value;return r.done===!0||i==null?{done:!0,value:void 0}:{done:!1,value:e(i)}}};return t}function Eh(n){const e=zt(Di.decode(`z${n}`));return Pn(e)}class ns{map;constructor(e){if(this.map=new Map,e!=null)for(const[t,r]of e.entries())this.map.set(t.toString(),{key:t,value:r})}[Symbol.iterator](){return this.entries()}clear(){this.map.clear()}delete(e){return this.map.delete(e.toString())}entries(){return oa(this.map.entries(),e=>[e[1].key,e[1].value])}forEach(e){this.map.forEach((t,r)=>{e(t.value,t.key,this)})}get(e){return this.map.get(e.toString())?.value}has(e){return this.map.has(e.toString())}set(e,t){this.map.set(e.toString(),{key:e,value:t})}keys(){return oa(this.map.values(),e=>e.key)}values(){return oa(this.map.values(),e=>e.value)}get size(){return this.map.size}}class nn{set;constructor(e){if(this.set=new Set,e!=null)for(const t of e)this.set.add(t.toString())}get size(){return this.set.size}[Symbol.iterator](){return this.values()}add(e){this.set.add(e.toString())}clear(){this.set.clear()}delete(e){this.set.delete(e.toString())}entries(){return oa(this.set.entries(),e=>{const t=Eh(e[0]);return[t,t]})}forEach(e){this.set.forEach(t=>{const r=Eh(t);e(r,r,this)})}has(e){return this.set.has(e.toString())}values(){return oa(this.set.values(),e=>Eh(e))}intersection(e){const t=new nn;for(const r of e)this.has(r)&&t.add(r);return t}difference(e){const t=new nn;for(const r of this)e.has(r)||t.add(r);return t}union(e){const t=new nn;for(const r of e)t.add(r);for(const r of this)t.add(r);return t}}function lb(){return new nn}const ko=Uint32Array.from([1732584193,4023233417,2562383102,271733878,3285377520]),$n=new Uint32Array(80);class ub extends pw{A=ko[0]|0;B=ko[1]|0;C=ko[2]|0;D=ko[3]|0;E=ko[4]|0;constructor(){super(64,20,8,!1)}get(){const{A:e,B:t,C:r,D:i,E:s}=this;return[e,t,r,i,s]}set(e,t,r,i,s){this.A=e|0,this.B=t|0,this.C=r|0,this.D=i|0,this.E=s|0}process(e,t){for(let c=0;c<16;c++,t+=4)$n[c]=e.getUint32(t,!1);for(let c=16;c<80;c++)$n[c]=hh($n[c-3]^$n[c-8]^$n[c-14]^$n[c-16],1);let{A:r,B:i,C:s,D:o,E:a}=this;for(let c=0;c<80;c++){let l,u;c<20?(l=gw(i,s,o),u=1518500249):c<40?(l=i^s^o,u=1859775393):c<60?(l=mw(i,s,o),u=2400959708):(l=i^s^o,u=3395469782);const d=hh(r,5)+l+a+u+$n[c]|0;a=o,o=s,s=hh(i,30),i=r,r=d}r=r+this.A|0,i=i+this.B|0,s=s+this.C|0,o=o+this.D|0,a=a+this.E|0,this.set(r,i,s,o,a)}roundClean(){E1($n)}destroy(){this.set(0,0,0,0,0),E1(this.buffer)}}const db=fw(()=>new ub);function V5(n,e,t,r){yw(n);const i=ww({dkLen:32,asyncTick:10},r),{c:s,dkLen:o,asyncTick:a}=i;if(fh(s,"c"),fh(o,"dkLen"),fh(a,"asyncTick"),s<1)throw new Error("iterations (c) must be >= 1");const c=V2(e,"password"),l=V2(t,"salt"),u=new Uint8Array(o),d=vw.create(n,c),h=d._cloneInto().update(l);return{c:s,dkLen:o,asyncTick:a,DK:u,PRF:d,PRFSalt:h}}function q5(n,e,t,r,i){return n.destroy(),e.destroy(),r&&r.destroy(),E1(i),t}function hb(n,e,t,r){const{c:i,dkLen:s,DK:o,PRF:a,PRFSalt:c}=V5(n,e,t,r);let l;const u=new Uint8Array(4),d=u5(u),h=new Uint8Array(a.outputLen);for(let f=1,m=0;m<s;f++,m+=a.outputLen){const y=o.subarray(m,m+a.outputLen);d.setInt32(0,f,!1),(l=c._cloneInto(l)).update(u).digestInto(h),y.set(h.subarray(0,y.length));for(let w=1;w<i;w++){a._cloneInto(l).update(h).digestInto(h);for(let E=0;E<y.length;E++)y[E]^=h[E]}}return q5(a,c,o,l,h)}async function H5(n,e,t,r){const{c:i,dkLen:s,asyncTick:o,DK:a,PRF:c,PRFSalt:l}=V5(n,e,t,r);let u;const d=new Uint8Array(4),h=u5(d),f=new Uint8Array(c.outputLen);for(let m=1,y=0;y<s;m++,y+=c.outputLen){const w=a.subarray(y,y+c.outputLen);h.setInt32(0,m,!1),(u=l._cloneInto(u)).update(d).digestInto(f),w.set(f.subarray(0,w.length)),await bw(i-1,o,()=>{c._cloneInto(u).update(f).digestInto(f);for(let E=0;E<w.length;E++)w[E]^=f[E]})}return q5(c,l,a,u,f)}const ng={sha1:db,"sha2-256":Ew,"sha2-512":V0};function _l(n,e,t,r,i){if(i!=="sha1"&&i!=="sha2-256"&&i!=="sha2-512"){const a=Object.keys(ng).join(" / ");throw new Ne(`Hash '${i}' is unknown or not supported. Must be ${a}`)}const s=ng[i],o=hb(s,n,e,{c:t,dkLen:r});return Fr.encode(o).substring(1)}const np={32:16777619n,64:1099511628211n,128:309485009821345068724781371n,256:374144419156711147060143317175368453031918731002211n,512:35835915874844867368919076489095108449946327955754392558399825615420669938882575126094039892345713852759n,1024:5016456510113118655434598811035278955030765345404790744303017523831112055108147451509157692220295382716162651878526895249385292291816524375083746691371804094271873160484737966720260389217684476157468082573n},z5={32:2166136261n,64:14695981039346656037n,128:144066263297769815596495629667062367629n,256:100029257958052580907070968620625704837092796014241193945225284501741471925557n,512:9659303129496669498009435400716310466090418745672637896108374329434462657994582932197716438449813051892206539805784495328239340083876191928701583869517785n,1024:14197795064947621068722070641403218320880622795441933960878474914617582723252296732303717722150864096521202355549365628174669108571814760471015076148029755969804077320157692458563003215304957150157403644460363550505412711285966361610267868082893823963790439336411086884584107735010676915n},K5=new globalThis.TextEncoder;function fb(n,e){const t=np[e];let r=z5[e];for(let i=0;i<n.length;i++)r^=BigInt(n[i]),r=BigInt.asUintN(e,r*t);return r}function pb(n,e,t){if(t.length===0)throw new Error("The `utf8Buffer` option must have a length greater than zero");const r=np[e];let i=z5[e],s=n;for(;s.length>0;){const o=K5.encodeInto(s,t);s=s.slice(o.read);for(let a=0;a<o.written;a++)i^=BigInt(t[a]),i=BigInt.asUintN(e,i*r)}return i}function gb(n,{size:e=32,utf8Buffer:t}={}){if(!np[e])throw new Error("The `size` option must be one of 32, 64, 128, 256, 512, or 1024");if(typeof n=="string"){if(t)return pb(n,e,t);n=K5.encode(n)}return fb(n,e)}const ip={hash:n=>Number(gb(n,{size:32})),hashV:(n,e)=>mb(ip.hash(n,e))};function mb(n){let e=n.toString(16);return e.length%2===1&&(e=`0${e}`),C(e,"base16")}const W5=64;class Ci{fp;h;seed;constructor(e,t,r,i=2){if(i>W5)throw new TypeError("Invalid Fingerprint Size");const s=t.hashV(e,r),o=Le(i);for(let a=0;a<o.length;a++)o[a]=s[a];o.length===0&&(o[0]=7),this.fp=o,this.h=t,this.seed=r}hash(){return this.h.hash(this.fp,this.seed)}equals(e){return e?.fp instanceof Uint8Array?Ue(this.fp,e.fp):!1}}function Il(n,e){return Math.floor(Math.random()*(e-n))+n}let Dc=class{contents;constructor(e){this.contents=new Array(e).fill(null)}has(e){if(!(e instanceof Ci))throw new TypeError("Invalid Fingerprint");return this.contents.some(t=>e.equals(t))}add(e){if(!(e instanceof Ci))throw new TypeError("Invalid Fingerprint");for(let t=0;t<this.contents.length;t++)if(this.contents[t]==null)return this.contents[t]=e,!0;return!0}swap(e){if(!(e instanceof Ci))throw new TypeError("Invalid Fingerprint");const t=Il(0,this.contents.length-1),r=this.contents[t];return this.contents[t]=e,r}remove(e){if(!(e instanceof Ci))throw new TypeError("Invalid Fingerprint");const t=this.contents.findIndex(r=>e.equals(r));return t>-1?(this.contents[t]=null,!0):!1}};const yb=500;class ig{bucketSize;filterSize;fingerprintSize;buckets;count;hash;seed;constructor(e){this.filterSize=e.filterSize,this.bucketSize=e.bucketSize??4,this.fingerprintSize=e.fingerprintSize??2,this.count=0,this.buckets=[],this.hash=e.hash??ip,this.seed=e.seed??Il(0,Math.pow(2,10))}add(e){typeof e=="string"&&(e=C(e));const t=new Ci(e,this.hash,this.seed,this.fingerprintSize),r=this.hash.hash(e,this.seed)%this.filterSize,i=(r^t.hash())%this.filterSize;if(this.buckets[r]==null&&(this.buckets[r]=new Dc(this.bucketSize)),this.buckets[i]==null&&(this.buckets[i]=new Dc(this.bucketSize)),this.buckets[r].add(t)||this.buckets[i].add(t))return this.count++,!0;const s=[r,i];let o=s[Il(0,s.length-1)];this.buckets[o]==null&&(this.buckets[o]=new Dc(this.bucketSize));for(let a=0;a<yb;a++){const c=this.buckets[o].swap(t);if(c!=null&&(o=(o^c.hash())%this.filterSize,this.buckets[o]==null&&(this.buckets[o]=new Dc(this.bucketSize)),this.buckets[o].add(c)))return this.count++,!0}return!1}has(e){typeof e=="string"&&(e=C(e));const t=new Ci(e,this.hash,this.seed,this.fingerprintSize),r=this.hash.hash(e,this.seed)%this.filterSize,i=this.buckets[r]?.has(t)??!1;if(i)return i;const s=(r^t.hash())%this.filterSize;return this.buckets[s]?.has(t)??!1}remove(e){typeof e=="string"&&(e=C(e));const t=new Ci(e,this.hash,this.seed,this.fingerprintSize),r=this.hash.hash(e,this.seed)%this.filterSize,i=this.buckets[r]?.remove(t)??!1;if(i)return this.count--,i;const s=(r^t.hash())%this.filterSize,o=this.buckets[s]?.remove(t)??!1;return o&&this.count--,o}get reliable(){return Math.floor(100*(this.count/this.filterSize))<=90}}const wb={1:.5,2:.84,4:.95,8:.98};function vb(n=.001){return n>.002?2:n>1e-5?4:8}function bb(n,e=.001){const t=vb(e),r=wb[t],i=Math.round(n/r),s=Math.min(Math.ceil(Math.log2(1/e)+Math.log2(2*t)),W5);return{filterSize:i,bucketSize:t,fingerprintSize:s}}class G5{filterSize;bucketSize;fingerprintSize;scale;filterSeries;hash;seed;constructor(e){this.bucketSize=e.bucketSize??4,this.filterSize=e.filterSize??(1<<18)/this.bucketSize,this.fingerprintSize=e.fingerprintSize??2,this.scale=e.scale??2,this.hash=e.hash??ip,this.seed=e.seed??Il(0,Math.pow(2,10)),this.filterSeries=[new ig({filterSize:this.filterSize,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed})]}add(e){if(typeof e=="string"&&(e=C(e)),this.has(e))return!0;let t=this.filterSeries.find(r=>r.reliable);if(t==null){const r=this.filterSize*Math.pow(this.scale,this.filterSeries.length);t=new ig({filterSize:r,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed}),this.filterSeries.push(t)}return t.add(e)}has(e){typeof e=="string"&&(e=C(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].has(e))return!0;return!1}remove(e){typeof e=="string"&&(e=C(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].remove(e))return!0;return!1}get count(){return this.filterSeries.reduce((e,t)=>e+t.count,0)}}function ai(n,e=.001,t){return new G5({...bb(n,e)})}class Eb{filter;constructor(e,t){this.filter=ai(e,t)}has(e){return this.filter.has(e.toMultihash().bytes)}add(e){this.filter.add(e.toMultihash().bytes)}remove(e){this.filter.remove?.(e.toMultihash().bytes)}}function Sb(n,e=.001){return new Eb(n,e)}class xb extends ns{metric;constructor(e){super();const{name:t,metrics:r}=e;this.metric=r.registerMetric(t),this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){const t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}}function Zu(n){const{name:e,metrics:t}=n;let r;return t!=null?r=new xb({name:e,metrics:t}):r=new ns,r}class Lo{full;pendingBytes;wantlist;blocks;blockPresences;constructor(e=!1,t=0){this.full=e,this.wantlist=new Map,this.blocks=new Map,this.blockPresences=new Map,this.pendingBytes=0}addWantlistEntry(e,t){const r=Fr.encode(e.multihash.bytes);this.wantlist.set(r,t)}addBlockPresence(e,t){const r=Fr.encode(e.multihash.bytes);this.blockPresences.set(r,t)}addBlock(e,t){const r=Fr.encode(e.multihash.bytes);this.blocks.set(r,t)}}function Ab(n){let e=new Uint8Array(n.reduce((r,i)=>r+Ft(i),0)),t=0;for(const r of n)e=Mr(r,e,t),t+=Ft(r);return e}function sg(n){return Ab([n.version,n.code,n.multihash.code,n.multihash.digest.byteLength])}class kb{peerId;blockstore;network;wants;exchangeCount;bytesSent;bytesReceived;lastExchange;maxSizeReplaceHasWithBlock;log;constructor(e,t){this.peerId=e.peerId,this.blockstore=e.blockstore,this.network=e.network,this.wants=new Map,this.log=e.logger.forComponent(`helia:bitswap:ledger:${e.peerId}`),this.exchangeCount=0,this.bytesSent=0,this.bytesReceived=0,this.maxSizeReplaceHasWithBlock=t.maxSizeReplaceHasWithBlock??Kv}sentBytes(e){this.exchangeCount++,this.lastExchange=new Date().getTime(),this.bytesSent+=e}receivedBytes(e){this.exchangeCount++,this.lastExchange=new Date().getTime(),this.bytesReceived+=e}debtRatio(){return this.bytesSent/(this.bytesReceived+1)}async sendBlocksToPeer(e){const t=new Lo,r=new Set;for(const[i,s]of this.wants.entries())try{const o=await this.blockstore.get(s.cid,e);s.wantType===ut.WantHave?o.byteLength<this.maxSizeReplaceHasWithBlock?(this.log("sending have and block for %c",s.cid),r.add(i),t.addBlock(s.cid,{data:o,prefix:sg(s.cid)})):(this.log("sending have for %c",s.cid),t.addBlockPresence(s.cid,{cid:s.cid.bytes,type:rn.HaveBlock})):(this.log("sending block for %c",s.cid),r.add(i),t.addBlock(s.cid,{data:o,prefix:sg(s.cid)}))}catch(o){if(o.name!=="NotFoundError")throw o;if(this.log("do not have block for %c",s.cid),!s.sendDontHave||s.sentDoNotHave===!0)continue;s.sentDoNotHave=!0,t.addBlockPresence(s.cid,{cid:s.cid.bytes,type:rn.DoNotHaveBlock})}if(t.blocks.size>0||t.blockPresences.size>0){this.log("sending message"),await this.network.sendMessage(this.peerId,t,e),this.log("sent message"),this.sentBytes([...t.blocks.values()].reduce((i,s)=>i+s.data.byteLength,0));for(const i of r)this.wants.delete(i)}}}class _b{blockstore;network;ledgerMap;maxSizeReplaceHasWithBlock;log;logger;constructor(e,t={}){this.blockstore=e.blockstore,this.network=e.network,this.maxSizeReplaceHasWithBlock=t.maxSizeReplaceHasWithBlock,this.log=e.logger.forComponent("helia:bitswap:peer-want-lists"),this.logger=e.logger,this.ledgerMap=Zu({name:"helia_bitswap_ledger_map",metrics:e.metrics}),this.network.addEventListener("bitswap:message",r=>{this.receiveMessage(r.detail.peer,r.detail.message).catch(i=>{this.log.error("error receiving bitswap message from %p",r.detail.peer,i)})}),this.network.addEventListener("peer:disconnected",r=>{this.peerDisconnected(r.detail)})}ledgerForPeer(e){const t=this.ledgerMap.get(e);if(t!=null)return{peer:t.peerId,value:t.debtRatio(),sent:t.bytesSent,received:t.bytesReceived,exchanged:t.exchangeCount}}wantListForPeer(e){const t=this.ledgerMap.get(e);if(t!=null)return[...t.wants.values()]}peers(){return Array.from(this.ledgerMap.values()).map(e=>e.peerId)}async receiveMessage(e,t){let r=this.ledgerMap.get(e);if(r==null&&(r=new kb({peerId:e,blockstore:this.blockstore,network:this.network,logger:this.logger},{maxSizeReplaceHasWithBlock:this.maxSizeReplaceHasWithBlock}),this.ledgerMap.set(e,r)),r.receivedBytes(t.blocks?.reduce((i,s)=>i+s.data.byteLength,0)??0),t.wantlist!=null){t.wantlist.full===!0&&r.wants.clear();for(const i of t.wantlist.entries){const s=he.decode(i.cid),o=ee(s.multihash.bytes,"base64");i.cancel===!0?(this.log("peer %p cancelled want of block for %c",e,s),r.wants.delete(o)):(i.wantType===ut.WantHave?this.log("peer %p wanted block presence for %c",e,s):this.log("peer %p wanted block for %c",e,s),r.wants.set(o,{cid:s,priority:i.priority,wantType:i.wantType??ut.WantBlock,sendDontHave:i.sendDontHave??!1}))}}this.log("send blocks to peer"),await r.sendBlocksToPeer()}async receivedBlock(e,t){const r=ee(e.multihash.bytes,"base64"),i=[];for(const s of this.ledgerMap.values())s.wants.has(r)&&i.push(s);await Promise.all(i.map(async s=>s.sendBlocksToPeer(t)))}peerDisconnected(e){this.ledgerMap.delete(e)}}class j5 extends Error{constructor(e){super(e),this.name="TimeoutError"}}let Ib=class extends Error{constructor(e){super(),this.name="AbortError",this.message=e}};const og=n=>globalThis.DOMException===void 0?new Ib(n):new DOMException(n),ag=n=>{const e=n.reason===void 0?og("This operation was aborted."):n.reason;return e instanceof Error?e:og(e)};function Ju(n,e){const{milliseconds:t,fallback:r,message:i,customTimers:s={setTimeout,clearTimeout}}=e;let o,a;const l=new Promise((u,d)=>{if(typeof t!="number"||Math.sign(t)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${t}\``);if(e.signal){const{signal:f}=e;f.aborted&&d(ag(f)),a=()=>{d(ag(f))},f.addEventListener("abort",a,{once:!0})}if(t===Number.POSITIVE_INFINITY){n.then(u,d);return}const h=new j5;o=s.setTimeout.call(void 0,()=>{if(r){try{u(r())}catch(f){d(f)}return}typeof n.cancel=="function"&&n.cancel(),i===!1?u():i instanceof Error?d(i):(h.message=i??`Promise timed out after ${t} milliseconds`,d(h))},t),(async()=>{try{u(await n)}catch(f){d(f)}})()}).finally(()=>{l.clear(),a&&e.signal&&e.signal.removeEventListener("abort",a)});return l.clear=()=>{s.clearTimeout.call(void 0,o),o=void 0},l}function Cb(n,e,t){let r=0,i=n.length;for(;i>0;){const s=Math.trunc(i/2);let o=r+s;t(n[o],e)<=0?(r=++o,i-=s+1):i=s}return r}let Tb=class{#e=[];enqueue(e,t){t={priority:0,...t};const r={priority:t.priority,id:t.id,run:e};if(this.size===0||this.#e[this.size-1].priority>=t.priority){this.#e.push(r);return}const i=Cb(this.#e,r,(s,o)=>o.priority-s.priority);this.#e.splice(i,0,r)}setPriority(e,t){const r=this.#e.findIndex(s=>s.id===e);if(r===-1)throw new ReferenceError(`No promise function with the id "${e}" exists in the queue.`);const[i]=this.#e.splice(r,1);this.enqueue(i.run,{priority:t,id:e})}dequeue(){return this.#e.shift()?.run}filter(e){return this.#e.filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return this.#e.length}};class ed extends ev{#e;#t;#r=0;#o;#c;#l=0;#s;#n;#i;#f;#a=0;#d;#u;#h;#v=1n;timeout;constructor(e){if(super(),e={carryoverConcurrencyCount:!1,intervalCap:Number.POSITIVE_INFINITY,interval:0,concurrency:Number.POSITIVE_INFINITY,autoStart:!0,queueClass:Tb,...e},!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${e.intervalCap?.toString()??""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${e.interval?.toString()??""}\` (${typeof e.interval})`);this.#e=e.carryoverConcurrencyCount,this.#t=e.intervalCap===Number.POSITIVE_INFINITY||e.interval===0,this.#o=e.intervalCap,this.#c=e.interval,this.#i=new e.queueClass,this.#f=e.queueClass,this.concurrency=e.concurrency,this.timeout=e.timeout,this.#h=e.throwOnTimeout===!0,this.#u=e.autoStart===!1}get#b(){return this.#t||this.#r<this.#o}get#E(){return this.#a<this.#d}#S(){this.#a--,this.#p(),this.emit("next")}#x(){this.#w(),this.#y(),this.#n=void 0}get#A(){const e=Date.now();if(this.#s===void 0){const t=this.#l-e;if(t<0)this.#r=this.#e?this.#a:0;else return this.#n===void 0&&(this.#n=setTimeout(()=>{this.#x()},t)),!0}return!1}#p(){if(this.#i.size===0)return this.#s&&clearInterval(this.#s),this.#s=void 0,this.emit("empty"),this.#a===0&&this.emit("idle"),!1;if(!this.#u){const e=!this.#A;if(this.#b&&this.#E){const t=this.#i.dequeue();return t?(this.emit("active"),t(),e&&this.#y(),!0):!1}}return!1}#y(){this.#t||this.#s!==void 0||(this.#s=setInterval(()=>{this.#w()},this.#c),this.#l=Date.now()+this.#c)}#w(){this.#r===0&&this.#a===0&&this.#s&&(clearInterval(this.#s),this.#s=void 0),this.#r=this.#e?this.#a:0,this.#g()}#g(){for(;this.#p(););}get concurrency(){return this.#d}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this.#d=e,this.#g()}async#k(e){return new Promise((t,r)=>{e.addEventListener("abort",()=>{r(e.reason)},{once:!0})})}setPriority(e,t){this.#i.setPriority(e,t)}async add(e,t={}){return t.id??=(this.#v++).toString(),t={timeout:this.timeout,throwOnTimeout:this.#h,...t},new Promise((r,i)=>{this.#i.enqueue(async()=>{this.#a++;try{t.signal?.throwIfAborted(),this.#r++;let s=e({signal:t.signal});t.timeout&&(s=Ju(Promise.resolve(s),{milliseconds:t.timeout})),t.signal&&(s=Promise.race([s,this.#k(t.signal)]));const o=await s;r(o),this.emit("completed",o)}catch(s){if(s instanceof j5&&!t.throwOnTimeout){r();return}i(s),this.emit("error",s)}finally{this.#S()}},t),this.emit("add"),this.#p()})}async addAll(e,t){return Promise.all(e.map(async r=>this.add(r,t)))}start(){return this.#u?(this.#u=!1,this.#g(),this):this}pause(){this.#u=!0}clear(){this.#i=new this.#f}async onEmpty(){this.#i.size!==0&&await this.#m("empty")}async onSizeLessThan(e){this.#i.size<e||await this.#m("next",()=>this.#i.size<e)}async onIdle(){this.#a===0&&this.#i.size===0||await this.#m("idle")}async#m(e,t){return new Promise(r=>{const i=()=>{t&&!t()||(this.off(e,i),r())};this.on(e,i)})}get size(){return this.#i.size}sizeBy(e){return this.#i.filter(e).length}get pending(){return this.#a}get isPaused(){return this.#u}}function Q5(n){const e=[cn.A];return n==null?e:Array.isArray(n)?n.length===0?e:n:[n]}const Y5=60;function X5(n){return{Status:n.Status??0,TC:n.TC??n.flag_tc??!1,RD:n.RD??n.flag_rd??!1,RA:n.RA??n.flag_ra??!1,AD:n.AD??n.flag_ad??!1,CD:n.CD??n.flag_cd??!1,Question:(n.Question??n.questions??[]).map(e=>({name:e.name,type:cn[e.type]})),Answer:(n.Answer??n.answers??[]).map(e=>({name:e.name,type:cn[e.type],TTL:e.TTL??e.ttl??Y5,data:e.data instanceof Uint8Array?ee(e.data):e.data}))}}const Rb=4;function cg(n,e={}){const t=new ed({concurrency:e.queryConcurrency??Rb});return async(r,i={})=>{const s=new URLSearchParams;s.set("name",r),Q5(i.types).forEach(a=>{s.append("type",cn[a])}),i.onProgress?.(new P("dns:query",r));const o=await t.add(async()=>{const a=await fetch(`${n}?${s}`,{headers:{accept:"application/dns-json"},signal:i?.signal});if(a.status!==200)throw new Error(`Unexpected HTTP status: ${a.status} - ${a.statusText}`);const c=X5(await a.json());return i.onProgress?.(new P("dns:response",c)),c},{signal:i.signal});if(o==null)throw new Error("No DNS response received");return o}}function Pb(){return[cg("https://cloudflare-dns.com/dns-query"),cg("https://dns.google/resolve")]}var Sh,lg;function Ob(){return lg||(lg=1,Sh=function(n){if(!n)throw Error("hashlru must have a max value, of type number, greater than 0");var e=0,t=Object.create(null),r=Object.create(null);function i(s,o){t[s]=o,e++,e>=n&&(e=0,r=t,t=Object.create(null))}return{has:function(s){return t[s]!==void 0||r[s]!==void 0},remove:function(s){t[s]!==void 0&&(t[s]=void 0),r[s]!==void 0&&(r[s]=void 0)},get:function(s){var o=t[s];if(o!==void 0)return o;if((o=r[s])!==void 0)return i(s,o),o},set:function(s,o){t[s]!==void 0?t[s]=o:i(s,o)},clear:function(){t=Object.create(null),r=Object.create(null)}}}),Sh}var Nb=Ob();const Db=ao(Nb);class Lb{lru;constructor(e){this.lru=Db(e)}get(e,t){let r=!0;const i=[];for(const s of t){const o=this.getAnswers(e,s);if(o.length===0){r=!1;break}i.push(...o)}if(r)return X5({answers:i})}getAnswers(e,t){const r=`${e.toLowerCase()}-${t}`,i=this.lru.get(r);if(i!=null){const s=i.filter(o=>o.expires>Date.now()).map(({expires:o,value:a})=>({...a,TTL:Math.round((o-Date.now())/1e3),type:cn[a.type]}));return s.length===0&&this.lru.remove(r),s}return[]}add(e,t){const r=`${e.toLowerCase()}-${t.type}`,i=this.lru.get(r)??[];i.push({expires:Date.now()+(t.TTL??Y5)*1e3,value:t}),this.lru.set(r,i)}remove(e,t){const r=`${e.toLowerCase()}-${t}`;this.lru.remove(r)}clear(){this.lru.clear()}}function Bb(n){return new Lb(n)}const Mb=1e3;let Fb=class{resolvers;cache;constructor(e){this.resolvers={},this.cache=Bb(e.cacheSize??Mb),Object.entries(e.resolvers??{}).forEach(([t,r])=>{Array.isArray(r)||(r=[r]),t.endsWith(".")||(t=`${t}.`),this.resolvers[t]=r}),this.resolvers["."]==null&&(this.resolvers["."]=Pb())}async query(e,t={}){const r=Q5(t.types),i=t.cached!==!1?this.cache.get(e,r):void 0;if(i!=null)return t.onProgress?.(new P("dns:cache",i)),i;const s=`${e.split(".").pop()}.`,o=(this.resolvers[s]??this.resolvers["."]).sort(()=>Math.random()>.5?-1:1),a=[];for(const c of o){if(t.signal?.aborted===!0)break;try{const l=await c(e,{...t,types:r});for(const u of l.Answer)this.cache.add(e,u);return l}catch(l){a.push(l),t.onProgress?.(new P("dns:error",l))}}throw a.length===1?a[0]:new AggregateError(a,`DNS lookup of ${e} ${r} failed`)}};var cn;(function(n){n[n.A=1]="A",n[n.CNAME=5]="CNAME",n[n.TXT=16]="TXT",n[n.AAAA=28]="AAAA"})(cn||(cn={}));function Cl(n={}){return new Fb(n)}const wn="/",Z5=new TextEncoder().encode(wn),Lc=Z5[0];class Te{_buf;constructor(e,t){if(typeof e=="string")this._buf=C(e);else if(e instanceof Uint8Array)this._buf=e;else throw new Error("Invalid key, should be String of Uint8Array");if(t==null&&(t=!0),t&&this.clean(),this._buf.byteLength===0||this._buf[0]!==Lc)throw new Error("Invalid key")}toString(e="utf8"){return ee(this._buf,e)}uint8Array(){return this._buf}get[Symbol.toStringTag](){return`Key(${this.toString()})`}static withNamespaces(e){return new Te(e.join(wn))}static random(){return new Te(Math.random().toString().substring(2))}static asKey(e){return e instanceof Uint8Array||typeof e=="string"?new Te(e):typeof e.uint8Array=="function"?new Te(e.uint8Array()):null}clean(){if((this._buf==null||this._buf.byteLength===0)&&(this._buf=Z5),this._buf[0]!==Lc){const e=new Uint8Array(this._buf.byteLength+1);e.fill(Lc,0,1),e.set(this._buf,1),this._buf=e}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===Lc;)this._buf=this._buf.subarray(0,-1)}less(e){const t=this.list(),r=e.list();for(let i=0;i<t.length;i++){if(r.length<i+1)return!1;const s=t[i],o=r[i];if(s<o)return!0;if(s>o)return!1}return t.length<r.length}reverse(){return Te.withNamespaces(this.list().slice().reverse())}namespaces(){return this.list()}baseNamespace(){const e=this.namespaces();return e[e.length-1]}list(){return this.toString().split(wn).slice(1)}type(){return Ub(this.baseNamespace())}name(){return $b(this.baseNamespace())}instance(e){return new Te(this.toString()+":"+e)}path(){let e=this.parent().toString();return e.endsWith(wn)||(e+=wn),e+=this.type(),new Te(e)}parent(){const e=this.list();return e.length===1?new Te(wn):new Te(e.slice(0,-1).join(wn))}child(e){return this.toString()===wn?e:e.toString()===wn?this:new Te(this.toString()+e.toString(),!1)}isAncestorOf(e){return e.toString()===this.toString()?!1:e.toString().startsWith(this.toString())}isDecendantOf(e){return e.toString()===this.toString()?!1:this.toString().startsWith(e.toString())}isTopLevel(){return this.list().length===1}concat(...e){return Te.withNamespaces([...this.namespaces(),...Vb(e.map(t=>t.namespaces()))])}}function Ub(n){const e=n.split(":");return e.length<2?"":e.slice(0,-1).join(":")}function $b(n){const e=n.split(":");return e[e.length-1]}function Vb(n){return[].concat(...n)}const J5="/pin/",ug="/pinned-block/",I1=Li,dg=1;function Bc(n){return n.version===0&&(n=n.toV1()),new Te(`${J5}${n.toString(I1)}`)}class qb{datastore;blockstore;getCodec;constructor(e,t,r){this.datastore=e,this.blockstore=t,this.getCodec=r}async*add(e,t={}){const r=Bc(e);if(await this.datastore.has(r))throw new Error("Already pinned");const i=Math.round(t.depth??1/0);if(i<0)throw new Error("Depth must be greater than or equal to 0");const s=new si({concurrency:dg});for await(const a of this.#e(e,s,{...t,depth:i}))await this.#t(a,c=>c.pinnedBy.find(l=>Ue(l,e.bytes))!=null?!1:(c.pinCount++,c.pinnedBy.push(e.bytes),!0),t),yield a;const o={depth:i,metadata:t.metadata??{}};await this.datastore.put(r,al(o),t)}async*#e(e,t,r){if(r.depth===-1)return;const i=await this.getCodec(e.code),s=await this.blockstore.get(e,r),o=A1({bytes:s,cid:e,codec:i});yield e;for(const[,a]of o.links())yield*await t.add(async()=>this.#e(a,t,{...r,depth:r.depth-1}))}async#t(e,t,r){const i=new Te(`${ug}${I1.encode(e.multihash.bytes)}`);let s={pinCount:0,pinnedBy:[]};try{s=Si(await this.datastore.get(i,r))}catch(a){if(a.name!=="NotFoundError")throw a}if(t(s)){if(s.pinCount===0&&await this.datastore.has(i)){await this.datastore.delete(i);return}await this.datastore.put(i,al(s),r),r.onProgress?.(new P("helia:pin:add",e))}}async*rm(e,t={}){const r=Bc(e),i=await this.datastore.get(r,t),s=Si(i);await this.datastore.delete(r,t);const o=new si({concurrency:dg});for await(const a of this.#e(e,o,{...t,depth:s.depth}))await this.#t(a,c=>(c.pinCount--,c.pinnedBy=c.pinnedBy.filter(l=>Ue(l,e.bytes)),!0),{...t,depth:s.depth}),yield a}async*ls(e={}){for await(const{key:t,value:r}of this.datastore.query({prefix:J5+(e.cid!=null?`${e.cid.toString(Li)}`:"")},e)){const i=he.parse(t.toString().substring(5),Li),s=Si(r);yield{cid:i,...s}}}async isPinned(e,t={}){const r=new Te(`${ug}${I1.encode(e.multihash.bytes)}`);return this.datastore.has(r,t)}async get(e,t){const r=Bc(e),i=await this.datastore.get(r,t);return Si(i)}async setMetadata(e,t,r){const i=Bc(e),s=await this.datastore.get(i,r),o=Si(s);o.metadata=t??{},await this.datastore.put(i,al(o),r)}}const Hb=1,zb=5;class Kb extends Error{static name="InsufficientProvidersError";constructor(e="Insufficient providers found"){super(e),this.name="InsufficientProvidersError"}}class Mc extends Error{static name="NoRoutersAvailableError";constructor(e="No routers available"){super(e),this.name="NoRoutersAvailableError"}}class Wb extends Error{static name="UnknownHashAlgorithmError";constructor(e="Unknown hash algorithm"){super(e),this.name="UnknownHashAlgorithmError"}}class Gb extends Error{static name="UnknownCodecError";constructor(e="Unknown codec"){super(e),this.name="UnknownCodecError"}}const jb=5;class Qb{log;routers;providerLookupConcurrency;constructor(e,t){this.log=e.logger.forComponent("helia:routing"),this.routers=t.routers??[],this.providerLookupConcurrency=t.providerLookupConcurrency??jb,this.findProviders=e.metrics?.traceFunction("helia.routing.findProviders",this.findProviders.bind(this),{optionsIndex:1})??this.findProviders,this.provide=e.metrics?.traceFunction("helia.routing.provide",this.provide.bind(this),{optionsIndex:1})??this.provide,this.cancelReprovide=e.metrics?.traceFunction("helia.routing.cancelReprovide",this.cancelReprovide.bind(this),{optionsIndex:1})??this.cancelReprovide,this.put=e.metrics?.traceFunction("helia.routing.put",this.put.bind(this),{optionsIndex:2})??this.put,this.get=e.metrics?.traceFunction("helia.routing.get",this.get.bind(this),{optionsIndex:1})??this.get,this.findPeer=e.metrics?.traceFunction("helia.routing.findPeer",this.findPeer.bind(this),{optionsIndex:1})??this.findPeer,this.getClosestPeers=e.metrics?.traceFunction("helia.routing.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1})??this.getClosestPeers}async start(){await Sn(...this.routers)}async stop(){await hi(...this.routers)}async*findProviders(e,t={}){if(this.routers.length===0)throw new Mc("No content routers available");const r=new oi({concurrency:this.providerLookupConcurrency});r.addEventListener("error",()=>{});for await(const i of Zn(r.toGenerator(),...yi(this.routers,"findProviders").map(s=>s.findProviders(e,t))))if(i!=null){if(i.multiaddrs.length===0){if(r.find(i.id)!=null)continue;r.add(async()=>{try{const s=await this.findPeer(i.id,t);return s.multiaddrs.length===0?null:s}catch(s){return this.log.error("could not load multiaddrs for peer %p",i.id,s),null}},{peerId:i.id,signal:t.signal}).catch(s=>{this.log.error("could not load multiaddrs for peer %p",i.id,s)})}yield i}}async provide(e,t={}){if(this.routers.length===0)throw new Mc("No content routers available");await Promise.all(yi(this.routers,"provide").map(async r=>{await r.provide(e,t)}))}async cancelReprovide(e,t={}){await Promise.all(yi(this.routers,"cancelReprovide").map(async r=>{await r.cancelReprovide(e,t)}))}async put(e,t,r){await Promise.all(yi(this.routers,"put").map(async i=>{await i.put(e,t,r)}))}async get(e,t){return Promise.any(yi(this.routers,"get").map(async r=>r.get(e,t)))}async findPeer(e,t){if(this.routers.length===0)throw new Mc("No peer routers available");const r=this,i=Zn(...yi(this.routers,"findPeer").map(s=>(async function*(){try{yield await s.findPeer(e,t)}catch(o){r.log.error(o)}})()));for await(const s of i)if(s!=null)return s;throw new Xe("Could not find peer in routing")}async*getClosestPeers(e,t={}){if(this.routers.length===0)throw new Mc("No peer routers available");for await(const r of Zn(...yi(this.routers,"getClosestPeers").map(i=>i.getClosestPeers(e,t))))r!=null&&(yield r)}}function yi(n,e){return n.filter(t=>t[e]!=null)}class Yb extends Error{static name="QueueFullError";constructor(e="The queue was full"){super(e),this.name="QueueFullError"}}class Xb{deferred;signal;constructor(e){this.signal=e,this.deferred=Promise.withResolvers(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new Ls)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}}function Zb(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}class Jb{id;fn;options;recipients;status;timeline;controller;constructor(e,t){this.id=Zb(),this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce((t,r)=>t&&r.signal?.aborted===!0,!0)&&(this.controller.abort(new Ls),this.cleanup())}async join(e={}){const t=new Xb(e.signal);return this.recipients.push(t),e.signal?.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();const e=await ht(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(t=>{t.deferred.resolve(e)}),this.status="complete"}catch(e){this.recipients.forEach(t=>{t.deferred.reject(e)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(e=>{e.cleanup(),e.signal?.removeEventListener("abort",this.onAbort)})}}function hg(n,e){let t;const r=function(){const i=function(){t=void 0,n()};clearTimeout(t),t=setTimeout(i,e)};return r.start=()=>{},r.stop=()=>{clearTimeout(t)},r}class fg extends tt{concurrency;maxSize;queue;pending;sort;autoStart;constructor(e={}){super(),this.concurrency=e.concurrency??Number.POSITIVE_INFINITY,this.maxSize=e.maxSize??Number.POSITIVE_INFINITY,this.pending=0,this.autoStart=e.autoStart??!0,this.sort=e.sort,this.queue=[],this.emitEmpty=hg(this.emitEmpty.bind(this),1),this.emitIdle=hg(this.emitIdle.bind(this),1)}[Symbol.asyncIterator](){return this.toGenerator()}emitEmpty(){this.size===0&&this.safeDispatchEvent("empty")}emitIdle(){this.running===0&&this.safeDispatchEvent("idle")}tryToStartAnother(){if(this.size===0)return this.emitEmpty(),this.running===0&&this.emitIdle(),!1;if(this.pending<this.concurrency){let e;for(const t of this.queue)if(t.status==="queued"){e=t;break}return e==null?!1:(this.safeDispatchEvent("active"),this.pending++,e.run().finally(()=>{for(let t=0;t<this.queue.length;t++)if(this.queue[t]===e){this.queue.splice(t,1);break}this.pending--,this.safeDispatchEvent("next"),this.autoStart&&this.tryToStartAnother()}),!0)}return!1}enqueue(e){this.queue.push(e),this.sort!=null&&this.queue.sort(this.sort)}start(){this.autoStart===!1&&(this.autoStart=!0,this.tryToStartAnother())}pause(){this.autoStart=!1}async add(e,t){if(t?.signal?.throwIfAborted(),this.size===this.maxSize)throw new Yb;const r=new Jb(e,t);return this.enqueue(r),this.safeDispatchEvent("add"),this.autoStart&&this.tryToStartAnother(),r.join(t).then(i=>(this.safeDispatchEvent("success",{detail:{job:r,result:i}}),i)).catch(i=>{if(r.status==="queued"){for(let s=0;s<this.queue.length;s++)if(this.queue[s]===r){this.queue.splice(s,1);break}}throw this.safeDispatchEvent("failure",{detail:{job:r,error:i}}),i})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(e=>{e.abort(new Ls)}),this.clear()}async onEmpty(e){this.size!==0&&await Ut(this,"empty",e?.signal)}async onSizeLessThan(e,t){this.size<e||await Ut(this,"next",t?.signal,{filter:()=>this.size<e})}async onIdle(e){this.pending===0&&this.size===0||await Ut(this,"idle",e?.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(e){e?.signal?.throwIfAborted();const t=fn({objectMode:!0}),r=c=>{c!=null?this.abort():this.clear(),t.end(c)},i=c=>{c.detail!=null&&t.push(c.detail.result)},s=c=>{r(c.detail.error)},o=()=>{r()},a=()=>{r(new Ls("Queue aborted"))};this.addEventListener("success",i),this.addEventListener("failure",s),this.addEventListener("idle",o),e?.signal?.addEventListener("abort",a);try{yield*t}finally{this.removeEventListener("success",i),this.removeEventListener("failure",s),this.removeEventListener("idle",o),e?.signal?.removeEventListener("abort",a),r()}}}const e6="lock:worker:request-read",t6="lock:worker:abort-read-request",r6="lock:worker:release-read",n6="lock:master:grant-read",i6="lock:master:error-read",s6="lock:worker:request-write",o6="lock:worker:abort-write-request",a6="lock:worker:release-write",c6="lock:master:grant-write",l6="lock:master:error-write",u6="lock:worker:finalize",d6="mortice",eE={singleProcess:!1},pg=(n,e,t,r,i,s,o,a,c)=>l=>{if(l.data==null)return;const u={type:l.data.type,name:l.data.name,identifier:l.data.identifier};u.type===i&&n.safeDispatchEvent(t,{detail:{name:u.name,identifier:u.identifier,handler:async()=>{e.postMessage({type:c,name:u.name,identifier:u.identifier}),await new Promise(d=>{const h=f=>{if(f?.data==null)return;const m={type:f.data.type,name:f.data.name,identifier:f.data.identifier};m.type===a&&m.identifier===u.identifier&&(e.removeEventListener("message",h),d())};e.addEventListener("message",h)})},onError:d=>{e.postMessage({type:o,name:u.name,identifier:u.identifier,error:{message:d.message,name:d.name,stack:d.stack}})}}}),u.type===s&&n.safeDispatchEvent(r,{detail:{name:u.name,identifier:u.identifier}}),u.type===u6&&n.safeDispatchEvent("finalizeRequest",{detail:{name:u.name}})},tE=(n=10)=>Math.random().toString().substring(2,n+2);class rE{name;channel;constructor(e){this.name=e,this.channel=new BroadcastChannel(d6)}readLock(e){return this.sendRequest(e6,t6,n6,i6,r6,e)}writeLock(e){return this.sendRequest(s6,o6,c6,l6,a6,e)}finalize(){this.channel.postMessage({type:u6,name:this.name}),this.channel.close()}async sendRequest(e,t,r,i,s,o){o?.signal?.throwIfAborted();const a=tE();return this.channel.postMessage({type:e,identifier:a,name:this.name}),new Promise((c,l)=>{const u=()=>{this.channel.postMessage({type:t,identifier:a,name:this.name})};o?.signal?.addEventListener("abort",u,{once:!0});const d=h=>{if(h.data?.identifier===a&&(h.data?.type===r&&(this.channel.removeEventListener("message",d),o?.signal?.removeEventListener("abort",u),c(()=>{this.channel.postMessage({type:s,identifier:a,name:this.name})})),h.data.type===i)){this.channel.removeEventListener("message",d),o?.signal?.removeEventListener("abort",u);const f=new Error;h.data.error!=null&&(f.message=h.data.error.message,f.name=h.data.error.name,f.stack=h.data.error.stack),l(f)}};this.channel.addEventListener("message",d)})}}const nE=n=>{if(n=Object.assign({},eE,n),!!globalThis.document||n.singleProcess){const t=new BroadcastChannel(d6),r=new tt;return t.addEventListener("message",pg(r,t,"requestReadLock","abortReadLockRequest",e6,t6,i6,r6,n6)),t.addEventListener("message",pg(r,t,"requestWriteLock","abortWriteLockRequest",s6,o6,l6,a6,c6)),r}return new rE(n.name)},Ti=new Map;let _o;function h6(n){return typeof n?.readLock=="function"&&typeof n?.writeLock=="function"}function iE(n){if(_o==null&&(_o=nE(n),!h6(_o))){const e=_o;e.addEventListener("requestReadLock",t=>{const r=t.detail.name,i=t.detail.identifier,s=Ti.get(r);if(s==null)return;const o=new AbortController,a=c=>{c.detail.name!==r||c.detail.identifier!==i||o.abort()};e.addEventListener("abortReadLockRequest",a),s.readLock({signal:o.signal}).then(async c=>{await t.detail.handler().finally(()=>{c()})}).catch(c=>{t.detail.onError(c)}).finally(()=>{e.removeEventListener("abortReadLockRequest",a)})}),e.addEventListener("requestWriteLock",t=>{const r=t.detail.name,i=t.detail.identifier,s=Ti.get(r);if(s==null)return;const o=new AbortController,a=c=>{c.detail.name!==r||c.detail.identifier!==i||o.abort()};e.addEventListener("abortWriteLockRequest",a),s.writeLock({signal:o.signal}).then(async c=>{await t.detail.handler().finally(()=>{c()})}).catch(c=>{t.detail.onError(c)}).finally(()=>{e.removeEventListener("abortWriteLockRequest",a)})}),e.addEventListener("finalizeRequest",t=>{const r=t.detail.name,i=Ti.get(r);i?.finalize()})}return _o}async function xh(n,e){let t,r;const i=new Promise((o,a)=>{t=o,r=a}),s=()=>{r(new Ls)};return e?.signal?.addEventListener("abort",s,{once:!0}),n.add(async()=>{await new Promise(o=>{t(()=>{e?.signal?.removeEventListener("abort",s),o()})})},{signal:e?.signal}).catch(o=>{r(o)}),i}const sE=(n,e)=>{let t=Ti.get(n);if(t!=null)return t;const r=iE(e);if(h6(r))return t=r,Ti.set(n,t),t;const i=new fg({concurrency:1});let s;return t={async readLock(o){if(s!=null)return xh(s,o);s=new fg({concurrency:e.concurrency,autoStart:!1});const a=s,c=xh(s,o);return i.add(async()=>{a.start(),await a.onIdle().then(()=>{s===a&&(s=null)})}),c},async writeLock(o){return s=null,xh(i,o)},finalize:()=>{Ti.delete(n)},queue:i},Ti.set(n,t),e.autoFinalize===!0&&i.addEventListener("idle",()=>{t.finalize()},{once:!0}),t},oE={name:"lock",concurrency:1/0,singleProcess:!1,autoFinalize:!1};function f6(n){const e=Object.assign({},oE,n);return sE(e.name,e)}class aE{lock;child;pins;started;constructor(e,t,r={}){this.child=e,this.pins=t,this.lock=f6({singleProcess:r.holdGcLock}),this.started=!1}isStarted(){return this.started}async start(){await Sn(this.child),this.started=!0}async stop(){await hi(this.child),this.started=!1}unwrap(){return this.child}async put(e,t,r={}){r?.signal?.throwIfAborted();const i=await this.lock.readLock();try{return await this.child.put(e,t,r)}finally{i()}}async*putMany(e,t={}){t?.signal?.throwIfAborted();const r=await this.lock.readLock();try{yield*this.child.putMany(e,t)}finally{r()}}async get(e,t={}){t?.signal?.throwIfAborted();const r=await this.lock.readLock();try{return await this.child.get(e,t)}finally{r()}}async*getMany(e,t={}){t?.signal?.throwIfAborted();const r=await this.lock.readLock();try{yield*this.child.getMany(e,t)}finally{r()}}async delete(e,t={}){t?.signal?.throwIfAborted();const r=await this.lock.writeLock();try{if(await this.pins.isPinned(e))throw new Error("CID was pinned");await this.child.delete(e,t)}finally{r()}}async*deleteMany(e,t={}){t?.signal?.throwIfAborted();const r=await this.lock.writeLock();try{const i=this;yield*this.child.deleteMany((async function*(){for await(const s of e){if(await i.pins.isPinned(s))throw new Error("CID was pinned");yield s}})(),t)}finally{r()}}async has(e,t={}){t?.signal?.throwIfAborted();const r=await this.lock.readLock();try{return await this.child.has(e,t)}finally{r()}}async*getAll(e={}){e?.signal?.throwIfAborted();const t=await this.lock.readLock();try{yield*this.child.getAll(e)}finally{t()}}createSession(e,t){return t?.signal?.throwIfAborted(),this.child.createSession(e,t)}}const Ah=new Te("/version"),gg=1;async function cE(n){if(!await n.has(Ah)){await n.put(Ah,C(`${gg}`));return}const e=await n.get(Ah),t=ee(e);if(parseInt(t,10)!==gg)throw new Error("Unknown datastore version, a datastore migration may be required")}function sp(n){return n?.then!=null}function lE(n=[],e){const t={[qt]:ic,[er]:d5,[ii]:lw,[Is]:xw,[ka]:Sw};return n.forEach(r=>{t[r.code]=r}),async r=>{let i=t[r];if(i==null&&e!=null){const s=e(r);sp(s)?i=await s:i=s,t[i.code]=i}if(i!=null)return i;throw new Gb(`Could not load codec for ${r}`)}}function uE(n=[],e){const t={[gt.code]:gt,[q2.code]:q2,[_a.code]:_a};return n.forEach(r=>{t[r.code]=r}),async r=>{let i=t[r];if(i==null&&e!=null){const s=e(r);sp(s)?i=await s:i=s,t[i.code]=i}if(i!=null)return i;throw new Wb(`No hasher configured for multihash code 0x${r.toString(16)}, please configure one. You can look up which hash this is at https://github.com/multiformats/multicodec/blob/master/table.csv`)}}let op=class C1 extends Error{static name="NotFoundError";static code="ERR_NOT_FOUND";name=C1.name;code=C1.code;constructor(e="Not Found"){super(e)}};class p6{has(e,t){return Promise.reject(new Error(".has is not implemented"))}put(e,t,r){return Promise.reject(new Error(".put is not implemented"))}async*putMany(e,t){for await(const{cid:r,block:i}of e)await this.put(r,i,t),yield r}get(e,t){return Promise.reject(new Error(".get is not implemented"))}async*getMany(e,t){for await(const r of e)yield{cid:r,block:await this.get(r,t)}}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*deleteMany(e,t){for await(const r of e)await this.delete(r,t),yield r}async*getAll(e){throw new Error(".getAll is not implemented")}}const Fc=0;class dE extends p6{child;constructor(e){super(),this.child=e}put(e,t,r){return e.multihash.code===Fc||this.child==null?(r?.signal?.throwIfAborted(),e):this.child.put(e,t,r)}get(e,t){if(e.multihash.code===Fc)return t?.signal?.throwIfAborted(),e.multihash.digest;if(this.child==null)throw t?.signal?.throwIfAborted(),new op;return this.child.get(e,t)}has(e,t){return e.multihash.code===Fc?(t?.signal?.throwIfAborted(),!0):this.child==null?(t?.signal?.throwIfAborted(),!1):this.child.has(e,t)}delete(e,t){if(e.code===Fc){t?.signal?.throwIfAborted();return}if(this.child!=null)return this.child.delete(e,t)}getAll(e){return this.child!=null?this.child.getAll(e):(e?.signal?.throwIfAborted(),[])}}function hE(n){return n[Symbol.asyncIterator]!=null}function zn(n,e){let t=0;if(hE(n))return(async function*(){for await(const c of n)await e(c,t++)&&(yield c)})();const r=h5(n),{value:i,done:s}=r.next();if(s===!0)return(function*(){})();const o=e(i,t++);if(typeof o.then=="function")return(async function*(){await o&&(yield i);for(const c of r)await e(c,t++)&&(yield c)})();const a=e;return(function*(){o===!0&&(yield i);for(const c of r)a(c,t++)&&(yield c)})()}function fE(n){return n[Symbol.asyncIterator]!=null}function mg(n){return n?.then!=null}function Tl(n,e){let t=0;if(fE(n))return(async function*(){for await(const c of n){const l=e(c,t++);mg(l)&&await l,yield c}})();const r=h5(n),{value:i,done:s}=r.next();if(s===!0)return(function*(){})();if(typeof e(i,t++)?.then=="function")return(async function*(){yield i;for(const c of r){const l=e(c,t++);mg(l)&&await l,yield c}})();const a=e;return(function*(){yield i;for(const c of r)a(c,t++),yield c})()}class g6{child;getHasher;log;logger;components;constructor(e){this.log=e.logger.forComponent("helia:networked-storage"),this.logger=e.logger,this.components=e,this.child=new dE(e.blockstore),this.getHasher=e.getHasher}async put(e,t,r={}){return await this.child.has(e,r)?(r.onProgress?.(new P("blocks:put:duplicate",e)),e):(r.onProgress?.(new P("blocks:put:providers:notify",e)),await Promise.all(this.components.blockBrokers.map(async i=>i.announce?.(e,t,r))),r.onProgress?.(new P("blocks:put:blockstore:put",e)),this.child.put(e,t,r))}async*putMany(e,t={}){const r=zn(e,async({cid:s})=>{const o=await this.child.has(s,t);return o&&t.onProgress?.(new P("blocks:put-many:duplicate",s)),!o}),i=Tl(r,async({cid:s,block:o})=>{t.onProgress?.(new P("blocks:put-many:providers:notify",s)),await Promise.all(this.components.blockBrokers.map(async a=>a.announce?.(s,o,t)))});t.onProgress?.(new P("blocks:put-many:blockstore:put-many")),yield*this.child.putMany(i,t)}async get(e,t={}){if(t.offline!==!0&&!await this.child.has(e,t)){const r=await this.getHasher(e.multihash.code);t.onProgress?.(new P("blocks:get:providers:get",e));const i=await yg(e,this.components.blockBrokers,r,{...t,log:this.log});return t.onProgress?.(new P("blocks:get:blockstore:put",e)),await this.child.put(e,i,t),t.onProgress?.(new P("blocks:get:providers:notify",e)),await Promise.all(this.components.blockBrokers.map(async s=>s.announce?.(e,i,t))),i}return t.onProgress?.(new P("blocks:get:blockstore:get",e)),this.child.get(e,t)}async*getMany(e,t={}){t.onProgress?.(new P("blocks:get-many:blockstore:get-many")),yield*this.child.getMany(Tl(e,async r=>{if(t.offline!==!0&&!await this.child.has(r,t)){const i=await this.getHasher(r.multihash.code);t.onProgress?.(new P("blocks:get-many:providers:get",r));const s=await yg(r,this.components.blockBrokers,i,{...t,log:this.log});t.onProgress?.(new P("blocks:get-many:blockstore:put",r)),await this.child.put(r,s,t),t.onProgress?.(new P("blocks:get-many:providers:notify",r)),await Promise.all(this.components.blockBrokers.map(async o=>o.announce?.(r,s,t)))}}))}async delete(e,t={}){t.onProgress?.(new P("blocks:delete:blockstore:delete",e)),await this.child.delete(e,t)}async*deleteMany(e,t={}){t.onProgress?.(new P("blocks:delete-many:blockstore:delete-many")),yield*this.child.deleteMany((async function*(){for await(const r of e)yield r})(),t)}async has(e,t={}){return this.child.has(e,t)}async*getAll(e={}){e.onProgress?.(new P("blocks:get-all:blockstore:get-many")),yield*this.child.getAll(e)}}class pE extends g6{started;constructor(e){super(e),this.started=!1}isStarted(){return this.started}async start(){await Sn(this.child,...this.components.blockBrokers),this.started=!0}async stop(){await hi(this.child,...this.components.blockBrokers),this.started=!1}unwrap(){return this.child}createSession(e,t){const r=this.components.blockBrokers.map(i=>i.createSession==null?i:i.createSession(t));return new gE({blockstore:this.child,blockBrokers:r,getHasher:this.getHasher,logger:this.logger},{root:e})}}class gE extends g6{closeController;constructor(e,t){super(e),this.closeController=new AbortController,this.closeController.signal,this.log=e.logger.forComponent(`helia:session-storage:${t.root}`)}close(){this.closeController.abort()}async put(e,t,r={}){const i=Re([this.closeController.signal,r.signal]);try{return await super.put(e,t,{...r,signal:i})}finally{i.clear()}}async*putMany(e,t={}){const r=Re([this.closeController.signal,t.signal]);try{yield*super.putMany(e,{...t,signal:r})}finally{r.clear()}}async get(e,t={}){const r=Re([this.closeController.signal,t.signal]);try{return await super.get(e,{...t,signal:r})}finally{r.clear()}}async*getMany(e,t={}){const r=Re([this.closeController.signal,t.signal]);try{yield*super.getMany(e,{...t,signal:r})}finally{r.clear()}}async delete(e,t={}){const r=Re([this.closeController.signal,t.signal]);try{await super.delete(e,{...t,signal:r})}finally{r.clear()}}async*deleteMany(e,t={}){const r=Re([this.closeController.signal,t.signal]);try{yield*super.deleteMany(e,{...t,signal:r})}finally{r.clear()}}async has(e,t={}){const r=Re([this.closeController.signal,t.signal]);try{return await super.has(e,{...t,signal:r})}finally{r.clear()}}async*getAll(e={}){const t=Re([this.closeController.signal,e.signal]);try{yield*super.getAll({...e,signal:t})}finally{t.clear()}}}function mE(n){return typeof n.retrieve=="function"}const yE=(n,e)=>{if(e==null)throw new $(`No hasher configured for multihash code 0x${n.multihash.code.toString(16)}, please configure one. You can look up which hash this is at https://github.com/multiformats/multicodec/blob/master/table.csv`);return async t=>{let r;const i=e.digest(t);if(sp(i)?r=await i:r=i,!Ue(r.digest,n.multihash.digest))throw new f5("Hash of downloaded block did not match multihash from passed CID")}};async function yg(n,e,t,r){const i=yE(n,t),s=new AbortController,o=Re([s.signal,r.signal]);s.signal;const a=[];for(const c of e)mE(c)&&a.push(c);try{return await Promise.any(a.map(async c=>{try{let l=!1;const u=await c.retrieve(n,{...r,signal:o,validateFn:async d=>{await i(d),l=!0}});return l||await i(u),u}catch(l){throw r.log.error("could not retrieve verified block for %c",n,l),l}}))}finally{s.abort(),o.clear()}}class m6 extends tt{initialPeerSearchComplete;requests;name;log;logger;minProviders;maxProviders;providers;evictionFilter;initialProviders;constructor(e,t){super(),this.name=t.name,this.logger=e.logger,this.log=e.logger.forComponent(this.name),this.requests=new Map,this.minProviders=t.minProviders??Hb,this.maxProviders=t.maxProviders??zb,this.providers=[],this.evictionFilter=ai(this.maxProviders),this.initialProviders=t.providers??[]}async retrieve(e,t={}){const r=Fr.encode(e.multihash.bytes),i=this.requests.get(r);if(i!=null)return this.log("join existing request for %c",e),i;const s=we();if(this.requests.set(r,s.promise),this.providers.length===0){let u=!1;this.initialPeerSearchComplete==null&&(u=!0,this.log=this.logger.forComponent(`${this.name}:${e}`),this.initialPeerSearchComplete=this.findProviders(e,this.minProviders,t)),await this.initialPeerSearchComplete,u&&this.log("found initial session peers for %c",e)}let o=!1;const a=new si({concurrency:this.maxProviders});a.addEventListener("error",()=>{}),a.addEventListener("failure",u=>{this.log.error("error querying provider %o, evicting from session",u.detail.job.options.provider,u.detail.error),this.evict(u.detail.job.options.provider)}),a.addEventListener("success",u=>{o=!0,s.resolve(u.detail.result)}),a.addEventListener("idle",()=>{if(o||t.signal?.aborted===!0){this.log.trace("session idle, found block");return}Promise.resolve().then(async()=>{this.log("no session peers had block for for %c, finding new providers",e);for(let u=0;u<this.minProviders&&this.providers.length!==0;u++){const d=this.providers[Math.floor(Math.random()*this.providers.length)];this.evict(d)}await this.findProviders(e,this.minProviders,t),this.log("found new providers re-retrieving %c",e),this.requests.delete(r),s.resolve(await this.retrieve(e,t))}).catch(u=>{this.log.error("could not find new providers for %c",e,u),s.reject(u)})});const c=u=>{a.add(async()=>this.queryProvider(e,u.detail,t),{provider:u.detail}).catch(d=>{t.signal?.aborted!==!0&&this.log.error("error retrieving session block for %c",e,d)})};this.addEventListener("provider",c),Promise.all([...this.providers].map(async u=>a.add(async()=>this.queryProvider(e,u,t),{provider:u}))).catch(u=>{t.signal?.aborted!==!0&&this.log.error("error retrieving session block for %c",e,u)});const l=()=>{s.reject(new pt(t.signal?.reason??"Session aborted")),a.abort()};t.signal?.addEventListener("abort",l);try{return await s.promise}finally{this.removeEventListener("provider",c),t.signal?.removeEventListener("abort",l),a.clear(),this.requests.delete(r)}}evict(e){this.evictionFilter.add(this.toEvictionKey(e));const t=this.providers.findIndex(r=>this.equals(r,e));t!==-1&&this.providers.splice(t,1)}isEvicted(e){return this.evictionFilter.has(this.toEvictionKey(e))}hasProvider(e){return!!(this.providers.find(t=>this.equals(t,e))!=null||this.isEvicted(e))}async findProviders(e,t,r){const i=we();let s=0;return Promise.resolve().then(async()=>{if(this.log("finding %d-%d new provider(s) for %c",t,this.maxProviders,e),this.initialProviders.length>0)for(;s<t&&this.initialProviders.length>0;){const o=this.initialProviders.pop();if(o==null)break;const a=await this.convertToProvider(o,r);if(r.signal?.aborted===!0)break;if(a!=null&&!this.hasProvider(a)&&(this.log("found %d/%d new providers",s,this.maxProviders),this.providers.push(a),this.safeDispatchEvent("provider",{detail:a}),s++,s===t&&(this.log("session is ready"),i.resolve()),this.providers.length===this.maxProviders)){this.log("found max session peers",s);break}}if(s<this.maxProviders)for await(const o of this.findNewProviders(e,r)){if(s===this.maxProviders||r.signal?.aborted===!0)break;if(!this.hasProvider(o)&&(this.log("found %d/%d new providers",s,this.maxProviders),this.providers.push(o),this.safeDispatchEvent("provider",{detail:o}),s++,s===t&&(this.log("session is ready"),i.resolve()),this.providers.length===this.maxProviders)){this.log("found max session peers",s);break}}if(this.log("found %d/%d new session peers",s,this.maxProviders),s<t)throw new Kb(`Found ${s} of ${t} ${this.name} providers for ${e}`)}).catch(o=>{this.log.error("error searching routing for potential session peers for %c",e,o.errors??o),i.reject(o)}),i.promise}}class wE{libp2p;blockstore;datastore;pins;logger;routing;getCodec;getHasher;dns;metrics;log;constructor(e){this.logger=e.logger??q0(),this.log=this.logger.forComponent("helia"),this.getHasher=uE(e.hashers,e.loadHasher),this.getCodec=lE(e.codecs,e.loadCodec),this.dns=e.dns??Cl(),this.metrics=e.metrics,this.libp2p=e.libp2p;const t={blockstore:e.blockstore,datastore:e.datastore,logger:this.logger,libp2p:this.libp2p,blockBrokers:[],getHasher:this.getHasher,getCodec:this.getCodec,dns:this.dns,metrics:this.metrics,...e.components??{}};this.routing=t.routing=new Qb(t,{routers:(e.routers??[]).flatMap(i=>{const s=[i];return i[Ns]!=null&&s.push(i[Ns]),i[Ds]!=null&&s.push(i[Ds]),s}),providerLookupConcurrency:e.providerLookupConcurrency});const r=new pE(t);this.pins=new qb(e.datastore,r,this.getCodec),this.blockstore=new aE(r,this.pins,{holdGcLock:e.holdGcLock??!0}),this.datastore=e.datastore,t.blockBrokers=e.blockBrokers.map(i=>i(t))}async start(){await cE(this.datastore),await Sn(this.blockstore,this.datastore,this.routing,this.libp2p)}async stop(){await hi(this.blockstore,this.datastore,this.routing,this.libp2p)}async gc(e={}){const t=await this.blockstore.lock.writeLock();try{const r=this,i=this.blockstore.unwrap();this.log("gc start"),await xn(i.deleteMany((async function*(){for await(const{cid:s}of i.getAll())try{if(await r.pins.isPinned(s,e))continue;yield s,e.onProgress?.(new P("helia:gc:deleted",s))}catch(o){r.log.error("Error during gc",o),e.onProgress?.(new P("helia:gc:error",o))}})()))}finally{t()}this.log("gc finished")}}class vE extends m6{wantList;network;libp2p;constructor(e,t){super(e,{...t,name:"helia:bitswap:session"}),this.wantList=e.wantList,this.network=e.network,this.libp2p=e.libp2p}async queryProvider(e,t,r){this.log("sending WANT-BLOCK for %c to %p",e,t);const i=await this.wantList.wantSessionBlock(e,t,r);if(this.log("%p %s %c",t,i.has?"has":"does not have",e),i.has&&i.block!=null)return i.block;throw new Error("Provider did not have block")}async*findNewProviders(e,t={}){for await(const r of this.network.findProviders(e,t))yield r.id}toEvictionKey(e){return e.toMultihash().bytes}equals(e,t){return e.equals(t)}async convertToProvider(e,t){return Oi(e)?e:(await this.libp2p.dial(e,t)).remotePeer}}function bE(n,e){return new vE(n,e)}class EE{blocksReceived;duplicateBlocksReceived;dataReceived;duplicateDataReceived;constructor(e){this.blocksReceived=e.metrics?.registerMetricGroup("helia_bitswap_received_blocks"),this.duplicateBlocksReceived=e.metrics?.registerMetricGroup("helia_bitswap_duplicate_received_blocks"),this.dataReceived=e.metrics?.registerMetricGroup("helia_bitswap_data_received_bytes"),this.duplicateDataReceived=e.metrics?.registerMetricGroup("helia_bitswap_duplicate_data_received_bytes")}updateBlocksReceived(e=1,t){const r={global:e};t!=null&&(r[t.toString()]=e),this.blocksReceived?.increment(r)}updateDuplicateBlocksReceived(e=1,t){const r={global:e};t!=null&&(r[t.toString()]=e),this.duplicateBlocksReceived?.increment(r)}updateDataReceived(e,t){const r={global:e};t!=null&&(r[t.toString()]=e),this.dataReceived?.increment(r)}updateDuplicateDataReceived(e,t){const r={global:e};t!=null&&(r[t.toString()]=e),this.duplicateDataReceived?.increment(r)}}class SE extends Map{metric;constructor(e){super();const{name:t,metrics:r}=e;this.metric=r.registerMetric(t),this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){const t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}}function Hr(n){const{name:e,metrics:t}=n;let r;return t!=null?r=new SE({name:e,metrics:t}):r=new Map,r}function xE(n){if(!(n instanceof Uint8Array))throw new Error("arg needs to be a Uint8Array");const e=[];for(;n.length>0;){const t=Ku(n);e.push(t),n=n.slice(Ft(t))}return e}class AE extends tt{peers;wants;network;log;sendMessagesDelay;sendMessagesTimeout;hashLoader;sendingMessages;constructor(e,t={}){super(),this.peers=Zu({name:"helia_bitswap_peers",metrics:e.metrics}),this.wants=Hr({name:"helia_bitswap_wantlist",metrics:e.metrics}),this.network=e.network,this.sendMessagesDelay=t.sendMessagesDelay??Qv,this.log=e.logger.forComponent("helia:bitswap:wantlist"),this.hashLoader=t.hashLoader,this.network.addEventListener("bitswap:message",r=>{this.receiveMessage(r.detail.peer,r.detail.message).catch(i=>{this.log.error("error receiving bitswap message from %p",r.detail.peer,i)})}),this.network.addEventListener("peer:connected",r=>{this.peerConnected(r.detail).catch(i=>{this.log.error("error processing newly connected bitswap peer %p",r.detail,i)})}),this.network.addEventListener("peer:disconnected",r=>{this.peerDisconnected(r.detail)})}async addEntry(e,t){const r=ee(e.multihash.bytes,"base64");let i=this.wants.get(r);i==null&&(i={cid:e,priority:t.priority??1,wantType:t.wantType??ut.WantBlock,cancel:!1,sendDontHave:!0},this.wants.set(r,i)),i.wantType===ut.WantHave&&t.wantType===ut.WantBlock&&(i.wantType=ut.WantBlock),await this.sendMessagesDebounced();try{return t.wantType===ut.WantBlock?(await Ut(this,"block",t?.signal,{filter:a=>Ue(e.multihash.digest,a.detail.cid.multihash.digest),errorMessage:"Want was aborted"})).detail:(await Ut(this,"presence",t?.signal,{filter:o=>Ue(e.multihash.digest,o.detail.cid.multihash.digest),errorMessage:"Want was aborted"})).detail}finally{t.signal?.aborted===!0&&(this.log("want for %c was aborted, cancelling want",e),i.cancel=!0,await this.sendMessagesDebounced())}}async sendMessagesDebounced(){await this.sendingMessages?.promise,clearTimeout(this.sendMessagesTimeout),this.sendMessagesTimeout=setTimeout(()=>{this.sendMessages().catch(e=>{this.log("error sending messages to peers",e)})},this.sendMessagesDelay)}async sendMessages(){this.sendingMessages=we(),await Promise.all([...this.peers.entries()].map(async([e,t])=>{const r=new Set,i=new Lo;for(const[s,o]of this.wants.entries())t.has(s)||o.cancel||(r.add(s),i.addWantlistEntry(o.cid,{cid:o.cid.bytes,priority:o.priority,wantType:o.wantType,cancel:o.cancel,sendDontHave:o.sendDontHave}));if(i.wantlist.size!==0)try{await this.network.sendMessage(e,i);for(const s of r)t.add(s)}catch(s){this.log.error("error sending full wantlist to new peer",s)}})).catch(e=>{this.log.error("error sending messages",e)});for(const[e,t]of this.wants)if(t.cancel){this.wants.delete(e);for(const r of this.peers.values())r.delete(e)}this.sendingMessages.resolve()}has(e){const t=ee(e.multihash.bytes,"base64");return this.wants.has(t)}async wantSessionPresence(e,t,r={}){const i=new Lo;return i.addWantlistEntry(e,{cid:e.bytes,sendDontHave:!0,wantType:ut.WantHave,priority:1}),await this.network.sendMessage(t,i),(await Ut(this,"presence",r.signal,{filter:o=>t.equals(o.detail.sender)&&Ue(e.multihash.digest,o.detail.cid.multihash.digest)})).detail}async wantBlock(e,t={}){return this.addEntry(e,{...t,wantType:ut.WantBlock})}async wantSessionBlock(e,t,r={}){const i=new Lo;return i.addWantlistEntry(e,{cid:e.bytes,sendDontHave:!0,wantType:ut.WantBlock,priority:1}),await this.network.sendMessage(t,i),(await Ut(this,"presence",r.signal,{filter:o=>t.equals(o.detail.sender)&&Ue(e.multihash.digest,o.detail.cid.multihash.digest)})).detail}async receivedBlock(e,t){const r=ee(e.multihash.bytes,"base64"),i=this.wants.get(r);i!=null&&(i.cancel=!0,await this.sendMessagesDebounced())}async receiveMessage(e,t){this.log("received message from %p with %d blocks",e,t.blocks.length);let r=!1;for(const i of t.blocks){if(i.prefix==null||i.data==null)continue;const s=xE(i.prefix),o=s[0],a=s[1],c=s[2],l=c===gt.code?gt:await this.hashLoader?.getHasher(c);if(l==null){this.log.error("unknown hash algorithm",c);continue}let u=l.digest(i.data);u.then!=null&&(u=await u);const d=he.create(o===0?0:1,a,u);this.log("received block from %p for %c",e,d),this.safeDispatchEvent("block",{detail:{sender:e,cid:d,block:i.data}}),this.safeDispatchEvent("presence",{detail:{sender:e,cid:d,has:!0,block:i.data}});const h=ee(d.multihash.bytes,"base64"),f=this.wants.get(h);f!=null&&(f.cancel=!0,r=!0)}for(const{cid:i,type:s}of t.blockPresences){const o=he.decode(i);this.log("received %s from %p for %c",s,e,o),this.safeDispatchEvent("presence",{detail:{sender:e,cid:o,has:s===rn.HaveBlock}})}r&&await this.sendMessagesDebounced()}async peerConnected(e){const t=new Set,r=new Lo(!0);for(const[i,s]of this.wants.entries())s.cancel||(t.add(i),r.addWantlistEntry(s.cid,{cid:s.cid.bytes,priority:1,wantType:ut.WantBlock,cancel:!1,sendDontHave:!1}));if(r.wantlist.size===0){this.peers.set(e,t);return}try{await this.network.sendMessage(e,r),this.peers.set(e,t)}catch(i){this.log.error("error sending full wantlist to new peer %p",e,i)}}peerDisconnected(e){this.peers.delete(e)}start(){}stop(){this.peers.clear(),clearTimeout(this.sendMessagesTimeout)}}class kE{log;logger;stats;network;blockstore;peerWantLists;wantList;libp2p;constructor(e,t={}){this.logger=e.logger,this.log=e.logger.forComponent("helia:bitswap"),this.blockstore=e.blockstore,this.libp2p=e.libp2p,this.stats=new EE(e),this.network=new cb(e,t),this.peerWantLists=new _b({...e,network:this.network},t),this.wantList=new AE({...e,network:this.network},t)}createSession(e={}){return bE({wantList:this.wantList,network:this.network,logger:this.logger,libp2p:this.libp2p},e)}async want(e,t={}){const r=new AbortController,i=Re([r.signal,t.signal]);r.signal,this.network.findAndConnect(e,{...t,signal:i}).catch(s=>{r.signal.aborted||this.log.error("error during finding and connect for cid %c",e,s)});try{const s=await this.wantList.wantBlock(e,{...t,signal:i});return t.onProgress?.(new P("bitswap:want-block:received",{cid:e,sender:s.sender})),s.block}finally{r.abort(),i.clear()}}async notify(e,t,r={}){await Promise.all([this.peerWantLists.receivedBlock(e,r),this.wantList.receivedBlock(e,r)])}getWantlist(){return[...this.wantList.wants.values()].filter(e=>!e.cancel).map(e=>({cid:e.cid,priority:e.priority,wantType:e.wantType}))}getPeerWantlist(e){return this.peerWantLists.wantListForPeer(e)}async start(){this.wantList.start(),await this.network.start()}async stop(){this.wantList.stop(),await this.network.stop()}}const _E=(n,e={})=>new kE(n,e);class IE{bitswap;started;constructor(e,t={}){const{getHasher:r}=e;this.bitswap=_E(e,{hashLoader:{getHasher:async i=>r(i)},...t}),this.started=!1}isStarted(){return this.started}async start(){await this.bitswap.start(),this.started=!0}async stop(){await this.bitswap.stop(),this.started=!1}async announce(e,t,r){await this.bitswap.notify(e,t,r)}async retrieve(e,t={}){return this.bitswap.want(e,t)}createSession(e){const t=this.bitswap.createSession(e);return{announce:async(r,i,s)=>{await this.bitswap.notify(r,i,s)},retrieve:async(r,i)=>t.retrieve(r,i)}}}function y6(n={}){return e=>new IE(e,n)}var ls={},wg;function CE(){return wg||(wg=1,(function(){var n,e,t,r,i,s,o,a;a=function(c){var l,u,d,h;return l=(c&255<<24)>>>24,u=(c&255<<16)>>>16,d=(c&65280)>>>8,h=c&255,[l,u,d,h].join(".")},o=function(c){var l,u,d,h,f,m;for(l=[],d=h=0;h<=3&&c.length!==0;d=++h){if(d>0){if(c[0]!==".")throw new Error("Invalid IP");c=c.substring(1)}m=e(c),f=m[0],u=m[1],c=c.substring(u),l.push(f)}if(c.length!==0)throw new Error("Invalid IP");switch(l.length){case 1:if(l[0]>4294967295)throw new Error("Invalid IP");return l[0]>>>0;case 2:if(l[0]>255||l[1]>16777215)throw new Error("Invalid IP");return(l[0]<<24|l[1])>>>0;case 3:if(l[0]>255||l[1]>255||l[2]>65535)throw new Error("Invalid IP");return(l[0]<<24|l[1]<<16|l[2])>>>0;case 4:if(l[0]>255||l[1]>255||l[2]>255||l[3]>255)throw new Error("Invalid IP");return(l[0]<<24|l[1]<<16|l[2]<<8|l[3])>>>0;default:throw new Error("Invalid IP")}},t=function(c){return c.charCodeAt(0)},r=t("0"),s=t("a"),i=t("A"),e=function(c){var l,u,d,h,f;for(h=0,l=10,u="9",d=0,c.length>1&&c[d]==="0"&&(c[d+1]==="x"||c[d+1]==="X"?(d+=2,l=16):"0"<=c[d+1]&&c[d+1]<="9"&&(d++,l=8,u="7")),f=d;d<c.length;){if("0"<=c[d]&&c[d]<=u)h=h*l+(t(c[d])-r)>>>0;else if(l===16)if("a"<=c[d]&&c[d]<="f")h=h*l+(10+t(c[d])-s)>>>0;else if("A"<=c[d]&&c[d]<="F")h=h*l+(10+t(c[d])-i)>>>0;else break;else break;if(h>4294967295)throw new Error("too large");d++}if(d===f)throw new Error("empty octet");return[h,d]},n=(function(){function c(l,u){var d,h,f;if(typeof l!="string")throw new Error("Missing `net' parameter");if(u||(f=l.split("/",2),l=f[0],u=f[1]),u||(u=32),typeof u=="string"&&u.indexOf(".")>-1){try{this.maskLong=o(u)}catch{throw new Error("Invalid mask: "+u)}for(d=h=32;h>=0;d=--h)if(this.maskLong===4294967295<<32-d>>>0){this.bitmask=d;break}}else if(u||u===0)this.bitmask=parseInt(u,10),this.maskLong=0,this.bitmask>0&&(this.maskLong=4294967295<<32-this.bitmask>>>0);else throw new Error("Invalid mask: empty");try{this.netLong=(o(l)&this.maskLong)>>>0}catch{throw new Error("Invalid net address: "+l)}if(!(this.bitmask<=32))throw new Error("Invalid mask for ip4: "+u);this.size=Math.pow(2,32-this.bitmask),this.base=a(this.netLong),this.mask=a(this.maskLong),this.hostmask=a(~this.maskLong),this.first=this.bitmask<=30?a(this.netLong+1):this.base,this.last=this.bitmask<=30?a(this.netLong+this.size-2):a(this.netLong+this.size-1),this.broadcast=this.bitmask<=30?a(this.netLong+this.size-1):void 0}return c.prototype.contains=function(l){return typeof l=="string"&&(l.indexOf("/")>0||l.split(".").length!==4)&&(l=new c(l)),l instanceof c?this.contains(l.base)&&this.contains(l.broadcast||l.last):(o(l)&this.maskLong)>>>0===(this.netLong&this.maskLong)>>>0},c.prototype.next=function(l){return l==null&&(l=1),new c(a(this.netLong+this.size*l),this.mask)},c.prototype.forEach=function(l){var u,d,h;for(h=o(this.first),d=o(this.last),u=0;h<=d;)l(a(h),h,u),u++,h++},c.prototype.toString=function(){return this.base+"/"+this.bitmask},c})(),ls.ip2long=o,ls.long2ip=a,ls.Netmask=n}).call(ls)),ls}var TE=CE();const RE=["0.0.0.0/8","10.0.0.0/8","100.64.0.0/10","127.0.0.0/8","169.254.0.0/16","172.16.0.0/12","192.0.0.0/24","192.0.0.0/29","192.0.0.8/32","192.0.0.9/32","192.0.0.10/32","192.0.0.170/32","192.0.0.171/32","192.0.2.0/24","192.31.196.0/24","192.52.193.0/24","192.88.99.0/24","192.168.0.0/16","192.175.48.0/24","198.18.0.0/15","198.51.100.0/24","203.0.113.0/24","240.0.0.0/4","255.255.255.255/32"],PE=RE.map(n=>new TE.Netmask(n));function ap(n){for(const e of PE)if(e.contains(n))return!0;return!1}function OE(n){return/^::ffff:([0-9a-fA-F]{1,4}):([0-9a-fA-F]{1,4})$/.test(n)}function NE(n){const e=n.split(":");if(e.length<2)return!1;const t=e[e.length-1].padStart(4,"0"),r=e[e.length-2].padStart(4,"0"),i=`${parseInt(r.substring(0,2),16)}.${parseInt(r.substring(2),16)}.${parseInt(t.substring(0,2),16)}.${parseInt(t.substring(2),16)}`;return ap(i)}function DE(n){return/^::ffff:([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(n)}function LE(n){const e=n.split(":"),t=e[e.length-1];return ap(t)}function BE(n){return/^::$/.test(n)||/^::1$/.test(n)||/^64:ff9b::([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(n)||/^100::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(n)||/^2001::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(n)||/^2001:2[0-9a-fA-F]:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(n)||/^2001:db8:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(n)||/^2002:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(n)||/^f[c-d]([0-9a-fA-F]{2,2}):/i.test(n)||/^fe[8-9a-bA-B][0-9a-fA-F]:/i.test(n)||/^ff([0-9a-fA-F]{2,2}):/i.test(n)}function fi(n){if(vl(n))return ap(n);if(OE(n))return NE(n);if(DE(n))return LE(n);if(Aw(n))return BE(n)}const Fe=n=>({match:e=>{const t=e[0];return t==null||t.code!==n||t.value!=null?!1:e.slice(1)}}),ae=(n,e)=>({match:t=>{const r=t[0];return r?.code!==n||r.value==null||e!=null&&r.value!==e?!1:t.slice(1)}}),Ie=n=>({match:e=>{const t=n.match(e);return t===!1?e:t}}),Ht=(...n)=>({match:e=>{let t;for(const r of n){const i=r.match(e);i!==!1&&(t==null||i.length<t.length)&&(t=i)}return t??!1}}),Pe=(...n)=>({match:e=>{for(const t of n){const r=t.match(e);if(r===!1)return!1;e=r}return e}});function Me(...n){function e(i){if(i==null)return!1;let s=i.getComponents();for(const o of n){const a=o.match(s);if(a===!1)return!1;s=a}return s}function t(i){return e(i)!==!1}function r(i){const s=e(i);return s===!1?!1:s.length===0}return{matchers:n,matches:t,exactMatch:r}}const ME=ae(Be),FE=Me(ME),td=ae(g5),rd=ae(m5),nd=ae(p5),cp=ae(w5);Me(td,Ie(ae(Be)));Me(rd,Ie(ae(Be)));Me(nd,Ie(ae(Be)));const w6=Me(Ht(cp,nd,td,rd),Ie(ae(Be))),v6=Pe(ae(Gu),Ie(ae(v5))),b6=Pe(Ie(ae(oc)),ae(Bi),Ie(ae(v5))),lp=Ht(v6,b6),Fi=Ht(lp,cp,td,rd,nd),UE=Me(Ht(lp,Pe(Ht(cp,nd,td,rd),Ie(ae(Be))))),vg=Me(v6),bg=Me(b6),$E=Me(lp),up=Pe(Fi,ae(ra)),cc=Pe(Fi,ae(_w)),Rl=Me(Pe(up,Ie(ae(Be))));Me(cc);const dp=Pe(cc,Fe(Iw),Ie(ae(Be))),id=Pe(cc,Fe(Tw),Ie(ae(Be))),VE=Ht(dp,id);Me(dp);const qE=Me(id),T1=Ht(Fi,up,cc,dp,id),E6=Ht(Pe(T1,Fe(y5),Ie(ae(Be)))),Ua=Me(E6),S6=Ht(Pe(T1,Fe(Pw),Ie(ae(Be))),Pe(T1,Fe(cl),Ie(ae(Rw)),Fe(y5),Ie(ae(Be)))),Pl=Me(S6),x6=Pe(cc,Fe(kw),Ie(ae(bl)),Ie(ae(bl)),Ie(ae(Be))),R1=Me(x6),A6=Pe(id,Fe(Cw),Ie(ae(bl)),Ie(ae(bl)),Ie(ae(Be))),Eg=Me(A6),Ol=Ht(E6,S6,Pe(up,Ie(ae(Be))),Pe(VE,Ie(ae(Be))),Pe(Fi,Ie(ae(Be))),x6,A6,ae(Be)),k6=Me(Ol),HE=Pe(Ol,Fe(sc),ae(Be)),ci=Me(HE),zE=Ht(Pe(Ol,Fe(sc),Fe(ph),Ie(ae(Be))),Pe(Ol,Fe(ph),Ie(ae(Be))),Pe(Fe(ph),Ie(ae(Be)))),P1=Me(zE),KE=Ht(Pe(Fi,ae(ra),Fe(na),Ie(ae(Be))),Pe(Fi,Fe(na),Ie(ae(Be)))),WE=Me(KE),GE=Pe(Fi,Ht(Pe(ae(ra,"443"),Fe(na)),Pe(ae(ra),Fe(H2)),Pe(ae(ra),Fe(cl),Fe(na)),Pe(Fe(cl),Fe(na)),Fe(cl),Fe(H2)),Ie(ae(Be))),jE=Me(GE),QE=Ht(Pe(ae(Ow),Ie(ae(Be))));Me(QE);const YE=Ht(Pe(ae(Nw),Ie(ae(Be))));Me(YE);function _6(n,e,t){return n.filter(r=>{if(jE.matches(r)||e&&WE.matches(r))return t||w6.matches(r)?!0:fi(r.toOptions().host)===!1;if(!e&&t){const{host:i}=r.toOptions();if(i==="127.0.0.1"||i==="localhost"||i.endsWith(".localhost"))return!0}return!1})}async function*I6(n,e,t,r,i,s={}){for await(const o of e.findProviders(n,s)){const a=_6(o.multiaddrs,r,i);if(a.length===0)continue;const c=H0(a[0]);yield new C6(c,{logger:t,transformRequestInit:s.transformRequestInit})}}async function XE(n,e,t){const{signal:r,log:i}=t??{},s=n.headers.get("content-length");if(s!=null){const c=parseInt(s,10);if(c>e)throw i?.error("content-length header (%d) is greater than the limit (%d)",c,e),n.body!=null&&await n.body.cancel().catch(l=>{i?.error("error cancelling response body after content-length check - %e",l)}),new Error(`Content-Length header (${c}) is greater than the limit (${e}).`)}const o=n.body?.getReader();if(o==null)throw new Error("Response body is not readable");const a=new $e;try{for(;;){if(r?.aborted===!0)throw new Error("Response body read was aborted.");const{done:c,value:l}=await o.read();if(c)break;if(a.append(l),a.byteLength>e)throw new Error(`Response body is greater than the limit (${e}), received ${a.byteLength} bytes.`)}}finally{o.cancel().catch(c=>{i?.error("error cancelling reader - %e",c)}).finally(()=>{o.releaseLock()})}return a.subarray()}class C6{url;#e=0;#t=0;#r=0;#o=0;#c=new Map;log;transformRequestInit;constructor(e,{logger:t,transformRequestInit:r}){this.url=e instanceof URL?e:new URL(e),this.transformRequestInit=r,this.log=t.forComponent(`helia:trustless-gateway-block-broker:${this.url.hostname}`)}#l(e){const t=e.multihash.bytes;return Fr.encode(t)}async getRawBlock(e,{signal:t,maxSize:r=tS}={}){const i=new URL(this.url.toString());if(i.pathname=`/ipfs/${e.toString()}`,i.search="?format=raw",t?.aborted===!0)throw new Error(`Signal to fetch raw block for CID ${e} from gateway ${this.url} was aborted prior to fetch`);const s=this.#l(e),o=new AbortController,a=()=>{o.abort()};t?.addEventListener("abort",a);try{let c=this.#c.get(s);if(c==null){this.#e++;const l={signal:o.signal,headers:{Accept:"application/vnd.ipld.raw"},cache:"force-cache"},u=this.transformRequestInit!=null?await this.transformRequestInit(l):l;c=fetch(i.toString(),u).then(async d=>{if(this.log("GET %s %d",i,d.status),!d.ok)throw this.#t++,new Error(`unable to fetch raw block for CID ${e} from gateway ${this.url}`);const h=await XE(d,r,{signal:o.signal,log:this.log});return this.#o++,h}),this.#c.set(s,c)}return await c}catch{throw t?.aborted===!0?new Error(`fetching raw block for CID ${e} from gateway ${this.url} was aborted`):(this.#t++,new Error(`unable to fetch raw block for CID ${e}`))}finally{t?.removeEventListener("abort",a),this.#c.delete(s)}}reliability(){return this.#e===0?1:this.#r>0?-1/0:this.#o/(this.#e+this.#t*3)}incrementInvalidBlocks(){this.#r++}getStats(){return{attempts:this.#e,errors:this.#t,invalidBlocks:this.#r,successes:this.#o,pendingResponses:this.#c.size}}}class ZE extends m6{routing;allowInsecure;allowLocal;transformRequestInit;constructor(e,t){super(e,{...t,name:"helia:trustless-gateway:session"}),this.routing=e.routing,this.allowInsecure=t.allowInsecure??T6,this.allowLocal=t.allowLocal??R6,this.transformRequestInit=t.transformRequestInit}async queryProvider(e,t,r){this.log("fetching BLOCK for %c from %s",e,t.url);const i=await t.getRawBlock(e,r);return this.log.trace("got block for %c from %s",e,t.url),await r.validateFn?.(i),i}async*findNewProviders(e,t={}){yield*I6(e,this.routing,this.logger,this.allowInsecure,this.allowLocal,{...t,transformRequestInit:this.transformRequestInit})}toEvictionKey(e){return e.url.toString()}equals(e,t){return e.url.toString()===t.url.toString()}async convertToProvider(e,t){if(Oi(e))return;const r=_6(Array.isArray(e)?e:[e],this.allowInsecure,this.allowLocal);if(r.length===0)return;const i=H0(r[0]);return new C6(i,{logger:this.logger,transformRequestInit:this.transformRequestInit})}}function JE(n,e){return new ZE(n,e)}class eS{allowInsecure;allowLocal;transformRequestInit;routing;log;logger;constructor(e,t={}){this.log=e.logger.forComponent("helia:trustless-gateway-block-broker"),this.logger=e.logger,this.routing=e.routing,this.allowInsecure=t.allowInsecure??T6,this.allowLocal=t.allowLocal??R6,this.transformRequestInit=t.transformRequestInit}async retrieve(e,t={}){const r=[];for await(const i of I6(e,this.routing,this.logger,this.allowInsecure,this.allowLocal,{...t,transformRequestInit:this.transformRequestInit})){this.log("getting block for %c from %s",e,i.url);try{const s=await i.getRawBlock(e,t);this.log.trace("got block for %c from %s",e,i.url);try{await t.validateFn?.(s)}catch(o){this.log.error("failed to validate block for %c from %s",e,i.url,o);continue}return s}catch(s){if(this.log.error("failed to get block for %c from %s",e,i.url,s),s instanceof Error?r.push(s):r.push(new Error(`Unable to fetch raw block for CID ${e} from gateway ${i.url}`)),t.signal?.aborted===!0){this.log.trace("request aborted while fetching raw block for CID %c from gateway %s",e,i.url);break}}}throw r.length>0?new AggregateError(r,`Unable to fetch raw block for CID ${e} from any gateway`):new Error(`Unable to fetch raw block for CID ${e} from any gateway`)}createSession(e={}){return JE({logger:this.logger,routing:this.routing},{...e,allowLocal:this.allowLocal,allowInsecure:this.allowInsecure,transformRequestInit:this.transformRequestInit})}}const T6=!1,R6=!1,tS=2097152;function P6(n={}){return e=>new eS(e,n)}var kh={exports:{}},Sg;function rS(){return Sg||(Sg=1,(function(n){(function(){n.exports=w;var e=86400,t=3200,r=146097*t/400,i=e*r,s=1e3*i,o=864e13,a=4294967296,c=1e6,l="000000000",u=Math.trunc||function(_){var M=_-_%1;return M==0&&(_<0||_===0&&1/_!=1/0)?-0:M},d=w.prototype,h=(w.fromDate=function(_){return new w(+_)},w.fromInt64BE=ie(0,1,2,3,0,4),w.fromInt64LE=ie(3,2,1,0,4,0),w.fromString=function(F){var M,O=new w,F=(F+="").replace(/^\s*[+\-]?\d+/,function(X){var X=+X,te=1970+(X-1970)%400;return O.year=X-te,te}).replace(/(?:Z|([+\-]\d{2}):?(\d{2}))$/,function(U,X,te){return X<0&&(te*=-1),M=6e4*(60*+X+ +te),""}).replace(/\.\d+$/,function(U){return O.nano=+(U+l).substr(1,9),""}).split(/\D+/);if(1<F.length?F[1]--:F[1]=0,O.time=M=Date.UTC.apply(Date,F)-(M||0),isNaN(M))throw new TypeError("Invalid Date");return E(O)},w.fromTimeT=function(_){return T(_,0)},d.year=0,d.time=0,d.nano=0,d.addNano=function(_){return this.nano+=+_||0,this},d.getNano=function(){var _=E(this);return(_.time%1e3*c+ +_.nano+1e9)%1e9},d.getTimeT=function(){var M=E(this),_=Math.floor(M.time/1e3),M=M.year;return M&&(_+=M*r*e/t),_},d.getYear=function(){return this.toDate().getUTCFullYear()+this.year},d.toDate=function(){return A(E(this).time)},d.toJSON=function(){return this.toString().replace(/0{1,6}Z$/,"Z")},d.toString=function(_){var M=this,O=M.toDate(),F={H:function(){return j(O.getUTCHours())},L:function(){return se(O.getUTCMilliseconds(),3)},M:function(){return j(O.getUTCMinutes())},N:function(){return se(M.getNano(),9)},S:function(){return j(O.getUTCSeconds())},Y:function(){var U=M.getYear();return 999999<U?"+"+U:9999<U?"+"+se(U,6):0<=U?se(U,4):-999999<=U?"-"+se(-U,6):U},a:function(){return m[O.getUTCDay()]},b:function(){return f[O.getUTCMonth()]},d:function(){return j(O.getUTCDate())},e:function(){return(function(U){return(9<U?"":" ")+(0|U)})(O.getUTCDate())},m:function(){return j(O.getUTCMonth()+1)}};return(function U(X){return X.replace(/%./g,function(te){var Z=te[1],G=y[Z],Z=F[Z];return G?U(G):Z?Z():te})})(_||h)},d.writeInt64BE=R(0,1,2,3,0,4),d.writeInt64LE=R(3,2,1,0,4,0),"%Y-%m-%dT%H:%M:%S.%NZ"),f=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],m=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],y={"%":"%",F:"%Y-%m-%d",n:`
`,R:"%H:%M",T:"%H:%M:%S",t:"	",X:"%T",Z:"GMT",z:"+0000"};return w;function w(_,M,O){var F=this;if(!(F instanceof w))return new w(_,M,O);F.time=+_||0,F.nano=+M||0,F.year=+O||0,E(F)}function E(_){var M,O,F,U=_.year,X=_.time,te=_.nano,G=((te<0||c<=te)&&(te-=(O=Math.floor(te/c))*c,X+=O,O=1),U%t);return(X<-o||o<X||G)&&((M=u(X/s))&&(U+=M*t,X-=M*s),(F=A(X)).setUTCFullYear(G+F.getUTCFullYear()),F=(X=+F)+(M=u((U-=G)/t))*s,M&&-o<=F&&F<=o&&(U-=M*t,X=F),O=1),O&&(_.year=U,_.time=X,_.nano=te),_}function A(_){var M=new Date(0);return M.setTime(_),M}function T(U,F){U=+U||0;var O=u((F=(F|0)*a)/i)+u(U/i),F=F%i+U%i,U=u(F/i);return U&&(O+=U,F-=U*i),new w(1e3*F,0,O*t)}function R(_,M,O,F,U,X){return function(G,Z){var N=E(this);G=G||new Array(8),re(G,Z|=0);var fe=Math.floor(N.time/1e3),N=N.year*(r*e/t),ce=u(N/a)+u(fe/a),N=N%a+fe%a,fe=Math.floor(N/a);return fe&&(ce+=fe,N-=fe*a),te(G,Z+U,ce),te(G,Z+X,N),G};function te(G,Z,ce){G[Z+_]=ce>>24&255,G[Z+M]=ce>>16&255,G[Z+O]=ce>>8&255,G[Z+F]=255&ce}}function ie(_,M,O,F,U,X){return function(G,Z){re(G,Z|=0);var ce=te(G,Z+U);return T(te(G,Z+X),ce)};function te(G,Z){return 16777216*G[Z+_]+(G[Z+M]<<16|G[Z+O]<<8|G[Z+F])}}function re(_,M){if(_=_&&_.length,_==null)throw new TypeError("Invalid Buffer");if(_<M+8)throw new RangeError("Out of range")}function j(_){return(9<_?"":"0")+(0|_)}function se(_,M){return(l+(0|_)).substr(-M)}})()})(kh)),kh.exports}var nS=rS();const Nl=ao(nS);class iS extends Error{static name="SignatureCreationError";constructor(e="Record signature creation failed"){super(e),this.name="SignatureCreationError"}}class _i extends Error{static name="SignatureVerificationError";constructor(e="Record signature verification failed"){super(e),this.name="SignatureVerificationError"}}class sS extends Error{static name="RecordExpiredError";constructor(e="Record has expired"){super(e),this.name="RecordExpiredError"}}class hp extends Error{static name="UnsupportedValidityError";constructor(e="The validity type is unsupported"){super(e),this.name="UnsupportedValidityError"}}class oS extends Error{static name="RecordTooLargeError";constructor(e="The record is too large"){super(e),this.name="RecordTooLargeError"}}let O6=class extends Error{static name="InvalidValueError";constructor(e="Value must be a valid content path starting with /"){super(e),this.name="InvalidValueError"}};class aS extends Error{static name="InvalidRecordDataError";constructor(e="Invalid record data"){super(e),this.name="InvalidRecordDataError"}}class xg extends Error{static name="InvalidEmbeddedPublicKeyError";constructor(e="Invalid embedded public key"){super(e),this.name="InvalidEmbeddedPublicKeyError"}}var mr;(function(n){(function(r){r.EOL="EOL"})(n.ValidityType||(n.ValidityType={}));let e;(function(r){r[r.EOL=0]="EOL"})(e||(e={})),(function(r){r.codec=()=>Jt(e)})(n.ValidityType||(n.ValidityType={}));let t;n.codec=()=>(t==null&&(t=pe((r,i,s={})=>{s.lengthDelimited!==!1&&i.fork(),r.value!=null&&(i.uint32(10),i.bytes(r.value)),r.signatureV1!=null&&(i.uint32(18),i.bytes(r.signatureV1)),r.validityType!=null&&(i.uint32(24),n.ValidityType.codec().encode(r.validityType,i)),r.validity!=null&&(i.uint32(34),i.bytes(r.validity)),r.sequence!=null&&(i.uint32(40),i.uint64(r.sequence)),r.ttl!=null&&(i.uint32(48),i.uint64(r.ttl)),r.pubKey!=null&&(i.uint32(58),i.bytes(r.pubKey)),r.signatureV2!=null&&(i.uint32(66),i.bytes(r.signatureV2)),r.data!=null&&(i.uint32(74),i.bytes(r.data)),s.lengthDelimited!==!1&&i.ldelim()},(r,i,s={})=>{const o={},a=i==null?r.len:r.pos+i;for(;r.pos<a;){const c=r.uint32();switch(c>>>3){case 1:{o.value=r.bytes();break}case 2:{o.signatureV1=r.bytes();break}case 3:{o.validityType=n.ValidityType.codec().decode(r);break}case 4:{o.validity=r.bytes();break}case 5:{o.sequence=r.uint64();break}case 6:{o.ttl=r.uint64();break}case 7:{o.pubKey=r.bytes();break}case 8:{o.signatureV2=r.bytes();break}case 9:{o.data=r.bytes();break}default:{r.skipType(c&7);break}}}return o})),t),n.encode=r=>ge(r,n.codec()),n.decode=(r,i)=>me(r,n.codec(),i)})(mr||(mr={}));const cS=mt("ipns:utils"),N6=C("/ipns/"),lS=114,uS=0,dS=18;function D6(n){let e;if(n.pubKey!=null)try{e=Vr(n.pubKey)}catch(t){throw cS.error(t),t}if(e!=null)return e}function hS(n,e,t){const r=C(e);return tr([n,t,r])}function L6(n){const e=C("ipns-signature:");return tr([e,n])}function Dl(n){return"signatureV1"in n?mr.encode({value:C(n.value),signatureV1:n.signatureV1,validityType:n.validityType,validity:C(n.validity),sequence:n.sequence,ttl:n.ttl,pubKey:n.pubKey,signatureV2:n.signatureV2,data:n.data}):mr.encode({pubKey:n.pubKey,signatureV2:n.signatureV2,data:n.data})}function Jn(n){const e=mr.decode(n);if(e.sequence!=null&&(e.sequence=BigInt(e.sequence)),e.ttl!=null&&(e.ttl=BigInt(e.ttl)),e.signatureV2==null||e.data==null)throw new _i("Missing data or signatureV2");const t=B6(e.data),r=pS(t.Value),i=ee(t.Validity);if(e.value!=null&&e.signatureV1!=null)return mS(e),{value:r,validityType:mr.ValidityType.EOL,validity:i,sequence:t.Sequence,ttl:t.TTL,pubKey:e.pubKey,signatureV1:e.signatureV1,signatureV2:e.signatureV2,data:e.data};if(e.signatureV2!=null)return{value:r,validityType:mr.ValidityType.EOL,validity:i,sequence:t.Sequence,ttl:t.TTL,pubKey:e.pubKey,signatureV2:e.signatureV2,data:e.data};throw new Error("invalid record: does not include signatureV1 or signatureV2")}function aa(n){return tr([N6,n.bytes])}function O1(n){const e=zt(n.slice(N6.length));if(!N1(e,uS)&&!N1(e,dS))throw new f5("Multihash in IPNS key was not identity or sha2-256");return e}function fS(n,e,t,r,i){let s;if(e===mr.ValidityType.EOL)s=0;else throw new hp("The validity type is unsupported");return al({Value:n,Validity:t,ValidityType:s,Sequence:r,TTL:i})}function B6(n){const e=Si(n);if(e.ValidityType===0)e.ValidityType=mr.ValidityType.EOL;else throw new hp("The validity type is unsupported");return Number.isInteger(e.Sequence)&&(e.Sequence=BigInt(e.Sequence)),Number.isInteger(e.TTL)&&(e.TTL=BigInt(e.TTL)),e}function pS(n){const e=ee(n).trim();if(e.startsWith("/"))return e;try{return`/ipfs/${he.decode(n).toV1().toString()}`}catch{}try{return`/ipfs/${he.parse(e).toV1().toString()}`}catch{}throw new O6("Value must be a valid content path starting with /")}function gS(n){if(n!=null){const e=vS(n);if(e!=null)return e.code===lS?`/ipns/${e.toString(Li)}`:`/ipfs/${e.toV1().toString()}`;if(yS(n))return`/ipns/${Li.encode(n.bytes)}`;const t=n.toString().trim();if(t.startsWith("/")&&t.length>1)return t}throw new O6("Value must be a valid content path starting with /")}function mS(n){if(n.data==null)throw new aS("Record data is missing");const e=B6(n.data);if(!Ue(e.Value,n.value??new Uint8Array(0)))throw new _i('Field "value" did not match between protobuf and CBOR');if(!Ue(e.Validity,n.validity??new Uint8Array(0)))throw new _i('Field "validity" did not match between protobuf and CBOR');if(e.ValidityType!==n.validityType)throw new _i('Field "validityType" did not match between protobuf and CBOR');if(e.Sequence!==n.sequence)throw new _i('Field "sequence" did not match between protobuf and CBOR');if(e.TTL!==n.ttl)throw new _i('Field "ttl" did not match between protobuf and CBOR')}function yS(n){return n.bytes instanceof Uint8Array}function wS(n){return typeof n?.toCID=="function"}function vS(n){if(wS(n))return n.toCID();try{return he.parse(n)}catch{}return he.asCID(n)}function N1(n,e){return n.code===e}const bS=mt("ipns"),M6=300*1e9,F6={v1Compatible:!0,ttlNs:M6};async function ES(n,e,t,r,i=F6){const s=new Nl(Date.now()+Number(r)),o=mr.ValidityType.EOL,a=BigInt(i.ttlNs??M6);return SS(n,e,t,o,s.toString(),a,i)}const SS=async(n,e,t,r,i,s,o=F6)=>{t=BigInt(t);const a=C(i),c=gS(e),l=C(c),u=fS(l,r,a,t,s),d=L6(u),h=await n.sign(d);let f;if(n.type==="RSA"&&(f=Xn(n.publicKey)),o.v1Compatible===!0){const m=await xS(n,l,r,a),y={value:c,signatureV1:m,validity:i,validityType:r,sequence:t,ttl:s,signatureV2:h,data:u};return f!=null&&(y.pubKey=f),y}else{const m={value:c,validity:i,validityType:r,sequence:t,ttl:s,signatureV2:h,data:u};return f!=null&&(m.pubKey=f),m}},xS=async(n,e,t,r)=>{try{const i=hS(e,t,r);return await n.sign(i)}catch(i){throw bS.error("record signature creation failed",i),new iS("Record signature creation failed")}},Uc=mt("ipns:validator"),AS=1024*10;async function kS(n,e){const t=Jn(e);let r;try{const i=L6(t.data);r=await n.verify(i,t.signatureV2)}catch{r=!1}if(!r)throw Uc.error("record signature verification failed"),new _i("Record signature verification failed");if(t.validityType===mr.ValidityType.EOL){if(Nl.fromString(t.validity).toDate().getTime()<Date.now())throw Uc.error("record has expired"),new sS("record has expired")}else if(t.validityType!=null)throw Uc.error("the validity type is unsupported"),new hp("The validity type is unsupported");Uc("ipns record for %s is valid",t.value)}async function ca(n,e){if(e.byteLength>AS)throw new oS("The record is too large");const t=O1(n);let r;N1(t,0)&&(r=Dw(t));const i=Jn(e),s=D6(i)??r;if(s==null)throw new xg("Could not extract public key from IPNS record or routing key");const o=aa(s.toMultihash());if(!Ue(o,n))throw new xg("Embedded public key did not match routing key");await kS(s,e)}let _S=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MESSAGE_LENGTH"};async function*Ag(n,e={}){const t=/\r?\n/,r=new TextDecoder("utf8");let i="";for await(let s of n){if(typeof s=="string"&&(s=new TextEncoder().encode(s)),ll(s)&&(s=s.subarray()),i+=r.decode(s,{stream:!0}),i.length>(e?.maxMessageLength??i.length))throw new _S("Incoming message too long");const o=i.split(t);i=o.pop()??"";for(let a=0;a<o.length;a++)yield JSON.parse(o[a])}i+=r.decode(),i!==""&&(yield JSON.parse(i))}class _h extends Error{static name="InvalidRequestError";constructor(e="Invalid request"){super(e),this.name="InvalidRequestError"}}class Vn extends Error{static name="BadResponseError";constructor(e="Bad response"){super(e),this.name="BadResponseError"}}const kg=C("/ipns/");function _g(n){return Ue(n.subarray(0,kg.byteLength),kg)}class IS{client;constructor(e){this.client=e}async*findProviders(e,t={}){yield*un(this.client.getProviders(e,t),r=>({id:r.ID,multiaddrs:r.Addrs??[]}))}async provide(){}async cancelReprovide(){}async put(e,t,r){if(!_g(e))return;const i=O1(e),s=he.createV1(114,i),o=Jn(t);await this.client.putIPNS(s,o,r)}async get(e,t){if(!_g(e))throw new Xe("Not found");const r=O1(e),i=he.createV1(114,r);try{const s=await this.client.getIPNS(i,t);return Dl(s)}catch(s){throw s.name==="BadResponseError"?new Xe("Not found"):s}}}class CS{client;constructor(e){this.client=e}async findPeer(e,t={}){const r=await z0(this.client.getPeers(e,t));if(r!=null)return{id:r.ID,multiaddrs:r.Addrs??[]};throw new Xe("Not found")}async*getClosestPeers(e,t={}){}}const yt=mt("delegated-routing-v1-http-api-client"),$c={concurrentRequests:4,timeout:3e4,cacheTTL:300*1e3,cacheName:"delegated-routing-v1-cache"};class TS{started;httpQueue;shutDownController;clientUrl;timeout;contentRouting;peerRouting;filterAddrs;filterProtocols;inFlightRequests;cacheName;cache;cacheTTL;constructor(e,t={}){this.started=!1,this.shutDownController=new AbortController,this.shutDownController.signal,this.httpQueue=new ed({concurrency:t.concurrentRequests??$c.concurrentRequests}),this.inFlightRequests=new Map,this.clientUrl=e instanceof URL?e:new URL(e),this.timeout=t.timeout??$c.timeout,this.filterAddrs=t.filterAddrs,this.filterProtocols=t.filterProtocols,this.contentRouting=new IS(this),this.peerRouting=new CS(this),this.cacheName=t.cacheName??$c.cacheName,this.cacheTTL=t.cacheTTL??$c.cacheTTL}get[Ns](){return this.contentRouting}get[Ds](){return this.peerRouting}isStarted(){return this.started}async start(){this.started||(this.started=!0,this.cacheTTL>0&&(this.cache=await globalThis.caches?.open(this.cacheName),this.cache!=null&&yt("cache enabled with ttl %d",this.cacheTTL)))}async stop(){this.httpQueue.clear(),this.shutDownController.abort(),await globalThis.caches?.delete(this.cacheName),this.started=!1}async*getProviders(e,t={}){yt("getProviders starts: %c",e);const r=AbortSignal.timeout(this.timeout),i=Re([this.shutDownController.signal,r,t.signal]),s=we(),o=we();this.httpQueue.add(async()=>(s.resolve(),o.promise));try{await s.promise;const a=new URL(`${this.clientUrl}routing/v1/providers/${e.toString()}`);this.#t(a,t.filterAddrs,t.filterProtocols);const c={headers:{Accept:"application/x-ndjson"},signal:i},l=await this.#r(a.toString(),c);if(l==null)throw new Vn("No response received");if(!l.ok)throw l.status===404?new Xe("No matching records found"):l.status===422?new _h("Request does not conform to schema or semantic constraints"):new Vn(`Unexpected status code: ${l.status}`);if(l.body==null)throw new Vn("Routing response had no body");const u=l.headers.get("Content-Type");if(u==null)throw new Vn("No Content-Type header received");if(u?.startsWith("application/json")){const d=await l.json();for(const h of d.Providers){const f=this.#e(h);f!=null&&(yield f)}}else if(u.includes("application/x-ndjson"))for await(const d of Ag(z2(l.body))){const h=this.#e(d);h!=null&&(yield h)}else throw new Vn(`Unsupported Content-Type: ${u}`)}finally{i.clear(),o.resolve(),yt("getProviders finished: %c",e)}}async*getPeers(e,t={}){yt("getPeers starts: %c",e);const r=AbortSignal.timeout(this.timeout),i=Re([this.shutDownController.signal,r,t.signal]),s=we(),o=we();this.httpQueue.add(async()=>(s.resolve(),o.promise));try{await s.promise;const a=new URL(`${this.clientUrl}routing/v1/peers/${e.toCID().toString()}`);this.#t(a,t.filterAddrs,t.filterProtocols);const c={headers:{Accept:"application/x-ndjson"},signal:i},l=await this.#r(a.toString(),c);if(l.status===404)throw new Xe("No matching records found");if(l.status===422)throw new _h("Request does not conform to schema or semantic constraints");if(l.body==null)throw new Vn("Routing response had no body");if(l.headers.get("Content-Type")==="application/json"){const d=await l.json();for(const h of d.Peers){const f=this.#e(h);f!=null&&(yield f)}}else for await(const d of Ag(z2(l.body))){const h=this.#e(d);h!=null&&(yield h)}}catch(a){yt.error("getPeers errored:",a)}finally{i.clear(),o.resolve(),yt("getPeers finished: %c",e)}}async getIPNS(e,t={}){yt("getIPNS starts: %s",e);const r=AbortSignal.timeout(this.timeout),i=Re([this.shutDownController.signal,r,t.signal]),s=we(),o=we();this.httpQueue.add(async()=>(s.resolve(),o.promise));const a=`${this.clientUrl}routing/v1/ipns/${e}`;try{await s.promise;const c={headers:{Accept:"application/vnd.ipfs.ipns-record"},signal:i},l=await this.#r(a,c);if(yt("getIPNS GET %s %d",a,l.status),l.status===404)throw new Xe("No matching records found");if(l.status===422)throw new _h("Request does not conform to schema or semantic constraints");if(l.body==null)throw new Vn("GET ipns response had no body");const u=await l.arrayBuffer(),d=new Uint8Array(u,0,u.byteLength);return t.validate!==!1&&await ca(aa(e.multihash),d),Jn(d)}catch(c){throw yt.error("getIPNS GET %s error:",a,c),c}finally{i.clear(),o.resolve(),yt("getIPNS finished: %s",e)}}async putIPNS(e,t,r={}){yt("putIPNS starts: %c",e);const i=AbortSignal.timeout(this.timeout),s=Re([this.shutDownController.signal,i,r.signal]),o=we(),a=we();this.httpQueue.add(async()=>(o.resolve(),a.promise));const c=`${this.clientUrl}routing/v1/ipns/${e}`;try{await o.promise;const l=Dl(t),u={method:"PUT",headers:{"Content-Type":"application/vnd.ipfs.ipns-record"},body:l,signal:s},d=await this.#r(c,u);if(yt("putIPNS PUT %s %d",c,d.status),d.status!==200)throw new Vn("PUT ipns response had status other than 200")}catch(l){throw yt.error("putIPNS PUT %s error:",c,l.stack),l}finally{s.clear(),a.resolve(),yt("putIPNS finished: %c",e)}}#e(e){try{const t=[],r=e.Addrs?.map(ue)??[];return e.Protocols!=null&&t.push(...e.Protocols),e.Protocol!=null&&(t.push(e.Protocol),delete e.Protocol),{...e,Schema:"peer",ID:Ot(e.ID),Addrs:r,Protocols:t}}catch(t){yt.error("could not conform record to peer schema",t)}}#t(e,t,r){if(t!=null||this.filterAddrs!=null){const i=t?.join(",")??this.filterAddrs?.join(",")??"";i!==""&&e.searchParams.set("filter-addrs",i)}if(r!=null||this.filterProtocols!=null){const i=r?.join(",")??this.filterProtocols?.join(",")??"";i!==""&&e.searchParams.set("filter-protocols",i)}}async#r(e,t){const r=t.method??"GET",i=`${r}-${e}`;if(r==="GET"){const c=await this.cache?.match(e);if(c!=null){if(parseInt(c.headers.get("x-cache-expires")??"0",10)>Date.now())return yt("returning cached response for %s",i),c;await this.cache?.delete(e)}}const s=this.inFlightRequests.get(i);if(s!=null){const c=await s;return yt("deduplicating outgoing request for %s",i),c.clone()}const o=fetch(e,t).then(async c=>{if(this.cache!=null&&c.ok&&r==="GET"){const l=Date.now()+this.cacheTTL,u=new Headers(c.headers);u.set("x-cache-expires",l.toString());const d=new Response(c.clone().body,{status:c.status,statusText:c.statusText,headers:u});await this.cache.put(e,d)}return c}).finally(()=>{this.inFlightRequests.delete(i)});return this.inFlightRequests.set(i,o),await o}}function U6(n,e={}){return new TS(new URL(n),e)}function RS(){return{filterProtocols:["unknown","transport-bitswap","transport-ipfs-gateway-http"],filterAddrs:["https","webtransport","webrtc","webrtc-direct","wss","tls"]}}const Ig="[a-fA-F\\d:]",Kn=n=>n&&n.includeBoundaries?`(?:(?<=\\s|^)(?=${Ig})|(?<=${Ig})(?=\\s|$))`:"",Or="(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)(?:\\.(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)){3}",nt="[a-fA-F\\d]{1,4}",sd=`
(?:
(?:${nt}:){7}(?:${nt}|:)|                                    // 1:2:3:4:5:6:7::  1:2:3:4:5:6:7:8
(?:${nt}:){6}(?:${Or}|:${nt}|:)|                             // 1:2:3:4:5:6::    1:2:3:4:5:6::8   1:2:3:4:5:6::8  1:2:3:4:5:6::1.2.3.4
(?:${nt}:){5}(?::${Or}|(?::${nt}){1,2}|:)|                   // 1:2:3:4:5::      1:2:3:4:5::7:8   1:2:3:4:5::8    1:2:3:4:5::7:1.2.3.4
(?:${nt}:){4}(?:(?::${nt}){0,1}:${Or}|(?::${nt}){1,3}|:)| // 1:2:3:4::        1:2:3:4::6:7:8   1:2:3:4::8      1:2:3:4::6:7:1.2.3.4
(?:${nt}:){3}(?:(?::${nt}){0,2}:${Or}|(?::${nt}){1,4}|:)| // 1:2:3::          1:2:3::5:6:7:8   1:2:3::8        1:2:3::5:6:7:1.2.3.4
(?:${nt}:){2}(?:(?::${nt}){0,3}:${Or}|(?::${nt}){1,5}|:)| // 1:2::            1:2::4:5:6:7:8   1:2::8          1:2::4:5:6:7:1.2.3.4
(?:${nt}:){1}(?:(?::${nt}){0,4}:${Or}|(?::${nt}){1,6}|:)| // 1::              1::3:4:5:6:7:8   1::8            1::3:4:5:6:7:1.2.3.4
(?::(?:(?::${nt}){0,5}:${Or}|(?::${nt}){1,7}|:))             // ::2:3:4:5:6:7:8  ::2:3:4:5:6:7:8  ::8             ::1.2.3.4
)(?:%[0-9a-zA-Z]{1,})?                                             // %eth0            %1
`.replace(/\s*\/\/.*$/gm,"").replace(/\n/g,"").trim(),PS=new RegExp(`(?:^${Or}$)|(?:^${sd}$)`),OS=new RegExp(`^${Or}$`),NS=new RegExp(`^${sd}$`),od=n=>n&&n.exact?PS:new RegExp(`(?:${Kn(n)}${Or}${Kn(n)})|(?:${Kn(n)}${sd}${Kn(n)})`,"g");od.v4=n=>n&&n.exact?OS:new RegExp(`${Kn(n)}${Or}${Kn(n)}`,"g");od.v6=n=>n&&n.exact?NS:new RegExp(`${Kn(n)}${sd}${Kn(n)}`,"g");function DS(n){const e=(...t)=>n(...t);return Object.defineProperty(e,"name",{value:`functionTimeout(${n.name||"<anonymous>"})`,configurable:!0}),e}const{toString:LS}=Object.prototype;function BS(n){return LS.call(n)==="[object RegExp]"}const Cg={global:"g",ignoreCase:"i",multiline:"m",dotAll:"s",sticky:"y",unicode:"u"};function MS(n,e={}){if(!BS(n))throw new TypeError("Expected a RegExp instance");const t=Object.keys(Cg).map(i=>(typeof e[i]=="boolean"?e[i]:n[i])?Cg[i]:"").join(""),r=new RegExp(e.source||n.source,t);return r.lastIndex=typeof e.lastIndex=="number"?e.lastIndex:n.lastIndex,r}function $6(n,e,{timeout:t}={}){try{return DS(()=>MS(n).test(e),{timeout:t})()}catch(r){throw r}}const FS=15,US=45,V6={timeout:400};function Tg(n){return n.length>US?!1:$6(od.v6({exact:!0}),n,V6)}function $S(n){return n.length>FS?!1:$6(od.v4({exact:!0}),n,V6)}const Rg={http:"80",https:"443",ws:"80",wss:"443"},VS=["http","https","ws","wss"];function qS(n,e){e=e??{};const t=e.defaultDnsType??"dns",{scheme:r,hostname:i,port:s,path:o}=HS(n),a=[zS(i,t),KS(s,r),WS(r)];o!=null&&a.push(GS(o));const c="/"+a.filter(l=>!!l).reduce((l,u)=>l.concat(u),[]).join("/");return ue(c)}function HS(n){const[e]=n.split(":");VS.includes(e)||(n="http"+n.substring(e.length));let{protocol:t,hostname:r,port:i,pathname:s,search:o}=new URL(n);if(i==null||i===""){const c=jS(e);c!=null&&(i=c),c==null&&t==="http:"&&(i="80")}let a;return s!=null&&s!==""&&s!=="/"&&(s.startsWith("/")&&(s=s.substring(1)),a=s),o!=null&&o!==""&&(a=a??"",a+=o),{scheme:e,hostname:r,port:i,path:a}}function zS(n,e){if(!(n==null||n==="")){if($S(n))return["ip4",n];if(Tg(n))return["ip6",n];if(n[0]==="["){const t=n.substring(1,n.length-1);if(Tg(t))return["ip6",t]}return[e,n]}}function KS(n,e){if(!(n==null||n===""))return e==="udp"?["udp",n]:["tcp",n]}function WS(n){if(n.match(/^tcp$|^udp$/)==null)return n==="https"?["/tls/http"]:n==="wss"?["/tls/ws"]:[n]}function GS(n){if(!(n==null||n===""))return["http-path",encodeURIComponent(n)]}function jS(n){if(!(n==null||n===""||Rg[n]==null))return Rg[n]}const QS=["https://trustless-gateway.link","https://4everland.io"],YS=2336;function XS(n){return n=n.toString(),{id:rs(he.createV1(YS,_a.digest(C(n)))),multiaddrs:[qS(n)]}}class ZS{gateways;shuffle;constructor(e={}){this.gateways=(e.gateways??QS).map(t=>XS(t)),this.shuffle=e.shuffle??!0}async*findProviders(e,t){yield*(this.shuffle?this.gateways.toSorted(()=>Math.random()>.5?1:-1):this.gateways).map(r=>({...r,protocols:["transport-ipfs-gateway-http"]}))}}function q6(n={}){return new ZS(n)}class JS{libp2p;constructor(e){this.libp2p=e}async provide(e,t){await this.libp2p.contentRouting.provide(e,t)}async cancelReprovide(e,t){await this.libp2p.contentRouting.cancelReprovide(e,t)}async*findProviders(e,t){yield*this.libp2p.contentRouting.findProviders(e,t)}async put(e,t,r){await this.libp2p.contentRouting.put(e,t,r)}async get(e,t){return this.libp2p.contentRouting.get(e,t)}async findPeer(e,t){return this.libp2p.peerRouting.findPeer(e,t)}async*getClosestPeers(e,t){yield*this.libp2p.peerRouting.getClosestPeers(e,t)}}function H6(n){return new JS(n)}class ex extends p6{data;constructor(){super(),this.data=new Map}put(e,t,r){return r?.signal?.throwIfAborted(),this.data.set(xi.encode(e.multihash.bytes),t),e}get(e,t){t?.signal?.throwIfAborted();const r=this.data.get(xi.encode(e.multihash.bytes));if(r==null)throw new op;return r}has(e,t){return t?.signal?.throwIfAborted(),this.data.has(xi.encode(e.multihash.bytes))}async delete(e,t){t?.signal?.throwIfAborted(),this.data.delete(xi.encode(e.multihash.bytes))}async*getAll(e){e?.signal?.throwIfAborted();for(const[t,r]of this.data.entries())yield{cid:he.createV1(er,zt(xi.decode(t))),block:r},e?.signal?.throwIfAborted()}}mt("blockstore:core:tiered");const tx="SHARDING";function rx(n){return n[Symbol.asyncIterator]!=null}function Pg(n,e){return rx(n)?(async function*(){yield*(await Ia(n)).sort(e)})():(function*(){yield*Ia(n).sort(e)})()}class nx{put(e,t,r){return Promise.reject(new Error(".put is not implemented"))}get(e,t){return Promise.reject(new Error(".get is not implemented"))}has(e,t){return Promise.reject(new Error(".has is not implemented"))}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*putMany(e,t={}){for await(const{key:r,value:i}of e)await this.put(r,i,t),yield r}async*getMany(e,t={}){for await(const r of e)yield{key:r,value:await this.get(r,t)}}async*deleteMany(e,t={}){for await(const r of e)await this.delete(r,t),yield r}batch(){let e=[],t=[];return{put(r,i){e.push({key:r,value:i})},delete(r){t.push(r)},commit:async r=>{await xn(this.putMany(e,r)),e=[],await xn(this.deleteMany(t,r)),t=[]}}}async*_all(e,t){throw new Error("._all is not implemented")}async*_allKeys(e,t){throw new Error("._allKeys is not implemented")}query(e,t){let r=this._all(e,t);if(e.prefix!=null){const i=e.prefix;r=zn(r,s=>s.key.toString().startsWith(i))}if(Array.isArray(e.filters)&&(r=e.filters.reduce((i,s)=>zn(i,s),r)),Array.isArray(e.orders)&&(r=e.orders.reduce((i,s)=>Pg(i,s),r)),e.offset!=null){let i=0;const s=e.offset;r=zn(r,()=>i++>=s)}return e.limit!=null&&(r=xl(r,e.limit)),r}queryKeys(e,t){let r=this._allKeys(e,t);if(e.prefix!=null){const i=e.prefix;r=zn(r,s=>s.toString().startsWith(i))}if(Array.isArray(e.filters)&&(r=e.filters.reduce((i,s)=>zn(i,s),r)),Array.isArray(e.orders)&&(r=e.orders.reduce((i,s)=>Pg(i,s),r)),e.offset!=null){const i=e.offset;let s=0;r=zn(r,()=>s++>=i)}return e.limit!=null&&(r=xl(r,e.limit)),r}}class z6 extends nx{data;constructor(){super(),this.data=new Map}put(e,t,r){return r?.signal?.throwIfAborted(),this.data.set(e.toString(),t),e}get(e,t){t?.signal?.throwIfAborted();const r=this.data.get(e.toString());if(r==null)throw new op;return r}has(e,t){return t?.signal?.throwIfAborted(),this.data.has(e.toString())}delete(e,t){t?.signal?.throwIfAborted(),this.data.delete(e.toString())}*_all(e,t){t?.signal?.throwIfAborted();for(const[r,i]of this.data.entries())yield{key:new Te(r),value:i},t?.signal?.throwIfAborted()}*_allKeys(e,t){t?.signal?.throwIfAborted();for(const r of this.data.keys())yield new Te(r),t?.signal?.throwIfAborted()}}new Te(tx);mt("datastore:core:tiered");function Ll(n){if(typeof n!="object"||n===null)return!1;const e=Object.getPrototypeOf(n);return(e===null||e===Object.prototype||Object.getPrototypeOf(e)===null)&&!(Symbol.toStringTag in n)&&!(Symbol.iterator in n)}const{hasOwnProperty:K6}=Object.prototype,{propertyIsEnumerable:ix}=Object,Bs=(n,e,t)=>{Object.defineProperty(n,e,{value:t,writable:!0,enumerable:!0,configurable:!0})},sx=void 0,Og={concatArrays:!1,ignoreUndefined:!1},ad=n=>{const e=[];for(const t in n)K6.call(n,t)&&e.push(t);if(Object.getOwnPropertySymbols){const t=Object.getOwnPropertySymbols(n);for(const r of t)ix.call(n,r)&&e.push(r)}return e};function co(n){return Array.isArray(n)?ox(n):Ll(n)?ax(n):n}function ox(n){const e=n.slice(0,0);return ad(n).forEach(t=>{Bs(e,t,co(n[t]))}),e}function ax(n){const e=Object.getPrototypeOf(n)===null?Object.create(null):{};return ad(n).forEach(t=>{Bs(e,t,co(n[t]))}),e}const W6=(n,e,t,r)=>(t.forEach(i=>{typeof e[i]>"u"&&r.ignoreUndefined||(i in n&&n[i]!==Object.getPrototypeOf(n)?Bs(n,i,D1(n[i],e[i],r)):Bs(n,i,co(e[i])))}),n),cx=(n,e,t)=>{let r=n.slice(0,0),i=0;return[n,e].forEach(s=>{const o=[];for(let a=0;a<s.length;a++)K6.call(s,a)&&(o.push(String(a)),s===n?Bs(r,i++,s[a]):Bs(r,i++,co(s[a])));r=W6(r,s,ad(s).filter(a=>!o.includes(a)),t)}),r};function D1(n,e,t){return t.concatArrays&&Array.isArray(n)&&Array.isArray(e)?cx(n,e,t):!Ll(e)||!Ll(n)?co(e):W6(n,e,ad(e),t)}function Wr(...n){const e=D1(co(Og),this!==sx&&this||{},Og);let t={_:{}};for(const r of n)if(r!==void 0){if(!Ll(r))throw new TypeError("`"+r+"` is not an Option Object");t=D1(t,{_:r},e)}return t._}class lx{dns;canResolve(e){return e.getComponents().some(({name:t})=>t==="dnsaddr")}async resolve(e,t){const r=e.getComponents().find(c=>c.name==="dnsaddr")?.value;if(r==null)return[e];const s=await this.getDNS(t).query(`_dnsaddr.${r}`,{signal:t?.signal,types:[cn.TXT]}),o=e.getComponents().find(c=>c.name==="p2p")?.value,a=[];for(const c of s.Answer){const l=c.data.replace(/["']/g,"").trim().split("=")[1];l!=null&&(o!=null&&!l.includes(o)||a.push(ue(l)))}return a}getDNS(e){return e.dns!=null?e.dns:(this.dns==null&&(this.dns=Cl()),this.dns)}}const fp=new lx;var ux={};const dx={addresses:{listen:[],announce:[],noAnnounce:[],announceFilter:n=>n},connectionManager:{resolvers:{dnsaddr:fp}},transportManager:{faultTolerance:Pa.FATAL_ALL}};async function hx(n){const e=Wr(dx,n);if(e.connectionProtector===null&&ux?.LIBP2P_FORCE_PNET!=null)throw new $("Private network is enforced, but no protector was provided");return e}var Bl;(function(n){let e;n.codec=()=>(e==null&&(e=pe((t,r,i={})=>{i.lengthDelimited!==!1&&r.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(r.uint32(10),r.bytes(t.publicKey)),t.payloadType!=null&&t.payloadType.byteLength>0&&(r.uint32(18),r.bytes(t.payloadType)),t.payload!=null&&t.payload.byteLength>0&&(r.uint32(26),r.bytes(t.payload)),t.signature!=null&&t.signature.byteLength>0&&(r.uint32(42),r.bytes(t.signature)),i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{const s={publicKey:Le(0),payloadType:Le(0),payload:Le(0),signature:Le(0)},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.publicKey=t.bytes();break}case 2:{s.payloadType=t.bytes();break}case 3:{s.payload=t.bytes();break}case 5:{s.signature=t.bytes();break}default:{t.skipType(a&7);break}}}return s})),e),n.encode=t=>ge(t,n.codec()),n.decode=(t,r)=>me(t,n.codec(),r)})(Bl||(Bl={}));class fx extends Error{constructor(e="Invalid signature"){super(e),this.name="InvalidSignatureError"}}class sn{static createFromProtobuf=e=>{const t=Bl.decode(e),r=Vr(t.publicKey);return new sn({publicKey:r,payloadType:t.payloadType,payload:t.payload,signature:t.signature})};static seal=async(e,t,r)=>{if(t==null)throw new Error("Missing private key");const i=e.domain,s=e.codec,o=e.marshal(),a=Ng(i,s,o),c=await t.sign(a.subarray(),r);return new sn({publicKey:t.publicKey,payloadType:s,payload:o,signature:c})};static openAndCertify=async(e,t,r)=>{const i=sn.createFromProtobuf(e);if(!await i.validate(t,r))throw new fx("Envelope signature is not valid for the given domain");return i};publicKey;payloadType;payload;signature;marshaled;constructor(e){const{publicKey:t,payloadType:r,payload:i,signature:s}=e;this.publicKey=t,this.payloadType=r,this.payload=i,this.signature=s}marshal(){return this.marshaled==null&&(this.marshaled=Bl.encode({publicKey:Xn(this.publicKey),payloadType:this.payloadType,payload:this.payload.subarray(),signature:this.signature})),this.marshaled}equals(e){return e==null?!1:Ue(this.marshal(),e.marshal())}async validate(e,t){const r=Ng(e,this.payloadType,this.payload);return this.publicKey.verify(r.subarray(),this.signature,t)}}const Ng=(n,e,t)=>{const r=C(n),i=Mr(r.byteLength),s=Mr(e.length),o=Mr(t.length);return new $e(i,r,s,e,o,t)};function px(n,e){const t=(r,i)=>r.toString().localeCompare(i.toString());return n.length!==e.length?!1:(e.sort(t),n.sort(t).every((r,i)=>e[i].equals(r)))}const gx="libp2p-peer-record",mx=Uint8Array.from([3,1]);var Ml;(function(n){(function(t){let r;t.codec=()=>(r==null&&(r=pe((i,s,o={})=>{o.lengthDelimited!==!1&&s.fork(),i.multiaddr!=null&&i.multiaddr.byteLength>0&&(s.uint32(10),s.bytes(i.multiaddr)),o.lengthDelimited!==!1&&s.ldelim()},(i,s,o={})=>{const a={multiaddr:Le(0)},c=s==null?i.len:i.pos+s;for(;i.pos<c;){const l=i.uint32();switch(l>>>3){case 1:{a.multiaddr=i.bytes();break}default:{i.skipType(l&7);break}}}return a})),r),t.encode=i=>ge(i,t.codec()),t.decode=(i,s)=>me(i,t.codec(),s)})(n.AddressInfo||(n.AddressInfo={}));let e;n.codec=()=>(e==null&&(e=pe((t,r,i={})=>{if(i.lengthDelimited!==!1&&r.fork(),t.peerId!=null&&t.peerId.byteLength>0&&(r.uint32(10),r.bytes(t.peerId)),t.seq!=null&&t.seq!==0n&&(r.uint32(16),r.uint64(t.seq)),t.addresses!=null)for(const s of t.addresses)r.uint32(26),n.AddressInfo.codec().encode(s,r);i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{const s={peerId:Le(0),seq:0n,addresses:[]},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.peerId=t.bytes();break}case 2:{s.seq=t.uint64();break}case 3:{if(i.limits?.addresses!=null&&s.addresses.length===i.limits.addresses)throw new xt('Decode error - map field "addresses" had too many elements');s.addresses.push(n.AddressInfo.codec().decode(t,t.uint32(),{limits:i.limits?.addresses$}));break}default:{t.skipType(a&7);break}}}return s})),e),n.encode=t=>ge(t,n.codec()),n.decode=(t,r)=>me(t,n.codec(),r)})(Ml||(Ml={}));class fr{static createFromProtobuf=e=>{const t=Ml.decode(e),r=Pn(zt(t.peerId)),i=(t.addresses??[]).map(o=>ue(o.multiaddr)),s=t.seq;return new fr({peerId:r,multiaddrs:i,seqNumber:s})};static DOMAIN=gx;static CODEC=mx;peerId;multiaddrs;seqNumber;domain=fr.DOMAIN;codec=fr.CODEC;marshaled;constructor(e){const{peerId:t,multiaddrs:r,seqNumber:i}=e;this.peerId=t,this.multiaddrs=r??[],this.seqNumber=i??BigInt(Date.now())}marshal(){return this.marshaled==null&&(this.marshaled=Ml.encode({peerId:this.peerId.toMultihash().bytes,seq:BigInt(this.seqNumber),addresses:this.multiaddrs.map(e=>({multiaddr:e.bytes}))})),this.marshaled}equals(e){return!(!(e instanceof fr)||!this.peerId.equals(e.peerId)||this.seqNumber!==e.seqNumber||!px(this.multiaddrs,e.multiaddrs))}}const yx=36e5,wx=216e5;var Ri;(function(n){(function(t){let r;t.codec=()=>(r==null&&(r=pe((i,s,o={})=>{o.lengthDelimited!==!1&&s.fork(),i.key!=null&&i.key!==""&&(s.uint32(10),s.string(i.key)),i.value!=null&&i.value.byteLength>0&&(s.uint32(18),s.bytes(i.value)),o.lengthDelimited!==!1&&s.ldelim()},(i,s,o={})=>{const a={key:"",value:Le(0)},c=s==null?i.len:i.pos+s;for(;i.pos<c;){const l=i.uint32();switch(l>>>3){case 1:{a.key=i.string();break}case 2:{a.value=i.bytes();break}default:{i.skipType(l&7);break}}}return a})),r),t.encode=i=>ge(i,t.codec()),t.decode=(i,s)=>me(i,t.codec(),s)})(n.Peer$metadataEntry||(n.Peer$metadataEntry={})),(function(t){let r;t.codec=()=>(r==null&&(r=pe((i,s,o={})=>{o.lengthDelimited!==!1&&s.fork(),i.key!=null&&i.key!==""&&(s.uint32(10),s.string(i.key)),i.value!=null&&(s.uint32(18),Ul.codec().encode(i.value,s)),o.lengthDelimited!==!1&&s.ldelim()},(i,s,o={})=>{const a={key:""},c=s==null?i.len:i.pos+s;for(;i.pos<c;){const l=i.uint32();switch(l>>>3){case 1:{a.key=i.string();break}case 2:{a.value=Ul.codec().decode(i,i.uint32(),{limits:o.limits?.value});break}default:{i.skipType(l&7);break}}}return a})),r),t.encode=i=>ge(i,t.codec()),t.decode=(i,s)=>me(i,t.codec(),s)})(n.Peer$tagsEntry||(n.Peer$tagsEntry={}));let e;n.codec=()=>(e==null&&(e=pe((t,r,i={})=>{if(i.lengthDelimited!==!1&&r.fork(),t.addresses!=null)for(const s of t.addresses)r.uint32(10),Fl.codec().encode(s,r);if(t.protocols!=null)for(const s of t.protocols)r.uint32(18),r.string(s);if(t.publicKey!=null&&(r.uint32(34),r.bytes(t.publicKey)),t.peerRecordEnvelope!=null&&(r.uint32(42),r.bytes(t.peerRecordEnvelope)),t.metadata!=null&&t.metadata.size!==0)for(const[s,o]of t.metadata.entries())r.uint32(50),n.Peer$metadataEntry.codec().encode({key:s,value:o},r);if(t.tags!=null&&t.tags.size!==0)for(const[s,o]of t.tags.entries())r.uint32(58),n.Peer$tagsEntry.codec().encode({key:s,value:o},r);t.updated!=null&&(r.uint32(64),r.uint64Number(t.updated)),i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{const s={addresses:[],protocols:[],metadata:new Map,tags:new Map},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{if(i.limits?.addresses!=null&&s.addresses.length===i.limits.addresses)throw new xt('Decode error - map field "addresses" had too many elements');s.addresses.push(Fl.codec().decode(t,t.uint32(),{limits:i.limits?.addresses$}));break}case 2:{if(i.limits?.protocols!=null&&s.protocols.length===i.limits.protocols)throw new xt('Decode error - map field "protocols" had too many elements');s.protocols.push(t.string());break}case 4:{s.publicKey=t.bytes();break}case 5:{s.peerRecordEnvelope=t.bytes();break}case 6:{if(i.limits?.metadata!=null&&s.metadata.size===i.limits.metadata)throw new J2('Decode error - map field "metadata" had too many elements');const c=n.Peer$metadataEntry.codec().decode(t,t.uint32());s.metadata.set(c.key,c.value);break}case 7:{if(i.limits?.tags!=null&&s.tags.size===i.limits.tags)throw new J2('Decode error - map field "tags" had too many elements');const c=n.Peer$tagsEntry.codec().decode(t,t.uint32(),{limits:{value:i.limits?.tags$value}});s.tags.set(c.key,c.value);break}case 8:{s.updated=t.uint64Number();break}default:{t.skipType(a&7);break}}}return s})),e),n.encode=t=>ge(t,n.codec()),n.decode=(t,r)=>me(t,n.codec(),r)})(Ri||(Ri={}));var Fl;(function(n){let e;n.codec=()=>(e==null&&(e=pe((t,r,i={})=>{i.lengthDelimited!==!1&&r.fork(),t.multiaddr!=null&&t.multiaddr.byteLength>0&&(r.uint32(10),r.bytes(t.multiaddr)),t.isCertified!=null&&(r.uint32(16),r.bool(t.isCertified)),t.observed!=null&&(r.uint32(24),r.uint64Number(t.observed)),i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{const s={multiaddr:Le(0)},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.multiaddr=t.bytes();break}case 2:{s.isCertified=t.bool();break}case 3:{s.observed=t.uint64Number();break}default:{t.skipType(a&7);break}}}return s})),e),n.encode=t=>ge(t,n.codec()),n.decode=(t,r)=>me(t,n.codec(),r)})(Fl||(Fl={}));var Ul;(function(n){let e;n.codec=()=>(e==null&&(e=pe((t,r,i={})=>{i.lengthDelimited!==!1&&r.fork(),t.value!=null&&t.value!==0&&(r.uint32(8),r.uint32(t.value)),t.expiry!=null&&(r.uint32(16),r.uint64(t.expiry)),i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{const s={value:0},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.value=t.uint32();break}case 2:{s.expiry=t.uint64();break}default:{t.skipType(a&7);break}}}return s})),e),n.encode=t=>ge(t,n.codec()),n.decode=(t,r)=>me(t,n.codec(),r)})(Ul||(Ul={}));function vx(n,e){if(n.publicKey!=null||e.publicKey==null)return n;let t;n.type==="RSA"&&(t=n.toMultihash());const r=Vr(e.publicKey,t);return Ca(r)}function bx(n,e,t){const r=Ri.decode(e);return Bo(n,r,t)}function Bo(n,e,t){const r=new Map,i=BigInt(Date.now());for(const[s,o]of e.tags.entries())o.expiry!=null&&o.expiry<i||r.set(s,o);return{...e,id:vx(n,e),addresses:e.addresses.filter(({observed:s})=>s!=null&&s>Date.now()-t).map(({multiaddr:s,isCertified:o})=>({multiaddr:ue(s),isCertified:o??!1})),metadata:e.metadata,peerRecordEnvelope:e.peerRecordEnvelope??void 0,tags:r}}function Ex(n,e){return Sx(n.addresses,e.addresses)&&xx(n.protocols,e.protocols)&&Ax(n.publicKey,e.publicKey)&&kx(n.peerRecordEnvelope,e.peerRecordEnvelope)&&_x(n.metadata,e.metadata)&&Ix(n.tags,e.tags)}function Sx(n,e){return j6(n,e,(t,r)=>!(t.isCertified!==r.isCertified||!Ue(t.multiaddr,r.multiaddr)))}function xx(n,e){return j6(n,e,(t,r)=>t===r)}function Ax(n,e){return G6(n,e)}function kx(n,e){return G6(n,e)}function _x(n,e){return Q6(n,e,(t,r)=>Ue(t,r))}function Ix(n,e){return Q6(n,e,(t,r)=>t.value===r.value&&t.expiry===r.expiry)}function G6(n,e){return n==null&&e==null?!0:n!=null&&e!=null?Ue(n,e):!1}function j6(n,e,t){if(n.length!==e.length)return!1;for(let r=0;r<n.length;r++)if(!t(n[r],e[r]))return!1;return!0}function Q6(n,e,t){if(n.size!==e.size)return!1;for(const[r,i]of n.entries()){const s=e.get(r);if(s==null||!t(i,s))return!1}return!0}const Y6="/peers/";function Vc(n){if(!Oi(n)||n.type==null)throw new $("Invalid PeerId");const e=n.toCID().toString();return new Te(`${Y6}${e}`)}async function Cx(n,e,t,r,i){const s=new Map;for(const o of t){if(o==null)continue;if(o.multiaddr instanceof Uint8Array&&(o.multiaddr=ue(o.multiaddr)),!K0(o.multiaddr))throw new $("Multiaddr was invalid");if(!await e(n,o.multiaddr,i))continue;const a=o.isCertified??!1,c=o.multiaddr.toString(),l=s.get(c);l!=null?o.isCertified=l.isCertified||a:s.set(c,{multiaddr:o.multiaddr,isCertified:a})}return[...s.values()].sort((o,a)=>o.multiaddr.toString().localeCompare(a.multiaddr.toString())).map(({isCertified:o,multiaddr:a})=>{const c=a.getPeerId();return n.equals(c)&&(a=a.decapsulate(ue(`/p2p/${n}`))),{isCertified:o,multiaddr:a.bytes}})}async function Ih(n,e,t,r){if(e==null)throw new $("Invalid PeerData");if(e.publicKey!=null&&n.publicKey!=null&&!e.publicKey.equals(n.publicKey))throw new $("publicKey bytes do not match peer id publicKey bytes");const i=r.existingPeer?.peer;if(i!=null&&!n.equals(i.id))throw new $("peer id did not match existing peer id");let s=i?.addresses??[],o=new Set(i?.protocols??[]),a=i?.metadata??new Map,c=i?.tags??new Map,l=i?.peerRecordEnvelope;if(t==="patch"){if((e.multiaddrs!=null||e.addresses!=null)&&(s=[],e.multiaddrs!=null&&s.push(...e.multiaddrs.map(h=>({isCertified:!1,multiaddr:h}))),e.addresses!=null&&s.push(...e.addresses)),e.protocols!=null&&(o=new Set(e.protocols)),e.metadata!=null){const h=e.metadata instanceof Map?[...e.metadata.entries()]:Object.entries(e.metadata);a=qc(h,{validate:Dg})}if(e.tags!=null){const h=e.tags instanceof Map?[...e.tags.entries()]:Object.entries(e.tags);c=qc(h,{validate:Lg,map:Bg})}e.peerRecordEnvelope!=null&&(l=e.peerRecordEnvelope)}if(t==="merge"){if(e.multiaddrs!=null&&s.push(...e.multiaddrs.map(h=>({isCertified:!1,multiaddr:h}))),e.addresses!=null&&s.push(...e.addresses),e.protocols!=null&&(o=new Set([...o,...e.protocols])),e.metadata!=null){const h=e.metadata instanceof Map?[...e.metadata.entries()]:Object.entries(e.metadata);for(const[f,m]of h)m==null?a.delete(f):a.set(f,m);a=qc([...a.entries()],{validate:Dg})}if(e.tags!=null){const h=e.tags instanceof Map?[...e.tags.entries()]:Object.entries(e.tags),f=new Map(c);for(const[m,y]of h)y==null?f.delete(m):f.set(m,y);c=qc([...f.entries()],{validate:Lg,map:Bg})}e.peerRecordEnvelope!=null&&(l=e.peerRecordEnvelope)}let u;i?.id.publicKey!=null?u=Xn(i.id.publicKey):e.publicKey!=null?u=Xn(e.publicKey):n.publicKey!=null&&(u=Xn(n.publicKey));const d={addresses:await Cx(n,r.addressFilter??(async()=>!0),s,r.existingPeer?.peerPB.addresses,r),protocols:[...o.values()].sort((h,f)=>h.localeCompare(f)),metadata:a,tags:c,publicKey:u,peerRecordEnvelope:l};return d.addresses.forEach(h=>{h.observed=r.existingPeer?.peerPB.addresses?.find(f=>Ue(f.multiaddr,f.multiaddr))?.observed??Date.now()}),n.type!=="RSA"&&delete d.publicKey,d}function qc(n,e){const t=new Map;for(const[r,i]of n)i!=null&&e.validate(r,i);for(const[r,i]of n.sort(([s],[o])=>s.localeCompare(o)))i!=null&&t.set(r,e.map?.(r,i)??i);return t}function Dg(n,e){if(typeof n!="string")throw new $("Metadata key must be a string");if(!(e instanceof Uint8Array))throw new $("Metadata value must be a Uint8Array")}function Lg(n,e){if(typeof n!="string")throw new $("Tag name must be a string");if(e.value!=null){if(parseInt(`${e.value}`,10)!==e.value)throw new $("Tag value must be an integer");if(e.value<0||e.value>100)throw new $("Tag value must be between 0-100")}if(e.ttl!=null){if(parseInt(`${e.ttl}`,10)!==e.ttl)throw new $("Tag ttl must be an integer");if(e.ttl<0)throw new $("Tag ttl must be between greater than 0")}}function Bg(n,e){let t;e.expiry!=null&&(t=e.expiry),e.ttl!=null&&(t=BigInt(Date.now()+Number(e.ttl)));const r={value:e.value??0};return t!=null&&(r.expiry=t),r}function X6(n){const e=n.toString().split("/")[2],t=he.parse(e,xi);return rs(t)}function Ch(n,e,t){const r=X6(n);return bx(r,e,t)}function Tx(n,e){return{prefix:Y6,filters:(n.filters??[]).map(t=>({key:r,value:i})=>t(Ch(r,i,e))),orders:(n.orders??[]).map(t=>(r,i)=>t(Ch(r.key,r.value,e),Ch(i.key,i.value,e)))}}class Rx{peerId;datastore;locks;addressFilter;log;maxAddressAge;maxPeerAge;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-store"),this.peerId=e.peerId,this.datastore=e.datastore,this.addressFilter=t.addressFilter,this.locks=Zu({name:"libp2p_peer_store_locks",metrics:e.metrics}),this.maxAddressAge=t.maxAddressAge??yx,this.maxPeerAge=t.maxPeerAge??wx}getLock(e){let t=this.locks.get(e);return t==null&&(t={refs:0,lock:f6({name:e.toString(),singleProcess:!0})},this.locks.set(e,t)),t.refs++,t}maybeRemoveLock(e,t){t.refs--,t.refs===0&&(t.lock.finalize(),this.locks.delete(e))}async getReadLock(e,t){const r=this.getLock(e);try{const i=await r.lock.readLock(t);return()=>{i(),this.maybeRemoveLock(e,r)}}catch(i){throw this.maybeRemoveLock(e,r),i}}async getWriteLock(e,t){const r=this.getLock(e);try{const i=await r.lock.writeLock(t);return()=>{i(),this.maybeRemoveLock(e,r)}}catch(i){throw this.maybeRemoveLock(e,r),i}}async has(e,t){try{return await this.load(e,t),!0}catch(r){if(r.name!=="NotFoundError")throw r}return!1}async delete(e,t){this.peerId.equals(e)||await this.datastore.delete(Vc(e),t)}async load(e,t){const r=Vc(e),i=await this.datastore.get(r,t),s=Ri.decode(i);if(this.#r(e,s))throw await this.datastore.delete(r,t),new Xe;return Bo(e,s,this.peerId.equals(e)?1/0:this.maxAddressAge)}async save(e,t,r){const i=await this.#e(e,r),s=await Ih(e,t,"patch",{...r,addressFilter:this.addressFilter});return this.#t(e,s,i)}async patch(e,t,r){const i=await this.#e(e,r),s=await Ih(e,t,"patch",{...r,addressFilter:this.addressFilter,existingPeer:i});return this.#t(e,s,i)}async merge(e,t,r){const i=await this.#e(e,r),s=await Ih(e,t,"merge",{addressFilter:this.addressFilter,existingPeer:i});return this.#t(e,s,i)}async*all(e){for await(const{key:t,value:r}of this.datastore.query(Tx(e??{},this.maxAddressAge),e)){const i=X6(t);if(i.equals(this.peerId))continue;const s=Ri.decode(r);if(this.#r(i,s)){await this.datastore.delete(t,e);continue}yield Bo(i,s,this.peerId.equals(i)?1/0:this.maxAddressAge)}}async#e(e,t){try{const r=Vc(e),i=await this.datastore.get(r,t),s=Ri.decode(i);if(this.#r(e,s))throw await this.datastore.delete(r,t),new Xe;return{peerPB:s,peer:Bo(e,s,this.maxAddressAge)}}catch(r){r.name!=="NotFoundError"&&this.log.error("invalid peer data found in peer store - %e",r)}}async#t(e,t,r,i){t.updated=Date.now();const s=Ri.encode(t);return await this.datastore.put(Vc(e),s,i),{peer:Bo(e,t,this.maxAddressAge),previous:r?.peer,updated:r==null||!Ex(t,r.peerPB)}}#r(e,t){if(t.updated==null)return!0;if(this.peerId.equals(e))return!1;const r=t.updated<Date.now()-this.maxPeerAge,i=Date.now()-this.maxAddressAge,s=t.addresses.filter(o=>o.observed!=null&&o.observed>i);return r&&s.length===0}}class Px{store;events;peerId;log;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-store"),this.events=e.events,this.peerId=e.peerId,this.store=new Rx(e,t)}[Symbol.toStringTag]="@libp2p/peer-store";async forEach(e,t){for await(const r of this.store.all(t))e(r)}async all(e){return Ia(this.store.all(e))}async delete(e,t){const r=await this.store.getReadLock(e,t);try{await this.store.delete(e,t)}finally{r()}}async has(e,t){const r=await this.store.getReadLock(e,t);try{return await this.store.has(e,t)}finally{this.log.trace("has release read lock"),r?.()}}async get(e,t){const r=await this.store.getReadLock(e,t);try{return await this.store.load(e,t)}finally{r?.()}}async getInfo(e,t){const r=await this.get(e,t);return{id:r.id,multiaddrs:r.addresses.map(({multiaddr:i})=>i)}}async save(e,t,r){const i=await this.store.getWriteLock(e,r);try{const s=await this.store.save(e,t,r);return this.#e(e,s),s.peer}finally{i?.()}}async patch(e,t,r){const i=await this.store.getWriteLock(e,r);try{const s=await this.store.patch(e,t,r);return this.#e(e,s),s.peer}finally{i?.()}}async merge(e,t,r){const i=await this.store.getWriteLock(e,r);try{const s=await this.store.merge(e,t,r);return this.#e(e,s),s.peer}finally{i?.()}}async consumePeerRecord(e,t,r){const i=Oi(t)?t:Oi(t?.expectedPeer)?t.expectedPeer:void 0,s=Oi(t)||t===void 0?r:t,o=await sn.openAndCertify(e,fr.DOMAIN,s),a=rs(o.publicKey.toCID());if(i?.equals(a)===!1)return this.log("envelope peer id was not the expected peer id - expected: %p received: %p",i,a),!1;const c=fr.createFromProtobuf(o.payload);let l;try{l=await this.get(a,s)}catch(u){if(u.name!=="NotFoundError")throw u}if(l?.peerRecordEnvelope!=null){const u=sn.createFromProtobuf(l.peerRecordEnvelope),d=fr.createFromProtobuf(u.payload);if(d.seqNumber>=c.seqNumber)return this.log("sequence number was lower or equal to existing sequence number - stored: %d received: %d",d.seqNumber,c.seqNumber),!1}return await this.patch(c.peerId,{peerRecordEnvelope:e,addresses:c.multiaddrs.map(u=>({isCertified:!0,multiaddr:u}))},s),!0}#e(e,t){t.updated&&(this.peerId.equals(e)?this.events.safeDispatchEvent("self:peer:update",{detail:t}):this.events.safeDispatchEvent("peer:update",{detail:t}))}}function Ox(n,e={}){return new Px(n,e)}const Mg=864e13,Nx=448,Th=449,Dx=53,Lx=54,Bx=55,Mx=56;class Fx{log;mappings;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:dns-mappings"),this.mappings=Hr({name:"libp2p_address_manager_dns_mappings",metrics:e.metrics})}has(e){const t=this.findHost(e);for(const r of this.mappings.values())if(r.domain===t)return!0;return!1}add(e,t){t.forEach(r=>{this.log("add DNS mapping %s to %s",r,e);const i=fi(r)===!0;this.mappings.set(r,{domain:e,verified:i,expires:i?Mg-Date.now():0,lastVerified:i?Mg-Date.now():void 0})})}remove(e){const t=this.findHost(e);let r=!1;for(const[i,s]of this.mappings.entries())s.domain===t&&(this.log("removing %s to %s DNS mapping %e",i,s.domain),this.mappings.delete(i),r=r||s.verified);return r}getAll(e){const t=[];for(let r=0;r<e.length;r++){const s=e[r].multiaddr.stringTuples(),o=s[0][1];if(o!=null)for(const[a,c]of this.mappings.entries()){if(o!==a)continue;this.maybeAddSNITuple(s,c.domain)&&(e.splice(r,1),r--,t.push({multiaddr:ue(`/${s.map(u=>[so(u[0]).name,u[1]].join("/")).join("/")}`),verified:c.verified,type:"dns-mapping",expires:c.expires,lastVerified:c.lastVerified}))}}return t}maybeAddSNITuple(e,t){for(let r=0;r<e.length;r++)if(e[r][0]===Nx&&e[r+1]?.[0]!==Th)return e.splice(r+1,0,[Th,t]),!0;return!1}confirm(e,t){const r=this.findHost(e);let i=!1;for(const[s,o]of this.mappings.entries())o.domain===r&&(this.log("marking %s to %s DNS mapping as verified",s,o.domain),i=o.verified,o.verified=!0,o.expires=Date.now()+t,o.lastVerified=Date.now());return i}unconfirm(e,t){const r=this.findHost(e);let i=!1;for(const[s,o]of this.mappings.entries())o.domain===r&&(this.log("removing verification of %s to %s DNS mapping",s,o.domain),i=i||o.verified,o.verified=!1,o.expires=Date.now()+t);return i}findHost(e){for(const t of e.stringTuples())if(t[0]===Th||t[0]===Dx||t[0]===Lx||t[0]===Bx||t[0]===Mx)return t[1]}}const Rh=4,Ph=41,Oh=6,Ux=273;class $x{log;mappings;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:ip-mappings"),this.mappings=Hr({name:"libp2p_address_manager_ip_mappings",metrics:e.metrics})}has(e){const t=e.stringTuples();for(const r of this.mappings.values())for(const i of r)if(i.externalIp===t[0][1])return!0;return!1}add(e,t,r,i=t,s="tcp"){const o=`${e}-${t}-${s}`,a=this.mappings.get(o)??[],c={internalIp:e,internalPort:t,externalIp:r,externalPort:i,externalFamily:vl(r)?4:6,protocol:s,verified:!1,expires:0};a.push(c),this.mappings.set(o,a)}remove(e){const t=e.stringTuples(),r=t[0][1]??"",i=t[1][0]===Oh?"tcp":"udp",s=parseInt(t[1][1]??"0");let o=!1;for(const[a,c]of this.mappings.entries()){for(let l=0;l<c.length;l++){const u=c[l];u.externalIp===r&&u.externalPort===s&&u.protocol===i&&(this.log("removing %s:%s to %s:%s %s IP mapping",u.externalIp,u.externalPort,r,s,i),o=o||u.verified,c.splice(l,1),l--)}c.length===0&&this.mappings.delete(a)}return o}getAll(e){const t=[];for(const{multiaddr:r}of e){const i=r.stringTuples();let s;if((i[0][0]===Rh||i[0][0]===Ph)&&i[1][0]===Oh?s=`${i[0][1]}-${i[1][1]}-tcp`:(i[0][0]===Rh||i[0][0]===Ph)&&i[1][0]===Ux&&(s=`${i[0][1]}-${i[1][1]}-udp`),s==null)continue;const o=this.mappings.get(s);if(o!=null)for(const a of o)i[0][0]=a.externalFamily===4?Rh:Ph,i[0][1]=a.externalIp,i[1][1]=`${a.externalPort}`,t.push({multiaddr:ue(`/${i.map(c=>[so(c[0]).name,c[1]].join("/")).join("/")}`),verified:a.verified,type:"ip-mapping",expires:a.expires,lastVerified:a.lastVerified})}return t}confirm(e,t){const i=e.stringTuples()[0][1];let s=!1;for(const o of this.mappings.values())for(const a of o)a.externalIp===i&&(this.log("marking %s to %s IP mapping as verified",a.internalIp,a.externalIp),s=a.verified,a.verified=!0,a.expires=Date.now()+t,a.lastVerified=Date.now());return s}unconfirm(e,t){const r=e.stringTuples(),i=r[0][1]??"",s=r[1][0]===Oh?"tcp":"udp",o=parseInt(r[1][1]??"0");let a=!1;for(const c of this.mappings.values())for(let l=0;l<c.length;l++){const u=c[l];u.externalIp===i&&u.externalPort===o&&u.protocol===s&&(this.log("removing verification of %s:%s to %s:%s %s IP mapping",u.externalIp,u.externalPort,i,o,s),a=a||u.verified,u.verified=!1,u.expires=Date.now()+t)}return a}}function Vx(n){try{for(const{code:e,value:t}of n.getComponents())if(e!==oc&&t!=null){if(e===Gu)return t.startsWith("169.254.");if(e===Bi)return t.toLowerCase().startsWith("fe80")}}catch{}return!1}function Z6(n){try{for(const{code:e}of n.getComponents())if(e!==oc)return e===Gu||e===Bi}catch{}return!1}function Ui(n){try{if(!Z6(n))return!1;const[[,e]]=n.stringTuples();return e==null?!1:fi(e)??!1}catch{}return!0}const qx={maxObservedAddresses:10};class Hx{log;addresses;maxObservedAddresses;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:observed-addresses"),this.addresses=Hr({name:"libp2p_address_manager_observed_addresses",metrics:e.metrics}),this.maxObservedAddresses=t.maxObservedAddresses??qx.maxObservedAddresses}has(e){return this.addresses.has(e.toString())}removePrefixed(e){for(const t of this.addresses.keys())t.toString().startsWith(e)&&this.addresses.delete(t)}add(e){this.addresses.size!==this.maxObservedAddresses&&(Ui(e)||Vx(e)||(this.log("adding observed address %a",e),this.addresses.set(e.toString(),{verified:!1,expires:0})))}getAll(){return Array.from(this.addresses).map(([e,t])=>({multiaddr:ue(e),verified:t.verified,type:"observed",expires:t.expires,lastVerified:t.lastVerified}))}remove(e){const t=this.addresses.get(e.toString())?.verified??!1;return this.log("removing observed address %a",e),this.addresses.delete(e.toString()),t}confirm(e,t){const r=e.toString(),i=this.addresses.get(r)??{verified:!1,expires:Date.now()+t,lastVerified:Date.now()},s=i.verified;return i.verified=!0,i.expires=Date.now()+t,i.lastVerified=Date.now(),this.log("marking observed address %a as verified",r),this.addresses.set(r,i),s}}const zx=[Gu,Bi,w5,g5,m5,p5];function Fg(n){try{for(const{code:e}of n.getComponents())if(e!==oc)return zx.includes(e)}catch{}return!1}const Kx={maxObservedAddresses:10};class Wx{log;addresses;maxObservedAddresses;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:observed-addresses"),this.addresses=Hr({name:"libp2p_address_manager_transport_addresses",metrics:e.metrics}),this.maxObservedAddresses=t.maxObservedAddresses??Kx.maxObservedAddresses}get(e,t){if(Ui(e))return{multiaddr:e,verified:!0,type:"transport",expires:Date.now()+t,lastVerified:Date.now()};const r=this.toKey(e);let i=this.addresses.get(r);return i==null&&(i={verified:!Fg(e),expires:0},this.addresses.set(r,i)),{multiaddr:e,verified:i.verified,type:"transport",expires:i.expires,lastVerified:i.lastVerified}}has(e){const t=this.toKey(e);return this.addresses.has(t)}remove(e){const t=this.toKey(e),r=this.addresses.get(t)?.verified??!1;return this.log("removing observed address %a",e),this.addresses.delete(t),r}confirm(e,t){const r=this.toKey(e),i=this.addresses.get(r)??{verified:!1,expires:0,lastVerified:0},s=i.verified;return i.verified=!0,i.expires=Date.now()+t,i.lastVerified=Date.now(),this.addresses.set(r,i),s}unconfirm(e,t){const r=this.toKey(e),i=this.addresses.get(r)??{verified:!1,expires:0},s=i.verified;return i.verified=!1,i.expires=Date.now()+t,this.addresses.set(r,i),s}toKey(e){if(Fg(e)){const t=e.toOptions();return`${t.host}-${t.port}-${t.transport}`}return e.toString()}}const Ug=6e4,$g={addressVerificationTTL:Ug*10,addressVerificationRetry:Ug*5},Gx=n=>n;function Nh(n,e){const t=n.getPeerId();return t!=null&&Ot(t).equals(e)&&(n=n.decapsulate(ue(`/p2p/${e.toString()}`))),n}class jx{log;components;listen;announce;appendAnnounce;announceFilter;observed;dnsMappings;ipMappings;transportAddresses;observedAddressFilter;addressVerificationTTL;addressVerificationRetry;constructor(e,t={}){const{listen:r=[],announce:i=[],appendAnnounce:s=[]}=t;this.components=e,this.log=e.logger.forComponent("libp2p:address-manager"),this.listen=r.map(o=>o.toString()),this.announce=new Set(i.map(o=>o.toString())),this.appendAnnounce=new Set(s.map(o=>o.toString())),this.observed=new Hx(e,t),this.dnsMappings=new Fx(e,t),this.ipMappings=new $x(e,t),this.transportAddresses=new Wx(e,t),this.announceFilter=t.announceFilter??Gx,this.observedAddressFilter=ai(1024),this.addressVerificationTTL=t.addressVerificationTTL??$g.addressVerificationTTL,this.addressVerificationRetry=t.addressVerificationRetry??$g.addressVerificationRetry,this._updatePeerStoreAddresses=Oa(this._updatePeerStoreAddresses.bind(this),1e3),e.events.addEventListener("transport:listening",()=>{this._updatePeerStoreAddresses()}),e.events.addEventListener("transport:close",()=>{this._updatePeerStoreAddresses()})}[Symbol.toStringTag]="@libp2p/address-manager";_updatePeerStoreAddresses(){const e=this.getAddresses().map(t=>t.getPeerId()===this.components.peerId.toString()?t.decapsulate(`/p2p/${this.components.peerId.toString()}`):t);this.components.peerStore.patch(this.components.peerId,{multiaddrs:e}).catch(t=>{this.log.error("error updating addresses",t)})}getListenAddrs(){return Array.from(this.listen).map(e=>ue(e))}getAnnounceAddrs(){return Array.from(this.announce).map(e=>ue(e))}getAppendAnnounceAddrs(){return Array.from(this.appendAnnounce).map(e=>ue(e))}getObservedAddrs(){return this.observed.getAll().map(e=>e.multiaddr)}addObservedAddr(e){const t=e.stringTuples(),r=`${t[0][1]}:${t[1][1]}`;this.observedAddressFilter.has(r)||(this.observedAddressFilter.add(r),e=Nh(e,this.components.peerId),!this.ipMappings.has(e)&&(this.dnsMappings.has(e)||this.observed.add(e)))}confirmObservedAddr(e,t){e=Nh(e,this.components.peerId);let r=!0;(t?.type==="transport"||this.transportAddresses.has(e))&&!this.transportAddresses.confirm(e,t?.ttl??this.addressVerificationTTL)&&r&&(r=!1),(t?.type==="dns-mapping"||this.dnsMappings.has(e))&&!this.dnsMappings.confirm(e,t?.ttl??this.addressVerificationTTL)&&r&&(r=!1),(t?.type==="ip-mapping"||this.ipMappings.has(e))&&!this.ipMappings.confirm(e,t?.ttl??this.addressVerificationTTL)&&r&&(r=!1),(t?.type==="observed"||this.observed.has(e))&&(this.maybeUpgradeToIPMapping(e)?(this.ipMappings.confirm(e,t?.ttl??this.addressVerificationTTL),r=!1):!this.observed.confirm(e,t?.ttl??this.addressVerificationTTL)&&r&&(r=!1)),r||this._updatePeerStoreAddresses()}removeObservedAddr(e,t){e=Nh(e,this.components.peerId),this.observed.has(e)&&this.observed.remove(e),this.transportAddresses.has(e)&&this.transportAddresses.unconfirm(e,t?.ttl??this.addressVerificationRetry),this.dnsMappings.has(e)&&this.dnsMappings.unconfirm(e,t?.ttl??this.addressVerificationRetry),this.ipMappings.has(e)&&this.ipMappings.unconfirm(e,t?.ttl??this.addressVerificationRetry)}getAddresses(){const e=new Set,t=this.getAddressesWithMetadata().filter(r=>{if(!r.verified)return!1;const i=r.multiaddr.toString();return e.has(i)?!1:(e.add(i),!0)}).map(r=>r.multiaddr);return this.announceFilter(t.map(r=>{const i=ue(r);return i.getComponents().pop()?.value===this.components.peerId.toString()?i:i.encapsulate(`/p2p/${this.components.peerId.toString()}`)}))}getAddressesWithMetadata(){const e=this.getAnnounceAddrs();if(e.length>0)return this.components.transportManager.getListeners().forEach(i=>{i.updateAnnounceAddrs(e)}),e.map(i=>({multiaddr:i,verified:!0,type:"announce",expires:Date.now()+this.addressVerificationTTL,lastVerified:Date.now()}));let t=[];t=t.concat(this.components.transportManager.getAddrs().map(i=>this.transportAddresses.get(i,this.addressVerificationTTL)));const r=this.getAppendAnnounceAddrs();return r.length>0&&(this.components.transportManager.getListeners().forEach(i=>{i.updateAnnounceAddrs(r)}),t=t.concat(r.map(i=>({multiaddr:i,verified:!0,type:"announce",expires:Date.now()+this.addressVerificationTTL,lastVerified:Date.now()})))),t=t.concat(this.observed.getAll()),t=t.concat(this.ipMappings.getAll(t)),t=t.concat(this.dnsMappings.getAll(t)),t}addDNSMapping(e,t){this.dnsMappings.add(e,t)}removeDNSMapping(e){this.dnsMappings.remove(ue(`/dns/${e}`))&&this._updatePeerStoreAddresses()}addPublicAddressMapping(e,t,r,i=t,s="tcp"){this.ipMappings.add(e,t,r,i,s),this.observed.removePrefixed(`/ip${vl(r)?4:6}/${r}/${s}/${i}`)}removePublicAddressMapping(e,t,r,i=t,s="tcp"){this.ipMappings.remove(ue(`/ip${vl(r)?4:6}/${r}/${s}/${i}`))&&this._updatePeerStoreAddresses()}maybeUpgradeToIPMapping(e){if(this.ipMappings.has(e))return!1;const t=e.toOptions();if(t.family===6||t.host==="127.0.0.1"||fi(t.host)===!0)return!1;const r=this.components.transportManager.getListeners(),i=[s=>Ua.exactMatch(s)||Pl.exactMatch(s),s=>Rl.exactMatch(s),s=>qE.exactMatch(s)];for(const s of i){if(!s(e))continue;const o=r.filter(l=>l.getAddrs().filter(u=>u.toOptions().family===4&&s(u)).length>0);if(o.length!==1)continue;const a=o[0].getAddrs().filter(l=>l.toOptions().host!=="127.0.0.1").pop();if(a==null)continue;const c=a.toOptions();return this.observed.remove(e),this.ipMappings.add(c.host,c.port,t.host,t.port,t.transport),!0}return!1}}var Vg;(function(n){n.NOT_STARTED_YET="The libp2p node is not started yet",n.NOT_FOUND="Not found"})(Vg||(Vg={}));class Qx extends Error{constructor(e="Missing service"){super(e),this.name="MissingServiceError"}}class Yx extends Error{constructor(e="Unmet service dependencies"){super(e),this.name="UnmetServiceDependenciesError"}}class Dh extends Error{constructor(e="No content routers available"){super(e),this.name="NoContentRoutersError"}}class qg extends Error{constructor(e="No peer routers available"){super(e),this.name="NoPeerRoutersError"}}class Xx extends Error{constructor(e="Should not try to find self"){super(e),this.name="QueriedForSelfError"}}class Zx extends Error{constructor(e="Unhandled protocol error"){super(e),this.name="UnhandledProtocolError"}}class Jx extends Error{constructor(e="Duplicate protocol handler error"){super(e),this.name="DuplicateProtocolHandlerError"}}class Hg extends Error{constructor(e="Dial denied error"){super(e),this.name="DialDeniedError"}}class eA extends Error{constructor(e="No transport was configured to listen on this address"){super(e),this.name="UnsupportedListenAddressError"}}class tA extends Error{constructor(e="Configured listen addresses could not be listened on"){super(e),this.name="UnsupportedListenAddressesError"}}class rA extends Error{constructor(e="No valid addresses"){super(e),this.name="NoValidAddressesError"}}class nA extends Error{constructor(e="Connection intercepted"){super(e),this.name="ConnectionInterceptedError"}}class iA extends Error{constructor(e="Connection denied"){super(e),this.name="ConnectionDeniedError"}}class L1 extends Error{constructor(e="Stream is not multiplexed"){super(e),this.name="MuxerUnavailableError"}}class Hc extends Error{constructor(e="Encryption failed"){super(e),this.name="EncryptionFailedError"}}class sA extends Error{constructor(e="Transport unavailable"){super(e),this.name="TransportUnavailableError"}}class oA extends Error{constructor(e="Max recursive depth reached"){super(e),this.name="RecursionLimitError"}}class aA{components={};_started=!1;constructor(e={}){this.components={};for(const[t,r]of Object.entries(e))this.components[t]=r;this.components.logger==null&&(this.components.logger=q0())}isStarted(){return this._started}async _invokeStartableMethod(e){await Promise.all(Object.values(this.components).filter(t=>J0(t)).map(async t=>{await t[e]?.()}))}async beforeStart(){await this._invokeStartableMethod("beforeStart")}async start(){await this._invokeStartableMethod("start"),this._started=!0}async afterStart(){await this._invokeStartableMethod("afterStart")}async beforeStop(){await this._invokeStartableMethod("beforeStop")}async stop(){await this._invokeStartableMethod("stop"),this._started=!1}async afterStop(){await this._invokeStartableMethod("afterStop")}}const cA=["metrics","connectionProtector","dns"],lA=["components","isStarted","beforeStart","start","afterStart","beforeStop","stop","afterStop","then","_invokeStartableMethod"];function uA(n={}){const e=new aA(n);return new Proxy(e,{get(r,i,s){if(typeof i=="string"&&!lA.includes(i)){const o=e.components[i];if(o==null&&!cA.includes(i))throw new Qx(`${i} not set`);return o}return Reflect.get(r,i,s)},set(r,i,s){return typeof i=="string"?e.components[i]=s:Reflect.set(r,i,s),!0}})}function dA(n){const e={};for(const t of Object.values(n.components))for(const r of hA(t))e[r]=!0;for(const t of Object.values(n.components))for(const r of fA(t))if(e[r]!==!0)throw new Yx(`Service "${pA(t)}" required capability "${r}" but it was not provided by any component, you may need to add additional configuration when creating your node.`)}function hA(n){return Array.isArray(n?.[St])?n[St]:[]}function fA(n){return Array.isArray(n?.[Mi])?n[Mi]:[]}function pA(n){return n?.[Symbol.toStringTag]??n?.toString()??"unknown"}const gA=4,mA=41;function yA(n={}){return{denyDialPeer:async()=>!1,denyDialMultiaddr:async e=>{if(Ua.matches(e))return!1;const t=e.stringTuples();return t[0][0]===gA||t[0][0]===mA?!!fi(`${t[0][1]}`):!1},denyInboundConnection:async()=>!1,denyOutboundConnection:async()=>!1,denyInboundEncryptedConnection:async()=>!1,denyOutboundEncryptedConnection:async()=>!1,denyInboundUpgradedConnection:async()=>!1,denyOutboundUpgradedConnection:async()=>!1,filterMultiaddrForPeer:async()=>!0,...n}}const zg=()=>{const n=new Error("Delay aborted");return n.name="AbortError",n},wA=new WeakMap;function vA({clearTimeout:n,setTimeout:e}={}){return(t,{value:r,signal:i}={})=>{if(i?.aborted)return Promise.reject(zg());let s,o,a;const c=n??clearTimeout,l=()=>{c(s),a(zg())},u=()=>{i&&i.removeEventListener("abort",l)},d=new Promise((h,f)=>{o=()=>{u(),h(r)},a=f,s=(e??setTimeout)(o,t)});return i&&i.addEventListener("abort",l,{once:!0}),wA.set(d,()=>{c(s),s=null,o()}),d}}const J6=vA();class ey{memoryStorage;points;duration;blockDuration;execEvenly;execEvenlyMinDelayMs;keyPrefix;constructor(e={}){this.points=e.points??4,this.duration=e.duration??1,this.blockDuration=e.blockDuration??0,this.execEvenly=e.execEvenly??!1,this.execEvenlyMinDelayMs=e.execEvenlyMinDelayMs??this.duration*1e3/this.points,this.keyPrefix=e.keyPrefix??"rlflx",this.memoryStorage=new bA}async consume(e,t=1,r={}){const i=this.getKey(e),s=this._getKeySecDuration(r);let o=this.memoryStorage.incrby(i,t,s);if(o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o.consumedPoints>this.points)throw this.blockDuration>0&&o.consumedPoints<=this.points+t&&(o=this.memoryStorage.set(i,o.consumedPoints,this.blockDuration)),new Cv("Rate limit exceeded",o);if(this.execEvenly&&o.msBeforeNext>0&&!o.isFirstInDuration){let a=Math.ceil(o.msBeforeNext/(o.remainingPoints+2));a<this.execEvenlyMinDelayMs&&(a=o.consumedPoints*this.execEvenlyMinDelayMs),await J6(a)}return o}penalty(e,t=1,r={}){const i=this.getKey(e),s=this._getKeySecDuration(r),o=this.memoryStorage.incrby(i,t,s);return o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o}reward(e,t=1,r={}){const i=this.getKey(e),s=this._getKeySecDuration(r),o=this.memoryStorage.incrby(i,-t,s);return o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o}block(e,t){const r=t*1e3,i=this.points+1;return this.memoryStorage.set(this.getKey(e),i,t),{remainingPoints:0,msBeforeNext:r===0?-1:r,consumedPoints:i,isFirstInDuration:!1}}set(e,t,r=0){const i=(r>=0?r:this.duration)*1e3;return this.memoryStorage.set(this.getKey(e),t,r),{remainingPoints:0,msBeforeNext:i===0?-1:i,consumedPoints:t,isFirstInDuration:!1}}get(e){const t=this.memoryStorage.get(this.getKey(e));return t!=null&&(t.remainingPoints=Math.max(this.points-t.consumedPoints,0)),t}delete(e){this.memoryStorage.delete(this.getKey(e))}_getKeySecDuration(e){return e?.customDuration!=null&&e.customDuration>=0?e.customDuration:this.duration}getKey(e){return this.keyPrefix.length>0?`${this.keyPrefix}:${e}`:e}parseKey(e){return e.substring(this.keyPrefix.length)}}class bA{storage;constructor(){this.storage=new Map}incrby(e,t,r){const i=this.storage.get(e);if(i!=null){const s=i.expiresAt!=null?i.expiresAt.getTime()-new Date().getTime():-1;return i.expiresAt==null||s>0?(i.value+=t,{remainingPoints:0,msBeforeNext:s,consumedPoints:i.value,isFirstInDuration:!1}):this.set(e,t,r)}return this.set(e,t,r)}set(e,t,r){const i=r*1e3,s=this.storage.get(e);s!=null&&clearTimeout(s.timeoutId);const o={value:t,expiresAt:i>0?new Date(Date.now()+i):void 0};return this.storage.set(e,o),i>0&&(o.timeoutId=setTimeout(()=>{this.storage.delete(e)},i),o.timeoutId.unref!=null&&o.timeoutId.unref()),{remainingPoints:0,msBeforeNext:i===0?-1:i,consumedPoints:o.value,isFirstInDuration:!0}}get(e){const t=this.storage.get(e);if(t!=null)return{remainingPoints:0,msBeforeNext:t.expiresAt!=null?t.expiresAt.getTime()-new Date().getTime():-1,consumedPoints:t.value,isFirstInDuration:!1}}delete(e){const t=this.storage.get(e);return t!=null?(t.timeoutId!=null&&clearTimeout(t.timeoutId),this.storage.delete(e),!0):!1}}function ty(n){if(Oi(n))return{peerId:n,multiaddrs:[]};let e=Array.isArray(n)?n:[n],t;if(e.length>0){const r=e[0].getPeerId();t=r==null?void 0:Ot(r),e.forEach(i=>{if(!K0(i))throw new W0("Invalid multiaddr");const s=i.getPeerId();if(s==null){if(t!=null)throw new $("Multiaddrs must all have the same peer id or have no peer id")}else{const o=Ot(s);if(t?.equals(o)!==!0)throw new $("Multiaddrs must all have the same peer id or have no peer id")}})}return e=e.filter(r=>!FE.exactMatch(r)),{peerId:t,multiaddrs:e}}const EA=["/ipfs/id/1.0.0","/ipfs/id/push/1.0.0","/libp2p/autonat/1.0.0","/libp2p/dcutr"];async function SA(n,e){const t=n?.streams?.map(i=>i.protocol)??[],r=e?.closableProtocols??EA;if(!(t.filter(i=>i!=null&&!r.includes(i)).length>0))try{await n?.close(e)}catch(i){n?.abort(i)}}function B1(n){try{let e;typeof n=="string"?e=ue(n):e=n;const t=new Set([...e.getComponents().map(r=>r.name)]);if(!t.has("ipcidr")){const i=t.has("ip6")?"/ipcidr/128":"/ipcidr/32";e=e.encapsulate(i)}return Sv(e)}catch{throw new Error(`Can't convert to IpNet, Invalid multiaddr format: ${n}`)}}class xA{connectionManager;peerStore;allow;events;log;constructor(e,t={}){this.allow=(t.allow??[]).map(r=>B1(r)),this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager:connection-pruner"),this.maybePruneConnections=this.maybePruneConnections.bind(this)}start(){this.events.addEventListener("connection:open",this.maybePruneConnections)}stop(){this.events.removeEventListener("connection:open",this.maybePruneConnections)}maybePruneConnections(){this._maybePruneConnections().catch(e=>{this.log.error("error while pruning connections %e",e)})}async _maybePruneConnections(){const e=this.connectionManager.getConnections(),t=e.length,r=this.connectionManager.getMaxConnections();if(this.log("checking max connections limit %d/%d",t,r),t<=r)return;const i=new ns;for(const c of e){const l=c.remotePeer;if(!i.has(l)){i.set(l,0);try{const u=await this.peerStore.get(l);i.set(l,[...u.tags.values()].reduce((d,h)=>d+h.value,0))}catch(u){u.name!=="NotFoundError"&&this.log.error("error loading peer tags",u)}}}const s=this.sortConnections(e,i),o=Math.max(t-r,0),a=[];for(const c of s)if(this.log("too many connections open - closing a connection to %p",c.remotePeer),this.allow.some(u=>u.contains(c.remoteAddr.nodeAddress().address))||a.push(c),a.length===o)break;await Promise.all(a.map(async c=>{await SA(c,{signal:AbortSignal.timeout(1e3)})})),this.events.safeDispatchEvent("connection:prune",{detail:a})}sortConnections(e,t){return e.sort((r,i)=>{const s=r.timeline.open,o=i.timeline.open;return s<o?1:s>o?-1:0}).sort((r,i)=>r.direction==="outbound"&&i.direction==="inbound"?1:r.direction==="inbound"&&i.direction==="outbound"?-1:0).sort((r,i)=>r.streams.length>i.streams.length?1:r.streams.length<i.streams.length?-1:0).sort((r,i)=>{const s=t.get(r.remotePeer)??0,o=t.get(i.remotePeer)??0;return s>o?1:s<o?-1:0})}}const ry=1e4,AA=1e4,$l=1e4,ny=25,kA=5,_A=10,IA=5,CA="last-dial-failure",TA="last-dial-success",iy=500,RA=32,PA=100,sy=50;class OA extends si{constructor(e={}){super({...e,sort:(t,r)=>t.options.priority>r.options.priority?-1:t.options.priority<r.options.priority?1:0})}}function NA(n){return/^127\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(n)||/^::1$/.test(n)}function Kg(n){if(!Z6(n))return!1;const{address:e}=n.nodeAddress();return NA(e)}function DA(n,e){const t=Rl.exactMatch(n.multiaddr),r=Rl.exactMatch(e.multiaddr);if(t&&!r)return-1;if(!t&&r)return 1;const i=Pl.exactMatch(n.multiaddr),s=Pl.exactMatch(e.multiaddr);if(i&&!s)return-1;if(!i&&s)return 1;const o=Ua.exactMatch(n.multiaddr),a=Ua.exactMatch(e.multiaddr);if(o&&!a)return-1;if(!o&&a)return 1;const c=P1.exactMatch(n.multiaddr),l=P1.exactMatch(e.multiaddr);if(c&&!l)return-1;if(!c&&l)return 1;const u=R1.exactMatch(n.multiaddr),d=R1.exactMatch(e.multiaddr);if(u&&!d)return-1;if(!u&&d)return 1;const h=Eg.exactMatch(n.multiaddr),f=Eg.exactMatch(e.multiaddr);return h&&!f?-1:!h&&f?1:0}function LA(n,e){const t=Kg(n.multiaddr),r=Kg(e.multiaddr);return t&&!r?1:!t&&r?-1:0}function BA(n,e){const t=Ui(n.multiaddr),r=Ui(e.multiaddr);return t&&!r?1:!t&&r?-1:0}function MA(n,e){return n.isCertified&&!e.isCertified?-1:!n.isCertified&&e.isCertified?1:0}function FA(n,e){const t=ci.exactMatch(n.multiaddr),r=ci.exactMatch(e.multiaddr);return t&&!r?1:!t&&r?-1:0}function UA(n){return n.sort(DA).sort(MA).sort(FA).sort(BA).sort(LA)}async function oy(n,e,t){const r=t.depth??0;if(r>(t.maxRecursiveDepth??RA))throw new oA("Max recursive depth reached");let i=!1;const s=[];for(const o of Object.values(e))if(o.canResolve(n)){i=!0;const a=await o.resolve(n,t);for(const c of a)s.push(...await oy(c,e,{...t,depth:r+1}))}return i===!1&&s.push(n),s}const Io={maxParallelDials:sy,maxDialQueueLength:iy,maxPeerAddrsToDial:ny,dialTimeout:ry,resolvers:{dnsaddr:fp}};class $A{queue;components;addressSorter;maxPeerAddrsToDial;maxDialQueueLength;dialTimeout;shutDownController;connections;log;resolvers;constructor(e,t={}){this.addressSorter=t.addressSorter,this.maxPeerAddrsToDial=t.maxPeerAddrsToDial??Io.maxPeerAddrsToDial,this.maxDialQueueLength=t.maxDialQueueLength??Io.maxDialQueueLength,this.dialTimeout=t.dialTimeout??Io.dialTimeout,this.connections=t.connections??new ns,this.log=e.logger.forComponent("libp2p:connection-manager:dial-queue"),this.components=e,this.resolvers=t.resolvers??Io.resolvers,this.shutDownController=new AbortController,this.shutDownController.signal,this.queue=new OA({concurrency:t.maxParallelDials??Io.maxParallelDials,metricName:"libp2p_dial_queue",metrics:e.metrics}),this.queue.addEventListener("failure",r=>{r.detail?.error.name!==pt.name&&this.log.error("error in dial queue - %e",r.detail)})}start(){this.shutDownController=new AbortController,this.shutDownController.signal}stop(){this.shutDownController.abort(),this.queue.abort()}async dial(e,t={}){const{peerId:r,multiaddrs:i}=ty(e),s=Array.from(this.connections.values()).flat().find(a=>t.force===!0||a.limits!=null?!1:a.remotePeer.equals(r)?!0:i.find(c=>c.equals(a.remoteAddr)));if(s?.status==="open")return this.log("already connected to %a",s.remoteAddr),t.onProgress?.(new P("dial-queue:already-connected")),s;const o=this.queue.queue.find(a=>{if(r?.equals(a.options.peerId)===!0)return!0;const c=a.options.multiaddrs;if(c==null)return!1;for(const l of i)if(c.has(l.toString()))return!0;return!1});if(o!=null){this.log("joining existing dial target for %p",r);for(const a of i)o.options.multiaddrs.add(a.toString());return t.onProgress?.(new P("dial-queue:already-in-dial-queue")),o.join(t)}if(this.queue.size>=this.maxDialQueueLength)throw new ia("Dial queue is full");return this.log("creating dial target for %p",r,i.map(a=>a.toString())),t.onProgress?.(new P("dial-queue:add-to-dial-queue")),this.queue.add(async a=>{a.onProgress?.(new P("dial-queue:start-dial"));const c=Re([this.shutDownController.signal,a.signal]);try{return await this.dialPeer(a,c)}finally{c.clear()}},{peerId:r,priority:t.priority??ay,multiaddrs:new Set(i.map(a=>a.toString())),signal:t.signal??AbortSignal.timeout(this.dialTimeout),onProgress:t.onProgress})}async dialPeer(e,t){const r=e.peerId,i=e.multiaddrs,s=new Set;let o=e.multiaddrs.size===0,a=0,c=0;const l=[];for(this.log("starting dial to %p",r);o||i.size>0;){c++,o=!1;const u=[],d=new Set(e.multiaddrs);i.clear(),this.log("calculating addrs to dial %p from %s",r,[...d]);const h=await this.calculateMultiaddrs(r,d,{...e,signal:t});for(const f of h){if(s.has(f.multiaddr.toString())){this.log.trace("skipping previously failed multiaddr %a while dialing %p",f.multiaddr,r);continue}u.push(f)}this.log("%s dial to %p with %s",c===1?"starting":"continuing",r,u.map(f=>f.multiaddr.toString())),e?.onProgress?.(new P("dial-queue:calculated-addresses",u));for(const f of u){if(a===this.maxPeerAddrsToDial)throw this.log("dialed maxPeerAddrsToDial (%d) addresses for %p, not trying any others",a,e.peerId),new ia("Peer had more than maxPeerAddrsToDial");a++;try{const m=await this.components.transportManager.dial(f.multiaddr,{...e,signal:t});this.log("dial to %a succeeded",f.multiaddr);try{await this.components.peerStore.merge(m.remotePeer,{multiaddrs:[m.remoteAddr],metadata:{[TA]:C(Date.now().toString())}})}catch(y){this.log.error("could not update last dial failure key for %p",r,y)}return m}catch(m){if(this.log.error("dial failed to %a",f.multiaddr,m),s.add(f.multiaddr.toString()),r!=null)try{await this.components.peerStore.merge(r,{metadata:{[CA]:C(Date.now().toString())}})}catch(y){this.log.error("could not update last dial failure key for %p",r,y)}if(t.aborted)throw new nc(m.message);l.push(m)}}}throw l.length===1?l[0]:new AggregateError(l,"All multiaddr dials failed")}async calculateMultiaddrs(e,t=new Set,r={}){const i=[...t].map(d=>({multiaddr:ue(d),isCertified:!1}));if(e!=null){if(this.components.peerId.equals(e))throw new ia("Tried to dial self");if(await this.components.connectionGater.denyDialPeer?.(e)===!0)throw new Hg("The dial request is blocked by gater.allowDialPeer");if(i.length===0){this.log("loading multiaddrs for %p",e);try{const d=await this.components.peerStore.get(e);i.push(...d.addresses),this.log("loaded multiaddrs for %p",e,i.map(({multiaddr:h})=>h.toString()))}catch(d){if(d.name!=="NotFoundError")throw d}}if(i.length===0){this.log("looking up multiaddrs for %p in the peer routing",e);try{const d=await this.components.peerRouting.findPeer(e,r);this.log("found multiaddrs for %p in the peer routing",e,i.map(({multiaddr:h})=>h.toString())),i.push(...d.multiaddrs.map(h=>({multiaddr:h,isCertified:!1})))}catch(d){d.name==="NoPeerRoutersError"?this.log("no peer routers configured",e):this.log.error("looking up multiaddrs for %p in the peer routing failed - %e",e,d)}}}let s=(await Promise.all(i.map(async d=>{const h=await oy(d.multiaddr,this.resolvers,{dns:this.components.dns,log:this.log,...r});return h.length===1&&h[0].equals(d.multiaddr)?d:h.map(f=>({multiaddr:f,isCertified:!1}))}))).flat();if(e!=null){const d=`/p2p/${e.toString()}`;s=s.map(h=>h.multiaddr.getComponents().pop()?.name!=="p2p"?{multiaddr:h.multiaddr.encapsulate(d),isCertified:h.isCertified}:h)}const o=s.filter(d=>{if(this.components.transportManager.dialTransportForMultiaddr(d.multiaddr)==null)return!1;const h=d.multiaddr.getPeerId();return e!=null&&h!=null?e.equals(h):!0}),a=new Map;for(const d of o){const h=d.multiaddr.toString(),f=a.get(h);if(f!=null){f.isCertified=f.isCertified||d.isCertified||!1;continue}a.set(h,d)}const c=[...a.values()];if(c.length===0)throw new rA("The dial request has no valid addresses");const l=[];for(const d of c)this.components.connectionGater.denyDialMultiaddr!=null&&await this.components.connectionGater.denyDialMultiaddr(d.multiaddr)||l.push(d);const u=this.addressSorter==null?UA(l):l.sort(this.addressSorter);if(u.length===0)throw new Hg("The connection gater denied all addresses in the dial request");return this.log.trace("addresses for %p before filtering",e??"unknown peer",s.map(({multiaddr:d})=>d.toString())),this.log.trace("addresses for %p after filtering",e??"unknown peer",u.map(({multiaddr:d})=>d.toString())),u}async isDialable(e,t={}){Array.isArray(e)||(e=[e]);try{const r=await this.calculateMultiaddrs(void 0,new Set(e.map(i=>i.toString())),t);return t.runOnLimitedConnection===!1?r.find(i=>!ci.matches(i.multiaddr))!=null:!0}catch(r){this.log.trace("error calculating if multiaddr(s) were dialable",r)}return!1}}const VA=Object.prototype.toString,qA=n=>VA.call(n)==="[object Error]",HA=new Set(["network error","Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed","fetch failed","terminated"," A network error occurred.","Network connection lost"]);function zA(n){if(!(n&&qA(n)&&n.name==="TypeError"&&typeof n.message=="string"))return!1;const{message:t,stack:r}=n;return t==="Load failed"?r===void 0||"__sentry_captured__"in n:t.startsWith("error sending request for url")?!0:HA.has(t)}let KA=class extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}};const Wg=(n,e,t)=>{const r=t.retries-(e-1);return n.attemptNumber=e,n.retriesLeft=r,n};async function WA(n,e){return new Promise((t,r)=>{e={...e},e.onFailedAttempt??=()=>{},e.shouldRetry??=()=>!0,e.retries??=10;const i=Jw.operation(e),s=()=>{i.stop(),r(e.signal?.reason)};e.signal&&!e.signal.aborted&&e.signal.addEventListener("abort",s,{once:!0});const o=()=>{e.signal?.removeEventListener("abort",s),i.stop()};i.attempt(async a=>{try{const c=await n(a);o(),t(c)}catch(c){try{if(!(c instanceof Error))throw new TypeError(`Non-error was thrown: "${c}". You should only throw errors.`);if(c instanceof KA)throw c.originalError;if(c instanceof TypeError&&!zA(c))throw c;if(Wg(c,a,e),await e.shouldRetry(c)||(i.stop(),r(c)),await e.onFailedAttempt(c),!i.retry(c))throw i.mainError()}catch(l){Wg(l,a,e),o(),r(l)}}})})}class GA{log;queue;started;peerStore;retries;retryInterval;backoffFactor;connectionManager;events;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:reconnect-queue"),this.peerStore=e.peerStore,this.connectionManager=e.connectionManager,this.queue=new oi({concurrency:t.maxParallelReconnects??IA,metricName:"libp2p_reconnect_queue",metrics:e.metrics}),this.started=!1,this.retries=t.retries??5,this.backoffFactor=t.backoffFactor,this.retryInterval=t.retryInterval,this.events=e.events,e.events.addEventListener("peer:disconnect",r=>{this.maybeReconnect(r.detail).catch(i=>{this.log.error("failed to maybe reconnect to %p - %e",r.detail,i)})})}async maybeReconnect(e){if(!this.started)return;const t=await this.peerStore.get(e);Gg(t)&&(this.queue.has(e)||this.queue.add(async r=>{await WA(async i=>{if(this.started)try{await this.connectionManager.openConnection(e,{signal:r?.signal})}catch(s){throw this.log("reconnecting to %p attempt %d of %d failed - %e",e,i,this.retries,s),s}},{signal:r?.signal,retries:this.retries,factor:this.backoffFactor,minTimeout:this.retryInterval})},{peerId:e}).catch(async r=>{this.log.error("failed to reconnect to %p - %e",e,r);const i={};[...t.tags.keys()].forEach(s=>{s.startsWith(Qu)&&(i[s]=void 0)}),await this.peerStore.merge(e,{tags:i}),this.events.safeDispatchEvent("peer:reconnect-failure",{detail:e})}).catch(async r=>{this.log.error("failed to remove keep-alive tag from %p - %e",e,r)}))}start(){this.started=!0}async afterStart(){Promise.resolve().then(async()=>{const e=await this.peerStore.all({filters:[t=>Gg(t)]});await Promise.all(e.map(async t=>{await this.connectionManager.openConnection(t.id).catch(r=>{this.log.error(r)})}))}).catch(e=>{this.log.error(e)})}stop(){this.started=!1,this.queue.abort()}}function Gg(n){for(const e of n.tags.keys())if(e.startsWith(Qu))return!0;return!1}const ay=50,Lh={maxConnections:PA,inboundConnectionThreshold:kA,maxIncomingPendingConnections:_A};class jA{started;connections;allow;deny;maxIncomingPendingConnections;incomingPendingConnections;outboundPendingConnections;maxConnections;dialQueue;reconnectQueue;connectionPruner;inboundConnectionRateLimiter;peerStore;metrics;events;log;peerId;constructor(e,t={}){if(this.maxConnections=t.maxConnections??Lh.maxConnections,this.maxConnections<1)throw new $("Connection Manager maxConnections must be greater than 0");this.connections=new ns,this.started=!1,this.peerId=e.peerId,this.peerStore=e.peerStore,this.metrics=e.metrics,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager"),this.onConnect=this.onConnect.bind(this),this.onDisconnect=this.onDisconnect.bind(this),this.allow=(t.allow??[]).map(r=>B1(r)),this.deny=(t.deny??[]).map(r=>B1(r)),this.incomingPendingConnections=0,this.maxIncomingPendingConnections=t.maxIncomingPendingConnections??Lh.maxIncomingPendingConnections,this.outboundPendingConnections=0,this.inboundConnectionRateLimiter=new ey({points:t.inboundConnectionThreshold??Lh.inboundConnectionThreshold,duration:1}),this.connectionPruner=new xA({connectionManager:this,peerStore:e.peerStore,events:e.events,logger:e.logger},{allow:t.allow?.map(r=>ue(r))}),this.dialQueue=new $A(e,{addressSorter:t.addressSorter,maxParallelDials:t.maxParallelDials??sy,maxDialQueueLength:t.maxDialQueueLength??iy,maxPeerAddrsToDial:t.maxPeerAddrsToDial??ny,dialTimeout:t.dialTimeout??ry,resolvers:t.resolvers??{dnsaddr:fp},connections:this.connections}),this.reconnectQueue=new GA({events:e.events,peerStore:e.peerStore,logger:e.logger,connectionManager:this},{retries:t.reconnectRetries,retryInterval:t.reconnectRetryInterval,backoffFactor:t.reconnectBackoffFactor,maxParallelReconnects:t.maxParallelReconnects})}[Symbol.toStringTag]="@libp2p/connection-manager";async start(){this.metrics?.registerMetricGroup("libp2p_connection_manager_connections",{calculate:()=>{const e={inbound:0,"inbound pending":this.incomingPendingConnections,outbound:0,"outbound pending":this.outboundPendingConnections};for(const t of this.connections.values())for(const r of t)e[r.direction]++;return e}}),this.metrics?.registerMetricGroup("libp2p_protocol_streams_total",{label:"protocol",calculate:()=>{const e={};for(const t of this.connections.values())for(const r of t)for(const i of r.streams){const s=`${i.direction} ${i.protocol??"unnegotiated"}`;e[s]=(e[s]??0)+1}return e}}),this.metrics?.registerMetricGroup("libp2p_connection_manager_protocol_streams_per_connection_90th_percentile",{label:"protocol",calculate:()=>{const e={};for(const r of this.connections.values())for(const i of r){const s={};for(const o of i.streams){const a=`${o.direction} ${o.protocol??"unnegotiated"}`;s[a]=(s[a]??0)+1}for(const[o,a]of Object.entries(s))e[o]=e[o]??[],e[o].push(a)}const t={};for(let[r,i]of Object.entries(e)){i=i.sort((o,a)=>o-a);const s=Math.floor(i.length*.9);t[r]=i[s]}return t}}),this.events.addEventListener("connection:open",this.onConnect),this.events.addEventListener("connection:close",this.onDisconnect),await Sn(this.dialQueue,this.reconnectQueue,this.connectionPruner),this.started=!0,this.log("started")}async stop(){this.events.removeEventListener("connection:open",this.onConnect),this.events.removeEventListener("connection:close",this.onDisconnect),await hi(this.reconnectQueue,this.dialQueue,this.connectionPruner);const e=[];for(const t of this.connections.values())for(const r of t)e.push((async()=>{try{await r.close()}catch(i){this.log.error(i)}})());this.log("closing %d connections",e.length),await Promise.all(e),this.connections.clear(),this.log("stopped")}getMaxConnections(){return this.maxConnections}setMaxConnections(e){if(this.maxConnections<1)throw new $("Connection Manager maxConnections must be greater than 0");let t=!1;e<this.maxConnections&&(t=!0),this.maxConnections=e,t&&this.connectionPruner.maybePruneConnections()}onConnect(e){this._onConnect(e).catch(t=>{this.log.error(t)})}async _onConnect(e){const{detail:t}=e;if(!this.started){await t.close();return}if(t.status!=="open")return;const r=t.remotePeer,i=!this.connections.has(r),s=this.connections.get(r)??[];s.push(t),this.connections.set(r,s),r.publicKey!=null&&r.type==="RSA"&&await this.peerStore.patch(r,{publicKey:r.publicKey}),i&&this.events.safeDispatchEvent("peer:connect",{detail:t.remotePeer})}onDisconnect(e){const{detail:t}=e,r=t.remotePeer,s=(this.connections.get(r)??[]).filter(o=>o.id!==t.id);this.connections.set(r,s),s.length===0&&(this.log.trace("peer %p disconnected, removing connection map entry",r),this.connections.delete(r),this.events.safeDispatchEvent("peer:disconnect",{detail:t.remotePeer}))}getConnections(e){if(e!=null)return this.connections.get(e)??[];let t=[];for(const r of this.connections.values())t=t.concat(r);return t}getConnectionsMap(){return this.connections}async openConnection(e,t={}){if(!this.started)throw new Os("Not started");this.outboundPendingConnections++;try{t.signal?.throwIfAborted();const{peerId:r}=ty(e);if(this.peerId.equals(r))throw new b5("Can not dial self");if(r!=null&&t.force!==!0){this.log("dial %p",r);const a=this.getConnections(r).find(c=>c.limits==null);if(a!=null)return this.log("had an existing non-limited connection to %p as %a",r,a.remoteAddr),t.onProgress?.(new P("dial-queue:already-connected")),a}const i=await this.dialQueue.dial(e,{...t,priority:t.priority??ay});if(i.status!=="open")throw new E5("Remote closed connection during opening");let s=this.connections.get(i.remotePeer);s==null&&(s=[],this.connections.set(i.remotePeer,s));let o=!1;for(const a of s)if(a.id===i.id&&(o=!0),t.force!==!0&&a.id!==i.id&&a.remoteAddr.equals(i.remoteAddr))return i.abort(new W0("Duplicate multiaddr connection")),a;return o||s.push(i),i}finally{this.outboundPendingConnections--}}async closeConnections(e,t={}){const r=this.connections.get(e)??[];await Promise.all(r.map(async i=>{try{await i.close(t)}catch(s){i.abort(s)}}))}async acceptIncomingConnection(e){if(this.deny.some(i=>i.contains(e.remoteAddr.nodeAddress().address)))return this.log("connection from %a refused - connection remote address was in deny list",e.remoteAddr),!1;if(this.allow.some(i=>i.contains(e.remoteAddr.nodeAddress().address)))return this.incomingPendingConnections++,!0;if(this.incomingPendingConnections===this.maxIncomingPendingConnections)return this.log("connection from %a refused - incomingPendingConnections exceeded by host",e.remoteAddr),!1;if(e.remoteAddr.isThinWaistAddress()){const i=e.remoteAddr.nodeAddress().address;try{await this.inboundConnectionRateLimiter.consume(i,1)}catch{return this.log("connection from %a refused - inboundConnectionThreshold exceeded by host %s",e.remoteAddr,i),!1}}return this.getConnections().length<this.maxConnections?(this.incomingPendingConnections++,!0):(this.log("connection from %a refused - maxConnections exceeded",e.remoteAddr),!1)}afterUpgradeInbound(){this.incomingPendingConnections--}getDialQueue(){const e={queued:"queued",running:"active",errored:"error",complete:"success"};return this.dialQueue.queue.queue.map(t=>({id:t.id,status:e[t.status],peerId:t.options.peerId,multiaddrs:[...t.options.multiaddrs].map(r=>ue(r))}))}async isDialable(e,t={}){return this.dialQueue.isDialable(e,t)}}class Bh{movingAverage;variance;deviation;forecast;timeSpan;previousTime;constructor(e){this.timeSpan=e,this.movingAverage=0,this.variance=0,this.deviation=0,this.forecast=0}alpha(e,t){return 1-Math.exp(-(e-t)/this.timeSpan)}push(e,t=Date.now()){if(this.previousTime!=null){const r=this.alpha(t,this.previousTime),i=e-this.movingAverage,s=r*i;this.movingAverage=r*e+(1-r)*this.movingAverage,this.variance=(1-r)*(this.variance+i*s),this.deviation=Math.sqrt(this.variance),this.forecast=this.movingAverage+r*i}else this.movingAverage=e;this.previousTime=t}}const QA=1.2,YA=2,XA=5e3,ZA=6e4,JA=5e3;class $a{success;failure;next;metric;timeoutMultiplier;failureMultiplier;minTimeout;maxTimeout;constructor(e={}){const t=e.interval??JA;this.success=new Bh(t),this.failure=new Bh(t),this.next=new Bh(t),this.failureMultiplier=e.failureMultiplier??YA,this.timeoutMultiplier=e.timeoutMultiplier??QA,this.minTimeout=e.minTimeout??XA,this.maxTimeout=e.maxTimeout??ZA,e.metricName!=null&&(this.metric=e.metrics?.registerMetricGroup(e.metricName))}getTimeoutSignal(e={}){let t=Math.round(this.next.movingAverage*(e.timeoutFactor??this.timeoutMultiplier));t<this.minTimeout&&(t=this.minTimeout),t>this.maxTimeout&&(t=this.maxTimeout);const r=AbortSignal.timeout(t),i=Re([e.signal,r]);return i.start=Date.now(),i.timeout=t,i}cleanUp(e){const t=Date.now()-e.start;e.aborted?(this.failure.push(t),this.next.push(t*this.failureMultiplier),this.metric?.update({failureMovingAverage:this.failure.movingAverage,failureDeviation:this.failure.deviation,failureForecast:this.failure.forecast,failureVariance:this.failure.variance,failure:t})):(this.success.push(t),this.next.push(t),this.metric?.update({successMovingAverage:this.success.movingAverage,successDeviation:this.success.deviation,successForecast:this.success.forecast,successVariance:this.success.variance,success:t}))}}class ek extends Error{name="UnexpectedEOFError";code="ERR_UNEXPECTED_EOF"}function Vl(n,e){const t=M5();n.sink(t).catch(async o=>{await t.end(o)}),n.sink=async o=>{for await(const a of o)await t.push(a);await t.end()};let r=n.source;n.source[Symbol.iterator]!=null?r=n.source[Symbol.iterator]():n.source[Symbol.asyncIterator]!=null&&(r=n.source[Symbol.asyncIterator]());const i=new $e;return{read:async o=>{if(o?.signal?.throwIfAborted(),o?.bytes==null){const{done:c,value:l}=await ht(r.next(),o?.signal);return c===!0?null:l}for(;i.byteLength<o.bytes;){const{value:c,done:l}=await ht(r.next(),o?.signal);if(l===!0)throw new ek("unexpected end of input");i.append(c)}const a=i.sublist(0,o.bytes);return i.consume(o.bytes),a},write:async(o,a)=>{a?.signal?.throwIfAborted(),o instanceof Uint8Array?await t.push(o,a):await t.push(o.subarray(),a)},unwrap:()=>{if(i.byteLength>0){const o=n.source;n.source=(async function*(){e?.yieldBytes===!1?yield i:yield*i,yield*o})()}return n}}}const tk=1e4,rk="1.0.0",nk="ping",ik="ipfs",jg=32,sk=!0;class ok{protocol;components;log;heartbeatInterval;pingIntervalMs;abortController;timeout;abortConnectionOnPingFailure;constructor(e,t={}){this.components=e,this.protocol=`/${t.protocolPrefix??ik}/${nk}/${rk}`,this.log=e.logger.forComponent("libp2p:connection-monitor"),this.pingIntervalMs=t.pingInterval??tk,this.abortConnectionOnPingFailure=t.abortConnectionOnPingFailure??sk,this.timeout=new $a({...t.pingTimeout??{},metrics:e.metrics,metricName:"libp2p_connection_monitor_ping_time_milliseconds"})}[Symbol.toStringTag]="@libp2p/connection-monitor";[St]=["@libp2p/connection-monitor"];start(){this.abortController=new AbortController,this.abortController.signal,this.heartbeatInterval=setInterval(()=>{this.components.connectionManager.getConnections().forEach(e=>{Promise.resolve().then(async()=>{let t=Date.now();try{const r=this.timeout.getTimeoutSignal({signal:this.abortController?.signal}),i=await e.newStream(this.protocol,{signal:r,runOnLimitedConnection:!0}),s=Vl(i);t=Date.now(),await Promise.all([s.write(an(jg),{signal:r}),s.read({bytes:jg,signal:r})]),e.rtt=Date.now()-t,await s.unwrap().close({signal:r})}catch(r){if(r.name!=="UnsupportedProtocolError")throw r;e.rtt=(Date.now()-t)/2}}).catch(t=>{this.log.error("error during heartbeat",t),this.abortConnectionOnPingFailure?(this.log.error("aborting connection due to ping failure"),e.abort(t)):this.log("connection ping failed, but not aborting due to abortConnectionOnPingFailure flag")})})},this.pingIntervalMs)}stop(){this.abortController?.abort(),this.heartbeatInterval!=null&&clearInterval(this.heartbeatInterval)}}class ak{routers;started;components;constructor(e,t){this.routers=t.routers??[],this.started=!1,this.components=e,this.findProviders=e.metrics?.traceFunction("libp2p.contentRouting.findProviders",this.findProviders.bind(this),{optionsIndex:1,getAttributesFromArgs:([r],i)=>({...i,cid:r.toString()}),getAttributesFromYieldedValue:(r,i)=>({...i,providers:[...Array.isArray(i.providers)?i.providers:[],r.id.toString()]})})??this.findProviders,this.provide=e.metrics?.traceFunction("libp2p.contentRouting.provide",this.provide.bind(this),{optionsIndex:1,getAttributesFromArgs:([r],i)=>({...i,cid:r.toString()})})??this.provide,this.cancelReprovide=e.metrics?.traceFunction("libp2p.contentRouting.cancelReprovide",this.cancelReprovide.bind(this),{optionsIndex:1,getAttributesFromArgs:([r],i)=>({...i,cid:r.toString()})})??this.cancelReprovide,this.put=e.metrics?.traceFunction("libp2p.contentRouting.put",this.put.bind(this),{optionsIndex:2,getAttributesFromArgs:([r])=>({key:ee(r,"base36")})})??this.put,this.get=e.metrics?.traceFunction("libp2p.contentRouting.get",this.get.bind(this),{optionsIndex:1,getAttributesFromArgs:([r])=>({key:ee(r,"base36")})})??this.get}[Symbol.toStringTag]="@libp2p/content-routing";isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1}async*findProviders(e,t={}){if(this.routers.length===0)throw new Dh("No content routers available");const r=this,i=new nn;for await(const s of Zn(...r.routers.filter(o=>o.findProviders instanceof Function).map(o=>o.findProviders(e,t))))s!=null&&(s.multiaddrs.length>0&&await this.components.peerStore.merge(s.id,{multiaddrs:s.multiaddrs},t),!i.has(s.id)&&(i.add(s.id),yield s))}async provide(e,t={}){if(this.routers.length===0)throw new Dh("No content routers available");await Promise.all(this.routers.filter(r=>r.provide instanceof Function).map(async r=>{await r.provide(e,t)}))}async cancelReprovide(e,t={}){if(this.routers.length===0)throw new Dh("No content routers available");await Promise.all(this.routers.filter(r=>r.cancelReprovide instanceof Function).map(async r=>{await r.cancelReprovide(e,t)}))}async put(e,t,r){if(!this.isStarted())throw new Os;await Promise.all(this.routers.filter(i=>i.put instanceof Function).map(async i=>{await i.put(e,t,r)}))}async get(e,t){if(!this.isStarted())throw new Os;return Promise.any(this.routers.filter(r=>r.get instanceof Function).map(async r=>r.get(e,t)))}}const zc=globalThis.CustomEvent??Event;async function*is(n,e={}){let t=e.concurrency??1/0;t<1&&(t=1/0);const r=e.ordered??!1,i=new EventTarget,s=[];let o=we(),a=we(),c=!1,l,u=!1;i.addEventListener("task-complete",()=>{a.resolve()}),Promise.resolve().then(async()=>{try{for await(const m of n){if(s.length===t&&(o=we(),await o.promise),u)break;const y={done:!1};s.push(y),m().then(w=>{y.done=!0,y.ok=!0,y.value=w,i.dispatchEvent(new zc("task-complete"))},w=>{y.done=!0,y.err=w,i.dispatchEvent(new zc("task-complete"))})}c=!0,i.dispatchEvent(new zc("task-complete"))}catch(m){l=m,i.dispatchEvent(new zc("task-complete"))}});function d(){return r?s[0]?.done:!!s.find(m=>m.done)}function*h(){for(;s.length>0&&s[0].done;){const m=s[0];if(s.shift(),m.ok)yield m.value;else throw u=!0,o.resolve(),m.err;o.resolve()}}function*f(){for(;d();)for(let m=0;m<s.length;m++)if(s[m].done){const y=s[m];if(s.splice(m,1),m--,y.ok)yield y.value;else throw u=!0,o.resolve(),y.err;o.resolve()}}for(;;){if(d()||(a=we(),await a.promise),l!=null||(r?yield*h():yield*f(),l!=null))throw l;if(c&&s.length===0)break}}class ck{log;peerId;peerStore;routers;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-routing"),this.peerId=e.peerId,this.peerStore=e.peerStore,this.routers=t.routers??[],this.findPeer=e.metrics?.traceFunction("libp2p.peerRouting.findPeer",this.findPeer.bind(this),{optionsIndex:1,getAttributesFromArgs:([r],i)=>({...i,peer:r.toString()})})??this.findPeer,this.getClosestPeers=e.metrics?.traceFunction("libp2p.peerRouting.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1,getAttributesFromArgs:([r],i)=>({...i,key:ee(r,"base36")}),getAttributesFromYieldedValue:(r,i)=>({...i,peers:[...Array.isArray(i.peers)?i.peers:[],r.id.toString()]})})??this.getClosestPeers}[Symbol.toStringTag]="@libp2p/peer-routing";async findPeer(e,t){if(this.routers.length===0)throw new qg("No peer routers available");if(e.toString()===this.peerId.toString())throw new Xx("Should not try to find self");const r=this,i=Zn(...this.routers.filter(s=>s.findPeer instanceof Function).map(s=>(async function*(){try{yield await s.findPeer(e,t)}catch(o){r.log.error(o)}})()));for await(const s of i)if(s!=null)return s.multiaddrs.length>0&&await this.peerStore.merge(s.id,{multiaddrs:s.multiaddrs},t),s;throw new Xe}async*getClosestPeers(e,t={}){if(this.routers.length===0)throw new qg("No peer routers available");const r=this,i=ai(1024);for await(const s of is((async function*(){const o=Zn(...r.routers.filter(a=>a.getClosestPeers instanceof Function).map(a=>a.getClosestPeers(e,t)));for await(let a of o)yield async()=>{if(a.multiaddrs.length===0)try{a=await r.findPeer(a.id,{...t,useCache:!1})}catch(c){r.log.error("could not find peer multiaddrs",c);return}return a}})()))s!=null&&(s.multiaddrs.length>0&&await this.peerStore.merge(s.id,{multiaddrs:s.multiaddrs},t),!i.has(s.id.toMultihash().bytes)&&(i.add(s.id.toMultihash().bytes),yield s))}}class lk extends tt{peerRouting;log;walking;walkers;shutdownController;walkController;needNext;constructor(e){super(),this.log=e.logger.forComponent("libp2p:random-walk"),this.peerRouting=e.peerRouting,this.walkers=0,this.walking=!1,this.shutdownController=new AbortController,this.shutdownController.signal}[Symbol.toStringTag]="@libp2p/random-walk";start(){this.shutdownController=new AbortController,this.shutdownController.signal}stop(){this.shutdownController.abort()}async*walk(e){this.walking||this.startWalk(),this.walkers++;const t=Re([this.shutdownController.signal,e?.signal]);try{for(;;)this.needNext?.resolve(),this.needNext=we(),yield(await Ut(this,"walk:peer",t,{errorEvent:"walk:error"})).detail}finally{t.clear(),this.walkers--,this.walkers===0&&(this.walkController?.abort(),this.walkController=void 0)}}startWalk(){this.walking=!0,this.walkController=new AbortController,this.walkController.signal;const e=Re([this.walkController.signal,this.shutdownController.signal]),t=Date.now();let r=0;Promise.resolve().then(async()=>{for(this.log("start walk");this.walkers>0;)try{const i=an(32);let s=Date.now();for await(const o of this.peerRouting.getClosestPeers(i,{signal:e}))e.aborted&&this.log("aborting walk"),e.throwIfAborted(),this.log("found peer %p after %dms for %d walkers",o.id,Date.now()-s,this.walkers),r++,this.safeDispatchEvent("walk:peer",{detail:o}),this.walkers===1&&this.needNext!=null&&(this.log("wait for need next"),await ht(this.needNext.promise,e)),s=Date.now();this.log("walk iteration for %b and %d walkers finished, found %d peers",i,this.walkers,r)}catch(i){this.log.error("random walk errored",i),this.safeDispatchEvent("walk:error",{detail:i})}this.log("no walkers left, ended walk")}).catch(i=>{this.log.error("random walk errored",i)}).finally(()=>{this.log("finished walk, found %d peers after %dms",r,Date.now()-t),this.walking=!1})}}const cy=32,ly=64;class uk{log;topologies;handlers;components;constructor(e){this.components=e,this.log=e.logger.forComponent("libp2p:registrar"),this.topologies=new Map,e.metrics?.registerMetricGroup("libp2p_registrar_topologies",{calculate:()=>{const t={};for(const[r,i]of this.topologies)t[r]=i.size;return t}}),this.handlers=Hr({name:"libp2p_registrar_protocol_handlers",metrics:e.metrics}),this._onDisconnect=this._onDisconnect.bind(this),this._onPeerUpdate=this._onPeerUpdate.bind(this),this._onPeerIdentify=this._onPeerIdentify.bind(this),this.components.events.addEventListener("peer:disconnect",this._onDisconnect),this.components.events.addEventListener("peer:update",this._onPeerUpdate),this.components.events.addEventListener("peer:identify",this._onPeerIdentify)}[Symbol.toStringTag]="@libp2p/registrar";getProtocols(){return Array.from(new Set([...this.handlers.keys()])).sort()}getHandler(e){const t=this.handlers.get(e);if(t==null)throw new Zx(`No handler registered for protocol ${e}`);return t}getTopologies(e){const t=this.topologies.get(e);return t==null?[]:[...t.values()]}async handle(e,t,r){if(this.handlers.has(e)&&r?.force!==!0)throw new Jx(`Handler already registered for protocol ${e}`);const i=Wr.bind({ignoreUndefined:!0})({maxInboundStreams:cy,maxOutboundStreams:ly},r);this.handlers.set(e,{handler:t,options:i}),await this.components.peerStore.merge(this.components.peerId,{protocols:[e]},r)}async unhandle(e,t){(Array.isArray(e)?e:[e]).forEach(i=>{this.handlers.delete(i)}),await this.components.peerStore.patch(this.components.peerId,{protocols:this.getProtocols()},t)}async register(e,t){if(t==null)throw new $("invalid topology");const r=`${(Math.random()*1e9).toString(36)}${Date.now()}`;let i=this.topologies.get(e);return i==null&&(i=new Map,this.topologies.set(e,i)),i.set(r,t),r}unregister(e){for(const[t,r]of this.topologies.entries())r.has(e)&&(r.delete(e),r.size===0&&this.topologies.delete(t))}_onDisconnect(e){const t=e.detail,r={signal:AbortSignal.timeout(5e3)};this.components.peerStore.get(t,r).then(i=>{for(const s of i.protocols){const o=this.topologies.get(s);if(o!=null)for(const a of o.values())a.filter?.has(t)!==!1&&(a.filter?.remove(t),a.onDisconnect?.(t))}}).catch(i=>{i.name!=="NotFoundError"&&this.log.error("could not inform topologies of disconnecting peer %p",t,i)})}_onPeerUpdate(e){const{peer:t,previous:r}=e.detail,i=(r?.protocols??[]).filter(s=>!t.protocols.includes(s));for(const s of i){const o=this.topologies.get(s);if(o!=null)for(const a of o.values())a.filter?.has(t.id)!==!1&&(a.filter?.remove(t.id),a.onDisconnect?.(t.id))}}_onPeerIdentify(e){const t=e.detail.protocols,r=e.detail.connection,i=e.detail.peerId;for(const s of t){const o=this.topologies.get(s);if(o!=null)for(const a of o.values())r.limits!=null&&a.notifyOnLimitedConnection!==!0||a.filter?.has(i)!==!0&&(a.filter?.add(i),a.onConnect?.(i,r))}}}class dk{log;components;transports;listeners;faultTolerance;started;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:transports"),this.components=e,this.started=!1,this.transports=Hr({name:"libp2p_transport_manager_transports",metrics:this.components.metrics}),this.listeners=Hr({name:"libp2p_transport_manager_listeners",metrics:this.components.metrics}),this.faultTolerance=t.faultTolerance??Pa.FATAL_ALL}[Symbol.toStringTag]="@libp2p/transport-manager";add(e){const t=e[Symbol.toStringTag];if(t==null)throw new $("Transport must have a valid tag");if(this.transports.has(t))throw new $(`There is already a transport with the tag ${t}`);this.log("adding transport %s",t),this.transports.set(t,e),this.listeners.has(t)||this.listeners.set(t,[])}isStarted(){return this.started}start(){this.started=!0}async afterStart(){const e=this.components.addressManager.getListenAddrs();await this.listen(e)}async stop(){const e=[];for(const[t,r]of this.listeners)for(this.log("closing listeners for %s",t);r.length>0;){const i=r.pop();i!=null&&e.push(i.close())}await Promise.all(e),this.log("all listeners closed");for(const t of this.listeners.keys())this.listeners.set(t,[]);this.started=!1}async dial(e,t){const r=this.dialTransportForMultiaddr(e);if(r==null)throw new sA(`No transport available for address ${String(e)}`);return t?.onProgress?.(new P("transport-manager:selected-transport",r[Symbol.toStringTag])),r.dial(e,{...t,upgrader:this.components.upgrader})}getAddrs(){let e=[];for(const t of this.listeners.values())for(const r of t)e=[...e,...r.getAddrs()];return e}getTransports(){return Array.of(...this.transports.values())}getListeners(){return Array.of(...this.listeners.values()).flat()}dialTransportForMultiaddr(e){for(const t of this.transports.values())if(t.dialFilter([e]).length>0)return t}listenTransportForMultiaddr(e){for(const t of this.transports.values())if(t.listenFilter([e]).length>0)return t}async listen(e){if(!this.isStarted())throw new Os("Not started");if(e==null||e.length===0){this.log("no addresses were provided for listening, this node is dial only");return}const t={errors:new Map,ipv4:{success:0,attempts:0},ipv6:{success:0,attempts:0}};e.forEach(s=>{t.errors.set(s.toString(),new eA)});const r=[];for(const[s,o]of this.transports.entries()){const a=o.listenFilter(e);for(const c of a){this.log("creating listener for %s on %a",s,c);const l=o.createListener({upgrader:this.components.upgrader});let u=this.listeners.get(s)??[];u==null&&(u=[],this.listeners.set(s,u)),u.push(l),l.addEventListener("listening",()=>{this.components.events.safeDispatchEvent("transport:listening",{detail:l})}),l.addEventListener("close",()=>{const d=u.findIndex(h=>h===l);u.splice(d,1),this.components.events.safeDispatchEvent("transport:close",{detail:l})}),vg.matches(c)?t.ipv4.attempts++:bg.matches(c)&&t.ipv6.attempts++,r.push(l.listen(c).then(()=>{t.errors.delete(c.toString()),vg.matches(c)&&t.ipv4.success++,bg.matches(c)&&t.ipv6.success++},d=>{throw this.log.error("transport %s could not listen on address %a - %e",s,c,d),t.errors.set(c.toString(),d),d}))}}const i=await Promise.allSettled(r);if(!(i.length>0&&i.every(s=>s.status==="fulfilled"))){if(this.ipv6Unsupported(t)){this.log("all IPv4 addresses succeed but all IPv6 failed");return}if(this.faultTolerance===Pa.NO_FATAL){this.log("failed to listen on any address but fault tolerance allows this");return}throw new tA(`Some configured addresses failed to be listened on, you may need to remove one or more listen addresses from your configuration or set \`transportManager.faultTolerance\` to NO_FATAL:
${[...t.errors.entries()].map(([s,o])=>`
  ${s}: ${`${o.stack??o}`.split(`
`).join(`
  `)}
`).join("")}`)}}ipv6Unsupported(e){if(e.ipv4.attempts===0||e.ipv6.attempts===0)return!1;const t=e.ipv4.attempts===e.ipv4.success,r=e.ipv6.success===0;return t&&r}async remove(e){const t=this.listeners.get(e)??[];this.log.trace("removing transport %s",e);const r=[];for(this.log.trace("closing listeners for %s",e);t.length>0;){const i=t.pop();i!=null&&r.push(i.close())}await Promise.all(r),this.transports.delete(e),this.listeners.delete(e)}async removeAll(){const e=[];for(const t of this.transports.keys())e.push(this.remove(t));await Promise.all(e)}}const Qt="/multistream/1.0.0",pp=1024;class hk extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"}class fk extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"}class pk extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"}function Ms(n,e={}){const t=Vl(n,e);e.maxDataLength!=null&&e.maxLengthLength==null&&(e.maxLengthLength=Ft(e.maxDataLength));const r=e?.lengthDecoder??Ku,i=e?.lengthEncoder??Mr;return{read:async o=>{let a=-1;const c=new $e;for(;;){c.append(await t.read({...o,bytes:1}));try{a=r(c)}catch(l){if(l instanceof RangeError)continue;throw l}if(a<0)throw new hk("Invalid message length");if(e?.maxLengthLength!=null&&c.byteLength>e.maxLengthLength)throw new pk("message length length too long");if(a>-1)break}if(e?.maxDataLength!=null&&a>e.maxDataLength)throw new fk("message length too long");return t.read({...o,bytes:a})},write:async(o,a)=>{await t.write(new $e(i(o.byteLength),o),a)},writeV:async(o,a)=>{const c=new $e(...o.flatMap(l=>[i(l.byteLength),l]));await t.write(c,a)},unwrap:()=>t.unwrap()}}const gk=C(`
`);async function Mo(n,e,t){await n.write(e,t)}async function mk(n,e,t){await n.writeV(e,t)}async function yk(n,e){const t=await n.read(e);if(t.byteLength===0||t.get(t.byteLength-1)!==gk[0])throw e.log.error("Invalid mss message - missing newline",t),new qe("Missing newline");return t.sublist(0,-1)}async function Cs(n,e){const t=await yk(n,e);return ee(t.subarray())}async function M1(n,e,t){if(e=Array.isArray(e)?[...e]:[e],e.length===1&&t.negotiateFully===!1)return wk(n,e[0],t);const r=Ms(n,{...t,maxDataLength:pp}),i=e.shift();if(i==null)throw new Error("At least one protocol must be specified");t.log.trace('select: write ["%s", "%s"]',Qt,i);const s=C(`${Qt}
`),o=C(`${i}
`);await mk(r,[s,o],t),t.log.trace("select: reading multistream-select header");let a=await Cs(r,t);if(t.log.trace('select: read "%s"',a),a===Qt&&(t.log.trace("select: reading protocol response"),a=await Cs(r,t),t.log.trace('select: read "%s"',a)),a===i)return{stream:r.unwrap(),protocol:i};for(const c of e){t.log.trace('select: write "%s"',c),await Mo(r,C(`${c}
`),t),t.log.trace("select: reading protocol response");const l=await Cs(r,t);if(t.log.trace('select: read "%s" for "%s"',l,c),l===c)return{stream:r.unwrap(),protocol:c}}throw new Wu("protocol selection failed")}function wk(n,e,t){const r=n.sink.bind(n),i=n.source;let s=!1,o=!1;const a=we();let c=!1,l=!1;const u=we();let d=!1,h=!1;const f=we(),m=Ms({sink:r,source:i},{...t,maxDataLength:pp});n.sink=async A=>{const{sink:T}=m.unwrap();await T((async function*(){let R=!1;for await(const ie of A){if(l&&await u.promise,c)yield ie;else{l=!0,t.log.trace('optimistic: write ["%s", "%s", data(%d)] in sink',Qt,e,ie.byteLength);const re=`${e}
`;yield new $e(Uint8Array.from([19]),C(`${Qt}
`),Mr(re.length),C(re),ie).subarray(),t.log.trace('optimistic: wrote ["%s", "%s", data(%d)] in sink',Qt,e,ie.byteLength),c=!0,l=!1,u.resolve(),y().catch(j=>{t.log.error("could not finish optimistic protocol negotiation of %s",e,j)})}R=!0}R||await y()})())};async function y(){if(o){t.log.trace("optimistic: already negotiating %s stream",e),await a.promise;return}o=!0;try{c||(t.log.trace("optimistic: doing send protocol for %s stream",e),await w()),d||(t.log.trace("optimistic: doing read protocol for %s stream",e),await E())}finally{o=!1,s=!0,a.resolve()}}async function w(){if(l){await u.promise;return}l=!0;try{t.log.trace('optimistic: write ["%s", "%s", data] in source',Qt,e),await m.writeV([C(`${Qt}
`),C(`${e}
`)]),t.log.trace('optimistic: wrote ["%s", "%s", data] in source',Qt,e)}finally{c=!0,l=!1,u.resolve()}}async function E(){if(h){await f.promise;return}h=!0;try{t.log.trace("optimistic: reading multistream select header");let A=await Cs(m,t);if(t.log.trace('optimistic: read multistream select header "%s"',A),A===Qt&&(A=await Cs(m,t)),t.log.trace('optimistic: read protocol "%s", expecting "%s"',A,e),A!==e)throw new Wu("protocol selection failed")}finally{d=!0,h=!1,f.resolve()}}if(n.source=(async function*(){await y(),t.log.trace('optimistic: reading data from "%s" stream',e),yield*m.unwrap().source})(),n.closeRead!=null){const A=n.closeRead.bind(n);n.closeRead=async T=>{s||await y().catch(R=>{t.log.error("could not negotiate protocol before close read",R)}),await A(T)}}if(n.closeWrite!=null){const A=n.closeWrite.bind(n);n.closeWrite=async T=>{s||await y().catch(R=>{t.log.error("could not negotiate protocol before close write",R)}),await A(T)}}if(n.close!=null){const A=n.close.bind(n);n.close=async T=>{const R=[];l&&R.push(u.promise),h&&R.push(f.promise),R.length>0?await ht(Promise.all(R),T?.signal):(s=!0,o=!1,a.resolve()),await A(T)}}return{stream:n,protocol:e}}async function F1(n,e,t){e=Array.isArray(e)?e:[e],t.log.trace("handle: available protocols %s",e);const r=Ms(n,{...t,maxDataLength:pp,maxLengthLength:2});for(;;){t.log.trace("handle: reading incoming string");const i=await Cs(r,t);if(t.log.trace('handle: read "%s"',i),i===Qt){t.log.trace('handle: respond with "%s" for "%s"',Qt,i),await Mo(r,C(`${Qt}
`),t),t.log.trace('handle: responded with "%s" for "%s"',Qt,i);continue}if(e.includes(i))return t.log.trace('handle: respond with "%s" for "%s"',i,i),await Mo(r,C(`${i}
`),t),t.log.trace('handle: responded with "%s" for "%s"',i,i),{stream:r.unwrap(),protocol:i};if(i==="ls"){const s=new $e(...e.map(o=>Na.single(C(`${o}
`))),C(`
`));t.log.trace('handle: respond with "%s" for %s',e,i),await Mo(r,s,t),t.log.trace('handle: responded with "%s" for %s',e,i);continue}t.log.trace('handle: respond with "na" for "%s"',i),await Mo(r,C(`na
`),t),t.log('handle: responded with "na" for "%s"',i)}}const vk=500;class bk{id;remoteAddr;remotePeer;direction;timeline;multiplexer;encryption;status;limits;log;tags;maConn;muxer;components;outboundStreamProtocolNegotiationTimeout;inboundStreamProtocolNegotiationTimeout;constructor(e,t){this.components=e,this.id=t.id,this.remoteAddr=t.maConn.remoteAddr,this.remotePeer=t.remotePeer,this.direction=t.direction??"outbound",this.status="open",this.timeline=t.maConn.timeline,this.encryption=t.encryption,this.limits=t.limits,this.maConn=t.maConn,this.log=t.maConn.log,this.outboundStreamProtocolNegotiationTimeout=t.outboundStreamProtocolNegotiationTimeout??$l,this.inboundStreamProtocolNegotiationTimeout=t.inboundStreamProtocolNegotiationTimeout??$l,this.remoteAddr.getPeerId()==null&&(this.remoteAddr=this.remoteAddr.encapsulate(`/p2p/${this.remotePeer}`)),this.tags=[],t.muxerFactory!=null&&(this.multiplexer=t.muxerFactory.protocol,this.muxer=t.muxerFactory.createStreamMuxer({direction:this.direction,log:this.log,onIncomingStream:r=>{this.onIncomingStream(r)}}),Promise.all([this.muxer.sink(this.maConn.source),this.maConn.sink(this.muxer.source)]).catch(r=>{this.log.error("error piping data through muxer - %e",r)}))}[Symbol.toStringTag]="Connection";[xv]=!0;get streams(){return this.muxer?.streams??[]}newStream=async(e,t={})=>{if(this.status==="closing")throw new Lw("the connection is being closed");if(this.status==="closed")throw new E5("the connection is closed");if(Array.isArray(e)||(e=[e]),this.limits!=null&&t?.runOnLimitedConnection!==!0)throw new K2("Cannot open protocol stream on limited connection");if(this.muxer==null)throw new L1("Connection is not multiplexed");this.log.trace("starting new stream for protocols %s",e);const r=await this.muxer.newStream();this.log.trace("started new stream %s for protocols %s",r.id,e);try{if(t.signal==null){r.log("no abort signal was passed while trying to negotiate protocols %s falling back to default timeout",e);const c=AbortSignal.timeout(this.outboundStreamProtocolNegotiationTimeout);t={...t,signal:c}}r.log.trace("selecting protocol from protocols %s",e);const{stream:i,protocol:s}=await M1(r,e,{...t,log:r.log,yieldBytes:!0});r.log("selected protocol %s",s);const o=xk(s,this.components.registrar,t),a=Qg(s,"outbound",this);if(a>=o){const c=new G0(`Too many outbound protocol streams for protocol "${s}" - ${a}/${o}`);throw r.abort(c),c}return await this.components.peerStore.merge(this.remotePeer,{protocols:[s]}),r.source=i.source,r.sink=i.sink,r.protocol=s,i.closeWrite!=null&&(r.closeWrite=i.closeWrite),i.closeRead!=null&&(r.closeRead=i.closeRead),i.close!=null&&(r.close=i.close),this.components.metrics?.trackProtocolStream(r,this),r.direction="outbound",r}catch(i){throw this.log.error("could not create new outbound stream on connection %s %a for protocols %s - %e",this.direction==="inbound"?"from":"to",this.remoteAddr,e,i),r.timeline.close==null&&r.abort(i),i}};onIncomingStream(e){const t=AbortSignal.timeout(this.inboundStreamProtocolNegotiationTimeout);Promise.resolve().then(async()=>{const r=this.components.registrar.getProtocols(),{stream:i,protocol:s}=await F1(e,r,{signal:t,log:e.log,yieldBytes:!1});this.log("incoming %s stream opened",s);const o=Sk(s,this.components.registrar);if(Qg(s,"inbound",this)===o){const u=new Bw(`Too many inbound protocol streams for protocol "${s}" - limit ${o}`);throw e.abort(u),u}e.source=i.source,e.sink=i.sink,e.protocol=s,i.closeWrite!=null&&(e.closeWrite=i.closeWrite),i.closeRead!=null&&(e.closeRead=i.closeRead),i.close!=null&&(e.close=i.close),await this.components.peerStore.merge(this.remotePeer,{protocols:[s]},{signal:t}),this.components.metrics?.trackProtocolStream(e,this);const{handler:c,options:l}=this.components.registrar.getHandler(s);if(this.limits!=null&&l.runOnLimitedConnection!==!0)throw new K2("Cannot open protocol stream on limited connection");await c({connection:this,stream:e})}).catch(async r=>{this.log.error("error handling incoming stream id %s - %e",e.id,r),e.abort(r)})}async close(e={}){if(!(this.status==="closed"||this.status==="closing")){if(this.log("closing connection to %a",this.remoteAddr),this.status="closing",e.signal==null){const t=AbortSignal.timeout(vk);e={...e,signal:t}}try{this.log.trace("closing underlying transport"),await this.muxer?.close(e),await this.maConn.close(e),this.log.trace("updating timeline with close time"),this.status="closed",this.timeline.close=Date.now()}catch(t){this.log.error("error encountered during graceful close of connection to %a",this.remoteAddr,t),this.abort(t)}}}abort(e){this.status!=="closed"&&(this.log.error("aborting connection to %a due to error",this.remoteAddr,e),this.status="closing",this.muxer?.abort(e),this.maConn.abort(e),this.status="closed",this.timeline.close=Date.now())}}function Ek(n,e){return new bk(n,e)}function Sk(n,e){try{const{options:t}=e.getHandler(n);return t.maxInboundStreams}catch(t){if(t.name!=="UnhandledProtocolError")throw t}return cy}function xk(n,e,t={}){try{const{options:r}=e.getHandler(n);if(r.maxOutboundStreams!=null)return r.maxOutboundStreams}catch(r){if(r.name!=="UnhandledProtocolError")throw r}return t.maxOutboundStreams??ly}function Qg(n,e,t){let r=0;return t.streams.forEach(i=>{i.direction===e&&i.protocol===n&&r++}),r}class Ak{components;connectionEncrypters;streamMuxers;inboundUpgradeTimeout;inboundStreamProtocolNegotiationTimeout;outboundStreamProtocolNegotiationTimeout;events;metrics;constructor(e,t){this.components=e,this.connectionEncrypters=Hr({name:"libp2p_upgrader_connection_encrypters",metrics:this.components.metrics}),t.connectionEncrypters.forEach(r=>{this.connectionEncrypters.set(r.protocol,r)}),this.streamMuxers=Hr({name:"libp2p_upgrader_stream_multiplexers",metrics:this.components.metrics}),t.streamMuxers.forEach(r=>{this.streamMuxers.set(r.protocol,r)}),this.inboundUpgradeTimeout=t.inboundUpgradeTimeout??AA,this.inboundStreamProtocolNegotiationTimeout=t.inboundStreamProtocolNegotiationTimeout??$l,this.outboundStreamProtocolNegotiationTimeout=t.outboundStreamProtocolNegotiationTimeout??$l,this.events=e.events,this.metrics={dials:e.metrics?.registerCounterGroup("libp2p_connection_manager_dials_total"),errors:e.metrics?.registerCounterGroup("libp2p_connection_manager_dial_errors_total"),inboundErrors:e.metrics?.registerCounterGroup("libp2p_connection_manager_dials_inbound_errors_total"),outboundErrors:e.metrics?.registerCounterGroup("libp2p_connection_manager_dials_outbound_errors_total")}}[Symbol.toStringTag]="@libp2p/upgrader";async shouldBlockConnection(e,...t){const r=this.components.connectionGater[e];if(r==null)return;if(await r.apply(this.components.connectionGater,t)===!0)throw new nA(`The multiaddr connection is blocked by gater.${e}`)}createInboundAbortSignal(e){return Re([AbortSignal.timeout(this.inboundUpgradeTimeout),e])}async upgradeInbound(e,t){let r=!1;const i=this.createInboundAbortSignal(t.signal);try{if(this.metrics.dials?.increment({inbound:!0}),r=await ht(this.components.connectionManager.acceptIncomingConnection(e),i),!r)throw new iA("Connection denied");await ht(this.shouldBlockConnection("denyInboundConnection",e),i),await this._performUpgrade(e,"inbound",{...t,signal:i})}catch(s){throw this.metrics.errors?.increment({inbound:!0}),this.metrics.inboundErrors?.increment({[s.name??"Error"]:!0}),s}finally{i.clear(),r&&this.components.connectionManager.afterUpgradeInbound()}}async upgradeOutbound(e,t){try{this.metrics.dials?.increment({outbound:!0});const r=e.remoteAddr.getPeerId();let i;r!=null&&(i=Ot(r),await ht(this.shouldBlockConnection("denyOutboundConnection",i,e),t.signal));let s="outbound";return t.initiator===!1&&(s="inbound"),await this._performUpgrade(e,s,t)}catch(r){throw this.metrics.errors?.increment({outbound:!0}),this.metrics.outboundErrors?.increment({[r.name??"Error"]:!0}),r}}async _performUpgrade(e,t,r){let i,s,o,a,c;const l=`${parseInt(String(Math.random()*1e9)).toString(36)}${Date.now()}`;e.log=e.log.newScope(`${t}:${l}`),this.components.metrics?.trackMultiaddrConnection(e),e.log.trace("starting the %s connection upgrade",t);let u=e;if(r?.skipProtection!==!0){const h=this.components.connectionProtector;h!=null&&(e.log("protecting the %s connection",t),u=await h.protect(e,r))}try{if(i=u,r?.skipEncryption!==!0){r?.onProgress?.(new P(`upgrader:encrypt-${t}-connection`)),{conn:i,remotePeer:s,protocol:c,streamMuxer:a}=await(t==="inbound"?this._encryptInbound(u,r):this._encryptOutbound(u,r));const h={...u,...i};await this.shouldBlockConnection(t==="inbound"?"denyInboundEncryptedConnection":"denyOutboundEncryptedConnection",s,h)}else{const h=e.remoteAddr.getPeerId();if(h==null)throw new W0(`${t} connection that skipped encryption must have a peer id`);const f=Ot(h);c="native",s=f}if(s.equals(this.components.peerId)){const h=new b5("Can not dial self");throw e.abort(h),h}if(o=i,r?.muxerFactory!=null)a=r.muxerFactory;else if(a==null&&this.streamMuxers.size>0){r?.onProgress?.(new P(`upgrader:multiplex-${t}-connection`));const h=await(t==="inbound"?this._multiplexInbound({...u,...i},this.streamMuxers,r):this._multiplexOutbound({...u,...i},this.streamMuxers,r));a=h.muxerFactory,o=h.stream}}catch(h){throw e.log.error("failed to upgrade inbound connection %s %a - %e",t==="inbound"?"from":"to",e.remoteAddr,h),h}await this.shouldBlockConnection(t==="inbound"?"denyInboundUpgradedConnection":"denyOutboundUpgradedConnection",s,e);const d=this._createConnection({id:l,cryptoProtocol:c,direction:t,maConn:e,upgradedConn:o,muxerFactory:a,remotePeer:s,limits:r?.limits});return d.log("successfully upgraded %s connection",t),d}_createConnection(e){const{id:t,cryptoProtocol:r,direction:i,maConn:s,upgradedConn:o,remotePeer:a,muxerFactory:c,limits:l}=e;let u;const d=s.timeline;return s.timeline=new Proxy(d,{set:(...h)=>(h[1]==="close"&&h[2]!=null&&d.close==null&&(async()=>{try{u.status==="open"&&await u.close()}catch(f){u.log.error("error closing connection after timeline close %e",f)}finally{this.events.safeDispatchEvent("connection:close",{detail:u})}})().catch(f=>{u.log.error("error thrown while dispatching connection:close event %e",f)}),Reflect.set(...h))}),s.timeline.upgraded=Date.now(),u=Ek(this.components,{id:t,maConn:o,remotePeer:a,direction:i,muxerFactory:c,encryption:r,limits:l,outboundStreamProtocolNegotiationTimeout:this.outboundStreamProtocolNegotiationTimeout,inboundStreamProtocolNegotiationTimeout:this.inboundStreamProtocolNegotiationTimeout}),this.events.safeDispatchEvent("connection:open",{detail:u}),u}async _encryptInbound(e,t){const r=Array.from(this.connectionEncrypters.keys());try{const{stream:i,protocol:s}=await F1(e,r,{...t,log:e.log}),o=this.connectionEncrypters.get(s);if(o==null)throw new Hc(`no crypto module found for ${s}`);return e.log("encrypting inbound connection to %a using %s",e.remoteAddr,s),{...await o.secureInbound(i,t),protocol:s}}catch(i){throw e.log.error("encrypting inbound connection from %a failed",e.remoteAddr,i),new Hc(i.message)}}async _encryptOutbound(e,t){const r=Array.from(this.connectionEncrypters.keys());try{e.log.trace("selecting encrypter from %s",r);const{stream:i,protocol:s}=await M1(e,r,{...t,log:e.log,yieldBytes:!0}),o=this.connectionEncrypters.get(s);if(o==null)throw new Hc(`no crypto module found for ${s}`);return e.log("encrypting outbound connection to %a using %s",e.remoteAddr,s),{...await o.secureOutbound(i,t),protocol:s}}catch(i){throw e.log.error("encrypting outbound connection to %a failed",e.remoteAddr,i),new Hc(i.message)}}async _multiplexOutbound(e,t,r){const i=Array.from(t.keys());e.log("outbound selecting muxer %s",i);try{e.log.trace("selecting stream muxer from %s",i);const{stream:s,protocol:o}=await M1(e,i,{...r,log:e.log,yieldBytes:!0});e.log("selected %s as muxer protocol",o);const a=t.get(o);return{stream:s,muxerFactory:a}}catch(s){throw e.log.error("error multiplexing outbound connection",s),new L1(String(s))}}async _multiplexInbound(e,t,r){const i=Array.from(t.keys());e.log("inbound handling muxers %s",i);try{const{stream:s,protocol:o}=await F1(e,i,{...r,log:e.log}),a=t.get(o);return{stream:s,muxerFactory:a}}catch(s){throw e.log.error("error multiplexing inbound connection",s),new L1(String(s))}}getConnectionEncrypters(){return this.connectionEncrypters}getStreamMuxers(){return this.streamMuxers}}const uy="2.10.0",dy="js-libp2p";function hy(n,e){return`${n??dy}/${e??uy} browser/${globalThis.navigator.userAgent}`}class fy extends tt{peerId;peerStore;contentRouting;peerRouting;metrics;services;logger;status;components;log;constructor(e){super(),this.status="stopped";const t=new tt,r=t.dispatchEvent.bind(t);t.dispatchEvent=l=>{const u=r(l),d=this.dispatchEvent(new CustomEvent(l.type,{detail:l.detail}));return u||d},this.peerId=e.peerId,this.logger=e.logger??q0(),this.log=this.logger.forComponent("libp2p"),this.services={};const i=e.nodeInfo?.name??dy,s=e.nodeInfo?.version??uy,o=this.components=uA({peerId:e.peerId,privateKey:e.privateKey,nodeInfo:{name:i,version:s,userAgent:e.nodeInfo?.userAgent??hy(i,s)},logger:this.logger,events:t,datastore:e.datastore??new z6,connectionGater:yA(e.connectionGater),dns:e.dns});e.metrics!=null&&(this.metrics=this.configureComponent("metrics",e.metrics(this.components))),this.peerStore=this.configureComponent("peerStore",Ox(o,{addressFilter:this.components.connectionGater.filterMultiaddrForPeer,...e.peerStore})),o.events.addEventListener("peer:update",l=>{if(l.detail.previous==null){const u={id:l.detail.peer.id,multiaddrs:l.detail.peer.addresses.map(d=>d.multiaddr)};o.events.safeDispatchEvent("peer:discovery",{detail:u})}}),e.connectionProtector!=null&&this.configureComponent("connectionProtector",e.connectionProtector(o)),this.components.upgrader=new Ak(this.components,{connectionEncrypters:(e.connectionEncrypters??[]).map((l,u)=>this.configureComponent(`connection-encryption-${u}`,l(this.components))),streamMuxers:(e.streamMuxers??[]).map((l,u)=>this.configureComponent(`stream-muxers-${u}`,l(this.components))),inboundUpgradeTimeout:e.connectionManager?.inboundUpgradeTimeout,inboundStreamProtocolNegotiationTimeout:e.connectionManager?.inboundStreamProtocolNegotiationTimeout??e.connectionManager?.protocolNegotiationTimeout,outboundStreamProtocolNegotiationTimeout:e.connectionManager?.outboundStreamProtocolNegotiationTimeout??e.connectionManager?.protocolNegotiationTimeout}),this.configureComponent("transportManager",new dk(this.components,e.transportManager)),this.configureComponent("connectionManager",new jA(this.components,e.connectionManager)),e.connectionMonitor?.enabled!==!1&&this.configureComponent("connectionMonitor",new ok(this.components,e.connectionMonitor)),this.configureComponent("registrar",new uk(this.components)),this.configureComponent("addressManager",new jx(this.components,e.addresses));const a=(e.peerRouters??[]).map((l,u)=>this.configureComponent(`peer-router-${u}`,l(this.components)));this.peerRouting=this.components.peerRouting=this.configureComponent("peerRouting",new ck(this.components,{routers:a}));const c=(e.contentRouters??[]).map((l,u)=>this.configureComponent(`content-router-${u}`,l(this.components)));if(this.contentRouting=this.components.contentRouting=this.configureComponent("contentRouting",new ak(this.components,{routers:c})),this.configureComponent("randomWalk",new lk(this.components)),(e.peerDiscovery??[]).forEach((l,u)=>{this.configureComponent(`peer-discovery-${u}`,l(this.components)).addEventListener("peer",h=>{this.#e(h)})}),e.transports?.forEach((l,u)=>{this.components.transportManager.add(this.configureComponent(`transport-${u}`,l(this.components)))}),e.services!=null)for(const l of Object.keys(e.services)){const u=e.services[l],d=u(this.components);if(d==null){this.log.error("service factory %s returned null or undefined instance",l);continue}this.services[l]=d,this.configureComponent(l,d),d[Ns]!=null&&(this.log("registering service %s for content routing",l),c.push(d[Ns])),d[Ds]!=null&&(this.log("registering service %s for peer routing",l),a.push(d[Ds])),d[Sl]!=null&&(this.log("registering service %s for peer discovery",l),d[Sl].addEventListener?.("peer",h=>{this.#e(h)}))}dA(o)}configureComponent(e,t){return t==null&&this.log.error("component %s was null or undefined",e),this.components[e]=t,t}async start(){if(this.status==="stopped"){this.status="starting",this.log("libp2p is starting");try{await this.components.beforeStart?.(),await this.components.start(),await this.components.afterStart?.(),this.status="started",this.safeDispatchEvent("start",{detail:this}),this.log("libp2p has started")}catch(e){throw this.log.error("An error occurred starting libp2p",e),this.status="started",await this.stop(),e}}}async stop(){this.status==="started"&&(this.log("libp2p is stopping"),this.status="stopping",await this.components.beforeStop?.(),await this.components.stop(),await this.components.afterStop?.(),this.status="stopped",this.safeDispatchEvent("stop",{detail:this}),this.log("libp2p has stopped"))}getConnections(e){return this.components.connectionManager.getConnections(e)}getDialQueue(){return this.components.connectionManager.getDialQueue()}getPeers(){const e=new nn;for(const t of this.components.connectionManager.getConnections())e.add(t.remotePeer);return Array.from(e)}async dial(e,t={}){return this.components.connectionManager.openConnection(e,{priority:75,...t})}async dialProtocol(e,t,r={}){if(t==null)throw new $("no protocols were provided to open a stream");if(t=Array.isArray(t)?t:[t],t.length===0)throw new $("no protocols were provided to open a stream");return(await this.dial(e,r)).newStream(t,r)}getMultiaddrs(){return this.components.addressManager.getAddresses()}getProtocols(){return this.components.registrar.getProtocols()}async hangUp(e,t={}){K0(e)&&(e=Ot(e.getPeerId()??"")),await this.components.connectionManager.closeConnections(e,t)}async getPublicKey(e,t={}){if(this.log("getPublicKey %p",e),e.publicKey!=null)return e.publicKey;try{const o=await this.peerStore.get(e,t);if(o.id.publicKey!=null)return o.id.publicKey}catch(o){if(o.name!=="NotFoundError")throw o}const r=tr([C("/pk/"),e.toMultihash().bytes]),i=await this.contentRouting.get(r,t),s=Vr(i);return await this.peerStore.patch(e,{publicKey:s},t),s}async handle(e,t,r){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async i=>{await this.components.registrar.handle(i,t,r)}))}async unhandle(e,t){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async r=>{await this.components.registrar.unhandle(r,t)}))}async register(e,t,r){return this.components.registrar.register(e,t,r)}unregister(e){this.components.registrar.unregister(e)}async isDialable(e,t={}){return this.components.connectionManager.isDialable(e,t)}#e(e){const{detail:t}=e;if(t.id.toString()===this.peerId.toString()){this.log.error("peer discovery mechanism discovered self");return}this.components.peerStore.merge(t.id,{multiaddrs:t.multiaddrs}).catch(r=>{this.log.error(r)})}}async function py(n={}){n.privateKey??=await j0("Ed25519");const e=new fy({...await hx(n),peerId:Mw(n.privateKey)});return n.start!==!1&&await e.start(),e}const kk=["dial","dialProtocol","hangUp","handle","unhandle","getMultiaddrs","getProtocols"];function _k(n){return n==null?!1:n instanceof fy?!0:kk.every(e=>typeof n[e]=="function")}var Mh,Yg;function Ik(){if(Yg)return Mh;Yg=1;function n(t){return t>=55296&&t<=56319}function e(t){return t>=56320&&t<=57343}return Mh=function(r,i,s){if(typeof i!="string")throw new Error("Input must be string");for(var o=i.length,a=0,c,l,u=0;u<o;u+=1){if(c=i.charCodeAt(u),l=i[u],n(c)&&e(i.charCodeAt(u+1))&&(u+=1,l+=i[u]),a+=r(l),a===s)return i.slice(0,u+1);if(a>s)return i.slice(0,u-l.length+1)}return i},Mh}var Fh,Xg;function Ck(){if(Xg)return Fh;Xg=1;function n(t){return t>=55296&&t<=56319}function e(t){return t>=56320&&t<=57343}return Fh=function(r){if(typeof r!="string")throw new Error("Input must be string");for(var i=r.length,s=0,o=null,a=null,c=0;c<i;c++)o=r.charCodeAt(c),e(o)?a!=null&&n(a)?s+=1:s+=3:o<=127?s+=1:o>=128&&o<=2047?s+=2:o>=2048&&o<=65535&&(s+=3),a=o;return s},Fh}var Uh,Zg;function Tk(){if(Zg)return Uh;Zg=1;var n=Ik(),e=Ck();return Uh=n.bind(null,e),Uh}var $h,Jg;function Rk(){if(Jg)return $h;Jg=1;var n=Tk(),e=/[\/\?<>\\:\*\|"]/g,t=/[\x00-\x1f\x80-\x9f]/g,r=/^\.+$/,i=/^(con|prn|aux|nul|com[0-9]|lpt[0-9])(\..*)?$/i,s=/[\. ]+$/;function o(a,c){if(typeof a!="string")throw new Error("Input must be string");var l=a.replace(e,c).replace(t,c).replace(r,c).replace(i,c).replace(s,c);return n(l,255)}return $h=function(a,c){var l=c&&c.replacement||"",u=o(a,l);return l===""?u:o(u,"")},$h}var Pk=Rk();const gy=ao(Pk),e3={keyLength:512/8,iterationCount:1e4,salt:"you should override this value with a crypto secure random number",hash:"sha2-512"},Vh={alg:"A128GCM",ext:!0,k:"scm9jmO_4BJAgdwWGVulLg",key_ops:["encrypt","decrypt"],kty:"oct"};function cd(n){const e="AES-GCM";let t=16;const r=12,i="SHA-256",s=16,o=32767,a=ac.get();t*=8;async function c(d,h){const f=a.getRandomValues(new Uint8Array(s)),m=a.getRandomValues(new Uint8Array(r)),y={name:e,iv:m};typeof h=="string"&&(h=C(h));let w;if(h.length===0){w=await a.subtle.importKey("jwk",Vh,{name:"AES-GCM"},!0,["encrypt"]);try{const A={name:"PBKDF2",salt:f,iterations:o,hash:{name:i}},T=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);w=await a.subtle.deriveKey(A,T,{name:e,length:t},!0,["encrypt"])}catch{w=await a.subtle.importKey("jwk",Vh,{name:"AES-GCM"},!0,["encrypt"])}}else{const A={name:"PBKDF2",salt:f,iterations:o,hash:{name:i}},T=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);w=await a.subtle.deriveKey(A,T,{name:e,length:t},!0,["encrypt"])}const E=await a.subtle.encrypt(y,w,d);return tr([f,y.iv,new Uint8Array(E)])}async function l(d,h){const f=d.subarray(0,s),m=d.subarray(s,s+r),y=d.subarray(s+r),w={name:e,iv:m};typeof h=="string"&&(h=C(h));let E;if(h.length===0)try{const T={name:"PBKDF2",salt:f,iterations:o,hash:{name:i}},R=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);E=await a.subtle.deriveKey(T,R,{name:e,length:t},!0,["decrypt"])}catch{E=await a.subtle.importKey("jwk",Vh,{name:"AES-GCM"},!0,["decrypt"])}else{const T={name:"PBKDF2",salt:f,iterations:o,hash:{name:i}},R=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);E=await a.subtle.deriveKey(T,R,{name:e,length:t},!0,["decrypt"])}const A=await a.subtle.decrypt(w,E,y);return new Uint8Array(A)}return{encrypt:c,decrypt:l}}/*!
 * MIT License
 * 
 * Copyright (c) 2017-2024 Peculiar Ventures, LLC
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 * 
 */const Ok="[object ArrayBuffer]";class L{static isArrayBuffer(e){return Object.prototype.toString.call(e)===Ok}static toArrayBuffer(e){return this.isArrayBuffer(e)?e:e.byteLength===e.buffer.byteLength||e.byteOffset===0&&e.byteLength===e.buffer.byteLength?e.buffer:this.toUint8Array(e.buffer).slice(e.byteOffset,e.byteOffset+e.byteLength).buffer}static toUint8Array(e){return this.toView(e,Uint8Array)}static toView(e,t){if(e.constructor===t)return e;if(this.isArrayBuffer(e))return new t(e);if(this.isArrayBufferView(e))return new t(e.buffer,e.byteOffset,e.byteLength);throw new TypeError("The provided value is not of type '(ArrayBuffer or ArrayBufferView)'")}static isBufferSource(e){return this.isArrayBufferView(e)||this.isArrayBuffer(e)}static isArrayBufferView(e){return ArrayBuffer.isView(e)||e&&this.isArrayBuffer(e.buffer)}static isEqual(e,t){const r=L.toUint8Array(e),i=L.toUint8Array(t);if(r.length!==i.byteLength)return!1;for(let s=0;s<r.length;s++)if(r[s]!==i[s])return!1;return!0}static concat(...e){let t;Array.isArray(e[0])&&!(e[1]instanceof Function)||Array.isArray(e[0])&&e[1]instanceof Function?t=e[0]:e[e.length-1]instanceof Function?t=e.slice(0,e.length-1):t=e;let r=0;for(const o of t)r+=o.byteLength;const i=new Uint8Array(r);let s=0;for(const o of t){const a=this.toUint8Array(o);i.set(a,s),s+=a.length}return e[e.length-1]instanceof Function?this.toView(i,e[e.length-1]):i.buffer}}const qh="string",Nk=/^[0-9a-f\s]+$/i,Dk=/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/,Lk=/^[a-zA-Z0-9-_]+$/;class t3{static fromString(e){const t=unescape(encodeURIComponent(e)),r=new Uint8Array(t.length);for(let i=0;i<t.length;i++)r[i]=t.charCodeAt(i);return r.buffer}static toString(e){const t=L.toUint8Array(e);let r="";for(let s=0;s<t.length;s++)r+=String.fromCharCode(t[s]);return decodeURIComponent(escape(r))}}class Qr{static toString(e,t=!1){const r=L.toArrayBuffer(e),i=new DataView(r);let s="";for(let o=0;o<r.byteLength;o+=2){const a=i.getUint16(o,t);s+=String.fromCharCode(a)}return s}static fromString(e,t=!1){const r=new ArrayBuffer(e.length*2),i=new DataView(r);for(let s=0;s<e.length;s++)i.setUint16(s*2,e.charCodeAt(s),t);return r}}class Q{static isHex(e){return typeof e===qh&&Nk.test(e)}static isBase64(e){return typeof e===qh&&Dk.test(e)}static isBase64Url(e){return typeof e===qh&&Lk.test(e)}static ToString(e,t="utf8"){const r=L.toUint8Array(e);switch(t.toLowerCase()){case"utf8":return this.ToUtf8String(r);case"binary":return this.ToBinary(r);case"hex":return this.ToHex(r);case"base64":return this.ToBase64(r);case"base64url":return this.ToBase64Url(r);case"utf16le":return Qr.toString(r,!0);case"utf16":case"utf16be":return Qr.toString(r);default:throw new Error(`Unknown type of encoding '${t}'`)}}static FromString(e,t="utf8"){if(!e)return new ArrayBuffer(0);switch(t.toLowerCase()){case"utf8":return this.FromUtf8String(e);case"binary":return this.FromBinary(e);case"hex":return this.FromHex(e);case"base64":return this.FromBase64(e);case"base64url":return this.FromBase64Url(e);case"utf16le":return Qr.fromString(e,!0);case"utf16":case"utf16be":return Qr.fromString(e);default:throw new Error(`Unknown type of encoding '${t}'`)}}static ToBase64(e){const t=L.toUint8Array(e);if(typeof btoa<"u"){const r=this.ToString(t,"binary");return btoa(r)}else return Buffer.from(t).toString("base64")}static FromBase64(e){const t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!Q.isBase64(t))throw new TypeError("Argument 'base64Text' is not Base64 encoded");return typeof atob<"u"?this.FromBinary(atob(t)):new Uint8Array(Buffer.from(t,"base64")).buffer}static FromBase64Url(e){const t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!Q.isBase64Url(t))throw new TypeError("Argument 'base64url' is not Base64Url encoded");return this.FromBase64(this.Base64Padding(t.replace(/\-/g,"+").replace(/\_/g,"/")))}static ToBase64Url(e){return this.ToBase64(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,"")}static FromUtf8String(e,t=Q.DEFAULT_UTF8_ENCODING){switch(t){case"ascii":return this.FromBinary(e);case"utf8":return t3.fromString(e);case"utf16":case"utf16be":return Qr.fromString(e);case"utf16le":case"usc2":return Qr.fromString(e,!0);default:throw new Error(`Unknown type of encoding '${t}'`)}}static ToUtf8String(e,t=Q.DEFAULT_UTF8_ENCODING){switch(t){case"ascii":return this.ToBinary(e);case"utf8":return t3.toString(e);case"utf16":case"utf16be":return Qr.toString(e);case"utf16le":case"usc2":return Qr.toString(e,!0);default:throw new Error(`Unknown type of encoding '${t}'`)}}static FromBinary(e){const t=e.length,r=new Uint8Array(t);for(let i=0;i<t;i++)r[i]=e.charCodeAt(i);return r.buffer}static ToBinary(e){const t=L.toUint8Array(e);let r="";for(let i=0;i<t.length;i++)r+=String.fromCharCode(t[i]);return r}static ToHex(e){const t=L.toUint8Array(e);let r="";const i=t.length;for(let s=0;s<i;s++){const o=t[s];o<16&&(r+="0"),r+=o.toString(16)}return r}static FromHex(e){let t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!Q.isHex(t))throw new TypeError("Argument 'hexString' is not HEX encoded");t.length%2&&(t=`0${t}`);const r=new Uint8Array(t.length/2);for(let i=0;i<t.length;i=i+2){const s=t.slice(i,i+2);r[i/2]=parseInt(s,16)}return r.buffer}static ToUtf16String(e,t=!1){return Qr.toString(e,t)}static FromUtf16String(e,t=!1){return Qr.fromString(e,t)}static Base64Padding(e){const t=4-e.length%4;if(t<4)for(let r=0;r<t;r++)e+="=";return e}static formatString(e){return e?.replace(/[\n\r\t ]/g,"")||""}}Q.DEFAULT_UTF8_ENCODING="utf8";function Bk(...n){const e=n.map(i=>i.byteLength).reduce((i,s)=>i+s),t=new Uint8Array(e);let r=0;return n.map(i=>new Uint8Array(i)).forEach(i=>{for(const s of i)t[r++]=s}),t.buffer}function my(n,e){if(!(n&&e)||n.byteLength!==e.byteLength)return!1;const t=new Uint8Array(n),r=new Uint8Array(e);for(let i=0;i<n.byteLength;i++)if(t[i]!==r[i])return!1;return!0}/*!
 Copyright (c) Peculiar Ventures, LLC
*/function Fs(n,e){let t=0;if(n.length===1)return n[0];for(let r=n.length-1;r>=0;r--)t+=n[n.length-1-r]*Math.pow(2,e*r);return t}function $i(n,e,t=-1){const r=t;let i=n,s=0,o=Math.pow(2,e);for(let a=1;a<8;a++){if(n<o){let c;if(r<0)c=new ArrayBuffer(a),s=a;else{if(r<a)return new ArrayBuffer(0);c=new ArrayBuffer(r),s=r}const l=new Uint8Array(c);for(let u=a-1;u>=0;u--){const d=Math.pow(2,u*e);l[s-u-1]=Math.floor(i/d),i-=l[s-u-1]*d}return c}o*=Math.pow(2,e)}return new ArrayBuffer(0)}function U1(...n){let e=0,t=0;for(const s of n)e+=s.length;const r=new ArrayBuffer(e),i=new Uint8Array(r);for(const s of n)i.set(s,t),t+=s.length;return i}function yy(){const n=new Uint8Array(this.valueHex);if(this.valueHex.byteLength>=2){const a=n[0]===255&&n[1]&128,c=n[0]===0&&(n[1]&128)===0;(a||c)&&this.warnings.push("Needlessly long format")}const e=new ArrayBuffer(this.valueHex.byteLength),t=new Uint8Array(e);for(let a=0;a<this.valueHex.byteLength;a++)t[a]=0;t[0]=n[0]&128;const r=Fs(t,8),i=new ArrayBuffer(this.valueHex.byteLength),s=new Uint8Array(i);for(let a=0;a<this.valueHex.byteLength;a++)s[a]=n[a];return s[0]&=127,Fs(s,8)-r}function Mk(n){const e=n<0?n*-1:n;let t=128;for(let r=1;r<8;r++){if(e<=t){if(n<0){const o=t-e,a=$i(o,8,r),c=new Uint8Array(a);return c[0]|=128,a}let i=$i(e,8,r),s=new Uint8Array(i);if(s[0]&128){const o=i.slice(0),a=new Uint8Array(o);i=new ArrayBuffer(i.byteLength+1),s=new Uint8Array(i);for(let c=0;c<o.byteLength;c++)s[c+1]=a[c];s[0]=0}return i}t*=Math.pow(2,8)}return new ArrayBuffer(0)}function Fk(n,e){if(n.byteLength!==e.byteLength)return!1;const t=new Uint8Array(n),r=new Uint8Array(e);for(let i=0;i<t.length;i++)if(t[i]!==r[i])return!1;return!0}function lr(n,e){const t=n.toString(10);if(e<t.length)return"";const r=e-t.length,i=new Array(r);for(let o=0;o<r;o++)i[o]="0";return i.join("").concat(t)}/*!
 * Copyright (c) 2014, GMO GlobalSign
 * Copyright (c) 2015-2022, Peculiar Ventures
 * All rights reserved.
 * 
 * Author 2014-2019, Yury Strozhevsky
 * 
 * Redistribution and use in source and binary forms, with or without modification,
 * are permitted provided that the following conditions are met:
 * 
 * * Redistributions of source code must retain the above copyright notice, this
 *   list of conditions and the following disclaimer.
 * 
 * * Redistributions in binary form must reproduce the above copyright notice, this
 *   list of conditions and the following disclaimer in the documentation and/or
 *   other materials provided with the distribution.
 * 
 * * Neither the name of the copyright holder nor the names of its
 *   contributors may be used to endorse or promote products derived from
 *   this software without specific prior written permission.
 * 
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR
 * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
 * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 * 
 */function ql(){if(typeof BigInt>"u")throw new Error("BigInt is not defined. Your environment doesn't implement BigInt.")}function gp(n){let e=0,t=0;for(let i=0;i<n.length;i++){const s=n[i];e+=s.byteLength}const r=new Uint8Array(e);for(let i=0;i<n.length;i++){const s=n[i];r.set(new Uint8Array(s),t),t+=s.byteLength}return r.buffer}function On(n,e,t,r){return e instanceof Uint8Array?e.byteLength?t<0?(n.error="Wrong parameter: inputOffset less than zero",!1):r<0?(n.error="Wrong parameter: inputLength less than zero",!1):e.byteLength-t-r<0?(n.error="End of input reached before message was fully decoded (inconsistent offset and length values)",!1):!0:(n.error="Wrong parameter: inputBuffer has zero length",!1):(n.error="Wrong parameter: inputBuffer must be 'Uint8Array'",!1)}class ld{constructor(){this.items=[]}write(e){this.items.push(e)}final(){return gp(this.items)}}const Co=[new Uint8Array([1])],r3="0123456789",Hh="name",n3="valueHexView",Uk="isHexOnly",$k="idBlock",Vk="tagClass",qk="tagNumber",Hk="isConstructed",zk="fromBER",Kk="toBER",Wk="local",Yt="",Gr=new ArrayBuffer(0),ud=new Uint8Array(0),Va="EndOfContent",wy="OCTET STRING",vy="BIT STRING";function pn(n){var e;return e=class extends n{get valueHex(){return this.valueHexView.slice().buffer}set valueHex(r){this.valueHexView=new Uint8Array(r)}constructor(...r){var i;super(...r);const s=r[0]||{};this.isHexOnly=(i=s.isHexOnly)!==null&&i!==void 0?i:!1,this.valueHexView=s.valueHex?L.toUint8Array(s.valueHex):ud}fromBER(r,i,s){const o=r instanceof ArrayBuffer?new Uint8Array(r):r;if(!On(this,o,i,s))return-1;const a=i+s;return this.valueHexView=o.subarray(i,a),this.valueHexView.length?(this.blockLength=s,a):(this.warnings.push("Zero buffer length"),i)}toBER(r=!1){return this.isHexOnly?r?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.byteLength===this.valueHexView.buffer.byteLength?this.valueHexView.buffer:this.valueHexView.slice().buffer:(this.error="Flag 'isHexOnly' is not set, abort",Gr)}toJSON(){return{...super.toJSON(),isHexOnly:this.isHexOnly,valueHex:Q.ToHex(this.valueHexView)}}},e.NAME="hexBlock",e}class ss{static blockName(){return this.NAME}get valueBeforeDecode(){return this.valueBeforeDecodeView.slice().buffer}set valueBeforeDecode(e){this.valueBeforeDecodeView=new Uint8Array(e)}constructor({blockLength:e=0,error:t=Yt,warnings:r=[],valueBeforeDecode:i=ud}={}){this.blockLength=e,this.error=t,this.warnings=r,this.valueBeforeDecodeView=L.toUint8Array(i)}toJSON(){return{blockName:this.constructor.NAME,blockLength:this.blockLength,error:this.error,warnings:this.warnings,valueBeforeDecode:Q.ToHex(this.valueBeforeDecodeView)}}}ss.NAME="baseBlock";class Kt extends ss{fromBER(e,t,r){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}toBER(e,t){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}}Kt.NAME="valueBlock";class by extends pn(ss){constructor({idBlock:e={}}={}){var t,r,i,s;super(),e?(this.isHexOnly=(t=e.isHexOnly)!==null&&t!==void 0?t:!1,this.valueHexView=e.valueHex?L.toUint8Array(e.valueHex):ud,this.tagClass=(r=e.tagClass)!==null&&r!==void 0?r:-1,this.tagNumber=(i=e.tagNumber)!==null&&i!==void 0?i:-1,this.isConstructed=(s=e.isConstructed)!==null&&s!==void 0?s:!1):(this.tagClass=-1,this.tagNumber=-1,this.isConstructed=!1)}toBER(e=!1){let t=0;switch(this.tagClass){case 1:t|=0;break;case 2:t|=64;break;case 3:t|=128;break;case 4:t|=192;break;default:return this.error="Unknown tag class",Gr}if(this.isConstructed&&(t|=32),this.tagNumber<31&&!this.isHexOnly){const i=new Uint8Array(1);if(!e){let s=this.tagNumber;s&=31,t|=s,i[0]=t}return i.buffer}if(!this.isHexOnly){const i=$i(this.tagNumber,7),s=new Uint8Array(i),o=i.byteLength,a=new Uint8Array(o+1);if(a[0]=t|31,!e){for(let c=0;c<o-1;c++)a[c+1]=s[c]|128;a[o]=s[o-1]}return a.buffer}const r=new Uint8Array(this.valueHexView.byteLength+1);if(r[0]=t|31,!e){const i=this.valueHexView;for(let s=0;s<i.length-1;s++)r[s+1]=i[s]|128;r[this.valueHexView.byteLength]=i[i.length-1]}return r.buffer}fromBER(e,t,r){const i=L.toUint8Array(e);if(!On(this,i,t,r))return-1;const s=i.subarray(t,t+r);if(s.length===0)return this.error="Zero buffer length",-1;switch(s[0]&192){case 0:this.tagClass=1;break;case 64:this.tagClass=2;break;case 128:this.tagClass=3;break;case 192:this.tagClass=4;break;default:return this.error="Unknown tag class",-1}this.isConstructed=(s[0]&32)===32,this.isHexOnly=!1;const a=s[0]&31;if(a!==31)this.tagNumber=a,this.blockLength=1;else{let c=1,l=this.valueHexView=new Uint8Array(255),u=255;for(;s[c]&128;){if(l[c-1]=s[c]&127,c++,c>=s.length)return this.error="End of input reached before message was fully decoded",-1;if(c===u){u+=255;const h=new Uint8Array(u);for(let f=0;f<l.length;f++)h[f]=l[f];l=this.valueHexView=new Uint8Array(u)}}this.blockLength=c+1,l[c-1]=s[c]&127;const d=new Uint8Array(c);for(let h=0;h<c;h++)d[h]=l[h];l=this.valueHexView=new Uint8Array(c),l.set(d),this.blockLength<=9?this.tagNumber=Fs(l,7):(this.isHexOnly=!0,this.warnings.push("Tag too long, represented as hex-coded"))}if(this.tagClass===1&&this.isConstructed)switch(this.tagNumber){case 1:case 2:case 5:case 6:case 9:case 13:case 14:case 23:case 24:case 31:case 32:case 33:case 34:return this.error="Constructed encoding used for primitive type",-1}return t+this.blockLength}toJSON(){return{...super.toJSON(),tagClass:this.tagClass,tagNumber:this.tagNumber,isConstructed:this.isConstructed}}}by.NAME="identificationBlock";class Ey extends ss{constructor({lenBlock:e={}}={}){var t,r,i;super(),this.isIndefiniteForm=(t=e.isIndefiniteForm)!==null&&t!==void 0?t:!1,this.longFormUsed=(r=e.longFormUsed)!==null&&r!==void 0?r:!1,this.length=(i=e.length)!==null&&i!==void 0?i:0}fromBER(e,t,r){const i=L.toUint8Array(e);if(!On(this,i,t,r))return-1;const s=i.subarray(t,t+r);if(s.length===0)return this.error="Zero buffer length",-1;if(s[0]===255)return this.error="Length block 0xFF is reserved by standard",-1;if(this.isIndefiniteForm=s[0]===128,this.isIndefiniteForm)return this.blockLength=1,t+this.blockLength;if(this.longFormUsed=!!(s[0]&128),this.longFormUsed===!1)return this.length=s[0],this.blockLength=1,t+this.blockLength;const o=s[0]&127;if(o>8)return this.error="Too big integer",-1;if(o+1>s.length)return this.error="End of input reached before message was fully decoded",-1;const a=t+1,c=i.subarray(a,a+o);return c[o-1]===0&&this.warnings.push("Needlessly long encoded length"),this.length=Fs(c,8),this.longFormUsed&&this.length<=127&&this.warnings.push("Unnecessary usage of long length form"),this.blockLength=o+1,t+this.blockLength}toBER(e=!1){let t,r;if(this.length>127&&(this.longFormUsed=!0),this.isIndefiniteForm)return t=new ArrayBuffer(1),e===!1&&(r=new Uint8Array(t),r[0]=128),t;if(this.longFormUsed){const i=$i(this.length,8);if(i.byteLength>127)return this.error="Too big length",Gr;if(t=new ArrayBuffer(i.byteLength+1),e)return t;const s=new Uint8Array(i);r=new Uint8Array(t),r[0]=i.byteLength|128;for(let o=0;o<i.byteLength;o++)r[o+1]=s[o];return t}return t=new ArrayBuffer(1),e===!1&&(r=new Uint8Array(t),r[0]=this.length),t}toJSON(){return{...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,longFormUsed:this.longFormUsed,length:this.length}}}Ey.NAME="lengthBlock";const z={};class At extends ss{constructor({name:e=Yt,optional:t=!1,primitiveSchema:r,...i}={},s){super(i),this.name=e,this.optional=t,r&&(this.primitiveSchema=r),this.idBlock=new by(i),this.lenBlock=new Ey(i),this.valueBlock=s?new s(i):new Kt(i)}fromBER(e,t,r){const i=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?r:this.lenBlock.length);return i===-1?(this.error=this.valueBlock.error,i):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),i)}toBER(e,t){const r=t||new ld;t||Sy(this);const i=this.idBlock.toBER(e);if(r.write(i),this.lenBlock.isIndefiniteForm)r.write(new Uint8Array([128]).buffer),this.valueBlock.toBER(e,r),r.write(new ArrayBuffer(2));else{const s=this.valueBlock.toBER(e);this.lenBlock.length=s.byteLength;const o=this.lenBlock.toBER(e);r.write(o),r.write(s)}return t?Gr:r.final()}toJSON(){const e={...super.toJSON(),idBlock:this.idBlock.toJSON(),lenBlock:this.lenBlock.toJSON(),valueBlock:this.valueBlock.toJSON(),name:this.name,optional:this.optional};return this.primitiveSchema&&(e.primitiveSchema=this.primitiveSchema.toJSON()),e}toString(e="ascii"){return e==="ascii"?this.onAsciiEncoding():Q.ToHex(this.toBER())}onAsciiEncoding(){const e=this.constructor.NAME,t=Q.ToHex(this.valueBlock.valueBeforeDecodeView);return`${e} : ${t}`}isEqual(e){if(this===e)return!0;if(!(e instanceof this.constructor))return!1;const t=this.toBER(),r=e.toBER();return Fk(t,r)}}At.NAME="BaseBlock";function Sy(n){var e;if(n instanceof z.Constructed)for(const t of n.valueBlock.value)Sy(t)&&(n.lenBlock.isIndefiniteForm=!0);return!!(!((e=n.lenBlock)===null||e===void 0)&&e.isIndefiniteForm)}class mp extends At{getValue(){return this.valueBlock.value}setValue(e){this.valueBlock.value=e}constructor({value:e=Yt,...t}={},r){super(t,r),e&&this.fromString(e)}fromBER(e,t,r){const i=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?r:this.lenBlock.length);return i===-1?(this.error=this.valueBlock.error,i):(this.fromBuffer(this.valueBlock.valueHexView),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),i)}onAsciiEncoding(){return`${this.constructor.NAME} : '${this.valueBlock.value}'`}}mp.NAME="BaseStringBlock";class xy extends pn(Kt){constructor({isHexOnly:e=!0,...t}={}){super(t),this.isHexOnly=e}}xy.NAME="PrimitiveValueBlock";var Ay;class lc extends At{constructor(e={}){super(e,xy),this.idBlock.isConstructed=!1}}Ay=lc;z.Primitive=Ay;lc.NAME="PRIMITIVE";function Gk(n,e){if(n instanceof e)return n;const t=new e;return t.idBlock=n.idBlock,t.lenBlock=n.lenBlock,t.warnings=n.warnings,t.valueBeforeDecodeView=n.valueBeforeDecodeView,t}function lo(n,e=0,t=n.length){const r=e;let i=new At({},Kt);const s=new ss;if(!On(s,n,e,t))return i.error=s.error,{offset:-1,result:i};if(!n.subarray(e,e+t).length)return i.error="Zero buffer length",{offset:-1,result:i};let a=i.idBlock.fromBER(n,e,t);if(i.idBlock.warnings.length&&i.warnings.concat(i.idBlock.warnings),a===-1)return i.error=i.idBlock.error,{offset:-1,result:i};if(e=a,t-=i.idBlock.blockLength,a=i.lenBlock.fromBER(n,e,t),i.lenBlock.warnings.length&&i.warnings.concat(i.lenBlock.warnings),a===-1)return i.error=i.lenBlock.error,{offset:-1,result:i};if(e=a,t-=i.lenBlock.blockLength,!i.idBlock.isConstructed&&i.lenBlock.isIndefiniteForm)return i.error="Indefinite length form used for primitive encoding form",{offset:-1,result:i};let c=At;switch(i.idBlock.tagClass){case 1:if(i.idBlock.tagNumber>=37&&i.idBlock.isHexOnly===!1)return i.error="UNIVERSAL 37 and upper tags are reserved by ASN.1 standard",{offset:-1,result:i};switch(i.idBlock.tagNumber){case 0:if(i.idBlock.isConstructed&&i.lenBlock.length>0)return i.error="Type [UNIVERSAL 0] is reserved",{offset:-1,result:i};c=z.EndOfContent;break;case 1:c=z.Boolean;break;case 2:c=z.Integer;break;case 3:c=z.BitString;break;case 4:c=z.OctetString;break;case 5:c=z.Null;break;case 6:c=z.ObjectIdentifier;break;case 10:c=z.Enumerated;break;case 12:c=z.Utf8String;break;case 13:c=z.RelativeObjectIdentifier;break;case 14:c=z.TIME;break;case 15:return i.error="[UNIVERSAL 15] is reserved by ASN.1 standard",{offset:-1,result:i};case 16:c=z.Sequence;break;case 17:c=z.Set;break;case 18:c=z.NumericString;break;case 19:c=z.PrintableString;break;case 20:c=z.TeletexString;break;case 21:c=z.VideotexString;break;case 22:c=z.IA5String;break;case 23:c=z.UTCTime;break;case 24:c=z.GeneralizedTime;break;case 25:c=z.GraphicString;break;case 26:c=z.VisibleString;break;case 27:c=z.GeneralString;break;case 28:c=z.UniversalString;break;case 29:c=z.CharacterString;break;case 30:c=z.BmpString;break;case 31:c=z.DATE;break;case 32:c=z.TimeOfDay;break;case 33:c=z.DateTime;break;case 34:c=z.Duration;break;default:{const l=i.idBlock.isConstructed?new z.Constructed:new z.Primitive;l.idBlock=i.idBlock,l.lenBlock=i.lenBlock,l.warnings=i.warnings,i=l}}break;case 2:case 3:case 4:default:c=i.idBlock.isConstructed?z.Constructed:z.Primitive}return i=Gk(i,c),a=i.fromBER(n,e,i.lenBlock.isIndefiniteForm?t:i.lenBlock.length),i.valueBeforeDecodeView=n.subarray(r,r+i.blockLength),{offset:a,result:i}}function xr(n){if(!n.byteLength){const e=new At({},Kt);return e.error="Input buffer has zero length",{offset:-1,result:e}}return lo(L.toUint8Array(n).slice(),0,n.byteLength)}function jk(n,e){return n?1:e}class ei extends Kt{constructor({value:e=[],isIndefiniteForm:t=!1,...r}={}){super(r),this.value=e,this.isIndefiniteForm=t}fromBER(e,t,r){const i=L.toUint8Array(e);if(!On(this,i,t,r))return-1;if(this.valueBeforeDecodeView=i.subarray(t,t+r),this.valueBeforeDecodeView.length===0)return this.warnings.push("Zero buffer length"),t;let s=t;for(;jk(this.isIndefiniteForm,r)>0;){const o=lo(i,s,r);if(o.offset===-1)return this.error=o.result.error,this.warnings.concat(o.result.warnings),-1;if(s=o.offset,this.blockLength+=o.result.blockLength,r-=o.result.blockLength,this.value.push(o.result),this.isIndefiniteForm&&o.result.constructor.NAME===Va)break}return this.isIndefiniteForm&&(this.value[this.value.length-1].constructor.NAME===Va?this.value.pop():this.warnings.push("No EndOfContent block encoded")),s}toBER(e,t){const r=t||new ld;for(let i=0;i<this.value.length;i++)this.value[i].toBER(e,r);return t?Gr:r.final()}toJSON(){const e={...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,value:[]};for(const t of this.value)e.value.push(t.toJSON());return e}}ei.NAME="ConstructedValueBlock";var ky;class Vt extends At{constructor(e={}){super(e,ei),this.idBlock.isConstructed=!0}fromBER(e,t,r){this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm;const i=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?r:this.lenBlock.length);return i===-1?(this.error=this.valueBlock.error,i):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),i)}onAsciiEncoding(){const e=[];for(const r of this.valueBlock.value)e.push(r.toString("ascii").split(`
`).map(i=>`  ${i}`).join(`
`));const t=this.idBlock.tagClass===3?`[${this.idBlock.tagNumber}]`:this.constructor.NAME;return e.length?`${t} :
${e.join(`
`)}`:`${t} :`}}ky=Vt;z.Constructed=ky;Vt.NAME="CONSTRUCTED";class _y extends Kt{fromBER(e,t,r){return t}toBER(e){return Gr}}_y.override="EndOfContentValueBlock";var Iy;class yp extends At{constructor(e={}){super(e,_y),this.idBlock.tagClass=1,this.idBlock.tagNumber=0}}Iy=yp;z.EndOfContent=Iy;yp.NAME=Va;var Cy;class zr extends At{constructor(e={}){super(e,Kt),this.idBlock.tagClass=1,this.idBlock.tagNumber=5}fromBER(e,t,r){return this.lenBlock.length>0&&this.warnings.push("Non-zero length of value block for Null type"),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.blockLength+=r,t+r>e.byteLength?(this.error="End of input reached before message was fully decoded (inconsistent offset and length values)",-1):t+r}toBER(e,t){const r=new ArrayBuffer(2);if(!e){const i=new Uint8Array(r);i[0]=5,i[1]=0}return t&&t.write(r),r}onAsciiEncoding(){return`${this.constructor.NAME}`}}Cy=zr;z.Null=Cy;zr.NAME="NULL";class Ty extends pn(Kt){get value(){for(const e of this.valueHexView)if(e>0)return!0;return!1}set value(e){this.valueHexView[0]=e?255:0}constructor({value:e,...t}={}){super(t),t.valueHex?this.valueHexView=L.toUint8Array(t.valueHex):this.valueHexView=new Uint8Array(1),e&&(this.value=e)}fromBER(e,t,r){const i=L.toUint8Array(e);return On(this,i,t,r)?(this.valueHexView=i.subarray(t,t+r),r>1&&this.warnings.push("Boolean value encoded in more then 1 octet"),this.isHexOnly=!0,yy.call(this),this.blockLength=r,t+r):-1}toBER(){return this.valueHexView.slice()}toJSON(){return{...super.toJSON(),value:this.value}}}Ty.NAME="BooleanValueBlock";var Ry;let dd=class extends At{getValue(){return this.valueBlock.value}setValue(e){this.valueBlock.value=e}constructor(e={}){super(e,Ty),this.idBlock.tagClass=1,this.idBlock.tagNumber=1}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.getValue}`}};Ry=dd;z.Boolean=Ry;dd.NAME="BOOLEAN";class Py extends pn(ei){constructor({isConstructed:e=!1,...t}={}){super(t),this.isConstructed=e}fromBER(e,t,r){let i=0;if(this.isConstructed){if(this.isHexOnly=!1,i=ei.prototype.fromBER.call(this,e,t,r),i===-1)return i;for(let s=0;s<this.value.length;s++){const o=this.value[s].constructor.NAME;if(o===Va){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, OCTET STRING may consists of OCTET STRINGs only",-1}if(o!==wy)return this.error="OCTET STRING may consists of OCTET STRINGs only",-1}}else this.isHexOnly=!0,i=super.fromBER(e,t,r),this.blockLength=r;return i}toBER(e,t){return this.isConstructed?ei.prototype.toBER.call(this,e,t):e?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),isConstructed:this.isConstructed}}}Py.NAME="OctetStringValueBlock";var wp;let $t=class extends At{constructor({idBlock:e={},lenBlock:t={},...r}={}){var i,s;(i=r.isConstructed)!==null&&i!==void 0||(r.isConstructed=!!(!((s=r.value)===null||s===void 0)&&s.length)),super({idBlock:{isConstructed:r.isConstructed,...e},lenBlock:{...t,isIndefiniteForm:!!r.isIndefiniteForm},...r},Py),this.idBlock.tagClass=1,this.idBlock.tagNumber=4}fromBER(e,t,r){if(this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,r===0)return this.idBlock.error.length===0&&(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length===0&&(this.blockLength+=this.lenBlock.blockLength),t;if(!this.valueBlock.isConstructed){const s=(e instanceof ArrayBuffer?new Uint8Array(e):e).subarray(t,t+r);try{if(s.byteLength){const o=lo(s,0,s.byteLength);o.offset!==-1&&o.offset===r&&(this.valueBlock.value=[o.result])}}catch{}}return super.fromBER(e,t,r)}onAsciiEncoding(){if(this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length)return Vt.prototype.onAsciiEncoding.call(this);const e=this.constructor.NAME,t=Q.ToHex(this.valueBlock.valueHexView);return`${e} : ${t}`}getValue(){if(!this.idBlock.isConstructed)return this.valueBlock.valueHexView.slice().buffer;const e=[];for(const t of this.valueBlock.value)t instanceof wp&&e.push(t.valueBlock.valueHexView);return L.concat(e)}};wp=$t;z.OctetString=wp;$t.NAME=wy;class Oy extends pn(ei){constructor({unusedBits:e=0,isConstructed:t=!1,...r}={}){super(r),this.unusedBits=e,this.isConstructed=t,this.blockLength=this.valueHexView.byteLength}fromBER(e,t,r){if(!r)return t;let i=-1;if(this.isConstructed){if(i=ei.prototype.fromBER.call(this,e,t,r),i===-1)return i;for(const a of this.value){const c=a.constructor.NAME;if(c===Va){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, BIT STRING may consists of BIT STRINGs only",-1}if(c!==vy)return this.error="BIT STRING may consists of BIT STRINGs only",-1;const l=a.valueBlock;if(this.unusedBits>0&&l.unusedBits>0)return this.error='Using of "unused bits" inside constructive BIT STRING allowed for least one only',-1;this.unusedBits=l.unusedBits}return i}const s=L.toUint8Array(e);if(!On(this,s,t,r))return-1;const o=s.subarray(t,t+r);if(this.unusedBits=o[0],this.unusedBits>7)return this.error="Unused bits for BitString must be in range 0-7",-1;if(!this.unusedBits){const a=o.subarray(1);try{if(a.byteLength){const c=lo(a,0,a.byteLength);c.offset!==-1&&c.offset===r-1&&(this.value=[c.result])}}catch{}}return this.valueHexView=o.subarray(1),this.blockLength=o.length,t+r}toBER(e,t){if(this.isConstructed)return ei.prototype.toBER.call(this,e,t);if(e)return new ArrayBuffer(this.valueHexView.byteLength+1);if(!this.valueHexView.byteLength)return Gr;const r=new Uint8Array(this.valueHexView.length+1);return r[0]=this.unusedBits,r.set(this.valueHexView,1),r.buffer}toJSON(){return{...super.toJSON(),unusedBits:this.unusedBits,isConstructed:this.isConstructed}}}Oy.NAME="BitStringValueBlock";var Ny;let Ni=class extends At{constructor({idBlock:e={},lenBlock:t={},...r}={}){var i,s;(i=r.isConstructed)!==null&&i!==void 0||(r.isConstructed=!!(!((s=r.value)===null||s===void 0)&&s.length)),super({idBlock:{isConstructed:r.isConstructed,...e},lenBlock:{...t,isIndefiniteForm:!!r.isIndefiniteForm},...r},Oy),this.idBlock.tagClass=1,this.idBlock.tagNumber=3}fromBER(e,t,r){return this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,super.fromBER(e,t,r)}onAsciiEncoding(){if(this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length)return Vt.prototype.onAsciiEncoding.call(this);{const e=[],t=this.valueBlock.valueHexView;for(const o of t)e.push(o.toString(2).padStart(8,"0"));const r=e.join(""),i=this.constructor.NAME,s=r.substring(0,r.length-this.valueBlock.unusedBits);return`${i} : ${s}`}}};Ny=Ni;z.BitString=Ny;Ni.NAME=vy;var Dy;function Qk(n,e){const t=new Uint8Array([0]),r=new Uint8Array(n),i=new Uint8Array(e);let s=r.slice(0);const o=s.length-1,a=i.slice(0),c=a.length-1;let l=0;const u=c<o?o:c;let d=0;for(let h=u;h>=0;h--,d++){switch(!0){case d<a.length:l=s[o-d]+a[c-d]+t[0];break;default:l=s[o-d]+t[0]}switch(t[0]=l/10,!0){case d>=s.length:s=U1(new Uint8Array([l%10]),s);break;default:s[o-d]=l%10}}return t[0]>0&&(s=U1(t,s)),s}function i3(n){if(n>=Co.length)for(let e=Co.length;e<=n;e++){const t=new Uint8Array([0]);let r=Co[e-1].slice(0);for(let i=r.length-1;i>=0;i--){const s=new Uint8Array([(r[i]<<1)+t[0]]);t[0]=s[0]/10,r[i]=s[0]%10}t[0]>0&&(r=U1(t,r)),Co.push(r)}return Co[n]}function Yk(n,e){let t=0;const r=new Uint8Array(n),i=new Uint8Array(e),s=r.slice(0),o=s.length-1,a=i.slice(0),c=a.length-1;let l,u=0;for(let d=c;d>=0;d--,u++)switch(l=s[o-u]-a[c-u]-t,!0){case l<0:t=1,s[o-u]=l+10;break;default:t=0,s[o-u]=l}if(t>0)for(let d=o-c+1;d>=0;d--,u++)if(l=s[o-u]-t,l<0)t=1,s[o-u]=l+10;else{t=0,s[o-u]=l;break}return s.slice()}class vp extends pn(Kt){setValueHex(){this.valueHexView.length>=4?(this.warnings.push("Too big Integer for decoding, hex only"),this.isHexOnly=!0,this._valueDec=0):(this.isHexOnly=!1,this.valueHexView.length>0&&(this._valueDec=yy.call(this)))}constructor({value:e,...t}={}){super(t),this._valueDec=0,t.valueHex&&this.setValueHex(),e!==void 0&&(this.valueDec=e)}set valueDec(e){this._valueDec=e,this.isHexOnly=!1,this.valueHexView=new Uint8Array(Mk(e))}get valueDec(){return this._valueDec}fromDER(e,t,r,i=0){const s=this.fromBER(e,t,r);if(s===-1)return s;const o=this.valueHexView;return o[0]===0&&(o[1]&128)!==0?this.valueHexView=o.subarray(1):i!==0&&o.length<i&&(i-o.length>1&&(i=o.length+1),this.valueHexView=o.subarray(i-o.length)),s}toDER(e=!1){const t=this.valueHexView;switch(!0){case(t[0]&128)!==0:{const r=new Uint8Array(this.valueHexView.length+1);r[0]=0,r.set(t,1),this.valueHexView=r}break;case(t[0]===0&&(t[1]&128)===0):this.valueHexView=this.valueHexView.subarray(1);break}return this.toBER(e)}fromBER(e,t,r){const i=super.fromBER(e,t,r);return i===-1||this.setValueHex(),i}toBER(e){return e?new ArrayBuffer(this.valueHexView.length):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}toString(){const e=this.valueHexView.length*8-1;let t=new Uint8Array(this.valueHexView.length*8/3),r=0,i;const s=this.valueHexView;let o="",a=!1;for(let c=s.byteLength-1;c>=0;c--){i=s[c];for(let l=0;l<8;l++){if((i&1)===1)switch(r){case e:t=Yk(i3(r),t),o="-";break;default:t=Qk(t,i3(r))}r++,i>>=1}}for(let c=0;c<t.length;c++)t[c]&&(a=!0),a&&(o+=r3.charAt(t[c]));return a===!1&&(o+=r3.charAt(0)),o}}Dy=vp;vp.NAME="IntegerValueBlock";Object.defineProperty(Dy.prototype,"valueHex",{set:function(n){this.valueHexView=new Uint8Array(n),this.setValueHex()},get:function(){return this.valueHexView.slice().buffer}});var la;class Ar extends At{constructor(e={}){super(e,vp),this.idBlock.tagClass=1,this.idBlock.tagNumber=2}toBigInt(){return ql(),BigInt(this.valueBlock.toString())}static fromBigInt(e){ql();const t=BigInt(e),r=new ld,i=t.toString(16).replace(/^-/,""),s=new Uint8Array(Q.FromHex(i));if(t<0){const a=new Uint8Array(s.length+(s[0]&128?1:0));a[0]|=128;const l=BigInt(`0x${Q.ToHex(a)}`)+t,u=L.toUint8Array(Q.FromHex(l.toString(16)));u[0]|=128,r.write(u)}else s[0]&128&&r.write(new Uint8Array([0])),r.write(s);return new la({valueHex:r.final()})}convertToDER(){const e=new la({valueHex:this.valueBlock.valueHexView});return e.valueBlock.toDER(),e}convertFromDER(){return new la({valueHex:this.valueBlock.valueHexView[0]===0?this.valueBlock.valueHexView.subarray(1):this.valueBlock.valueHexView})}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()}`}}la=Ar;z.Integer=la;Ar.NAME="INTEGER";var Ly;class hd extends Ar{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=10}}Ly=hd;z.Enumerated=Ly;hd.NAME="ENUMERATED";class $1 extends pn(Kt){constructor({valueDec:e=-1,isFirstSid:t=!1,...r}={}){super(r),this.valueDec=e,this.isFirstSid=t}fromBER(e,t,r){if(!r)return t;const i=L.toUint8Array(e);if(!On(this,i,t,r))return-1;const s=i.subarray(t,t+r);this.valueHexView=new Uint8Array(r);for(let a=0;a<r&&(this.valueHexView[a]=s[a]&127,this.blockLength++,(s[a]&128)!==0);a++);const o=new Uint8Array(this.blockLength);for(let a=0;a<this.blockLength;a++)o[a]=this.valueHexView[a];return this.valueHexView=o,(s[this.blockLength-1]&128)!==0?(this.error="End of input reached before message was fully decoded",-1):(this.valueHexView[0]===0&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=Fs(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),t+this.blockLength)}set valueBigInt(e){ql();let t=BigInt(e).toString(2);for(;t.length%7;)t="0"+t;const r=new Uint8Array(t.length/7);for(let i=0;i<r.length;i++)r[i]=parseInt(t.slice(i*7,i*7+7),2)+(i+1<r.length?128:0);this.fromBER(r.buffer,0,r.length)}toBER(e){if(this.isHexOnly){if(e)return new ArrayBuffer(this.valueHexView.byteLength);const i=this.valueHexView,s=new Uint8Array(this.blockLength);for(let o=0;o<this.blockLength-1;o++)s[o]=i[o]|128;return s[this.blockLength-1]=i[this.blockLength-1],s.buffer}const t=$i(this.valueDec,7);if(t.byteLength===0)return this.error="Error during encoding SID value",Gr;const r=new Uint8Array(t.byteLength);if(!e){const i=new Uint8Array(t),s=t.byteLength-1;for(let o=0;o<s;o++)r[o]=i[o]|128;r[s]=i[s]}return r}toString(){let e="";if(this.isHexOnly)e=Q.ToHex(this.valueHexView);else if(this.isFirstSid){let t=this.valueDec;this.valueDec<=39?e="0.":this.valueDec<=79?(e="1.",t-=40):(e="2.",t-=80),e+=t.toString()}else e=this.valueDec.toString();return e}toJSON(){return{...super.toJSON(),valueDec:this.valueDec,isFirstSid:this.isFirstSid}}}$1.NAME="sidBlock";class By extends Kt{constructor({value:e=Yt,...t}={}){super(t),this.value=[],e&&this.fromString(e)}fromBER(e,t,r){let i=t;for(;r>0;){const s=new $1;if(i=s.fromBER(e,i,r),i===-1)return this.blockLength=0,this.error=s.error,i;this.value.length===0&&(s.isFirstSid=!0),this.blockLength+=s.blockLength,r-=s.blockLength,this.value.push(s)}return i}toBER(e){const t=[];for(let r=0;r<this.value.length;r++){const i=this.value[r].toBER(e);if(i.byteLength===0)return this.error=this.value[r].error,Gr;t.push(i)}return gp(t)}fromString(e){this.value=[];let t=0,r=0,i="",s=!1;do if(r=e.indexOf(".",t),r===-1?i=e.substring(t):i=e.substring(t,r),t=r+1,s){const o=this.value[0];let a=0;switch(o.valueDec){case 0:break;case 1:a=40;break;case 2:a=80;break;default:this.value=[];return}const c=parseInt(i,10);if(isNaN(c))return;o.valueDec=c+a,s=!1}else{const o=new $1;if(i>Number.MAX_SAFE_INTEGER){ql();const a=BigInt(i);o.valueBigInt=a}else if(o.valueDec=parseInt(i,10),isNaN(o.valueDec))return;this.value.length||(o.isFirstSid=!0,s=!0),this.value.push(o)}while(r!==-1)}toString(){let e="",t=!1;for(let r=0;r<this.value.length;r++){t=this.value[r].isHexOnly;let i=this.value[r].toString();r!==0&&(e=`${e}.`),t?(i=`{${i}}`,this.value[r].isFirstSid?e=`2.{${i} - 80}`:e+=i):e+=i}return e}toJSON(){const e={...super.toJSON(),value:this.toString(),sidArray:[]};for(let t=0;t<this.value.length;t++)e.sidArray.push(this.value[t].toJSON());return e}}By.NAME="ObjectIdentifierValueBlock";var My;class Zt extends At{getValue(){return this.valueBlock.toString()}setValue(e){this.valueBlock.fromString(e)}constructor(e={}){super(e,By),this.idBlock.tagClass=1,this.idBlock.tagNumber=6}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}}My=Zt;z.ObjectIdentifier=My;Zt.NAME="OBJECT IDENTIFIER";class V1 extends pn(ss){constructor({valueDec:e=0,...t}={}){super(t),this.valueDec=e}fromBER(e,t,r){if(r===0)return t;const i=L.toUint8Array(e);if(!On(this,i,t,r))return-1;const s=i.subarray(t,t+r);this.valueHexView=new Uint8Array(r);for(let a=0;a<r&&(this.valueHexView[a]=s[a]&127,this.blockLength++,(s[a]&128)!==0);a++);const o=new Uint8Array(this.blockLength);for(let a=0;a<this.blockLength;a++)o[a]=this.valueHexView[a];return this.valueHexView=o,(s[this.blockLength-1]&128)!==0?(this.error="End of input reached before message was fully decoded",-1):(this.valueHexView[0]===0&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=Fs(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),t+this.blockLength)}toBER(e){if(this.isHexOnly){if(e)return new ArrayBuffer(this.valueHexView.byteLength);const i=this.valueHexView,s=new Uint8Array(this.blockLength);for(let o=0;o<this.blockLength-1;o++)s[o]=i[o]|128;return s[this.blockLength-1]=i[this.blockLength-1],s.buffer}const t=$i(this.valueDec,7);if(t.byteLength===0)return this.error="Error during encoding SID value",Gr;const r=new Uint8Array(t.byteLength);if(!e){const i=new Uint8Array(t),s=t.byteLength-1;for(let o=0;o<s;o++)r[o]=i[o]|128;r[s]=i[s]}return r.buffer}toString(){let e="";return this.isHexOnly?e=Q.ToHex(this.valueHexView):e=this.valueDec.toString(),e}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}}V1.NAME="relativeSidBlock";class Fy extends Kt{constructor({value:e=Yt,...t}={}){super(t),this.value=[],e&&this.fromString(e)}fromBER(e,t,r){let i=t;for(;r>0;){const s=new V1;if(i=s.fromBER(e,i,r),i===-1)return this.blockLength=0,this.error=s.error,i;this.blockLength+=s.blockLength,r-=s.blockLength,this.value.push(s)}return i}toBER(e,t){const r=[];for(let i=0;i<this.value.length;i++){const s=this.value[i].toBER(e);if(s.byteLength===0)return this.error=this.value[i].error,Gr;r.push(s)}return gp(r)}fromString(e){this.value=[];let t=0,r=0,i="";do{r=e.indexOf(".",t),r===-1?i=e.substring(t):i=e.substring(t,r),t=r+1;const s=new V1;if(s.valueDec=parseInt(i,10),isNaN(s.valueDec))return!0;this.value.push(s)}while(r!==-1);return!0}toString(){let e="",t=!1;for(let r=0;r<this.value.length;r++){t=this.value[r].isHexOnly;let i=this.value[r].toString();r!==0&&(e=`${e}.`),t&&(i=`{${i}}`),e+=i}return e}toJSON(){const e={...super.toJSON(),value:this.toString(),sidArray:[]};for(let t=0;t<this.value.length;t++)e.sidArray.push(this.value[t].toJSON());return e}}Fy.NAME="RelativeObjectIdentifierValueBlock";var Uy;class bp extends At{getValue(){return this.valueBlock.toString()}setValue(e){this.valueBlock.fromString(e)}constructor(e={}){super(e,Fy),this.idBlock.tagClass=1,this.idBlock.tagNumber=13}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}}Uy=bp;z.RelativeObjectIdentifier=Uy;bp.NAME="RelativeObjectIdentifier";var $y;class De extends Vt{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=16}}$y=De;z.Sequence=$y;De.NAME="SEQUENCE";var Vy;let on=class extends Vt{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=17}};Vy=on;z.Set=Vy;on.NAME="SET";class qy extends pn(Kt){constructor({...e}={}){super(e),this.isHexOnly=!0,this.value=Yt}toJSON(){return{...super.toJSON(),value:this.value}}}qy.NAME="StringValueBlock";class Hy extends qy{}Hy.NAME="SimpleStringValueBlock";class yr extends mp{constructor({...e}={}){super(e,Hy)}fromBuffer(e){this.valueBlock.value=String.fromCharCode.apply(null,L.toUint8Array(e))}fromString(e){const t=e.length,r=this.valueBlock.valueHexView=new Uint8Array(t);for(let i=0;i<t;i++)r[i]=e.charCodeAt(i);this.valueBlock.value=e}}yr.NAME="SIMPLE STRING";class zy extends yr{fromBuffer(e){this.valueBlock.valueHexView=L.toUint8Array(e);try{this.valueBlock.value=Q.ToUtf8String(e)}catch(t){this.warnings.push(`Error during "decodeURIComponent": ${t}, using raw string`),this.valueBlock.value=Q.ToBinary(e)}}fromString(e){this.valueBlock.valueHexView=new Uint8Array(Q.FromUtf8String(e)),this.valueBlock.value=e}}zy.NAME="Utf8StringValueBlock";var Ky;class Nn extends zy{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=12}}Ky=Nn;z.Utf8String=Ky;Nn.NAME="UTF8String";class Wy extends yr{fromBuffer(e){this.valueBlock.value=Q.ToUtf16String(e),this.valueBlock.valueHexView=L.toUint8Array(e)}fromString(e){this.valueBlock.value=e,this.valueBlock.valueHexView=new Uint8Array(Q.FromUtf16String(e))}}Wy.NAME="BmpStringValueBlock";var Gy;class fd extends Wy{constructor({...e}={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=30}}Gy=fd;z.BmpString=Gy;fd.NAME="BMPString";class jy extends yr{fromBuffer(e){const t=ArrayBuffer.isView(e)?e.slice().buffer:e.slice(0),r=new Uint8Array(t);for(let i=0;i<r.length;i+=4)r[i]=r[i+3],r[i+1]=r[i+2],r[i+2]=0,r[i+3]=0;this.valueBlock.value=String.fromCharCode.apply(null,new Uint32Array(t))}fromString(e){const t=e.length,r=this.valueBlock.valueHexView=new Uint8Array(t*4);for(let i=0;i<t;i++){const s=$i(e.charCodeAt(i),8),o=new Uint8Array(s);if(o.length>4)continue;const a=4-o.length;for(let c=o.length-1;c>=0;c--)r[i*4+c+a]=o[c]}this.valueBlock.value=e}}jy.NAME="UniversalStringValueBlock";var Qy;class pd extends jy{constructor({...e}={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=28}}Qy=pd;z.UniversalString=Qy;pd.NAME="UniversalString";var Yy;class gd extends yr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=18}}Yy=gd;z.NumericString=Yy;gd.NAME="NumericString";var Xy;class md extends yr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=19}}Xy=md;z.PrintableString=Xy;md.NAME="PrintableString";var Zy;class yd extends yr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=20}}Zy=yd;z.TeletexString=Zy;yd.NAME="TeletexString";var Jy;class wd extends yr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=21}}Jy=wd;z.VideotexString=Jy;wd.NAME="VideotexString";var e8;class vd extends yr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=22}}e8=vd;z.IA5String=e8;vd.NAME="IA5String";var t8;class bd extends yr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=25}}t8=bd;z.GraphicString=t8;bd.NAME="GraphicString";var r8;class uc extends yr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=26}}r8=uc;z.VisibleString=r8;uc.NAME="VisibleString";var n8;class Ed extends yr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=27}}n8=Ed;z.GeneralString=n8;Ed.NAME="GeneralString";var i8;class Sd extends yr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=29}}i8=Sd;z.CharacterString=i8;Sd.NAME="CharacterString";var s8;class dc extends uc{constructor({value:e,valueDate:t,...r}={}){if(super(r),this.year=0,this.month=0,this.day=0,this.hour=0,this.minute=0,this.second=0,e){this.fromString(e),this.valueBlock.valueHexView=new Uint8Array(e.length);for(let i=0;i<e.length;i++)this.valueBlock.valueHexView[i]=e.charCodeAt(i)}t&&(this.fromDate(t),this.valueBlock.valueHexView=new Uint8Array(this.toBuffer())),this.idBlock.tagClass=1,this.idBlock.tagNumber=23}fromBuffer(e){this.fromString(String.fromCharCode.apply(null,L.toUint8Array(e)))}toBuffer(){const e=this.toString(),t=new ArrayBuffer(e.length),r=new Uint8Array(t);for(let i=0;i<e.length;i++)r[i]=e.charCodeAt(i);return t}fromDate(e){this.year=e.getUTCFullYear(),this.month=e.getUTCMonth()+1,this.day=e.getUTCDate(),this.hour=e.getUTCHours(),this.minute=e.getUTCMinutes(),this.second=e.getUTCSeconds()}toDate(){return new Date(Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second))}fromString(e){const r=/(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})Z/ig.exec(e);if(r===null){this.error="Wrong input string for conversion";return}const i=parseInt(r[1],10);i>=50?this.year=1900+i:this.year=2e3+i,this.month=parseInt(r[2],10),this.day=parseInt(r[3],10),this.hour=parseInt(r[4],10),this.minute=parseInt(r[5],10),this.second=parseInt(r[6],10)}toString(e="iso"){if(e==="iso"){const t=new Array(7);return t[0]=lr(this.year<2e3?this.year-1900:this.year-2e3,2),t[1]=lr(this.month,2),t[2]=lr(this.day,2),t[3]=lr(this.hour,2),t[4]=lr(this.minute,2),t[5]=lr(this.second,2),t[6]="Z",t.join("")}return super.toString(e)}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.toDate().toISOString()}`}toJSON(){return{...super.toJSON(),year:this.year,month:this.month,day:this.day,hour:this.hour,minute:this.minute,second:this.second}}}s8=dc;z.UTCTime=s8;dc.NAME="UTCTime";var o8;class xd extends dc{constructor(e={}){var t;super(e),(t=this.millisecond)!==null&&t!==void 0||(this.millisecond=0),this.idBlock.tagClass=1,this.idBlock.tagNumber=24}fromDate(e){super.fromDate(e),this.millisecond=e.getUTCMilliseconds()}toDate(){const e=Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second,this.millisecond);return new Date(e)}fromString(e){let t=!1,r="",i="",s=0,o,a=0,c=0;if(e[e.length-1]==="Z")r=e.substring(0,e.length-1),t=!0;else{const d=new Number(e[e.length-1]);if(isNaN(d.valueOf()))throw new Error("Wrong input string for conversion");r=e}if(t){if(r.indexOf("+")!==-1)throw new Error("Wrong input string for conversion");if(r.indexOf("-")!==-1)throw new Error("Wrong input string for conversion")}else{let d=1,h=r.indexOf("+"),f="";if(h===-1&&(h=r.indexOf("-"),d=-1),h!==-1){if(f=r.substring(h+1),r=r.substring(0,h),f.length!==2&&f.length!==4)throw new Error("Wrong input string for conversion");let m=parseInt(f.substring(0,2),10);if(isNaN(m.valueOf()))throw new Error("Wrong input string for conversion");if(a=d*m,f.length===4){if(m=parseInt(f.substring(2,4),10),isNaN(m.valueOf()))throw new Error("Wrong input string for conversion");c=d*m}}}let l=r.indexOf(".");if(l===-1&&(l=r.indexOf(",")),l!==-1){const d=new Number(`0${r.substring(l)}`);if(isNaN(d.valueOf()))throw new Error("Wrong input string for conversion");s=d.valueOf(),i=r.substring(0,l)}else i=r;switch(!0){case i.length===8:if(o=/(\d{4})(\d{2})(\d{2})/ig,l!==-1)throw new Error("Wrong input string for conversion");break;case i.length===10:if(o=/(\d{4})(\d{2})(\d{2})(\d{2})/ig,l!==-1){let d=60*s;this.minute=Math.floor(d),d=60*(d-this.minute),this.second=Math.floor(d),d=1e3*(d-this.second),this.millisecond=Math.floor(d)}break;case i.length===12:if(o=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})/ig,l!==-1){let d=60*s;this.second=Math.floor(d),d=1e3*(d-this.second),this.millisecond=Math.floor(d)}break;case i.length===14:if(o=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/ig,l!==-1){const d=1e3*s;this.millisecond=Math.floor(d)}break;default:throw new Error("Wrong input string for conversion")}const u=o.exec(i);if(u===null)throw new Error("Wrong input string for conversion");for(let d=1;d<u.length;d++)switch(d){case 1:this.year=parseInt(u[d],10);break;case 2:this.month=parseInt(u[d],10);break;case 3:this.day=parseInt(u[d],10);break;case 4:this.hour=parseInt(u[d],10)+a;break;case 5:this.minute=parseInt(u[d],10)+c;break;case 6:this.second=parseInt(u[d],10);break;default:throw new Error("Wrong input string for conversion")}if(t===!1){const d=new Date(this.year,this.month,this.day,this.hour,this.minute,this.second,this.millisecond);this.year=d.getUTCFullYear(),this.month=d.getUTCMonth(),this.day=d.getUTCDay(),this.hour=d.getUTCHours(),this.minute=d.getUTCMinutes(),this.second=d.getUTCSeconds(),this.millisecond=d.getUTCMilliseconds()}}toString(e="iso"){if(e==="iso"){const t=[];return t.push(lr(this.year,4)),t.push(lr(this.month,2)),t.push(lr(this.day,2)),t.push(lr(this.hour,2)),t.push(lr(this.minute,2)),t.push(lr(this.second,2)),this.millisecond!==0&&(t.push("."),t.push(lr(this.millisecond,3))),t.push("Z"),t.join("")}return super.toString(e)}toJSON(){return{...super.toJSON(),millisecond:this.millisecond}}}o8=xd;z.GeneralizedTime=o8;xd.NAME="GeneralizedTime";var a8;class Ep extends Nn{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=31}}a8=Ep;z.DATE=a8;Ep.NAME="DATE";var c8;class Sp extends Nn{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=32}}c8=Sp;z.TimeOfDay=c8;Sp.NAME="TimeOfDay";var l8;class xp extends Nn{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=33}}l8=xp;z.DateTime=l8;xp.NAME="DateTime";var u8;class Ap extends Nn{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=34}}u8=Ap;z.Duration=u8;Ap.NAME="Duration";var d8;class kp extends Nn{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=14}}d8=kp;z.TIME=d8;kp.NAME="TIME";class Vi{constructor({name:e=Yt,optional:t=!1}={}){this.name=e,this.optional=t}}class _p extends Vi{constructor({value:e=[],...t}={}){super(t),this.value=e}}class Hl extends Vi{constructor({value:e=new Vi,local:t=!1,...r}={}){super(r),this.value=e,this.local=t}}class Xk{get data(){return this.dataView.slice().buffer}set data(e){this.dataView=L.toUint8Array(e)}constructor({data:e=ud}={}){this.dataView=L.toUint8Array(e)}fromBER(e,t,r){const i=t+r;return this.dataView=L.toUint8Array(e).subarray(t,i),i}toBER(e){return this.dataView.slice().buffer}}function Wn(n,e,t){if(t instanceof _p){for(const s of t.value)if(Wn(n,e,s).verified)return{verified:!0,result:n};{const s={verified:!1,result:{error:"Wrong values for Choice type"}};return t.hasOwnProperty(Hh)&&(s.name=t.name),s}}if(t instanceof Vi)return t.hasOwnProperty(Hh)&&(n[t.name]=e),{verified:!0,result:n};if(!(n instanceof Object))return{verified:!1,result:{error:"Wrong root object"}};if(!(e instanceof Object))return{verified:!1,result:{error:"Wrong ASN.1 data"}};if(!(t instanceof Object))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(!($k in t))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(!(zk in t.idBlock))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(!(Kk in t.idBlock))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};const r=t.idBlock.toBER(!1);if(r.byteLength===0)return{verified:!1,result:{error:"Error encoding idBlock for ASN.1 schema"}};if(t.idBlock.fromBER(r,0,r.byteLength)===-1)return{verified:!1,result:{error:"Error decoding idBlock for ASN.1 schema"}};if(t.idBlock.hasOwnProperty(Vk)===!1)return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(t.idBlock.tagClass!==e.idBlock.tagClass)return{verified:!1,result:n};if(t.idBlock.hasOwnProperty(qk)===!1)return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(t.idBlock.tagNumber!==e.idBlock.tagNumber)return{verified:!1,result:n};if(t.idBlock.hasOwnProperty(Hk)===!1)return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(t.idBlock.isConstructed!==e.idBlock.isConstructed)return{verified:!1,result:n};if(!(Uk in t.idBlock))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(t.idBlock.isHexOnly!==e.idBlock.isHexOnly)return{verified:!1,result:n};if(t.idBlock.isHexOnly){if(!(n3 in t.idBlock))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};const s=t.idBlock.valueHexView,o=e.idBlock.valueHexView;if(s.length!==o.length)return{verified:!1,result:n};for(let a=0;a<s.length;a++)if(s[a]!==o[1])return{verified:!1,result:n}}if(t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,Yt),t.name&&(n[t.name]=e)),t instanceof z.Constructed){let s=0,o={verified:!1,result:{error:"Unknown error"}},a=t.valueBlock.value.length;if(a>0&&t.valueBlock.value[0]instanceof Hl&&(a=e.valueBlock.value.length),a===0)return{verified:!0,result:n};if(e.valueBlock.value.length===0&&t.valueBlock.value.length!==0){let c=!0;for(let l=0;l<t.valueBlock.value.length;l++)c=c&&(t.valueBlock.value[l].optional||!1);return c?{verified:!0,result:n}:(t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,Yt),t.name&&delete n[t.name]),n.error="Inconsistent object length",{verified:!1,result:n})}for(let c=0;c<a;c++)if(c-s>=e.valueBlock.value.length){if(t.valueBlock.value[c].optional===!1){const l={verified:!1,result:n};return n.error="Inconsistent length between ASN.1 data and schema",t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,Yt),t.name&&(delete n[t.name],l.name=t.name)),l}}else if(t.valueBlock.value[0]instanceof Hl){if(o=Wn(n,e.valueBlock.value[c],t.valueBlock.value[0].value),o.verified===!1)if(t.valueBlock.value[0].optional)s++;else return t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,Yt),t.name&&delete n[t.name]),o;if(Hh in t.valueBlock.value[0]&&t.valueBlock.value[0].name.length>0){let l={};Wk in t.valueBlock.value[0]&&t.valueBlock.value[0].local?l=e:l=n,typeof l[t.valueBlock.value[0].name]>"u"&&(l[t.valueBlock.value[0].name]=[]),l[t.valueBlock.value[0].name].push(e.valueBlock.value[c])}}else if(o=Wn(n,e.valueBlock.value[c-s],t.valueBlock.value[c]),o.verified===!1)if(t.valueBlock.value[c].optional)s++;else return t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,Yt),t.name&&delete n[t.name]),o;if(o.verified===!1){const c={verified:!1,result:n};return t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,Yt),t.name&&(delete n[t.name],c.name=t.name)),c}return{verified:!0,result:n}}if(t.primitiveSchema&&n3 in e.valueBlock){const s=lo(e.valueBlock.valueHexView);if(s.offset===-1){const o={verified:!1,result:s.result};return t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,Yt),t.name&&(delete n[t.name],o.name=t.name)),o}return Wn(n,s.result,t.primitiveSchema)}return{verified:!0,result:n}}function Zk(n,e){if(!(e instanceof Object))return{verified:!1,result:{error:"Wrong ASN.1 schema type"}};const t=lo(L.toUint8Array(n));return t.offset===-1?{verified:!1,result:t.result}:Wn(t.result,t.result,e)}const h8=Object.freeze(Object.defineProperty({__proto__:null,Any:Vi,BaseBlock:At,BaseStringBlock:mp,BitString:Ni,BmpString:fd,Boolean:dd,CharacterString:Sd,Choice:_p,Constructed:Vt,DATE:Ep,DateTime:xp,Duration:Ap,EndOfContent:yp,Enumerated:hd,GeneralString:Ed,GeneralizedTime:xd,GraphicString:bd,HexBlock:pn,IA5String:vd,Integer:Ar,Null:zr,NumericString:gd,ObjectIdentifier:Zt,OctetString:$t,Primitive:lc,PrintableString:md,RawData:Xk,RelativeObjectIdentifier:bp,Repeated:Hl,Sequence:De,Set:on,TIME:kp,TeletexString:yd,TimeOfDay:Sp,UTCTime:dc,UniversalString:pd,Utf8String:Nn,ValueBlock:Kt,VideotexString:wd,ViewWriter:ld,VisibleString:uc,compareSchema:Wn,fromBER:xr,verifySchema:Zk},Symbol.toStringTag,{value:"Module"})),Jk=16,q1=32,H1=1e4;async function Ad(n,e){const r=await cd().encrypt(n,e);return Fr.encode(r)}async function s3(n,e,t){if(n.type==="RSA")return n_(n,e,t);if(n.type==="Ed25519")return e_(n,e,t);if(n.type==="secp256k1")return t_(n,e,t);if(n.type==="ECDSA")return r_(n,e,t);throw new Fw}async function e_(n,e,t="libp2p-key"){if(t==="libp2p-key")return Ad(dn(n),e);throw new Ne(`export format '${t}' is not supported`)}async function t_(n,e,t="libp2p-key"){if(t==="libp2p-key")return Ad(dn(n),e);throw new Ne("Export format is not supported")}async function r_(n,e,t="libp2p-key"){if(t==="libp2p-key")return Ad(dn(n),e);throw new Ne(`export format '${t}' is not supported`)}async function n_(n,e,t="pkcs-8"){if(t==="pkcs-8")return i_(n,e);if(t==="libp2p-key")return Ad(dn(n),e);throw new Ne("Export format is not supported")}async function i_(n,e){const t=ac.get(),i=new De({value:[new Ar({value:0}),new De({value:[new Zt({value:"1.2.840.113549.1.1.1"}),new zr]}),new $t({valueHex:n.raw})]}).toBER(),s=new Uint8Array(i,0,i.byteLength),o=an(Jk),a=await H5(V0,e,o,{c:H1,dkLen:q1}),c=an(16),l=await t.subtle.importKey("raw",a,"AES-CBC",!1,["encrypt"]),u=await t.subtle.encrypt({name:"AES-CBC",iv:c},l,s),d=new De({value:[new $t({valueHex:o}),new Ar({value:H1}),new Ar({value:q1}),new De({value:[new Zt({value:"1.2.840.113549.2.11"}),new zr]})]}),h=new De({value:[new Zt({value:"1.2.840.113549.1.5.13"}),new De({value:[new De({value:[new Zt({value:"1.2.840.113549.1.5.12"}),d]}),new De({value:[new Zt({value:"2.16.840.1.101.3.4.1.42"}),new $t({valueHex:c})]})]})]}),m=new De({value:[h,new $t({valueHex:u})]}).toBER(),y=new Uint8Array(m,0,m.byteLength);return["-----BEGIN ENCRYPTED PRIVATE KEY-----",...ee(y,"base64pad").split(/(.{64})/).filter(Boolean),"-----END ENCRYPTED PRIVATE KEY-----"].join(`
`)}async function o3(n,e){try{const t=await s_(n,e);return S5(t)}catch{}if(!n.includes("BEGIN"))throw new Ne("Encrypted key was not a libp2p-key or a PEM file");return o_(n,e)}async function s_(n,e){const t=Fr.decode(n);return cd().decrypt(t,e)}async function o_(n,e){const t=ac.get();let r;if(n.includes("-----BEGIN ENCRYPTED PRIVATE KEY-----")){const s=C(n.replace("-----BEGIN ENCRYPTED PRIVATE KEY-----","").replace("-----END ENCRYPTED PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:o}=xr(s),{iv:a,salt:c,iterations:l,keySize:u,cipherText:d}=a_(o),h=await H5(V0,e,c,{c:l,dkLen:u}),f=await t.subtle.importKey("raw",h,"AES-CBC",!1,["decrypt"]),m=ua(await t.subtle.decrypt({name:"AES-CBC",iv:a},f,d)),{result:y}=xr(m);r=a3(y)}else if(n.includes("-----BEGIN PRIVATE KEY-----")){const s=C(n.replace("-----BEGIN PRIVATE KEY-----","").replace("-----END PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:o}=xr(s);r=a3(o)}else throw new Ne("Could not parse private key from PEM data");const i=x5(r);if(i.type!=="RSA")throw new Ne("Could not parse RSA private key from PEM data");return i}function a_(n){const e=n.valueBlock.value[0];if(e.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.13")throw new Ne("Only pkcs5PBES2 encrypted private keys are supported");const r=e.valueBlock.value[1].valueBlock.value[0];if(r.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.12")throw new Ne("Only pkcs5PBKDF2 key derivation functions are supported");const s=r.valueBlock.value[1],o=ua(s.valueBlock.value[0].getValue());let a=H1,c=q1;if(s.valueBlock.value.length===3)a=Number(s.valueBlock.value[1].toBigInt()),c=Number(s.valueBlock.value[2].toBigInt());else if(s.valueBlock.value.length===2)throw new Ne("Could not derive key size and iterations from PEM file - please use @libp2p/rsa to re-import your key");const l=e.valueBlock.value[1].valueBlock.value[1],u=l.valueBlock.value[0].toString();if(u!=="OBJECT IDENTIFIER : 1.2.840.113549.3.7"){if(u!=="OBJECT IDENTIFIER : 1.3.14.3.2.7"){if(u!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.2"){if(u!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.22"){if(u!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.42")throw new Ne("Only AES-CBC encryption schemes are supported")}}}}const d=ua(l.valueBlock.value[1].getValue());return{cipherText:ua(n.valueBlock.value[1].getValue()),salt:o,iterations:a,keySize:c,iv:d}}function a3(n){return ua(n.valueBlock.value[2].getValue())}function ua(n){return new Uint8Array(n,0,n.byteLength)}const c_="/pkcs8/",z1="/info/",To=new WeakMap,wi={minKeyLength:112/8,minSaltLength:128/8,minIterationCount:1e3};function us(n){return n==null||typeof n!="string"?!1:n===gy(n.trim())&&n.length>0}async function wt(){const t=Math.random()*800+200;await new Promise(r=>setTimeout(r,t))}function vi(n){return new Te(c_+n)}function ds(n){return new Te(z1+n)}async function l_(n){const e=dn(n),t=await gt.digest(e);return Di.encode(t.bytes).substring(1)}let u_=class{components;init;log;self;constructor(e,t){if(this.components=e,this.log=e.logger.forComponent("libp2p:keychain"),this.init={...t,dek:{...e3,...t.dek}},this.self=t.selfKey??"self",this.init.pass!=null&&this.init.pass?.length<20)throw new Error("pass must be least 20 characters");if(this.init.dek?.keyLength!=null&&this.init.dek.keyLength<wi.minKeyLength)throw new Error(`dek.keyLength must be least ${wi.minKeyLength} bytes`);if(this.init.dek?.salt?.length!=null&&this.init.dek.salt.length<wi.minSaltLength)throw new Error(`dek.saltLength must be least ${wi.minSaltLength} bytes`);if(this.init.dek?.iterationCount!=null&&this.init.dek.iterationCount<wi.minIterationCount)throw new Error(`dek.iterationCount must be least ${wi.minIterationCount}`);const r=this.init.pass!=null&&this.init.dek?.salt!=null?_l(this.init.pass,this.init.dek?.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";To.set(this,{dek:r})}[Symbol.toStringTag]="@libp2p/keychain";[kv]=["@libp2p/keychain"];static generateOptions(){const e=Object.assign({},this.options),t=Math.ceil(wi.minSaltLength/3)*3;return e.dek!=null&&(e.dek.salt=ee(an(t),"base64")),e}static get options(){return{dek:{...e3}}}async findKeyByName(e){if(!us(e))throw await wt(),new Ne(`Invalid key name '${e}'`);const t=ds(e);try{const r=await this.components.datastore.get(t);return JSON.parse(ee(r))}catch(r){throw await wt(),this.log.error("could not read key from datastore - %e",r),new Uw(`Key '${e}' does not exist.`)}}async findKeyById(e){try{const t={prefix:z1};for await(const r of this.components.datastore.query(t)){const i=JSON.parse(ee(r.value));if(i.id===e)return i}throw new Ne(`Key with id '${e}' does not exist.`)}catch(t){throw await wt(),t}}async importKey(e,t){if(!us(e))throw await wt(),new Ne(`Invalid key name '${e}'`);if(t==null)throw await wt(),new Ne("Key is required");const r=vi(e);if(await this.components.datastore.has(r))throw await wt(),new Ne(`Key '${e}' already exists`);let s,o;try{s=await l_(t);const l=To.get(this);if(l==null)throw new Ne("dek missing");const u=l.dek;o=await s3(t,u,t.type==="RSA"?"pkcs-8":"libp2p-key")}catch(l){throw await wt(),l}const a={name:e,id:s},c=this.components.datastore.batch();return c.put(r,C(o)),c.put(ds(e),C(JSON.stringify(a))),await c.commit(),a}async exportKey(e){if(!us(e))throw await wt(),new Ne(`Invalid key name '${e}'`);const t=vi(e);try{const r=await this.components.datastore.get(t),i=ee(r),s=To.get(this);if(s==null)throw new Ne("dek missing");const o=s.dek;return await o3(i,o)}catch(r){throw await wt(),r}}async removeKey(e){if(!us(e)||e===this.self)throw await wt(),new Ne(`Invalid key name '${e}'`);const t=vi(e),r=await this.findKeyByName(e),i=this.components.datastore.batch();return i.delete(t),i.delete(ds(e)),await i.commit(),r}async listKeys(){const e={prefix:z1},t=[];for await(const r of this.components.datastore.query(e))t.push(JSON.parse(ee(r.value)));return t}async renameKey(e,t){if(!us(e)||e===this.self)throw await wt(),new Ne(`Invalid old key name '${e}'`);if(!us(t)||t===this.self)throw await wt(),new Ne(`Invalid new key name '${t}'`);const r=vi(e),i=vi(t),s=ds(e),o=ds(t);if(await this.components.datastore.has(i))throw await wt(),new Ne(`Key '${t}' already exists`);try{const c=await this.components.datastore.get(r),l=await this.components.datastore.get(s),u=JSON.parse(ee(l));u.name=t;const d=this.components.datastore.batch();return d.put(i,c),d.put(o,C(JSON.stringify(u))),d.delete(r),d.delete(s),await d.commit(),u}catch(c){throw await wt(),c}}async rotateKeychainPass(e,t){if(typeof e!="string")throw await wt(),new Ne(`Invalid old pass type '${typeof e}'`);if(typeof t!="string")throw await wt(),new Ne(`Invalid new pass type '${typeof t}'`);if(t.length<20)throw await wt(),new Ne(`Invalid pass length ${t.length}`);this.log("recreating keychain");const r=To.get(this);if(r==null)throw new Ne("dek missing");const i=r.dek;this.init.pass=t;const s=t!=null&&this.init.dek?.salt!=null?_l(t,this.init.dek.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";To.set(this,{dek:s});const o=await this.listKeys();for(const a of o){const c=await this.components.datastore.get(vi(a.name)),l=ee(c),u=await o3(l,i),d=s.toString(),h=await s3(u,d,u.type==="RSA"?"pkcs-8":"libp2p-key"),f=this.components.datastore.batch(),m={name:a.name,id:a.id};f.put(vi(a.name),C(h)),f.put(ds(a.name),C(JSON.stringify(m))),await f.commit()}this.log("keychain reconstructed")}};function d_(n={}){return e=>new u_(e,n)}ur.formatters.b=n=>n==null?"undefined":Di.baseEncode(n);ur.formatters.t=n=>n==null?"undefined":xi.baseEncode(n);ur.formatters.m=n=>n==null?"undefined":Fr.baseEncode(n);ur.formatters.p=n=>n==null?"undefined":n.toString();ur.formatters.c=n=>n==null?"undefined":n.toString();ur.formatters.k=n=>n==null?"undefined":n.toString();ur.formatters.a=n=>n==null?"undefined":n.toString();ur.formatters.e=n=>{if(n==null)return"undefined";const e=c3(n.message),t=c3(n.stack);return e!=null&&t!=null?t.includes(e)?t:`${e}
${t}`:t??e??n.toString()};function h_(n){const e=()=>{};return e.enabled=!1,e.color="",e.diff=0,e.log=()=>{},e.namespace=n,e.destroy=()=>!0,e.extend=()=>e,e}function f_(){return{forComponent(n){return f8(n)}}}function f8(n){let e=h_(`${n}:trace`);return ur.enabled(`${n}:trace`)&&ur.names.map(t=>t.toString()).find(t=>t.includes(":trace"))!=null&&(e=ur(`${n}:trace`)),Object.assign(ur(n),{error:ur(`${n}:error`),trace:e,newScope:t=>f8(`${n}:${t}`)})}function c3(n){if(n!=null&&(n=n.trim(),n.length!==0))return n}async function p_(n,e={}){const t=e.selfKey??"self",r=d_(e)({datastore:n,logger:f_()});let i;return await n.has(new Te(`/pkcs8/${t}`))?i=await r.exportKey(t):(i=await j0(e.keyType??"Ed25519"),await r.importKey(t,i)),i}function l3(){const n=we();let e=!1;return{sink:async t=>{if(e)throw new Error("already piped");e=!0,n.resolve(t)},source:(async function*(){yield*await n.promise})()}}function g_(){const n=l3(),e=l3();return[{source:n.source,sink:e.sink},{source:e.source,sink:n.sink}]}var m_={};const qa=65535,u3=qa-16,hc=!!m_?.DUMP_SESSION_KEYS;/*! noble-ciphers - MIT License (c) 2023 Paul Miller (paulmillr.com) */function p8(n){return n instanceof Uint8Array||ArrayBuffer.isView(n)&&n.constructor.name==="Uint8Array"}function K1(n){if(typeof n!="boolean")throw new Error(`boolean expected, not ${n}`)}function zh(n){if(!Number.isSafeInteger(n)||n<0)throw new Error("positive integer expected, got "+n)}function Xt(n,...e){if(!p8(n))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(n.length))throw new Error("Uint8Array expected of length "+e+", got length="+n.length)}function d3(n,e=!0){if(n.destroyed)throw new Error("Hash instance has been destroyed");if(e&&n.finished)throw new Error("Hash#digest() has already been called")}function y_(n,e){Xt(n);const t=e.outputLen;if(n.length<t)throw new Error("digestInto() expects output buffer of length at least "+t)}function ti(n){return new Uint32Array(n.buffer,n.byteOffset,Math.floor(n.byteLength/4))}function Us(...n){for(let e=0;e<n.length;e++)n[e].fill(0)}function w_(n){return new DataView(n.buffer,n.byteOffset,n.byteLength)}const v_=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function b_(n){if(typeof n!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(n))}function W1(n){if(typeof n=="string")n=b_(n);else if(p8(n))n=G1(n);else throw new Error("Uint8Array expected, got "+typeof n);return n}function E_(n,e){if(e==null||typeof e!="object")throw new Error("options must be defined");return Object.assign(n,e)}function S_(n,e){if(n.length!==e.length)return!1;let t=0;for(let r=0;r<n.length;r++)t|=n[r]^e[r];return t===0}const x_=(n,e)=>{function t(r,...i){if(Xt(r),!v_)throw new Error("Non little-endian hardware is not yet supported");if(n.nonceLength!==void 0){const u=i[0];if(!u)throw new Error("nonce / iv required");n.varSizeNonce?Xt(u):Xt(u,n.nonceLength)}const s=n.tagLength;s&&i[1]!==void 0&&Xt(i[1]);const o=e(r,...i),a=(u,d)=>{if(d!==void 0){if(u!==2)throw new Error("cipher output not supported");Xt(d)}};let c=!1;return{encrypt(u,d){if(c)throw new Error("cannot encrypt() twice with same key + nonce");return c=!0,Xt(u),a(o.encrypt.length,d),o.encrypt(u,d)},decrypt(u,d){if(Xt(u),s&&u.length<s)throw new Error("invalid ciphertext length: smaller than tagLength="+s);return a(o.decrypt.length,d),o.decrypt(u,d)}}}return Object.assign(t,n),t};function h3(n,e,t=!0){if(e===void 0)return new Uint8Array(n);if(e.length!==n)throw new Error("invalid output length, expected "+n+", got: "+e.length);if(t&&!k_(e))throw new Error("invalid output, must be aligned");return e}function f3(n,e,t,r){if(typeof n.setBigUint64=="function")return n.setBigUint64(e,t,r);const i=BigInt(32),s=BigInt(4294967295),o=Number(t>>i&s),a=Number(t&s),c=4,l=0;n.setUint32(e+c,o,r),n.setUint32(e+l,a,r)}function A_(n,e,t){K1(t);const r=new Uint8Array(16),i=w_(r);return f3(i,0,BigInt(e),t),f3(i,8,BigInt(n),t),r}function k_(n){return n.byteOffset%4===0}function G1(n){return Uint8Array.from(n)}const g8=n=>Uint8Array.from(n.split("").map(e=>e.charCodeAt(0))),__=g8("expand 16-byte k"),I_=g8("expand 32-byte k"),C_=ti(__),T_=ti(I_);function Ae(n,e){return n<<e|n>>>32-e}function j1(n){return n.byteOffset%4===0}const Kc=64,R_=16,m8=2**32-1,p3=new Uint32Array;function P_(n,e,t,r,i,s,o,a){const c=i.length,l=new Uint8Array(Kc),u=ti(l),d=j1(i)&&j1(s),h=d?ti(i):p3,f=d?ti(s):p3;for(let m=0;m<c;o++){if(n(e,t,r,u,o,a),o>=m8)throw new Error("arx: counter overflow");const y=Math.min(Kc,c-m);if(d&&y===Kc){const w=m/4;if(m%4!==0)throw new Error("arx: invalid block position");for(let E=0,A;E<R_;E++)A=w+E,f[A]=h[A]^u[E];m+=Kc;continue}for(let w=0,E;w<y;w++)E=m+w,s[E]=i[E]^l[w];m+=y}}function O_(n,e){const{allowShortKeys:t,extendNonceFn:r,counterLength:i,counterRight:s,rounds:o}=E_({allowShortKeys:!1,counterLength:8,counterRight:!1,rounds:20},e);if(typeof n!="function")throw new Error("core must be a function");return zh(i),zh(o),K1(s),K1(t),(a,c,l,u,d=0)=>{Xt(a),Xt(c),Xt(l);const h=l.length;if(u===void 0&&(u=new Uint8Array(h)),Xt(u),zh(d),d<0||d>=m8)throw new Error("arx: counter overflow");if(u.length<h)throw new Error(`arx: output (${u.length}) is shorter than data (${h})`);const f=[];let m=a.length,y,w;if(m===32)f.push(y=G1(a)),w=T_;else if(m===16&&t)y=new Uint8Array(32),y.set(a),y.set(a,16),w=C_,f.push(y);else throw new Error(`arx: invalid 32-byte key, got length=${m}`);j1(c)||f.push(c=G1(c));const E=ti(y);if(r){if(c.length!==24)throw new Error("arx: extended nonce must be 24 bytes");r(w,E,ti(c.subarray(0,16)),E),c=c.subarray(16)}const A=16-i;if(A!==c.length)throw new Error(`arx: nonce must be ${A} or 16 bytes`);if(A!==12){const R=new Uint8Array(12);R.set(c,s?0:12-c.length),c=R,f.push(c)}const T=ti(c);return P_(n,w,E,T,l,u,d,o),Us(...f),u}}const vt=(n,e)=>n[e++]&255|(n[e++]&255)<<8;class N_{constructor(e){this.blockLen=16,this.outputLen=16,this.buffer=new Uint8Array(16),this.r=new Uint16Array(10),this.h=new Uint16Array(10),this.pad=new Uint16Array(8),this.pos=0,this.finished=!1,e=W1(e),Xt(e,32);const t=vt(e,0),r=vt(e,2),i=vt(e,4),s=vt(e,6),o=vt(e,8),a=vt(e,10),c=vt(e,12),l=vt(e,14);this.r[0]=t&8191,this.r[1]=(t>>>13|r<<3)&8191,this.r[2]=(r>>>10|i<<6)&7939,this.r[3]=(i>>>7|s<<9)&8191,this.r[4]=(s>>>4|o<<12)&255,this.r[5]=o>>>1&8190,this.r[6]=(o>>>14|a<<2)&8191,this.r[7]=(a>>>11|c<<5)&8065,this.r[8]=(c>>>8|l<<8)&8191,this.r[9]=l>>>5&127;for(let u=0;u<8;u++)this.pad[u]=vt(e,16+2*u)}process(e,t,r=!1){const i=r?0:2048,{h:s,r:o}=this,a=o[0],c=o[1],l=o[2],u=o[3],d=o[4],h=o[5],f=o[6],m=o[7],y=o[8],w=o[9],E=vt(e,t+0),A=vt(e,t+2),T=vt(e,t+4),R=vt(e,t+6),ie=vt(e,t+8),re=vt(e,t+10),j=vt(e,t+12),se=vt(e,t+14);let _=s[0]+(E&8191),M=s[1]+((E>>>13|A<<3)&8191),O=s[2]+((A>>>10|T<<6)&8191),F=s[3]+((T>>>7|R<<9)&8191),U=s[4]+((R>>>4|ie<<12)&8191),X=s[5]+(ie>>>1&8191),te=s[6]+((ie>>>14|re<<2)&8191),G=s[7]+((re>>>11|j<<5)&8191),Z=s[8]+((j>>>8|se<<8)&8191),ce=s[9]+(se>>>5|i),N=0,fe=N+_*a+M*(5*w)+O*(5*y)+F*(5*m)+U*(5*f);N=fe>>>13,fe&=8191,fe+=X*(5*h)+te*(5*d)+G*(5*u)+Z*(5*l)+ce*(5*c),N+=fe>>>13,fe&=8191;let Ce=N+_*c+M*a+O*(5*w)+F*(5*y)+U*(5*m);N=Ce>>>13,Ce&=8191,Ce+=X*(5*f)+te*(5*h)+G*(5*d)+Z*(5*u)+ce*(5*l),N+=Ce>>>13,Ce&=8191;let Ee=N+_*l+M*c+O*a+F*(5*w)+U*(5*y);N=Ee>>>13,Ee&=8191,Ee+=X*(5*m)+te*(5*f)+G*(5*h)+Z*(5*d)+ce*(5*u),N+=Ee>>>13,Ee&=8191;let K=N+_*u+M*l+O*c+F*a+U*(5*w);N=K>>>13,K&=8191,K+=X*(5*y)+te*(5*m)+G*(5*f)+Z*(5*h)+ce*(5*d),N+=K>>>13,K&=8191;let lt=N+_*d+M*u+O*l+F*c+U*a;N=lt>>>13,lt&=8191,lt+=X*(5*w)+te*(5*y)+G*(5*m)+Z*(5*f)+ce*(5*h),N+=lt>>>13,lt&=8191;let It=N+_*h+M*d+O*u+F*l+U*c;N=It>>>13,It&=8191,It+=X*a+te*(5*w)+G*(5*y)+Z*(5*m)+ce*(5*f),N+=It>>>13,It&=8191;let Se=N+_*f+M*h+O*d+F*u+U*l;N=Se>>>13,Se&=8191,Se+=X*c+te*a+G*(5*w)+Z*(5*y)+ce*(5*m),N+=Se>>>13,Se&=8191;let Dt=N+_*m+M*f+O*h+F*d+U*u;N=Dt>>>13,Dt&=8191,Dt+=X*l+te*c+G*a+Z*(5*w)+ce*(5*y),N+=Dt>>>13,Dt&=8191;let Wt=N+_*y+M*m+O*f+F*h+U*d;N=Wt>>>13,Wt&=8191,Wt+=X*u+te*l+G*c+Z*a+ce*(5*w),N+=Wt>>>13,Wt&=8191;let Lt=N+_*w+M*y+O*m+F*f+U*h;N=Lt>>>13,Lt&=8191,Lt+=X*d+te*u+G*l+Z*c+ce*a,N+=Lt>>>13,Lt&=8191,N=(N<<2)+N|0,N=N+fe|0,fe=N&8191,N=N>>>13,Ce+=N,s[0]=fe,s[1]=Ce,s[2]=Ee,s[3]=K,s[4]=lt,s[5]=It,s[6]=Se,s[7]=Dt,s[8]=Wt,s[9]=Lt}finalize(){const{h:e,pad:t}=this,r=new Uint16Array(10);let i=e[1]>>>13;e[1]&=8191;for(let a=2;a<10;a++)e[a]+=i,i=e[a]>>>13,e[a]&=8191;e[0]+=i*5,i=e[0]>>>13,e[0]&=8191,e[1]+=i,i=e[1]>>>13,e[1]&=8191,e[2]+=i,r[0]=e[0]+5,i=r[0]>>>13,r[0]&=8191;for(let a=1;a<10;a++)r[a]=e[a]+i,i=r[a]>>>13,r[a]&=8191;r[9]-=8192;let s=(i^1)-1;for(let a=0;a<10;a++)r[a]&=s;s=~s;for(let a=0;a<10;a++)e[a]=e[a]&s|r[a];e[0]=(e[0]|e[1]<<13)&65535,e[1]=(e[1]>>>3|e[2]<<10)&65535,e[2]=(e[2]>>>6|e[3]<<7)&65535,e[3]=(e[3]>>>9|e[4]<<4)&65535,e[4]=(e[4]>>>12|e[5]<<1|e[6]<<14)&65535,e[5]=(e[6]>>>2|e[7]<<11)&65535,e[6]=(e[7]>>>5|e[8]<<8)&65535,e[7]=(e[8]>>>8|e[9]<<5)&65535;let o=e[0]+t[0];e[0]=o&65535;for(let a=1;a<8;a++)o=(e[a]+t[a]|0)+(o>>>16)|0,e[a]=o&65535;Us(r)}update(e){d3(this),e=W1(e),Xt(e);const{buffer:t,blockLen:r}=this,i=e.length;for(let s=0;s<i;){const o=Math.min(r-this.pos,i-s);if(o===r){for(;r<=i-s;s+=r)this.process(e,s);continue}t.set(e.subarray(s,s+o),this.pos),this.pos+=o,s+=o,this.pos===r&&(this.process(t,0,!1),this.pos=0)}return this}destroy(){Us(this.h,this.r,this.buffer,this.pad)}digestInto(e){d3(this),y_(e,this),this.finished=!0;const{buffer:t,h:r}=this;let{pos:i}=this;if(i){for(t[i++]=1;i<16;i++)t[i]=0;this.process(t,0,!0)}this.finalize();let s=0;for(let o=0;o<8;o++)e[s++]=r[o]>>>0,e[s++]=r[o]>>>8;return e}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const r=e.slice(0,t);return this.destroy(),r}}function D_(n){const e=(r,i)=>n(i).update(W1(r)).digest(),t=n(new Uint8Array(32));return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=r=>n(r),e}const L_=D_(n=>new N_(n));function B_(n,e,t,r,i,s=20){let o=n[0],a=n[1],c=n[2],l=n[3],u=e[0],d=e[1],h=e[2],f=e[3],m=e[4],y=e[5],w=e[6],E=e[7],A=i,T=t[0],R=t[1],ie=t[2],re=o,j=a,se=c,_=l,M=u,O=d,F=h,U=f,X=m,te=y,G=w,Z=E,ce=A,N=T,fe=R,Ce=ie;for(let K=0;K<s;K+=2)re=re+M|0,ce=Ae(ce^re,16),X=X+ce|0,M=Ae(M^X,12),re=re+M|0,ce=Ae(ce^re,8),X=X+ce|0,M=Ae(M^X,7),j=j+O|0,N=Ae(N^j,16),te=te+N|0,O=Ae(O^te,12),j=j+O|0,N=Ae(N^j,8),te=te+N|0,O=Ae(O^te,7),se=se+F|0,fe=Ae(fe^se,16),G=G+fe|0,F=Ae(F^G,12),se=se+F|0,fe=Ae(fe^se,8),G=G+fe|0,F=Ae(F^G,7),_=_+U|0,Ce=Ae(Ce^_,16),Z=Z+Ce|0,U=Ae(U^Z,12),_=_+U|0,Ce=Ae(Ce^_,8),Z=Z+Ce|0,U=Ae(U^Z,7),re=re+O|0,Ce=Ae(Ce^re,16),G=G+Ce|0,O=Ae(O^G,12),re=re+O|0,Ce=Ae(Ce^re,8),G=G+Ce|0,O=Ae(O^G,7),j=j+F|0,ce=Ae(ce^j,16),Z=Z+ce|0,F=Ae(F^Z,12),j=j+F|0,ce=Ae(ce^j,8),Z=Z+ce|0,F=Ae(F^Z,7),se=se+U|0,N=Ae(N^se,16),X=X+N|0,U=Ae(U^X,12),se=se+U|0,N=Ae(N^se,8),X=X+N|0,U=Ae(U^X,7),_=_+M|0,fe=Ae(fe^_,16),te=te+fe|0,M=Ae(M^te,12),_=_+M|0,fe=Ae(fe^_,8),te=te+fe|0,M=Ae(M^te,7);let Ee=0;r[Ee++]=o+re|0,r[Ee++]=a+j|0,r[Ee++]=c+se|0,r[Ee++]=l+_|0,r[Ee++]=u+M|0,r[Ee++]=d+O|0,r[Ee++]=h+F|0,r[Ee++]=f+U|0,r[Ee++]=m+X|0,r[Ee++]=y+te|0,r[Ee++]=w+G|0,r[Ee++]=E+Z|0,r[Ee++]=A+ce|0,r[Ee++]=T+N|0,r[Ee++]=R+fe|0,r[Ee++]=ie+Ce|0}const M_=O_(B_,{counterRight:!1,counterLength:4,allowShortKeys:!1}),F_=new Uint8Array(16),g3=(n,e)=>{n.update(e);const t=e.length%16;t&&n.update(F_.subarray(t))},U_=new Uint8Array(32);function m3(n,e,t,r,i){const s=n(e,t,U_),o=L_.create(s);i&&g3(o,i),g3(o,r);const a=A_(r.length,i?i.length:0,!0);o.update(a);const c=o.digest();return Us(s,a),c}const $_=n=>(e,t,r)=>({encrypt(s,o){const a=s.length;o=h3(a+16,o,!1),o.set(s);const c=o.subarray(0,-16);n(e,t,c,c,1);const l=m3(n,e,t,c,r);return o.set(l,a),Us(l),o},decrypt(s,o){o=h3(s.length-16,o,!1);const a=s.subarray(0,-16),c=s.subarray(-16),l=m3(n,e,t,a,r);if(!S_(c,l))throw new Error("invalid tag");return o.set(s.subarray(0,-16)),n(e,t,o,o,1),Us(l),o}}),y3=x_({blockSize:64,nonceLength:12,tagLength:16},$_(M_));/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Ro=BigInt(0),hs=BigInt(1),Wc=BigInt(2);function V_(n){return uv(n,{adjustScalarBytes:"function",powPminus2:"function"}),Object.freeze({...n})}function q_(n){const e=V_(n),{P:t,type:r,adjustScalarBytes:i,powPminus2:s}=e,o=r==="x25519";if(!o&&r!=="x448")throw new Error("invalid type");const a=o?255:448,c=o?32:56,l=BigInt(o?9:5),u=BigInt(o?121665:39081),d=o?Wc**BigInt(254):Wc**BigInt(447),h=o?BigInt(8)*Wc**BigInt(251)-hs:BigInt(4)*Wc**BigInt(445)-hs,f=d+h+hs,m=j=>T5(j,t),y=w(l);function w(j){return lv(m(j),c)}function E(j){const se=Z2("u coordinate",j,c);return o&&(se[31]&=127),m(X2(se))}function A(j){return X2(i(Z2("scalar",j,c)))}function T(j,se){const _=re(E(se),A(j));if(_===Ro)throw new Error("invalid private or public key received");return w(_)}function R(j){return T(j,y)}function ie(j,se,_){const M=m(j*(se-_));return se=m(se-M),_=m(_+M),{x_2:se,x_3:_}}function re(j,se){Y2("u",j,Ro,t),Y2("scalar",se,d,f);const _=se,M=j;let O=hs,F=Ro,U=j,X=hs,te=Ro;for(let Z=BigInt(a-1);Z>=Ro;Z--){const ce=_>>Z&hs;te^=ce,{x_2:O,x_3:U}=ie(te,O,U),{x_2:F,x_3:X}=ie(te,F,X),te=ce;const N=O+F,fe=m(N*N),Ce=O-F,Ee=m(Ce*Ce),K=fe-Ee,lt=U+X,It=U-X,Se=m(It*N),Dt=m(lt*Ce),Wt=Se+Dt,Lt=Se-Dt;U=m(Wt*Wt),X=m(M*m(Lt*Lt)),O=m(fe*Ee),F=m(K*(fe+m(u*K)))}({x_2:O,x_3:U}=ie(te,O,U)),{x_2:F,x_3:X}=ie(te,F,X);const G=s(F);return m(O*G)}return{scalarMult:T,scalarMultBase:R,getSharedSecret:(j,se)=>T(j,se),getPublicKey:j=>R(j),utils:{randomPrivateKey:()=>e.randomBytes(c)},GuBytes:y.slice()}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Q1=BigInt("57896044618658097711785492504343953926634992332820282019728792003956564819949");BigInt(0);const H_=BigInt(1),w3=BigInt(2),z_=BigInt(3),K_=BigInt(5);BigInt(8);function W_(n){const e=BigInt(10),t=BigInt(20),r=BigInt(40),i=BigInt(80),s=Q1,a=n*n%s*n%s,c=Tr(a,w3,s)*a%s,l=Tr(c,H_,s)*n%s,u=Tr(l,K_,s)*l%s,d=Tr(u,e,s)*u%s,h=Tr(d,t,s)*d%s,f=Tr(h,r,s)*h%s,m=Tr(f,i,s)*f%s,y=Tr(m,i,s)*f%s,w=Tr(y,e,s)*u%s;return{pow_p_5_8:Tr(w,w3,s)*n%s,b2:a}}function G_(n){return n[0]&=248,n[31]&=127,n[31]|=64,n}const Gc=q_({P:Q1,type:"x25519",powPminus2:n=>{const e=Q1,{pow_p_5_8:t,b2:r}=W_(n);return T5(Tr(t,z_,e)*r,e)},adjustScalarBytes:G_,randomBytes:iv});function j_(n,e,t){return X0(n),t===void 0&&(t=new Uint8Array(n.outputLen)),Z0(n,j2(t),j2(e))}const Kh=Uint8Array.from([0]),v3=Uint8Array.of();function Q_(n,e,t,r=32){X0(n),ul(r);const i=n.outputLen;if(r>255*i)throw new Error("Length should be <= 255*HashLen");const s=Math.ceil(r/i);t===void 0&&(t=v3);const o=new Uint8Array(s*i),a=Z0.create(n,e),c=a._cloneInto(),l=new Uint8Array(a.outputLen);for(let u=0;u<s;u++)Kh[0]=u+1,c.update(u===0?v3:l).update(t).update(Kh).digestInto(l),o.set(l,i*u),a._cloneInto(c);return a.destroy(),c.destroy(),C5(l,Kh),o.slice(0,r)}const Y_={hashSHA256(n){return gh(n.subarray())},getHKDF(n,e){const t=j_(gh,e,n),i=Q_(gh,t,void 0,96),s=i.subarray(0,32),o=i.subarray(32,64),a=i.subarray(64,96);return[s,o,a]},generateX25519KeyPair(){const n=Gc.utils.randomPrivateKey();return{publicKey:Gc.getPublicKey(n),privateKey:n}},generateX25519KeyPairFromSeed(n){return{publicKey:Gc.getPublicKey(n),privateKey:n}},generateX25519SharedKey(n,e){return Gc.getSharedSecret(n.subarray(),e.subarray())},chaCha20Poly1305Encrypt(n,e,t,r){return y3(r,e,t).encrypt(n.subarray())},chaCha20Poly1305Decrypt(n,e,t,r,i){return y3(r,e,t).decrypt(n.subarray(),i)}},X_=Y_;function Z_(n){return{generateKeypair:n.generateX25519KeyPair,dh:(e,t)=>n.generateX25519SharedKey(e.privateKey,t).subarray(0,32),encrypt:n.chaCha20Poly1305Encrypt,decrypt:n.chaCha20Poly1305Decrypt,hash:n.hashSHA256,hkdf:n.getHKDF}}const zl=n=>{const e=Aa(2);return e[0]=n>>8,e[1]=n,e};zl.bytes=2;const dl=n=>{if(n.length<2)throw RangeError("Could not decode int16BE");if(n instanceof Uint8Array){let e=0;return e+=n[0]<<8,e+=n[1],e}return n.getUint16(0)};dl.bytes=2;function J_(n){return{xxHandshakeSuccesses:n.registerCounter("libp2p_noise_xxhandshake_successes_total",{help:"Total count of noise xxHandshakes successes_"}),xxHandshakeErrors:n.registerCounter("libp2p_noise_xxhandshake_error_total",{help:"Total count of noise xxHandshakes errors"}),encryptedPackets:n.registerCounter("libp2p_noise_encrypted_packets_total",{help:"Total count of noise encrypted packets successfully"}),decryptedPackets:n.registerCounter("libp2p_noise_decrypted_packets_total",{help:"Total count of noise decrypted packets"}),decryptErrors:n.registerCounter("libp2p_noise_decrypt_errors_total",{help:"Total count of noise decrypt errors"})}}function y8(n,e){!e.enabled||!hc||(n?(e(`LOCAL_STATIC_PUBLIC_KEY ${ee(n.publicKey,"hex")}`),e(`LOCAL_STATIC_PRIVATE_KEY ${ee(n.privateKey,"hex")}`)):e("Missing local static keys."))}function w8(n,e){!e.enabled||!hc||(n?(e(`LOCAL_PUBLIC_EPHEMERAL_KEY ${ee(n.publicKey,"hex")}`),e(`LOCAL_PRIVATE_EPHEMERAL_KEY ${ee(n.privateKey,"hex")}`)):e("Missing local ephemeral keys."))}function eI(n,e){!e.enabled||!hc||e(n?`REMOTE_STATIC_PUBLIC_KEY ${ee(n.subarray(),"hex")}`:"Missing remote static public key.")}function v8(n,e){!e.enabled||!hc||e(n?`REMOTE_EPHEMERAL_PUBLIC_KEY ${ee(n.subarray(),"hex")}`:"Missing remote ephemeral keys.")}function b8(n,e,t){!t.enabled||!hc||(t(`CIPHER_STATE_1 ${n.n.getUint64()} ${n.k&&ee(n.k,"hex")}`),t(`CIPHER_STATE_2 ${e.n.getUint64()} ${e.k&&ee(e.k,"hex")}`))}function $s(n,e){if(n.length!==e.length)throw new Error("Inputs should have the same length");const t=Aa(n.length);for(let r=0;r<n.length;r++)t[r]=n[r]^e[r];return $w(t)}class da extends Error{code;constructor(e="Invalid crypto exchange"){super(e),this.code=da.code}static code="ERR_INVALID_CRYPTO_EXCHANGE"}const tI=0,rI=4294967295,nI="Cipherstate has reached maximum n, a new handshake must be performed";class iI{n;bytes;view;constructor(e=tI){this.n=e,this.bytes=Le(12),this.view=new DataView(this.bytes.buffer,this.bytes.byteOffset,this.bytes.byteLength),this.view.setUint32(4,e,!0)}increment(){this.n++,this.view.setUint32(4,this.n,!0)}getBytes(){return this.bytes}getUint64(){return this.n}assertValue(){if(this.n>rI)throw new Error(nI)}}const Ts=Le(0);class jc{k;n;crypto;constructor(e,t=void 0,r=0){this.crypto=e,this.k=t,this.n=new iI(r)}hasKey(){return!!this.k}encryptWithAd(e,t){if(!this.hasKey())return t;this.n.assertValue();const r=this.crypto.encrypt(t,this.n.getBytes(),e,this.k);return this.n.increment(),r}decryptWithAd(e,t,r){if(!this.hasKey())return t;this.n.assertValue();const i=this.crypto.decrypt(t,this.n.getBytes(),e,this.k,r);return this.n.increment(),i}}class sI{cs;ck;h;crypto;constructor(e,t){this.crypto=e;const r=C(t,"utf-8");this.h=aI(e,r),this.ck=this.h,this.cs=new jc(e)}mixKey(e){const[t,r]=this.crypto.hkdf(this.ck,e);this.ck=t,this.cs=new jc(this.crypto,r)}mixHash(e){this.h=this.crypto.hash(new $e(this.h,e))}encryptAndHash(e){const t=this.cs.encryptWithAd(this.h,e);return this.mixHash(t),t}decryptAndHash(e){const t=this.cs.decryptWithAd(this.h,e);return this.mixHash(e),t}split(){const[e,t]=this.crypto.hkdf(this.ck,Ts);return[new jc(this.crypto,e),new jc(this.crypto,t)]}}class oI{ss;s;e;rs;re;initiator;crypto;constructor(e){const{crypto:t,protocolName:r,prologue:i,initiator:s,s:o,e:a,rs:c,re:l}=e;this.crypto=t,this.ss=new sI(t,r),this.ss.mixHash(i),this.initiator=s,this.s=o,this.e=a,this.rs=c,this.re=l}writeE(){if(this.e)throw new Error("ephemeral keypair is already set");const e=this.crypto.generateKeypair();return this.ss.mixHash(e.publicKey),this.e=e,e.publicKey}writeS(){if(!this.s)throw new Error("static keypair is not set");return this.ss.encryptAndHash(this.s.publicKey)}writeEE(){if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.re))}writeES(){if(this.initiator){if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.rs)throw new Error("remote static public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.rs))}else{if(!this.s)throw new Error("static keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.s,this.re))}}writeSE(){if(this.initiator){if(!this.s)throw new Error("static keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.s,this.re))}else{if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.rs)throw new Error("remote static public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.rs))}}readE(e,t=0){if(this.re)throw new Error("remote ephemeral public key is already set");if(e.byteLength<t+32)throw new Error("message is not long enough");this.re=e.sublist(t,t+32),this.ss.mixHash(this.re)}readS(e,t=0){if(this.rs)throw new Error("remote static public key is already set");const r=32+(this.ss.cs.hasKey()?16:0);if(e.byteLength<t+r)throw new Error("message is not long enough");const i=e.sublist(t,t+r);return this.rs=this.ss.decryptAndHash(i),r}readEE(){this.writeEE()}readES(){this.writeES()}readSE(){this.writeSE()}}class E8 extends oI{writeMessageA(e){return new $e(this.writeE(),this.ss.encryptAndHash(e))}writeMessageB(e){const t=this.writeE();this.writeEE();const r=this.writeS();return this.writeES(),new $e(t,r,this.ss.encryptAndHash(e))}writeMessageC(e){const t=this.writeS();return this.writeSE(),new $e(t,this.ss.encryptAndHash(e))}readMessageA(e){try{return this.readE(e),this.ss.decryptAndHash(e.sublist(32))}catch(t){throw new da(`handshake stage 0 validation fail: ${t.message}`)}}readMessageB(e){try{this.readE(e),this.readEE();const t=this.readS(e,32);return this.readES(),this.ss.decryptAndHash(e.sublist(32+t))}catch(t){throw new da(`handshake stage 1 validation fail: ${t.message}`)}}readMessageC(e){try{const t=this.readS(e);return this.readSE(),this.ss.decryptAndHash(e.sublist(t))}catch(t){throw new da(`handshake stage 2 validation fail: ${t.message}`)}}}function aI(n,e){if(e.length<=32){const t=Le(32);return t.set(e),t}else return n.hash(e)}var Kl;(function(n){let e;n.codec=()=>(e==null&&(e=pe((t,r,i={})=>{if(i.lengthDelimited!==!1&&r.fork(),t.webtransportCerthashes!=null)for(const s of t.webtransportCerthashes)r.uint32(10),r.bytes(s);if(t.streamMuxers!=null)for(const s of t.streamMuxers)r.uint32(18),r.string(s);i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{const s={webtransportCerthashes:[],streamMuxers:[]},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{if(i.limits?.webtransportCerthashes!=null&&s.webtransportCerthashes.length===i.limits.webtransportCerthashes)throw new xt('Decode error - map field "webtransportCerthashes" had too many elements');s.webtransportCerthashes.push(t.bytes());break}case 2:{if(i.limits?.streamMuxers!=null&&s.streamMuxers.length===i.limits.streamMuxers)throw new xt('Decode error - map field "streamMuxers" had too many elements');s.streamMuxers.push(t.string());break}default:{t.skipType(a&7);break}}}return s})),e),n.encode=t=>ge(t,n.codec()),n.decode=(t,r)=>me(t,n.codec(),r)})(Kl||(Kl={}));var Wl;(function(n){let e;n.codec=()=>(e==null&&(e=pe((t,r,i={})=>{i.lengthDelimited!==!1&&r.fork(),t.identityKey!=null&&t.identityKey.byteLength>0&&(r.uint32(10),r.bytes(t.identityKey)),t.identitySig!=null&&t.identitySig.byteLength>0&&(r.uint32(18),r.bytes(t.identitySig)),t.extensions!=null&&(r.uint32(34),Kl.codec().encode(t.extensions,r)),i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{const s={identityKey:Le(0),identitySig:Le(0)},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.identityKey=t.bytes();break}case 2:{s.identitySig=t.bytes();break}case 4:{s.extensions=Kl.codec().decode(t,t.uint32(),{limits:i.limits?.extensions});break}default:{t.skipType(a&7);break}}}return s})),e),n.encode=t=>ge(t,n.codec()),n.decode=(t,r)=>me(t,n.codec(),r)})(Wl||(Wl={}));async function S8(n,e,t){const r=await n.sign(A8(e));return Wl.encode({identityKey:Xn(n.publicKey),identitySig:r,extensions:t})}async function x8(n,e,t){try{const r=Wl.decode(n),i=Vr(r.identityKey);if(t?.equals(i)===!1)throw new Error(`Payload identity key ${i} does not match expected remote identity key ${t}`);if(!e)throw new Error("Remote static does not exist");const s=A8(e);if(!await i.verify(s,r.identitySig))throw new Error("Invalid payload signature");return r}catch(r){throw new Vw(r.message)}}function A8(n){const e=C("noise-libp2p-static-key:");return n instanceof Uint8Array?tr([e,n],e.length+n.length):(n.prepend(e),n)}async function cI(n,e){const{log:t,connection:r,crypto:i,privateKey:s,prologue:o,s:a,remoteIdentityKey:c,extensions:l}=n,u=await S8(s,a.publicKey,l),d=new E8({crypto:i,protocolName:"Noise_XX_25519_ChaChaPoly_SHA256",initiator:!0,prologue:o,s:a});y8(d.s,t),t.trace("Stage 0 - Initiator starting to send first message."),await r.write(d.writeMessageA(Ts),e),t.trace("Stage 0 - Initiator finished sending first message."),w8(d.e,t),t.trace("Stage 1 - Initiator waiting to receive first message from responder...");const h=d.readMessageB(await r.read(e));t.trace("Stage 1 - Initiator received the message."),v8(d.re,t),eI(d.rs,t),t.trace("Initiator going to check remote's signature...");const f=await x8(h,d.rs,c);t.trace("All good with the signature!"),t.trace("Stage 2 - Initiator sending third handshake message."),await r.write(d.writeMessageC(u),e),t.trace("Stage 2 - Initiator sent message with signed payload.");const[m,y]=d.ss.split();return b8(m,y,t),{payload:f,encrypt:w=>m.encryptWithAd(Ts,w),decrypt:(w,E)=>y.decryptWithAd(Ts,w,E)}}async function lI(n,e){const{log:t,connection:r,crypto:i,privateKey:s,prologue:o,s:a,remoteIdentityKey:c,extensions:l}=n,u=await S8(s,a.publicKey,l),d=new E8({crypto:i,protocolName:"Noise_XX_25519_ChaChaPoly_SHA256",initiator:!1,prologue:o,s:a});y8(d.s,t),t.trace("Stage 0 - Responder waiting to receive first message."),d.readMessageA(await r.read(e)),t.trace("Stage 0 - Responder received first message."),v8(d.re,t),t.trace("Stage 1 - Responder sending out first message with signed payload and static key."),await r.write(d.writeMessageB(u),e),t.trace("Stage 1 - Responder sent the second handshake message with signed payload."),w8(d.e,t),t.trace("Stage 2 - Responder waiting for third handshake message...");const h=d.readMessageC(await r.read(e));t.trace("Stage 2 - Responder received the message, finished handshake.");const f=await x8(h,d.rs,c),[m,y]=d.ss.split();return b8(m,y,t),{payload:f,encrypt:w=>y.encryptWithAd(Ts,w),decrypt:(w,E)=>m.decryptWithAd(Ts,w,E)}}const b3=16;function uI(n,e){return async function*(t){for await(const r of t)for(let i=0;i<r.length;i+=u3){let s=i+u3;s>r.length&&(s=r.length);let o;r instanceof Uint8Array?o=n.encrypt(r.subarray(i,s)):o=n.encrypt(r.sublist(i,s)),e?.encryptedPackets.increment(),yield new $e(zl(o.byteLength),o)}}}function dI(n,e){return async function*(t){for await(const r of t)for(let i=0;i<r.length;i+=qa){let s=i+qa;if(s>r.length&&(s=r.length),s-b3<i)throw new Error("Invalid chunk");const o=r.sublist(i,s),a=r.subarray(i,s-b3);try{const c=n.decrypt(o,a);e?.decryptedPackets.increment(),yield c}catch(c){throw e?.decryptErrors.increment(),c}}}}class hI{protocol="/noise";crypto;prologue;staticKey;extensions;metrics;components;constructor(e,t={}){const{staticNoiseKey:r,extensions:i,crypto:s,prologueBytes:o}=t,{metrics:a}=e;this.components=e;const c=s??X_;this.crypto=Z_(c),this.extensions={webtransportCerthashes:[],...i},this.metrics=a?J_(a):void 0,r?this.staticKey=c.generateX25519KeyPairFromSeed(r):this.staticKey=c.generateX25519KeyPair(),this.prologue=o??Le(0)}[Symbol.toStringTag]="@chainsafe/libp2p-noise";[St]=["@libp2p/connection-encryption","@chainsafe/libp2p-noise"];async secureOutbound(e,t){const r=Ms(e,{lengthEncoder:zl,lengthDecoder:dl,maxDataLength:qa}),i=await this.performHandshakeInitiator(r,this.components.privateKey,t?.remotePeer?.publicKey,t),s=await this.createSecureConnection(r,i);e.source=s.source,e.sink=s.sink;const o=Vr(i.payload.identityKey);return{conn:e,remoteExtensions:i.payload.extensions,remotePeer:Ca(o),streamMuxer:t?.skipStreamMuxerNegotiation===!0?void 0:this.getStreamMuxer(i.payload.extensions?.streamMuxers)}}getStreamMuxer(e){if(e==null||e.length===0)return;const t=this.components.upgrader.getStreamMuxers();if(t!=null)for(const r of e){const i=t.get(r);if(i!=null)return i}if(e.length)throw new qw("Early muxer negotiation was requested but the initiator and responder had no common muxers")}async secureInbound(e,t){const r=Ms(e,{lengthEncoder:zl,lengthDecoder:dl,maxDataLength:qa}),i=await this.performHandshakeResponder(r,this.components.privateKey,t?.remotePeer?.publicKey,t),s=await this.createSecureConnection(r,i);e.source=s.source,e.sink=s.sink;const o=Vr(i.payload.identityKey);return{conn:e,remoteExtensions:i.payload.extensions,remotePeer:Ca(o),streamMuxer:t?.skipStreamMuxerNegotiation===!0?void 0:this.getStreamMuxer(i.payload.extensions?.streamMuxers)}}async performHandshakeInitiator(e,t,r,i){let s;const o=i?.skipStreamMuxerNegotiation===!0?[]:[...this.components.upgrader.getStreamMuxers().keys()];try{s=await cI({connection:e,privateKey:t,remoteIdentityKey:r,log:this.components.logger.forComponent("libp2p:noise:xxhandshake"),crypto:this.crypto,prologue:this.prologue,s:this.staticKey,extensions:{streamMuxers:o,webtransportCerthashes:[],...this.extensions}},i),this.metrics?.xxHandshakeSuccesses.increment()}catch(a){throw this.metrics?.xxHandshakeErrors.increment(),a}return s}async performHandshakeResponder(e,t,r,i){let s;const o=i?.skipStreamMuxerNegotiation===!0?[]:[...this.components.upgrader.getStreamMuxers().keys()];try{s=await lI({connection:e,privateKey:t,remoteIdentityKey:r,log:this.components.logger.forComponent("libp2p:noise:xxhandshake"),crypto:this.crypto,prologue:this.prologue,s:this.staticKey,extensions:{streamMuxers:o,webtransportCerthashes:[],...this.extensions}},i),this.metrics?.xxHandshakeSuccesses.increment()}catch(a){throw this.metrics?.xxHandshakeErrors.increment(),a}return s}async createSecureConnection(e,t){const[r,i]=g_(),s=e.unwrap();return await rr(r,uI(t,this.metrics),s,o=>Da(o,{lengthDecoder:dl}),dI(t,this.metrics),r),i}}function k8(n={}){return e=>new hI(e,n)}function Ip(n){if(n!=null){if(typeof n[Symbol.iterator]=="function")return n[Symbol.iterator]();if(typeof n[Symbol.asyncIterator]=="function")return n[Symbol.asyncIterator]();if(typeof n.next=="function")return n}throw new Error("argument is not an iterator or iterable")}class Ss extends Error{static name="InvalidFrameError";constructor(e="The frame was invalid"){super(e),this.name="InvalidFrameError"}}class _8 extends Error{static name="UnrequestedPingError";constructor(e="Unrequested ping error"){super(e),this.name="UnrequestedPingError"}}class I8 extends Error{static name="NotMatchingPingError";constructor(e="Unrequested ping error"){super(e),this.name="NotMatchingPingError"}}class fI extends Error{static name="InvalidStateError";constructor(e="Invalid state"){super(e),this.name="InvalidStateError"}}class pI extends Error{static name="StreamAlreadyExistsError";constructor(e="Strean already exists"){super(e),this.name="StreamAlreadyExistsError"}}class gI extends Error{static name="DecodeInvalidVersionError";constructor(e="Decode invalid version"){super(e),this.name="DecodeInvalidVersionError"}}class mI extends Error{static name="BothClientsError";constructor(e="Both clients"){super(e),this.name="BothClientsError"}}class C8 extends Error{static name="ReceiveWindowExceededError";constructor(e="Receive window exceeded"){super(e),this.name="ReceiveWindowExceededError"}}const yI=new Set([Ss.name,_8.name,I8.name,pI.name,gI.name,mI.name,C8.name]),Cp=256*1024,wI=16*1024*1024,vI={enableKeepAlive:!0,keepAliveInterval:3e4,maxInboundStreams:1e3,maxOutboundStreams:1e3,initialStreamWindowSize:Cp,maxStreamWindowSize:wI,maxMessageSize:64*1024};function bI(n){if(n.keepAliveInterval<=0)throw new $("keep-alive interval must be positive");if(n.maxInboundStreams<0)throw new $("max inbound streams must be larger or equal 0");if(n.maxOutboundStreams<0)throw new $("max outbound streams must be larger or equal 0");if(n.initialStreamWindowSize<Cp)throw new $("InitialStreamWindowSize must be larger or equal 256 kB");if(n.maxStreamWindowSize<n.initialStreamWindowSize)throw new $("MaxStreamWindowSize must be larger than the InitialStreamWindowSize");if(n.maxStreamWindowSize>2**32-1)throw new $("MaxStreamWindowSize must be less than equal MAX_UINT32");if(n.maxMessageSize<1024)throw new $("MaxMessageSize must be greater than a kilobyte")}var ot;(function(n){n[n.Data=0]="Data",n[n.WindowUpdate=1]="WindowUpdate",n[n.Ping=2]="Ping",n[n.GoAway=3]="GoAway"})(ot||(ot={}));var Qe;(function(n){n[n.SYN=1]="SYN",n[n.ACK=2]="ACK",n[n.FIN=4]="FIN",n[n.RST=8]="RST"})(Qe||(Qe={}));Object.values(Qe).filter(n=>typeof n!="string");const EI=0;var Zr;(function(n){n[n.NormalTermination=0]="NormalTermination",n[n.ProtocolError=1]="ProtocolError",n[n.InternalError=2]="InternalError"})(Zr||(Zr={}));const ha=12,E3=2**24;function SI(n){if(n[0]!==EI)throw new Ss("Invalid frame version");return{type:n[1],flag:(n[2]<<8)+n[3],streamID:n[4]*E3+(n[5]<<16)+(n[6]<<8)+n[7],length:n[8]*E3+(n[9]<<16)+(n[10]<<8)+n[11]}}let xI=class{source;buffer;frameInProgress;constructor(e){this.source=AI(e),this.buffer=new $e,this.frameInProgress=!1}async*emitFrames(){for await(const e of this.source)for(this.buffer.append(e);;){const t=this.readHeader();if(t===void 0)break;const{type:r,length:i}=t;r===ot.Data?(this.frameInProgress=!0,yield{header:t,readData:this.readBytes.bind(this,i)}):yield{header:t}}}readHeader(){if(this.frameInProgress)throw new fI("decoding frame already in progress");if(this.buffer.length<ha)return;const e=SI(this.buffer.subarray(0,ha));return this.buffer.consume(ha),e}async readBytes(e){if(this.buffer.length<e){for await(const r of this.source)if(this.buffer.append(r),this.buffer.length>=e)break}const t=this.buffer.sublist(0,e);return this.buffer.consume(e),this.frameInProgress=!1,t}};function AI(n){if(n[Symbol.iterator]!==void 0){const e=n[Symbol.iterator]();return e.return=void 0,{[Symbol.iterator](){return e}}}else if(n[Symbol.asyncIterator]!==void 0){const e=n[Symbol.asyncIterator]();return e.return=void 0,{[Symbol.asyncIterator](){return e}}}else throw new Error("a source must be either an iterable or an async iterable")}function S3(n){const e=new Uint8Array(ha);return e[1]=n.type,e[2]=n.flag>>>8,e[3]=n.flag,e[4]=n.streamID>>>24,e[5]=n.streamID>>>16,e[6]=n.streamID>>>8,e[7]=n.streamID,e[8]=n.length>>>24,e[9]=n.length>>>16,e[10]=n.length>>>8,e[11]=n.length,e}function kI(n){return n==null?!1:typeof n.then=="function"&&typeof n.catch=="function"&&typeof n.finally=="function"}function T8(n,e){const t=Ip(n).return?.();kI(t)&&t.catch(r=>{e.error("could not cause iterator to return",r)})}const _I=5e3;function Wh(n){return n==null?!1:typeof n.then=="function"&&typeof n.catch=="function"&&typeof n.finally=="function"}class Tp{id;direction;timeline;protocol;metadata;source;status;readStatus;writeStatus;log;sinkController;sinkEnd;closed;endErr;streamSource;onEnd;onCloseRead;onCloseWrite;onReset;onAbort;sendCloseWriteTimeout;sendingData;constructor(e){this.sinkController=new AbortController,this.sinkEnd=we(),this.closed=we(),this.log=e.log,this.status="open",this.readStatus="ready",this.writeStatus="ready",this.id=e.id,this.metadata=e.metadata??{},this.direction=e.direction,this.timeline={open:Date.now()},this.sendCloseWriteTimeout=e.sendCloseWriteTimeout??_I,this.onEnd=e.onEnd,this.onCloseRead=e.onCloseRead,this.onCloseWrite=e.onCloseWrite,this.onReset=e.onReset,this.onAbort=e.onAbort,this.source=this.streamSource=fn({onEnd:t=>{t!=null?this.log.trace("source ended with error",t):this.log.trace("source ended"),this.onSourceEnd(t)}}),this.sink=this.sink.bind(this)}async sink(e){if(this.writeStatus!=="ready")throw new S1(`writable end state is "${this.writeStatus}" not "ready"`);try{this.writeStatus="writing";const t={signal:this.sinkController.signal};if(this.direction==="outbound"){const i=this.sendNewStream(t);Wh(i)&&await i}const r=()=>{T8(e,this.log)};try{this.sinkController.signal.addEventListener("abort",r),this.log.trace("sink reading from source");for await(let i of e){i=i instanceof Uint8Array?new $e(i):i;const s=this.sendData(i,t);Wh(s)&&(this.sendingData=we(),await s,this.sendingData.resolve(),this.sendingData=void 0)}}finally{this.sinkController.signal.removeEventListener("abort",r)}this.log.trace('sink finished reading from source, write status is "%s"',this.writeStatus),this.writeStatus==="writing"&&(this.writeStatus="closing",this.log.trace("send close write to remote"),await this.sendCloseWrite({signal:AbortSignal.timeout(this.sendCloseWriteTimeout)}),this.writeStatus="closed"),this.onSinkEnd()}catch(t){throw this.log.trace("sink ended with error, calling abort with error",t),this.abort(t),t}finally{this.log.trace("resolve sink end"),this.sinkEnd.resolve()}}onSourceEnd(e){this.timeline.closeRead==null&&(this.timeline.closeRead=Date.now(),this.readStatus="closed",e!=null&&this.endErr==null&&(this.endErr=e),this.onCloseRead?.(),this.timeline.closeWrite!=null?(this.log.trace("source and sink ended"),this.timeline.close=Date.now(),this.status!=="aborted"&&this.status!=="reset"&&(this.status="closed"),this.onEnd!=null&&this.onEnd(this.endErr),this.closed.resolve()):this.log.trace("source ended, waiting for sink to end"))}onSinkEnd(e){this.timeline.closeWrite==null&&(this.timeline.closeWrite=Date.now(),this.writeStatus="closed",e!=null&&this.endErr==null&&(this.endErr=e),this.onCloseWrite?.(),this.timeline.closeRead!=null?(this.log.trace("sink and source ended"),this.timeline.close=Date.now(),this.status!=="aborted"&&this.status!=="reset"&&(this.status="closed"),this.onEnd!=null&&this.onEnd(this.endErr),this.closed.resolve()):this.log.trace("sink ended, waiting for source to end"))}async close(e){this.status==="open"&&(this.log.trace("closing gracefully"),this.status="closing",await ht(Promise.all([this.closeWrite(e),this.closeRead(e),this.closed.promise]),e?.signal),this.status="closed",this.log.trace("closed gracefully"))}async closeRead(e={}){if(this.readStatus==="closing"||this.readStatus==="closed")return;this.log.trace('closing readable end of stream with starting read status "%s"',this.readStatus);const t=this.readStatus;this.readStatus="closing",this.status!=="reset"&&this.status!=="aborted"&&this.timeline.closeRead==null&&(this.log.trace("send close read to remote"),await this.sendCloseRead(e)),t==="ready"&&(this.log.trace("ending internal source queue with %d queued bytes",this.streamSource.readableLength),this.streamSource.end()),this.log.trace("closed readable end of stream")}async closeWrite(e={}){this.writeStatus==="closing"||this.writeStatus==="closed"||(this.log.trace('closing writable end of stream with starting write status "%s"',this.writeStatus),this.writeStatus==="ready"&&(this.log.trace("sink was never sunk, sink an empty array"),await ht(this.sink([]),e.signal)),this.writeStatus==="writing"&&(this.sendingData!=null&&await ht(this.sendingData.promise,e.signal),this.log.trace("aborting source passed to .sink"),this.sinkController.abort(),await ht(this.sinkEnd.promise,e.signal)),this.writeStatus="closed",this.log.trace("closed writable end of stream"))}abort(e){if(this.status==="closed"||this.status==="aborted"||this.status==="reset")return;this.log("abort with error",e),this.log("try to send reset to remote");const t=this.sendReset();Wh(t)&&t.catch(r=>{this.log.error("error sending reset message",r)}),this.status="aborted",this.timeline.abort=Date.now(),this._closeSinkAndSource(e),this.onAbort?.(e)}reset(){if(this.status==="closed"||this.status==="aborted"||this.status==="reset")return;const e=new Hw("stream reset");this.status="reset",this.timeline.reset=Date.now(),this._closeSinkAndSource(e),this.onReset?.()}_closeSinkAndSource(e){this._closeSink(e),this._closeSource(e)}_closeSink(e){this.writeStatus==="writing"&&(this.log.trace("end sink source"),this.sinkController.abort()),this.onSinkEnd(e)}_closeSource(e){this.readStatus!=="closing"&&this.readStatus!=="closed"&&(this.log.trace("ending source with %d bytes to be read by consumer",this.streamSource.readableLength),this.readStatus="closing",this.streamSource.end(e))}remoteCloseWrite(){if(this.readStatus==="closing"||this.readStatus==="closed"){this.log("received remote close write but local source is already closed");return}this.log.trace("remote close write"),this._closeSource()}remoteCloseRead(){if(this.writeStatus==="closing"||this.writeStatus==="closed"){this.log("received remote close read but local sink is already closed");return}this.log.trace("remote close read"),this._closeSink()}destroy(){if(this.status==="closed"||this.status==="aborted"||this.status==="reset"){this.log("received destroy but we are already closed");return}this.log.trace("stream destroyed"),this._closeSinkAndSource()}sourcePush(e){this.streamSource.push(e)}sourceReadableLength(){return this.streamSource.readableLength}}var Nr;(function(n){n[n.Init=0]="Init",n[n.SYNSent=1]="SYNSent",n[n.SYNReceived=2]="SYNReceived",n[n.Established=3]="Established",n[n.Finished=4]="Finished"})(Nr||(Nr={}));class II extends Tp{name;state;config;_id;sendWindowCapacity;sendWindowCapacityUpdate;recvWindow;recvWindowCapacity;epochStart;getRTT;sendFrame;constructor(e){super({...e,onEnd:t=>{this.state=Nr.Finished,e.onEnd?.(t)}}),this.config=e.config,this._id=parseInt(e.id,10),this.name=e.name,this.state=e.state,this.sendWindowCapacity=Cp,this.recvWindow=this.config.initialStreamWindowSize,this.recvWindowCapacity=this.recvWindow,this.epochStart=Date.now(),this.getRTT=e.getRTT,this.sendFrame=e.sendFrame,this.source=Tl(this.source,()=>{this.sendWindowUpdate()})}async sendNewStream(){}async sendData(e,t={}){for(e=e.sublist();e.byteLength!==0;){if(this.sendWindowCapacity===0&&(this.log?.trace("wait for send window capacity, status %s",this.status),await this.waitForSendWindowCapacity(t),this.status==="closed"||this.status==="aborted"||this.status==="reset")){this.log?.trace("%s while waiting for send window capacity",this.status);return}const r=Math.min(this.sendWindowCapacity,this.config.maxMessageSize-ha,e.length),i=this.getSendFlags();this.sendFrame({type:ot.Data,flag:i,streamID:this._id,length:r},e.sublist(0,r)),this.sendWindowCapacity-=r,e.consume(r)}}async sendReset(){this.sendFrame({type:ot.WindowUpdate,flag:Qe.RST,streamID:this._id,length:0})}async sendCloseWrite(){const e=this.getSendFlags()|Qe.FIN;this.sendFrame({type:ot.WindowUpdate,flag:e,streamID:this._id,length:0})}async sendCloseRead(){}async waitForSendWindowCapacity(e={}){if(this.sendWindowCapacity>0)return;let t,r;const i=()=>{this.status==="open"||this.status==="closing"?r(new pt("Stream aborted")):t()};e.signal?.addEventListener("abort",i);try{await new Promise((s,o)=>{this.sendWindowCapacityUpdate=()=>{s()},r=o,t=s})}finally{e.signal?.removeEventListener("abort",i)}}handleWindowUpdate(e){this.log?.trace("stream received window update id=%s",this._id),this.processFlags(e.flag);const t=this.sendWindowCapacity;this.sendWindowCapacity+=e.length,t===0&&e.length>0&&this.sendWindowCapacityUpdate?.()}async handleData(e,t){if(this.log?.trace("stream received data id=%s",this._id),this.processFlags(e.flag),this.recvWindowCapacity<e.length)throw new C8("Receive window exceeded");const r=await t();this.recvWindowCapacity-=e.length,this.sourcePush(r)}processFlags(e){(e&Qe.ACK)===Qe.ACK&&this.state===Nr.SYNSent&&(this.state=Nr.Established),(e&Qe.FIN)===Qe.FIN&&this.remoteCloseWrite(),(e&Qe.RST)===Qe.RST&&this.reset()}getSendFlags(){switch(this.state){case Nr.Init:return this.state=Nr.SYNSent,Qe.SYN;case Nr.SYNReceived:return this.state=Nr.Established,Qe.ACK;default:return 0}}sendWindowUpdate(){const e=this.getSendFlags(),t=Date.now(),r=this.getRTT();if(e===0&&r>-1&&t-this.epochStart<r*4&&(this.recvWindow=Math.min(this.recvWindow*2,this.config.maxStreamWindowSize)),this.recvWindowCapacity>=this.recvWindow&&e===0)return;const i=this.recvWindow-this.recvWindowCapacity;this.recvWindowCapacity=this.recvWindow,this.epochStart=t,this.sendFrame({type:ot.WindowUpdate,flag:e,streamID:this._id,length:i})}}const R8="/yamux/1.0.0",CI=500;class TI{protocol=R8;_components;_init;constructor(e,t={}){this._components=e,this._init=t}[Symbol.toStringTag]="@chainsafe/libp2p-yamux";[St]=["@libp2p/stream-multiplexing"];createStreamMuxer(e){return new RI(this._components,{...this._init,...e})}}class RI{protocol=R8;source;sink;config;log;logger;closeController;nextStreamID;_streams;nextPingID;activePing;rtt;client;localGoAway;remoteGoAway;numInboundStreams;numOutboundStreams;onIncomingStream;onStreamEnd;constructor(e,t){this.client=t.direction==="outbound",this.config={...vI,...t},this.logger=e.logger,this.log=this.logger.forComponent("libp2p:yamux"),bI(this.config),this.closeController=new AbortController,this.closeController.signal,this.onIncomingStream=t.onIncomingStream,this.onStreamEnd=t.onStreamEnd,this._streams=new Map,this.source=fn({onEnd:()=>{this.log?.trace("muxer source ended"),this._streams.forEach(r=>{r.destroy()})}}),this.sink=async r=>{const i=()=>{const a=Ip(r);if(a.return!=null){const c=a.return();PI(c)&&c.catch(l=>{this.log?.("could not cause sink source to return",l)})}};let s,o;try{const a=new xI(r);try{this.closeController.signal.addEventListener("abort",i);for await(const c of a.emitFrames())await this.handleFrame(c.header,c.readData)}finally{this.closeController.signal.removeEventListener("abort",i)}s=Zr.NormalTermination}catch(a){yI.has(a.name)?(this.log?.error("protocol error in sink",a),s=Zr.ProtocolError):(this.log?.error("internal error in sink",a),s=Zr.InternalError),o=a}this.log?.trace("muxer sink ended"),o!=null?this.abort(o,s):await this.close({reason:s})},this.numInboundStreams=0,this.numOutboundStreams=0,this.nextStreamID=this.client?1:2,this.nextPingID=0,this.rtt=-1,this.log?.trace("muxer created"),this.config.enableKeepAlive&&this.keepAliveLoop().catch(r=>this.log?.error("keepalive error: %s",r)),this.ping().catch(r=>this.log?.error("ping error: %s",r))}get streams(){return Array.from(this._streams.values())}newStream(e){if(this.remoteGoAway!==void 0)throw new ws("Muxer closed remotely");if(this.localGoAway!==void 0)throw new ws("Muxer closed locally");const t=this.nextStreamID;if(this.nextStreamID+=2,this.numOutboundStreams>=this.config.maxOutboundStreams)throw new G0("max outbound streams exceeded");this.log?.trace("new outgoing stream id=%s",t);const r=this._newStream(t,e,Nr.Init,"outbound");return this._streams.set(t,r),this.numOutboundStreams++,r.sendWindowUpdate(),r}async ping(){if(this.remoteGoAway!==void 0)throw new ws("Muxer closed remotely");if(this.localGoAway!==void 0)throw new ws("Muxer closed locally");if(this.activePing===void 0){let e=()=>{};this.activePing={id:this.nextPingID++,promise:new Promise((i,s)=>{const o=()=>{s(new ws("Muxer closed locally"))};this.closeController.signal.addEventListener("abort",o,{once:!0}),e=()=>{this.closeController.signal.removeEventListener("abort",o),i()}}),resolve:e};const t=Date.now();this.sendPing(this.activePing.id);try{await this.activePing.promise}finally{delete this.activePing}const r=Date.now();this.rtt=r-t}else await this.activePing.promise;return this.rtt}getRTT(){return this.rtt}async close(e={}){if(this.closeController.signal.aborted)return;const t=e?.reason??Zr.NormalTermination;if(this.log?.trace("muxer close reason=%s",t),e.signal==null){const r=AbortSignal.timeout(CI);e={...e,signal:r}}try{await Promise.all([...this._streams.values()].map(async r=>r.close(e))),this.sendGoAway(t),this._closeMuxer()}catch(r){this.abort(r)}}abort(e,t){if(!this.closeController.signal.aborted){t=t??Zr.InternalError,this.log?.error("muxer abort reason=%s error=%s",t,e);for(const r of this._streams.values())r.abort(e);this.sendGoAway(t),this._closeMuxer()}}isClosed(){return this.closeController.signal.aborted}_closeMuxer(){this.closeController.abort(),this.source.end()}_newStream(e,t,r,i){if(this._streams.get(e)!=null)throw new $("Stream already exists with that id");const s=new II({id:e.toString(),name:t,state:r,direction:i,sendFrame:this.sendFrame.bind(this),onEnd:()=>{this.closeStream(e),this.onStreamEnd?.(s)},log:this.logger.forComponent(`libp2p:yamux:${i}:${e}`),config:this.config,getRTT:this.getRTT.bind(this)});return s}closeStream(e){this.client===(e%2===0)?this.numInboundStreams--:this.numOutboundStreams--,this._streams.delete(e)}async keepAliveLoop(){for(this.log?.trace("muxer keepalive enabled interval=%s",this.config.keepAliveInterval);;){let e;try{await ht(new Promise(t=>{e=setTimeout(t,this.config.keepAliveInterval)}),this.closeController.signal),this.ping().catch(t=>this.log?.error("ping error: %s",t))}catch{clearInterval(e);return}}}async handleFrame(e,t){const{streamID:r,type:i,length:s}=e;if(this.log?.trace("received frame %o",e),r===0)switch(i){case ot.Ping:{this.handlePing(e);return}case ot.GoAway:{this.handleGoAway(s);return}default:throw new Ss("Invalid frame type")}else switch(e.type){case ot.Data:case ot.WindowUpdate:{await this.handleStreamMessage(e,t);return}default:throw new Ss("Invalid frame type")}}handlePing(e){if(e.flag===Qe.SYN)this.log?.trace("received ping request pingId=%s",e.length),this.sendPing(e.length,Qe.ACK);else if(e.flag===Qe.ACK)this.log?.trace("received ping response pingId=%s",e.length),this.handlePingResponse(e.length);else throw new Ss("Invalid frame flag")}handlePingResponse(e){if(this.activePing===void 0)throw new _8("ping not requested");if(this.activePing.id!==e)throw new I8("ping doesn't match our id");this.activePing.resolve()}handleGoAway(e){this.log?.trace("received GoAway reason=%s",Zr[e]??"unknown"),this.remoteGoAway=e;for(const t of this._streams.values())t.reset();this._closeMuxer()}async handleStreamMessage(e,t){const{streamID:r,flag:i,type:s}=e;(i&Qe.SYN)===Qe.SYN&&this.incomingStream(r);const o=this._streams.get(r);if(o===void 0){if(s===ot.Data){if(this.log?.("discarding data for stream id=%s",r),t===void 0)throw new Error("unreachable");await t()}else this.log?.trace("frame for missing stream id=%s",r);return}switch(s){case ot.WindowUpdate:{o.handleWindowUpdate(e);return}case ot.Data:{if(t===void 0)throw new Error("unreachable");await o.handleData(e,t);return}default:throw new Error("unreachable")}}incomingStream(e){if(this.client!==(e%2===0))throw new $("Both endpoints are clients");if(this._streams.has(e))return;if(this.log?.trace("new incoming stream id=%s",e),this.localGoAway!==void 0){this.sendFrame({type:ot.WindowUpdate,flag:Qe.RST,streamID:e,length:0});return}if(this.numInboundStreams>=this.config.maxInboundStreams){this.log?.("maxIncomingStreams exceeded, forcing stream reset"),this.sendFrame({type:ot.WindowUpdate,flag:Qe.RST,streamID:e,length:0});return}const t=this._newStream(e,void 0,Nr.SYNReceived,"inbound");this.numInboundStreams++,this._streams.set(e,t),this.onIncomingStream?.(t)}sendFrame(e,t){if(this.log?.trace("sending frame %o",e),e.type===ot.Data){if(t===void 0)throw new Ss("Invalid frame");this.source.push(new $e(S3(e),t))}else this.source.push(S3(e))}sendPing(e,t=Qe.SYN){t===Qe.SYN?this.log?.trace("sending ping request pingId=%s",e):this.log?.trace("sending ping response pingId=%s",e),this.sendFrame({type:ot.Ping,flag:t,streamID:0,length:e})}sendGoAway(e=Zr.NormalTermination){this.log?.("sending GoAway reason=%s",Zr[e]),this.localGoAway=e,this.sendFrame({type:ot.GoAway,flag:0,streamID:0,length:e})}}function PI(n){return n!=null&&typeof n.then=="function"}function OI(n={}){return e=>new TI(e,n)}function P8(n){try{for(const{code:e,value:t}of n.getComponents())if(t!=null&&e===Bi)return Ev("2000::/3",t)}catch{}return!1}function NI(n,e,t){let r,i,s=!1;function o(){const l={signal:i.signal};if(t?.timeout!=null){const u=Re([i.signal,AbortSignal.timeout(t.timeout)]);l.signal=u}s=!0,Promise.resolve().then(async()=>{await n(l)}).catch(()=>{}).finally(()=>{s=!1,!i.signal.aborted&&(r=setTimeout(o,e))})}const a=Oa(o,t?.debounce??100);let c=!1;return{setInterval:l=>{e!==l&&(e=l,r!=null&&(clearTimeout(r),r=setTimeout(o,e)))},setTimeout:l=>{t??={},t.timeout=l},run:()=>{s||(clearTimeout(r),a())},start:()=>{c||(c=!0,i=new AbortController,i.signal,t?.runImmediately===!0?queueMicrotask(()=>{o()}):r=setTimeout(o,e))},stop:()=>{clearTimeout(r),i?.abort(),c=!1}}}function Nt(n,e){const t=Ms(n,e),r={read:async(i,s)=>{const o=await t.read(s);return i.decode(o)},write:async(i,s,o)=>{await t.write(s.encode(i),o)},writeV:async(i,s,o)=>{await t.writeV(i.map(a=>s.encode(a)),o)},pb:i=>({read:async s=>r.read(i,s),write:async(s,o)=>r.write(s,i,o),writeV:async(s,o)=>r.writeV(s,i,o),unwrap:()=>r}),unwrap:()=>t.unwrap()};return r}const DI="libp2p",LI="autonat",BI="1.0.0",MI=3e4,FI=2,UI=20,$I=80,VI=8192;var Ke;(function(n){(function(i){i.DIAL="DIAL",i.DIAL_RESPONSE="DIAL_RESPONSE"})(n.MessageType||(n.MessageType={}));let e;(function(i){i[i.DIAL=0]="DIAL",i[i.DIAL_RESPONSE=1]="DIAL_RESPONSE"})(e||(e={})),(function(i){i.codec=()=>Jt(e)})(n.MessageType||(n.MessageType={})),(function(i){i.OK="OK",i.E_DIAL_ERROR="E_DIAL_ERROR",i.E_DIAL_REFUSED="E_DIAL_REFUSED",i.E_BAD_REQUEST="E_BAD_REQUEST",i.E_INTERNAL_ERROR="E_INTERNAL_ERROR"})(n.ResponseStatus||(n.ResponseStatus={}));let t;(function(i){i[i.OK=0]="OK",i[i.E_DIAL_ERROR=100]="E_DIAL_ERROR",i[i.E_DIAL_REFUSED=101]="E_DIAL_REFUSED",i[i.E_BAD_REQUEST=200]="E_BAD_REQUEST",i[i.E_INTERNAL_ERROR=300]="E_INTERNAL_ERROR"})(t||(t={})),(function(i){i.codec=()=>Jt(t)})(n.ResponseStatus||(n.ResponseStatus={})),(function(i){let s;i.codec=()=>(s==null&&(s=pe((o,a,c={})=>{if(c.lengthDelimited!==!1&&a.fork(),o.id!=null&&(a.uint32(10),a.bytes(o.id)),o.addrs!=null)for(const l of o.addrs)a.uint32(18),a.bytes(l);c.lengthDelimited!==!1&&a.ldelim()},(o,a,c={})=>{const l={addrs:[]},u=a==null?o.len:o.pos+a;for(;o.pos<u;){const d=o.uint32();switch(d>>>3){case 1:{l.id=o.bytes();break}case 2:{if(c.limits?.addrs!=null&&l.addrs.length===c.limits.addrs)throw new xt('Decode error - map field "addrs" had too many elements');l.addrs.push(o.bytes());break}default:{o.skipType(d&7);break}}}return l})),s),i.encode=o=>ge(o,i.codec()),i.decode=(o,a)=>me(o,i.codec(),a)})(n.PeerInfo||(n.PeerInfo={})),(function(i){let s;i.codec=()=>(s==null&&(s=pe((o,a,c={})=>{c.lengthDelimited!==!1&&a.fork(),o.peer!=null&&(a.uint32(10),n.PeerInfo.codec().encode(o.peer,a)),c.lengthDelimited!==!1&&a.ldelim()},(o,a,c={})=>{const l={},u=a==null?o.len:o.pos+a;for(;o.pos<u;){const d=o.uint32();switch(d>>>3){case 1:{l.peer=n.PeerInfo.codec().decode(o,o.uint32(),{limits:c.limits?.peer});break}default:{o.skipType(d&7);break}}}return l})),s),i.encode=o=>ge(o,i.codec()),i.decode=(o,a)=>me(o,i.codec(),a)})(n.Dial||(n.Dial={})),(function(i){let s;i.codec=()=>(s==null&&(s=pe((o,a,c={})=>{c.lengthDelimited!==!1&&a.fork(),o.status!=null&&(a.uint32(8),n.ResponseStatus.codec().encode(o.status,a)),o.statusText!=null&&(a.uint32(18),a.string(o.statusText)),o.addr!=null&&(a.uint32(26),a.bytes(o.addr)),c.lengthDelimited!==!1&&a.ldelim()},(o,a,c={})=>{const l={},u=a==null?o.len:o.pos+a;for(;o.pos<u;){const d=o.uint32();switch(d>>>3){case 1:{l.status=n.ResponseStatus.codec().decode(o);break}case 2:{l.statusText=o.string();break}case 3:{l.addr=o.bytes();break}default:{o.skipType(d&7);break}}}return l})),s),i.encode=o=>ge(o,i.codec()),i.decode=(o,a)=>me(o,i.codec(),a)})(n.DialResponse||(n.DialResponse={}));let r;n.codec=()=>(r==null&&(r=pe((i,s,o={})=>{o.lengthDelimited!==!1&&s.fork(),i.type!=null&&(s.uint32(8),n.MessageType.codec().encode(i.type,s)),i.dial!=null&&(s.uint32(18),n.Dial.codec().encode(i.dial,s)),i.dialResponse!=null&&(s.uint32(26),n.DialResponse.codec().encode(i.dialResponse,s)),o.lengthDelimited!==!1&&s.ldelim()},(i,s,o={})=>{const a={},c=s==null?i.len:i.pos+s;for(;i.pos<c;){const l=i.uint32();switch(l>>>3){case 1:{a.type=n.MessageType.codec().decode(i);break}case 2:{a.dial=n.Dial.codec().decode(i,i.uint32(),{limits:o.limits?.dial});break}case 3:{a.dialResponse=n.DialResponse.codec().decode(i,i.uint32(),{limits:o.limits?.dialResponse});break}default:{i.skipType(l&7);break}}}return a})),r),n.encode=i=>ge(i,n.codec()),n.decode=(i,s)=>me(i,n.codec(),s)})(Ke||(Ke={}));const qI=4,HI=8;class zI{components;protocol;timeout;maxInboundStreams;maxOutboundStreams;maxMessageSize;started;log;topologyId;dialResults;findPeers;addressFilter;connectionThreshold;constructor(e,t){this.components=e,this.log=e.logger.forComponent("libp2p:auto-nat"),this.started=!1,this.protocol=`/${t.protocolPrefix??DI}/${LI}/${BI}`,this.timeout=t.timeout??MI,this.maxInboundStreams=t.maxInboundStreams??FI,this.maxOutboundStreams=t.maxOutboundStreams??UI,this.connectionThreshold=t.connectionThreshold??$I,this.maxMessageSize=t.maxMessageSize??VI,this.dialResults=Hr({name:"libp2p_autonat_dial_results",metrics:e.metrics}),this.findPeers=NI(this.findRandomPeers.bind(this),6e4),this.addressFilter=ai(1024)}[Symbol.toStringTag]="@libp2p/autonat";[St]=["@libp2p/autonat"];get[Mi](){return["@libp2p/identify"]}isStarted(){return this.started}async start(){this.started||(await this.components.registrar.handle(this.protocol,e=>{this.handleIncomingAutonatStream(e).catch(t=>{this.log.error("error handling incoming autonat stream - %e",t)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}),this.topologyId=await this.components.registrar.register(this.protocol,{onConnect:(e,t)=>{this.verifyExternalAddresses(t).catch(r=>{this.log.error("could not verify addresses - %e",r)})}}),this.findPeers.start(),this.started=!0)}async stop(){await this.components.registrar.unhandle(this.protocol),this.topologyId!=null&&await this.components.registrar.unhandle(this.topologyId),this.dialResults.clear(),this.findPeers.stop(),this.started=!1}allAddressesAreVerified(){return this.components.addressManager.getAddressesWithMetadata().every(e=>e.expires>Date.now()?!0:e.verified)}async findRandomPeers(e){if(this.allAddressesAreVerified())return;const t=Re([AbortSignal.timeout(1e4),e?.signal]);try{this.log("starting random walk to find peers to run AutoNAT");for await(const r of this.components.randomWalk.walk({signal:t})){if(!await this.components.connectionManager.isDialable(r.multiaddrs)){this.log.trace("random peer %p was not dialable %s",r.id,r.multiaddrs.map(i=>i.toString()).join(", "));continue}try{this.log.trace("dial random peer %p",r.id),await this.components.connectionManager.openConnection(r.multiaddrs,{signal:t})}catch{}if(this.allAddressesAreVerified()){this.log("stopping random walk, all addresses are verified");return}if(!this.hasConnectionCapacity()){this.log("stopping random walk, too close to max connections");return}}}catch{}}async handleIncomingAutonatStream(e){const t=AbortSignal.timeout(this.timeout),r=Nt(e.stream,{maxDataLength:this.maxMessageSize}).pb(Ke);try{const i=await r.read({signal:t}),s=await this.handleAutonatMessage(i,e.connection,{signal:t});await r.write(s,{signal:t}),await r.unwrap().unwrap().close({signal:t})}catch(i){this.log.error("error handling incoming autonat stream - %e",i),e.stream.abort(i)}}async handleAutonatMessage(e,t,r){const i=this.components.addressManager.getAddresses().map(d=>d.toOptions().host),s=e.dial;if(s==null)return this.log.error("dial was missing from message"),{type:Ke.MessageType.DIAL_RESPONSE,dialResponse:{status:Ke.ResponseStatus.E_BAD_REQUEST,statusText:"No Dial message found in message"}};let o;const a=s.peer;if(a?.id==null)return this.log.error("PeerId missing from message"),{type:Ke.MessageType.DIAL_RESPONSE,dialResponse:{status:Ke.ResponseStatus.E_BAD_REQUEST,statusText:"missing peer info"}};try{const d=zt(a.id);o=Pn(d)}catch(d){return this.log.error("invalid PeerId - %e",d),{type:Ke.MessageType.DIAL_RESPONSE,dialResponse:{status:Ke.ResponseStatus.E_BAD_REQUEST,statusText:"bad peer id"}}}if(this.log("incoming request from %p",o),!t.remotePeer.equals(o))return this.log("target peer %p did not equal sending peer %p",o,t.remotePeer),{type:Ke.MessageType.DIAL_RESPONSE,dialResponse:{status:Ke.ResponseStatus.E_BAD_REQUEST,statusText:"peer id mismatch"}};const c=a.addrs.map(d=>ue(d)).filter(d=>{try{const h=d.toOptions();return Ui(d)?!1:h.host!==t.remoteAddr.toOptions().host?(this.log.trace("not dialing %a - target host did not match remote host %a",d,t.remoteAddr),!1):i.includes(h.host)?!1:this.components.transportManager.dialTransportForMultiaddr(d)==null?(this.log.trace("not dialing %a - transport unsupported",d),!1):!0}catch{return!1}}).map(d=>(d.getPeerId()==null&&(d=d.encapsulate(`/p2p/${o.toString()}`)),d));if(c.length===0)return this.log("refused to dial all multiaddrs for %p from message",o),{type:Ke.MessageType.DIAL_RESPONSE,dialResponse:{status:Ke.ResponseStatus.E_DIAL_REFUSED,statusText:"no dialable addresses"}};this.log("dial multiaddrs %s for peer %p",c.map(d=>d.toString()).join(", "),o);let l="",u=c[0];for(const d of c){let h;u=d;try{if(h=await this.components.connectionManager.openConnection(d,r),!h.remoteAddr.equals(d))throw this.log.error("tried to dial %a but dialed %a",d,h.remoteAddr),new Error("Unexpected remote address");return this.log("successfully dialed %p via %a",o,d),{type:Ke.MessageType.DIAL_RESPONSE,dialResponse:{status:Ke.ResponseStatus.OK,addr:h.remoteAddr.decapsulateCode(so("p2p").code).bytes}}}catch(f){this.log.error("could not dial %p - %e",o,f),l=f.message}finally{h!=null&&await h.close()}}return{type:Ke.MessageType.DIAL_RESPONSE,dialResponse:{status:Ke.ResponseStatus.E_DIAL_ERROR,statusText:l,addr:u.bytes}}}getFirstUnverifiedMultiaddr(e,t){const r=this.components.addressManager.getAddressesWithMetadata().sort((i,s)=>i.type==="observed"&&s.type!=="observed"?1:s.type==="observed"&&i.type!=="observed"?-1:0).filter(i=>!(!(i.expires<Date.now())||i.multiaddr.toOptions().family===6&&(!t||!P8(i.multiaddr))||Ui(i.multiaddr)));for(const i of r){const s=i.multiaddr.toString();let o=this.dialResults.get(s);if(o!=null){if(o.networkSegments.includes(e)){this.log.trace("%a already has a network segment result from %s",o.multiaddr,e);continue}if(o.queue.size>10){this.log.trace("%a already has enough peers queued",o.multiaddr);continue}}if(o==null){const a=i.expires<Date.now();if(a&&this.addressFilter.remove?.(s),this.addressFilter.has(s))continue;this.addressFilter.add(s),this.log.trace("creating dial result %s %s",a?"to revalidate":"for",s),o={multiaddr:i.multiaddr,success:0,failure:0,networkSegments:[],verifyingPeers:lb(),queue:new oi({concurrency:3,maxSize:50}),type:i.type,lastVerified:i.lastVerified},this.dialResults.set(s,o)}return o}}removeOutdatedMultiaddrResults(){const e=new Set(this.components.addressManager.getAddressesWithMetadata().filter(({expires:t})=>t<Date.now()).map(({multiaddr:t})=>t.toString()));for(const t of this.dialResults.keys())e.has(t)||(this.log.trace("remove results for %a",t),this.dialResults.delete(t))}async verifyExternalAddresses(e){if(!this.isStarted())return;this.removeOutdatedMultiaddrResults();const r=(await this.components.peerStore.get(e.remotePeer)).addresses.some(({multiaddr:o})=>o.toOptions().family===6),i=this.getNetworkSegment(e.remoteAddr),s=this.getFirstUnverifiedMultiaddr(i,r);if(s==null){this.log.trace("no unverified public addresses found for peer %p to verify, not requesting verification",e.remotePeer);return}if(!this.hasConnectionCapacity()){s.lastVerified!=null?(this.log("automatically re-verifying %a because we are too close to the connection limit",s.multiaddr),this.confirmAddress(s)):this.log("skipping verifying %a because we are too close to the connection limit",s.multiaddr);return}s.queue.add(async o=>{await this.askPeerToVerify(e,i,o)},{peerId:e.remotePeer,multiaddr:s.multiaddr}).catch(o=>{s?.result==null&&this.log.error("error from %p verifying address %a - %e",e.remotePeer,s?.multiaddr,o)})}async askPeerToVerify(e,t,r){let i=this.dialResults.get(r.multiaddr.toString());if(i==null){this.log("%a was verified while %p was queued",r.multiaddr,e.remotePeer);return}const s=AbortSignal.timeout(this.timeout);this.log.trace("asking %p to verify multiaddr %s",e.remotePeer,r.multiaddr);const o=await e.newStream(this.protocol,{signal:s});try{const a=Nt(o).pb(Ke),[,c]=await Promise.all([a.write({type:Ke.MessageType.DIAL,dial:{peer:{id:this.components.peerId.toMultihash().bytes,addrs:[r.multiaddr.bytes]}}},{signal:s}),a.read({signal:s})]);if(c.type!==Ke.MessageType.DIAL_RESPONSE||c.dialResponse==null){this.log("invalid autonat response from %p - %j",e.remotePeer,c);return}const l=c.dialResponse.status;if(this.log.trace("autonat response from %p for %a is %s",e.remotePeer,r.multiaddr,l),l!==Ke.ResponseStatus.OK&&l!==Ke.ResponseStatus.E_DIAL_ERROR)return;if(i=this.dialResults.get(r.multiaddr.toString()),i==null){this.log.trace("peer reported %a as %s but there is no result object",r.multiaddr,c.dialResponse.status);return}if(i.networkSegments.includes(t)){this.log.trace("%a results included network segment %s",r.multiaddr,t);return}if(i.result!=null){this.log.trace("already resolved result for %a, ignoring response from",r.multiaddr,e.remotePeer);return}if(i.verifyingPeers.has(e.remotePeer)){this.log.trace("peer %p has already verified %a, ignoring response",e.remotePeer,r.multiaddr);return}if(i.verifyingPeers.add(e.remotePeer),i.networkSegments.push(t),l===Ke.ResponseStatus.OK){if(i.success++,i.type!=="observed"){this.confirmAddress(i);return}}else l===Ke.ResponseStatus.E_DIAL_ERROR&&i.failure++;this.log("%a success %d failure %d",i.multiaddr,i.success,i.failure),i.success===qI&&this.confirmAddress(i),i.failure===HI&&this.unconfirmAddress(i)}finally{try{await o.close({signal:s})}catch(a){o.abort(a)}}}hasConnectionCapacity(){const t=this.components.connectionManager.getConnections().length,r=this.components.connectionManager.getMaxConnections();return t/r*100<this.connectionThreshold}confirmAddress(e){this.log("%s address %a is externally dialable",e.type,e.multiaddr),this.components.addressManager.confirmObservedAddr(e.multiaddr),this.dialResults.delete(e.multiaddr.toString()),e.result=!0,e.queue.abort()}unconfirmAddress(e){this.log("%s address %a is not externally dialable",e.type,e.multiaddr),this.components.addressManager.removeObservedAddr(e.multiaddr),this.dialResults.delete(e.multiaddr.toString()),e.result=!1,e.queue.abort()}getNetworkSegment(e){const t=e.toOptions();return t.family===4?t.host.split(".")[0].padStart(3,"0"):t.host.split(":")[0].padStart(4,"0")}}function KI(n={}){return e=>new zI(e,n)}const WI=q("dns4"),GI=q("dns6"),jI=q("dnsaddr"),qi=rt(q("dns"),jI,WI,GI),kd=rt(q("ip4"),q("ip6")),Vs=rt(ne(kd,q("tcp")),ne(qi,q("tcp"))),_d=ne(kd,q("udp")),QI=ne(_d,q("utp")),YI=ne(_d,q("quic")),XI=ne(_d,q("quic-v1")),Y1=rt(ne(Vs,q("ws")),ne(qi,q("ws"))),Gl=rt(ne(Y1,q("p2p")),Y1),X1=rt(ne(Vs,q("wss")),ne(qi,q("wss")),ne(Vs,q("tls"),q("ws")),ne(qi,q("tls"),q("ws"))),jl=rt(ne(X1,q("p2p")),X1),Z1=rt(ne(Vs,q("http")),ne(kd,q("http")),ne(qi,q("http"))),J1=rt(ne(Vs,q("https")),ne(kd,q("https")),ne(qi,q("https"))),x3=ne(_d,q("webrtc-direct"),q("certhash")),O8=rt(ne(x3,q("p2p")),x3),A3=ne(XI,q("webtransport"),q("certhash"),q("certhash")),N8=rt(ne(A3,q("p2p")),A3),D8=rt(ne(Gl,q("p2p-webrtc-star"),q("p2p")),ne(jl,q("p2p-webrtc-star"),q("p2p")),ne(Gl,q("p2p-webrtc-star")),ne(jl,q("p2p-webrtc-star")));rt(ne(Gl,q("p2p-websocket-star"),q("p2p")),ne(jl,q("p2p-websocket-star"),q("p2p")),ne(Gl,q("p2p-websocket-star")),ne(jl,q("p2p-websocket-star")));const L8=rt(ne(Z1,q("p2p-webrtc-direct"),q("p2p")),ne(J1,q("p2p-webrtc-direct"),q("p2p")),ne(Z1,q("p2p-webrtc-direct")),ne(J1,q("p2p-webrtc-direct"))),Hi=rt(Y1,X1,Z1,J1,D8,L8,Vs,QI,YI,qi,O8,N8);rt(ne(Hi,q("p2p-stardust"),q("p2p")),ne(Hi,q("p2p-stardust")));const Gn=rt(ne(Hi,q("p2p")),D8,L8,O8,N8,q("p2p")),k3=rt(ne(Gn,q("p2p-circuit"),Gn),ne(Gn,q("p2p-circuit")),ne(q("p2p-circuit"),Gn),ne(Hi,q("p2p-circuit")),ne(q("p2p-circuit"),Hi),q("p2p-circuit")),B8=()=>rt(ne(k3,B8),k3),Ii=B8(),ZI=rt(ne(Ii,Gn,Ii),ne(Gn,Ii),ne(Ii,Gn),Ii,Gn);rt(ne(Ii,q("webrtc"),q("p2p")),ne(Ii,q("webrtc")),ne(Hi,q("webrtc"),q("p2p")),ne(Hi,q("webrtc")),q("webrtc"));function M8(n){function e(t){let r;try{r=ue(t)}catch{return!1}const i=n(r.protoNames());return i===null?!1:i===!0||i===!1?i:i.length===0}return e}function ne(...n){function e(t){if(t.length<n.length)return null;let r=t;return n.some(i=>(r=typeof i=="function"?i().partialMatch(t):i.partialMatch(t),Array.isArray(r)&&(t=r),r===null)),r}return{toString:function(){return"{ "+n.join(" ")+" }"},input:n,matches:M8(e),partialMatch:e}}function rt(...n){function e(r){let i=null;return n.some(s=>{const o=typeof s=="function"?s().partialMatch(r):s.partialMatch(r);return o!=null?(i=o,!0):!1}),i}return{toString:function(){return"{ "+n.join(" ")+" }"},input:n,matches:M8(e),partialMatch:e}}function q(n){const e=n;function t(i){let s;try{s=ue(i)}catch{return!1}const o=s.protoNames();return o.length===1&&o[0]===e}function r(i){return i.length===0?null:i[0]===e?i.slice(1):null}return{toString:function(){return e},matches:t,partialMatch:r}}const JI="bootstrap",eC=50,tC=1e3;class rC extends tt{static tag="bootstrap";log;timer;list;timeout;components;_init;constructor(e,t={list:[]}){if(t.list==null||t.list.length===0)throw new Error("Bootstrap requires a list of peer addresses");super(),this.components=e,this.log=e.logger.forComponent("libp2p:bootstrap"),this.timeout=t.timeout??tC,this.list=[];for(const r of t.list){if(!ZI.matches(r)){this.log.error("Invalid multiaddr");continue}const i=ue(r),s=i.getPeerId();if(s==null){this.log.error("Invalid bootstrap multiaddr without peer id");continue}const o={id:Ot(s),multiaddrs:[i]};this.list.push(o)}this._init=t}[Sl]=this;[Symbol.toStringTag]="@libp2p/bootstrap";[St]=["@libp2p/peer-discovery"];isStarted(){return!!this.timer}start(){this.isStarted()||(this.log("Starting bootstrap node discovery, discovering peers after %s ms",this.timeout),this.timer=setTimeout(()=>{this._discoverBootstrapPeers().catch(e=>{this.log.error(e)})},this.timeout))}async _discoverBootstrapPeers(){if(this.timer!=null)for(const e of this.list){if(await this.components.peerStore.merge(e.id,{tags:{[this._init.tagName??JI]:{value:this._init.tagValue??eC,ttl:this._init.tagTTL}},multiaddrs:e.multiaddrs}),this.timer==null)return;this.safeDispatchEvent("peer",{detail:e}),this.components.connectionManager.openConnection(e.id).catch(t=>{this.log.error("could not dial bootstrap peer %p",e.id,t)})}}stop(){this.timer!=null&&clearTimeout(this.timer),this.timer=void 0}}function nC(n){return e=>new rC(e,n)}const iC=290,sC=1,F8=2e3,oC=100,Qc=`${Qu}-circuit-relay`;BigInt(1<<17);const Ql="/libp2p/circuit/relay/0.2.0/hop",_3="/libp2p/circuit/relay/0.2.0/stop",I3=300,aC=4096,cC=.001;var qs;(function(n){(function(r){r.RESERVE="RESERVE",r.CONNECT="CONNECT",r.STATUS="STATUS"})(n.Type||(n.Type={}));let e;(function(r){r[r.RESERVE=0]="RESERVE",r[r.CONNECT=1]="CONNECT",r[r.STATUS=2]="STATUS"})(e||(e={})),(function(r){r.codec=()=>Jt(e)})(n.Type||(n.Type={}));let t;n.codec=()=>(t==null&&(t=pe((r,i,s={})=>{s.lengthDelimited!==!1&&i.fork(),r.type!=null&&(i.uint32(8),n.Type.codec().encode(r.type,i)),r.peer!=null&&(i.uint32(18),Hs.codec().encode(r.peer,i)),r.reservation!=null&&(i.uint32(26),Yl.codec().encode(r.reservation,i)),r.limit!=null&&(i.uint32(34),zs.codec().encode(r.limit,i)),r.status!=null&&(i.uint32(40),Mt.codec().encode(r.status,i)),s.lengthDelimited!==!1&&i.ldelim()},(r,i,s={})=>{const o={},a=i==null?r.len:r.pos+i;for(;r.pos<a;){const c=r.uint32();switch(c>>>3){case 1:{o.type=n.Type.codec().decode(r);break}case 2:{o.peer=Hs.codec().decode(r,r.uint32(),{limits:s.limits?.peer});break}case 3:{o.reservation=Yl.codec().decode(r,r.uint32(),{limits:s.limits?.reservation});break}case 4:{o.limit=zs.codec().decode(r,r.uint32(),{limits:s.limits?.limit});break}case 5:{o.status=Mt.codec().decode(r);break}default:{r.skipType(c&7);break}}}return o})),t),n.encode=r=>ge(r,n.codec()),n.decode=(r,i)=>me(r,n.codec(),i)})(qs||(qs={}));var vn;(function(n){(function(r){r.CONNECT="CONNECT",r.STATUS="STATUS"})(n.Type||(n.Type={}));let e;(function(r){r[r.CONNECT=0]="CONNECT",r[r.STATUS=1]="STATUS"})(e||(e={})),(function(r){r.codec=()=>Jt(e)})(n.Type||(n.Type={}));let t;n.codec=()=>(t==null&&(t=pe((r,i,s={})=>{s.lengthDelimited!==!1&&i.fork(),r.type!=null&&(i.uint32(8),n.Type.codec().encode(r.type,i)),r.peer!=null&&(i.uint32(18),Hs.codec().encode(r.peer,i)),r.limit!=null&&(i.uint32(26),zs.codec().encode(r.limit,i)),r.status!=null&&(i.uint32(32),Mt.codec().encode(r.status,i)),s.lengthDelimited!==!1&&i.ldelim()},(r,i,s={})=>{const o={},a=i==null?r.len:r.pos+i;for(;r.pos<a;){const c=r.uint32();switch(c>>>3){case 1:{o.type=n.Type.codec().decode(r);break}case 2:{o.peer=Hs.codec().decode(r,r.uint32(),{limits:s.limits?.peer});break}case 3:{o.limit=zs.codec().decode(r,r.uint32(),{limits:s.limits?.limit});break}case 4:{o.status=Mt.codec().decode(r);break}default:{r.skipType(c&7);break}}}return o})),t),n.encode=r=>ge(r,n.codec()),n.decode=(r,i)=>me(r,n.codec(),i)})(vn||(vn={}));var Hs;(function(n){let e;n.codec=()=>(e==null&&(e=pe((t,r,i={})=>{if(i.lengthDelimited!==!1&&r.fork(),t.id!=null&&t.id.byteLength>0&&(r.uint32(10),r.bytes(t.id)),t.addrs!=null)for(const s of t.addrs)r.uint32(18),r.bytes(s);i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{const s={id:Le(0),addrs:[]},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.id=t.bytes();break}case 2:{if(i.limits?.addrs!=null&&s.addrs.length===i.limits.addrs)throw new xt('Decode error - map field "addrs" had too many elements');s.addrs.push(t.bytes());break}default:{t.skipType(a&7);break}}}return s})),e),n.encode=t=>ge(t,n.codec()),n.decode=(t,r)=>me(t,n.codec(),r)})(Hs||(Hs={}));var Yl;(function(n){let e;n.codec=()=>(e==null&&(e=pe((t,r,i={})=>{if(i.lengthDelimited!==!1&&r.fork(),t.expire!=null&&t.expire!==0n&&(r.uint32(8),r.uint64(t.expire)),t.addrs!=null)for(const s of t.addrs)r.uint32(18),r.bytes(s);t.voucher!=null&&(r.uint32(26),Zl.codec().encode(t.voucher,r)),i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{const s={expire:0n,addrs:[]},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.expire=t.uint64();break}case 2:{if(i.limits?.addrs!=null&&s.addrs.length===i.limits.addrs)throw new xt('Decode error - map field "addrs" had too many elements');s.addrs.push(t.bytes());break}case 3:{s.voucher=Zl.codec().decode(t,t.uint32(),{limits:i.limits?.voucher});break}default:{t.skipType(a&7);break}}}return s})),e),n.encode=t=>ge(t,n.codec()),n.decode=(t,r)=>me(t,n.codec(),r)})(Yl||(Yl={}));var zs;(function(n){let e;n.codec=()=>(e==null&&(e=pe((t,r,i={})=>{i.lengthDelimited!==!1&&r.fork(),t.duration!=null&&(r.uint32(8),r.uint32(t.duration)),t.data!=null&&(r.uint32(16),r.uint64(t.data)),i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{const s={},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.duration=t.uint32();break}case 2:{s.data=t.uint64();break}default:{t.skipType(a&7);break}}}return s})),e),n.encode=t=>ge(t,n.codec()),n.decode=(t,r)=>me(t,n.codec(),r)})(zs||(zs={}));var Mt;(function(n){n.UNUSED="UNUSED",n.OK="OK",n.RESERVATION_REFUSED="RESERVATION_REFUSED",n.RESOURCE_LIMIT_EXCEEDED="RESOURCE_LIMIT_EXCEEDED",n.PERMISSION_DENIED="PERMISSION_DENIED",n.CONNECTION_FAILED="CONNECTION_FAILED",n.NO_RESERVATION="NO_RESERVATION",n.MALFORMED_MESSAGE="MALFORMED_MESSAGE",n.UNEXPECTED_MESSAGE="UNEXPECTED_MESSAGE"})(Mt||(Mt={}));var ef;(function(n){n[n.UNUSED=0]="UNUSED",n[n.OK=100]="OK",n[n.RESERVATION_REFUSED=200]="RESERVATION_REFUSED",n[n.RESOURCE_LIMIT_EXCEEDED=201]="RESOURCE_LIMIT_EXCEEDED",n[n.PERMISSION_DENIED=202]="PERMISSION_DENIED",n[n.CONNECTION_FAILED=203]="CONNECTION_FAILED",n[n.NO_RESERVATION=204]="NO_RESERVATION",n[n.MALFORMED_MESSAGE=400]="MALFORMED_MESSAGE",n[n.UNEXPECTED_MESSAGE=401]="UNEXPECTED_MESSAGE"})(ef||(ef={}));(function(n){n.codec=()=>Jt(ef)})(Mt||(Mt={}));var Xl;(function(n){let e;n.codec=()=>(e==null&&(e=pe((t,r,i={})=>{i.lengthDelimited!==!1&&r.fork(),t.relay!=null&&t.relay.byteLength>0&&(r.uint32(10),r.bytes(t.relay)),t.peer!=null&&t.peer.byteLength>0&&(r.uint32(18),r.bytes(t.peer)),t.expiration!=null&&t.expiration!==0n&&(r.uint32(24),r.uint64(t.expiration)),i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{const s={relay:Le(0),peer:Le(0),expiration:0n},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.relay=t.bytes();break}case 2:{s.peer=t.bytes();break}case 3:{s.expiration=t.uint64();break}default:{t.skipType(a&7);break}}}return s})),e),n.encode=t=>ge(t,n.codec()),n.decode=(t,r)=>me(t,n.codec(),r)})(Xl||(Xl={}));var Zl;(function(n){let e;n.codec=()=>(e==null&&(e=pe((t,r,i={})=>{i.lengthDelimited!==!1&&r.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(r.uint32(10),r.bytes(t.publicKey)),t.payloadType!=null&&t.payloadType.byteLength>0&&(r.uint32(18),r.bytes(t.payloadType)),t.payload!=null&&(r.uint32(26),Xl.codec().encode(t.payload,r)),t.signature!=null&&t.signature.byteLength>0&&(r.uint32(42),r.bytes(t.signature)),i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{const s={publicKey:Le(0),payloadType:Le(0),signature:Le(0)},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.publicKey=t.bytes();break}case 2:{s.payloadType=t.bytes();break}case 3:{s.payload=Xl.codec().decode(t,t.uint32(),{limits:i.limits?.payload});break}case 5:{s.signature=t.bytes();break}default:{t.skipType(a&7);break}}}return s})),e),n.encode=t=>ge(t,n.codec()),n.decode=(t,r)=>me(t,n.codec(),r)})(Zl||(Zl={}));class C3 extends Error{static name="HadEnoughRelaysError";name="HadEnoughRelaysError"}class lC extends Error{static name="DoubleRelayError";name="DoubleRelayError"}class uC extends Error{static name="RelayQueueFullError";name="RelayQueueFullError"}function T3(n){const e=n*BigInt(1e3),t=new Date().getTime();return Number(e-BigInt(t))}class R3{expires;bytes;constructor(e){e?.duration!=null&&e?.duration!==0&&(this.expires=Date.now()+e.duration*1e3),this.bytes=e?.data,this.bytes===0n&&(this.bytes=void 0),this.onData=this.onData.bind(this)}onData(e){this.bytes!=null&&(this.bytes-=BigInt(e.byteLength),this.bytes<0n&&(this.bytes=0n))}getLimits(){if(this.expires==null&&this.bytes==null)return;const e={};if(this.bytes!=null){const t=this;Object.defineProperty(e,"bytes",{get(){return t.bytes}})}if(this.expires!=null){const t=this;Object.defineProperty(e,"seconds",{get(){return Math.round(((t.expires??0)-Date.now())/1e3)}})}return e}}const U8=Me(Pe(k6.matchers[0],Fe(sc))),$8=Me(Fe(sc));function P3(n){const{stream:e,remoteAddr:t,log:r,onDataRead:i,onDataWrite:s}=n;let o=!1,a=!1;const c=e.close.bind(e);e.close=async f=>{await c(f),h(!0)};const l=e.abort.bind(e);e.abort=f=>{l(f),h(!0)};const u=e.sink.bind(e);e.sink=async f=>{try{await u(rr(f,m=>Tl(m,y=>s?.(y))))}catch(m){d.log.error("errored - %e",m),m.type!=="aborted"&&d.log.error("%s error in sink - %e",t,m)}finally{a=!0,h()}};const d={log:r.newScope("stream-to-maconn"),sink:e.sink,source:(async function*(){try{for await(const f of e.source)i?.(f),yield f}finally{o=!0,h()}})(),remoteAddr:t,timeline:{open:Date.now(),close:void 0},close:e.close,abort:e.abort};function h(f){f===!0&&(o=!0,a=!0),o&&a&&d.timeline.close==null&&(d.timeline.close=Date.now())}return d}class dC extends tt{components;started;running;topologyId;log;discoveryController;filter;queue;constructor(e,t={}){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:discover-relays"),this.components=e,this.started=!1,this.running=!1,this.filter=t.filter,this.discoveryController=new AbortController,this.discoveryController.signal,this.dialPeer=this.dialPeer.bind(this),this.onPeer=this.onPeer.bind(this)}isStarted(){return this.started}async start(){this.topologyId=await this.components.registrar.register(Ql,{filter:this.filter,onConnect:e=>{this.log.trace("discovered relay %p queue (length: %d, active %d)",e,this.queue?.size,this.queue?.running),this.safeDispatchEvent("relay:discover",{detail:e})}}),this.started=!0}stop(){this.topologyId!=null&&this.components.registrar.unregister(this.topologyId),this.running&&this.stopDiscovery(),this.started=!1}startDiscovery(){this.running||(this.log("start discovery"),this.running=!0,this.discoveryController=new AbortController,this.discoveryController.signal,this.components.events.addEventListener("peer:discovery",this.onPeer),Promise.resolve().then(async()=>{this.log("searching peer store for relays");const e=await this.components.peerStore.all({filters:[r=>r.protocols.includes(Ql)],orders:[()=>Math.random()<.5?1:-1,(r,i)=>{const s=O3(r),o=O3(i);return s>o?-1:o>s?1:0}]});for(const r of e)this.log.trace("found relay peer %p in peer store",r.id),this.safeDispatchEvent("relay:discover",{detail:r.id});this.log("found %d relay peers in peer store",e.length);const t=this.queue=new oi({concurrency:5});this.log("start random walk");for await(const r of this.components.randomWalk.walk({signal:this.discoveryController.signal})){if(this.log.trace("found random peer %p",r.id),t.has(r.id)){this.log.trace("random peer %p was already in queue",r.id);continue}if(this.components.connectionManager.getConnections(r.id)?.length>0){this.log.trace("random peer %p was already connected",r.id);continue}if(!await this.components.connectionManager.isDialable(r.multiaddrs)){this.log.trace("random peer %p was not dialable",r.id,r.multiaddrs.map(i=>i.toString()));continue}t.queued>10&&(this.log.trace("wait for space in queue for %p",r.id),await t.onSizeLessThan(10,{signal:this.discoveryController.signal})),this.log("adding random peer %p to dial queue (length: %d, active %d)",r.id,t.size,t.running),t.add(this.dialPeer,{peerId:r.id,signal:this.discoveryController.signal}).catch(i=>{this.log.error("error opening connection to random peer %p",r.id,i)})}this.log("stop random walk"),await t.onIdle()}).catch(e=>{this.discoveryController.signal.aborted||this.log.error("failed when finding relays on the network",e)}))}stopDiscovery(){this.log("stop discovery"),this.running=!1,this.discoveryController?.abort(),this.queue?.clear(),this.components.events.removeEventListener("peer:discovery",this.onPeer)}onPeer(e){this.log.trace("maybe dialing discovered peer %p - %e",e.detail.id),this.maybeDialPeer(e).catch(t=>{this.log.trace("error dialing discovered peer %p - %e",e.detail.id,t)})}async maybeDialPeer(e){if(this.queue==null)return;const t=e.detail.id,r=e.detail.multiaddrs;if(this.queue.has(t)){this.log.trace("random peer %p was already in queue",t);return}if(this.components.connectionManager.getConnections(t)?.length>0){this.log.trace("random peer %p was already connected",t);return}if(!await this.components.connectionManager.isDialable(r)){this.log.trace("random peer %p was not dialable",t);return}this.queue?.add(this.dialPeer,{peerId:e.detail.id,signal:this.discoveryController.signal}).catch(i=>{this.log.error("error opening connection to discovered peer %p",e.detail.id,i)})}async dialPeer({peerId:e,signal:t}){const r=Re([AbortSignal.timeout(5e3),t]);try{await this.components.connectionManager.openConnection(e,{signal:r})}finally{r.clear()}}}function O3(n){const e=n.metadata.get("last-dial-success");return e==null?0:new Date(ee(e)).getTime()}class hC extends tt{connectionManager;addressManager;reservationStore;listeningAddrs;log;listenTimeout;reservationId;relay;constructor(e,t={}){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:transport:listener"),this.connectionManager=e.connectionManager,this.addressManager=e.addressManager,this.reservationStore=e.reservationStore,this.listeningAddrs=[],this.listenTimeout=t.listenTimeout??F8,this.reservationStore.addEventListener("relay:removed",this._onRemoveRelayPeer),this.reservationStore.addEventListener("relay:created-reservation",this._onAddRelayPeer)}_onRemoveRelayPeer=e=>{this.log("relay removed %p our relay %p",e.detail.relay,this.relay,this.relay?.equals(e.detail.relay)),this.relay?.equals(e.detail.relay)===!0&&(this.log("relay peer removed %p",e.detail.relay),this.listeningAddrs.forEach(t=>{this.addressManager.removeObservedAddr(t)}),this.listeningAddrs=[],this.safeDispatchEvent("listening"))};_onAddRelayPeer=e=>{const{details:t}=e.detail;t.type!=="configured"&&t.id===this.reservationId&&this.addedRelay(e.detail)};async listen(e){if($8.exactMatch(e))this.log("searching for circuit relay servers"),this.reservationId=this.reservationStore.reserveRelay();else if(U8.exactMatch(e)){this.log("listen on specific relay server %a",e);const t=AbortSignal.timeout(this.listenTimeout),r=e.decapsulate("/p2p-circuit"),i=await this.connectionManager.openConnection(r,{signal:t});if(!this.reservationStore.hasReservation(i.remotePeer)){this.log("making reservation on peer %p",i.remotePeer);const s=await this.reservationStore.addRelay(i.remotePeer,"configured");this.addedRelay(s)}}else throw new x1(`Could not listen on p2p-circuit address "${e}"`)}getAddrs(){return[...this.listeningAddrs.values()].flat()}updateAnnounceAddrs(){}async close(){this.reservationStore.cancelReservations(),this.listeningAddrs=[],this.reservationStore.removeEventListener("relay:removed",this._onRemoveRelayPeer),queueMicrotask(()=>{this.safeDispatchEvent("close")})}addedRelay(e){this.log("relay peer added %p",e.relay),this.relay=e.relay,this.listeningAddrs=e.details.reservation.addrs.map(t=>ue(t).encapsulate("/p2p-circuit")),this.listeningAddrs.forEach(t=>{this.addressManager.confirmObservedAddr(t,{type:"transport"})}),queueMicrotask(()=>{this.safeDispatchEvent("listening")})}}function fC(n){return new hC(n)}const pC=60*1e3*10,gC=60*1e3*5,mC=30*1e3;class yC extends tt{peerId;connectionManager;peerStore;events;reserveQueue;reservations;pendingReservations;maxReservationQueueLength;reservationCompletionTimeout;started;log;relayFilter;constructor(e,t){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:transport:reservation-store"),this.peerId=e.peerId,this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.events=e.events,this.reservations=new ns,this.pendingReservations=[],this.maxReservationQueueLength=t?.maxReservationQueueLength??oC,this.reservationCompletionTimeout=t?.reservationCompletionTimeout??F8,this.started=!1,this.relayFilter=ai(100),this.reserveQueue=new oi({concurrency:t?.reservationConcurrency??sC,metricName:"libp2p_relay_reservation_queue",metrics:e.metrics}),this.events.addEventListener("connection:close",r=>{[...this.reservations.values()].find(s=>s.connection===r.detail.id)!=null&&this.#t(r.detail.remotePeer).catch(s=>{this.log("could not remove relay %p - %e",r.detail,s)})})}isStarted(){return this.started}start(){this.started=!0}afterStart(){Promise.resolve().then(async()=>{const e=await this.peerStore.all({filters:[t=>t.tags.has(Qc)]});this.log("removing tag from %d old relays",e.length),await Promise.all(e.map(async t=>{await this.peerStore.merge(t.id,{tags:{[Qc]:void 0}})})),this.log("redialing %d old relays",e.length),await Promise.all(e.map(async t=>this.addRelay(t.id,"discovered"))),this.#r()}).catch(e=>{this.log.error(e)})}stop(){this.reserveQueue.clear(),this.reservations.forEach(({timeout:e})=>{clearTimeout(e)}),this.reservations.clear(),this.started=!1}reserveRelay(){const e=zw();return this.pendingReservations.push(e),this.#r(),e}async addRelay(e,t){if(this.peerId.equals(e))throw this.log.trace("not trying to use self as relay"),new x1("Cannot use self as relay");if(this.reserveQueue.size>this.maxReservationQueueLength)throw new uC("The reservation queue is full");const r=this.reserveQueue.find(e);if(r!=null)return this.log.trace("potential relay peer %p is already in the reservation queue",e),r.join();if(this.relayFilter.has(e.toMultihash().bytes))throw new x1("The relay was previously invalid");return this.log.trace("try to reserve relay slot with %p",e),this.reserveQueue.add(async()=>{const i=Date.now();try{const s=this.reservations.get(e);if(s!=null){const m=this.connectionManager.getConnections(e);let y=!1;if(m.length===0&&this.log("already have relay reservation with %p but we are no longer connected",e),m.map(w=>w.id).includes(s.connection)&&(this.log("already have relay reservation with %p and the original connection is still open",e),y=!0),y&&T3(s.reservation.expire)>pC)return this.log("already have relay reservation with %p but we are still connected and it does not expire soon",e),{relay:e,details:s};await this.#t(e)}if(t==="discovered"&&this.pendingReservations.length===0)throw new C3("Not making reservation on discovered relay because we do not need any more relays");const o=AbortSignal.timeout(this.reservationCompletionTimeout);const a=await this.connectionManager.openConnection(e,{signal:o});if(ci.matches(a.remoteAddr))throw new lC("not creating reservation over relayed connection");const c=await this.#e(a,{signal:o}),l=T3(c.expire);this.log("created reservation on relay peer %p, expiry date is %s",e,new Date(Date.now()+l).toString());const u=Math.min(Math.max(l-gC,mC),Math.pow(2,31)-1),d=setTimeout(()=>{this.log("refresh reservation to relay %p",e),this.addRelay(e,t).catch(async m=>{this.log.error("could not refresh reservation to relay %p - %e",e,m),await this.#t(e)}).catch(m=>{this.log.error("could not remove expired reservation to relay %p - %e",e,m)})},u);let h;if(t==="discovered"){const m=this.pendingReservations.pop();if(m==null)throw new C3("Made reservation on relay but did not need any more discovered relays");h={timeout:d,reservation:c,type:t,connection:a.id,id:m}}else h={timeout:d,reservation:c,type:t,connection:a.id};this.reservations.set(e,h),await this.peerStore.merge(e,{tags:{[Qc]:{value:1,ttl:l}}}),this.#r();const f={relay:e,details:h};return this.safeDispatchEvent("relay:created-reservation",{detail:f}),f}catch(s){throw t==="discovered"&&s.name==="HadEnoughRelaysError"||this.log.error("could not reserve slot on %p after %dms - %e",e,Date.now()-i,s),(s.name==="DialError"||s.name==="UnsupportedProtocolError")&&this.relayFilter.add(e.toMultihash().bytes),this.#t(e).catch(o=>{this.log.error("could not remove reservation on %p after reserving slot failed - %e",e,o)}),s}},{peerId:e})}hasReservation(e){return this.reservations.has(e)}getReservation(e){return this.reservations.get(e)?.reservation}reservationCount(e){return e==null?this.reservations.size:[...this.reservations.values()].reduce((t,r)=>(r.type===e&&t++,t),0)}cancelReservations(){[...this.reservations.values()].forEach(e=>{clearTimeout(e.timeout)}),this.reservations.clear()}async#e(e,t){t.signal?.throwIfAborted(),this.log("requesting reservation from %p",e.remotePeer);const r=await e.newStream(Ql,t),s=Nt(r).pb(qs);this.log.trace("send RESERVE to %p",e.remotePeer),await s.write({type:qs.Type.RESERVE},t);let o;try{this.log.trace("reading response from %p",e.remotePeer),o=await s.read(t)}catch(c){throw r.abort(c),c}finally{r.status!=="closed"&&await r.close(t)}if(this.log.trace("read response %o",o),o.status===Mt.OK&&o.reservation!=null){const c=new Set;c.add(e.remoteAddr.toString());for(const l of o.reservation.addrs){let u=ue(l);u.getPeerId()==null&&(u=u.encapsulate(`/p2p/${e.remotePeer}`)),u=ue(u.toString().replace(`/p2p/${e.remotePeer}/p2p/${e.remotePeer}`,`/p2p/${e.remotePeer}`)),c.add(u.toString())}return o.reservation.addrs=[...c].map(l=>ue(l).bytes),o.reservation}const a=`reservation failed with status ${o.status??"undefined"}`;throw this.log.error(a),new Error(a)}async#t(e){const t=this.reservations.get(e);t!=null&&(this.log("removing relay reservation with %p from local store",e),clearTimeout(t.timeout),this.reservations.delete(e),t.type==="discovered"&&this.pendingReservations.push(t.id),await this.peerStore.merge(e,{tags:{[Qc]:void 0}}),this.safeDispatchEvent("relay:removed",{detail:{relay:e,details:t}}),this.#r())}#r(){if(this.pendingReservations.length===0){this.log.trace("have discovered enough relays"),this.reserveQueue.clear(),this.safeDispatchEvent("relay:found-enough-relays");return}this.relayFilter=ai(100),this.log("not discovered enough relays %d/%d",this.reservations.size,this.pendingReservations.length),this.safeDispatchEvent("relay:not-enough-relays")}}const wC=n=>{if(n.peer==null)return!1;try{n.peer.addrs.forEach(ue)}catch{return!1}return!0},N3={maxInboundStopStreams:I3,maxOutboundStopStreams:I3};class vC{discovery;registrar;peerStore;connectionManager;transportManager;peerId;upgrader;addressManager;connectionGater;reservationStore;logger;maxInboundStopStreams;maxOutboundStopStreams;started;log;shutdownController;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:circuit-relay:transport"),this.registrar=e.registrar,this.peerStore=e.peerStore,this.connectionManager=e.connectionManager,this.transportManager=e.transportManager,this.logger=e.logger,this.peerId=e.peerId,this.upgrader=e.upgrader,this.addressManager=e.addressManager,this.connectionGater=e.connectionGater,this.maxInboundStopStreams=t.maxInboundStopStreams??N3.maxInboundStopStreams,this.maxOutboundStopStreams=t.maxOutboundStopStreams??N3.maxOutboundStopStreams,this.shutdownController=new AbortController,this.discovery=new dC(e,{filter:t.discoveryFilter??Sb(aC,cC)}),this.discovery.addEventListener("relay:discover",r=>{this.reservationStore.addRelay(r.detail,"discovered").catch(i=>{i.name!=="HadEnoughRelaysError"&&i.name!=="RelayQueueFullError"&&this.log.error("could not add discovered relay %p",r.detail,i)})}),this.reservationStore=new yC(e,t),this.reservationStore.addEventListener("relay:not-enough-relays",()=>{this.discovery?.startDiscovery()}),this.reservationStore.addEventListener("relay:found-enough-relays",()=>{this.discovery?.stopDiscovery()}),this.started=!1}[Symbol.toStringTag]="@libp2p/circuit-relay-v2-transport";[St]=["@libp2p/transport","@libp2p/circuit-relay-v2-transport"];get[Mi](){return this.discovery!=null?["@libp2p/identify"]:[]}[Yu]=!0;isStarted(){return this.started}async start(){this.shutdownController=new AbortController,this.shutdownController.signal,await this.registrar.handle(_3,e=>{const t=this.upgrader.createInboundAbortSignal(this.shutdownController.signal);this.onStop(e,t).catch(r=>{this.log.error("error while handling STOP protocol",r),e.stream.abort(r)}).finally(()=>{t.clear()})},{maxInboundStreams:this.maxInboundStopStreams,maxOutboundStreams:this.maxOutboundStopStreams,runOnLimitedConnection:!0}),await Sn(this.discovery,this.reservationStore),this.started=!0}async stop(){this.shutdownController.abort(),await hi(this.discovery,this.reservationStore),await this.registrar.unhandle(_3),this.started=!1}async dial(e,t){if(e.protoCodes().filter(f=>f===iC).length!==1){const f="Invalid circuit relay address";throw this.log.error(f,e),new ia(f)}const r=e.toString().split("/p2p-circuit"),i=ue(r[0]),s=ue(r[r.length-1]),o=i.getPeerId(),a=s.getPeerId();if(o==null||a==null){const f=`ircuit relay dial to ${e.toString()} failed as address did not have both relay and destination PeerIDs`;throw this.log.error(`c${f}`),new ia(`C${f}`)}const c=Ot(o),l=Ot(a);let d=this.connectionManager.getConnections(c)[0];d==null?(await this.peerStore.merge(c,{multiaddrs:[i]}),t.onProgress?.(new P("circuit-relay:open-connection")),d=await this.connectionManager.openConnection(c,t)):t.onProgress?.(new P("circuit-relay:reuse-connection"));let h;try{t.onProgress?.(new P("circuit-relay:open-hop-stream")),h=await d.newStream(Ql,t);const f=Nt(h),m=f.pb(qs);t.onProgress?.(new P("circuit-relay:write-connect-message")),await m.write({type:qs.Type.CONNECT,peer:{id:l.toMultihash().bytes,addrs:[ue(s).bytes]}},t),t.onProgress?.(new P("circuit-relay:read-connect-response"));const y=await m.read(t);if(y.status!==Mt.OK)throw new qe(`failed to connect via relay with status ${y?.status?.toString()??"undefined"}`);const w=new R3(y.limit),E=P3({stream:f.unwrap(),remoteAddr:e,localAddr:i.encapsulate(`/p2p-circuit/p2p/${this.peerId.toString()}`),log:this.log,onDataRead:w.onData,onDataWrite:w.onData}),A=await this.upgrader.upgradeOutbound(E,{...t,limits:w.getLimits()});return A.log("outbound relayed connection established to %p with limits %o, over connection %s",A.remotePeer,y.limit??"none",d.id),A}catch(f){throw this.log.error("circuit relay dial to destination %p via relay %p failed",l,c,f),h?.abort(f),f}}createListener(e){return fC({peerId:this.peerId,connectionManager:this.connectionManager,addressManager:this.addressManager,reservationStore:this.reservationStore,logger:this.logger})}listenFilter(e){return e=Array.isArray(e)?e:[e],e.filter(t=>U8.exactMatch(t)||$8.exactMatch(t))}dialFilter(e){return e=Array.isArray(e)?e:[e],e.filter(t=>ci.exactMatch(t))}async onStop({connection:e,stream:t},r){if(!this.reservationStore.hasReservation(e.remotePeer))try{this.log("dialed via relay we did not have a reservation on, start listening on that relay address"),await this.transportManager.listen([e.remoteAddr.encapsulate("/p2p-circuit")])}catch(u){this.log.error("failed to listen on a relay peer we were dialed via but did not have a reservation on",u)}const i=Nt(t).pb(vn),s=await i.read({signal:r});if(this.log("new circuit relay v2 stop stream from %p with type %s",e.remotePeer,s.type),s?.type===void 0){this.log.error("type was missing from circuit v2 stop protocol request from %s",e.remotePeer),await i.write({type:vn.Type.STATUS,status:Mt.MALFORMED_MESSAGE},{signal:r}),await t.close();return}if(s.type!==vn.Type.CONNECT){this.log.error("invalid stop connect request via peer %p",e.remotePeer),await i.write({type:vn.Type.STATUS,status:Mt.UNEXPECTED_MESSAGE},{signal:r}),await t.close();return}if(!wC(s)){this.log.error("invalid stop connect request via peer %p",e.remotePeer),await i.write({type:vn.Type.STATUS,status:Mt.MALFORMED_MESSAGE},{signal:r}),await t.close({signal:r});return}const o=Pn(zt(s.peer.id));if(await this.connectionGater.denyInboundRelayedConnection?.(e.remotePeer,o)===!0){this.log.error("connection gater denied inbound relayed connection from %p",e.remotePeer),await i.write({type:vn.Type.STATUS,status:Mt.PERMISSION_DENIED},{signal:r}),await t.close({signal:r});return}this.log.trace("sending success response to %p",e.remotePeer),await i.write({type:vn.Type.STATUS,status:Mt.OK},{signal:r});const a=new R3(s.limit),c=e.remoteAddr.encapsulate(`/p2p-circuit/p2p/${o.toString()}`);this.addressManager.getAddresses()[0];const l=P3({stream:i.unwrap().unwrap(),remoteAddr:c,log:this.log,onDataRead:a.onData,onDataWrite:a.onData});await this.upgrader.upgradeInbound(l,{limits:a.getLimits(),signal:r}),l.log("inbound relayed connection established to %p with limits %o, over connection %s",o,s.limit??"none",e.id)}}function bC(n={}){return e=>new vC(e,n)}var Jr;(function(n){(function(r){r.UNUSED="UNUSED",r.CONNECT="CONNECT",r.SYNC="SYNC"})(n.Type||(n.Type={}));let e;(function(r){r[r.UNUSED=0]="UNUSED",r[r.CONNECT=100]="CONNECT",r[r.SYNC=300]="SYNC"})(e||(e={})),(function(r){r.codec=()=>Jt(e)})(n.Type||(n.Type={}));let t;n.codec=()=>(t==null&&(t=pe((r,i,s={})=>{if(s.lengthDelimited!==!1&&i.fork(),r.type!=null&&(i.uint32(8),n.Type.codec().encode(r.type,i)),r.observedAddresses!=null)for(const o of r.observedAddresses)i.uint32(18),i.bytes(o);s.lengthDelimited!==!1&&i.ldelim()},(r,i,s={})=>{const o={observedAddresses:[]},a=i==null?r.len:r.pos+i;for(;r.pos<a;){const c=r.uint32();switch(c>>>3){case 1:{o.type=n.Type.codec().decode(r);break}case 2:{if(s.limits?.observedAddresses!=null&&o.observedAddresses.length===s.limits.observedAddresses)throw new xt('Decode error - map field "observedAddresses" had too many elements');o.observedAddresses.push(r.bytes());break}default:{r.skipType(c&7);break}}}return o})),t),n.encode=r=>ge(r,n.codec()),n.decode=(r,i)=>me(r,n.codec(),i)})(Jr||(Jr={}));function D3(n,e){return ci.matches(n)||e.dialTransportForMultiaddr(n)==null?!1:w6.matches(n)?!0:$E.matches(n)?fi(n.toOptions().host)===!1:!1}const L3=1024*4,B3=100,Yc={timeout:5e3,retries:3,maxInboundStreams:1,maxOutboundStreams:1};class EC{started;timeout;retries;maxInboundStreams;maxOutboundStreams;peerStore;registrar;connectionManager;addressManager;transportManager;topologyId;log;constructor(e,t){this.log=e.logger.forComponent("libp2p:dcutr"),this.started=!1,this.peerStore=e.peerStore,this.registrar=e.registrar,this.addressManager=e.addressManager,this.connectionManager=e.connectionManager,this.transportManager=e.transportManager,this.timeout=t.timeout??Yc.timeout,this.retries=t.retries??Yc.retries,this.maxInboundStreams=t.maxInboundStreams??Yc.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams??Yc.maxOutboundStreams}[Symbol.toStringTag]="@libp2p/dcutr";[Mi]=["@libp2p/identify"];isStarted(){return this.started}async start(){this.started||(this.topologyId=await this.registrar.register(Xc,{notifyOnLimitedConnection:!0,onConnect:(e,t)=>{ci.exactMatch(t.remoteAddr)&&t.direction==="inbound"&&this.upgradeInbound(t).catch(r=>{this.log.error("error during outgoing DCUtR attempt",r)})}}),await this.registrar.handle(Xc,e=>{this.handleIncomingUpgrade(e.stream,e.connection).catch(t=>{this.log.error("error during incoming DCUtR attempt",t),e.stream.abort(t)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:!0}),this.started=!0)}async stop(){await this.registrar.unhandle(Xc),this.topologyId!=null&&this.registrar.unregister(this.topologyId),this.started=!1}async upgradeInbound(e){if(await this.attemptUnilateralConnectionUpgrade(e))return;let t;for(let r=0;r<this.retries;r++){const i={signal:AbortSignal.timeout(this.timeout)};try{t=await e.newStream([Xc],{signal:i.signal,runOnLimitedConnection:!0});const s=Nt(t,{maxDataLength:L3}).pb(Jr);this.log("B sending connect to %p",e.remotePeer);const o=Date.now();await s.write({type:Jr.Type.CONNECT,observedAddresses:this.addressManager.getAddresses().map(d=>d.bytes)},i),this.log("B receiving connect from %p",e.remotePeer);const a=await s.read(i);if(a.type!==Jr.Type.CONNECT)throw this.log("A sent wrong message type"),new qe("DCUtR message type was incorrect");const c=this.getDialableMultiaddrs(a.observedAddresses);if(c.length===0)throw this.log("A did not have any dialable multiaddrs"),new qe("DCUtR connect message had no multiaddrs");const l=Date.now()-o;this.log("A sending sync, rtt %dms",l),await s.write({type:Jr.Type.SYNC,observedAddresses:[]},i),this.log("A waiting for half RTT"),await J6(l/2),this.log("B dialing",c);const u=await this.connectionManager.openConnection(c,{signal:i.signal,priority:B3,force:!0,initiator:!1});this.log("DCUtR to %p succeeded to address %a, closing relayed connection",e.remotePeer,u.remoteAddr),await e.close(i);break}catch(s){if(this.log.error("error while attempting DCUtR on attempt %d of %d",r+1,this.retries,s),t?.abort(s),r===this.retries)throw s}finally{t!=null&&await t.close(i)}}}async attemptUnilateralConnectionUpgrade(e){const r=(await this.peerStore.get(e.remotePeer)).addresses.map(i=>{const s=i.multiaddr;return s.getPeerId()==null?s.encapsulate(`/p2p/${e.remotePeer}`):s}).filter(i=>D3(i,this.transportManager));if(r.length>0){const i=AbortSignal.timeout(this.timeout);try{this.log("attempting unilateral connection upgrade to %a",r);const s=await this.connectionManager.openConnection(r,{signal:i,force:!0});if(ci.exactMatch(s.remoteAddr))throw new Error("Could not open a new, non-limited, connection");return this.log("unilateral connection upgrade to %p succeeded via %a, closing relayed connection",e.remotePeer,s.remoteAddr),await e.close({signal:i}),!0}catch(s){this.log.error("unilateral connection upgrade to %p on addresses %a failed",e.remotePeer,r,s)}}else this.log("peer %p has no public addresses, not attempting unilateral connection upgrade",e.remotePeer);return!1}async handleIncomingUpgrade(e,t){const r={signal:AbortSignal.timeout(this.timeout)};try{const i=Nt(e,{maxDataLength:L3}).pb(Jr);this.log("A receiving connect");const s=await i.read(r);if(s.type!==Jr.Type.CONNECT)throw this.log("B sent wrong message type"),new qe("DCUtR message type was incorrect");if(s.observedAddresses.length===0)throw this.log("B sent no multiaddrs"),new qe("DCUtR connect message had no multiaddrs");const o=this.getDialableMultiaddrs(s.observedAddresses);if(o.length===0)throw this.log("B had no dialable multiaddrs"),new qe("DCUtR connect message had no dialable multiaddrs");if(this.log("A sending connect"),await i.write({type:Jr.Type.CONNECT,observedAddresses:this.addressManager.getAddresses().map(l=>l.bytes)}),this.log("A receiving sync"),(await i.read(r)).type!==Jr.Type.SYNC)throw new qe("DCUtR message type was incorrect");this.log("A dialing",o);const c=await this.connectionManager.openConnection(o,{signal:r.signal,priority:B3,force:!0});this.log("DCUtR to %p succeeded via %a, closing relayed connection",t.remotePeer,c.remoteAddr),await t.close(r)}catch(i){this.log.error("incoming DCUtR from %p failed",t.remotePeer,i),e.abort(i)}finally{await e.close(r)}}getDialableMultiaddrs(e){const t=[];for(const r of e)if(!(r==null||r.length===0))try{const i=ue(r);if(!D3(i,this.transportManager))continue;t.push(i)}catch{}return t}}const Xc="/libp2p/dcutr";function SC(n={}){return e=>new EC(e,n)}const xC="0.1.0",AC="id",kC="id/push",_C="1.0.0",IC="1.0.0",CC=1024*8,TC=32,RC=1e3;var Ks;(function(n){let e;n.codec=()=>(e==null&&(e=pe((t,r,i={})=>{if(i.lengthDelimited!==!1&&r.fork(),t.protocolVersion!=null&&(r.uint32(42),r.string(t.protocolVersion)),t.agentVersion!=null&&(r.uint32(50),r.string(t.agentVersion)),t.publicKey!=null&&(r.uint32(10),r.bytes(t.publicKey)),t.listenAddrs!=null)for(const s of t.listenAddrs)r.uint32(18),r.bytes(s);if(t.observedAddr!=null&&(r.uint32(34),r.bytes(t.observedAddr)),t.protocols!=null)for(const s of t.protocols)r.uint32(26),r.string(s);t.signedPeerRecord!=null&&(r.uint32(66),r.bytes(t.signedPeerRecord)),i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{const s={listenAddrs:[],protocols:[]},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 5:{s.protocolVersion=t.string();break}case 6:{s.agentVersion=t.string();break}case 1:{s.publicKey=t.bytes();break}case 2:{if(i.limits?.listenAddrs!=null&&s.listenAddrs.length===i.limits.listenAddrs)throw new xt('Decode error - map field "listenAddrs" had too many elements');s.listenAddrs.push(t.bytes());break}case 4:{s.observedAddr=t.bytes();break}case 3:{if(i.limits?.protocols!=null&&s.protocols.length===i.limits.protocols)throw new xt('Decode error - map field "protocols" had too many elements');s.protocols.push(t.string());break}case 8:{s.signedPeerRecord=t.bytes();break}default:{t.skipType(a&7);break}}}return s})),e),n.encode=t=>ge(t,n.codec()),n.decode=(t,r)=>me(t,n.codec(),r)})(Ks||(Ks={}));const Er={protocolPrefix:"ipfs",timeout:5e3,maxInboundStreams:1,maxOutboundStreams:1,maxObservedAddresses:10,maxMessageSize:CC,runOnConnectionOpen:!0,runOnSelfUpdate:!0,runOnLimitedConnection:!0,concurrency:TC};function PC(n){if(n!=null&&n.length>0)try{return ue(n)}catch{}}function OC(n,e){return e??n.userAgent}async function V8(n,e,t,r,i){if(t("received identify from %p",r.remotePeer),i==null)throw new qe("message was null or undefined");const s={};if(i.listenAddrs.length>0&&(s.addresses=i.listenAddrs.map(c=>({isCertified:!1,multiaddr:ue(c)}))),i.protocols.length>0&&(s.protocols=i.protocols),i.publicKey!=null){const c=Vr(i.publicKey);if(!Ca(c).equals(r.remotePeer))throw new qe("public key did not match remote PeerId");s.publicKey=c}let o;if(i.signedPeerRecord!=null){t.trace("received signedPeerRecord from %p",r.remotePeer);let c=i.signedPeerRecord;const l=await sn.openAndCertify(c,fr.DOMAIN);let u=fr.createFromProtobuf(l.payload);const d=rs(l.publicKey.toCID());if(!u.peerId.equals(d))throw new qe("signing key does not match PeerId in the PeerRecord");if(!r.remotePeer.equals(u.peerId))throw new qe("signing key does not match remote PeerId");let h;try{h=await n.get(u.peerId)}catch(f){if(f.name!=="NotFoundError")throw f}if(h!=null&&(s.metadata=h.metadata,h.peerRecordEnvelope!=null)){const f=sn.createFromProtobuf(h.peerRecordEnvelope),m=fr.createFromProtobuf(f.payload);m.seqNumber>=u.seqNumber&&(t("sequence number was lower or equal to existing sequence number - stored: %d received: %d",m.seqNumber,u.seqNumber),u=m,c=h.peerRecordEnvelope)}s.peerRecordEnvelope=c,s.addresses=u.multiaddrs.map(f=>({isCertified:!0,multiaddr:f})),o={seq:u.seqNumber,addresses:u.multiaddrs}}else t("%p did not send a signed peer record",r.remotePeer);if(t.trace("patching %p with",r.remotePeer,s),await n.patch(r.remotePeer,s),i.agentVersion!=null||i.protocolVersion!=null){const c={};i.agentVersion!=null&&(c.AgentVersion=C(i.agentVersion)),i.protocolVersion!=null&&(c.ProtocolVersion=C(i.protocolVersion)),t.trace("merging %p metadata",r.remotePeer,c),await n.merge(r.remotePeer,{metadata:c})}const a={peerId:r.remotePeer,protocolVersion:i.protocolVersion,agentVersion:i.agentVersion,publicKey:i.publicKey,listenAddrs:i.listenAddrs.map(c=>ue(c)),observedAddr:i.observedAddr==null?void 0:ue(i.observedAddr),protocols:i.protocols,signedPeerRecord:o,connection:r};return e.safeDispatchEvent("peer:identify",{detail:a}),a}class q8{host;protocol;started;timeout;peerId;privateKey;peerStore;registrar;addressManager;maxInboundStreams;maxOutboundStreams;maxMessageSize;maxObservedAddresses;events;runOnLimitedConnection;log;constructor(e,t){this.protocol=t.protocol,this.started=!1,this.peerId=e.peerId,this.privateKey=e.privateKey,this.peerStore=e.peerStore,this.registrar=e.registrar,this.addressManager=e.addressManager,this.events=e.events,this.log=t.log,this.timeout=t.timeout??Er.timeout,this.maxInboundStreams=t.maxInboundStreams??Er.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams??Er.maxOutboundStreams,this.maxMessageSize=t.maxMessageSize??Er.maxMessageSize,this.maxObservedAddresses=t.maxObservedAddresses??Er.maxObservedAddresses,this.runOnLimitedConnection=t.runOnLimitedConnection??Er.runOnLimitedConnection,this.host={protocolVersion:`${t.protocolPrefix??Er.protocolPrefix}/${xC}`,agentVersion:OC(e.nodeInfo,t.agentVersion)}}isStarted(){return this.started}async start(){this.started||(await this.peerStore.merge(this.peerId,{metadata:{AgentVersion:C(this.host.agentVersion),ProtocolVersion:C(this.host.protocolVersion)}}),await this.registrar.handle(this.protocol,e=>{this.handleProtocol(e).catch(t=>{this.log.error(t)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnection}),this.started=!0)}async stop(){await this.registrar.unhandle(this.protocol),this.started=!1}}class NC extends q8{connectionManager;concurrency;_push;constructor(e,t={}){super(e,{...t,protocol:`/${t.protocolPrefix??Er.protocolPrefix}/${kC}/${IC}`,log:e.logger.forComponent("libp2p:identify-push")}),this.connectionManager=e.connectionManager,this.concurrency=t.concurrency??Er.concurrency,this._push=Oa(this.sendPushMessage.bind(this),t.debounce??RC),(t.runOnSelfUpdate??Er.runOnSelfUpdate)&&e.events.addEventListener("self:peer:update",r=>{this.push().catch(i=>{this.log.error("error pushing updates to peers - %e",i)})})}[St]=["@libp2p/identify-push"];async push(){this._push()}async sendPushMessage(){if(this.isStarted())try{const e=this.addressManager.getAddresses().map(u=>u.decapsulateCode(so("p2p").code)),t=new fr({peerId:this.peerId,multiaddrs:e}),r=await sn.seal(t,this.privateKey),i=this.registrar.getProtocols(),s=await this.peerStore.get(this.peerId),o=ee(s.metadata.get("AgentVersion")??C(this.host.agentVersion)),a=ee(s.metadata.get("ProtocolVersion")??C(this.host.protocolVersion)),c=this;async function*l(){for(const u of c.connectionManager.getConnections()){const d=await c.peerStore.get(u.remotePeer),h=u.log.newScope("identify-push");d.protocols.includes(c.protocol)&&(yield async()=>{let f;const m=AbortSignal.timeout(c.timeout);try{f=await u.newStream(c.protocol,{signal:m,runOnLimitedConnection:c.runOnLimitedConnection}),await Nt(f,{maxDataLength:c.maxMessageSize}).pb(Ks).write({listenAddrs:e.map(w=>w.bytes),signedPeerRecord:r.marshal(),protocols:i,agentVersion:o,protocolVersion:a},{signal:m}),await f.close({signal:m})}catch(y){h.error("could not push identify update to peer",y),f?.abort(y)}})}}await xn(is(l(),{concurrency:this.concurrency}))}catch(e){this.log.error("error pushing updates to peers - %e",e)}}async handleProtocol(e){const{connection:t,stream:r}=e,i=t.log.newScope("identify-push");try{if(this.peerId.equals(t.remotePeer))throw new Error("received push from ourselves?");const s={signal:AbortSignal.timeout(this.timeout)},a=await Nt(r,{maxDataLength:this.maxMessageSize}).pb(Ks).read(s);await r.close(s),await V8(this.peerStore,this.events,i,t,a)}catch(s){i.error("received invalid message",s),r.abort(s);return}i.trace("handled push from %p",t.remotePeer)}}class DC extends q8{constructor(e,t={}){super(e,{...t,protocol:`/${t.protocolPrefix??Er.protocolPrefix}/${AC}/${_C}`,log:e.logger.forComponent("libp2p:identify")}),(t.runOnConnectionOpen??Er.runOnConnectionOpen)&&e.events.addEventListener("connection:open",r=>{const i=r.detail;this.identify(i).catch(s=>{s.name!==Wu.name&&this.log.error("error during identify trigged by connection:open",s)})})}[St]=["@libp2p/identify"];async _identify(e,t={}){let r;if(t.signal==null){const i=AbortSignal.timeout(this.timeout);t={...t,signal:i}}try{r=await e.newStream(this.protocol,{...t,runOnLimitedConnection:this.runOnLimitedConnection});const s=await Nt(r,{maxDataLength:this.maxMessageSize}).pb(Ks).read(t);return await r.close(t),s}catch(i){throw r?.abort(i),i}}async identify(e,t={}){const r=await this._identify(e,t),{publicKey:i,protocols:s,observedAddr:o}=r;if(i==null)throw new qe("Public key was missing from identify message");const a=Vr(i),c=rs(a.toCID()),l=e.log.newScope("identify");if(!e.remotePeer.equals(c))throw new qe("Identified peer does not match the expected peer");if(this.peerId.equals(c))throw new qe("Identified peer is our own peer id?");return this.maybeAddObservedAddress(o,l),l("completed for peer %p and protocols %o",c,s),V8(this.peerStore,this.events,l,e,r)}maybeAddObservedAddress(e,t){const r=PC(e);if(r==null)return;if(t.trace("our observed address was %a",r),Ui(r)){this.log.trace("our observed address was private");return}const i=r.getComponents();if((i[0].code===Bi||i[0].code===oc&&i[1].code===Bi)&&!P8(r)){t.trace("our observed address was IPv6 but not a global unicast address");return}Rl.exactMatch(r)||(t.trace("storing the observed address"),this.addressManager.addObservedAddr(r))}async handleProtocol(e){const{connection:t,stream:r}=e,i=t.log.newScope("identify"),s=AbortSignal.timeout(this.timeout);try{const o=await this.peerStore.get(this.peerId),a=this.addressManager.getAddresses().map(d=>d.decapsulateCode(so("p2p").code));let c=o.peerRecordEnvelope;if(a.length>0&&c==null){const d=new fr({peerId:this.peerId,multiaddrs:a});c=(await sn.seal(d,this.privateKey)).marshal().subarray()}let l=t.remoteAddr.bytes;UE.matches(t.remoteAddr)||(l=void 0),await Nt(r).pb(Ks).write({protocolVersion:this.host.protocolVersion,agentVersion:this.host.agentVersion,publicKey:Xn(this.privateKey.publicKey),listenAddrs:a.map(d=>d.bytes),signedPeerRecord:c,observedAddr:l,protocols:o.protocols},{signal:s}),await r.close({signal:s})}catch(o){i.error("could not respond to identify request",o),r.abort(o)}}}function LC(n={}){return e=>new DC(e,n)}function BC(n={}){return e=>new NC(e,n)}const uo=1e3,Rp=60*uo,Id=60*Rp,MC="/ipfs/kad/1.0.0",H8=48*Id,FC=24*Id,UC=10,$C=16384,VC=Id,M3=Id,qC=10*uo,z8=20,Cd=10,HC=5*Rp,zC=uo,KC=5*uo,WC=5*Rp,GC=30*uo,jC=180*uo,F3=`${Qu}-kad-dht`;var Jl;(function(n){let e;n.codec=()=>(e==null&&(e=pe((t,r,i={})=>{i.lengthDelimited!==!1&&r.fork(),t.key!=null&&t.key.byteLength>0&&(r.uint32(10),r.bytes(t.key)),t.value!=null&&t.value.byteLength>0&&(r.uint32(18),r.bytes(t.value)),t.timeReceived!=null&&t.timeReceived!==""&&(r.uint32(42),r.string(t.timeReceived)),i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{const s={key:Le(0),value:Le(0),timeReceived:""},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.key=t.bytes();break}case 2:{s.value=t.bytes();break}case 5:{s.timeReceived=t.string();break}default:{t.skipType(a&7);break}}}return s})),e),n.encode=t=>ge(t,n.codec()),n.decode=(t,r)=>me(t,n.codec(),r)})(Jl||(Jl={}));function QC(n){const e=n.getUTCFullYear(),t=String(n.getUTCMonth()+1).padStart(2,"0"),r=String(n.getUTCDate()).padStart(2,"0"),i=String(n.getUTCHours()).padStart(2,"0"),s=String(n.getUTCMinutes()).padStart(2,"0"),o=String(n.getUTCSeconds()).padStart(2,"0"),a=n.getUTCMilliseconds(),c=String(a*1e3*1e3).padStart(9,"0");return`${e}-${t}-${r}T${i}:${s}:${o}.${c}Z`}function YC(n){const e=new RegExp("(\\d{4})-(\\d{2})-(\\d{2})T(\\d{2}):(\\d{2}):(\\d{2})\\.(\\d+)Z"),t=String(n).trim().match(e);if(t==null)throw new Error("Invalid format");const r=parseInt(t[1],10),i=parseInt(t[2],10)-1,s=parseInt(t[3],10),o=parseInt(t[4],10),a=parseInt(t[5],10),c=parseInt(t[6],10),l=parseInt(t[7].slice(0,-6),10);return new Date(Date.UTC(r,i,s,o,a,c,l))}class Rt{key;value;timeReceived;constructor(e,t,r){if(!(e instanceof Uint8Array))throw new Error("key must be a Uint8Array");if(!(t instanceof Uint8Array))throw new Error("value must be a Uint8Array");this.key=e,this.value=t,this.timeReceived=r}serialize(){return Jl.encode(this.prepareSerialize())}prepareSerialize(){return{key:this.key,value:this.value,timeReceived:QC(this.timeReceived)}}static deserialize(e){const t=Jl.decode(e);return new Rt(t.key,t.value,new Date(t.timeReceived))}static fromDeserialized(e){const t=YC(e.timeReceived);if(e.key==null)throw new Error("key missing from deserialized object");if(e.value==null)throw new Error("value missing from deserialized object");return new Rt(e.key,e.value,t)}}class eu extends Error{constructor(e="Query error"){super(e),this.name="QueryError"}}class XC extends Error{constructor(e="Invalid record"){super(e),this.name="InvalidRecordError"}}class ZC extends Error{constructor(e="No selector function configured for prefix"){super(e),this.name="MissingSelectorError"}}var U3;(function(n){let e;n.codec=()=>(e==null&&(e=pe((t,r,i={})=>{i.lengthDelimited!==!1&&r.fork(),t.key!=null&&(r.uint32(10),r.bytes(t.key)),t.value!=null&&(r.uint32(18),r.bytes(t.value)),t.author!=null&&(r.uint32(26),r.bytes(t.author)),t.signature!=null&&(r.uint32(34),r.bytes(t.signature)),t.timeReceived!=null&&(r.uint32(42),r.string(t.timeReceived)),i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{const s={},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.key=t.bytes();break}case 2:{s.value=t.bytes();break}case 3:{s.author=t.bytes();break}case 4:{s.signature=t.bytes();break}case 5:{s.timeReceived=t.string();break}default:{t.skipType(a&7);break}}}return s})),e),n.encode=t=>ge(t,n.codec()),n.decode=(t,r)=>me(t,n.codec(),r)})(U3||(U3={}));var Ge;(function(n){n.PUT_VALUE="PUT_VALUE",n.GET_VALUE="GET_VALUE",n.ADD_PROVIDER="ADD_PROVIDER",n.GET_PROVIDERS="GET_PROVIDERS",n.FIND_NODE="FIND_NODE",n.PING="PING"})(Ge||(Ge={}));var tu;(function(n){n[n.PUT_VALUE=0]="PUT_VALUE",n[n.GET_VALUE=1]="GET_VALUE",n[n.ADD_PROVIDER=2]="ADD_PROVIDER",n[n.GET_PROVIDERS=3]="GET_PROVIDERS",n[n.FIND_NODE=4]="FIND_NODE",n[n.PING=5]="PING"})(tu||(tu={}));(function(n){n.codec=()=>Jt(tu)})(Ge||(Ge={}));var Ws;(function(n){n.NOT_CONNECTED="NOT_CONNECTED",n.CONNECTED="CONNECTED",n.CAN_CONNECT="CAN_CONNECT",n.CANNOT_CONNECT="CANNOT_CONNECT"})(Ws||(Ws={}));var tf;(function(n){n[n.NOT_CONNECTED=0]="NOT_CONNECTED",n[n.CONNECTED=1]="CONNECTED",n[n.CAN_CONNECT=2]="CAN_CONNECT",n[n.CANNOT_CONNECT=3]="CANNOT_CONNECT"})(tf||(tf={}));(function(n){n.codec=()=>Jt(tf)})(Ws||(Ws={}));var xs;(function(n){let e;n.codec=()=>(e==null&&(e=pe((t,r,i={})=>{if(i.lengthDelimited!==!1&&r.fork(),t.id!=null&&t.id.byteLength>0&&(r.uint32(10),r.bytes(t.id)),t.multiaddrs!=null)for(const s of t.multiaddrs)r.uint32(18),r.bytes(s);t.connection!=null&&(r.uint32(24),Ws.codec().encode(t.connection,r)),i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{const s={id:Le(0),multiaddrs:[]},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.id=t.bytes();break}case 2:{if(i.limits?.multiaddrs!=null&&s.multiaddrs.length===i.limits.multiaddrs)throw new xt('Decode error - map field "multiaddrs" had too many elements');s.multiaddrs.push(t.bytes());break}case 3:{s.connection=Ws.codec().decode(t);break}default:{t.skipType(a&7);break}}}return s})),e),n.encode=t=>ge(t,n.codec()),n.decode=(t,r)=>me(t,n.codec(),r)})(xs||(xs={}));var Rs;(function(n){let e;n.codec=()=>(e==null&&(e=pe((t,r,i={})=>{if(i.lengthDelimited!==!1&&r.fork(),t.type!=null&&tu[t.type]!==0&&(r.uint32(8),Ge.codec().encode(t.type,r)),t.clusterLevel!=null&&(r.uint32(80),r.int32(t.clusterLevel)),t.key!=null&&(r.uint32(18),r.bytes(t.key)),t.record!=null&&(r.uint32(26),r.bytes(t.record)),t.closer!=null)for(const s of t.closer)r.uint32(66),xs.codec().encode(s,r);if(t.providers!=null)for(const s of t.providers)r.uint32(74),xs.codec().encode(s,r);i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{const s={type:Ge.PUT_VALUE,closer:[],providers:[]},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.type=Ge.codec().decode(t);break}case 10:{s.clusterLevel=t.int32();break}case 2:{s.key=t.bytes();break}case 3:{s.record=t.bytes();break}case 8:{if(i.limits?.closer!=null&&s.closer.length===i.limits.closer)throw new xt('Decode error - map field "closer" had too many elements');s.closer.push(xs.codec().decode(t,t.uint32(),{limits:i.limits?.closer$}));break}case 9:{if(i.limits?.providers!=null&&s.providers.length===i.limits.providers)throw new xt('Decode error - map field "providers" had too many elements');s.providers.push(xs.codec().decode(t,t.uint32(),{limits:i.limits?.providers$}));break}default:{t.skipType(a&7);break}}}return s})),e),n.encode=t=>ge(t,n.codec()),n.decode=(t,r)=>me(t,n.codec(),r)})(Rs||(Rs={}));function $3(n,e={}){const t={...n,name:"SEND_QUERY",type:0,messageName:n.type,messageType:n.type};return e.onProgress?.(new CustomEvent("kad-dht:query:send-query",{detail:t})),t}function rf(n,e={}){const t={...n,name:"PEER_RESPONSE",type:1,messageName:n.messageType,closer:n.closer??[],providers:n.providers??[]};return e.onProgress?.(new CustomEvent("kad-dht:query:peer-response",{detail:t})),t}function Gh(n,e={}){const t={...n,name:"FINAL_PEER",type:2};return e.onProgress?.(new CustomEvent("kad-dht:query:final-peer",{detail:t})),t}function Gs(n,e={}){const t={...n,name:"QUERY_ERROR",type:3};return e.onProgress?.(new CustomEvent("kad-dht:query:query-error",{detail:t})),t}function V3(n,e={}){const t={...n,name:"PROVIDER",type:4};return e.onProgress?.(new CustomEvent("kad-dht:query:provider",{detail:t})),t}function nf(n,e={}){const t={...n,name:"VALUE",type:5};return e.onProgress?.(new CustomEvent("kad-dht:query:value",{detail:t})),t}function q3(n,e={}){const t={...n,name:"DIAL_PEER",type:7};return e.onProgress?.(new CustomEvent("kad-dht:query:dial-peer",{detail:t})),t}function JC(n,e={}){const t={...n,name:"PATH_ENDED",type:8};return e.onProgress?.(new CustomEvent("kad-dht:query:path-ended",{detail:t})),t}function eT(n,e,t){if(t.length===0)throw new $("No records given");const i=ee(e).split("/");if(i.length<3)throw new $("Record key does not have a selector function");const s=n[i[1].toString()];if(s==null)throw new ZC(`No selector function configured for key type "${i[1]}"`);return t.length===1?0:s(e,t)}function tT(n,e){return 0}const rT={pk:tT};async function Pp(n,e,t){const r=e.key,s=ee(r).split("/");if(s.length<3)return;const o=n[s[1].toString()];if(o==null)throw new $(`No validator available for key type "${s[1]}"`);await o(r,e.value,t)}const nT=async(n,e,t)=>{if(!(n instanceof Uint8Array))throw new $('"key" must be a Uint8Array');if(n.byteLength<5)throw new $("Invalid public key record");if(ee(n.subarray(0,4))!=="/pk/")throw new $("key was not prefixed with /pk/");const i=Vr(e),s=n.slice(4);if(!Ue(s,i.toMultihash().bytes))throw new $("public key does not match passed in key")},iT={pk:nT},sT=C("/pk/");function oT(n){return{...n,multiaddrs:n.multiaddrs.filter(e=>{const[[t,r]]=e.stringTuples();if(t===53||t===54||t===55)return r!=="localhost";if(t!==4&&t!==6||r==null)return!1;const i=fi(r);return i==null?!0:!i})}}async function Ha(n,e){const t=await gt.digest(n);return e?.signal?.throwIfAborted(),t.digest}async function An(n,e){return Ha(n.toMultihash().bytes,e)}function fa(n,e){return new Te(`${n}/${ee(e,"base32")}`,!1)}function aT(n){return tr([sT,n.toMultihash().bytes])}function cT(n){return ee(n.subarray(0,4))==="/pk/"}function lT(n){const e=zt(n.subarray(4));return Pn(e)}function H3(n,e){const t=new Date;return new Rt(n,e,t).serialize()}const uT=290,dT=54,hT=55,fT=56,pT=4,gT=41;function mT(n){const e=n.stringTuples();for(const t of e)if(t[0]===uT)return!1;if(e[0][0]===dT||e[0][0]===hT||e[0][0]===fT)return!0;if(e[0][0]===pT||e[0][0]===gT){const t=fi(`${e[0][1]}`);return t==null||!t}return!1}function K8(n){const e=n.toString().split("/"),t=e.pop(),r=e.pop();if(t==null||r==null)throw new Error(`incorrectly formatted provider entry key in datastore: ${n.toString()}`);return{cid:he.createV1(er,zt(C(r,"base32"))),peerId:Ot(t)}}function jh(n,e,t){const r=typeof e=="string"?e:ee(e.multihash.bytes,"base32"),i=[n,r];return t!=null&&i.push(t.toString()),new Te(i.join("/"))}function W8(n){return new Date(Ku(n))}function fs(n,e,t){return async function*(...r){const i=e.queryTime?.timer(t),s=e.errorTime?.timer(t);let o=!1;try{e.queries?.increment({[t]:!0}),yield*n(...r)}catch(a){throw o=!0,s?.(),e.errors?.increment({[t]:!0}),a}finally{e.queries?.decrement({[t]:!0}),o||i?.()}}}function G8(n,e,t){return async function(...r){const i=e?.queryTime?.timer(t),s=e?.errorTime?.timer(t);let o=!1;try{return e.queries?.increment({[t]:!0}),await n(...r)}catch(a){throw o=!0,s?.(),e.errors?.increment({[t]:!0}),a}finally{e.queries?.decrement({[t]:!0}),o||i?.()}}}class yT{log;components;validators;selectors;peerRouting;queryManager;network;datastorePrefix;constructor(e,t){const{validators:r,selectors:i,peerRouting:s,queryManager:o,network:a,logPrefix:c}=t;this.components=e,this.log=e.logger.forComponent(`${c}:content-fetching`),this.datastorePrefix=`${t.datastorePrefix}/record`,this.validators=r,this.selectors=i,this.peerRouting=s,this.queryManager=o,this.network=a,this.get=e.metrics?.traceFunction("libp2p.kadDHT.get",this.get.bind(this),{optionsIndex:1})??this.get,this.put=e.metrics?.traceFunction("libp2p.kadDHT.put",this.put.bind(this),{optionsIndex:2})??this.put}async getLocal(e,t){this.log("getLocal %b",e);const r=fa(this.datastorePrefix,e);this.log("fetching record for key %k",r);const i=await this.components.datastore.get(r,t);this.log("found %k in local datastore",r);const s=Rt.deserialize(i);return await Pp(this.validators,s,t),s}async*sendCorrectionRecord(e,t,r,i){this.log("sendCorrection for %b",e);const s=H3(e,r);for(const{value:o,from:a}of t){if(Ue(o,r)){this.log("record was ok");continue}if(this.components.peerId.equals(a)){try{const u=fa(this.datastorePrefix,e);this.log(`Storing corrected record for key ${u.toString()}`),await this.components.datastore.put(u,s.subarray(),i)}catch(u){this.log.error("Failed error correcting self",u)}continue}let c=!1;const l={type:Ge.PUT_VALUE,key:e,record:s};for await(const u of this.network.sendRequest(a,l,i))u.name==="PEER_RESPONSE"&&u.record!=null&&Ue(u.record.value,Rt.deserialize(s).value)&&(c=!0),yield u;if(!c)throw new eu("Could not send correction");this.log.error("Failed error correcting entry")}}async*put(e,t,r){this.log("put key %b value %b",e,t);const i=H3(e,t),s=fa(this.datastorePrefix,e);this.log(`storing record for key ${s.toString()}`),await this.components.datastore.put(s,i.subarray(),r),yield*rr(this.peerRouting.getClosestPeers(e,{...r,signal:r.signal}),o=>un(o,a=>async()=>{if(a.name!=="FINAL_PEER")return[a];const c=[],l={type:Ge.PUT_VALUE,key:e,record:i};this.log("send put to %p",a.peer.id);for await(const u of this.network.sendRequest(a.peer.id,l,{...r,path:a.path}))c.push(u),u.name==="PEER_RESPONSE"&&(u.record!=null&&Ue(u.record.value,Rt.deserialize(i).value)||c.push(Gs({from:a.peer.id,error:new eu("Value not put correctly"),path:u.path},r)));return c}),o=>is(o,{ordered:!1,concurrency:Cd}),async function*(o){for await(const a of o)yield*a})}async*get(e,t){this.log("get %b",e);const r=[];for await(const a of this.getMany(e,t)){if(a.name==="VALUE"){r.push(a);continue}yield a}if(r.length===0)return;const i=r.map(a=>a.value);let s=0;try{s=eT(this.selectors,e,i)}catch(a){if(a.name!=="InvalidParametersError")throw a}const o=i[s];if(this.log("GetValue %b %b",e,o),o==null)throw new Xe("Best value was not found");yield*this.sendCorrectionRecord(e,r,o,{...t,path:{index:-1,queued:0,running:0,total:0}}),yield r[s]}async*getMany(e,t={}){this.log("getMany values for %b",e);try{const s=await this.getLocal(e,t);yield nf({value:s.value,from:this.components.peerId,path:{index:-1,running:0,queued:0,total:0}},t)}catch(s){this.log("error getting local value for %b",e,s)}const r=this,i=async function*({peer:s,signal:o,path:a}){for await(const c of r.peerRouting.getValueOrPeers(s.id,e,{...t,signal:o,path:a}))yield c,c.name==="PEER_RESPONSE"&&c.record!=null&&(yield nf({from:s.id,value:c.record.value,path:a},t))};yield*this.queryManager.run(e,i,t)}}function wT(n,e){return{id:n.id.toMultihash().bytes,multiaddrs:(n.multiaddrs??[]).map(r=>r.bytes),connection:e}}function Zc(n){if(n.id==null)throw new Error("Invalid peer in message");const e=zt(n.id);return{id:Pn(e),multiaddrs:(n.multiaddrs??[]).map(t=>ue(t))}}class vT{log;components;network;peerRouting;queryManager;routingTable;providers;constructor(e,t){const{network:r,peerRouting:i,queryManager:s,routingTable:o,providers:a,logPrefix:c}=t;this.components=e,this.log=e.logger.forComponent(`${c}:content-routing`),this.network=r,this.peerRouting=i,this.queryManager=s,this.routingTable=o,this.providers=a,this.findProviders=e.metrics?.traceFunction("libp2p.kadDHT.findProviders",this.findProviders.bind(this),{optionsIndex:1,getAttributesFromYieldedValue:(l,u)=>(l.name==="PROVIDER"&&(u.providers??=[],u.providers.push(...l.providers.map(d=>d.id.toString()))),u)})??this.findProviders,this.provide=e.metrics?.traceFunction("libp2p.kadDHT.provide",this.provide.bind(this),{optionsIndex:1,getAttributesFromYieldedValue:(l,u)=>(l.name==="PEER_RESPONSE"&&l.messageName==="ADD_PROVIDER"&&(u.providers??=[],u.providers.push(l.from.toString())),u)})??this.provide}async*provide(e,t,r={}){this.log("provide %s",e);const i=e.multihash.bytes;await this.providers.addProvider(e,this.components.peerId,r);const s={type:Ge.ADD_PROVIDER,key:i,providers:[wT({id:this.components.peerId,multiaddrs:t})]};let o=0;const a=this;async function*c(d){try{a.log("sending provider record for %s to %p",e,d.peer.id);for await(const h of a.network.sendMessage(d.peer.id,s,{...r,path:d.path}))h.name==="PEER_RESPONSE"&&(a.log("sent provider record for %s to %p",e,d.peer.id),o++),yield h}catch(h){a.log.error("error sending provide record to peer %p",d.peer.id,h),yield Gs({from:d.peer.id,error:h,path:d.path},r)}}const l=fn({objectMode:!0}),u=new si({concurrency:Cd});u.addEventListener("idle",()=>{l.end()}),u.addEventListener("failure",d=>{this.log.error("error publishing provider record to peer - %e",d.detail.error)}),u.add(async()=>{const d=[];for await(const h of this.peerRouting.getClosestPeers(i,r))l.push(h),h.name==="FINAL_PEER"&&d.push(h);d.forEach(h=>{u.add(async()=>{for await(const f of c(h))l.push(f)}).catch(f=>{this.log.error("error publishing provider record to peer - %e",f)})})}).catch(d=>{l.end(d)}),yield*l,this.log("sent provider records to %d peers",o)}async*findProviders(e,t){const r=this.routingTable.kBucketSize;let i=0;const s=e.multihash.bytes,o=this;this.log("findProviders %c",e);const a=await this.providers.getProviders(e,t);if(a.length>0){const u=[];for(const d of a.slice(0,r))try{const h=await this.components.peerStore.get(d,t);u.push({id:d,multiaddrs:h.addresses.map(({multiaddr:f})=>f)})}catch(h){if(h.name!=="NotFoundError")throw h;this.log("no peer store entry for %p",d)}if(yield rf({from:this.components.peerId,messageType:Ge.GET_PROVIDERS,providers:u,path:{index:-1,queued:0,running:0,total:0}},t),yield V3({from:this.components.peerId,providers:u,path:{index:-1,queued:0,running:0,total:0}},t),i+=u.length,i>=r)return}const c=async function*({peer:u,signal:d,path:h}){const f={type:Ge.GET_PROVIDERS,key:s};yield*o.network.sendRequest(u.id,f,{...t,signal:d,path:h})},l=new nn(a);for await(const u of this.queryManager.run(s,c,t))if(yield u,u.name==="PEER_RESPONSE"){this.log("Found %d provider entries for %c and %d closer peers",u.providers.length,e,u.closer.length);const d=[];for(const h of u.providers)l.has(h.id)||(l.add(h.id),d.push(h));if(d.length>0&&(yield V3({from:u.from,providers:d,path:u.path},t),i+=d.length,i>=r))return}}}class bT extends tt{log;protocol;running;components;timeout;metrics;constructor(e,t){super(),this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:network`),this.running=!1,this.protocol=t.protocol,this.timeout=new $a({...t.timeout??{},metrics:e.metrics,metricName:`${t.metricsPrefix}_network_message_send_times_milliseconds`}),this.metrics={operations:e.metrics?.registerCounterGroup(`${t.metricsPrefix}_outbound_rpc_requests_total`),errors:e.metrics?.registerCounterGroup(`${t.metricsPrefix}_outbound_rpc_errors_total`)},this.sendRequest=e.metrics?.traceFunction("libp2p.kadDHT.sendRequest",this.sendRequest.bind(this),{optionsIndex:2,getAttributesFromArgs([r,i],s){return{...s,to:r.toString(),"message type":`${i.type}`}},getAttributesFromYieldedValue:(r,i)=>(r.name==="PEER_RESPONSE"&&(r.providers.length>0&&r.providers.forEach((s,o)=>{i[`providers-${o}`]=s.id.toString()}),r.closer.length>0&&r.closer.forEach((s,o)=>{i[`closer-${o}`]=s.id.toString()})),i)})??this.sendRequest,this.sendMessage=e.metrics?.traceFunction("libp2p.kadDHT.sendMessage",this.sendMessage.bind(this),{optionsIndex:2,getAttributesFromArgs([r,i],s){return{...s,to:r.toString(),"message type":`${i.type}`}},getAttributesFromYieldedValue:(r,i)=>(r.name==="PEER_RESPONSE"&&(r.providers.length>0&&r.providers.forEach((s,o)=>{i[`providers-${o}`]=s.id.toString()}),r.closer.length>0&&r.closer.forEach((s,o)=>{i[`closer-${o}`]=s.id.toString()})),i)})??this.sendMessage}async start(){this.running||(this.running=!0)}async stop(){this.running=!1}isStarted(){return this.running}async*sendRequest(e,t,r){if(!this.running)return;const i=t.type;if(i==null)throw new $("Message type was missing");let s;const o=this.timeout.getTimeoutSignal(r);r={...r,signal:o};try{this.metrics.operations?.increment({[i]:!0}),this.log("dialling %p",e),yield q3({peer:e,path:r.path},r),s=await(await this.components.connectionManager.openConnection(e,r)).newStream(this.protocol,r),this.log("sending %s to %p",t.type,e),yield $3({to:e,type:i,path:r.path},r);const c=await this._writeReadMessage(s,t,r);s.close(r).catch(l=>{this.log.error("error closing stream to %p",e,l),s?.abort(l)}),yield rf({from:e,messageType:c.type,closer:c.closer.map(Zc),providers:c.providers.map(Zc),record:c.record==null?void 0:Rt.deserialize(c.record),path:r.path},r)}catch(a){this.metrics.errors?.increment({[i]:!0}),s?.abort(a),r.signal?.aborted!==!0&&this.log.error("could not send %s to %p - %e",t.type,e,a),yield Gs({from:e,error:a,path:r.path},r)}finally{this.timeout.cleanUp(o)}}async*sendMessage(e,t,r){if(!this.running)return;const i=t.type;if(i==null)throw new $("Message type was missing");let s;const o=this.timeout.getTimeoutSignal(r);r={...r,signal:o};try{this.metrics.operations?.increment({[i]:!0}),this.log("dialling %p",e),yield q3({peer:e,path:r.path},r),s=await(await this.components.connectionManager.openConnection(e,r)).newStream(this.protocol,r),this.log("sending %s to %p",t.type,e),yield $3({to:e,type:i,path:r.path},r),await this._writeMessage(s,t,r),s.close(r).catch(c=>{this.log.error("error closing stream to %p",e,c),s?.abort(c)}),yield rf({from:e,messageType:i,path:r.path},r)}catch(a){this.metrics.errors?.increment({[i]:!0}),s?.abort(a),yield Gs({from:e,error:a,path:r.path},r)}finally{this.timeout.cleanUp(o)}}async _writeMessage(e,t,r){await Nt(e).write(t,Rs,r)}async _writeReadMessage(e,t,r){const i=Nt(e);await i.write(t,Rs,r);const s=await i.read(Rs,r);return s.closer.forEach(o=>{this.safeDispatchEvent("peer",{detail:Zc(o)})}),s.providers.forEach(o=>{this.safeDispatchEvent("peer",{detail:Zc(o)})}),s}}function pa(n,e){if(n.byteLength!==e.byteLength)throw new Error("Inputs should have the same length");for(let t=0;t<n.byteLength;t++)if(n[t]!==e[t])return n[t]<e[t]?-1:1;return 0}class Op{originDhtKey;capacity;peerDistances;constructor(e,t){this.originDhtKey=e,this.capacity=t,this.peerDistances=[]}get length(){return this.peerDistances.length}get peers(){return[...this.peerDistances]}async add(e,t={index:-1,queued:0,running:0,total:0},r){const i=await An(e.id,r);this.addWithKadId(e,i,t)}addWithKadId(e,t,r={index:-1,queued:0,running:0,total:0}){if(this.peerDistances.find(o=>o.peer.id.equals(e.id))!=null)return;const i={peer:e,distance:$s(this.originDhtKey,t),path:r};if(this.peerDistances.length===this.capacity){const o=this.peerDistances[this.peerDistances.length-1];if(o!=null&&pa(i.distance,o.distance)!==-1)return}let s=!1;for(let o=0;o<this.peerDistances.length;o++){const a=pa(this.peerDistances[o].distance,i.distance);if(a===0||a===1){s=!0,this.peerDistances.splice(o,0,i);break}}s||this.peerDistances.push(i),this.peerDistances=this.peerDistances.slice(0,this.capacity)}async isCloser(e,t){if(this.length===0)return!0;const r=await An(e,t),i=$s(r,this.originDhtKey),s=this.peerDistances[this.peerDistances.length-1].distance;return pa(i,s)===-1}async anyCloser(e,t){return e.length===0?!1:Promise.any(e.map(async r=>this.isCloser(r,t)))}}class ET{log;routingTable;network;validators;queryManager;components;constructor(e,t){this.routingTable=t.routingTable,this.network=t.network,this.validators=t.validators,this.queryManager=t.queryManager,this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:peer-routing`),this.findPeer=e.metrics?.traceFunction("libp2p.kadDHT.findPeer",this.findPeer.bind(this),{optionsIndex:1})??this.findPeer,this.getClosestPeers=e.metrics?.traceFunction("libp2p.kadDHT.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1})??this.getClosestPeers}async findPeerLocal(e,t){let r;const i=await this.routingTable.find(e,t);if(i!=null){this.log("findPeerLocal found %p in routing table",e);try{r=await this.components.peerStore.get(i,t)}catch(s){if(s.name!=="NotFoundError")throw s}}if(r==null)try{r=await this.components.peerStore.get(e,t)}catch(s){if(s.name!=="NotFoundError")throw s}if(r!=null)return this.log("findPeerLocal found %p in peer store",e),{id:r.id,multiaddrs:r.addresses.map(s=>s.multiaddr)}}async*_getValueSingle(e,t,r){const i={type:Ge.GET_VALUE,key:t};yield*this.network.sendRequest(e,i,r)}async*getPublicKeyFromNode(e,t={}){const r=aT(e),i={index:-1,queued:0,running:0,total:0};for await(const s of this._getValueSingle(e,r,{...t,path:i}))if(yield s,s.name==="PEER_RESPONSE"&&s.record!=null){const o=Vr(s.record.value),a=Ca(o);if(!a.equals(e))throw new W2("public key does not match id");if(a.publicKey==null)throw new W2("public key missing");yield nf({from:e,value:s.record.value,path:i},t)}throw new eu(`Node not responding with its public key: ${e.toString()}`)}async*findPeer(e,t={}){if(this.log("findPeer %p",e),t.useCache!==!1){const i=await this.findPeerLocal(e,t);if(i!=null){this.log("found local"),yield Gh({from:this.components.peerId,peer:i,path:{index:-1,queued:0,running:0,total:0}},t);return}}let r=!1;if(t.useNetwork!==!1){const i=this,s=async function*({peer:o,signal:a,path:c}){const l={type:Ge.FIND_NODE,key:e.toMultihash().bytes};for await(const u of i.network.sendRequest(o.id,l,{...t,signal:a,path:c}))if(yield u,u.name==="PEER_RESPONSE"){const d=u.closer.find(h=>h.id.equals(e));d!=null&&(yield Gh({from:u.from,peer:d,path:u.path},t))}};for await(const o of this.queryManager.run(e.toMultihash().bytes,s,t))o.name==="FINAL_PEER"&&(r=!0),yield o}if(!r)throw new Xe("Not found")}async*getClosestPeers(e,t={}){this.log("getClosestPeers to %b",e);const r=await Ha(e,t),i=new Op(r,this.routingTable.kBucketSize),s=this,o=async function*({peer:a,path:c,peerKadId:l,signal:u}){s.log("getClosestPeers asking %p",a.id);const d={type:Ge.FIND_NODE,key:e};yield*s.network.sendRequest(a.id,d,{...t,signal:u,path:c}),i.addWithKadId(a,l,c)};yield*this.queryManager.run(e,o,t),this.log("found %d peers close to %b",i.length,e);for(let{peer:a,path:c}of i.peers)try{if(a.multiaddrs.length===0&&(a=await s.components.peerStore.getInfo(a.id,t)),a.multiaddrs.length===0)continue;yield Gh({from:this.components.peerId,peer:await s.components.peerStore.getInfo(a.id,t),path:{index:c.index,queued:0,running:0,total:0}},t)}catch{continue}}async*getValueOrPeers(e,t,r){for await(const i of this._getValueSingle(e,t,r)){if(i.name==="PEER_RESPONSE"&&i.record!=null)try{await this._verifyRecordOnline(i.record,r)}catch{const o="invalid record received, discarded";this.log(o),yield Gs({from:i.from,error:new eu(o),path:r.path},r);continue}yield i}}async _verifyRecordOnline(e,t){if(e.timeReceived==null)throw new XC("invalid record received");await Pp(this.validators,new Rt(e.key,e.value,e.timeReceived),t)}async getClosestPeersOffline(e,t){const r=[];try{const o=zt(e),a=Pn(o),c=await this.components.peerStore.get(a,t);r.push({id:c.id,multiaddrs:c.addresses.map(({multiaddr:l})=>l)})}catch{}const i=await Ha(e,t),s=this.routingTable.closestPeers(i,t);for(const o of s)try{r.push(await this.components.peerStore.getInfo(o,t))}catch(a){if(a.name!=="NotFoundError")throw a}return r.length>0?this.log("getClosestPeersOffline returning the %d closest peer(s) %b we know",r.length,e):this.log("getClosestPeersOffline could not any peers close to %b with %d peers in the routing table",e,this.routingTable.size),r}}class ST{log;datastore;datastorePrefix;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:providers`),this.datastorePrefix=`${t.datastorePrefix}/provider`,this.datastore=e.datastore}async addProvider(e,t,r){this.log.trace("%p provides %s",t,e),await this.writeProviderEntry(e,t,r)}async removeProvider(e,t,r){const i=jh(this.datastorePrefix,e,t);this.log.trace("%p no longer provides %s",t,e),await this.datastore.delete(i,r)}async getProviders(e,t){this.log.trace("get providers for %c",e);const r=await this.loadProviders(e,t);return this.log.trace("got %d providers for %c",r.size,e),[...r.keys()]}async writeProviderEntry(e,t,r){const i=jh(this.datastorePrefix,e,t),s=Mr(r?.time?.getTime()??Date.now());await this.datastore.put(i,s,r)}async loadProviders(e,t){const r=new ns,i=jh(this.datastorePrefix,e);for await(const s of this.datastore.query({prefix:i.toString()},t)){const{peerId:o}=K8(s.key);r.set(o,W8(s.value))}return r}}const xT=n=>{const e=n.addEventListener||n.on||n.addListener,t=n.removeEventListener||n.off||n.removeListener;if(!e||!t)throw new TypeError("Emitter is not compatible");return{addListener:e.bind(n),removeListener:t.bind(n)}};function AT(n,e,t){let r;const i=new Promise((s,o)=>{if(t={rejectionEvents:["error"],multiArgs:!1,resolveImmediately:!1,...t},!(t.count>=0&&(t.count===Number.POSITIVE_INFINITY||Number.isInteger(t.count))))throw new TypeError("The `count` option should be at least 0 or more");t.signal?.throwIfAborted();const a=[e].flat(),c=[],{addListener:l,removeListener:u}=xT(n),d=(...f)=>{const m=t.multiArgs?f:f[0];t.filter&&!t.filter(m)||(c.push(m),t.count===c.length&&(r(),s(c)))},h=f=>{r(),o(f)};r=()=>{for(const f of a)u(f,d);for(const f of t.rejectionEvents)u(f,h)};for(const f of a)l(f,d);for(const f of t.rejectionEvents)l(f,h);t.signal&&t.signal.addEventListener("abort",()=>{h(t.signal.reason)},{once:!0}),t.resolveImmediately&&s(c)});if(i.cancel=r,typeof t.timeout=="number"){const s=Ju(i,{milliseconds:t.timeout});return s.cancel=r,s}return i}function kT(n,e,t){typeof t=="function"&&(t={filter:t}),t={...t,count:1,resolveImmediately:!1};const r=AT(n,e,t),i=r.then(s=>s[0]);return i.cancel=r.cancel,i}async function*_T(n){const{key:e,startingPeers:t,ourPeerId:r,query:i,alpha:s,path:o,numPaths:a,log:c,peersSeen:l,connectionManager:u,signal:d}=n,h=fn({objectMode:!0}),f=new si({concurrency:s,sort:(y,w)=>pa(y.options.distance,w.options.distance)});f.addEventListener("idle",()=>{h.push(JC({path:{index:o,queued:f.queued,running:f.running,total:f.size}},n)),h.end()}),f.addEventListener("failure",y=>{c.error("error during query - %e",y.detail.error)});const m=()=>{f.abort(),h.end(new pt)};d.addEventListener("abort",m);try{let w=function(E,A){if(E==null)return;l.add(E.id.toMultihash().bytes);const T=$s(A,y);f.add(async()=>{try{for await(const R of i({...n,key:e,peer:E,path:{index:o,queued:f.queued,running:f.running,total:f.size},numPaths:a,peerKadId:A,signal:d})){if(R.name==="PEER_RESPONSE")for(const ie of R.closer){if(l.has(ie.id.toMultihash().bytes)){c("already seen %p in query",ie.id);continue}if(r.equals(ie.id)){c("not querying ourselves");continue}if(!await u.isDialable(ie.multiaddrs)){c("not querying undialable peer");continue}const re=await An(ie.id,{signal:d}),j=$s(re,y);if(pa(j,T)!==-1){c("skipping %p as they are not closer to %b than %p",ie.id,e,E);continue}c("querying closer peer %p",ie.id),w(ie,re)}h.push({...R,path:{index:o,queued:f.queued,running:f.running,total:f.size}})}}catch(R){h.push(Gs({from:E.id,error:R,path:{index:o,queued:f.queued,running:f.running-1,total:f.size-1}},n))}},{distance:T}).catch(R=>{c.error("error during query - %e",R)})};const y=await Ha(e,{signal:d});await Promise.all(t.map(async E=>{w({id:E,multiaddrs:[]},await An(E,{signal:d}))})),yield*h}finally{d.removeEventListener("abort",m)}}class IT{disjointPaths;alpha;shutDownController;running;logger;peerId;connectionManager;routingTable;initialQuerySelfHasRun;logPrefix;allowQueryWithZeroPeers;constructor(e,t){this.logPrefix=t.logPrefix,this.disjointPaths=t.disjointPaths??z8,this.alpha=t.alpha??Cd,this.initialQuerySelfHasRun=t.initialQuerySelfHasRun,this.routingTable=t.routingTable,this.logger=e.logger,this.peerId=e.peerId,this.connectionManager=e.connectionManager,this.allowQueryWithZeroPeers=t.allowQueryWithZeroPeers??!1,this.shutDownController=new AbortController,this.shutDownController.signal,this.running=!1}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.shutDownController=new AbortController,this.shutDownController.signal,void 0)}async stop(){this.running=!1,this.shutDownController.abort()}async*run(e,t,r={}){if(!this.running)throw new Error("QueryManager not started");if(r.signal==null){const c=AbortSignal.timeout(jC);r={...r,signal:c}}const i=new AbortController,s=Re([this.shutDownController.signal,i.signal,r.signal]);i.signal;const o=this.logger.forComponent(`${this.logPrefix}:query:`+ee(e,"base58btc"));let a=!1;try{this.routingTable.size===0&&!this.allowQueryWithZeroPeers&&(o("routing table was empty, waiting for some peers before running%s query",r.isSelfQuery===!0?" self":""),await kT(this.routingTable,"peer:add",{signal:s,filter:f=>!this.peerId.equals(f.detail)}),o("routing table has peers, continuing with%s query",r.isSelfQuery===!0?" self":"")),r.isSelfQuery!==!0&&this.initialQuerySelfHasRun!=null&&(o("waiting for initial self query before continuing"),await ht(this.initialQuerySelfHasRun.promise,s),this.initialQuerySelfHasRun=void 0),o("query:start");const c=await Ha(e,{signal:s}),l=this.routingTable.closestPeers(c,{count:this.routingTable.kBucketSize}),u=l.sort(()=>Math.random()>.5?1:-1).reduce((f,m,y)=>(f[y%this.disjointPaths].push(m),f),new Array(this.disjointPaths).fill(0).map(()=>[])).filter(f=>f.length>0);if(l.length===0){o.error("running query with no peers");return}const d=ai(1024),h=u.map((f,m)=>_T({...r,key:e,startingPeers:f,ourPeerId:this.peerId,signal:s,query:t,path:m,numPaths:u.length,alpha:this.alpha,log:o,peersSeen:d,onProgress:r.onProgress,connectionManager:this.connectionManager}));for await(const f of Zn(...h)){if(f.name==="QUERY_ERROR"&&o.error("query error",f.error),f.name==="PEER_RESPONSE")for(const m of[...f.closer,...f.providers])await this.connectionManager.isDialable(m.multiaddrs,{signal:s})&&await this.routingTable.add(m.id,{signal:s});s.throwIfAborted(),yield f}a=!0}catch(c){if(this.running)throw c}finally{a||(o("query exited early"),i.abort()),s.clear(),o("query finished")}}}function CT(n){return n[Symbol.asyncIterator]!=null}function j8(n){if(CT(n))return(async()=>{let e=0;for await(const t of n)e++;return e})();{let e=0;for(const t of n)e++;return e}}class TT{log;peerId;peerRouting;events;count;interval;initialInterval;queryTimeout;running;timeoutId;controller;initialQuerySelfHasRun;querySelfPromise;constructor(e,t){this.peerId=e.peerId,this.log=e.logger.forComponent(`${t.logPrefix}:query-self`),this.events=e.events,this.running=!1,this.peerRouting=t.peerRouting,this.count=t.count??z8,this.interval=t.interval??HC,this.initialInterval=t.initialInterval??zC,this.queryTimeout=t.queryTimeout??KC,this.initialQuerySelfHasRun=t.initialQuerySelfHasRun,this.querySelf=G8(this.querySelf.bind(this),t.operationMetrics,"SELF_QUERY")}isStarted(){return this.running}start(){this.running||(this.running=!0,clearTimeout(this.timeoutId),this.timeoutId=setTimeout(()=>{this.querySelf().catch(e=>{this.log.error("error running self-query",e)})},this.initialInterval))}stop(){this.running=!1,this.timeoutId!=null&&clearTimeout(this.timeoutId),this.controller!=null&&this.controller.abort()}async querySelf(){if(!this.running){this.log("skip self-query because we are not started");return}if(this.querySelfPromise!=null)return this.log("joining existing self query"),this.querySelfPromise.promise;if(this.querySelfPromise=we(),this.running){this.controller=new AbortController;const e=[this.controller.signal];if(this.initialQuerySelfHasRun==null){const r=AbortSignal.timeout(this.queryTimeout);e.push(r)}const t=Re(e);this.controller.signal;try{this.log("run self-query, look for %d peers timing out after %dms",this.count,this.queryTimeout);const r=Date.now(),i=await rr(this.peerRouting.getClosestPeers(this.peerId.toMultihash().bytes,{signal:t,isSelfQuery:!0}),o=>xl(o,this.count),async o=>j8(o));t?.throwIfAborted();const s=Date.now()-r;this.log("self-query found %d peers in %dms",i,s),this.events.dispatchEvent(new CustomEvent("kad-dht:query:self",{detail:{peers:i,duration:s}}))}catch(r){this.log.error("self-query error",r)}finally{t.clear(),this.initialQuerySelfHasRun!=null&&(this.initialQuerySelfHasRun.resolve(),this.initialQuerySelfHasRun=void 0)}}this.querySelfPromise.resolve(),this.querySelfPromise=void 0,this.running&&(this.timeoutId=setTimeout(()=>{this.querySelf().catch(e=>{this.log.error("error running self-query",e)})},this.interval))}}class RT extends tt{log;reprovideQueue;maxQueueSize;datastore;timeout;reprovideTimeout;running;shutdownController;reprovideThreshold;contentRouting;datastorePrefix;addressManager;validity;interval;peerId;constructor(e,t){super(),this.log=e.logger.forComponent(`${t.logPrefix}:reprovider`),this.peerId=e.peerId,this.reprovideQueue=new si({concurrency:t.concurrency??UC,metrics:e.metrics,metricName:`${t.metricsPrefix}_reprovide_queue`}),this.reprovideTimeout=new $a({...t.timeout??{},metrics:e.metrics,metricName:`${t.metricsPrefix}_reprovide_timeout_milliseconds`}),this.datastore=e.datastore,this.addressManager=e.addressManager,this.datastorePrefix=`${t.datastorePrefix}/provider`,this.reprovideThreshold=t.threshold??FC,this.maxQueueSize=t.maxQueueSize??$C,this.validity=t.validity??H8,this.interval=t.interval??VC,this.contentRouting=t.contentRouting,this.running=!1,this.reprovide=G8(this.reprovide.bind(this),t.operationMetrics,"PROVIDE")}start(){this.running||(this.running=!0,this.shutdownController=new AbortController,this.shutdownController.signal,this.timeout=setTimeout(()=>{this.processRecords({signal:AbortSignal.timeout(M3)}).catch(e=>{this.log.error("error running process to reprovide/cleanup - %e",e)})},this.interval))}stop(){this.running=!1,this.reprovideQueue.clear(),clearTimeout(this.timeout),this.shutdownController?.abort()}async processRecords(e){try{this.safeDispatchEvent("reprovide:start"),this.log("starting reprovide/cleanup");for await(const t of this.datastore.query({prefix:this.datastorePrefix},e))try{const{cid:r,peerId:i}=K8(t.key),o=W8(t.value).getTime()+this.validity,a=Date.now(),c=a>o,l=this.peerId.equals(i);this.log.trace("comparing: %d (now) < %d (expires) = %s %s",a,o,c,c?"(expired)":"(valid)"),c&&!l&&await this.datastore.delete(t.key,e),this.shouldReprovide(l,o)&&(this.log("reproviding %c as it is within the reprovide threshold (%d)",r,this.reprovideThreshold),this.queueReprovide(r).catch(u=>{this.log.error("could not reprovide %c - %e",r,u)}))}catch(r){this.log.error("error processing datastore key %s - %e",t.key,r.message)}this.log("reprovide/cleanup successful")}finally{this.safeDispatchEvent("reprovide:end"),this.running&&(this.log("queuing next re-provide/cleanup run in %d ms",this.interval),this.timeout=setTimeout(()=>{this.processRecords({signal:AbortSignal.timeout(M3)}).catch(t=>{this.log.error("error running re-provide - %e",t)})},this.interval))}}shouldReprovide(e,t){if(!e)return!1;const r=Date.now();return t<r?!0:t-r<this.reprovideThreshold}async queueReprovide(e,t){if(!this.running)return;this.log.trace("waiting for queue capacity before adding %c to re-provide queue",e),await this.reprovideQueue.onSizeLessThan(this.maxQueueSize,t);const r=this.reprovideQueue.queue.find(i=>i.options.cid.equals(e));if(r!=null)return this.log.trace("not adding %c to re-provide queue - already in queue",e),r.join();this.log.trace("adding %c to re-provide queue",e),this.reprovideQueue.add(async i=>{if(i.signal?.throwIfAborted(),!this.running)return;this.log.trace("re-providing %c",e);const s=this.reprovideTimeout.getTimeoutSignal(i);try{await this.reprovide(i.cid,i)}finally{this.reprovideTimeout.cleanUp(s)}this.log.trace("re-provided %c",e)},{signal:this.shutdownController?.signal,cid:e}).catch(i=>{this.log.error("could not re-provide key %c - %e",e,i)})}async reprovide(e,t){await xn(this.contentRouting.provide(e,this.addressManager.getAddresses(),t))}}const PT=20,OT=5e3,NT="kad-close",DT=50;class LT{routingTable;components;closestPeers;newPeers;refreshInterval;peerSetSize;timeout;closeTagName;closeTagValue;log;running;constructor(e,t){this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:routing-table`),this.routingTable=t.routingTable,this.refreshInterval=t.refreshInterval??OT,this.peerSetSize=t.peerSetSize??PT,this.closeTagName=t.closeTagName??NT,this.closeTagValue=t.closeTagValue??DT,this.closestPeers=new nn,this.onPeerPing=this.onPeerPing.bind(this),this.running=!1}async start(){if(this.running)return;this.running=!0;const e=await An(this.components.peerId);this.newPeers=new Op(e,this.peerSetSize),this.routingTable.addEventListener("peer:ping",this.onPeerPing),this.timeout=setInterval(()=>{this.updatePeerTags().catch(t=>{this.log.error("error updating peer tags - %e",t)})},this.refreshInterval)}stop(){this.running=!1,this.routingTable.removeEventListener("peer:ping",this.onPeerPing),clearTimeout(this.timeout)}onPeerPing(e){this.newPeers?.add({id:e.detail,multiaddrs:[]}).catch(t=>{this.log.error("error adding peer to distance list - %e",t)})}async updatePeerTags(){const e=new nn(this.newPeers?.peers.map(({peer:i})=>i.id)),t=e.difference(this.closestPeers),r=this.closestPeers.difference(e);this.closestPeers=e,await Promise.all([...[...t].map(async i=>{await this.components.peerStore.merge(i,{tags:{[this.closeTagName]:{value:this.closeTagValue},[F3]:{value:1}}})}),...[...r].map(async i=>{await this.components.peerStore.merge(i,{tags:{[this.closeTagName]:void 0,[F3]:void 0}})})])}}function hl(n){return Array.isArray(n?.peers)}class BT{peerId;root;localPeer;prefixLength;splitThreshold;kBucketSize;numberOfNodesToPing;lastPingThreshold;ping;verify;onAdd;onRemove;onMove;addingPeerMap;constructor(e,t){this.peerId=e.peerId,this.prefixLength=t.prefixLength??UT,this.kBucketSize=t.kBucketSize??Np,this.splitThreshold=t.splitThreshold??this.kBucketSize,this.numberOfNodesToPing=t.numberOfOldContactsToPing??qT,this.lastPingThreshold=t.lastPingThreshold??WT,this.ping=t.ping,this.verify=t.verify,this.onAdd=t.onAdd,this.onRemove=t.onRemove,this.addingPeerMap=Zu({name:`${t.metricsPrefix}_adding_peer_map`,metrics:e.metrics}),this.root={prefix:"",depth:0,peers:[]}}async start(){await this.addSelfPeer(this.peerId)}stop(){this.addingPeerMap.clear(),this.root={prefix:"",depth:0,peers:[]}}async addSelfPeer(e,t){this.localPeer={peerId:e,kadId:await An(e,t),lastPing:Date.now()}}async add(e,t){const r={peerId:e,kadId:await An(e,t),lastPing:0},i=this.addingPeerMap.get(e);if(i!=null)return i;try{const s=this._add(r,t);this.addingPeerMap.set(e,s),await s}finally{this.addingPeerMap.delete(e)}}async _add(e,t){const r=this._determineBucket(e.kadId);if(this._indexOf(r,e.kadId)>-1)return;if(r.peers.length===this.splitThreshold&&r.depth<this.prefixLength){await this._split(r,t),await this._add(e,t);return}if(r.peers.length<this.kBucketSize){if(!FT(e,this.lastPingThreshold)){r.peers.push(e),await this.onAdd?.(e,r,t);return}await this.verify(e,t)&&(e.lastPing=Date.now(),await this._add(e,t));return}const i=r.peers.filter(o=>!(o.peerId.equals(this.localPeer?.peerId)||o.lastPing>Date.now()-this.lastPingThreshold)).sort((o,a)=>o.lastPing<a.lastPing?-1:o.lastPing>a.lastPing?1:0).slice(0,this.numberOfNodesToPing);let s=!1;for await(const o of this.ping(i,t))s=!0,await this.remove(o.kadId,t);s&&await this._add(e,t)}*closest(e,t){const r=new Op(e,t?.count??this.kBucketSize);for(const i of this.toIterable())t?.exclude?.some(s=>s.equals(i.peerId))!==!0&&r.addWithKadId({id:i.peerId,multiaddrs:[]},i.kadId);yield*un(r.peers,({peer:i})=>i.id)}count(){function e(t){if(hl(t))return t.peers.length;let r=0;return t.left!=null&&(r+=e(t.left)),t.right!=null&&(r+=e(t.right)),r}return e(this.root)}get(e){const t=this._determineBucket(e),r=this._indexOf(t,e);return t.peers[r]}async remove(e,t){const r=this._determineBucket(e),i=this._indexOf(r,e);if(i>-1){const s=r.peers.splice(i,1)[0];await this.onRemove?.(s,r,t)}}*toIterable(){function*e(t){if(hl(t)){yield*t.peers;return}yield*e(t.left),yield*e(t.right)}yield*e(this.root)}distance(e,t){return BigInt("0x"+ee($s(e,t),"base16"))}_determineBucket(e){const t=ee(e,"base2");function r(i,s=0){return hl(i)?i:t[s]==="0"?r(i.left,s+1):r(i.right,s+1)}return r(this.root)}_indexOf(e,t){return e.peers.findIndex(r=>Ue(r.kadId,t))}async _split(e,t){const r={prefix:"0",depth:e.depth+1,peers:[]},i={prefix:"1",depth:e.depth+1,peers:[]};for(const s of e.peers)ee(s.kadId,"base2")[e.depth]==="0"?(r.peers.push(s),await this.onMove?.(s,e,r,t)):(i.peers.push(s),await this.onMove?.(s,e,i,t));MT(e,r,i)}}function MT(n,e,t){return delete n.peers,n.left=e,n.right=t,n.prefix===""&&(delete n.depth,delete n.prefix),!0}function FT(n,e){return n.lastPing<Date.now()-e}const Np=20,UT=6,$T=20,VT=100,qT=3,HT=20,zT=100,z3="kad-peer",KT=1,WT=6e5,GT=!0,jT=1e3;class QT extends tt{kBucketSize;kb;network;closestPeerTagger;log;components;running;pingNewContactTimeout;pingNewContactQueue;pingOldContactTimeout;pingOldContactQueue;populateFromDatastoreOnStart;populateFromDatastoreLimit;protocol;peerTagName;peerTagValue;metrics;shutdownController;constructor(e,t){super(),this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:routing-table`),this.kBucketSize=t.kBucketSize??Np,this.running=!1,this.protocol=t.protocol,this.network=t.network,this.peerTagName=t.peerTagName??z3,this.peerTagValue=t.peerTagValue??KT,this.pingOldContacts=this.pingOldContacts.bind(this),this.verifyNewContact=this.verifyNewContact.bind(this),this.peerAdded=this.peerAdded.bind(this),this.peerRemoved=this.peerRemoved.bind(this),this.populateFromDatastoreOnStart=t.populateFromDatastoreOnStart??GT,this.populateFromDatastoreLimit=t.populateFromDatastoreLimit??jT,this.shutdownController=new AbortController,this.shutdownController.signal,this.pingOldContactQueue=new oi({concurrency:t.pingOldContactConcurrency??HT,metricName:`${t.metricsPrefix}_ping_old_contact_queue`,metrics:this.components.metrics,maxSize:t.pingOldContactMaxQueueSize??zT}),this.pingOldContactTimeout=new $a({...t.pingOldContactTimeout??{},metrics:this.components.metrics,metricName:`${t.metricsPrefix}_routing_table_ping_old_contact_time_milliseconds`}),this.pingNewContactQueue=new oi({concurrency:t.pingNewContactConcurrency??$T,metricName:`${t.metricsPrefix}_ping_new_contact_queue`,metrics:this.components.metrics,maxSize:t.pingNewContactMaxQueueSize??VT}),this.pingNewContactTimeout=new $a({...t.pingNewContactTimeout??{},metrics:this.components.metrics,metricName:`${t.metricsPrefix}_routing_table_ping_new_contact_time_milliseconds`}),this.kb=new BT(e,{kBucketSize:t.kBucketSize,prefixLength:t.prefixLength,splitThreshold:t.splitThreshold,numberOfOldContactsToPing:t.numberOfOldContactsToPing,lastPingThreshold:t.lastPingThreshold,ping:this.pingOldContacts,verify:this.verifyNewContact,onAdd:this.peerAdded,onRemove:this.peerRemoved,metricsPrefix:t.metricsPrefix}),this.closestPeerTagger=new LT(this.components,{logPrefix:t.logPrefix,routingTable:this,peerSetSize:t.closestPeerSetSize,refreshInterval:t.closestPeerSetRefreshInterval,closeTagName:t.closeTagName,closeTagValue:t.closeTagValue}),this.components.metrics!=null&&(this.metrics={routingTableSize:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_size`),routingTableKadBucketTotal:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_total`),routingTableKadBucketAverageOccupancy:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_average_occupancy`),routingTableKadBucketMinOccupancy:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_min_occupancy`),routingTableKadBucketMaxOccupancy:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_max_occupancy`),routingTableKadBucketMaxDepth:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_max_depth`),kadBucketEvents:this.components.metrics.registerCounterGroup(`${t.metricsPrefix}_kad_bucket_events_total`)})}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.shutdownController=new AbortController,this.shutdownController.signal,await Sn(this.closestPeerTagger,this.kb))}async afterStart(){let e=0;Promise.resolve().then(async()=>{if(!this.populateFromDatastoreOnStart)return;const t=Re([this.shutdownController.signal,AbortSignal.timeout(2e4)]);try{for(const r of await this.components.peerStore.all({filters:[i=>i.protocols.includes(this.protocol)&&i.tags.has(z3)],limit:this.populateFromDatastoreLimit,signal:t})){if(!this.running)return;try{await this.add(r.id,{signal:t}),e++}catch{this.log("failed to add peer %p to routing table, removing kad-dht peer tags - %e"),await this.components.peerStore.merge(r.id,{tags:{[this.peerTagName]:void 0}})}}}finally{t.clear()}this.log("added %d peer store peers to the routing table",e)}).catch(t=>{this.log.error("error adding %d, peer store peers to the routing table - %e",e,t)})}async stop(){this.running=!1,await hi(this.closestPeerTagger,this.kb),this.pingOldContactQueue.abort(),this.pingNewContactQueue.abort(),this.shutdownController.abort()}async peerAdded(e,t,r){this.components.peerId.equals(e.peerId)||await this.components.peerStore.merge(e.peerId,{tags:{[this.peerTagName]:{value:this.peerTagValue}}},r),this.updateMetrics(),this.metrics?.kadBucketEvents.increment({peer_added:!0}),this.safeDispatchEvent("peer:add",{detail:e.peerId})}async peerRemoved(e,t,r){this.components.peerId.equals(e.peerId)||await this.components.peerStore.merge(e.peerId,{tags:{[this.peerTagName]:void 0}},r),this.updateMetrics(),this.metrics?.kadBucketEvents.increment({peer_removed:!0}),this.safeDispatchEvent("peer:remove",{detail:e.peerId})}async*pingOldContacts(e,t){if(!this.running)return;const r=[];for(const i of e){if(this.kb.get(i.kadId)==null){this.log("asked to ping contact %p that was not in routing table",i.peerId);continue}this.metrics?.kadBucketEvents.increment({ping_old_contact:!0}),r.push(async()=>{const s=this.pingOldContactQueue.find(i.peerId);if(s!=null)return this.log("asked to ping contact %p was already being pinged",i.peerId),await s.join(t)?void 0:i;if(!await this.pingOldContactQueue.add(async a=>{const c=this.pingOldContactTimeout.getTimeoutSignal(),l=Re([c,this.shutdownController.signal,a?.signal]);try{return await this.pingContact(i,a)}catch{return this.metrics?.kadBucketEvents.increment({ping_old_contact_error:!0}),!0}finally{this.pingOldContactTimeout.cleanUp(c),l.clear()}},{peerId:i.peerId,signal:t?.signal}))return i})}for await(const i of is(r))i!=null&&(yield i)}async verifyNewContact(e,t){const r=this.pingNewContactTimeout.getTimeoutSignal(),i=Re([r,this.shutdownController.signal,t?.signal]);try{const s=this.pingNewContactQueue.find(e.peerId);return s!=null?(this.log("joining existing ping to add new peer %p to routing table",e.peerId),await s.join({signal:i})):await this.pingNewContactQueue.add(async o=>(this.metrics?.kadBucketEvents.increment({ping_new_contact:!0}),this.log("pinging new peer %p before adding to routing table",e.peerId),this.pingContact(e,o)),{peerId:e.peerId,signal:i})}catch{return this.log.trace("tried to add peer %p but they were not online",e.peerId),this.metrics?.kadBucketEvents.increment({ping_new_contact_error:!0}),!1}finally{this.pingNewContactTimeout.cleanUp(r),i.clear()}}async pingContact(e,t){try{return this.log("pinging contact %p",e.peerId),await this.components.ping.ping(e.peerId,t),this.log("contact %p ping ok",e.peerId),this.safeDispatchEvent("peer:ping",{detail:e.peerId}),!0}catch(r){return this.log("error pinging old contact %p - %e",e.peerId,r),!1}}get size(){return this.kb==null?0:this.kb.count()}async find(e,t){const r=await An(e,t);return this.kb.get(r)?.peerId}closestPeer(e){const t=this.closestPeers(e,{count:1});if(t.length>0)return t[0]}closestPeers(e,t){return this.kb==null?[]:[...this.kb.closest(e,t)]}async add(e,t){if(this.kb==null)throw new Error("RoutingTable is not started");await this.kb.add(e,t)}async remove(e,t){if(this.kb==null)throw new Error("RoutingTable is not started");const r=await An(e,t);await this.kb.remove(r,t)}updateMetrics(){if(this.metrics==null||this.kb==null)return;let e=0,t=0,r=0,i=20,s=0;function o(a){if(hl(a)){a.depth>r&&(r=a.depth),t++,e+=a.peers.length,a.peers.length<i&&(i=a.peers.length),a.peers.length>s&&(s=a.peers.length);return}o(a.left),o(a.right)}o(this.kb.root),this.metrics.routingTableSize.update(e),this.metrics.routingTableKadBucketTotal.update(t),this.metrics.routingTableKadBucketAverageOccupancy.update(Math.round(e/t)),this.metrics.routingTableKadBucketMinOccupancy.update(i),this.metrics.routingTableKadBucketMaxOccupancy.update(s),this.metrics.routingTableKadBucketMaxDepth.update(r)}}const YT=[77591,22417,43971,28421,740,29829,71467,228973,196661,78537,27689,36431,44415,14362,19456,106025,96308,2882,49509,21149,87173,131409,75844,23676,121838,30291,17492,2953,7564,110620,129477,127283,53113,72417,165166,109690,21200,102125,24049,71504,90342,25307,72039,26812,26715,32264,133800,71161,88956,171987,51779,24425,16671,30251,186294,247761,14202,2121,8465,35024,4876,85917,169730,3638,256836,96184,943,18678,6583,52907,35807,112254,214097,18796,11595,9243,23554,887,268203,382004,24590,111335,11625,16619,29039,102425,69006,97976,92362,32552,63717,41433,128974,137630,59943,10019,13986,35430,33665,108037,43799,43280,38195,29078,58629,18265,14425,46832,235538,40830,77881,110717,58937,3463,325358,51300,47623,117252,19007,10170,20540,91237,294813,4951,79841,56232,36270,128547,69209,66275,100156,32063,73531,34439,80937,28892,44466,88595,216307,32583,49620,16605,82127,45807,21630,78726,20235,40163,111007,96926,5567,72083,21665,58844,39419,179767,48328,42662,51550,5251,37811,49608,81056,50854,55513,20922,18891,197409,164656,32593,71449,220474,58919,85682,67854,13758,35066,3565,61905,214793,119572,141419,21504,10302,27354,67003,46131,32668,15165,64871,34450,17821,2757,11452,34189,5160,12257,85523,560,53385,65887,119549,135620,312353,115979,122356,10867,193231,124537,54783,90675,120791,4715,142253,50943,17271,43358,25331,4917,120566,34580,12878,33786,160528,32523,4869,301307,104817,81491,23276,8832,97911,31265,52065,7998,49622,9715,43998,34091,84587,20664,69041,29419,53205,10838,58288,116145,6185,5154,141795,35924,21307,144738,43730,12085,8279,10002,119,133779,199668,72938,31768,39176,67875,38453,9700,44144,4121,116048,41733,12868,82669,92308,128,34262,11332,7712,90764,36141,13553,71312,77470,117314,96549,49135,23602,54468,28605,6327,62308,17171,67531,21319,14105,894,107722,46157,8503,51069,100472,45138,15246,14577,35609,191464,1757,13364,161349,32067,91705,81144,52339,5408,91066,21983,14157,100545,4372,26630,129112,1423,29676,213626,4397,88436,99190,6877,49958,26122,114348,60661,29818,293118,50042,179738,16400,163423,89627,31040,43973,36638,45952,5153,1894,109322,1898,134021,12402,112077,68309,190269,69866,31938,107383,11522,105232,11248,14868,39852,71707,186525,16530,38162,106212,11700,5130,16608,26998,59586,108399,230033,43683,48135,82179,2073,5015,196684,189293,16378,23452,8301,35640,11632,214551,29240,57644,33137,91949,55157,52384,117313,5090,17717,89668,49363,82238,241035,66216,29066,184088,97206,62820,26595,4241,135635,173672,8202,459,71355,146294,29587,3008,135385,141203,14803,6634,45094,69362,50925,546,51884,62011,83296,234584,44515,56050,89476,87751,19373,12691,149923,19794,13833,35846,87557,58339,2884,19145,25647,12224,11024,77338,64608,122297,53025,7205,36189,36294,170779,21750,7739,173883,75192,35664,224240,113121,30181,26267,27036,117827,92015,106516,55628,203549,67949,60462,60844,35911,20457,1820,920,19773,8738,73173,181993,38521,98254,76257,46008,92796,5384,26868,151566,22124,2411,15919,186872,180021,28099,152961,78811,80237,62352,102653,74259,184890,16792,123702,224945,29940,19512,75283,14059,112691,92811,233329,20411,138569,53341,109802,50600,134528,66747,5529,166531,31578,64732,67189,1596,126357,967,167999,206598,109752,119431,207825,78791,91938,10301,27311,24233,252343,28831,32812,66002,112267,90895,8786,8095,16824,22866,21813,60507,174833,19549,130985,117051,52110,6938,81923,123864,38061,919,18680,53534,46739,112893,161529,85429,26761,11900,81121,91968,15390,217947,56524,1713,6654,37089,85630,138866,61850,16491,75577,16884,98296,73523,6140,44645,6062,36366,29844,57946,37932,42472,5266,20834,19309,33753,127182,134259,35810,41805,45878,312001,14881,47757,49251,120050,44252,3708,25856,107864,120347,1228,36550,41682,34496,47025,8393,173365,246526,12894,161607,35670,90785,126572,2095,124731,157033,58694,554,12786,9642,4817,16136,47864,174698,66992,4639,69284,10625,40710,27763,51738,30404,264105,137904,109882,52487,42824,57514,2740,10479,146799,107390,16586,88038,174951,9410,16185,44158,5568,40658,46108,12763,97385,26175,108859,664,230732,67470,46663,14395,50750,141320,93140,15361,47997,55784,6791,307840,118569,107326,18056,58281,260415,54691,8790,73332,45633,7511,45674,143373,14031,11799,94491,35646,96544,14560,26049,32983,25791,83814,42094,231370,63955,139212,2359,169908,3108,183486,105867,28197,32941,124968,26402,88267,149768,23053,3078,19091,52924,25383,19209,111548,97361,3959,24880,235061,9099,24921,161254,151405,20508,7159,34381,20133,11434,74036,19974,34769,36585,1076,22454,17354,38727,235160,111547,96454,117448,156940,91330,37299,7310,26915,117060,51369,22620,61861,322264,106850,111694,15091,2624,40345,300446,177064,1707,27389,54792,327783,132669,183543,59003,17744,20603,151134,106923,53084,71803,279424,319816,11579,21946,16728,38274,72711,5085,83391,88646,40159,25027,34680,10752,12988,54126,30365,18338,100445,230674,44874,84974,143877,123253,139372,28082,91477,144002,13096,219729,46016,50029,42377,14601,6660,58244,58978,23918,88206,113611,64452,17541,41032,10942,12021,49189,10978,40175,37156,10947,71709,106894,112538,57007,137486,150608,152719,40615,7746,279716,13101,19524,28708,40578,72320,1096,182051,94527,51275,22833,45164,81917,77519,48508,5421,140302,37845,149830,5587,27579,5357,428725,248187,6326,206760,39814,32585,89923,44341,288753,284443,96368,31201,94189,119504,20359,52073,103216,179,27934,32801,96035,34111,34309,101326,18198,20704,210266,37643,27880,141873,106e3,19414,56614,167714,66483,107885,86602,4379,20796,75467,4987,5017,118857,26003,34308,114428,29198,6686,29697,73632,3739,69795,16798,41504,7207,30722,21436,36735,28067,28545,3239,11221,36031,41889,100010,19247,317673,29495,174554,6424,129725,53845,94986,7955,59676,2604,191497,19735,102214,62954,23844,11872,179525,261436,34492,428,78404,142035,16747,17246,27578,37021,33672,57944,26056,135760,2369,61674,122066,31327,19374,157065,40553,130982,69619,71290,38855,72100,92903,95940,51422,165999,65713,57873,50726,7288,20272,2081,42326,22624,81120,57914,79352,19447,1684,72302,11774,302559,161481,96396,13692,414988,3721,79066,56627,46883,21150,11747,12184,5856,113458,176117,84416,52079,27933,3354,59765,141359,2212,216309,2555,23458,196722,142463,45701,44548,28798,19418,215,29916,9396,10574,114226,84475,13520,18694,34056,4524,90302,62930,13539,19407,77209,7728,38088,9535,2263,23875,183945,17750,26274,67172,10585,28042,22199,7478,51331,66030,26774,192929,31434,25850,50197,52926,178158,4679,181256,70184,229600,9959,105594,72158,73974,2726,35085,78087,23284,35568,51713,155676,5401,27254,11966,17569,223253,71993,103357,111477,55722,30504,26034,46774,35392,36285,214814,41143,163465,1051,16094,81044,6636,76489,179102,20712,39178,35683,125177,54219,30617,52994,25324,50123,2543,87529,58995,10688,125199,12388,60158,125481,131646,7642,133350,65874,3438,97277,101450,10075,56344,116821,50778,60547,98016,106135,13859,14255,16300,77373,173521,8285,45932,37426,4054,114295,55947,7703,39114,52,51119,128135,19714,60715,9554,50492,88180,2823,118271,52993,122625,97919,23859,37895,25040,33614,32102,20431,3577,9275,15686,43031,157741,110358,1884,40291,125391,13736,5008,64881,87336,77381,70711,43032,49155,118587,70494,4318,10168,30126,12580,10524,280104,104001,145413,2862,84140,6603,106005,13566,12780,11251,42830,571,179910,82443,13146,469,42714,32591,265217,424024,92553,54721,134100,6007,15242,114681,59030,16718,85465,200214,85982,55174,165013,23493,56964,82529,109150,32706,27568,82442,5350,14976,13165,44890,60021,21343,33978,17264,4655,22328,27819,75730,16567,55483,14510,17926,45827,150609,3704,7385,272531,161543,76904,122163,52405,2039,19165,41623,14423,228354,3369,176360,85491,7122,35789,303724,4465,13628,2233,55311,118771,20713,10006,221519,45115,71021,35650,29775,7337,10864,20665,21142,1746,15080,1624,32449,10905,105743,229797,7701,3940,22997,178467,57208,389057,39683,59403,63344,63125,54847,69691,18336,56448,3362,37202,18282,29648,138224,35867,10495,5911,28814,26653,31514,176702,26550,45621,11734,4525,40543,73944,121080,27858,155561,14887,44670,30742,8796,107455,113472,56369,75581,183777,240095,133699,153299,8768,160464,26058,49078,103971,21875,71486,44888,17156,9678,89541,123019,102337,3972,83930,21245,87852,109660,287918,183019,686,10100,39177,283941,11274,24736,26793,26214,25995,77011,141580,4070,23742,46285,46632,30700,26669,19056,35951,115575,174034,56097,35463,87425,24575,44245,38701,82317,85922,281616,100333,147697,61503,7730,84330,8530,59917,61597,17173,9092,32658,90288,193136,39023,20381,56654,31132,7779,1919,1375,117128,30819,11169,40938,23935,115201,101155,151034,4835,11231,74550,89388,59951,91704,107312,167882,115062,12732,72738,88703,464019,158267,57995,60496,737,14371,123867,4174,243339,159946,7568,16025,134556,110916,38103,191,80226,88794,29688,27230,10454,76308,57647,77409,113483,66864,14745,19808,12023,46583,84805,16015,17102,2231,20611,3547,95740,250131,34559,108894,8498,15853,159169,148920,20942,2813,93160,45188,210613,45531,52587,149062,39782,28194,57849,60965,84954,89766,84453,100927,16501,27658,165311,103841,54192,207341,19558,20084,319622,5672,205467,98462,61849,36279,13609,147177,24726,165015,209489,59591,31157,6551,117580,75060,141146,277310,21072,22023,106474,63041,137443,122965,68371,5383,42146,98961,113467,30863,23794,4843,99630,30392,82679,13699,241612,33601,93146,24319,18643,32155,95669,40440,15333,34089,67799,142144,58245,38633,114531,117400,77861,188726,5507,2568,8853,10987,107222,2663,2421,11530,13345,30075,41785,118661,104786,17459,12490,16281,71936,193555,17431,5944,71758,26485,77317,20803,367167,158,7362,93430,11735,172445,46002,11532,54482,930,62911,2235,23004,179236,4764,101859,208113,22477,55163,95579,14098,67320,162556,90709,156949,3826,57492,4025,34092,87442,104565,6718,186015,28214,14209,10039,107186,233912,58877,81637,55265,39828,6194,145813,50831,105849,4974,88319,122296,10272,197216,95714,51540,72418,23324,91555,8743,140452,250249,51666,34124,7229,38592,129641,78169,174242,22464,149964,51450,14034,10026,95376,26190,120062,14401,8700,265,31386,143573,7203,229889,61567,4227,140981,2466,72052,10787,10062,30958,6099,38471,30103,23202,208101,70847,467,58934,32271,32984,36637,24107,30771,17109,73353,13650,2098,157040,67366,66904,106018,265380,107238,18535,44025,32681,144983,62505,91295,56120,3082,77508,10322,63023,36700,81885,224127,16721,45023,239261,111272,13852,7866,149243,204199,32309,22084,42029,38316,126644,104973,14406,43454,67322,61310,15789,40285,24026,181047,6301,70927,23319,115823,27248,66693,115875,278566,63007,146844,56841,59007,87368,180001,22370,42114,80605,12022,10374,308,25079,14689,12618,63368,7936,264973,212291,136713,95999,105801,18965,32075,48700,52230,35119,96912,32992,8586,16606,101333,101812,14969,39930,759,193090,27387,42914,12937,5058,62646,64528,38624,25743,37502,3716,4435,30352,178687,26461,132611,42002,138442,35833,59582,16345,8048,60319,49349,309,47800,49739,90482,26405,34470,63786,32479,85028,39866,47846,11649,23934,29466,2816,42864,31828,7410,74885,49632,47629,111801,90749,19536,18767,105764,59606,21223,10746,76298,22220,39408,7190,79654,64856,11602,82156,272765,17079,70089,245473,51813,184407,384678,1576,122249,5064,27481,6188,25790,74361,27541,318284,45430,31488,620,93579,45723,192118,22670,51913,4162,70244,35966,26397,16199,50899,209613,121702,287507,2993,36101,132229,67345,33062,76295,118628,78705,52316,34375,107083,107454,44863,127561,33964,3073,154010,190914,55967,39074,6272,31047,5550,41123,26154,98638,47110,19998,148091,50229,31329,59900,195442,19106,61347,73497,70015,682,45850,25776,38022,148951,6288,37411,232526,109277,27286,32342,9262,5220,16651,23175,46740,129438,78614,121925,66914,88710,127952,5563,21500,34521,10739,14863,191006,62956,17359,16749,67027,56284,69134,43301,35039,58883,54466,60823,404451,75743,59856,86979,7923,34273,83785,32142,7693,268986,197428,282681,17049,22346,22990,92245,107180,3357,37104,96724,49153,7683,31197,43267,82231,164276,23696,20848,188364,22309,24821,158707,1018,22514,70922,27792,45589,59709,10765,736,35218,63479,51987,24275,63588,55361,92929,81964,4658,20122,12330,44058,13065,311456,72224,8337,211229,38979,22590,138478,52757,32595,133600,8838,31549,94412,43391,90056,1585,94802,127271,6223,31889,137038,132910,2165,57616,230152,6080,10748,36737,74579,134062,50525,180532,119270,34556,76155,82394,52595,29258,31435,87820,67996,26943,183878,38007,2410,13526,180297,69856,3503,187396,167700,7838,16701,9199,56267,3661,37407,65994,23767,5708,62508,221700,67088,86978,46776,84434,32088,5612,9149,88244,21685,95151,46750,189612,2979,506311,2594,3628,40074,105039,78243,28523,6651,38058,71999,30992,12764,68261,108991,6165,26450,61961,13400,22426,7490,60890,109623,2070,12958,50355,67979,257096,7213,42578,52121,35716,65461,7516,124758,39268,302,64712,14977,1467,219452,2840,34229,11121,21602,19270,63574,8024,1532,17331,79839,78885,52029,180767,57957,6069,91265,61380,55767,8927,32881,287603,22149,35029,68876,6428,199567,46926,13412,104132,21434,366616,45060,110046,81924,128910,45886,52821,130416,29416,77342,21762,67329,121432,79924,11724,38625,81006,102033,28338,13326,3250,82056,82526,38212,21112,12382,111495,3263,7414,86274,93490,40844,30224,45212,24019,48411,71367,24941,76729,57776,3769,38114,202019,197745,31953,237533,33270,201580,255648,100798,44741,32241,98468,106931,10085,15090,170358,33154,66787,18819,69760,25061,234005,82660,6295,131975,16874,9076,4094,25005,17740,40908,19533,220019,44330,99792,50040,19619,13950,55228,24423,31253,95308,103177,184795,28590,82285,5059,3210,75525,49894,70007,56178,10580,36051,139681,21617,98736,3555,106306,164189,37352,63915,47824,24883,145530,61904,28444,11483,19837,145446,30420,112972,85939,11835,191233,2262,20705,58630,1753,148334,1197,144714,6887,11223,107667,60879,77914,4151,57417,81594,96681,169430,1784,20444,95138,254041,27038,596,7117,72808,13759,3353,126776,21074,55322,27081,36942,39547,139830,179275,4453,713,8722,71399,19204,25785,22794,23923,104114,11291,25458,102309,88396,75288,230440,206396,104551,58447,130857,37247,94734,31548,176529,226077,65159,20104,10096,66881,94191,237909,27109,37404,1520,27421,25220,113003,23423,24884,50585,6286,231877,150800,11789,3226,90004,60642,5053,202400,61442,132531,175329,57138,30116,103847,9973,75367,16452,32360,59119,21246,10191,164804,23305,61051,37348,154530,13214,5468,50403,66754,130976,50559,80515,14436,155492,84017,5472,43107,41240,2890,90431,70188,382,76234,48040,50211,281038,237007,32115,142178,1536,22761,96429,1811,31243,1679,49143,55209,17402,235054,61494,7462,77030,34925,87609,78002,9499,9027,73289,201078,101379,63544,27666,5469,10642,30029,49816,132979,95620,58086,351930,116300,2110,2043,30845,6154,11279,16727,4122,2277,27281,4971,3650,39060,61970,65951,39674,75686,38151,11370,130809,177895,32665,63725,122267,7857,39618,118483,44792,157755,178624,136994,24260,41308,22471,12404,21707,12486,30473,52781,50246,20247,39065,909,56825,103158,128603,31542,1089,41935,32744,12428,37963,84420,33134,72921,208449,42622,168151,127335,147107,46699,38216,12591,94342,85814,31423,24944,2605,87542,67473,192551,4496,56321,91819,17630,6300,256183,114569,202090,33209,35289,34897,24967,40520,43470,5344,10199,34810,14283,10381,10017,62923,49924,23233,64539,13051,35686,19698,11570,135555,120868,44924,87065,52318,52335,47586,140906,245885,109834,78668,9065,46990,25258,72022,61243,40838,4545,146387,10537,11557,17470,36930,68104,46711,24264,79401,81043,18225,120488,24746,84338,81652,28266,13776,21878,46973,1047,230465,73357,95777,24973,210160,62210,58404,110633,169651,6937,41870,9909,26822,191062,76553,27519,96256,239070,2478,205678,67955,58532,20601,50120,19148,78501,195724,110740,8249,109665,27446,30568,57631,31425,49752,32820,65504,50079,3663,102256,219898,23849,211315,14645,4359,91767,9528,12449,49366,7941,49763,107848,8930,27086,50686,9744,10447,81935,39513,46514,1670,29229,6172,22312,137280,97759,9806,14445,22976,56458,73391,34983,93760,174219,52573,33149,59747,2429,136277,75123,165263,91040,7446,57632,48633,97140,246081,84766,151684,79918,93268,120346,54059,54875,77858,32996,103590,45276,11968,19600,25849,17159,132907,42828,16817,4913,99462,103303,27395,5737,74184,20749,21160,14377,77062,131403,158735,10999,27799,77785,9320,34366,51593,61070,33746,47048,29268,36675,30262,53297,9832,82e3,20188,122292,39917,7331,18160,68301,185935,134830,15031,4935,10004,165845,185534,46923,30109,44134,122631,18874,22903,112790,26561,18549,348902,82871,140345,255565,135390,63556,103747,145055,179600,145662,296111,61661,211987,23952,52342,126343,48450,32919,44277,82185,9591,62139,205363,376969,394874,108461,18040,120885,14798,39863,16571,16794,58271,81025,55206,14640,118656,6361,44092,85970,6262,153863,108244,180200,72264,79947,38044,10050,5735,61221,80712,5471,115689,11391,11661,184257,20010,60116,30320,19327,134598,45455,27542,18004,125092,452272,1549,91523,46567,180063,156026,2608,11174,58848,37788,65907,80194,30490,5786,40775,119519,106241,11323,156297,8425,61495,2617,29675,2425,59886,112582,49142,59618,4863,50597,86710,50650,168632,27693,85641,83643,18993,25768,84284,28090,93592,36627,312804,43381,9887,9402,100931,97165,3311,173330,66805,28935,4963,184460,3201,78102,19126,21607,37496,24938,22615,16153,32862,134792,153318,61120,6067,2812,12826,12792,23825,37559,64662,202250,102694,155488,85881,149193,46233,65383,15521,106982,11358,176786,25752,39717,34208,24510,32464,77742,39371,72028,138229,60688,71386,102834,132477,2208,11548,63670,271279,28351,30338,38620,32491,99845,143885,152266,13252,2825,178663,108097,1775,78201,14897,113573,163346,62292,171129,22183,96598,38733,64971,166776,117445,9968,146393,44677,74867,20908,97328,12761,25656,26785,9148,112344,26115,99176,110121,22437,49547,6180,79320,5835,31392,43328,33377,75870,119860,69497,80273,7325,155219,43167,111173,28347,20222,3763,71752,55041,47252,14618,28088,15012,97805,194698,54636,2036,41349,6173,96604,61530,51859,43782,13361,24334,22668,24792,7070,23441,16789,3209,36211,208475,26242,32880,122181,182407,21444,31060,88459,29929,77907,12716,10934,97005,20599,31690,8403,58445,30303,22700,10336,86731,103115,337709,72556,46788,112566,47684,67089,53548,36874,56487,41387,125985,26893,40071,106683,73712,18787,40105,72992,67246,137276,50802,36790,70328,138827,22466,39263,183295,29858,50975,9322,57397,10654,24364,30383,55799,41600,23584,127295,296610,129078,143558,244131,86397,36049,1085,80677,3820,108139,5476,34767,24683,7758,13060,7239,131671,250593,59556,103392,29810,4188,252323,39404,116877,7651,43600,40338,13554,157253,39196,25978,144387,61211,234,50104,6129,10449,93777,9240,356378,274148,4439,72970,3724,147770,78680,62570,115877,40027,40547,36817,224392,64609,34795,165027,67440,2477,37206,23431,50754,164797,46018,94995,170982,27051,7957,22767,3674,27900,56419,18930,60701,41302,2692,84749,339721,61996,111094,80221,50129,1045,8153,62945,19202,8250,37208,37418,32560,79477,41106,88569,33963,36693,5892,30570,1581,66471,49647,11922,160717,29442,5643,114865,82962,95982,132098,22633,22838,94726,54556,28566,205039,162340,33216,16849,35847,221339,94851,26533,71469,1805,3804,12935,45483,71020,36310,65381,192960,34240,35165,59773,1248,46954,155332,96864,4246,388800,16129,57133,74592,44807,442014,38203,42574,80818,91592,26377,36424,65760,977,77387,22628,147610,28018,30561,98454,6969,119628,63648,18170,36854,26601,64018,22027,37279,51395,152934,21153,9430,58760,194742,5330,55115,34158,28917,174111,13171,122326,1526,43896,66094,25325,4234,148354,11450,275,18999,112191,44365,22723,68409,8733,57746,96565,75007,14196,108844,29475,88599,177563,100792,106156,86323,93726,14248,135341,194131,40126,47099,14779,8272,39597,95983,171398,65882,28052,10393,47213,40689,22120,72212,106829,34964,109146,753,648,21660,30047,17527,181025,5619,145357,4085,216883,9359,186951,24779,53931,24545,36197,223296,62628,168101,4243,107313,30321,26642,13049,51059,31027,107912,807,73550,26551,84369,122422,165872,49754,74213,234264,33151,52014,33100,87183,22365,52500,40013,23302,5652,72723,21404,26107,48434,587,94049,168493,96418,32871,70860,31709,25128,443,71597,166253,15670,70994,26341,133675,28280,75491,54756,47955,56028,26182,11952,113272,472197,64640,110753,17919,337,50642,22576,142,87371,53391,93210,126694,15285,19642,85667,14148,1506,42092,52962,33243,11970,20734,135843,57044,58880,13002,219134,22876,64754,232519,4257,43120,321573,24799,64526,124728,52579,81472,70831,276848,17403,74359,23021,182101,74597,23744,148267,12055,7976,5349,11772,67540,167347,65318,18720,127832,108238,22828,90233,9987,259080,118185,73209,79270,13775,90100,137742,90799,70569,15699,19961,9087,67475,57872,39731,8810,134897,131868,146849,19898,3334,2281,167061,91073,60356,467742,74712,188,53179,137679,92769,29241,9537,132595,80119,1041,88962,5976,40171,44911,102859,139059,104558,98987,47761,19272,71472,113864,175377,73338,10857,23402,23758,1591,139864,5644,4076,118760,16427,134198,18853,20291,100849,37423,22038,36677,19071,195521,57445,11069,31869,55718,66882,148490,44,41296,75242,49704,166810,9906,20943,122258,49112,105667,15969,10344,6408,187694,21399,72742,58970,14867,14376,81889,41856,23225,15042,56993,16074,131389,74276,72407,53875,383108,53597,37363,68993,44854,122548,430927,198279,38430,80409,12245,2981,628,2818,17760,37437,238229,7968,46892,2200,3730,34190,65983,37959,112291,87850,70827,6522,20750,73913,111621,41652,19587,2780,58668,25916,85259,18200,168962,95781,42445,102050,7776,57662,103313,47742,96358,41964,66174,100396,29069,204735,19679,27978,7479,40264,22534,61183,36081,107436,58223,14680,23002,101311,24716,124108,12908,5646,31750,40380,14215,232799,102772,14122,96775,61398,50917,12096,149880,67833,598749,124194,155871,49216,790,14677,65319,56917,7440,145744,95701,12206,49405,129269,76199,45732,9767,11058,9047,210885,11051,7392,26307,2130,8132,147526,20802,232698,115660,50060,59789,57344,107623,80343,112676,23291,9866,160971,34032,118291,15719,59730,164911,28975,2659,58046,78480,21854,66209,53863,109085,116045,29021,46481,107552,22130,18764,70254,31272,11300,52460,43933,84738,20721,53869,190840,79673,105300,7561,321817,66924,13940,33281,101046,183181,32176,71878,5678,62924,79535,56646,40303,19559,27703,93042,73368,42187,3670,37376,46440,7023,36816,109628,20680,5940,276440,275233,170848,112093,136996,14984,20226,111441,77693,112960,48577,39370,55707,50314,123404,26570,54281,61372,123391,4857,35928,246740,132507,106646,44241,7196,92258,9825,37688,51197,303141,5590,15476,132986,10955,85782,34486,26696,7991,28813,18858,39546,11703,11365,38185,5716,93555,11925,40121,60002,6985,10976,171384,3887,43394,13337,56346,6381,252336,39573,75042,53711,1028,31781,44295,95925,131713,7214,68125,43571,70954,213234,1628,8760,13391,65485,17320,56038,1710,25248,60803,57399,19839,3870,326,281556,50945,72400,21460,316244,75619,56246,98775,481,13513,55765,50427,7388,123519,32929,57908,27124,61316,101097,57467,30228,48792,10788,20402,37318,50526,155730,34456,158065,145305,17832,43733,64052,4506,35072,205355,177028,184004,187081,68616,35938,83703,10367,36892,93186,260137,51934,89970,4985,23445,26755,21558,7948,78741,23376,124405,85594,68596,57536,49351,12619,56593,132668,99924,109728,71844,71935,196018,65464,17617,14987,89701,143773,33997,8687,22701,33258,2914,4436,72108,85610,9671,49067,2327,82988,1361,1672,44033,35777,30269,24057,10605,82236,616,15793,13919,47249,112086,116698,9484,80207,90574,33304,68624,93127,56101,42210,160929,4827,38995,38095,4701,125119,5027,33680,9236,231236,14135,87837,23318,70261,78893,30151,81482,14332,1084,74256,27532,46644,79185,3148,62615,6981,55672,31668,36825,1849,14536,37446,14738,23779,43058,162749,72199,1168,21346,5592,85932,85302,9668,18351,57135,150360,2080,228015,77953,34670,119302,151751,31009,106725,84265,45214,59289,74178,113071,263206,111009,4021,44449,188119,192629,123592,392506,292847,114487,12831,205858,9852,20780,79648,75767,357014,97721,18166,21005,67950,33226,204009,16536,2987,11335,66717,144910,47950,17262,55060,15063,2934,51038,26775,178497,66008,3427,49433,128592,20036,157553,63861,3089,23015,51210,28696,35933,49942,71135,231518,99620,17248,21835,176536,20676,16944,38700,165831,233253,295625,36723,13023,52745,10907,19423,67972,125868,95473,82875,1183,108455,52685,33417,64095,21433,52438,33191,127809,44505,211823,7810,2752,95548,162031,7185,91196,47563,61721,33359,17897,23682,42806,178101,22874,49707,199897,75419,82456,8618,11171,79712,116847,18783,44190,46564,5346,59046,95032,7893,14916,3214,26800,24172,121453,34362,10250,17408,18888,4840,68696,22831,13162,36005,32512,14800,62357,41723,45046,27247,37486,5372,2564,34261,298500,66509,133920,89138,31305,117697,19097,108304,81386,84106,23802,46411,63304,946,51417,41777,41041,19501,115864,60743,294354,37955,94165,18116,1156,17937,20645,57114,90804,58042,48643,92288,9861,2557,88546,61333,101008,12853,5148,87856,4152,144503,73841,18718,9789,147565,10846,42085,12789,30223,8993,56352,67203,2448,28215,6052,23540,126319,75933,36689,80235,23231,23561,21383,38800,77548,102798,21234,31468,158608,46188,63960,191679,8051,67014,11185,170078,42186,28827,34777,41930,212079,12421,34750,24111,110344,73918,45171,70826,141949,40063,23979,24254,37309,26724,27179,24718,83648,54938,14591,17425,29525,102675,48975,48654,12316,8929,60640,41709,50168,63264,89812,50716,48632,38755,138583,160123,55579,71829,24230,233277,46322,39650,166388,34718,24108,98252,7031,106695,62498,18258,35062,217827,78731,34824,33354,19520,60852,2432,60224,8587,2836,62955,702,20227,42285,40560,95592,62486,11094,53035,143291,18842,46177,77994,1770,9657,107422,172915,32655,128716,25886,25164,156740,119928,165875,85817,11007,89110,33956,12652,65156,180266,8494,36889,19958,20955,96,1264,118288,135769,44754,86671,5632,19026,168220,289120,33569,93821,66144,70635,7687,5642,2714,55445,56636,71545,184182,93133,7332,37389,12643,52315,22729,11014,158742,17050,152889,50178,34601,41945,52136,9948,26914,63548,95721,115951,40759,8960,158258,38938,49232,48325,42234,81523,253019,66128,40978,20048,238048,38760,62928,122560,118532,43687,137472,163689,26680,9878,17448,51035,16211,60834,36749,29178,14241,59868,150086,2305,26477,42422,34342,165341,83279,33894,14257,29928,12743,13957,125571,89134,66712,10952,16507,147839,30146,7249,16565,45399,39874,114565,215780,31990,230881,171477,102,196546,44538,10880,84948,281705,86651,10617,31395,2342,453658,43569,60561,132901,21845,17727,58556,258242,22262,58728,4008,77997,11806,37431,30599,81375,109137,185787,114085,217292,97453,169085,30593,60212,11544,102056,65580,2384,91655,4855,95725,7295,157994,16228,20669,53276,141590,105246,17334,25440,76067,17967,39321,38911,11362,28559,63807,21627,26468,85816,40120,1025,15234,58319,69516,66512,124548,75845,78873,22137,46681,51242,85683,32909,76747,35555,43396,101465,1765,73094,1077,2962,39028,66777,57831,42048,15828,13962,36041,63657,52412,5242,58846,2141,5506,219012,134451,3936,182230,17558,17153,152237,22621,49377,170216,35257,68233,65374,6510,11126,212151,7184,2480,22517,3437,33073,30156,16557,3768,55067,86829,91e3,12350,148650,66017,79424,70885,49066,28250,21369,51213,34533,11510,3258,18176,18465,84413,6315,36411,163765,4346,356,107618,598,13727,285026,162695,8749,14583,7132,63521,184253,32378,25991,5604,30961,53675,4874,84693,5086,34811,26978,56564,7904,33519,51221,113942,69253,6664,125563,22055,220680,102008,742,51930,19494,176108,44424,35123,13025,75685,11759,74335,22250,181453,131147,16984,132115,154311,11991,76452,52609,85351,196,30969,9198,74919,2529,56838,71779,29187,116304,3504,62330,41190,86153,28393,254926,104228,105189,13264,84359,3574,12415,8534,57147,10175,188174,59504,60932,66318,16407,107921,17638,99103,49278,28403,39786,145865,8462,3558,43406,142271,29139,21989,36552,93955,72365,7176,13556,106185,37957,321774,17782,129017,51154,27938,24952,1935,39366,2791,33489,41582,56078,24558,9311,5449,218786,27808,190429,68013,36020,86003,29735,3404,87348,119357,115714,2324,86796,81973,40992,43376,93621,28784,16808,36367,2517,2909,191926,24978,55303,53308,205724,60068,3098,21375,64784,23949,26579,63121,12319,80145,39967,97861,6757,70143,67642,37082,34698,69140,122883,46151,62187,80934,429,19437,135071,137885,222647,13331,154065,327,61778,74257,40116,37493,14855,85079,237641,42342,102164,199965,71204,4662,29368,5042,113914,122214,8955,13149,102503,43173,5659,163787,69003,307084,63392,171080,21390,81918,86666,36622,24126,28887,5736,28054,207170,163428,79891,346467,95363,38980,111806,80828,9200,19288,294896,114468,87405,111715,141705,7015,72754,68463,48738,243147,33397,101210,37051,98801,82847,20397,4940,185559,18716,54718,83491,11725,40803,1128,12128,23060,5174,7745,67007,46701,1571,27807,180186,256996,18975,16837,7877,212758,250379,15440,87954,57755,24719,124057,83461,258,50864,8874,29038,71289,31627,15429,9005,4061,113851,107716,82819,13651,79656,117851,17539,111446,12938,39724,190787,4352,15402,21070,62708,8539,23777,73853,13552,38810,86117,16285,56400,1718,75342,142863,29033,378,110113,180321,32586,23606,26393,160984,207987,23783,8406,16904,24596,47274,11693,46539,60524,78595,48423,31718,20170,9009,146268,15183,191060,172765,1349,138436,37365,10970,40509,225817,20021,70394,152138,21541,66559,66544,89352,2725,17258,91345,7313,3815,115868,8660,40362,4071,103524,39388,118275,21950,6549,38226,32754,209574,29201,43495,18028,20296,40597,18370,47520,202450,24134,2219,8195,69545,38041,136934,46374,19041,159811,84865,58620,846,98749,13569,30714,97246,32186,4479,27355,92973,35214,151491,75963,37631,1561,27200,238083,23182,60756,12291,25766,39355,102333,87362,65741,59906,19538,201575,48772,102938,24438,292580,39964,66366,9004,61379,50548,37622,38732,28379,68180,76622,17488,69849,5963,7219,48143,43413,55358,540,58691,29506,19245,52193,48621,5518,13048,118625,44755,191081,42061,89197,2259,60665,66994,71210,51232,3585,142096,55024,7892,8345,58653,463307,65658,64319,137941,136323,53499,12746,43492,6978,95163,29925,60175,5128,7352,41463,184756,121146,20473,18426,4598,5309,54580,14277,121151,10691,56711,43880,63409,76682,11830,172218,264898,32632,66536,81062,31649,25788,92774,60222,11100,63159,9432,224657,25240,53613,152,138620,163829,2397,85345,12501,37507,64932,38575,43522,65789,80198,78796,35226,3851,108891,73311,3060,28391,93671,39663,46142,30982,66041,37281,68157,26553,71872,81142,211527,39747,118119,22695,2859,11066,20232,168911,7933,197005,17066,111071,44434,133994,120798,12766,227798,45756,132852,29917,36076,55352,65281,129800,41958,18944,84678,18580,168093,132621,39997,54092,27740,32354,3770,114118,103242,43918,15899,18574,145944,3190,123469,219903,24169,100571,62403,16776,92779,14535,17168,16475,14304,37231,1712,28218,242754,61688,28980,1318,51359,222657,99200,67989,31772,23932,35351,201251,49041,27306,19128,40135,3986,77333,19649,120683,151927,21081,7076,78375,77501,101599,8011,89585,96715,58179,5378,102138,106793,26051,217276,4197,16297,27014,46721,13322,22806,5278,29629,70632,9647,71519,58818,40603,128530,8903,36770,56900,31483,26935,43845,34265,34920,87658,6114,84767,64250,47318,50720,19264,162514,33357,13117,6705,46696,75032,71054,87004,42035,69138,11903,99854,102328,19611,34525,69312,6431,49842,101600,133178,108751,41829,89939,225664,48916,99556,9195,130387,5960,36857,116724,53518,94002,39077,53996,6945,22261,64291,8314,152785,57588,16522,9091,5048,87671,35441,39509,1945,12423,158923,178413,37549,14095,1475,73188,62878,4819,24012,68534,42606,4010,120809,57497,59564,101758,103718,32701,80116,12345,95834,46918,21468,53213,15665,31200,3867,5140,96013,250744,21016,10069,13968,35449,180829,27683,39704,59956,22893,3115,26293,32785,75934,62445,141162,62720,2018,83638,19949,114012,95006,3330,99829,130935,309272,9565,55874,121727,37017,23586,319858,40970,27602,8625,112329,61060,100088,118525,25922,16232,1907,60671,51583,44553,80993,5262,94679,8676,940,20736,11823,3020,16476,12340,152600,97416,3703,25744,66826,16245,16876,46446,84798,74227,176020,45192,61955,75496,23946,23626,40372,26036,6149,11822,30582,16541,41914,82385,232823,40921,80773,14930,3631,7517,39619,4348,36180,126106,138939,62611,1477,113512,47321,25052,14546,118881,29060,23589,128322,36795,18401,137921,104699,267929,36194,172791,18113,4766,188215,30083,332586,94089,5805,77909,22194,68234,154976,43220,40660,70001,184893,138095,11128,103010,22663,5108,212615,8485,5565,49222,54614,26530,42639,16319,55062,152662,105595,21114,22216,10294,68158,10436,86950,7206,62115,3977,3657,59874,456,118617,18156,106663,112229,80992,17442,8217,55551,5133,34344,251927,51153,39364,201321,7816,66803,23057,156724,145664,14276,95705,979,2796,6875,13429,212525,50602,26276,28284,3424,19465,52397,46963,31420,51399,206476,92317,48851,637,100820,83349,10317,60227,21972,6908,282439,32857,224767,95629,83882,42106,87338,69757,29840,68709,37665,45244,114577,49188,175943,54009,186746,106158,70168,3358,234002,50555,9221,129338,9562,20118,32923,78479,118280,65752,4977,10474,102174,60947,129006,10570,83451,8598,8078,159367,123785,80438,16742,5905,5281,181513,42402,6977,163136,93179,42191,14968,50421,112401,105440,33456,57347,121611,4221,94954,36517,24046,27796,6255,33394,72990,135408,116627,1233,57874,25654,95419,68156,401399,313338,55208,45573,93124,119251,47200,38196,11909,130667,45391,73904,64964,167846,4137,115606,52036,62214,7969,160925,7187,1132,134835,40309,73195,64494,80472,444841,61111,26500,45323,40743,53625,52797,22659,15631,29739,36706,28841,39147,102836,26794,10536,14845,87305,45874,12241,127587,83833,57183,79722,30844,41304,84655,20825,92500,3722,25655,27811,10157,81634,31362,34088,92487,70123,22190,185100,72658,139035,192523,88241,2078,230490,44528,85638,100198,22088,29982,291233,241062,13865,4445,137791,37835,107218,31726,19718,38234,72528,23046,19177,66695,5109,17251,28077,5617,21554,47839,72425,133825,1486,73065,181275,141508,21768,62971,63082,2512,34200,9904,120309,6392,91243,68416,268253,41199,116757,138551,185526,41246,28986,4093,19057,17295,4148,245766,122360,35356,112075,20301,75441,10998,7977,19769,62922,937,63547,100196,26427,157820,20983,236696,22935,8140,90315,156004,47204,140973,7726,45097,52725,22636,23436,257282,105247,522,88389,216031,202204,46812,211666,19693,68828,81691,45925,11256,30292,372,5236,167826,88328,232776,151611,5360,82104,18841,80393,25465,18285,20320,72377,31730,33160,45803,38715,27705,37379,24163,18360,103586,4015,32305,269494,91252,20080,36567,54650,7797,57073,12650,31164,42209,6375,261663,105528,81661,106002,2800,5375,17247,43151,4442,15727,194619,100855,144898,62320,78465,39929,16454,1967,28311,61363,17219,9395,8745,121445,76939,80385,162380,22009,54191,44248,16299,122830,48151,74429,78291,64755,14238,44966,2511,17712,67954,93583,829,105899,49935,84750,11591,33185,85447,42717,27409,208542,28965,62052,52525,5597,25694,65594,16343,63224,276188,12475,9331,127507,38522,57287,24128,133161,79723,105548,133695,48917,27558,43278,46520,13778,141954,110785,83366,17715,46317,105763,66298,147013,41086,94180,16478,220447,44611,730,19722,78975,117889,125643,26254,16574,18480,65006,15806,38549,246418,46052,36056,8440,34984,30170,3163,59800,4458,115442,4283,41970,33507,104078,1653,22,121158,276486,3655,6338,24048,133421,23641,2161,24422,36006,8086,10675,181474,12307,29514,59143,14729,52509,87128,122470,19446,80852,33314,24573,119864,14237,9652,57779,6612,51851,15284,98871,90581,124466,156831,21190,22015,71380,161906,87247,69201,18392,17908,108470,72962,40719,14338,17911,95260,43339,20610,78916,20710,72451,11315,31448,17263,58853,178878,48111,116002,45497,80506,82605,85880,36300,121755,25215,36118,301929,88728,405223,276136,553,34704,212438,49970,78329,922,20711,25036,257130,38295,145369,18128,15385,30829,55656,48345,8012,3561,28004,122041,192900,58338,112508,41085,29976,87040,47117,23905,4336,92061,138880,97407,42083,172121,6256,25192,172671,5,93568,1420,12677,31605,56743,40620,6015,78415,231077,31298,80026,13902,19048,24924,170586,32955,176119,87859,36731,6773,27711,24658,26475,115216,133207,93250,95820,88522,8317,5714,124047,55219,86860,19677,23961,22928,162209,8904,225992,359835,56084,96201,29392,96558,86071,93643,55114,13347,8183,95129,82012,2017,123336,34219,115554,157159,47747,101684,41008,18735,193781,104151,226906,7552,179874,124113,31159,21162,44010,14771,51268,166128,31382,73124,77438,92830,205709,12113,1292,38937,13114,1334,2118,15597,69581,14449,21934,76618,48728,67038,14967,51495,24243,87736,147249,26720,11119,46063,43749,5843,44147,152629,133428,65703,14269,45604,57982,28672,55616,45957,8438,95433,37698,220862,132034,39456,61870,4161,26501,73560,56418,9845,4654,20916,10456,88920,119358,9015,65931,96507,48029,38534,21676,109081,43078,34943,25089,6131,28766,23665,5477,10255,16695,67,45778,42443,42770,29534,23733,100513,62617,42630,48746,14191,43753,50295,26007,8792,57243,43119,54725,164253,58250,112304,131796,25165,4651,3188,24831,47748,3705,19540,13211,102095,5593,18699,23666,32005,117571,33541,60584,74573,86311,99443,25172,27222,168938,7143,11853,53560,18834,19960,86522,28217,53266,117700,72989,34323,18721,66450,34346,74056,47217,202002,46269,9429,68582,75458,37823,82843,96652,32549,145144,27958,19820,158086,31955,201406,135379,31207,192545,12950,51704,9094,248263,76147,64028,110009,79407,89345,99284,223492,47966,26848,15359,201137,2861,110507,71231,72297,31851,118777,71039,151051,240855,16333,50766,14727,7939,4149,80908,418780,88378,59276,1327,7284,38576,79814,65820,42199,84860,49574,62596,12396,70598,40117,8648,7994,16836,7630,14047,359699,106878,525,29037,28064,13380,11675,50669,74216,103539,180314,27449,56299,172344,19274,7301,246099,32043,19422,36506,129317,6806,30140,4614,46639,66926,932,86600,6322,27847,233103,10541,39025,34887,3517,12972,26220,2031,66561,115015,48658,47596,12714,33845,3893,16165,35237,89983,14769,11962,147224,47018,29977,27979,5552,82338,86023,131368,1218,24853,237840,132193,15455,40873,3668,65351,53388,15229,59889,272245,47934,11858,34347,18038,90853,86981,300602,19343,114181,29362,84921,6095,106059,79472,38015,1206,48741,6208,8e4,21916,17423,6002,108083,24479,34931,56661,9511,26995,100694,163853,35997,81254,58321,18919,171890,86877,91341,74503,70477,53412,7027,59281,39892,131302,5864,15947,61301,67466,162369,47956,27874,35624,282324,21270,111847,102548,41482,30955,116737,28264,8592,55458,22301,75090,29821,30697,51709,3041,19208,8038,24634,30467,87509,126428,19389,18814,152686,20701,83474,45832,80891,105808,11378,153223,120770,98186,150633,49838,9141,12755,30962,5260,74490,21256,31678,65062,33326,289838,187831,20595,89768,2805,58535,10844,70085,12090,2451,138068,98544,24461,4511,6754,41684,28203,3383,65355,82833,30161,83924,234361,128424,28921,222594,33975,125491,34069,11508,67464,144226,41850,98703,34371,7901,21254,38398,65651,23549,53883,213340,123269,12028,71764,177701,28758,2623,68395,11549,15232,68603,9660,63116,36079,57093,31198,20475,48467,89984,35619,186847,107469,31389,43631,73867,41949,68841,114250,1605,30564,63403,17588,27680,99533,12641,70325,50428,73426,78379,11855,91651,72081,91720,60198,15743,12065,83398,140046,6761,46598,45900,5068,886,62448,148968,37347,19405,9680,15819,43496,63370,75667,163700,37639,3633,22774,34341,183131,134335,37200,23915,7054,14194,12970,26438,13350,285521,25594,8219,104410,91039,168804,138480,149734,15907,33818,61132,60082,4622,110187,56736,13551,73571,3945,73463,65498,17758,263266,17593,2710,27585,54469,38200,45367,63754,28881,3473,12791,98287,31895,65787,4463,94536,24951,36332,59901,28803,52130,86403,7668,181822,74831,18977,9850,177206,145485,109798,7292,31421,26280,77211,58511,12507,127004,11113,147,8729,56208,43066,79926,129937,31345,83947,39915,46146,98763,42566,1337,13192,18323,105163,80570,117753,16555,72883,11077,159438,40764,70933,83329,26066,12276,72059,21655,173836,126713,69454,153482,91585,70644,102558,110483,6764,127864,190133,3961,101798,20945,71138,82402,90884,69669,44753,923,16939,59700,164258,25969,27082,31399,43846,6306,246093,51342,6153,151581,202801,182731,56475,162188,89426,141356,14355,121815,27536,28023,65257,77523,106668,127314,24947,12790,38796,169698,23555,10725,44573,183083,42088,62716,43265,105958,32050,44067,50118,1668,3874,6243,318411,16599,1691,94999,52378,28671,216728,123258,2059,34969,69225,5913,136280,171443,141515,91662,22175,135282,80020,92270,1663,4808,4482,3495,34691,5226,109830,108512,17342,107488,11606,123190,100247,29666,146527,113014,15794,30894,13224,39585,243192,22351,9903,7836,47699,11078,25468,122291,48821,26780,122679,75521,81450,630,4895,92900,55074,74293,17441,3563,111657,103102,51613,12318,52370,36191,68245,34269,40445,41354,122901,168604,182500,62012,42557,11259,24428,115113,86345,12362,3909,78430,86852,134602,20459,47853,93879,22577,7659,3688,38555,13349,17381,56715,91639,12493,10895,92438,3142,37057,28928,2004,36427,32268,34222,209974,10432,67436,41989,173518,107930,27079,62729,30908,55558,5828,45031,14902,53546,8204,144263,60255,14520,88212,86582,109589,69356,8064,47449,8505,66558,16886,4844,52817,111260,215129,12941,91118,650,20770,6273,73089,40618,62790,2873,35002,14023,97208,19386,102646,36993,143736,135457,35385,113601,17893,32627,84439,100619,56016,6581,57264,172160,45452,111710,203627,70131,24100,322787,1996,35665,70078,22358,90922,83658,4097,63200,58499,14542,99153,52159,6615,12414,63415,31986,16823,1579,65405,137809,8841,16898,48082,259,33014,42375,12260,179850,73667,91389,98882,29532,17311,326251,41092,5928,20742,44964,48019,43505,9317,49265,6643,192712,48424,163487,19861,20113,70848,31928,105333,23685,78563,14638,54755,7158,24142,44018,20774,125255,20331,24280,10163,1285,2336,39851,4299,117269,46714,63816,87779,159624,11731,9971,990,137317,108831,50994,74554,162680,23640,131597,146962,170620,34829,91205,21184,1913,63616,18427,93136,156592,17519,67565,115882,138220,78622,88535,18115,2711,33554,109492,54298,971,24914,25863,36363,45715,27099,194995,14299,178181,111488,72395,322385,157719,130787,11897,81843,83999,11369,49280,118604,40922,61332,110343,53407,75639,40582,300440,54722,25637,13694,48248,48278,194521,56203,52779,48783,72627,10953,376,16733,280238,26351,230789,15132,25168,137270,3588,63704,73376,94031,74284,19443,159557,9697,39901,13351,119050,15406,146455,3460,29556,75195,37673,102524,92329,47289,98413,15311,100684,56345,7116,95480,11590,7200,167,23610,58426,17730,136656,27944,53151,2701,8824,103124,3017,90744,113588,53216,79736,65940,26931,498,29568,80540,143543,21292,1740,59268,16561,180816,42323,50174,40890,52866,10703,57169,4700,17191,4424,93511,49698,166650,26972,48631,165169,82879,69326,202970,4007,2376,231325,139592,22119,62851,37504,68816,58345,67398,186643,43331,277416,53749,15746,23102,17432,4793,151138,48822,54265,48203,198688,14305,54287,2291,18018,113378,123260,7180,97549,87027,120085,2920,76080,8190,102005,5641,64580,14955,59802,54028,58884,19367,81779,412567,85957,97053,103637,78871,29364,27637,141728,4767,30686,112738,130146,42745,12730,105040,14844,232,210944,36581,152317,135543,29744,3129,55647,58149,46319,27265,17499,28005,59948,7170,34138,5702,293047,110892,408,91760,218674,18469,46095,81403,14389,4610,35672,73060,11006,74848,104820,118143,190357,20043,105358,141735,5115,27093,45924,123073,52599,29433,9616,238350,78610,24851,58858,26769,31969,24613,18294,4982,32735,39639,143563,112073,202205,12567,4873,88601,44897,81503,101648,81362,34662,85277,17574,48173,21435,221188,40215,39576,80786,26544,64668,81841,10731,37733,247986,149188,127703,495,18382,54388,72446,43071,30974,198723,89608,41360,190,33045,8386,31658,19992,237838,119015,137622,50890,100913,6460,116233,267230,26621,104129,65114,14190,41542,14888,85962,23342,23041,26453,43725,71809,45186,4770,46452,53894,56616,221286,18973,9038,109299,55365,19366,26863,18808,60909,69353,41738,83463,12100,68561,72860,3980,13796,49340,12332,31311,27418,4255,53430,18976,45523,510,14224,30477,26581,4530,3651,101663,139840,22709,150861,31996,63923,120623,262522,3076,10528,2929,14672,130238,18087,9816,121894,100308,25085,55111,14565,18952,53293,2042,369988,23674,61789,133529,28783,108293,35477,47119,36448,71049,40015,33055,78598,198442,1833,159937,40654,77444,189245,113153,8621,18599,38553,35223,166072,2375,11659,21786,89523,6032,12116,63046,159398,18454,3678,32521,47626,11411,103527,38896,42946,15696,26370,10185,8413,37080,165583,4331,63555,14907,72220,50056,6623,62236,36565,49783,10049,17503,100581,55951,146244,24724,9626,17969,25524,109300,173965,99994,101056,46459,43647,53737,277968,8347,123521,74858,33829,44762,77574,877,81377,222525,123532,30602,43881,53145,2973,16284,81940,61281,127044,63620,9875,14756,114829,19032,9202,52759,119141,23928,120551,19607,3599,33401,76821,73233,117430,39968,36539,7071,5446,121735,194059,15206,45283,6706,15603,65615,1207,165723,92275,34773,104447,8396,32353,205240,164323,13600,60555,79205,25532,22907,33410,57480,107111,69630,32137,47832,70913,33161,20321,2371,117348,10714,86246,1625,11763,17900,268,78457,99175,97940,101092,86660,32221,14041,128504,125080,53744,124263,31017,13897,403,31859,21964,5633,111630,5547,77329,17961,18241,84995,25984,12983,67491,62168,47262,5241,297,51191,7351,8967,147212,82060,16821,782,11033,82431,62957,5026,43459,77963,203477,53528,6247,191852,87774,74164,215654,13467,1522,219964,28589,244104,16242,117821,67725,72570,156792,17186,15979,26990,44128,193014,35276,57125,16212,166451,68017,6905,77608,16364,53777,75921,76426,37975,26203,269296,64099,84122,12077,38533,830,4407,20139,963,43028,38902,42911,37503,83343,85045,16979,1165,60835,137387,58380,86990,110066,134540,56331,193845,81238,17922,163093,38744,110641,12502,56404,34862,26865,125964,12965,111648,25547,7771,27196,136980,9555,29551,107158,57885,18831,37705,35505,101742,13970,102109,62548,124657,23328,11124,89592,146376,248050,6241,22033,18337,80685,29898,11908,216623,67721,106162,146610,21377,15085,91552,42041,62560,122532,125336,102365,121537,142559,29693,223919,11515,110495,18776,22494,5895,185059,103592,229351,51220,100102,37027,257855,29359,54123,36066,106493,12244,79258,32002,432,56205,94836,90182,6726,14762,29391,48938,26864,38083,60364,3310,60192,14766,205567,57504,110760,22649,24666,46333,21517,3430,13135,28873,27052,158809,11597,20529,6695,23138,22960,37137,45574,6545,305877,43423,26153,24769,59844,14501,10430,134352,56169,13213,103432,49523,35181,13435,12408,129475,64620,230854,77390,51990,15653,83248,33466,44571,117828,51481,2187,10559,68019,18021,54895,48247,18354,33737,4554,108595,37288,39767,116707,9175,3726,108877,21616,83684,49862,1938,8543,276466,20134,108498,48770,102254,31914,131520,185291,100559,51890,209,19526,76471,50544,71814,99351,8172,198526,28816,20419,9109,98389,136777,76479,75596,30635,165417,48216,120220,25955,211071,39314,24308,32164,2559,146280,43403,9233,17947,90585,1786,86920,125662,2457,64741,32152,32918,122882,78538,44001,31723,56426,23375,103172,88177,145697,52506,49319,68016,31664,41488,18486,110400,7030,28241,986,109199,19900,42147,56864,65287,49183,7858,24e3,30453,840,16673,25907,68916,89927,6309,158335,36407,199737,130464,13137,59603,201778,195292,21015,42466,179062,172561,89492,11075,180407,31868,72493,20998,60217,9865,19530,39274,130266,54539,21623,12535,13505,40641,73375,4087,85633,2153,3117,70680,55788,92096,47509,98493,37490,271936,151475,3032,16171,96642,34106,78425,125761,19591,3366,19316,54508,24183,50786,194248,91528,33253,34622,108355,41741,705,3814,3883,108929,13203,67831,10142,59754,68208,29128,84820,56880,38794,24972,48571,40821,40476,18137,164254,24064,236309,79181,11282,395,39169,2013,51587,28551,9645,701,109513,115899,113566,12762,62045,58322,103726,41343,40866,244102,143816,2490,70346,40973,52618,15412,30720,104315,38917,42027,93676,17513,107418,20706,123890,13399,97727,24044,87962,65606,44250,98044,65276,74790,101473,19350,91570,1326,87790,172042,7577,100813,86896,85891,41512,108130,27794,14875,71431,12835,156250,58135,3759,22476,42176,115873,34686,56523,73643,108505,51491,20838,12721,32863,45700,29496,13700,34294,55360,29206,155942,123812,7706,163234,203,132720,49358,144431,8130,175788,35818,3270,76832,25710,54095,97274,28779,94621,74396,19092,128242,58067,20885,14670,93255,15107,63291,23654,126900,129421,59294,262659,9798,3251,67344,28600,44629,50672,29072,26999,31526,23183,49175,165843,175455,17282,175411,32022,45989,30298,90690,78118,83156,23749,35636,31317,7069,80381,94561,133756,14960,97404,6138,41065,78041,32843,16601,34123,9559,146529,123377,96395,54441,42012,84257,123541,10745,22139,106459,11720,150883,172651,154996,110538,4728,53447,25704,2009,71152,119354,21166,66604,1429,216162,8637,122250,63520,27180,29172,36124,276428,107787,77184,4680,14952,104903,24418,14793,51561,52931,8371,26342,48526,7118,92066,67280,40653,8847,34597,105438,14198,50163,61188,146286,50315,41205,170829,161496,585,197359,95056,1687,365794,91349,48507,5804,49263,5146,104902,96365,117343,132222,46084,96919,16875,8073,262381,79982,52663,13928,16056,153908,15145,109256,132308,18763,24904,167644,13618,40750,18686,147124,114709,150038,52849,2938,12568,48617,8778,5459,44202,44591,74914,17183,248689,13878,7822,80060,23116,194037,18487,2067,7798,43077,33678,244028,31320,74273,2794,19466,8218,36280,183997,48124,19416,29656,19280,98734,7715,18311,30701,133602,150307,126956,7378,2933,79903,13178,12593,86571,26604,92446,13574,44205,65699,427599,21118,8245,14407,27877,47936,33542,7916,26460,117762,21596,37818,2249,127359,209394,60044,47677,308089,36791,154971,31417,6998,150042,174360,12255,43009,29335,48739,3912,101398,53340,2580,146939,151295,45360,125275,15273,45383,27456,48761,23314,8750,60801,85823,104759,27894,123685,66968,39480,26917,55290,83305,2696,98390,57569,145853,340733,4919,20024,52268,30884,7413,203685,70989,112855,4129,50536,349518,68205,332641,159581,135361,236026,37563,176404,64899,6578,122033,63871,1850,85234,82089,66124,74145,121098,107351,12687,36881,117334,13136,14698,85933,93866,18047,32620,310,15094,46e3,88451,23632,36645,27940,87618,80520,58892,20976,27702,140090,96075,67841,103292,238964,87778,107338,17019,83427,67522,7302,8261,47570,116787,8730,80484,61772,174422,56005,131193,52875,14588,28471,59817,9586,15720,158155,51307,109734,15196,11025,59331,3884,52626,102602,84797,25158,27314,4437,20488,76214,189248,35023,114952,157376,2827,62439,102878,129749,36405,10329,109339,108633,36662,1254,13267,5470,87105,58004,15397,10434,159667,21864,52022,179464,3013,32147,31496,116832,18494,105502,129227,107267,50033,13481,9954,24267,22141,16257,116154,36185,950,115685,11305,176708,2048,178671,112573,287867,162328,497663,95170,50979,193861,50987,30368,136257,31830,46549,15119,169876,23788,17462,249887,57377,1949,35448,14791,43769,210091,3783,34612,282103,88380,245190,5457,20491,98908,11402,86899,117916,16028,162584,60644,320177,156096,31065,55876,22e3,77655,9992,23397,13757,317623,63978,215255,2443,17648,93231,27388,104529,93807,55505,140477,12046,112040,70887,40152,94365,112353,25063,114679,266061,71248,119555,15589,2244,617,14129,211431,70110,100652,7777,4383,85911,89221,21010,120615,58357,86405,37554,41647,18,15143,69662,60491,14714,186134,148344,42347,5410,168175,44535,42449,343894,129417,99682,20659,27272,140483,63455,222159,17536,13722,42637,62324,11976,114691,148109,2283,32057,182393,4295,147364,33705,2075,44303,30274,28331,63740,69740,29148,10346,44862,33716,73937,153333,12930,38784,247159,2515,41053,20256,83368,256189,54639,115240,5096,24661,175419,153552,26516,141,138176,63885,34115,47222,55709,2765,28479,38875,236608,12229,22921,77291,54426,45388,2860,57787,114579,295139,105782,17826,71066,19119,54364,69385,16568,12323,28057,33346,34919,124763,155533,101386,31644,8627,49001,303600,29868,63213,9103,77280,71333,9696,138789,37059,24823,5057,21352,32368,114208,56803,19424,10445,58514,8661,209508,26187,171838,10460,63454,14016,122504,41328,21329,46618,32493,38225,7855,31763,7945,29876,8734,6438,24205,97490,139977,130740,47323,33195,85390,57194,13813,60600,21313,96251,7699,27584,170521,139271,1363,4402,336738,129223,84983,69150,13147,3590,163929,207225,155260,55916,20288,4503,8398,98490,11773,27512,37113,84976,86558,28365,11756,116005,182148,13733,115313,47644,67208,85069,9347,14995,226141,14704,101835,41159,35314,13113,63526,214039,29978,50446,83339,17440,129441,72522,118641,97816,24907,73844,15717,118884,167255,96509,162793,30847,36849,51297,78974,77793,10427,1873,2972,9999,35074,28190,64297,146836,46298,60038,163007,108919,61219,2403,75022,127339,4233,110389,69022,9833,128097,88016,79390,222936,22570,94657,28462,56956,38803,81536,30474,152794,19566,16481,147408,74574,81895,20731,1918,1366,76367,187321,54494,24366,21690,61696,33283,107477,77499,31112,414383,74362,18463,218441,120929,59848,258629,201924,69269,454,19989,13054,59894,3623,58908,20681,35723,78523,102680,38988,184112,108087,50944,132704,52966,21699,18860,96349,201411,82697,85395,95658,5093,6427,177894,44191,32755,26961,155739,6249,31310,81030,26574,84311,120155,86730,113535,7424,48888,13516,45747,98098,20077,183995,81945,43210,26704,40420,75831,45648,11180,6855,57927,65528,124096,34851,2598,156633,107572,127352,38169,123845,60142,62722,105584,232364,23211,68120,1601,22169,89299,747,258039,80572,7258,152249,11862,101204,8834,121434,33761,19175,133142,46343,40178,48723,3589,41977,30210,38868,62257,10087,82658,87827,90646,16415,47552,351723,28298,72225,91146,272760,1701,11295,1652,109651,300747,51863,198800,29446,11794,32345,37538,22356,33102,37590,113544,37970,11478,179743,25454,103417,59905,221970,105196,145604,7817,164809,102360,16974,75840,255333,56902,6659,1954,645,59400,67769,7689,18675,5215,13793,20536,27852,3387,29523,259718,16860,94625,43143,29245,15848,233581,22685,63631,78557,22836,133302,84513,1348,51826,47129,98836,58284,1830,1749,94642,10933,6145,12506,10975,13879,103781,144434,10268,28409,32346,52968,121567,107374,77268,23686,35097,10501,155275,15303,47136,21102,168741,55332,90385,15996,84817,681,137803,25054,142275,6163,38175,8056,124296,240642,65621,4934,178205,16101,62803,60964,18230,100622,76465,44689,14545,9543,47514,16852,93380,28048,12047,107106,37575,101485,77047,57326,34819,96137,76916,6469,46264,115983,75768,87668,69942,13027,165,8373,114231,26434,52844,42799,182044,23580,146254,38081,43236,33883,146220,382894,14606,46035,36481,166621,35417,95382,2957,59384,60428,36358,66343,75378,22267,22950,83528,17577,56474,25285,4619,179691,75355,95836,53295,34588,171410,4487,14679,84208,44015,18562,109133,54101,11531,86052,174479,303157,28095,9953,35642,14564,39802,16145,77606,117406,53038,121117,53624,22062,1212,7632,127157,237292,189087,10478,127345,102515,181997,86752,87623,10966,121602,68783,68681,83042,114380,138349,191305,67176,50085,39016,1427,42384,1412,67118,122616,72389,25260,2237,13576,137346,19938,20304,2191,68759,5373,61364,238507,75814,23931,69565,38993,131741,38364,12528,87762,5679,129853,5310,186831,32653,90338,260176,389531,108118,26843,43985,50175,30563,25106,56965,18130,140428,4542,165503,117991,24219,229605,1819,129663,1240,3797,76093,18398,71339,51919,93043,27175,47060,216257,6483,35051,1217,16512,80798,129064,13225,69339,8548,237079,72298,2575,34280,51379,117910,55671,53345,247552,29486,39328,140821,34681,57045,60177,5004,90269,78522,2479,322607,48474,61296,13057,31558,4678,59271,6699,27044,31988,35944,12503,83480,4389,136508,3781,114121,70279,4488,155829,42214,2898,68191,75695,305850,45041,74344,106509,30087,17429,93292,12477,290,23080,114802,35714,18751,26554,105424,17775,2144,2412,100610,65192,113975,52975,180272,135050,129815,76238,106483,21440,63186,4260,46189,9711,28249,4169,23429,23390,8324,141585,63809,67668,38457,38063,39226,59972,1189,203916,62368,14403,16949,61767,85801,1739,40147,35049,76757,33124,62102,15780,103593,103009,53484,22952,67973,114645,6566,5245,50462,7601,8288,3513,194571,80276,1908,54592,5124,58571,2513,6800,273997,193904,1119,17991,117245,2508,129156,82366,26278,71465,63341,56943,39662,106116,94966,156875,9736,2204,122308,94418,27134,1280,24539,49022,45314,3764,50904,46424,30699,28087,293839,9400,33646,40165,822,147499,50263,116179,29085,11863,31314,5578,17797,5104,12454,1604,15342,219206,10232,67800,94261,25872,13565,90339,78971,75377,26649,41184,47695,11514,35369,20767,14227,41953,309396,148270,147938,33074,14453,27499,109019,39018,25738,240196,158931,52820,8612,95853,21524,137010,84901,70869,70021,116794,48404,38771,6732,1070,70990,187297,49140,5238,576,3564,253975,16027,16483,2811,37775,19034,25259,4053,2e3,70083,95774,19713,33431,92703,91314,42381,288770,48194,95985,3991,77418,13406,241328,245086,56533,35275,62725,9246,51924,70181,95331,16163,31410,79016,39312,120878,119371,275987,80124,27712,9186,220,23598,146167,85209,68238,282190,57048,31273,30555,80913,17594,75779,59160,135002,101219,189377,29225,96735,60126,62522,104e3,27620,86814,17240,147533,11001,5425,43682,410,49460,87270,69480,46315,59448,1816,76201,9431,11788,87960,29063,65539,47347,11678,33846,7008,196704,9895,6753,8633,120892,59970,572824,115934,6646,202559,892,48351,37611,251282,57823,67263,57750,26527,34485,90747,7685,88370,6144,64182,1709,41969,21458,62327,181657,49247,225330,122600,114574,107124,85361,111833,63243,71420,15655,191178,72430,18063,51425,54002,12364,53225,86557,18193,97580,41232,138398,67821,128724,8944,233212,101353,52099,42127,14006,120107,32789,32132,3498,18123,33758,56058,5779,128760,59888,98869,18445,84702,51911,13234,218379,20093,39031,8074,70195,20708,23462,24355,131384,60189,26390,10403,41060,7140,10781,49410,42261,87202,82566,41663,43105,60276,2768,5733,74176,28329,2297,145430,131632,83615,122915,105441,655,224102,5284,136426,67763,16294,188511,32538,61049,27893,3394,13951,159099,28542,17930,145360,9492,190122,32285,78855,26440,13570,58648,73908,4239,124561,2444,74172,53131,11468,10794,73566,11623,35343,64710,30481,4163,10328,38309,29901,10538,154377,76132,92405,24839,11679,3465,13449,11637,7824,2337,57754,1260,14458,41118,19878,38661,13416,159180,37074,163164,54137,28627,52134,184900,8520,40385,29546,30502,22386,66527,107458,6850,24022,47983,30603,35083,8934,304066,39500,9,28261,33026,77251,9374,44833,116312,34990,29236,63563,125639,135405,165398,159055,55690,88141,69643,236964,31983,25572,20436,36746,60896,31850,16179,11828,5888,3043,66368,9750,31167,7915,53111,36430,1333,64344,93659,20061,60596,180191,51630,6792,30244,43509,101058,22409,420,44210,109783,43223,27030,72477,72831,32679,29235,7675,47556,12258,39907,149412,84926,118247,24692,71717,105038,86009,45941,41189,89453,29856,52543,30627,226798,67303,59230,67415,34408,1367,99685,16867,128419,52147,4111,125381,117881,16173,44093,102224,31575,23234,24870,83790,127407,239098,3200,994,1255,100903,242275,117266,55116,38205,16140,29662,11307,40414,208793,123355,56470,4862,75600,30119,58218,70828,24075,26974,7802,192353,4851,5475,78720,66596,3409,28573,64396,30381,30690,59859,88256,5406,99945,103064,34463,37727,24238,86643,60088,4057,23741,5967,162904,38240,28356,93858,25510,122879,6897,3278,7057,11971,4400,35461,211413,21395,59615,39471,87233,55795,128426,3051,22470,41950,14705,3974,180108,80476,78442,204996,91987,15634,67610,139015,142373,35611,51134,10387,4353,153456,57749,181039,14183,68447,151532,21107,36452,20551,3186,46247,46383,129666,88736,140662,146243,2066,8360,7978,64818,106963,17896,47801,10723,114821,223295,74192,3293,3393,16987,74064,11277,91622,4270,29828,27951,387869,103235,1374,61988,120083,477,145892,128378,11779,211263,61354,18221,17869,46530,83061,108538,157981,90608,67199,95080,49064,195814,12302,66307,10348,231346,160732,112859,63633,146558,21271,31037,198802,47622,12862,95710,3910,77850,73961,85585,34752,61e3,4082,24595,103679,71107,8208,79568,150019,16615,24961,139857,32664,197366,4559,54735,32696,4126,162019,75698,13916,70108,159638,19834,9349,24675,175560,49643,18206,52459,27992,10809,88865,401975,133172,29e3,34558,30915,3658,25834,42430,36562,125265,18182,10155,40149,97082,208980,19575,60853,90529,66545,9600,789,46420,2317,88593,55595,98980,115302,5742,169155,1073,177901,3472,11189,63711,78643,65472,50459,127979,93,42202,67053,21720,157650,11145,141378,42033,22824,85705,79114,35584,15974,1510,54172,28562,12451,104226,19190,97151,73024,20948,5151,81741,21499,29006,84183,198074,54003,45120,170125,26240,35177,28389,64863,79974,60778,176915,232183,45342,2038,80253,41564,40703,32689,5430,100689,5366,23007,134279,14266,26712,73993,24934,64242,52113,102887,61801,46415,201049,54251,62133,122757,164883,30815,139966,2319,30842,766,13362,10287,134518,86111,81665,82440,28333,43019,18963,8804,161944,23439,102144,101145,80029,39052,248708,30350,117340,11878,128467,974,138625,63961,5237,74778,61834,67040,43814,13690,65947,33809,232476,115258,181745,28824,94013,9510,10246,93722,81976,7217,114383,3493,16014,69045,72692,12145,80981,9507,6692,1620,60820,330444,35474,33962,4797,7053,295463,46445,27026,12491,77988,49524,35675,90947,29114,166705,101385,133782,32704,6186,84595,176031,185623,45966,151302,63069,1699,107491,947,15458,74452,196212,6046,10498,12163,10239,35191,243951,9277,9090,29539,54460,22820,26514,112549,60372,51753,48756,21812,70861,260326,41,44222,10441,16961,48148,138771,216194,5914,52153,53400,212036,56519,26245,10117,45888,15294,138019,90913,26368,43842,42111,23348,6082,194845,161089,156206,51546,11647,30759,302912,262094,8635,78876,26535,35283,54183,31183,85484,147873,12989,5197,6356,72894,65347,20150,27370,73787,1493,45918,12366,190217,20724,13858,10981,67449,81213,7553,14115,72242,271517,11842,48310,88743,143726,22177,3290,243231,58452,62937,12592,1654,40066,33477,13751,9921,128442,15868,7106,75236,83773,10775,36938,10482,170465,17368,17469,161508,32752,98340,800,19824,264456,3901,87319,2867,26782,9630,113102,185815,24197,44584,86366,40224,3636,140916,31731,267731,9567,53678,72984,29389,27963,17106,50282,284911,60170,8322,12608,23374,89652,5268,39044,229766,8869,151350,31436,177342,12269,183212,120418,116270,2843,78888,69192,7865,184099,1086,129897,18383,70508,20242,18508,229924,124569,35749,50589,55626,9884,83115,40971,30671,18135,14452,38861,17844,201826,5549,26413,17189,13561,38539,10679,143331,3314,36785,171194,49685,187713,67506,4618,104039,17060,195080,50648,33159,19238,67559,134840,28599,157523,17130,38064,117398,94355,31918,13575,34538,40326,13997,3494,348283,62481,26862,3603,104426,244363,153709,112487,304612,199674,41239,35545,54869,293005,28223,26277,26899,4533,18518,15492,38587,80488,70485,160395,263,60162,11382,222152,4696,250751,51921,182609,10707,48463,46243,1227,49111,111564,46502,33342,56846,68541,63559,858,139927,16654,229375,76759,26478,33205,95828,23399,92945,2637,35630,28470,143992,50214,14174,21456,166191,65665,1711,21594,78019,97599,111701,36,147151,110246,189022,43021,30397,40757,131935,42065,73335,48039,26596,28984,15102,2361,7421,202167,69744,43766,52826,3642,83304,33873,75140,63169,192389,36551,92748,13039,123959,233220,21738,84447,77230,20228,187852,19095,25799,92136,108774,29237,53947,2299,118106,2687,8830,42331,202924,33667,2023,73763,30704,19363,19779,16737,35629,48081,24068,101013,162338,291912,13749,24745,328289,167679,70086,48299,23306,16732,17801,43322,54589,3586,63653,43624,53474,925,109177,251316,43805,13082,19511,86565,142182,92461,17117,101033,103319,64589,4022,4351,235897,5352,82705,107142,46391,156084,5860,61365,10558,13045,7717,18357,33922,12590,33065,6928,46993,783,46937,67846,8952,26295,6107,119656,18799,17458,50747,4229,179559,112727,118080,20683,41464,125468,51560,49749,44231,7359,35339,62988,136487,67015,5208,29150,24956,105186,48858,6143,18097,6972,16404,73489,58742,97196,36357,164616,5834,32267,13746,147733,15113,132091,34127,106298,39729,106426,22294,9780,15602,36213,71502,42808,66802,599,60755,5851,39120,67363,108623,126368,72770,91263,32486,30596,151717,7951,52002,43103,11768,68942,40901,39344,24037,127500,116890,48403,16926,86750,17745,48648,159545,34460,58419,5634,114317,67865,31462,23352,24010,98185,125708,69686,68337,13610,26271,70691,2980,4768,27225,102402,75453,28106,8104,6931,1176,6274,6475,112635,22498,6176,238686,26832,28893,90319,14441,15682,15087,39517,45270,109134,104440,45965,47645,81772,7876,52683,87720,12898,4505,185665,2769,113401,15664,57592,105229,137381,97059,119268,6876,43309,33886,128363,35476,144249,67013,143587,83367,25703,91436,59347,53236,2289,16519,19844,46309,58558,99834,23313,218816,231303,36388,51333,183535,109792,139277,54306,90139,18235,8275,32710,37677,82464,86025,92204,88842,117723,37570,128723,234242,76350,73795,34896,148247,58424,11105,11744,45746,63372,17118,49772,199520,81902,38004,22911,33752,3125,1995,53792,4689,26909,108150,146062,69674,41811,161444,84855,8999,28561,16731,93937,3189,21967,24890,22943,1356,145300,51569,28802,517,118679,31703,40607,48098,108854,25003,10233,73969,177495,5248,24516,215347,146192,48712,60626,69188,40735,5866,586,101541,6509,47590,52129,5969,222045,110933,25733,24223,65339,62812,2414,155418,35819,16022,78423,43138,20995,128255,240673,46745,236093,72176,57085,97841,61248,107,36068,193177,105427,55726,215229,20446,47228,100420,87091,14429,121708,23605,21157,187721,21880,2997,203976,99166,95068,25877,7724,98925,83401,4829,13182,18229,13718,239662,38653,116505,153497,30589,89029,38962,181302,43853,78872,180301,4786,248240,7401,106136,112590,77745,19731,60880,77789,125748,135487,5975,48627,34084,12419,215770,47557,254582,10364,106495,21856,67539,88981,38805,21428,48732,42316,12149,16078,52808,25327,51322,33850,51147,12253,122354,46077,56483,254553,115417,81834,150991,94662,86668,7381,12841,100650,18218,15741,22372,68294,50705,15535,84660,61887,22553,72299,31361,24824,17743,46820,64288,31582,77006,111674,116384,30760,80920,86149,77192,51979,79691,60342,122805,103800,240873,160744,233114,78962,54920,8608,3484,316104,72548,24337,5088,230040,21926,10172,36838,26,86221,83458,102176,12062,17571,41929,41170,28428,68239,41750,103930,2634,18313,53019,34825,97837,63115,24606,73157,152474,14715,91439,37033,109806,140259,30668,174760,380,135597,95673,136073,65073,134249,13829,17279,122305,4420,46444,10237,64848,203623,70728,10349,182885,65075,24519,25783,40318,34139,22222,63394,55266,102764,41422,20126,65100,90408,53640,35128,48932,11192,38935,96839,34782,39492,19396,41332,6250,5511,19492,51304,25936,104466,54099,73771,86115,5080,7669,30891,111700,13931,25276,72289,135447,14820,258641,25265,31005,281179,75286,393,95359,14623,13584,6680,101227,80173,44933,76666,54542,13244,39348,458,25379,109451,134348,81143,6959,65554,12027,51311,8716,57589,140731,28467,23316,17272,30458,25980,55229,77197,83798,28302,114784,7428,34548,26241,14712,39336,103304,18928,54080,12870,334,87722,15208,16895,142098,114262,39820,83913,57817,28682,7721,14900,108672,11250,62246,42849,415188,1724,26555,24549,25505,26443,107450,145899,61035,43528,6901,60726,65906,267741,21338,147590,42079,18924,73017,135236,15393,5206,4026,84185,1531,5988,113890,82647,303391,7386,69844,71611,189865,76523,31877,13315,19314,198575,32821,1928,67641,25913,104475,103489,3297,70391,18406,15446,113347,19295,93790,27856,1792,167471,116449,8541,4408,41757,63233,25765,86680,64501,27034,24816,34975,6079,4486,49693,36229,16917,21581,62426,27862,11612,54284,35702,194034,355,24277,48262,87411,70504,310164,118018,12516,47559,43502,57433,107139,9290,66533,80863,14634,34312,91725,28606,21342,67241,72355,43244,375789,37402,174015,105070,8342,44167,67494,1890,16365,11723,271002,1865,47918,8350,45564,27742,25110,125803,8553,49504,81925,62211,4534,15491,19011,80373,206920,667,102405,128623,245524,5553,113309,192739,65766,19567,22832,261958,29679,21293,71134,20962,105123,24721,860,21752,33448,18372,157167,94822,35770,173224,232737,75729,28937,46828,28062,25453,5207,140366,36665,30652,6169,67920,150458,92040,23186,184604,92330,20891,176492,49427,27828,38305,42495,143982,49560,25503,90043,29747,65328,47830,12932,11068,77721,9003,25213,94205,140426,46090,89945,138173,192691,33329,112232,129905,35709,27514,1841,19957,31411,127476,53572,17497,173549,55063,175135,19841,69314,5192,237921,117660,150697,4060,273045,50414,98940,65348,153665,164423,58804,156695,48994,213928,86036,28608,8355,39574,34540,16927,135680,18374,151587,10830,53805,16878,16623,4282,48030,8537,14986,46102,13062,72897,72,33050,108227,39451,45935,651,113320,40535,95176,57450,48843,5003,19019,10407,211163,3848,1068,4988,32091,30095,41692,15099,43602,107434,50744,7627,171349,16313,150832,352665,207750,33937,38256,51091,156e3,87889,90663,84175,24908,114900,50365,31494,83829,5398,169342,47521,54818,18935,8356,43094,41212,174536,10082,92550,6678,60614,23355,69721,14796,34149,128830,58187,3179,208,40325,28399,225029,401412,51150,31580,207268,6657,10993,69818,64282,289845,23308,12961,38447,6681,52944,31855,2572,47646,120728,179148,37240,45196,218274,4816,3695,21961,50084,35209,18073,51452,27004,6100,33941,1377,84831,171214,85,141510,9078,99227,32610,6417,11718,49868,65579,87902,73018,49062,46280,61742,21512,40862,107733,15941,29168,157765,144919,14487,5767,158014,140070,7241,573,71584,16921,223566,40331,179473,35081,47926,140885,41508,52104,59180,42310,32811,29048,123517,102413,80208,10104,14746,12649,153641,126022,37965,113017,4171,83,142592,2809,6362,50416,71323,116894,260776,16204,1524,5760,30351,12658,20703,54403,36083,45408,74772,4946,14485,50759,111222,10890,2195,167147,92962,130534,16283,177256,35016,15472,210156,151187,73922,117691,43250,52051,37392,24811,24358,30830,5775,818,21969,1476,127322,151783,58392,31021,106913,65215,89407,90802,28531,11690,20234,95249,44602,37256,18707,11928,5161,4410,26571,51903,49768,22008,25252,65780,209499,68769,203726,13249,137363,48845,86823,6658,5674,31881,1083,1823,108676,34518,166752,13791,14287,91576,91429,8665,11529,26401,16191,91972,30964,5254,28486,54697,79613,66520,18447,22870,45203,194466,22822,51703,12278,76716,44595,73455,33546,12235,144843,36154,51247,11116,33040,3180,225753,60864,1972,28469,12891,28879,10338,144157,56294,353058,38302,41447,87532,110616,27065,168438,6557,1213,50804,144643,24817,2390,136531,38174,247513,16190,4059,122791,131994,137430,39506,57650,16305,5188,54309,106128,20628,88071,67394,395446,250285,66176,91254,1399,114196,43915,60230,44853,27206,106353,43013,18733,345105,226453,51202,16607,57106,117175,35492,10476,89598,127439,15187,39624,13688,61570,10615,31111,59370,6238,175252,32143,224492,41388,95408,34384,148238,78307,38959,9340,160091,61443,15737,11216,41244,170,38299,102443,113097,26382,14027,33707,3957,76300,66160,19431,18900,6952,1717,108656,82206,188021,257335,27295,43999,41210,31777,46956,57457,12657,11489,15697,48060,204748,53583,82422,284790,30503,137341,8120,19615,220311,15991,10217,63424,9808,67431,70976,98221,4491,15177,28535,144789,751,13230,2394,1504,33977,132104,30316,22230,931,97193,185240,24826,22687,174322,15307,22988,1390,188745,180325,29580,59068,74903,18994,29195,79,15436,7622,38462,11566,138710,44828,45774,37768,99236,68137,84083,19282,22698,17134,74807,126662,173497,46248,16938,119735,3212,28292,213652,49013,9975,32180,45660,86250,4801,68788,95490,77482,113751,11994,44624,94452,46839,128497,100316,5798,58588,73184,202987,65417,37790,88524,1606,43156,97964,105717,34947,11203,100060,37742,130074,93653,107799,94311,196106,41347,8035,10780,16390,27883,118236,167395,1979,25006,19375,31628,18916,144723,78502,114047,103107,86492,107686,5844,20934,206963,23556,22591,16562,146333,20167,10471,117434,33085,2863,9740,36669,41849,37271,22790,18209,28979,8231,12952,54408,21731,25130,45208,55748,138120,75826,414,29593,9925,292865,25999,683,123149,7036,92159,86055,61827,103680,23176,54918,58466,57578,13305,5709,86479,16697,31064,17660,200919,10770,49793,33423,32370,52047,16488,62555,6459,8426,83493,7763,59725,82812,18628,67760,79405,68557,9612,7673,28102,56517,69620,171797,32458,29541,15870,81109,32080,207644,71495,21202,11039,91036,61230,2810,130800,32260,4613,60590,37112,75214,33979,126402,155062,30642,63875,12810,194463,82799,47664,16725,36685,43367,61099,449,172150,102867,21691,301838,36745,7130,18671,57316,34852,38034,54182,35578,65900,99486,19771,3456,2658,16914,99866,28390,28109,8262,21147,34353,20006,4228,137085,1675,203023,283196,198286,214375,163329,290603,152574,40471,83506,30068,14730,23177,131539,34759,27668,32178,71896,104799,116305,85430,119262,42860,25160,8911,23428,49437,105322,6519,16203,6349,74711,1230,38045,8540,75165,44736,25909,51026,317034,4984,32281,91312,27060,44431,17817,45363,155937,239085,35697,59784,91993,29531,126740,213757,76560,167776,285273,24262,8237,65030,41160,74437,48804,118916,13159,37842,1031,75349,1478,11655,108777,23435,277425,101734,67469,70231,124711,43532,28514,65526,54956,1e3,21882,17728,25302,40952,52214,149632,1999,2111,3259,63362,89961,220561,39777,26335,9063,10572,12416,34551,34623,38604,24723,5947,15588,69927,66252,119177,69173,46629,28714,70715,212408,20521,406913,74380,11716,50659,50862,37009,88460,130101,7210,53853,538,65120,151950,55806,163748,52837,13153,21100,16674,64536,6091,138201,44837,58547,3723,163,2177,32288,85454,34033,8497,14282,25742,10535,10741,79559,117493,243787,49337,100718,79495,40139,42956,7551,55433,15421,31509,23034,45081,547,61176,53434,328001,8470,36263,30145,4519,74173,53935,11845,73774,60211,78025,3,4102,73782,109293,315332,48412,26683,13714,6865,20128,18490,104141,325,39470,171970,115860,15707,7268,73301,74336,31370,2368,111827,107757,136231,142844,97138,96638,84053,38691,23801,1588,10573,122098,77039,240,186135,146101,11996,18143,112963,46171,155836,348769,47795,121213,116266,132515,3344,144804,31286,99187,255838,129694,35894,48779,55235,148582,71967,65282,15174,13920,47080,6147,108242,157593,125025,7136,1286,28957,127956,28402,98813,20805,7532,109417,40610,5041,32958,15142,18408,108596,33543,50517,27748,80114,233434,91447,487,37094,100048,30541,43477,10639,89862,155868,37667,8726,60684,237903,73408,99589,12190,38739,97348,3914,13594,2680,149016,13907,30171,28343,23530,115225,61104,35821,147679,14337,4297,244282,24085,326976,56428,7851,21303,131620,71446,83253,68692,111870,5224,15813,38197,49026,45057,13660,3306,76345,40671,27905,91072,996,68527,62085,91351,122634,55109,168209,2024,27560,112707,17352,8306,167115,169921,166958,5031,46020,11844,67284,19130,76185,6920,32849,5450,14610,22451,21002,17392,31872,66682,84796,13709,40210,59898,12029,8719,53564,21462,91884,21647,88379,194428,12754,37797,132826,160016,22567,54383,53186,77611,31107,8339,4694,19185,90355,23597,17222,140675,28442,23668,55977,9128,61555,28774,155229,17658,9390,24379,69357,15752,127381,239631,62460,93181,55913,45133,140155,18676,25249,33164,29581,82837,67223,22362,29975,7317,52813,1943,29613,20012,207130,49617,49651,5636,15334,36313,29226,28084,95247,72072,19e3,224932,15811,114,32127,38097,37508,88507,37225,27359,91626,12193,69279,20608,11055,88156,92808,2152,57259,55275,72789,24475,104414,1708,9882,3818,48661,66897,1631,34806,227930,85815,87753,18321,250664,72733,25107,206797,50891,8082,196411,92596,96764,152823,65514,22819,387277,62176,51225,40329,15563,189,3659,73670,64357,51793,275136,33482,86653,74615,67058,11318,125720,15388,22388,8267,1730,102663,170910,40784,7144,85373,13040,7088,94309,583,44224,140424,77439,18496,164026,36578,4722,9151,5824,63365,26510,35199,40500,79277,32495,44614,35233,9566,203293,152144,7097,2330,183480,98629,13423,330887,44130,68600,30939,97829,31012,345465,56747,94879,4939,160027,149761,99423,46099,32251,15332,8761,96094,128555,5763,235318,222223,55729,30241,55420,201746,3987,81382,8259,49325,23287,7719,24633,251100,92311,18591,110533,64759,170260,393860,7175,21144,132887,3593,75346,101277,91109,16387,259187,11627,57459,173829,44694,55780,49797,89192,120443,62622,3904,14814,23887,1027,112258,64955,99800,11132,66353,36202,48624,18158,88481,96882,43059,11040,2455,7077,21651,181159,99126,100434,61388,68186,19161,110468,120052,8819,55324,41494,7014,37689,3618,87729,92615,207943,9823,128657,12587,15857,6379,67628,51216,71775,157617,63244,1503,3864,218754,110864,5769,21492,7243,1192,87921,85529,31512,18537,42698,35350,73510,84474,34301,8991,21013,35034,566,38832,19838,35586,37216,39413,55006,12178,59742,856,84563,6900,25632,17437,49786,30723,13847,70845,4044,7843,23944,235976,55530,48942,6518,20939,73769,192653,52936,95207,23895,132542,142982,22632,87452,48042,54018,178468,10728,26230,23559,363,81269,142012,5718,346258,31456,84333,246476,51018,66692,101804,120570,39962,30373,70593,2864,60541,19425,54209,104092,7201,31545,48018,25865,15442,46257,40443,8328,6451,111782,47527,97754,33046,470,245116,31095,39,91934,87208,73470,36708,36521,12801,70624,36272,8892,79768,12427,55454,103756,5908,52390,62962,22720,141138,94634,41689,128402,126390,6628,106394,35527,134394,82727,254651,194502,148064,89549,3202,28359,957,21954,27906,49840,142747,8307,24206,48978,1186,71728,133038,71474,91306,6333,110959,74600,70387,18983,62609,56057,22970,1147,135850,1321,28834,3578,59715,102227,32827,81415,99952,55636,257598,390,22702,35701,85872,402916,39216,189795,14929,19467,10112,144422,61514,5279,63421,134686,41436,8424,51925,10598,132295,124416,4604,194739,210929,57866,31829,51626,50007,9976,91878,61906,56168,81906,60918,61859,40017,23059,16887,40927,62064,12785,32893,32913,21782,93965,20169,44387,79084,38463,11457,93950,27127,157050,2697,337088,5116,54128,48255,33279,8821,27352,25515,124022,65710,28906,38557,33390,1722,104435,72215,38551,12094,30978,25113,6671,37355,175109,42862,98024,65406,221276,59624,118012,64637,78760,86697,21426,1639,40350,12584,67193,84144,31396,7863,143011,69629,63112,9454,28666,65798,46372,134721,6314,51402,30837,151922,2847,38676,38008,92823,136245,17540,5504,109295,205242,37606,5211,214892,1586,20670,208711,137743,19328,40652,16995,20023,14657,154919,34422,12996,13918,38221,47690,16398,2959,37680,89122,6721,198469,91876,172043,83898,101992,26084,94570,3635,76958,22853,76497,38266,176590,168403,44464,142840,79180,184594,1984,41806,83147,11985,6546,366068,59732,24533,271505,8736,39084,222992,93429,28962,58985,86665,8432,30028,14548,32439,54424,165029,55175,27458,69046,121277,46168,33732,20661,24581,135574,123110,37556,79260,72611,16957,12939,46162,58238,44907,72936,253758,41324,32518,96480,11949,124438,65280,43256,34107,53533,43531,37037,28366,45970,32741,173438,6121,194202,62969,26355,30314,58370,28455,1848,50519,82830,90393,21761,295490,10936,256940,133568,44050,20269,4089,27457,21610,219460,36743,14821,101388,52005,13124,30979,140816,167362,26054,18458,60789,34917,40447,26606,33422,9066,3452,83614,5761,20263,137238,25038,91310,101,52322,74548,42572,38084,214054,186568,31802,17665,30620,141936,37730,14420,4265,187218,49640,188208,51441,55388,96452,66659,40869,42039,60967,221027,19234,178581,29105,96050,9165,196118,157335,3738,40354,117436,2965,34136,59659,15570,50843,230035,31444,71260,43886,18316,5387,38500,168508,17406,32174,8828,103373,143806,90367,3560,18719,122310,16508,26719,2541,105429,6645,37998,73190,10591,235916,49737,87112,233941,53188,32193,79154,4544,52905,126477,7580,63501,57314,3216,31337,6541,103083,60846,49,9756,15481,1355,43840,14319,13743,27486,10222,73114,230718,418644,16706,6674,279748,23058,45273,295831,86306,2743,5535,88773,21829,35253,120938,31153,3169,16839,42847,8751,80974,33942,36867,35514,16485,26474,77775,56877,5391,48346,3882,108713,31403,27804,55248,26235,43821,136104,40118,175507,28034,203908,18732,1788,34030,106427,36958,54359,7251,44936,15356,69139,455,157915,22173,140291,50348,43275,82066,49621,54952,15216,36226,96695,66855,6936,1987,8227,196087,4631,68827,99004,47541,110265,17953,147605,110242,58520,31312,38724,329975,642,3155,34497,75937,6207,73843,6120,17249,51429,117746,3218,910,68961,319671,14938,29555,34700,1649,66673,72268,9655,76800,153087,6941,210168,27130,35398,1780,73242,3135,56689,19556,165307,8765,35967,121458,13333,70453,17350,117253,22265,13340,44265,39869,441,3742,135025,23581,33309,16543,17731,13291,157637,283005,21408,101360,63887,52312,83873,5338,233779,23759,186949,34531,177320,38069,156465,91004,19353,59852,68160,14891,1338,1072,29823,1950,28901,81407,313445,73038,84807,162348,240257,37162,138934,16111,58013,41253,102951,16457,96056,19541,56402,67217,41638,94381,89674,29481,37456,80815,151579,13937,13683,132537,19699,134545,67020,29816,222341,141235,427578,48868,129557,233342,23077,87871,16213,18728,16184,9469,37913,19680,2798,171356,178328,13216,50049,72690,71904,124644,55455,7504,29052,41036,266546,19899,30391,188755,8659,59469,16,104298,112943,53865,76203,138226,68857,139953,14125,107625,119795,173133,4398,50273,48808,54390,16466,122086,31835,67035,50971,48859,7508,46427,66477,73021,84615,39985,83076,46779,201569,53336,36443,60865,168164,143810,51393,25548,169307,32896,24485,38424,21837,29087,275813,51674,6714,64883,46169,187369,55186,76192,12852,12018,62134,31067,118303,16542,12125,10579,4928,26291,43854,7091,10946,253716,109062,39283,17261,113012,258512,47764,125126,32646,55892,80279,201623,149872,3192,385,1208,48750,5376,58738,22335,5427,82416,47811,32435,143086,38930,94128,59975,156037,37977,38224,62485,7698,50405,71027,16462,21559,136153,34131,107506,162069,63703,3101,215029,40407,4178,3774,9187,80019,17880,97926,67579,2600,18405,8351,47924,86638,70820,92206,86453,29610,42241,119200,3198,15466,67813,57863,35454,4779,99518,4649,104641,144269,33730,38073,65864,6838,109456,193298,154007,5623,45741,30846,182578,25573,157224,1543,58575,138703,146140,44971,49356,18275,59064,20300,13122,11848,24453,11973,9797,86843,2919,25530,49210,1130,161220,76788,75373,85604,34926,36014,17777,17255,51533,11676,92226,51845,119859,21525,5936,18507,28050,1140,31418,14857,34207,47859,10750,36382,32079,106909,59426,87757,38393,110042,15965,97104,33757,35344,97993,53979,33651,45407,41884,82515,173089,7177,58371,35365,47543,51927,35587,10670,23544,29306,84233,39976,76076,62097,9007,8668,28119,78281,120790,19835,143020,54968,18670,64959,20649,34469,42570,33001,136570,87796,120044,1106,58700,63951,127623,12805,83057,40212,31773,49850,7361,54336,347524,101314,23751,19569,48791,29174,49369,20467,7465,75842,38281,623,112457,60210,28849,51003,94720,6426,90047,85560,43761,3579,85105,34607,90410,118528,7224,42907,111163,18168,6960,161135,191298,5247,100584,127552,171568,20121,91173,12636,54615,20199,63730,98105,2396,40387,14438,125012,4765,33235,12865,45299,37728,82098,77872,114037,59253,19675,24838,398016,102561,11446,17069,57508,178277,65836,99941,26114,2585,271882,136866,50126,11027,155648,118367,14585,8910,123015,335383,40434,41016,53021,14439,87098,176860,201543,121888,2358,9286,5739,22666,54270,37884,169381,33984,93859,16124,89364,72207,51639,76366,99029,65812,2198,12147,174891,194289,6986,30252,88822,21284,11445,288337,160821,33034,100869,43852,25761,52882,1144,103809,1924,84458,86079,43411,13542,139276,18141,34978,41298,7276,26481,173800,33210,17951,142652,33616,33677,2210,19941,98568,2486,192414,80136,12058,235883,50963,249638,29572,27221,47034,6124,72107,63346,97620,158513,299699,40388,23235,37176,224244,198386,121323,67992,23827,63170,17838,106622,158590,26807,5345,23489,91891,55474,74834,37981,13058,5977,72552,34706,26828,145172,19904,21367,34043,960,77092,91381,4733,47446,7680,41697,5170,16960,14741,46101,13656,473,51842,37433,11103,11551,121951,13191,97536,165932,50397,51628,129028,9069,44885,6590,59195,47045,32940,225472,90345,21833,13303,29407,96615,141951,5198,6028,18395,7181,3861,14966,156358,167182,36529,55253,25942,173153,30959,27261,50691,150176,162201,38467,48462,80602,42163,118482,168,108756,26011,17166,54149,456538,22512,91374,13816,90358,131615,18132,226707,1824,28139,26860,42253,93877,77351,65575,8980,80574,22020,27948,40422,91324,76376,13528,39281,91685,82215,122541,144066,1983,193851,17283,26320,2739,194978,4790,26845,42627,61300,65815,174612,55133,4200,191130,79771,158321,52280,166796,221620,62461,11278,4067,88152,83409,31717,121367,13522,47325,37945,10406,174348,249321,154101,64912,29938,51775,17220,15776,166138,78890,84425,54121,42861,16368,24572,291647,10197,32073,22651,11677,97509,26952,35787,18424,41910,71614,94977,72318,41594,70024,275419,37702,60199,7335,39107,61315,18271,18394,33768,87884,104277,123724,7277,56288,71981,189803,49320,3352,6798,14240,8954,69220,94433,57372,28620,68863,193727,85575,42309,41667,67689,42081,22543,44824,12719,28540,114236,101553,27638,27296,4300,5353,4663,19379,94098,3758,95888,95144,80344,87320,28447,259518,12718,71391,152731,37063,24132,31911,104896,15672,103782,1521,4945,72541,23717,122632,15619,87175,206120,29428,189780,61416,28350,44457,972,1175,47233,198738,95789,41907,21953,97034,59341,22864,53713,16873,32971,20693,20954,31336,21477,16169,38370,16412,9019,3841,24599,21938,17085,6484,81198,76413,5849,72514,12320,65247,276175,37234,59796,52642,16312,57349,198507,94148,46134,18958,125552,1747,18725,151873,14901,5490,68287,29470,3689,64794,40814,26018,25692,54450,2703,88278,124886,173087,174e3,24159,179477,24276,46004,201876,209202,445,52876,31948,30206,157610,39180,18439,44124,50469,5774,96278,222758,200216,50290,45486,20435,46986,46276,140133,142326,15569,13363,47522,92583,2182,7135,16853,22998,30272,4952,63263,35623,39096,53789,44864,20053,110392,124213,4630,16087,28221,127787,25839,77481,44693,13464,113146,6983,27069,55717,50102,4760,7107,26186,66507,59145,36032,104182,71328,29425,64317,50781,47465,94298,69706,74899,22754,120756,25108,93077,56834,73286,39928,16218,41699,176763,7555,70819,50083,26895,23315,26014,16773,123079,41712,5719,31516,90427,158540,85051,183128,40864,27505,55392,9058,45224,96857,30901,136622,96557,56304,120061,11501,151448,5773,89743,7769,86069,2935,18471,41628,10114,33660,110170,49479,26745,92846,33221,26731,18795,87076,8550,2100,29972,120289,3077,72490,33784,2630,208722,50861,63483,79029,6419,39467,14302,45286,64207,9686,67513,44170,1050,77246,59266,17055,53801,7150,11111,42432,4278,94579,362117,36175,42902,41933,39002,98489,22913,74161,84773,57036,17556,162288,74485,178760,93867,73635,128860,50362,261,67455,80001,46080,35662,4368,25247,19230,74393,22588,1822,27682,235324,13798,85998,13194,235067,23514,71669,147632,23191,134748,214683,105101,1518,25489,247114,7380,54842,26922,3971,26361,20844,68642,170517,77339,123255,8963,77818,150998,48466,36806,2732,23261,11741,236162,18243,126216,28690,50546,16385,92760,197383,246558,201295,88255,67588,71687,176076,172653,169058,33906,63747,24835,157621,43338,30050,46152,132741,2770,51371,94835,6614,15112,11749,56936,1250,19027,399017,58036,100215,23388,55815,308768,124152,94803,9521,64186,8971,28,30427,62163,7616,103838,35079,29203,131235,7743,17389,10882,37420,61460,228512,85363,41581,131077,62822,119647,10130,54445,26925,19968,29016,24446,74028,24176,61448,67185,9254,8563,119129,9771,99184,37716,39514,10532,221512,258753,218630,55980,23394,32141,61924,66749,32411,3741,36475,26678,77010,44946,91203,128749,116953,20476,49625,53116,13735,102335,29376,51946,83407,67892,59212,34685,21083,1546,112982,32972,74397,1078,190545,16082,86140,58591,89611,101531,10061,105104,76319,20035,17551,52611,169061,190842,100780,23907,90413,115619,9675,34710,193435,49443,129734,11183,258877,16318,136182,126808,44635,27304,192375,2599,125648,47051,12091,23814,721,58800,40137,66726,97930,60877,74487,7942,54326,9841,41428,13762,8211,85383,6950,99177,79806,201786,296464,124087,13144,29741,41721,47634,55088,254286,106408,17041,99064,12942,64086,45233,14005,2612,55827,255,7984,13980,38574,12776,46654,73499,249951,2101,26676,25996,132326,116415,119062,50449,31033,23038,11589,179252,20007,14860,129270,21143,17796,144715,60106,70758,69842,34674,282133,44014,16774,57268,38528,24053,46373,201667,28327,471023,51889,102667,21193,114909,84132,69317,96723,67969,16134,68145,15058,28765,32035,2524,101089,98664,25045,76571,14957,86040,118506,262428,154764,81573,39681,283900,73287,127825,544,80448,52347,38512,175971,15180,45467,33086,46552,48894,81107,43213,36672,54025,76703,8053,7608,13299,56619,20752,238099,54164,105133,1444,32942,953,37564,8e3,66316,119463,106817,404,13667,149108,128597,31267,10269,49836,106150,1484,52330,76965,160486,171648,38456,31263,22424,37738,66245,67467,143369,60471,75610,20895,115528,86070,60854,40796,49347,18989,15030,11371,37578,15779,79867,10187,86462,46402,155626,93200,40229,7090,57547,108053,99598,11088,47505,41218,206017,2173,20988,30219,22919,80563,57566,42369,93141,41675,2407,182519,120495,27154,16702,29456,14349,7958,16688,117177,140375,42467,261919,74916,153569,10836,34742,49526,7621,105997,12212,2270,392377,7755,17959,25086,232152,138791,33847,13860,35316,5811,1344,71259,50452,207539,92635,50359,5821,33674,30255,2086,2587,96264,17543,42,6029,9580,43007,139248,82831,12917,29607,25786,51467,42137,85161,100698,31561,88989,121990,278500,3602,109344,37982,15279,116442,28936,30880,87894,58079,128661,126731,67392,28051,146885,4861,16216,97344,42827,147561,153948,22684,21335,47685,1853,43349,15185,59642,10229,25520,187921,108972,5579,98037,24945,6697,19193,63734,137934,75056,89740,19767,224268,56138,63643,151661,39313,70618,84031,89723,84074,13703,85626,35460,8867,64845,3439,57906,99776,63968,49270,81130,34356,16210,23547,36446,34090,140028,72439,2221,22163,57058,363492,113754,18913,95451,48663,54464,54037,176097,68425,3023,34906,29482,117389,341780,80431,58330,16753,92616,60907,94846,147486,4498,48646,7773,46801,7778,18946,464978,47558,33223,177444,7328,15626,63337,94700,11743,9351,255024,39098,16447,42647,96230,39769,58840,10068,63439,35800,65843,58823,413844,9156,51258,7434,61791,85018,6872,3692,28096,7121,33024,6009,75532,31997,192535,9661,3304,9547,14753,31987,25314,55689,15896,20430,39472,31340,99744,25398,115569,54883,28719,205423,23071,57855,64638,149867,25671,82403,37616,20668,39989,77996,74948,140555,175248,64810,36515,46595,4958,248773,24045,28728,136673,168704,20804,114833,100325,27135,21205,96151,153134,45992,7093,13992,76047,1980,19432,145001,75159,87462,17710,1013,45556,34297,144882,20648,26061,11319,129567,108555,18872,464580,33386,22717,65948,167189,5603,135042,79542,8801,202632,18114,91882,5973,5239,67315,4431,60916,47819,71693,32597,32606,18183,45072,80329,76385,24749,51305,40314,156514,14693,130345,13168,66214,18029,12858,34801,27628,14544,10823,40522,40185,33739,148694,23548,9923,61012,28859,17933,19442,34364,99849,164107,141167,30629,21054,6744,36491,8096,42474,41706,155060,30650,10600,163442,1143,96655,61390,52359,7559,51568,64256,203854,4467,22453,14504,436398,7878,6980,8293,63610,293747,16167,35763,19627,147603,15419,18032,110744,51346,33681,54571,40472,48615,39073,21604,13754,173027,92560,11083,47299,63062,11813,52007,29883,9734,139722,15953,1550,20651,13616,49306,16113,90089,92326,7584,30712,72424,164858,6831,152871,55746,197721,34167,196442,6022,112107,55215,7538,123381,4920,43539,77165,8939,50392,34192,20225,79762,22505,58667,40770,29788,97180,82835,4568,8579,13273,363569,35898,49983,436,36598,3237,131691,62418,35591,8101,4073,379438,65218,76072,33887,2968,27573,212619,288680,68278,72851,150504,217896,6913,121339,22017,35340,51072,43616,75043,31437,10833,81487,4364,22968,41454,106687,85446,19863,109625,149241,524,141850,214404,54376,657,237023,9401,108137,53800,32474,49712,53334,126876,27337,45552,177696,8269,15036,12097,42240,2328,125374,119295,99715,2500,19624,39441,27220,102691,60957,94543,39101,18566,67362,13975,78230,25017,34017,239007,90027,39351,41681,35354,43822,1043,916,58587,141983,94818,38799,75459,41114,67432,16195,36606,59568,22272,126769,31424,68659,12287,134302,257977,5756,207285,95637,47248,117689,19583,77451,22373,12200,54993,117118,34244,29386,34562,53819,71267,64172,77665,49368,7716,59301,25749,45426,194789,17297,2650,1766,32501,45198,20403,20984,6600,14171,94604,19037,5402,29896,9938,59935,109708,88081,145182,44844,39167,352626,164173,35374,45982,6122,154,73419,220487,53834,53601,17992,8609,229321,5610,68098,66815,71012,95069,140968,27396,8957,134489,24656,86659,56598,134852,17316,123838,255436,6613,41610,138033,81452,32023,32396,123687,63398,8693,29712,30407,19296,121188,3551,36099,20032,111948,56624,16547,27453,35916,15378,52039,56849,13489,22214,73177,53097,277349,2157,14029,187886,10260,141743,246460,91880,50869,3788,49486,133566,54950,33120,129337,53768,18333,9525,26902,312251,10297,9020,70759,16647,112432,59260,84609,9818,82766,73569,468,46001,75780,55028,52106,11498,43645,108069,17150,17753,29417,16705,31799,9606,289,122254,115975,8620,6133,255357,56908,14456,133464,43554,79224,11247,29630,160,12756,25464,65960,350428,62521,321796,100359,67358,35169,46172,113128,48988,88868,31094,33266,6847,60887,98188,49659,69117,92977,220228,13947,80181,35103,62170,97351,13475,2440,199768,19498,36597,46971,25234,67806,62881,84717,73648,181966,10488,94149,21550,26655,63436,48375,14405,165650,9621,24439,28043,42735,4490,29963,56674,45373,1934,262446,50855,67098,26898,5261,52696,40644,33900,9440,180286,87162,22940,19704,26936,69769,10254,101759,27406,12243,48e3,73926,113215,54935,5726,192787,4312,106216,9366,11550,52949,23457,212271,277152,133895,108374,6191,96477,29980,218916,58024,54696,40853,91124,65894,91170,65908,252552,6793,29212,15389,44516,122515,52617,35058,9017,103536,39510,49136,19242,130652,662077,74699,47024,31422,8517,73351,24399,13867,128360,4810,4434,61779,111983,61036,17798,110240,59722,102960,39688,10001,23803,23039,176498,56659,44814,134295,17188,77577,74466,226175,102472,154333,63900,111747,18062,41171,79669,32773,408933,42562,28931,30907,107388,43487,2946,240310,23938,24354,319,184983,7927,6488,1422,10790,68809,68209,64775,4361,202,17123,59634,51200,44391,18188,17843,2619,74278,3230,9540,47187,21702,36274,56894,43907,16310,34790,16866,6150,5561,13587,107545,108873,126867,86986,28640,33427,19017,5762,80637,17430,46903,2047,131055,25958,13558,5444,47152,13900,44563,122857,45348,70863,39593,54332,38068,33637,318,40310,143467,18502,24520,11377,62013,28942,27246,28269,83545,17999,59015,90707,30065,15161,34720,1263,37008,2012,6060,98575,92933,5721,299,199555,24578,29223,2985,743,115825,109523,136657,47454,26378,53586,3733,174945,93340,244456,5693,37386,28782,89767,27545,23573,18798,136425,34320,84778,20041,48453,38215,7477,71958,40621,8773,5874,187927,105965,51100,43533,18083,8443,10180,43597,2003,183999,69689,12216,129696,146188,62389,34044,68410,12765,43273,26949,266807,3345,34477,79197,5688,47539,213110,21634,22257,50092,32222,42346,39530,63668,98,134978,74022,5152,59088,174145,37220,9934,9545,118937,5724,87240,19875,15784,40143,23263,87513,181654,285152,37881,263241,4966,43934,10433,186657,6470,74416,225854,25908,142677,246262,32280,6192,75890,45546,143264,135305,29742,47013,77787,11732,126658,8763,37950,21806,57557,113464,89465,108995,164574,23894,22996,23169,15369,23117,17642,130607,40503,36239,280990,44666,9981,40427,147487,26869,168452,32886,32991,46798,240839,15111,70502,65697,88548,44145,28701,48767,31139,206777,35659,181164,166262,14554,171445,31786,66523,76607,17956,6507,31279,90476,116611,167918,6560,1243,115324,80128,41867,55897,187323,37069,32596,189444,145931,13390,105530,65709,26805,6999,55714,41300,22915,68951,22138,21120,22264,10058,19945,33635,56123,99085,10032,5818,6016,46649,57476,35264,94413,112522,262288,93686,83038,14341,23204,28807,66084,77987,6101,126673,7133,38126,5923,122091,170240,97772,46874,215746,43948,41622,3272,55596,8332,146411,251315,13533,8561,81521,115449,48616,175175,2063,186556,3036,134537,75772,29728,82360,22973,186559,86348,89100,38388,82297,45610,2613,87082,9986,177812,57884,23591,47485,42543,33582,44713,74439,257444,252451,31825,35631,38540,33066,5147,13973,4343,51830,70378,22827,26448,95560,36896,241741,48067,203953,298860,61620,20450,3220,67272,6586,107662,100160,108684,6929,57226,4762,7457,1320,40404,77204,99309,62750,208653,59977,44e3,74315,34332,5819,172217,64904,114077,18147,84012,1791,98456,90930,21446,116669,103938,7422,85140,59713,5768,326211,16239,75411,13229,29398,10758,236107,1539,112472,95979,152154,151294,306,21196,38146,10700,6891,84282,109646,56492,40539,6589,119491,51354,30685,140209,136906,29622,73617,49553,70525,51671,166869,139616,74395,37439,49595,45678,11959,33211,86560,52434,9282,62690,112155,130810,5243,108261,99970,265613,72551,80049,6391,33365,90721,66737,69872,87011,1860,9032,112544,60905,37371,89015,140351,19076,850,373531,2802,36725,218795,72062,28990,16550,24614,7815,6187,26336,33373,32162,42791,73555,32062,23386,10244,56392,49442,27076,136262,12412,14883,1134,33675,97153,199281,15608,100152,74072,47942,254301,36451,16026,10687,65067,56708,254030,30290,50490,13864,57941,259331,35588,23485,43486,24869,21620,92971,22072,88645,1048,182050,13343,32452,14825,19509,3325,216938,45740,99716,189082,53740,78245,25609,24311,176777,47340,308354,40669,66085,14102,125339,9225,128709,97207,1271,200933,78439,113451,88975,18324,46521,11819,18570,141756,72512,170020,52754,63550,118515,103073,93330,32736,50499,14722,31600,68452,398867,29316,172786,18417,104924,2606,5670,84818,16288,67106,59580,82929,607401,291,85829,359,15897,35830,50696,65630,52672,22115,356968,29895,40837,231192,34024,38957,26722,406,23335,124952,72068,68804,13268,147101,164740,276569,162596,66943,11569,26654,66358,4777,23229,102127,5848,978,2921,59666,5371,28212,90108,42938,39320,2499,4271,108792,33510,125072,71653,65239,38250,66357,38577,13964,86251,35708,50755,36010,29448,12209,3844,38222,206337,100876,67827,137088,14167,252225,84163,195270,1306,5703,54198,779,46802,22028,51124,86759,70560,113164,35685,162145,45471,34561,422,2611,6464,47486,19223,38246,9191,18331,89942,243642,212364,15893,17518,22617,6409,30046,126182,59716,36560,104428,18846,26592,19458,50793,147333,30826,1388,27647,10922,14495,33545,19269,135828,39727,41601,46931,233379,49169,131130,182112,16276,82381,118209,142445,128310,19672,28740,82907,33436,3118,102206,28723,24819,41937,38854,5157,3881,111491,1142,9776,421673,152241,29309,14961,87854,6054,15424,3796,82656,54996,2108,55367,239450,154525,9643,118103,106041,64601,68549,48707,30266,25772,18740,9462,229669,91798,112152,191327,14493,72828,8175,66636,236474,25817,87351,129027,76653,20422,22983,71240,27846,44661,12399,46158,77704,53101,35032,11072,17300,109294,33638,24408,1895,11241,760,17584,82479,125877,63150,141075,34259,23274,81698,15732,43577,48340,91584,14688,16379,24481,150280,96420,262050,48635,43727,61819,56268,72003,88178,17281,79912,13218,122519,125295,166396,11811,2171,118930,67746,17636,178278,174656,95661,173039,83845,79689,17473,98555,127696,203415,54730,22925,232239,9309,12136,175026,20740,180188,10747,39816,314017,266131,10040,175732,112550,220651,31974,37393,888,23008,86799,4303,64905,148467,75337,251,3284,370102,50264,9835,5438,23655,4481,29851,329,12855,7162,64931,78141,12804,42372,296771,83547,18624,34874,86271,3360,48665,77735,88767,11463,63527,28889,22258,29140,194315,113924,25499,6406,31334,1845,4802,49184,43455,35469,127594,92970,61038,115005,38840,87761,106838,8811,20572,55637,11162,96721,132425,108925,2948,125457,36356,3502,75270,27622,127192,2561,123095,49394,61155,16897,110064,9699,89448,53356,19628,220310,21622,83036,9885,112214,6087,26713,17901,161912,91492,3440,68594,9266,92238,8087,6866,150194,72175,80701,13459,31836,43243,239700,95846,44749,50647,21945,230538,120612,132371,244604,5193,105637,34661,41341,68775,85393,1874,8771,33718,49672,77403,595452,99507,6490,58895,128742,7704,39239,73217,43816,62824,37804,199976,22361,80005,87514,94832,14089,4574,139975,59142,75523,100268,43906,53442,15152,2547,186002,17011,19513,204282,3343,60568,128318,119250,4298,51871,41336,71759,21921,45074,98169,145889,99427,11350,1237,5520,28799,7803,53702,21026,136352,38293,128690,12158,90132,44600,10184,26957,39459,126025,78904,82999,59373,39301,150198,120529,153042,20177,50089,14764,271571,30530,123161,38975,101562,22941,5648,124654,109243,69817,71675,49162,106884,21241,107795,30258,16572,188262,141456,7688,60718,8271,11044,32440,104608,103419,236109,93156,43293,128929,42107,67180,25201,115254,185488,130954,72813,167547,20537,39969,38432,22582,184022,1139,27199,5655,17767,97412,122606,209377,27070,35871,326617,188954,42680,73512,80911,22629,3011,95021,315242,157737,383,41821,41808,19335,27950,15674,25677,110950,35375,76835,59108,57370,35262,16569,160415,37706,78086,32041,49691,137143,9782,172080,50148,77917,6323,10110,69172,17711,21795,59511,76184,135114,31046,132319,59105,157578,20549,80778,57649,158421,65143,4575,72235,21899,10797,92745,34035,106079,80159,4508,78304,25350,75457,46458,32937,25623,47,8531,104751,84953,8138,36508,187199,66310,115274,13253,32461,38536,1916,42007,187160,35055,26325,84394,35963,94216,45590,97782],Jc=15;class XT{log;peerRouting;routingTable;refreshInterval;refreshQueryTimeout;commonPrefixLengthRefreshedAt;refreshTimeoutId;constructor(e,t){const{peerRouting:r,routingTable:i,refreshInterval:s,refreshQueryTimeout:o,logPrefix:a}=t;this.log=e.logger.forComponent(`${a}:routing-table:refresh`),this.peerRouting=r,this.routingTable=i,this.refreshInterval=s??WC,this.refreshQueryTimeout=o??GC,this.commonPrefixLengthRefreshedAt=[],this.refreshTable=this.refreshTable.bind(this)}async afterStart(){this.log(`refreshing routing table every ${this.refreshInterval}ms`),this.refreshTable(!0)}async stop(){this.refreshTimeoutId!=null&&clearTimeout(this.refreshTimeoutId)}refreshTable(e=!1,t){this.log("refreshing routing table");const r=this._maxCommonPrefix(),i=this._getTrackedCommonPrefixLengthsForRefresh(r);this.log(`max common prefix length ${r}`),this.log(`tracked CPLs [ ${i.map(s=>s.toISOString()).join(", ")} ]`),Promise.all(i.map(async(s,o)=>{try{if(await this._refreshCommonPrefixLength(o,s,e,t),this._numPeersForCpl(r)===0){const a=Math.min(2*(o+1),i.length-1);for(let c=o+1;c<a+1;c++)try{await this._refreshCommonPrefixLength(c,s,e,t)}catch(l){this.log.error(l)}}}catch(a){this.log.error(a)}})).catch(s=>{this.log.error(s)}).then(()=>{this.refreshTimeoutId=setTimeout(this.refreshTable,this.refreshInterval),this.refreshTimeoutId.unref!=null&&this.refreshTimeoutId.unref()}).catch(s=>{this.log.error(s)})}async _refreshCommonPrefixLength(e,t,r,i){if(!r&&t.getTime()>Date.now()-this.refreshInterval){this.log("not running refresh for cpl %s as time since last refresh not above interval",e);return}const s=this._generateRandomPeerId(e);this.log("starting refreshing cpl %s with key %p (routing table size was %s)",e,s,this.routingTable.size);const o=Re([i?.signal,AbortSignal.timeout(this.refreshQueryTimeout)]);try{const a=await j8(this.peerRouting.getClosestPeers(s.toMultihash().bytes,{signal:o}));this.log(`found ${a} peers that were close to imaginary peer %p`,s),this.log("finished refreshing cpl %s with key %p (routing table size is now %s)",e,s,this.routingTable.size)}finally{o.clear()}}_getTrackedCommonPrefixLengthsForRefresh(e){e>Jc&&(e=Jc);const t=[];for(let r=0;r<=e;r++)t[r]=this.commonPrefixLengthRefreshedAt[r]??new Date;return t}_generateRandomPeerId(e){if(this.routingTable.kb==null)throw new Error("Routing table not started");if(this.routingTable.kb.localPeer==null)throw new Error("Local peer not set");const t=an(2),r=(t[1]<<8)+t[0],i=this._makePeerId(this.routingTable.kb.localPeer.kadId,r,e),s=zt(i);return Pn(s)}_makePeerId(e,t,r){if(r>Jc)throw new Error(`Cannot generate peer ID for common prefix length greater than ${Jc}`);const o=new DataView(e.buffer,e.byteOffset,e.byteLength).getUint16(0,!1)^32768>>r,a=65535<<16-(r+1),c=o&a|t&~a,l=YT[c],u=new ArrayBuffer(34),d=new DataView(u,0,u.byteLength);return d.setUint8(0,gt.code),d.setUint8(1,32),d.setUint32(2,l,!1),new Uint8Array(d.buffer,d.byteOffset,d.byteLength)}_maxCommonPrefix(){let e=0;for(const t of this._prefixLengths())t>e&&(e=t);return e}_numPeersForCpl(e){let t=0;for(const r of this._prefixLengths())r===e&&t++;return t}*_prefixLengths(){if(this.routingTable.kb?.localPeer!=null)for(const{kadId:e}of this.routingTable.kb.toIterable()){const t=$s(this.routingTable.kb.localPeer.kadId,e);let r=0;for(const i of t)if(i===0)r++;else break;yield r}}}class ZT{peerId;providers;peerStore;log;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:add-provider`),this.peerId=e.peerId,this.providers=t.providers,this.peerStore=e.peerStore}async handle(e,t){if(t.key==null||t.key.length===0)throw new qe("Missing key");let r;try{r=he.decode(t.key)}catch{throw new qe("Invalid CID")}(t.providers==null||t.providers.length===0)&&this.log.error("no providers found in message"),this.log("%p asked us, %p to store provider record for for %c",e,this.peerId,r),await Promise.all(t.providers.map(async i=>{const s=zt(i.id),o=Pn(s),a=i.multiaddrs.map(c=>ue(c));if(!e.equals(o)){this.log("invalid provider peer %p from %p",i.id,e);return}if(i.multiaddrs.length<1){this.log("no valid addresses for provider %p. Ignore",e);return}this.log.trace("received provider %p for %s (addrs %s)",e,r,a),await this.providers.addProvider(r,o),await this.peerStore.merge(o,{multiaddrs:a})}))}}class JT{peerRouting;peerInfoMapper;peerId;addressManager;log;constructor(e,t){const{peerRouting:r,logPrefix:i}=t;this.log=e.logger.forComponent(`${i}:rpc:handlers:find-node`),this.peerId=e.peerId,this.addressManager=e.addressManager,this.peerRouting=r,this.peerInfoMapper=t.peerInfoMapper}async handle(e,t){this.log("incoming request from %p for peers close to %b",e,t.key);try{if(t.key==null)throw new qe("Invalid FIND_NODE message received - key was missing");const r=await this.peerRouting.getClosestPeersOffline(t.key,{exclude:[e,this.peerId]});Ue(this.peerId.toMultihash().bytes,t.key)&&r.push({id:this.peerId,multiaddrs:this.addressManager.getAddresses().map(s=>s.decapsulateCode(so("p2p").code))});const i={type:Ge.FIND_NODE,clusterLevel:t.clusterLevel,closer:r.map(this.peerInfoMapper).filter(({multiaddrs:s})=>s.length).map(s=>({id:s.id.toMultihash().bytes,multiaddrs:s.multiaddrs.map(o=>o.bytes)})),providers:[]};return i.closer.length===0?this.log("could not find any peers closer to %b for %p",t.key,e):this.log("found %d peers close to %b for %p",i.closer.length,t.key,e),i}catch(r){throw this.log("error during finding peers closer to %b for %p - %e",t.key,e,r),r}}}class eR{peerId;peerRouting;providers;peerStore;peerInfoMapper;log;constructor(e,t){const{peerRouting:r,providers:i,logPrefix:s}=t;this.log=e.logger.forComponent(`${s}:rpc:handlers:get-providers`),this.peerId=e.peerId,this.peerStore=e.peerStore,this.peerRouting=r,this.providers=i,this.peerInfoMapper=t.peerInfoMapper}async handle(e,t){if(t.key==null)throw new qe("Invalid GET_PROVIDERS message received - key was missing");let r;try{r=he.decode(t.key)}catch{throw new qe("Invalid CID")}this.log("%p asking for providers for %s",e,r);const[i,s]=await Promise.all([Ia(un(await this.providers.getProviders(r),async a=>{const c=await this.peerStore.get(a);return{id:c.id,multiaddrs:c.addresses.map(({multiaddr:u})=>u)}})),this.peerRouting.getClosestPeersOffline(t.key)]),o={type:Ge.GET_PROVIDERS,key:t.key,clusterLevel:t.clusterLevel,closer:s.map(this.peerInfoMapper).filter(({id:a,multiaddrs:c})=>c.length>0).map(a=>({id:a.id.toMultihash().bytes,multiaddrs:a.multiaddrs.map(c=>c.bytes)})),providers:i.map(this.peerInfoMapper).filter(({id:a,multiaddrs:c})=>c.length>0).map(a=>({id:a.id.toMultihash().bytes,multiaddrs:a.multiaddrs.map(c=>c.bytes)}))};return this.log("got %s providers %s closerPeers",o.providers.length,o.closer.length),o}async _getAddresses(e){return[]}}class tR{peerStore;datastore;peerRouting;log;datastorePrefix;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:get-value`),this.datastorePrefix=`${t.datastorePrefix}/record`,this.peerStore=e.peerStore,this.datastore=e.datastore,this.peerRouting=t.peerRouting}async handle(e,t){const r=t.key;if(this.log("%p asked for key %b",e,r),r==null||r.length===0)throw new qe("Invalid key");const i={type:Ge.GET_VALUE,key:r,clusterLevel:t.clusterLevel,closer:[],providers:[]};if(cT(r)){this.log("is public key");const a=lT(r);let c;try{const l=await this.peerStore.get(a);if(l.id.publicKey==null)throw new Xe("No public key found in key book");c=Xn(l.id.publicKey)}catch(l){if(l.name!=="NotFoundError")throw l}if(c!=null)return this.log("returning found public key"),i.record=new Rt(r,c,new Date).serialize(),i}const[s,o]=await Promise.all([this._checkLocalDatastore(r),this.peerRouting.getClosestPeersOffline(r)]);return s!=null&&(this.log("had record for %b in local datastore",r),i.record=s.serialize()),o.length>0&&(this.log("had %s closer peers in routing table",o.length),i.closer=o.map(a=>({id:a.id.toMultihash().bytes,multiaddrs:a.multiaddrs.map(c=>c.bytes)}))),i}async _checkLocalDatastore(e){this.log("checkLocalDatastore looking for %b",e);const t=fa(this.datastorePrefix,e);let r;try{r=await this.datastore.get(t)}catch(s){if(s.name==="NotFoundError")return;throw s}const i=Rt.deserialize(r);if(i.timeReceived==null||Date.now()-i.timeReceived.getTime()>H8){await this.datastore.delete(t);return}return i}}class rR{log;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:ping`)}async handle(e,t){return this.log("ping from %p",e),t}}class nR{components;validators;log;datastorePrefix;constructor(e,t){const{validators:r}=t;this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:put-value`),this.datastorePrefix=`${t.datastorePrefix}/record`,this.validators=r}async handle(e,t){const r=t.key;if(this.log("%p asked us to store value for key %b",e,r),t.record==null){const i=`Empty record from: ${e.toString()}`;throw this.log.error(i),new qe(i)}try{const i=Rt.deserialize(t.record);await Pp(this.validators,i),i.timeReceived=new Date;const s=fa(this.datastorePrefix,i.key);await this.components.datastore.put(s,i.serialize().subarray()),this.log("put record for %b into datastore under key %k",r,s)}catch(i){this.log("did not put record for key %b into datastore %o",r,i)}return t}}class iR{handlers;log;metrics;incomingMessageTimeout;constructor(e,t){this.metrics={operations:e.metrics?.registerCounterGroup(`${t.metricsPrefix}_inbound_rpc_requests_total`),errors:e.metrics?.registerCounterGroup(`${t.metricsPrefix}_inbound_rpc_errors_total`),rpcTime:e.metrics?.registerMetricGroup(`${t.metricsPrefix}_inbound_rpc_time_seconds`,{label:"operation"})},this.log=e.logger.forComponent(`${t.logPrefix}:rpc`),this.incomingMessageTimeout=t.incomingMessageTimeout??1e4,this.handlers={[Ge.GET_VALUE.toString()]:new tR(e,t),[Ge.PUT_VALUE.toString()]:new nR(e,t),[Ge.FIND_NODE.toString()]:new JT(e,t),[Ge.ADD_PROVIDER.toString()]:new ZT(e,t),[Ge.GET_PROVIDERS.toString()]:new eR(e,t),[Ge.PING.toString()]:new rR(e,t)}}async handleMessage(e,t){const r=this.handlers[t.type];if(r==null){this.log.error(`no handler found for message type: ${t.type}`);return}try{return this.metrics.operations?.increment({[t.type]:!0}),await r.handle(e,t)}catch{this.metrics.errors?.increment({[t.type]:!0})}}onIncomingStream(e){const t="unknown";Promise.resolve().then(async()=>{const{stream:r,connection:i}=e,s=()=>{r.abort(new nc)};let o=AbortSignal.timeout(this.incomingMessageTimeout);o.addEventListener("abort",s);const a=Nt(r).pb(Rs);try{for(;;){const c=await a.read({signal:o}),l=this.metrics?.rpcTime?.timer(c.type.toString()),u=this.metrics?.rpcTime?.timer(c.type.toString());let d=!1;try{this.log("incoming %s from %p",c.type,i.remotePeer);const h=await this.handleMessage(i.remotePeer,c);h!=null&&await a.write(h,{signal:o})}catch(h){throw d=!0,u?.(),h}finally{d||l?.()}o.removeEventListener("abort",s),o=AbortSignal.timeout(this.incomingMessageTimeout),o.addEventListener("abort",s)}}catch(c){r.abort(c)}}).catch(r=>{this.log.error("error handling %s RPC message from %p - %e",t,e.connection.remotePeer,r)})}}class sR extends tt{log;components;protocol;running;registrarId;constructor(e,t){super();const{protocol:r,logPrefix:i}=t;this.components=e,this.log=e.logger.forComponent(`${i}:topology-listener`),this.running=!1,this.protocol=r}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.registrarId=await this.components.registrar.register(this.protocol,{onConnect:e=>{this.log("observed peer %p with protocol %s",e,this.protocol),this.dispatchEvent(new CustomEvent("peer",{detail:e}))}}))}async stop(){this.running=!1,this.registrarId!=null&&(this.components.registrar.unregister(this.registrarId),this.registrarId=void 0)}}class oR{dht;constructor(e){this.dht=e}async provide(e,t={}){await xn(this.dht.provide(e,t))}async cancelReprovide(e){await this.dht.cancelReprovide(e)}async*findProviders(e,t={}){for await(const r of this.dht.findProviders(e,t))r.name==="PROVIDER"&&(yield*r.providers)}async put(e,t,r){await xn(this.dht.put(e,t,r))}async get(e,t){for await(const r of this.dht.get(e,t))if(r.name==="VALUE")return r.value;throw new Xe("Could not find value for key")}}class aR{dht;constructor(e){this.dht=e}async findPeer(e,t={}){for await(const r of this.dht.findPeer(e,t))if(r.name==="FINAL_PEER")return r.peer;throw new Xe("Peer not found")}async*getClosestPeers(e,t={}){for await(const r of this.dht.getClosestPeers(e,t))r.name==="FINAL_PEER"&&(yield r.peer)}}const cR=32,lR=64;class uR extends tt{k;a;d;protocol;routingTable;providers;network;peerRouting;components;log;running;clientMode;validators;selectors;queryManager;contentFetching;contentRouting;routingTableRefresh;rpc;topologyListener;querySelf;maxInboundStreams;maxOutboundStreams;dhtContentRouting;dhtPeerRouting;peerInfoMapper;reprovider;onPeerConnectTimeout;constructor(e,t={}){super();const r=t.logPrefix??"libp2p:kad-dht",i=t.datastorePrefix??"/dht",s=t.metricsPrefix??"libp2p_kad_dht",o={queries:e.metrics?.registerMetricGroup(`${s}_operations_total`,{label:"operation"}),errors:e.metrics?.registerCounterGroup(`${s}_operation_errors_total`,{label:"operation"}),queryTime:e.metrics?.registerMetricGroup(`${s}_operation_time_seconds`,{label:"operation"}),errorTime:e.metrics?.registerMetricGroup(`${s}_operation_error_time_seconds`,{label:"operation"})};this.running=!1,this.components=e,this.log=e.logger.forComponent(r),this.k=t.kBucketSize??Np,this.a=t.alpha??Cd,this.d=t.disjointPaths??this.a,this.protocol=t.protocol??MC,this.clientMode=t.clientMode??!0,this.maxInboundStreams=t.maxInboundStreams??cR,this.maxOutboundStreams=t.maxOutboundStreams??lR,this.peerInfoMapper=t.peerInfoMapper??oT,this.onPeerConnectTimeout=t.onPeerConnectTimeout??qC,this.providers=new ST(e,{...t.providers,logPrefix:r,datastorePrefix:i}),this.validators={...iT,...t.validators},this.selectors={...rT,...t.selectors},this.network=new bT(e,{protocol:this.protocol,logPrefix:r,metricsPrefix:s}),this.routingTable=new QT(e,{kBucketSize:this.k,pingOldContactTimeout:t.pingOldContactTimeout,pingOldContactConcurrency:t.pingOldContactConcurrency,pingOldContactMaxQueueSize:t.pingOldContactMaxQueueSize,pingNewContactTimeout:t.pingNewContactTimeout,pingNewContactConcurrency:t.pingNewContactConcurrency,pingNewContactMaxQueueSize:t.pingNewContactMaxQueueSize,protocol:this.protocol,logPrefix:r,metricsPrefix:s,prefixLength:t.prefixLength,splitThreshold:t.kBucketSplitThreshold,network:this.network});const a=we();t.allowQueryWithZeroPeers===!0&&a.resolve(),this.queryManager=new IT(e,{disjointPaths:this.d,alpha:this.a,logPrefix:r,metricsPrefix:s,initialQuerySelfHasRun:a,routingTable:this.routingTable,allowQueryWithZeroPeers:t.allowQueryWithZeroPeers}),this.peerRouting=new ET(e,{routingTable:this.routingTable,network:this.network,validators:this.validators,queryManager:this.queryManager,logPrefix:r}),this.contentFetching=new yT(e,{validators:this.validators,selectors:this.selectors,peerRouting:this.peerRouting,queryManager:this.queryManager,network:this.network,logPrefix:r,datastorePrefix:i}),this.contentRouting=new vT(e,{network:this.network,peerRouting:this.peerRouting,queryManager:this.queryManager,routingTable:this.routingTable,providers:this.providers,logPrefix:r}),this.routingTableRefresh=new XT(e,{peerRouting:this.peerRouting,routingTable:this.routingTable,logPrefix:r}),this.rpc=new iR(e,{routingTable:this.routingTable,providers:this.providers,peerRouting:this.peerRouting,validators:this.validators,logPrefix:r,metricsPrefix:s,datastorePrefix:i,peerInfoMapper:this.peerInfoMapper}),this.topologyListener=new sR(e,{protocol:this.protocol,logPrefix:r}),this.querySelf=new TT(e,{peerRouting:this.peerRouting,interval:t.querySelfInterval,initialInterval:t.initialQuerySelfInterval,logPrefix:r,initialQuerySelfHasRun:a,operationMetrics:o}),this.reprovider=new RT(e,{...t.reprovide,logPrefix:r,metricsPrefix:s,datastorePrefix:i,contentRouting:this.contentRouting,operationMetrics:o}),this.network.addEventListener("peer",c=>{const l=c.detail;this.onPeerConnect(l).catch(u=>{this.log.error("could not add %p to routing table",l.id,u)}),this.dispatchEvent(new CustomEvent("peer",{detail:l}))}),this.topologyListener.addEventListener("peer",c=>{const l=c.detail;Promise.resolve().then(async()=>{const u=await this.components.peerStore.get(l),d={id:l,multiaddrs:u.addresses.map(({multiaddr:h})=>h),protocols:u.protocols};await this.onPeerConnect(d)}).catch(u=>{this.log.error("could not add %p to routing table - %e - %e",l,u)})}),this.dhtPeerRouting=new aR(this),this.dhtContentRouting=new oR(this),t.clientMode==null&&e.events.addEventListener("self:peer:update",c=>{this.log("received update of self-peer info"),Promise.resolve().then(async()=>{const l=c.detail.peer.addresses.some(({multiaddr:d})=>mT(d)),u=this.getMode();l&&u==="client"?await this.setMode("server"):u==="server"&&!l&&await this.setMode("client")}).catch(l=>{this.log.error("error setting dht server mode",l)})}),this.get=fs(this.get.bind(this),o,"GET_VALUE"),this.findProviders=fs(this.findProviders.bind(this),o,"FIND_PROVIDERS"),this.findPeer=fs(this.findPeer.bind(this),o,"FIND_PEER"),this.getClosestPeers=fs(this.getClosestPeers.bind(this),o,"GET_CLOSEST_PEERS"),this.provide=fs(this.provide.bind(this),o,"PROVIDE"),this.put=fs(this.put.bind(this),o,"PUT_VALUE")}[Symbol.toStringTag]="@libp2p/kad-dht";[St]=["@libp2p/content-routing","@libp2p/peer-routing","@libp2p/peer-discovery","@libp2p/kad-dht"];[Mi]=["@libp2p/identify","@libp2p/ping"];get[Ns](){return this.dhtContentRouting}get[Ds](){return this.dhtPeerRouting}get[Sl](){return this}async onPeerConnect(e){if(this.log.trace("peer %p connected",e.id),e=this.peerInfoMapper(e),e.multiaddrs.length===0){this.log.trace("ignoring %p as there were no valid addresses in %s after filtering",e.id,e.multiaddrs.map(r=>r.toString()));return}const t=AbortSignal.timeout(this.onPeerConnectTimeout);try{await this.routingTable.add(e.id,{signal:t})}catch(r){this.log.error("could not add %p to routing table",e.id,r)}}isStarted(){return this.running}getMode(){return this.clientMode?"client":"server"}async setMode(e,t){if(e===this.getMode()&&t?.force!==!0){this.log("already in %s mode",e);return}if(await this.components.registrar.unhandle(this.protocol,t),e===this.getMode()&&t?.force!==!0){this.log("already in %s mode",e);return}e==="client"?(this.log("enabling client mode while in %s mode",this.getMode()),this.clientMode=!0):(this.log("enabling server mode while in %s mode",this.getMode()),this.clientMode=!1,await this.components.registrar.handle(this.protocol,this.rpc.onIncomingStream.bind(this.rpc),{signal:t?.signal,maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}))}async start(){this.running||(this.running=!0,await this.setMode(this.clientMode?"client":"server",{force:!0}),await Sn(this.routingTable,this.queryManager,this.network,this.topologyListener,this.routingTableRefresh,this.reprovider),await Sn(this.querySelf))}async stop(){this.running=!1,await hi(this.querySelf,this.queryManager,this.network,this.routingTable,this.routingTableRefresh,this.topologyListener,this.reprovider)}async*put(e,t,r={}){yield*this.contentFetching.put(e,t,r)}async*get(e,t={}){yield*this.contentFetching.get(e,t)}async*provide(e,t={}){yield*this.contentRouting.provide(e,this.components.addressManager.getAddresses(),t)}async cancelReprovide(e,t){await this.providers.removeProvider(e,this.components.peerId,t)}async*findProviders(e,t={}){yield*this.contentRouting.findProviders(e,t)}async*findPeer(e,t={}){yield*this.peerRouting.findPeer(e,t)}async*getClosestPeers(e,t={}){yield*this.peerRouting.getClosestPeers(e,t)}async refreshRoutingTable(e){this.routingTableRefresh.refreshTable(!0,e)}}var K3;(function(n){n[n.SEND_QUERY=0]="SEND_QUERY",n[n.PEER_RESPONSE=1]="PEER_RESPONSE",n[n.FINAL_PEER=2]="FINAL_PEER",n[n.QUERY_ERROR=3]="QUERY_ERROR",n[n.PROVIDER=4]="PROVIDER",n[n.VALUE=5]="VALUE",n[n.ADD_PEER=6]="ADD_PEER",n[n.DIAL_PEER=7]="DIAL_PEER",n[n.PATH_ENDED=8]="PATH_ENDED"})(K3||(K3={}));function dR(n={}){return e=>new uR(e,n)}function hR(n,e,t,r){X0(n);const i=av({dkLen:32,asyncTick:10},r),{c:s,dkLen:o,asyncTick:a}=i;if(ul(s),ul(o),ul(a),s<1)throw new Error("iterations (c) should be >= 1");const c=Q2(e),l=Q2(t),u=new Uint8Array(o),d=Z0.create(n,c),h=d._cloneInto().update(l);return{c:s,dkLen:o,asyncTick:a,DK:u,PRF:d,PRFSalt:h}}function fR(n,e,t,r,i){return n.destroy(),e.destroy(),r&&r.destroy(),C5(i),t}async function Q8(n,e,t,r){const{c:i,dkLen:s,asyncTick:o,DK:a,PRF:c,PRFSalt:l}=hR(n,e,t,r);let u;const d=new Uint8Array(4),h=sv(d),f=new Uint8Array(c.outputLen);for(let m=1,y=0;y<s;m++,y+=c.outputLen){const w=a.subarray(y,y+c.outputLen);h.setInt32(0,m,!1),(u=l._cloneInto(u)).update(d).digestInto(f),w.set(f.subarray(0,w.length)),await ov(i-1,o,()=>{c._cloneInto(u).update(f).digestInto(f);for(let E=0;E<w.length;E++)w[E]^=f[E]})}return fR(c,l,a,u,f)}const Y8=cv,pR=16,sf=32,of=1e4;async function Td(n,e){const r=await cd().encrypt(n,e);return Fr.encode(r)}async function W3(n,e,t){if(n.type==="RSA")return wR(n,e,t);if(n.type==="Ed25519")return gR(n,e,t);if(n.type==="secp256k1")return mR(n,e,t);if(n.type==="ECDSA")return yR(n,e,t);throw new Kw}async function gR(n,e,t="libp2p-key"){if(t==="libp2p-key")return Td(dn(n),e);throw new $(`export format '${t}' is not supported`)}async function mR(n,e,t="libp2p-key"){if(t==="libp2p-key")return Td(dn(n),e);throw new $("Export format is not supported")}async function yR(n,e,t="libp2p-key"){if(t==="libp2p-key")return Td(dn(n),e);throw new $(`export format '${t}' is not supported`)}async function wR(n,e,t="pkcs-8"){if(t==="pkcs-8")return vR(n,e);if(t==="libp2p-key")return Td(dn(n),e);throw new $("Export format is not supported")}async function vR(n,e){const t=ac.get(),i=new De({value:[new Ar({value:0}),new De({value:[new Zt({value:"1.2.840.113549.1.1.1"}),new zr]}),new $t({valueHex:n.raw})]}).toBER(),s=new Uint8Array(i,0,i.byteLength),o=an(pR),a=await Q8(Y8,e,o,{c:of,dkLen:sf}),c=an(16),l=await t.subtle.importKey("raw",a,"AES-CBC",!1,["encrypt"]),u=await t.subtle.encrypt({name:"AES-CBC",iv:c},l,s),d=new De({value:[new $t({valueHex:o}),new Ar({value:of}),new Ar({value:sf}),new De({value:[new Zt({value:"1.2.840.113549.2.11"}),new zr]})]}),h=new De({value:[new Zt({value:"1.2.840.113549.1.5.13"}),new De({value:[new De({value:[new Zt({value:"1.2.840.113549.1.5.12"}),d]}),new De({value:[new Zt({value:"2.16.840.1.101.3.4.1.42"}),new $t({valueHex:c})]})]})]}),m=new De({value:[h,new $t({valueHex:u})]}).toBER(),y=new Uint8Array(m,0,m.byteLength);return["-----BEGIN ENCRYPTED PRIVATE KEY-----",...ee(y,"base64pad").split(/(.{64})/).filter(Boolean),"-----END ENCRYPTED PRIVATE KEY-----"].join(`
`)}async function G3(n,e){try{const t=await bR(n,e);return S5(t)}catch{}if(!n.includes("BEGIN"))throw new $("Encrypted key was not a libp2p-key or a PEM file");return ER(n,e)}async function bR(n,e){const t=Fr.decode(n);return cd().decrypt(t,e)}async function ER(n,e){const t=ac.get();let r;if(n.includes("-----BEGIN ENCRYPTED PRIVATE KEY-----")){const s=C(n.replace("-----BEGIN ENCRYPTED PRIVATE KEY-----","").replace("-----END ENCRYPTED PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:o}=xr(s),{iv:a,salt:c,iterations:l,keySize:u,cipherText:d}=SR(o),h=await Q8(Y8,e,c,{c:l,dkLen:u}),f=await t.subtle.importKey("raw",h,"AES-CBC",!1,["decrypt"]),m=ga(await t.subtle.decrypt({name:"AES-CBC",iv:a},f,d)),{result:y}=xr(m);r=j3(y)}else if(n.includes("-----BEGIN PRIVATE KEY-----")){const s=C(n.replace("-----BEGIN PRIVATE KEY-----","").replace("-----END PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:o}=xr(s);r=j3(o)}else throw new $("Could not parse private key from PEM data");const i=x5(r);if(i.type!=="RSA")throw new $("Could not parse RSA private key from PEM data");return i}function SR(n){const e=n.valueBlock.value[0];if(e.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.13")throw new $("Only pkcs5PBES2 encrypted private keys are supported");const r=e.valueBlock.value[1].valueBlock.value[0];if(r.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.12")throw new $("Only pkcs5PBKDF2 key derivation functions are supported");const s=r.valueBlock.value[1],o=ga(s.valueBlock.value[0].getValue());let a=of,c=sf;if(s.valueBlock.value.length===3)a=Number(s.valueBlock.value[1].toBigInt()),c=Number(s.valueBlock.value[2].toBigInt());else if(s.valueBlock.value.length===2)throw new $("Could not derive key size and iterations from PEM file - please use @libp2p/rsa to re-import your key");const l=e.valueBlock.value[1].valueBlock.value[1],u=l.valueBlock.value[0].toString();if(u!=="OBJECT IDENTIFIER : 1.2.840.113549.3.7"){if(u!=="OBJECT IDENTIFIER : 1.3.14.3.2.7"){if(u!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.2"){if(u!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.22"){if(u!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.42")throw new $("Only AES-CBC encryption schemes are supported")}}}}const d=ga(l.valueBlock.value[1].getValue());return{cipherText:ga(n.valueBlock.value[1].getValue()),salt:o,iterations:a,keySize:c,iv:d}}function j3(n){return ga(n.valueBlock.value[2].getValue())}function ga(n){return new Uint8Array(n,0,n.byteLength)}const xR="/pkcs8/",af="/info/",Po=new WeakMap,bi={minKeyLength:112/8,minSaltLength:128/8,minIterationCount:1e3},Qh={dek:{keyLength:512/8,iterationCount:1e4,salt:"you should override this value with a crypto secure random number",hash:"sha2-512"}};function ps(n){return n==null||typeof n!="string"?!1:n===gy(n.trim())&&n.length>0}async function bt(){const t=Math.random()*800+200;await new Promise(r=>setTimeout(r,t))}function Ei(n){return new Te(xR+n)}function gs(n){return new Te(af+n)}async function AR(n){const e=dn(n),t=await gt.digest(e);return Di.encode(t.bytes).substring(1)}class kR{components;init;log;self;constructor(e,t){if(this.components=e,this.log=e.logger.forComponent("libp2p:keychain"),this.init=Wr(Qh,t),this.self=t.selfKey??"self",this.init.pass!=null&&this.init.pass?.length<20)throw new Error("pass must be least 20 characters");if(this.init.dek?.keyLength!=null&&this.init.dek.keyLength<bi.minKeyLength)throw new Error(`dek.keyLength must be least ${bi.minKeyLength} bytes`);if(this.init.dek?.salt?.length!=null&&this.init.dek.salt.length<bi.minSaltLength)throw new Error(`dek.saltLength must be least ${bi.minSaltLength} bytes`);if(this.init.dek?.iterationCount!=null&&this.init.dek.iterationCount<bi.minIterationCount)throw new Error(`dek.iterationCount must be least ${bi.minIterationCount}`);const r=this.init.pass!=null&&this.init.dek?.salt!=null?_l(this.init.pass,this.init.dek?.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";Po.set(this,{dek:r})}[Symbol.toStringTag]="@libp2p/keychain";[St]=["@libp2p/keychain"];static generateOptions(){const e=Object.assign({},Qh),t=Math.ceil(bi.minSaltLength/3)*3;return e.dek.salt=ee(an(t),"base64"),e}static get options(){return Qh}async findKeyByName(e){if(!ps(e))throw await bt(),new $(`Invalid key name '${e}'`);const t=gs(e);try{const r=await this.components.datastore.get(t);return JSON.parse(ee(r))}catch(r){throw await bt(),this.log.error(r),new Xe(`Key '${e}' does not exist.`)}}async findKeyById(e){try{const t={prefix:af};for await(const r of this.components.datastore.query(t)){const i=JSON.parse(ee(r.value));if(i.id===e)return i}throw new $(`Key with id '${e}' does not exist.`)}catch(t){throw await bt(),t}}async importKey(e,t){if(!ps(e))throw await bt(),new $(`Invalid key name '${e}'`);if(t==null)throw await bt(),new $("Key is required");const r=Ei(e);if(await this.components.datastore.has(r))throw await bt(),new $(`Key '${e}' already exists`);let s,o;try{s=await AR(t);const l=Po.get(this);if(l==null)throw new $("dek missing");const u=l.dek;o=await W3(t,u,t.type==="RSA"?"pkcs-8":"libp2p-key")}catch(l){throw await bt(),l}const a={name:e,id:s},c=this.components.datastore.batch();return c.put(r,C(o)),c.put(gs(e),C(JSON.stringify(a))),await c.commit(),a}async exportKey(e){if(!ps(e))throw await bt(),new $(`Invalid key name '${e}'`);const t=Ei(e);try{const r=await this.components.datastore.get(t),i=ee(r),s=Po.get(this);if(s==null)throw new $("dek missing");const o=s.dek;return await G3(i,o)}catch(r){throw await bt(),r}}async removeKey(e){if(!ps(e)||e===this.self)throw await bt(),new $(`Invalid key name '${e}'`);const t=Ei(e),r=await this.findKeyByName(e),i=this.components.datastore.batch();return i.delete(t),i.delete(gs(e)),await i.commit(),r}async listKeys(){const e={prefix:af},t=[];for await(const r of this.components.datastore.query(e))t.push(JSON.parse(ee(r.value)));return t}async renameKey(e,t){if(!ps(e)||e===this.self)throw await bt(),new $(`Invalid old key name '${e}'`);if(!ps(t)||t===this.self)throw await bt(),new $(`Invalid new key name '${t}'`);const r=Ei(e),i=Ei(t),s=gs(e),o=gs(t);if(await this.components.datastore.has(i))throw await bt(),new $(`Key '${t}' already exists`);try{const c=await this.components.datastore.get(r),l=await this.components.datastore.get(s),u=JSON.parse(ee(l));u.name=t;const d=this.components.datastore.batch();return d.put(i,c),d.put(o,C(JSON.stringify(u))),d.delete(r),d.delete(s),await d.commit(),u}catch(c){throw await bt(),c}}async rotateKeychainPass(e,t){if(typeof e!="string")throw await bt(),new $(`Invalid old pass type '${typeof e}'`);if(typeof t!="string")throw await bt(),new $(`Invalid new pass type '${typeof t}'`);if(t.length<20)throw await bt(),new $(`Invalid pass length ${t.length}`);this.log("recreating keychain");const r=Po.get(this);if(r==null)throw new $("dek missing");const i=r.dek;this.init.pass=t;const s=t!=null&&this.init.dek?.salt!=null?_l(t,this.init.dek.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";Po.set(this,{dek:s});const o=await this.listKeys();for(const a of o){const c=await this.components.datastore.get(Ei(a.name)),l=ee(c),u=await G3(l,i),d=s.toString(),h=await W3(u,d,u.type==="RSA"?"pkcs-8":"libp2p-key"),f=this.components.datastore.batch(),m={name:a.name,id:a.id};f.put(Ei(a.name),C(h)),f.put(gs(a.name),C(JSON.stringify(m))),await f.commit()}this.log("keychain reconstructed")}}function _R(n={}){return e=>new kR(e,n)}var ke;(function(n){n[n.NEW_STREAM=0]="NEW_STREAM",n[n.MESSAGE_RECEIVER=1]="MESSAGE_RECEIVER",n[n.MESSAGE_INITIATOR=2]="MESSAGE_INITIATOR",n[n.CLOSE_RECEIVER=3]="CLOSE_RECEIVER",n[n.CLOSE_INITIATOR=4]="CLOSE_INITIATOR",n[n.RESET_RECEIVER=5]="RESET_RECEIVER",n[n.RESET_INITIATOR=6]="RESET_INITIATOR"})(ke||(ke={}));const Dp=Object.freeze({0:"NEW_STREAM",1:"MESSAGE_RECEIVER",2:"MESSAGE_INITIATOR",3:"CLOSE_RECEIVER",4:"CLOSE_INITIATOR",5:"RESET_RECEIVER",6:"RESET_INITIATOR"}),Q3=Object.freeze({NEW_STREAM:ke.NEW_STREAM,MESSAGE:ke.MESSAGE_INITIATOR,CLOSE:ke.CLOSE_INITIATOR,RESET:ke.RESET_INITIATOR}),IR=Object.freeze({MESSAGE:ke.MESSAGE_RECEIVER,CLOSE:ke.CLOSE_RECEIVER,RESET:ke.RESET_RECEIVER}),X8=1<<20,CR=4<<20;class TR{_buffer;_headerInfo;_maxMessageSize;_maxUnprocessedMessageQueueSize;constructor(e=X8,t=CR){this._buffer=new $e,this._headerInfo=null,this._maxMessageSize=e,this._maxUnprocessedMessageQueueSize=t}write(e){if(e==null||e.length===0)return[];if(this._buffer.append(e),this._buffer.byteLength>this._maxUnprocessedMessageQueueSize)throw new qe("Unprocessed message queue size too large!");const t=[];for(;this._buffer.length!==0;){if(this._headerInfo==null)try{this._headerInfo=this._decodeHeader(this._buffer)}catch(l){if(l.name==="InvalidMessageError")throw l;break}const{id:r,type:i,length:s,offset:o}=this._headerInfo;if(this._buffer.length-o<s)break;const c={id:r,type:i};(i===ke.NEW_STREAM||i===ke.MESSAGE_INITIATOR||i===ke.MESSAGE_RECEIVER)&&(c.data=this._buffer.sublist(o,o+s)),t.push(c),this._buffer.consume(o+s),this._headerInfo=null}return t}_decodeHeader(e){const{value:t,offset:r}=X3(e),{value:i,offset:s}=X3(e,r),o=t&7;if(Dp[o]==null)throw new Error(`Invalid type received: ${o}`);if(i>this._maxMessageSize)throw new qe("Message size too large");return{id:t>>3,type:o,offset:r+s,length:i}}}const RR=128,Y3=127;function X3(n,e=0){let t=0,r=0,i=e,s;const o=n.length;do{if(i>=o||r>49)throw e=0,new RangeError("Could not decode varint");s=n.get(i++),t+=r<28?(s&Y3)<<r:(s&Y3)*Math.pow(2,r),r+=7}while(s>=RR);return e=i-e,{value:t,offset:e}}const Yh=10*1024;class PR{_pool;_poolOffset;constructor(){this._pool=Aa(Yh),this._poolOffset=0}write(e,t){const r=this._pool;let i=this._poolOffset;Mr(e.id<<3|e.type,r,i),i+=Ft(e.id<<3|e.type),(e.type===ke.NEW_STREAM||e.type===ke.MESSAGE_INITIATOR||e.type===ke.MESSAGE_RECEIVER)&&e.data!=null?(Mr(e.data.length,r,i),i+=Ft(e.data.length)):(Mr(0,r,i),i+=Ft(0));const s=r.subarray(this._poolOffset,i);Yh-i<100?(this._pool=Aa(Yh),this._poolOffset=0):this._poolOffset=i,t.append(s),(e.type===ke.NEW_STREAM||e.type===ke.MESSAGE_INITIATOR||e.type===ke.MESSAGE_RECEIVER)&&e.data!=null&&t.append(e.data)}}const OR=new PR;async function*NR(n){for await(const e of n){const t=new $e;OR.write(e,t),yield t}}class DR extends Error{constructor(e="Stream input buffer error"){super(e),this.name="StreamInputBufferError"}}class LR extends Tp{name;streamId;send;types;maxDataSize;constructor(e){super(e),this.types=e.direction==="outbound"?Q3:IR,this.send=e.send,this.name=e.name,this.streamId=e.streamId,this.maxDataSize=e.maxDataSize}async sendNewStream(){await this.send({id:this.streamId,type:Q3.NEW_STREAM,data:new $e(C(this.name))})}async sendData(e){for(e=e.sublist();e.byteLength>0;){const t=Math.min(e.byteLength,this.maxDataSize);await this.send({id:this.streamId,type:this.types.MESSAGE,data:e.sublist(0,t)}),e.consume(t)}}async sendReset(){await this.send({id:this.streamId,type:this.types.RESET})}async sendCloseWrite(){await this.send({id:this.streamId,type:this.types.CLOSE})}async sendCloseRead(){}}function BR(n){const{id:e,name:t,send:r,onEnd:i,type:s="initiator",maxMsgSize:o=X8}=n,a=s==="initiator"?"outbound":"inbound";return new LR({id:s==="initiator"?`i${e}`:`r${e}`,streamId:e,name:`${t??e}`,direction:a,maxDataSize:o,onEnd:i,send:r,log:n.log.newScope(`${a}:${e}`)})}const MR=1024,FR=1024,UR=1024*1024*4,$R=5,VR=500;function Z3(n){const e={...n,type:`${Dp[n.type]} (${n.type})`};return n.type===ke.NEW_STREAM&&(e.data=ee(n.data instanceof Uint8Array?n.data:n.data.subarray())),(n.type===ke.MESSAGE_INITIATOR||n.type===ke.MESSAGE_RECEIVER)&&(e.data=ee(n.data instanceof Uint8Array?n.data:n.data.subarray(),"base16")),e}class qR{protocol="/mplex/6.7.0";sink;source;log;_streamId;_streams;_init;_source;closeController;rateLimiter;closeTimeout;logger;constructor(e,t){t=t??{},this.log=t.log?.newScope("mplex")??e.logger.forComponent("libp2p:mplex"),this.logger=e.logger,this._streamId=0,this._streams={initiators:new Map,receivers:new Map},this._init=t,this.closeTimeout=t.closeTimeout??VR,this.sink=this._createSink(),this._source=fn({objectMode:!0,onEnd:()=>{for(const r of this._streams.initiators.values())r.destroy();for(const r of this._streams.receivers.values())r.destroy()}}),this.source=rr(this._source,r=>NR(r)),this.closeController=new AbortController,this.rateLimiter=new ey({points:t.disconnectThreshold??$R,duration:1})}get streams(){const e=[];for(const t of this._streams.initiators.values())e.push(t);for(const t of this._streams.receivers.values())e.push(t);return e}newStream(e){if(this.closeController.signal.aborted)throw new ws("Muxer already closed");const t=this._streamId++;e=e==null?t.toString():e.toString();const r=this._streams.initiators;return this._newStream({id:t,name:e,type:"initiator",registry:r})}async close(e){if(this.closeController.signal.aborted)return;const t=e?.signal??AbortSignal.timeout(this.closeTimeout);try{await Promise.all(this.streams.map(async r=>r.close({signal:t}))),this._source.end(),await this._source.onEmpty({signal:t}),this.closeController.abort()}catch(r){this.abort(r)}}abort(e){this.closeController.signal.aborted||(this.streams.forEach(t=>{t.abort(e)}),this.closeController.abort(e))}_newReceiverStream(e){const{id:t,name:r}=e,i=this._streams.receivers;return this._newStream({id:t,name:r,type:"receiver",registry:i})}_newStream(e){const{id:t,name:r,type:i,registry:s}=e;if(this.log("new %s stream %s",i,t),i==="initiator"&&this._streams.initiators.size===(this._init.maxOutboundStreams??FR))throw new G0("Too many outbound streams open");if(s.has(t))throw new Error(`${i} stream ${t} already exists!`);const c=BR({id:t,name:r,send:async l=>{this.log.enabled&&this.log.trace("%s stream %s send",i,t,Z3(l)),this._source.push(l)},type:i,onEnd:()=>{this.log("%s stream with id %s and protocol %s ended",i,t,c.protocol),s.delete(t),this._init.onStreamEnd!=null&&this._init.onStreamEnd(c)},maxMsgSize:this._init.maxMsgSize,log:this.log});return s.set(t,c),c}_createSink(){return async t=>{const r=()=>{T8(t,this.log)};this.closeController.signal.addEventListener("abort",r);try{const i=new TR(this._init.maxMsgSize,this._init.maxUnprocessedMessageQueueSize);for await(const s of t)for(const o of i.write(s))await this._handleIncoming(o);this._source.end()}catch(i){this.log("error in sink",i),this._source.end(i)}finally{this.closeController.signal.removeEventListener("abort",r)}}}async _handleIncoming(e){const{id:t,type:r}=e;if(this.log.enabled&&this.log.trace("incoming message",Z3(e)),e.type===ke.NEW_STREAM){if(this._streams.receivers.size===(this._init.maxInboundStreams??MR)){this.log("too many inbound streams open"),this._source.push({id:t,type:ke.RESET_RECEIVER});try{await this.rateLimiter.consume("new-stream",1)}catch{this.log("rate limit hit when opening too many new streams over the inbound stream limit - closing remote connection"),this.abort(new Error("Too many open streams"));return}return}const a=this._newReceiverStream({id:t,name:ee(e.data instanceof Uint8Array?e.data:e.data.subarray())});this._init.onIncomingStream!=null&&this._init.onIncomingStream(a);return}const s=((r&1)===1?this._streams.initiators:this._streams.receivers).get(t);if(s==null){this.log("missing stream %s for message type %s",t,Dp[r]);try{await this.rateLimiter.consume("missing-stream",1)}catch{this.log("rate limit hit when receiving messages for streams that do not exist - closing remote connection"),this.abort(new Error("Too many messages for missing streams"));return}return}const o=this._init.maxStreamBufferSize??UR;try{switch(r){case ke.MESSAGE_INITIATOR:case ke.MESSAGE_RECEIVER:if(s.sourceReadableLength()>o)throw this._source.push({id:e.id,type:r===ke.MESSAGE_INITIATOR?ke.RESET_RECEIVER:ke.RESET_INITIATOR}),new DR("Input buffer full - increase Mplex maxBufferSize to accommodate slow consumers");s.sourcePush(e.data);break;case ke.CLOSE_INITIATOR:case ke.CLOSE_RECEIVER:s.remoteCloseWrite();break;case ke.RESET_INITIATOR:case ke.RESET_RECEIVER:s.reset();break;default:this.log("unknown message type %s",r)}}catch(a){this.log.error("error while processing message",a),s.abort(a)}}}class HR{protocol="/mplex/6.7.0";_init;components;constructor(e,t={}){this.components=e,this._init=t}[Symbol.toStringTag]="@libp2p/mplex";[St]=["@libp2p/stream-multiplexing"];createStreamMuxer(e){return new qR(this.components,{...e,...this._init})}}function zR(n={}){return e=>new HR(e,n)}const Xh=32,KR="1.0.0",WR="ping",GR="ipfs",jR=1e4,QR=2,YR=1;class XR{protocol;components;started;timeout;maxInboundStreams;maxOutboundStreams;runOnLimitedConnection;constructor(e,t={}){this.components=e,this.started=!1,this.protocol=`/${t.protocolPrefix??GR}/${WR}/${KR}`,this.timeout=t.timeout??jR,this.maxInboundStreams=t.maxInboundStreams??QR,this.maxOutboundStreams=t.maxOutboundStreams??YR,this.runOnLimitedConnection=t.runOnLimitedConnection??!0,this.handleMessage=this.handleMessage.bind(this)}[Symbol.toStringTag]="@libp2p/ping";[St]=["@libp2p/ping"];async start(){await this.components.registrar.handle(this.protocol,this.handleMessage,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnection}),this.started=!0}async stop(){await this.components.registrar.unhandle(this.protocol),this.started=!1}isStarted(){return this.started}handleMessage(e){const t=e.connection.log.newScope("ping");t.trace("ping from %p",e.connection.remotePeer);const{stream:r}=e,i=Date.now(),s=Vl(r);let o=!1;Promise.resolve().then(async()=>{for(;;){const a=AbortSignal.timeout(this.timeout);a.addEventListener("abort",()=>{r?.abort(new nc("ping timeout"))});const c=await s.read({bytes:Xh,signal:a});await s.write(c,{signal:a}),o=!0}}).catch(a=>{o&&a.name==="UnexpectedEOFError"&&r.readStatus!=="ready"||(t.error("ping from %p failed with error - %e",e.connection.remotePeer,a),r?.abort(a))}).finally(()=>{const a=Date.now()-i;t("ping from %p complete in %dms",e.connection.remotePeer,a);const c=AbortSignal.timeout(this.timeout);r.close({signal:c}).catch(l=>{t.error("error closing ping stream from %p - %e",e.connection.remotePeer,l),r?.abort(l)})})}async ping(e,t={}){const r=Date.now(),i=an(Xh),s=await this.components.connectionManager.openConnection(e,t),o=s.log.newScope("ping");let a;if(t.signal==null){const c=AbortSignal.timeout(this.timeout);t={...t,signal:c}}try{a=await s.newStream(this.protocol,{...t,runOnLimitedConnection:this.runOnLimitedConnection});const c=Vl(a),[,l]=await Promise.all([c.write(i,t),c.read({...t,bytes:Xh})]),u=Date.now()-r;if(!Ue(i,l.subarray()))throw new Ww(`Received wrong ping ack after ${u}ms`);return o("ping %p complete in %dms",s.remotePeer,u),u}catch(c){throw o.error("error while pinging %p",s.remotePeer,c),a?.abort(c),c}finally{a!=null&&await a.close(t)}}}function ZR(n={}){return e=>new XR(e,n)}var jt;(function(n){(function(r){r.FIN="FIN",r.STOP_SENDING="STOP_SENDING",r.RESET="RESET",r.FIN_ACK="FIN_ACK"})(n.Flag||(n.Flag={}));let e;(function(r){r[r.FIN=0]="FIN",r[r.STOP_SENDING=1]="STOP_SENDING",r[r.RESET=2]="RESET",r[r.FIN_ACK=3]="FIN_ACK"})(e||(e={})),(function(r){r.codec=()=>Jt(e)})(n.Flag||(n.Flag={}));let t;n.codec=()=>(t==null&&(t=pe((r,i,s={})=>{s.lengthDelimited!==!1&&i.fork(),r.flag!=null&&(i.uint32(8),n.Flag.codec().encode(r.flag,i)),r.message!=null&&(i.uint32(18),i.bytes(r.message)),s.lengthDelimited!==!1&&i.ldelim()},(r,i,s={})=>{const o={},a=i==null?r.len:r.pos+i;for(;r.pos<a;){const c=r.uint32();switch(c>>>3){case 1:{o.flag=n.Flag.codec().decode(r);break}case 2:{o.message=r.bytes();break}default:{r.skipType(c&7);break}}}return o})),t),n.encode=r=>ge(r,n.codec()),n.decode=(r,i)=>me(r,n.codec(),i)})(jt||(jt={}));const JR=["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478","stun:stun.cloudflare.com:3478","stun:stun.services.mozilla.com:3478"],J3=Array.from("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890"),eP="libp2p+webrtc+v1/",tP=466,rP=2*1024*1024,nP=30*1e3,Rd=16*1024;function iP(n=Rd){const e=Ft(n-Ft(n)),t=1+Ft(Object.keys(jt.Flag).length-1),r=1,i=n-e-t-r,s=Ft(i);return e+t+r+s}const sP=iP(),oP=5e3,aP=5e3,cP=3e4,Z8="/webrtc",cf="/webrtc-signaling/0.0.1",lP="/libp2p/webrtc-direct/certificate",uP="webrtc-direct-certificate-private-key",dP=12096e5,em=864e5,tm=tv(),Lp=tm!=null&&tm.name==="firefox",J8=async function*(){},e7=async n=>{};function hP(n,e,t=cP,r){n.readyState==="open"&&Promise.resolve().then(async()=>{if(n.bufferedAmount>0){r.log("%s drain channel with %d buffered bytes",e,n.bufferedAmount);const i=we();let s=!1;n.bufferedAmountLowThreshold=0;const o=()=>{s||(r.log("%s drain channel closed before drain",e),i.resolve())};n.addEventListener("close",o,{once:!0}),n.addEventListener("bufferedamountlow",()=>{s=!0,n.removeEventListener("close",o),i.resolve()}),await Ju(i.promise,{milliseconds:t})}}).then(async()=>{n.readyState==="open"&&n.close()}).catch(i=>{r.log.error("error closing outbound stream",i)})}async function rm(n){return n=n??{},typeof n=="function"&&(n=await n()),n.iceServers=n.iceServers??JR.map(e=>({urls:[e]})),n}const fP=(n=32)=>eP+[...Array(n)].map(()=>J3.at(Math.floor(Math.random()*J3.length))).join("");class lf{log;peerConnection;remoteAddr;timeline;metrics;source=J8();sink=e7;constructor(e,t){this.log=e.logger.forComponent("libp2p:webrtc:maconn"),this.remoteAddr=t.remoteAddr,this.timeline=t.timeline,this.peerConnection=t.peerConnection;const r=this.peerConnection,i=r.connectionState;this.peerConnection.onconnectionstatechange=()=>{this.log.trace("peer connection state change",r.connectionState,"initial state",i),(r.connectionState==="disconnected"||r.connectionState==="failed"||r.connectionState==="closed")&&(this.timeline.close=Date.now())}}async close(e){this.log.trace("closing connection"),this.peerConnection.close(),this.timeline.close=Date.now(),this.metrics?.increment({close:!0})}abort(e){this.log.error("closing connection due to error",e),this.peerConnection.close(),this.timeline.close=Date.now(),this.metrics?.increment({abort:!0})}}class pP extends Tp{channel;incomingData;maxBufferedAmount;bufferedAmountLowEventTimeout;maxMessageSize;receiveFinAck;finAckTimeout;openTimeout;closeController;constructor(e){const t=e.onEnd;switch(e.onEnd=i=>{this.log.trace('readable and writeable ends closed with status "%s"',this.status),Promise.resolve(async()=>{if(!(this.timeline.abort!=null||this.timeline.reset!==null))try{await Ju(this.receiveFinAck.promise,{milliseconds:this.finAckTimeout})}catch(s){this.log.error("error receiving FIN_ACK",s)}}).then(()=>{this.incomingData.end(),t?.(i)}).catch(s=>{this.log.error("error ending stream",s)}).finally(()=>{this.channel.close()})},super(e),this.channel=e.channel,this.channel.binaryType="arraybuffer",this.incomingData=fn(),this.bufferedAmountLowEventTimeout=e.bufferedAmountLowEventTimeout??nP,this.maxBufferedAmount=e.maxBufferedAmount??rP,this.maxMessageSize=(e.maxMessageSize??Rd)-sP,this.receiveFinAck=we(),this.finAckTimeout=e.closeTimeout??oP,this.openTimeout=e.openTimeout??aP,this.closeController=new AbortController,this.channel.readyState){case"open":this.timeline.open=new Date().getTime();break;case"closed":case"closing":(this.timeline.close===void 0||this.timeline.close===0)&&(this.timeline.close=Date.now());break;case"connecting":break;default:throw this.log.error("unknown datachannel state %s",this.channel.readyState),new S1("Unknown datachannel state")}this.channel.onopen=i=>{this.timeline.open=new Date().getTime()},this.channel.onclose=i=>{this.log.trace("received onclose event"),this.closeController.abort(),this.receiveFinAck.resolve(),this.close().catch(s=>{this.log.error("error closing stream after channel closed",s)})},this.channel.onerror=i=>{this.log.trace("received onerror event"),this.closeController.abort();const s=i.error;this.abort(s)},this.channel.onmessage=async i=>{const{data:s}=i;s===null||s.byteLength===0||this.incomingData.push(new Uint8Array(s,0,s.byteLength))};const r=this;Promise.resolve().then(async()=>{for await(const i of Da(this.incomingData)){const s=r.processIncomingProtobuf(i);s!=null&&r.sourcePush(new $e(s))}}).catch(i=>{this.log.error("error processing incoming data channel messages",i)})}sendNewStream(){}async _sendMessage(e,t=!0){if(this.channel.readyState==="closed"||this.channel.readyState==="closing")throw new S1(`Invalid datachannel state - ${this.channel.readyState}`);if(this.channel.readyState!=="open"){const r=AbortSignal.timeout(this.openTimeout),i=Re([this.closeController.signal,r]);try{this.log('channel state is "%s" and not "open", waiting for "open" event before sending data',this.channel.readyState),await Ut(this.channel,"open",i)}finally{i.clear()}this.log('channel state is now "%s", sending data',this.channel.readyState)}if(t&&this.channel.bufferedAmount>this.maxBufferedAmount){const r=AbortSignal.timeout(this.bufferedAmountLowEventTimeout),i=Re([this.closeController.signal,r]);try{this.log('channel buffer is %d, wait for "bufferedamountlow" event',this.channel.bufferedAmount),await Ut(this.channel,"bufferedamountlow",i)}catch(s){throw r.aborted?new nc(`Timed out waiting for DataChannel buffer to clear after ${this.bufferedAmountLowEventTimeout}ms`):s}finally{i.clear()}}try{this.log.trace('sending message, channel state "%s"',this.channel.readyState),this.channel.send(e.subarray())}catch(r){this.log.error("error while sending message",r)}}async sendData(e){const t=e.byteLength;for(e=e.sublist();e.byteLength>0;){const r=Math.min(e.byteLength,this.maxMessageSize),i=e.subarray(0,r),s=jt.encode({message:i}),o=Na.single(s);this.log.trace("sending %d/%d bytes on channel",i.byteLength,t),await this._sendMessage(o),e.consume(r)}this.log.trace('finished sending data, channel state "%s"',this.channel.readyState)}async sendReset(){try{await this._sendFlag(jt.Flag.RESET)}catch(e){this.log.error("failed to send reset - %e",e)}finally{this.channel.close()}}async sendCloseWrite(e){if(this.channel.readyState!=="open"){this.receiveFinAck.resolve();return}if(await this._sendFlag(jt.Flag.FIN)){this.log.trace("awaiting FIN_ACK");try{await ht(this.receiveFinAck.promise,e?.signal,{errorMessage:"sending close-write was aborted before FIN_ACK was received",errorName:"FinAckNotReceivedError"})}catch(r){this.log.error("failed to await FIN_ACK",r)}}else this.log.trace("sending FIN failed, not awaiting FIN_ACK");this.receiveFinAck.resolve()}async sendCloseRead(){this.channel.readyState==="open"&&await this._sendFlag(jt.Flag.STOP_SENDING)}processIncomingProtobuf(e){const t=jt.decode(e);if(t.flag!==void 0&&(this.log.trace('incoming flag %s, write status "%s", read status "%s"',t.flag,this.writeStatus,this.readStatus),t.flag===jt.Flag.FIN&&(this.remoteCloseWrite(),this.log.trace("sending FIN_ACK"),this._sendFlag(jt.Flag.FIN_ACK).catch(r=>{this.log.error("error sending FIN_ACK immediately",r)})),t.flag===jt.Flag.RESET&&this.reset(),t.flag===jt.Flag.STOP_SENDING&&this.remoteCloseRead(),t.flag===jt.Flag.FIN_ACK&&(this.log.trace("received FIN_ACK"),this.receiveFinAck.resolve())),this.readStatus==="ready")return t.message}async _sendFlag(e){if(this.channel.readyState!=="open")return this.log.trace('not sending flag %s because channel is "%s" and not "open"',e.toString(),this.channel.readyState),!1;this.log.trace("sending flag %s",e.toString());const t=jt.encode({flag:e}),r=Na.single(t);try{return await this._sendMessage(r,!1),!0}catch(i){this.log.error("could not send flag %s - %e",e.toString(),i)}return!1}}function ru(n){const{channel:e,direction:t,handshake:r}=n;return new pP({...n,id:`${e.id}`,log:n.log.newScope(`${r===!0?"handshake":t}:${e.id}`)})}class Bp{protocol;peerConnection;bufferedStreams=[];metrics;dataChannelOptions;components;log;constructor(e,t){this.components=e,this.peerConnection=t.peerConnection,this.metrics=t.metrics,this.protocol=t.protocol??Z8,this.dataChannelOptions=t.dataChannelOptions??{},this.log=e.logger.forComponent("libp2p:webrtc:muxerfactory"),this.peerConnection.ondatachannel=({channel:r})=>{if(this.log.trace('incoming early datachannel with channel id %d and label "%s"',r.id),r.label==="init"){this.log.trace("closing early init channel"),r.close();return}const i={},s=ru({channel:r,direction:"inbound",onEnd:o=>{i.onEnd(o)},log:this.log,...this.dataChannelOptions});i.stream=s,i.channel=r,i.onEnd=()=>{this.bufferedStreams=this.bufferedStreams.filter(o=>o.stream.id!==s.id)},this.bufferedStreams.push(i)}}createStreamMuxer(e){return new gP(this.components,{...e,peerConnection:this.peerConnection,dataChannelOptions:this.dataChannelOptions,metrics:this.metrics,streams:this.bufferedStreams,protocol:this.protocol})}}class gP{init;streams;protocol;log;peerConnection;dataChannelOptions;metrics;logger;constructor(e,t){this.init=t,this.log=t.log?.newScope("muxer")??e.logger.forComponent("libp2p:webrtc:muxer"),this.logger=e.logger,this.streams=t.streams.map(r=>r.stream),this.peerConnection=t.peerConnection,this.protocol=t.protocol??Z8,this.metrics=t.metrics,this.dataChannelOptions=t.dataChannelOptions??{},this.peerConnection.ondatachannel=({channel:r})=>{if(this.log.trace("incoming datachannel with channel id %d",r.id),r.label==="init"){this.log.trace("closing init channel"),r.close();return}const i=r.id,s=ru({channel:r,direction:"inbound",onEnd:()=>{this.#e(s,r),this.log("incoming channel %s ended",i)},log:this.log,...this.dataChannelOptions});this.streams.push(s),this.metrics?.increment({incoming_stream:!0}),t?.onIncomingStream?.(s)},this.init.streams.length>0&&queueMicrotask(()=>{this.init.streams.forEach(r=>{r.onEnd=()=>{this.log("incoming early channel %s ended with state %s",r.channel.id,r.channel.readyState),this.#e(r.stream,r.channel)},this.metrics?.increment({incoming_stream:!0}),this.init?.onIncomingStream?.(r.stream)})})}#e(e,t){this.log.trace("stream %s %s %s onEnd",e.direction,e.id,e.protocol),hP(t,`${e.direction} ${e.id} ${e.protocol}`,this.dataChannelOptions.drainTimeout,{log:this.log}),this.streams=this.streams.filter(r=>r.id!==e.id),this.metrics?.increment({stream_end:!0}),this.init?.onStreamEnd?.(e)}async close(e){try{await Promise.all(this.streams.map(async t=>t.close(e)))}catch(t){this.abort(t)}}abort(e){for(const t of this.streams)t.abort(e)}source=J8();sink=e7;newStream(){const e=this.peerConnection.createDataChannel(""),t=e.id;this.log.trace("opened outgoing datachannel with channel id %s",t);const r=ru({channel:e,direction:"outbound",onEnd:()=>{this.#e(r,e),this.log("outgoing channel %s ended",t)},log:this.log,...this.dataChannelOptions});return this.streams.push(r),this.metrics?.increment({outgoing_stream:!0}),r}}const t7=globalThis.RTCPeerConnection,r7=globalThis.RTCSessionDescription,mP=globalThis.RTCIceCandidate;class fc extends Error{constructor(e){super(`WebRTC transport error: ${e}`),this.name="WebRTCTransportError"}}class jn extends fc{constructor(e="SDP handshake failed"){super(e),this.name="SDPHandshakeFailedError"}}class yP extends fc{constructor(e,t){super(`Invalid fingerprint "${e}" within ${t}`),this.name="WebRTC/InvalidFingerprintError"}}class wP extends fc{constructor(e){super(`A method (${e}) was called though it has been intentionally left unimplemented.`),this.name="WebRTC/UnimplementedError"}}class vP extends fc{constructor(e){super(`unsupported hash algorithm code: ${e} please see the codes at https://github.com/multiformats/multicodec/blob/master/table.csv `),this.name="WebRTC/UnsupportedHashAlgorithmError"}}var Dr;(function(n){(function(r){r.SDP_OFFER="SDP_OFFER",r.SDP_ANSWER="SDP_ANSWER",r.ICE_CANDIDATE="ICE_CANDIDATE"})(n.Type||(n.Type={}));let e;(function(r){r[r.SDP_OFFER=0]="SDP_OFFER",r[r.SDP_ANSWER=1]="SDP_ANSWER",r[r.ICE_CANDIDATE=2]="ICE_CANDIDATE"})(e||(e={})),(function(r){r.codec=()=>Jt(e)})(n.Type||(n.Type={}));let t;n.codec=()=>(t==null&&(t=pe((r,i,s={})=>{s.lengthDelimited!==!1&&i.fork(),r.type!=null&&(i.uint32(8),n.Type.codec().encode(r.type,i)),r.data!=null&&(i.uint32(18),i.string(r.data)),s.lengthDelimited!==!1&&i.ldelim()},(r,i,s={})=>{const o={},a=i==null?r.len:r.pos+i;for(;r.pos<a;){const c=r.uint32();switch(c>>>3){case 1:{o.type=n.Type.codec().decode(r);break}case 2:{o.data=r.string();break}default:{r.skipType(c&7);break}}}return o})),t),n.encode=r=>ge(r,n.codec()),n.decode=(r,i)=>me(r,n.codec(),i)})(Dr||(Dr={}));const n7=async(n,e,t)=>{try{const r=we();for(bP(n,r);;){const i=await Promise.race([r.promise,e.read({signal:t.signal}).catch(()=>{})]);if(i==null){t.signal?.throwIfAborted();break}if(i.type!==Dr.Type.ICE_CANDIDATE)throw new qe("ICE candidate message expected");const s=JSON.parse(i.data??"null");if(s===""||s===null){t.onProgress?.(new P("webrtc:end-of-ice-candidates")),t.log.trace("end-of-candidates received");continue}const o=new mP(s);t.log.trace("%s received new ICE candidate %o",t.direction,s);try{t.onProgress?.(new P("webrtc:add-ice-candidate",o.candidate)),await n.addIceCandidate(o)}catch(a){t.log.error("%s bad candidate received",t.direction,s,a)}}}catch(r){if(t.log.error("%s error parsing ICE candidate",t.direction,r),t.signal?.aborted===!0&&Mp(n)!=="connected")throw r}};function Mp(n){return Lp?n.iceConnectionState:n.connectionState}function bP(n,e){n[Lp?"oniceconnectionstatechange":"onconnectionstatechange"]=t=>{switch(Mp(n)){case"connected":e.resolve();break;case"failed":case"disconnected":case"closed":e.reject(new Q0("RTCPeerConnection was closed"));break}}}async function EP({rtcConfiguration:n,dataChannel:e,signal:t,metrics:r,multiaddr:i,connectionManager:s,transportManager:o,log:a,logger:c,onProgress:l}){const{circuitAddress:u,targetPeer:d}=AP(i);r?.dialerEvents.increment({open:!0}),a.trace("dialing circuit address: %a",u);const h=s.getConnections(d);let f;h.length===0?(l?.(new P("webrtc:dial-relay")),f=await o.dial(u,{signal:t,onProgress:l})):(l?.(new P("webrtc:reuse-relay-connection")),f=h[0]),l?.(new P("webrtc:open-signaling-stream"));const m=await f.newStream(cf,{signal:t,runOnLimitedConnection:!0}),y=Nt(m).pb(Dr),w=new t7(n),E=new Bp({logger:c},{peerConnection:w,dataChannelOptions:e});try{const A=w.createDataChannel("init");w.onicecandidate=({candidate:re})=>{const j=JSON.stringify(re?.toJSON()??null);a.trace("initiator sending ICE candidate %o",re),y.write({type:Dr.Type.ICE_CANDIDATE,data:j},{signal:t}).catch(se=>{a.error("error sending ICE candidate",se)})},w.onicecandidateerror=re=>{a.error("initiator ICE candidate error",re)};const T=await w.createOffer().catch(re=>{throw a.error("could not execute createOffer",re),new jn("Failed to set createOffer")});a.trace("initiator send SDP offer %s",T.sdp),l?.(new P("webrtc:send-sdp-offer")),await y.write({type:Dr.Type.SDP_OFFER,data:T.sdp},{signal:t}),await w.setLocalDescription(T).catch(re=>{throw a.error("could not execute setLocalDescription",re),new jn("Failed to set localDescription")}),l?.(new P("webrtc:read-sdp-answer")),a.trace("initiator read SDP answer");const R=await y.read({signal:t});if(R.type!==Dr.Type.SDP_ANSWER)throw new jn("Remote should send an SDP answer");a.trace("initiator received SDP answer %s",R.data);const ie=new r7({type:"answer",sdp:R.data});return await w.setRemoteDescription(ie).catch(re=>{throw a.error("could not execute setRemoteDescription",re),new jn("Failed to set remoteDescription")}),a.trace("initiator read candidates until connected"),l?.(new P("webrtc:read-ice-candidates")),await n7(w,y,{direction:"initiator",signal:t,log:a,onProgress:l}),a.trace("initiator connected, closing init channel"),A.close(),l?.(new P("webrtc:close-signaling-stream")),a.trace("closing signaling channel"),await m.close({signal:t}),a.trace("initiator connected to remote address %s",i),{remoteAddress:i,peerConnection:w,muxerFactory:E}}catch(A){throw a.error("outgoing signaling error",A),w.close(),m.abort(A),A}finally{w.onicecandidate=null,w.onicecandidateerror=null}}const nm=Me(k6.matchers[0],Fe(sc));class Fp extends tt{transportManager;shutdownController;events;constructor(e,t){super(),this.transportManager=e.transportManager,this.events=e.events,this.shutdownController=t.shutdownController,this.onTransportListening=this.onTransportListening.bind(this)}async listen(){this.events.addEventListener("transport:listening",this.onTransportListening)}onTransportListening(e){e.detail.getAddrs().filter(r=>nm.exactMatch(r)).map(r=>r.encapsulate("/webrtc")).length>0&&this.safeDispatchEvent("listening")}getAddrs(){return this.transportManager.getListeners().filter(e=>!(e instanceof Fp)).map(e=>e.getAddrs().filter(t=>nm.exactMatch(t)).map(t=>t.encapsulate("/webrtc"))).flat()}updateAnnounceAddrs(){}async close(){this.events.removeEventListener("transport:listening",this.onTransportListening),this.shutdownController.abort(),queueMicrotask(()=>{this.safeDispatchEvent("close")})}}async function SP({peerConnection:n,stream:e,signal:t,connection:r,log:i}){i.trace("new inbound signaling stream");const s=Nt(e).pb(Dr);try{n.onicecandidate=({candidate:u})=>{const d=JSON.stringify(u?.toJSON()??null);i.trace("recipient sending ICE candidate %s",d),s.write({type:Dr.Type.ICE_CANDIDATE,data:d},{signal:t}).catch(h=>{i.error("error sending ICE candidate",h)})},i.trace("recipient read SDP offer");const a=await s.read({signal:t});if(a.type!==Dr.Type.SDP_OFFER)throw new jn(`expected message type SDP_OFFER, received: ${a.type??"undefined"} `);i.trace("recipient received SDP offer %s",a.data);const c=new r7({type:"offer",sdp:a.data});await n.setRemoteDescription(c).catch(u=>{throw i.error("could not execute setRemoteDescription",u),new jn("Failed to set remoteDescription")});const l=await n.createAnswer().catch(u=>{throw i.error("could not execute createAnswer",u),new jn("Failed to create answer")});i.trace("recipient send SDP answer %s",l.sdp),await s.write({type:Dr.Type.SDP_ANSWER,data:l.sdp},{signal:t}),await n.setLocalDescription(l).catch(u=>{throw i.error("could not execute setLocalDescription",u),new jn("Failed to set localDescription")}),i.trace("recipient read candidates until connected"),await n7(n,s,{direction:"recipient",signal:t,log:i})}catch(a){if(Mp(n)!=="connected")throw i.error("error while handling signaling stream from peer %a",r.remoteAddr,a),n.close(),a;i("error while handling signaling stream from peer %a, ignoring as the RTCPeerConnection is already connected",r.remoteAddr,a)}const o=ue(`/webrtc/p2p/${r.remoteAddr.getPeerId()}`);return i.trace("recipient connected to remote address %s",o),{remoteAddress:o}}class xP{components;init;log;_started=!1;metrics;shutdownController;constructor(e,t={}){this.components=e,this.init=t,this.log=e.logger.forComponent("libp2p:webrtc"),this.shutdownController=new AbortController,this.shutdownController.signal,e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webrtc_dialer_events_total",{label:"event",help:"Total count of WebRTC dialer events by type"}),listenerEvents:e.metrics.registerCounterGroup("libp2p_webrtc_listener_events_total",{label:"event",help:"Total count of WebRTC listener events by type"})})}[Yu]=!0;[Symbol.toStringTag]="@libp2p/webrtc";[St]=["@libp2p/transport"];[Mi]=["@libp2p/identify","@libp2p/circuit-relay-v2-transport"];isStarted(){return this._started}async start(){await this.components.registrar.handle(cf,e=>{const t=this.components.upgrader.createInboundAbortSignal(this.shutdownController.signal);this._onProtocol(e,t).catch(r=>{this.log.error("failed to handle incoming connect from %p",e.connection.remotePeer,r)}).finally(()=>{t.clear()})},{runOnLimitedConnection:!0}),this._started=!0}async stop(){await this.components.registrar.unhandle(cf),this._started=!1}createListener(e){return new Fp(this.components,{shutdownController:this.shutdownController})}listenFilter(e){return e.filter(P1.exactMatch)}dialFilter(e){return this.listenFilter(e)}async dial(e,t){this.log.trace("dialing address: %a",e);const{remoteAddress:r,peerConnection:i,muxerFactory:s}=await EP({rtcConfiguration:await rm(this.init.rtcConfiguration),dataChannel:this.init.dataChannel,multiaddr:e,dataChannelOptions:this.init.dataChannel,signal:t.signal,connectionManager:this.components.connectionManager,transportManager:this.components.transportManager,log:this.log,logger:this.components.logger,onProgress:t.onProgress}),o=new lf(this.components,{peerConnection:i,timeline:{open:Date.now()},remoteAddr:r,metrics:this.metrics?.dialerEvents}),a=await t.upgrader.upgradeOutbound(o,{skipProtection:!0,skipEncryption:!0,muxerFactory:s,onProgress:t.onProgress,signal:t.signal});return this._closeOnShutdown(i,o),a}async _onProtocol({connection:e,stream:t},r){const i=new t7(await rm(this.init.rtcConfiguration)),s=new Bp(this.components,{peerConnection:i,dataChannelOptions:this.init.dataChannel});try{const{remoteAddress:o}=await SP({peerConnection:i,connection:e,stream:t,signal:r,log:this.log});await t.close({signal:r});const a=new lf(this.components,{peerConnection:i,timeline:{open:new Date().getTime()},remoteAddr:o,metrics:this.metrics?.listenerEvents});await this.components.upgrader.upgradeInbound(a,{skipEncryption:!0,skipProtection:!0,muxerFactory:s,signal:r}),this._closeOnShutdown(i,a)}catch(o){throw this.log.error("incoming signaling error",o),i.close(),t.abort(o),o}}_closeOnShutdown(e,t){const r=()=>{t.close().catch(i=>{this.log.error("could not close WebRTCMultiaddrConnection",i)})};this.shutdownController.signal.addEventListener("abort",r),e.addEventListener("close",()=>{this.shutdownController.signal.removeEventListener("abort",r)})}}function AP(n){const e=n.getComponents().filter(({name:r})=>r==="p2p").map(({value:r})=>r).pop();if(e==null)throw new $("Destination peer id was missing");return{circuitAddress:ue(n.getComponents().filter(({name:r})=>r!=="webrtc")),targetPeer:Ot(e)}}var im={};/*! *****************************************************************************
Copyright (C) Microsoft. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */var sm;function kP(){if(sm)return im;sm=1;var n;return(function(e){(function(t){var r=typeof globalThis=="object"?globalThis:typeof G2=="object"?G2:typeof self=="object"?self:typeof this=="object"?this:c(),i=s(e);typeof r.Reflect<"u"&&(i=s(r.Reflect,i)),t(i,r),typeof r.Reflect>"u"&&(r.Reflect=e);function s(l,u){return function(d,h){Object.defineProperty(l,d,{configurable:!0,writable:!0,value:h}),u&&u(d,h)}}function o(){try{return Function("return this;")()}catch{}}function a(){try{return(0,eval)("(function() { return this; })()")}catch{}}function c(){return o()||a()}})(function(t,r){var i=Object.prototype.hasOwnProperty,s=typeof Symbol=="function",o=s&&typeof Symbol.toPrimitive<"u"?Symbol.toPrimitive:"@@toPrimitive",a=s&&typeof Symbol.iterator<"u"?Symbol.iterator:"@@iterator",c=typeof Object.create=="function",l={__proto__:[]}instanceof Array,u=!c&&!l,d={create:c?function(){return dh(Object.create(null))}:l?function(){return dh({__proto__:null})}:function(){return dh({})},has:u?function(b,S){return i.call(b,S)}:function(b,S){return S in b},get:u?function(b,S){return i.call(b,S)?b[S]:void 0}:function(b,S){return b[S]}},h=Object.getPrototypeOf(Function),f=typeof Map=="function"&&typeof Map.prototype.entries=="function"?Map:iw(),m=typeof Set=="function"&&typeof Set.prototype.entries=="function"?Set:sw(),y=typeof WeakMap=="function"?WeakMap:ow(),w=s?Symbol.for("@reflect-metadata:registry"):void 0,E=tw(),A=rw(E);function T(b,S,x,B){if(K(x)){if(!xo(b))throw new TypeError;if(!D2(S))throw new TypeError;return U(b,S)}else{if(!xo(b))throw new TypeError;if(!Se(S))throw new TypeError;if(!Se(B)&&!K(B)&&!lt(B))throw new TypeError;return lt(B)&&(B=void 0),x=ar(x),X(b,S,x,B)}}t("decorate",T);function R(b,S){function x(B,oe){if(!Se(B))throw new TypeError;if(!K(oe)&&!J9(oe))throw new TypeError;N(b,S,B,oe)}return x}t("metadata",R);function ie(b,S,x,B){if(!Se(x))throw new TypeError;return K(B)||(B=ar(B)),N(b,S,x,B)}t("defineMetadata",ie);function re(b,S,x){if(!Se(S))throw new TypeError;return K(x)||(x=ar(x)),te(b,S,x)}t("hasMetadata",re);function j(b,S,x){if(!Se(S))throw new TypeError;return K(x)||(x=ar(x)),G(b,S,x)}t("hasOwnMetadata",j);function se(b,S,x){if(!Se(S))throw new TypeError;return K(x)||(x=ar(x)),Z(b,S,x)}t("getMetadata",se);function _(b,S,x){if(!Se(S))throw new TypeError;return K(x)||(x=ar(x)),ce(b,S,x)}t("getOwnMetadata",_);function M(b,S){if(!Se(b))throw new TypeError;return K(S)||(S=ar(S)),fe(b,S)}t("getMetadataKeys",M);function O(b,S){if(!Se(b))throw new TypeError;return K(S)||(S=ar(S)),Ce(b,S)}t("getOwnMetadataKeys",O);function F(b,S,x){if(!Se(S))throw new TypeError;if(K(x)||(x=ar(x)),!Se(S))throw new TypeError;K(x)||(x=ar(x));var B=Ao(S,x,!1);return K(B)?!1:B.OrdinaryDeleteMetadata(b,S,x)}t("deleteMetadata",F);function U(b,S){for(var x=b.length-1;x>=0;--x){var B=b[x],oe=B(S);if(!K(oe)&&!lt(oe)){if(!D2(oe))throw new TypeError;S=oe}}return S}function X(b,S,x,B){for(var oe=b.length-1;oe>=0;--oe){var Ze=b[oe],st=Ze(S,x,B);if(!K(st)&&!lt(st)){if(!Se(st))throw new TypeError;B=st}}return B}function te(b,S,x){var B=G(b,S,x);if(B)return!0;var oe=uh(S);return lt(oe)?!1:te(b,oe,x)}function G(b,S,x){var B=Ao(S,x,!1);return K(B)?!1:Lt(B.OrdinaryHasOwnMetadata(b,S,x))}function Z(b,S,x){var B=G(b,S,x);if(B)return ce(b,S,x);var oe=uh(S);if(!lt(oe))return Z(b,oe,x)}function ce(b,S,x){var B=Ao(S,x,!1);if(!K(B))return B.OrdinaryGetOwnMetadata(b,S,x)}function N(b,S,x,B){var oe=Ao(x,B,!0);oe.OrdinaryDefineOwnMetadata(b,S,x,B)}function fe(b,S){var x=Ce(b,S),B=uh(b);if(B===null)return x;var oe=fe(B,S);if(oe.length<=0)return x;if(x.length<=0)return oe;for(var Ze=new m,st=[],ye=0,V=x;ye<V.length;ye++){var W=V[ye],Y=Ze.has(W);Y||(Ze.add(W),st.push(W))}for(var J=0,ve=oe;J<ve.length;J++){var W=ve[J],Y=Ze.has(W);Y||(Ze.add(W),st.push(W))}return st}function Ce(b,S){var x=Ao(b,S,!1);return x?x.OrdinaryOwnMetadataKeys(b,S):[]}function Ee(b){if(b===null)return 1;switch(typeof b){case"undefined":return 0;case"boolean":return 2;case"string":return 3;case"symbol":return 4;case"number":return 5;case"object":return b===null?1:6;default:return 6}}function K(b){return b===void 0}function lt(b){return b===null}function It(b){return typeof b=="symbol"}function Se(b){return typeof b=="object"?b!==null:typeof b=="function"}function Dt(b,S){switch(Ee(b)){case 0:return b;case 1:return b;case 2:return b;case 3:return b;case 4:return b;case 5:return b}var x="string",B=L2(b,o);if(B!==void 0){var oe=B.call(b,x);if(Se(oe))throw new TypeError;return oe}return Wt(b)}function Wt(b,S){var x,B,oe;{var Ze=b.toString;if(mi(Ze)){var B=Ze.call(b);if(!Se(B))return B}var x=b.valueOf;if(mi(x)){var B=x.call(b);if(!Se(B))return B}}throw new TypeError}function Lt(b){return!!b}function ch(b){return""+b}function ar(b){var S=Dt(b);return It(S)?S:ch(S)}function xo(b){return Array.isArray?Array.isArray(b):b instanceof Object?b instanceof Array:Object.prototype.toString.call(b)==="[object Array]"}function mi(b){return typeof b=="function"}function D2(b){return typeof b=="function"}function J9(b){switch(Ee(b)){case 3:return!0;case 4:return!0;default:return!1}}function lh(b,S){return b===S||b!==b&&S!==S}function L2(b,S){var x=b[S];if(x!=null){if(!mi(x))throw new TypeError;return x}}function B2(b){var S=L2(b,a);if(!mi(S))throw new TypeError;var x=S.call(b);if(!Se(x))throw new TypeError;return x}function M2(b){return b.value}function F2(b){var S=b.next();return S.done?!1:S}function U2(b){var S=b.return;S&&S.call(b)}function uh(b){var S=Object.getPrototypeOf(b);if(typeof b!="function"||b===h||S!==h)return S;var x=b.prototype,B=x&&Object.getPrototypeOf(x);if(B==null||B===Object.prototype)return S;var oe=B.constructor;return typeof oe!="function"||oe===b?S:oe}function ew(){var b;!K(w)&&typeof r.Reflect<"u"&&!(w in r.Reflect)&&typeof r.Reflect.defineMetadata=="function"&&(b=nw(r.Reflect));var S,x,B,oe=new y,Ze={registerProvider:st,getProvider:V,setProvider:Y};return Ze;function st(J){if(!Object.isExtensible(Ze))throw new Error("Cannot add provider to a frozen registry.");switch(!0){case b===J:break;case K(S):S=J;break;case S===J:break;case K(x):x=J;break;case x===J:break;default:B===void 0&&(B=new m),B.add(J);break}}function ye(J,ve){if(!K(S)){if(S.isProviderFor(J,ve))return S;if(!K(x)){if(x.isProviderFor(J,ve))return S;if(!K(B))for(var Ve=B2(B);;){var Je=F2(Ve);if(!Je)return;var Ir=M2(Je);if(Ir.isProviderFor(J,ve))return U2(Ve),Ir}}}if(!K(b)&&b.isProviderFor(J,ve))return b}function V(J,ve){var Ve=oe.get(J),Je;return K(Ve)||(Je=Ve.get(ve)),K(Je)&&(Je=ye(J,ve),K(Je)||(K(Ve)&&(Ve=new f,oe.set(J,Ve)),Ve.set(ve,Je))),Je}function W(J){if(K(J))throw new TypeError;return S===J||x===J||!K(B)&&B.has(J)}function Y(J,ve,Ve){if(!W(Ve))throw new Error("Metadata provider not registered.");var Je=V(J,ve);if(Je!==Ve){if(!K(Je))return!1;var Ir=oe.get(J);K(Ir)&&(Ir=new f,oe.set(J,Ir)),Ir.set(ve,Ve)}return!0}}function tw(){var b;return!K(w)&&Se(r.Reflect)&&Object.isExtensible(r.Reflect)&&(b=r.Reflect[w]),K(b)&&(b=ew()),!K(w)&&Se(r.Reflect)&&Object.isExtensible(r.Reflect)&&Object.defineProperty(r.Reflect,w,{enumerable:!1,configurable:!1,writable:!1,value:b}),b}function rw(b){var S=new y,x={isProviderFor:function(W,Y){var J=S.get(W);return K(J)?!1:J.has(Y)},OrdinaryDefineOwnMetadata:st,OrdinaryHasOwnMetadata:oe,OrdinaryGetOwnMetadata:Ze,OrdinaryOwnMetadataKeys:ye,OrdinaryDeleteMetadata:V};return E.registerProvider(x),x;function B(W,Y,J){var ve=S.get(W),Ve=!1;if(K(ve)){if(!J)return;ve=new f,S.set(W,ve),Ve=!0}var Je=ve.get(Y);if(K(Je)){if(!J)return;if(Je=new f,ve.set(Y,Je),!b.setProvider(W,Y,x))throw ve.delete(Y),Ve&&S.delete(W),new Error("Wrong provider for target.")}return Je}function oe(W,Y,J){var ve=B(Y,J,!1);return K(ve)?!1:Lt(ve.has(W))}function Ze(W,Y,J){var ve=B(Y,J,!1);if(!K(ve))return ve.get(W)}function st(W,Y,J,ve){var Ve=B(J,ve,!0);Ve.set(W,Y)}function ye(W,Y){var J=[],ve=B(W,Y,!1);if(K(ve))return J;for(var Ve=ve.keys(),Je=B2(Ve),Ir=0;;){var $2=F2(Je);if(!$2)return J.length=Ir,J;var aw=M2($2);try{J[Ir]=aw}catch(cw){try{U2(Je)}finally{throw cw}}Ir++}}function V(W,Y,J){var ve=B(Y,J,!1);if(K(ve)||!ve.delete(W))return!1;if(ve.size===0){var Ve=S.get(Y);K(Ve)||(Ve.delete(J),Ve.size===0&&S.delete(Ve))}return!0}}function nw(b){var S=b.defineMetadata,x=b.hasOwnMetadata,B=b.getOwnMetadata,oe=b.getOwnMetadataKeys,Ze=b.deleteMetadata,st=new y,ye={isProviderFor:function(V,W){var Y=st.get(V);return!K(Y)&&Y.has(W)?!0:oe(V,W).length?(K(Y)&&(Y=new m,st.set(V,Y)),Y.add(W),!0):!1},OrdinaryDefineOwnMetadata:S,OrdinaryHasOwnMetadata:x,OrdinaryGetOwnMetadata:B,OrdinaryOwnMetadataKeys:oe,OrdinaryDeleteMetadata:Ze};return ye}function Ao(b,S,x){var B=E.getProvider(b,S);if(!K(B))return B;if(x){if(E.setProvider(b,S,A))return A;throw new Error("Illegal state.")}}function iw(){var b={},S=[],x=(function(){function ye(V,W,Y){this._index=0,this._keys=V,this._values=W,this._selector=Y}return ye.prototype["@@iterator"]=function(){return this},ye.prototype[a]=function(){return this},ye.prototype.next=function(){var V=this._index;if(V>=0&&V<this._keys.length){var W=this._selector(this._keys[V],this._values[V]);return V+1>=this._keys.length?(this._index=-1,this._keys=S,this._values=S):this._index++,{value:W,done:!1}}return{value:void 0,done:!0}},ye.prototype.throw=function(V){throw this._index>=0&&(this._index=-1,this._keys=S,this._values=S),V},ye.prototype.return=function(V){return this._index>=0&&(this._index=-1,this._keys=S,this._values=S),{value:V,done:!0}},ye})(),B=(function(){function ye(){this._keys=[],this._values=[],this._cacheKey=b,this._cacheIndex=-2}return Object.defineProperty(ye.prototype,"size",{get:function(){return this._keys.length},enumerable:!0,configurable:!0}),ye.prototype.has=function(V){return this._find(V,!1)>=0},ye.prototype.get=function(V){var W=this._find(V,!1);return W>=0?this._values[W]:void 0},ye.prototype.set=function(V,W){var Y=this._find(V,!0);return this._values[Y]=W,this},ye.prototype.delete=function(V){var W=this._find(V,!1);if(W>=0){for(var Y=this._keys.length,J=W+1;J<Y;J++)this._keys[J-1]=this._keys[J],this._values[J-1]=this._values[J];return this._keys.length--,this._values.length--,lh(V,this._cacheKey)&&(this._cacheKey=b,this._cacheIndex=-2),!0}return!1},ye.prototype.clear=function(){this._keys.length=0,this._values.length=0,this._cacheKey=b,this._cacheIndex=-2},ye.prototype.keys=function(){return new x(this._keys,this._values,oe)},ye.prototype.values=function(){return new x(this._keys,this._values,Ze)},ye.prototype.entries=function(){return new x(this._keys,this._values,st)},ye.prototype["@@iterator"]=function(){return this.entries()},ye.prototype[a]=function(){return this.entries()},ye.prototype._find=function(V,W){if(!lh(this._cacheKey,V)){this._cacheIndex=-1;for(var Y=0;Y<this._keys.length;Y++)if(lh(this._keys[Y],V)){this._cacheIndex=Y;break}}return this._cacheIndex<0&&W&&(this._cacheIndex=this._keys.length,this._keys.push(V),this._values.push(void 0)),this._cacheIndex},ye})();return B;function oe(ye,V){return ye}function Ze(ye,V){return V}function st(ye,V){return[ye,V]}}function sw(){var b=(function(){function S(){this._map=new f}return Object.defineProperty(S.prototype,"size",{get:function(){return this._map.size},enumerable:!0,configurable:!0}),S.prototype.has=function(x){return this._map.has(x)},S.prototype.add=function(x){return this._map.set(x,x),this},S.prototype.delete=function(x){return this._map.delete(x)},S.prototype.clear=function(){this._map.clear()},S.prototype.keys=function(){return this._map.keys()},S.prototype.values=function(){return this._map.keys()},S.prototype.entries=function(){return this._map.entries()},S.prototype["@@iterator"]=function(){return this.keys()},S.prototype[a]=function(){return this.keys()},S})();return b}function ow(){var b=16,S=d.create(),x=B();return(function(){function V(){this._key=B()}return V.prototype.has=function(W){var Y=oe(W,!1);return Y!==void 0?d.has(Y,this._key):!1},V.prototype.get=function(W){var Y=oe(W,!1);return Y!==void 0?d.get(Y,this._key):void 0},V.prototype.set=function(W,Y){var J=oe(W,!0);return J[this._key]=Y,this},V.prototype.delete=function(W){var Y=oe(W,!1);return Y!==void 0?delete Y[this._key]:!1},V.prototype.clear=function(){this._key=B()},V})();function B(){var V;do V="@@WeakMap@@"+ye();while(d.has(S,V));return S[V]=!0,V}function oe(V,W){if(!i.call(V,x)){if(!W)return;Object.defineProperty(V,x,{value:d.create()})}return V[x]}function Ze(V,W){for(var Y=0;Y<W;++Y)V[Y]=Math.random()*255|0;return V}function st(V){if(typeof Uint8Array=="function"){var W=new Uint8Array(V);return typeof crypto<"u"?crypto.getRandomValues(W):typeof msCrypto<"u"?msCrypto.getRandomValues(W):Ze(W,V),W}return Ze(new Array(V),V)}function ye(){var V=st(b);V[6]=V[6]&79|64,V[8]=V[8]&191|128;for(var W="",Y=0;Y<b;++Y){var J=V[Y];(Y===4||Y===6||Y===8)&&(W+="-"),J<16&&(W+="0"),W+=J.toString(16).toLowerCase()}return W}}function dh(b){return b.__=void 0,delete b.__,b}})})(n||(n={})),im}kP();var k;(function(n){n[n.Sequence=0]="Sequence",n[n.Set=1]="Set",n[n.Choice=2]="Choice"})(k||(k={}));var v;(function(n){n[n.Any=1]="Any",n[n.Boolean=2]="Boolean",n[n.OctetString=3]="OctetString",n[n.BitString=4]="BitString",n[n.Integer=5]="Integer",n[n.Enumerated=6]="Enumerated",n[n.ObjectIdentifier=7]="ObjectIdentifier",n[n.Utf8String=8]="Utf8String",n[n.BmpString=9]="BmpString",n[n.UniversalString=10]="UniversalString",n[n.NumericString=11]="NumericString",n[n.PrintableString=12]="PrintableString",n[n.TeletexString=13]="TeletexString",n[n.VideotexString=14]="VideotexString",n[n.IA5String=15]="IA5String",n[n.GraphicString=16]="GraphicString",n[n.VisibleString=17]="VisibleString",n[n.GeneralString=18]="GeneralString",n[n.CharacterString=19]="CharacterString",n[n.UTCTime=20]="UTCTime",n[n.GeneralizedTime=21]="GeneralizedTime",n[n.DATE=22]="DATE",n[n.TimeOfDay=23]="TimeOfDay",n[n.DateTime=24]="DateTime",n[n.Duration=25]="Duration",n[n.TIME=26]="TIME",n[n.Null=27]="Null"})(v||(v={}));class Pd{constructor(e,t=0){if(this.unusedBits=0,this.value=new ArrayBuffer(0),e)if(typeof e=="number")this.fromNumber(e);else if(L.isBufferSource(e))this.unusedBits=t,this.value=L.toArrayBuffer(e);else throw TypeError("Unsupported type of 'params' argument for BitString")}fromASN(e){if(!(e instanceof Ni))throw new TypeError("Argument 'asn' is not instance of ASN.1 BitString");return this.unusedBits=e.valueBlock.unusedBits,this.value=e.valueBlock.valueHex,this}toASN(){return new Ni({unusedBits:this.unusedBits,valueHex:this.value})}toSchema(e){return new Ni({name:e})}toNumber(){let e="";const t=new Uint8Array(this.value);for(const r of t)e+=r.toString(2).padStart(8,"0");return e=e.split("").reverse().join(""),this.unusedBits&&(e=e.slice(this.unusedBits).padStart(this.unusedBits,"0")),parseInt(e,2)}fromNumber(e){let t=e.toString(2);const r=t.length+7>>3;this.unusedBits=(r<<3)-t.length;const i=new Uint8Array(r);t=t.padStart(r<<3,"0").split("").reverse().join("");let s=0;for(;s<r;)i[s]=parseInt(t.slice(s<<3,(s<<3)+8),2),s++;this.value=i.buffer}}class be{get byteLength(){return this.buffer.byteLength}get byteOffset(){return 0}constructor(e){typeof e=="number"?this.buffer=new ArrayBuffer(e):L.isBufferSource(e)?this.buffer=L.toArrayBuffer(e):Array.isArray(e)?this.buffer=new Uint8Array(e):this.buffer=new ArrayBuffer(0)}fromASN(e){if(!(e instanceof $t))throw new TypeError("Argument 'asn' is not instance of ASN.1 OctetString");return this.buffer=e.valueBlock.valueHex,this}toASN(){return new $t({valueHex:this.buffer})}toSchema(e){return new $t({name:e})}}const _P={fromASN:n=>n instanceof zr?null:n.valueBeforeDecodeView,toASN:n=>{if(n===null)return new zr;const e=xr(n);if(e.result.error)throw new Error(e.result.error);return e.result}},IP={fromASN:n=>n.valueBlock.valueHexView.byteLength>=4?n.valueBlock.toString():n.valueBlock.valueDec,toASN:n=>new Ar({value:+n})},CP={fromASN:n=>n.valueBlock.valueDec,toASN:n=>new hd({value:n})},ze={fromASN:n=>n.valueBlock.valueHexView,toASN:n=>new Ar({valueHex:n})},TP={fromASN:n=>n.valueBlock.valueHexView,toASN:n=>new Ni({valueHex:n})},RP={fromASN:n=>n.valueBlock.toString(),toASN:n=>new Zt({value:n})},PP={fromASN:n=>n.valueBlock.value,toASN:n=>new dd({value:n})},nu={fromASN:n=>n.valueBlock.valueHexView,toASN:n=>new $t({valueHex:n})},OP={fromASN:n=>new be(n.getValue()),toASN:n=>n.toASN()};function _r(n){return{fromASN:e=>e.valueBlock.value,toASN:e=>new n({value:e})}}const i7=_r(Nn),NP=_r(fd),DP=_r(pd),LP=_r(gd),BP=_r(md),MP=_r(yd),FP=_r(wd),UP=_r(vd),$P=_r(bd),VP=_r(uc),qP=_r(Ed),HP=_r(Sd),zP={fromASN:n=>n.toDate(),toASN:n=>new dc({valueDate:n})},KP={fromASN:n=>n.toDate(),toASN:n=>new xd({valueDate:n})},WP={fromASN:()=>null,toASN:()=>new zr};function ma(n){switch(n){case v.Any:return _P;case v.BitString:return TP;case v.BmpString:return NP;case v.Boolean:return PP;case v.CharacterString:return HP;case v.Enumerated:return CP;case v.GeneralString:return qP;case v.GeneralizedTime:return KP;case v.GraphicString:return $P;case v.IA5String:return UP;case v.Integer:return IP;case v.Null:return WP;case v.NumericString:return LP;case v.ObjectIdentifier:return RP;case v.OctetString:return nu;case v.PrintableString:return BP;case v.TeletexString:return MP;case v.UTCTime:return zP;case v.UniversalString:return DP;case v.Utf8String:return i7;case v.VideotexString:return FP;case v.VisibleString:return VP;default:return null}}function En(n){return typeof n=="function"&&n.prototype?n.prototype.toASN&&n.prototype.fromASN?!0:En(n.prototype):!!(n&&typeof n=="object"&&"toASN"in n&&"fromASN"in n)}function s7(n){var e;if(n){const t=Object.getPrototypeOf(n);return((e=t?.prototype)===null||e===void 0?void 0:e.constructor)===Array?!0:s7(t)}return!1}function GP(n,e){if(!(n&&e)||n.byteLength!==e.byteLength)return!1;const t=new Uint8Array(n),r=new Uint8Array(e);for(let i=0;i<n.byteLength;i++)if(t[i]!==r[i])return!1;return!0}class jP{constructor(){this.items=new WeakMap}has(e){return this.items.has(e)}get(e,t=!1){const r=this.items.get(e);if(!r)throw new Error(`Cannot get schema for '${e.prototype.constructor.name}' target`);if(t&&!r.schema)throw new Error(`Schema '${e.prototype.constructor.name}' doesn't contain ASN.1 schema. Call 'AsnSchemaStorage.cache'.`);return r}cache(e){const t=this.get(e);t.schema||(t.schema=this.create(e,!0))}createDefault(e){const t={type:k.Sequence,items:{}},r=this.findParentSchema(e);return r&&(Object.assign(t,r),t.items=Object.assign({},t.items,r.items)),t}create(e,t){const r=this.items.get(e)||this.createDefault(e),i=[];for(const s in r.items){const o=r.items[s],a=t?s:"";let c;if(typeof o.type=="number"){const u=v[o.type],d=h8[u];if(!d)throw new Error(`Cannot get ASN1 class by name '${u}'`);c=new d({name:a})}else En(o.type)?c=new o.type().toSchema(a):o.optional?this.get(o.type).type===k.Choice?c=new Vi({name:a}):(c=this.create(o.type,!1),c.name=a):c=new Vi({name:a});const l=!!o.optional||o.defaultValue!==void 0;if(o.repeated){c.name="";const u=o.repeated==="set"?on:De;c=new u({name:"",value:[new Hl({name:a,value:c})]})}if(o.context!==null&&o.context!==void 0)if(o.implicit)if(typeof o.type=="number"||En(o.type)){const u=o.repeated?Vt:lc;i.push(new u({name:a,optional:l,idBlock:{tagClass:3,tagNumber:o.context}}))}else{this.cache(o.type);const u=!!o.repeated;let d=u?c:this.get(o.type,!0).schema;d="valueBlock"in d?d.valueBlock.value:d.value,i.push(new Vt({name:u?"":a,optional:l,idBlock:{tagClass:3,tagNumber:o.context},value:d}))}else i.push(new Vt({optional:l,idBlock:{tagClass:3,tagNumber:o.context},value:[c]}));else c.optional=l,i.push(c)}switch(r.type){case k.Sequence:return new De({value:i,name:""});case k.Set:return new on({value:i,name:""});case k.Choice:return new _p({value:i,name:""});default:throw new Error("Unsupported ASN1 type in use")}}set(e,t){return this.items.set(e,t),this}findParentSchema(e){const t=Object.getPrototypeOf(e);return t?this.items.get(t)||this.findParentSchema(t):null}}const at=new jP,I=n=>e=>{let t;at.has(e)?t=at.get(e):(t=at.createDefault(e),at.set(e,t)),Object.assign(t,n)},g=n=>(e,t)=>{let r;at.has(e.constructor)?r=at.get(e.constructor):(r=at.createDefault(e.constructor),at.set(e.constructor,r));const i=Object.assign({},n);if(typeof i.type=="number"&&!i.converter){const s=ma(n.type);if(!s)throw new Error(`Cannot get default converter for property '${t}' of ${e.constructor.name}`);i.converter=s}i.raw=n.raw,r.items[t]=i};class Oo extends Error{constructor(){super(...arguments),this.schemas=[]}}class QP{static parse(e,t){const r=xr(e);if(r.result.error)throw new Error(r.result.error);return this.fromASN(r.result,t)}static fromASN(e,t){try{if(En(t))return new t().fromASN(e);const r=at.get(t);at.cache(t);let i=r.schema;const s=this.handleChoiceTypes(e,r,t,i);if(s?.result)return s.result;s?.targetSchema&&(i=s.targetSchema);const o=this.handleSequenceTypes(e,r,t,i);if(o&&"isManualMapping"in o)return o.result;const a=o,c=new t;return s7(t)?this.handleArrayTypes(e,r,t):(this.processSchemaItems(r,a,c),c)}catch(r){throw r instanceof Oo&&r.schemas.push(t.name),r}}static handleChoiceTypes(e,t,r,i){if(e.constructor===Vt&&t.type===k.Choice&&e.idBlock.tagClass===3)for(const s in t.items){const o=t.items[s];if(o.context===e.idBlock.tagNumber&&o.implicit&&typeof o.type=="function"&&at.has(o.type)){const a=at.get(o.type);if(a&&a.type===k.Sequence){const c=new De;if("value"in e.valueBlock&&Array.isArray(e.valueBlock.value)&&"value"in c.valueBlock){c.valueBlock.value=e.valueBlock.value;const l=this.fromASN(c,o.type),u=new r;return u[s]=l,{result:u}}}}}else if(e.constructor===Vt&&t.type!==k.Choice){const s=new Vt({idBlock:{tagClass:3,tagNumber:e.idBlock.tagNumber},value:t.schema.valueBlock.value});for(const o in t.items)delete e[o];return{targetSchema:s}}return null}static handleSequenceTypes(e,t,r,i){if(t.type===k.Sequence){if(Object.keys(t.items).filter(a=>{const c=t.items[a];return c.optional&&typeof c.type=="function"&&at.has(c.type)&&at.get(c.type).type===k.Choice}).length>0&&"value"in e.valueBlock&&Array.isArray(e.valueBlock.value)&&r.name==="CertReqMsg")return this.handleManualMapping(e,t,r);const o=Wn({},e,i);if(!o.verified)throw new Oo(`Data does not match to ${r.name} ASN1 schema.${o.result.error?` ${o.result.error}`:""}`);return o}else{const s=Wn({},e,i);if(!s.verified)throw new Oo(`Data does not match to ${r.name} ASN1 schema.${s.result.error?` ${s.result.error}`:""}`);return s}}static handleManualMapping(e,t,r){const i=new r,s=e.valueBlock.value,o=Object.keys(t.items);let a=0;for(let c=0;c<o.length;c++){const l=o[c],u=t.items[l];if(a>=s.length)break;if(u.repeated){i[l]=this.processRepeatedField(s,a,u);break}else if(typeof u.type=="number")i[l]=this.processPrimitiveField(s[a],u),a++;else if(this.isOptionalChoiceField(u)){const d=this.processOptionalChoiceField(s[a],u);d.processed&&(i[l]=d.value,a++)}else i[l]=this.fromASN(s[a],u.type),a++}return{result:i,verified:!0,isManualMapping:!0}}static processRepeatedField(e,t,r){let i=e.slice(t);if(i.length===1&&i[0].constructor.name==="Sequence"){const s=i[0];s.valueBlock&&s.valueBlock.value&&Array.isArray(s.valueBlock.value)&&(i=s.valueBlock.value)}if(typeof r.type=="number"){const s=ma(r.type);if(!s)throw new Error(`No converter for ASN.1 type ${r.type}`);return i.filter(o=>o&&o.valueBlock).map(o=>{try{return s.fromASN(o)}catch{return}}).filter(o=>o!==void 0)}else return i.filter(s=>s&&s.valueBlock).map(s=>{try{return this.fromASN(s,r.type)}catch{return}}).filter(s=>s!==void 0)}static processPrimitiveField(e,t){const r=ma(t.type);if(!r)throw new Error(`No converter for ASN.1 type ${t.type}`);return r.fromASN(e)}static isOptionalChoiceField(e){return e.optional&&typeof e.type=="function"&&at.has(e.type)&&at.get(e.type).type===k.Choice}static processOptionalChoiceField(e,t){try{return{processed:!0,value:this.fromASN(e,t.type)}}catch(r){if(r instanceof Oo&&/Wrong values for Choice type/.test(r.message))return{processed:!1};throw r}}static handleArrayTypes(e,t,r){if(!("value"in e.valueBlock&&Array.isArray(e.valueBlock.value)))throw new Error("Cannot get items from the ASN.1 parsed value. ASN.1 object is not constructed.");const i=t.itemType;if(typeof i=="number"){const s=ma(i);if(!s)throw new Error(`Cannot get default converter for array item of ${r.name} ASN1 schema`);return r.from(e.valueBlock.value,o=>s.fromASN(o))}else return r.from(e.valueBlock.value,s=>this.fromASN(s,i))}static processSchemaItems(e,t,r){for(const i in e.items){const s=t.result[i];if(!s)continue;const o=e.items[i],a=o.type;let c;typeof a=="number"||En(a)?c=this.processPrimitiveSchemaItem(s,o,a):c=this.processComplexSchemaItem(s,o,a),c&&typeof c=="object"&&"value"in c&&"raw"in c?(r[i]=c.value,r[`${i}Raw`]=c.raw):r[i]=c}}static processPrimitiveSchemaItem(e,t,r){var i;const s=(i=t.converter)!==null&&i!==void 0?i:En(r)?new r:null;if(!s)throw new Error("Converter is empty");return t.repeated?this.processRepeatedPrimitiveItem(e,t,s):this.processSinglePrimitiveItem(e,t,r,s)}static processRepeatedPrimitiveItem(e,t,r){if(t.implicit){const i=t.repeated==="sequence"?De:on,s=new i;s.valueBlock=e.valueBlock;const o=xr(s.toBER(!1));if(o.offset===-1)throw new Error(`Cannot parse the child item. ${o.result.error}`);if(!("value"in o.result.valueBlock&&Array.isArray(o.result.valueBlock.value)))throw new Error("Cannot get items from the ASN.1 parsed value. ASN.1 object is not constructed.");const a=o.result.valueBlock.value;return Array.from(a,c=>r.fromASN(c))}else return Array.from(e,i=>r.fromASN(i))}static processSinglePrimitiveItem(e,t,r,i){let s=e;if(t.implicit){let o;if(En(r))o=new r().toSchema("");else{const a=v[r],c=h8[a];if(!c)throw new Error(`Cannot get '${a}' class from asn1js module`);o=new c}o.valueBlock=s.valueBlock,s=xr(o.toBER(!1)).result}return i.fromASN(s)}static processComplexSchemaItem(e,t,r){if(t.repeated){if(!Array.isArray(e))throw new Error("Cannot get list of items from the ASN.1 parsed value. ASN.1 value should be iterable.");return Array.from(e,i=>this.fromASN(i,r))}else{const i=this.handleImplicitTagging(e,t,r);if(this.isOptionalChoiceField(t))try{return this.fromASN(i,r)}catch(s){if(s instanceof Oo&&/Wrong values for Choice type/.test(s.message))return;throw s}else{const s=this.fromASN(i,r);return t.raw?{value:s,raw:e.valueBeforeDecodeView}:s}}}static handleImplicitTagging(e,t,r){if(t.implicit&&typeof t.context=="number"){const i=at.get(r);if(i.type===k.Sequence){const s=new De;if("value"in e.valueBlock&&Array.isArray(e.valueBlock.value)&&"value"in s.valueBlock)return s.valueBlock.value=e.valueBlock.value,s}else if(i.type===k.Set){const s=new on;if("value"in e.valueBlock&&Array.isArray(e.valueBlock.value)&&"value"in s.valueBlock)return s.valueBlock.value=e.valueBlock.value,s}}return e}}class Up{static serialize(e){return e instanceof At?e.toBER(!1):this.toASN(e).toBER(!1)}static toASN(e){if(e&&typeof e=="object"&&En(e))return e.toASN();if(!(e&&typeof e=="object"))throw new TypeError("Parameter 1 should be type of Object.");const t=e.constructor,r=at.get(t);at.cache(t);let i=[];if(r.itemType){if(!Array.isArray(e))throw new TypeError("Parameter 1 should be type of Array.");if(typeof r.itemType=="number"){const o=ma(r.itemType);if(!o)throw new Error(`Cannot get default converter for array item of ${t.name} ASN1 schema`);i=e.map(a=>o.toASN(a))}else i=e.map(o=>this.toAsnItem({type:r.itemType},"[]",t,o))}else for(const o in r.items){const a=r.items[o],c=e[o];if(c===void 0||a.defaultValue===c||typeof a.defaultValue=="object"&&typeof c=="object"&&GP(this.serialize(a.defaultValue),this.serialize(c)))continue;const l=Up.toAsnItem(a,o,t,c);if(typeof a.context=="number")if(a.implicit)if(!a.repeated&&(typeof a.type=="number"||En(a.type))){const u={};u.valueHex=l instanceof zr?l.valueBeforeDecodeView:l.valueBlock.toBER(),i.push(new lc({optional:a.optional,idBlock:{tagClass:3,tagNumber:a.context},...u}))}else i.push(new Vt({optional:a.optional,idBlock:{tagClass:3,tagNumber:a.context},value:l.valueBlock.value}));else i.push(new Vt({optional:a.optional,idBlock:{tagClass:3,tagNumber:a.context},value:[l]}));else a.repeated?i=i.concat(l):i.push(l)}let s;switch(r.type){case k.Sequence:s=new De({value:i});break;case k.Set:s=new on({value:i});break;case k.Choice:if(!i[0])throw new Error(`Schema '${t.name}' has wrong data. Choice cannot be empty.`);s=i[0];break}return s}static toAsnItem(e,t,r,i){let s;if(typeof e.type=="number"){const o=e.converter;if(!o)throw new Error(`Property '${t}' doesn't have converter for type ${v[e.type]} in schema '${r.name}'`);if(e.repeated){if(!Array.isArray(i))throw new TypeError("Parameter 'objProp' should be type of Array.");const a=Array.from(i,l=>o.toASN(l)),c=e.repeated==="sequence"?De:on;s=new c({value:a})}else s=o.toASN(i)}else if(e.repeated){if(!Array.isArray(i))throw new TypeError("Parameter 'objProp' should be type of Array.");const o=Array.from(i,c=>this.toASN(c)),a=e.repeated==="sequence"?De:on;s=new a({value:o})}else s=this.toASN(i);return s}}class Oe extends Array{constructor(e=[]){if(typeof e=="number")super(e);else{super();for(const t of e)this.push(t)}}}class D{static serialize(e){return Up.serialize(e)}static parse(e,t){return QP.parse(e,t)}static toString(e){const t=L.isBufferSource(e)?L.toArrayBuffer(e):D.serialize(e),r=xr(t);if(r.offset===-1)throw new Error(`Cannot decode ASN.1 data. ${r.result.error}`);return r.result.toString()}}class om{static isIPv4(e){return/^(\d{1,3}\.){3}\d{1,3}$/.test(e)}static parseIPv4(e){const t=e.split(".");if(t.length!==4)throw new Error("Invalid IPv4 address");return t.map(r=>{const i=parseInt(r,10);if(isNaN(i)||i<0||i>255)throw new Error("Invalid IPv4 address part");return i})}static parseIPv6(e){const r=this.expandIPv6(e).split(":");if(r.length!==8)throw new Error("Invalid IPv6 address");return r.reduce((i,s)=>{const o=parseInt(s,16);if(isNaN(o)||o<0||o>65535)throw new Error("Invalid IPv6 address part");return i.push(o>>8&255),i.push(o&255),i},[])}static expandIPv6(e){if(!e.includes("::"))return e;const t=e.split("::");if(t.length>2)throw new Error("Invalid IPv6 address");const r=t[0]?t[0].split(":"):[],i=t[1]?t[1].split(":"):[],s=8-(r.length+i.length);if(s<0)throw new Error("Invalid IPv6 address");return[...r,...Array(s).fill("0"),...i].join(":")}static formatIPv6(e){const t=[];for(let r=0;r<16;r+=2)t.push((e[r]<<8|e[r+1]).toString(16));return this.compressIPv6(t.join(":"))}static compressIPv6(e){const t=e.split(":");let r=-1,i=0,s=-1,o=0;for(let a=0;a<t.length;a++)t[a]==="0"?(s===-1&&(s=a),o++):(o>i&&(r=s,i=o),s=-1,o=0);if(o>i&&(r=s,i=o),i>1){const a=t.slice(0,r).join(":"),c=t.slice(r+i).join(":");return`${a}::${c}`}return e}static parseCIDR(e){const[t,r]=e.split("/"),i=parseInt(r,10);if(this.isIPv4(t)){if(i<0||i>32)throw new Error("Invalid IPv4 prefix length");return[this.parseIPv4(t),i]}else{if(i<0||i>128)throw new Error("Invalid IPv6 prefix length");return[this.parseIPv6(t),i]}}static decodeIP(e){if(e.length===64&&parseInt(e,16)===0)return"::/0";if(e.length!==16)return e;const t=parseInt(e.slice(8),16).toString(2).split("").reduce((i,s)=>i+ +s,0);let r=e.slice(0,8).replace(/(.{2})/g,i=>`${parseInt(i,16)}.`);return r=r.slice(0,-1),`${r}/${t}`}static toString(e){const t=new Uint8Array(e);if(t.length===4)return Array.from(t).join(".");if(t.length===16)return this.formatIPv6(t);if(t.length===8||t.length===32){const r=t.length/2,i=t.slice(0,r),s=t.slice(r);if(t.every(c=>c===0))return t.length===8?"0.0.0.0/0":"::/0";const a=s.reduce((c,l)=>c+(l.toString(2).match(/1/g)||[]).length,0);return t.length===8?`${Array.from(i).join(".")}/${a}`:`${this.formatIPv6(i)}/${a}`}return this.decodeIP(Q.ToHex(e))}static fromString(e){if(e.includes("/")){const[r,i]=this.parseCIDR(e),s=new Uint8Array(r.length);let o=i;for(let c=0;c<s.length;c++)o>=8?(s[c]=255,o-=8):o>0&&(s[c]=255<<8-o,o=0);const a=new Uint8Array(r.length*2);return a.set(r,0),a.set(s,r.length),a.buffer}const t=this.isIPv4(e)?this.parseIPv4(e):this.parseIPv6(e);return new Uint8Array(t).buffer}}var uf,df,hf;let kt=class{constructor(e={}){Object.assign(this,e)}toString(){return this.bmpString||this.printableString||this.teletexString||this.universalString||this.utf8String||""}};p([g({type:v.TeletexString})],kt.prototype,"teletexString",void 0);p([g({type:v.PrintableString})],kt.prototype,"printableString",void 0);p([g({type:v.UniversalString})],kt.prototype,"universalString",void 0);p([g({type:v.Utf8String})],kt.prototype,"utf8String",void 0);p([g({type:v.BmpString})],kt.prototype,"bmpString",void 0);kt=p([I({type:k.Choice})],kt);let js=class extends kt{constructor(e={}){super(e),Object.assign(this,e)}toString(){return this.ia5String||(this.anyValue?Q.ToHex(this.anyValue):super.toString())}};p([g({type:v.IA5String})],js.prototype,"ia5String",void 0);p([g({type:v.Any})],js.prototype,"anyValue",void 0);js=p([I({type:k.Choice})],js);class Od{constructor(e={}){this.type="",this.value=new js,Object.assign(this,e)}}p([g({type:v.ObjectIdentifier})],Od.prototype,"type",void 0);p([g({type:js})],Od.prototype,"value",void 0);let Qs=uf=class extends Oe{constructor(e){super(e),Object.setPrototypeOf(this,uf.prototype)}};Qs=uf=p([I({type:k.Set,itemType:Od})],Qs);let ff=df=class extends Oe{constructor(e){super(e),Object.setPrototypeOf(this,df.prototype)}};ff=df=p([I({type:k.Sequence,itemType:Qs})],ff);let et=hf=class extends ff{constructor(e){super(e),Object.setPrototypeOf(this,hf.prototype)}};et=hf=p([I({type:k.Sequence})],et);const YP={fromASN:n=>om.toString(nu.fromASN(n)),toASN:n=>nu.toASN(om.fromString(n))};class za{constructor(e={}){this.typeId="",this.value=new ArrayBuffer(0),Object.assign(this,e)}}p([g({type:v.ObjectIdentifier})],za.prototype,"typeId",void 0);p([g({type:v.Any,context:0})],za.prototype,"value",void 0);class $p{constructor(e={}){this.partyName=new kt,Object.assign(this,e)}}p([g({type:kt,optional:!0,context:0,implicit:!0})],$p.prototype,"nameAssigner",void 0);p([g({type:kt,context:1,implicit:!0})],$p.prototype,"partyName",void 0);let le=class{constructor(e={}){Object.assign(this,e)}};p([g({type:za,context:0,implicit:!0})],le.prototype,"otherName",void 0);p([g({type:v.IA5String,context:1,implicit:!0})],le.prototype,"rfc822Name",void 0);p([g({type:v.IA5String,context:2,implicit:!0})],le.prototype,"dNSName",void 0);p([g({type:v.Any,context:3,implicit:!0})],le.prototype,"x400Address",void 0);p([g({type:et,context:4,implicit:!1})],le.prototype,"directoryName",void 0);p([g({type:$p,context:5})],le.prototype,"ediPartyName",void 0);p([g({type:v.IA5String,context:6,implicit:!0})],le.prototype,"uniformResourceIdentifier",void 0);p([g({type:v.OctetString,context:7,implicit:!0,converter:YP})],le.prototype,"iPAddress",void 0);p([g({type:v.ObjectIdentifier,context:8,implicit:!0})],le.prototype,"registeredID",void 0);le=p([I({type:k.Choice})],le);const Vp="1.3.6.1.5.5.7",XP=`${Vp}.1`,ho=`${Vp}.3`,Nd=`${Vp}.48`,am=`${Nd}.1`,cm=`${Nd}.2`,lm=`${Nd}.3`,um=`${Nd}.5`,Dn="2.5.29";var pf;const gf=`${XP}.1`;class pc{constructor(e={}){this.accessMethod="",this.accessLocation=new le,Object.assign(this,e)}}p([g({type:v.ObjectIdentifier})],pc.prototype,"accessMethod",void 0);p([g({type:le})],pc.prototype,"accessLocation",void 0);let As=pf=class extends Oe{constructor(e){super(e),Object.setPrototypeOf(this,pf.prototype)}};As=pf=p([I({type:k.Sequence,itemType:pc})],As);const mf=`${Dn}.35`;class qp extends be{}class Pi{constructor(e={}){e&&Object.assign(this,e)}}p([g({type:qp,context:0,optional:!0,implicit:!0})],Pi.prototype,"keyIdentifier",void 0);p([g({type:le,context:1,optional:!0,implicit:!0,repeated:"sequence"})],Pi.prototype,"authorityCertIssuer",void 0);p([g({type:v.Integer,context:2,optional:!0,implicit:!0,converter:ze})],Pi.prototype,"authorityCertSerialNumber",void 0);const o7=`${Dn}.19`;class iu{constructor(e={}){this.cA=!1,Object.assign(this,e)}}p([g({type:v.Boolean,defaultValue:!1})],iu.prototype,"cA",void 0);p([g({type:v.Integer,optional:!0})],iu.prototype,"pathLenConstraint",void 0);var yf;let Pt=yf=class extends Oe{constructor(e){super(e),Object.setPrototypeOf(this,yf.prototype)}};Pt=yf=p([I({type:k.Sequence,itemType:le})],Pt);var wf;let dm=wf=class extends Pt{constructor(e){super(e),Object.setPrototypeOf(this,wf.prototype)}};dm=wf=p([I({type:k.Sequence})],dm);var vf;const a7=`${Dn}.32`;let kn=class{constructor(e={}){Object.assign(this,e)}toString(){return this.ia5String||this.visibleString||this.bmpString||this.utf8String||""}};p([g({type:v.IA5String})],kn.prototype,"ia5String",void 0);p([g({type:v.VisibleString})],kn.prototype,"visibleString",void 0);p([g({type:v.BmpString})],kn.prototype,"bmpString",void 0);p([g({type:v.Utf8String})],kn.prototype,"utf8String",void 0);kn=p([I({type:k.Choice})],kn);class Hp{constructor(e={}){this.organization=new kn,this.noticeNumbers=[],Object.assign(this,e)}}p([g({type:kn})],Hp.prototype,"organization",void 0);p([g({type:v.Integer,repeated:"sequence"})],Hp.prototype,"noticeNumbers",void 0);class zp{constructor(e={}){Object.assign(this,e)}}p([g({type:Hp,optional:!0})],zp.prototype,"noticeRef",void 0);p([g({type:kn,optional:!0})],zp.prototype,"explicitText",void 0);let su=class{constructor(e={}){Object.assign(this,e)}};p([g({type:v.IA5String})],su.prototype,"cPSuri",void 0);p([g({type:zp})],su.prototype,"userNotice",void 0);su=p([I({type:k.Choice})],su);class Kp{constructor(e={}){this.policyQualifierId="",this.qualifier=new ArrayBuffer(0),Object.assign(this,e)}}p([g({type:v.ObjectIdentifier})],Kp.prototype,"policyQualifierId",void 0);p([g({type:v.Any})],Kp.prototype,"qualifier",void 0);class Dd{constructor(e={}){this.policyIdentifier="",Object.assign(this,e)}}p([g({type:v.ObjectIdentifier})],Dd.prototype,"policyIdentifier",void 0);p([g({type:Kp,repeated:"sequence",optional:!0})],Dd.prototype,"policyQualifiers",void 0);let ou=vf=class extends Oe{constructor(e){super(e),Object.setPrototypeOf(this,vf.prototype)}};ou=vf=p([I({type:k.Sequence,itemType:Dd})],ou);let au=class{constructor(e=0){this.value=e}};p([g({type:v.Integer})],au.prototype,"value",void 0);au=p([I({type:k.Choice})],au);let hm=class extends au{};hm=p([I({type:k.Choice})],hm);var bf;const Ef=`${Dn}.31`;var Rr;(function(n){n[n.unused=1]="unused",n[n.keyCompromise=2]="keyCompromise",n[n.cACompromise=4]="cACompromise",n[n.affiliationChanged=8]="affiliationChanged",n[n.superseded=16]="superseded",n[n.cessationOfOperation=32]="cessationOfOperation",n[n.certificateHold=64]="certificateHold",n[n.privilegeWithdrawn=128]="privilegeWithdrawn",n[n.aACompromise=256]="aACompromise"})(Rr||(Rr={}));class c7 extends Pd{toJSON(){const e=[],t=this.toNumber();return t&Rr.aACompromise&&e.push("aACompromise"),t&Rr.affiliationChanged&&e.push("affiliationChanged"),t&Rr.cACompromise&&e.push("cACompromise"),t&Rr.certificateHold&&e.push("certificateHold"),t&Rr.cessationOfOperation&&e.push("cessationOfOperation"),t&Rr.keyCompromise&&e.push("keyCompromise"),t&Rr.privilegeWithdrawn&&e.push("privilegeWithdrawn"),t&Rr.superseded&&e.push("superseded"),t&Rr.unused&&e.push("unused"),e}toString(){return`[${this.toJSON().join(", ")}]`}}let zi=class{constructor(e={}){Object.assign(this,e)}};p([g({type:le,context:0,repeated:"sequence",implicit:!0})],zi.prototype,"fullName",void 0);p([g({type:Qs,context:1,implicit:!0})],zi.prototype,"nameRelativeToCRLIssuer",void 0);zi=p([I({type:k.Choice})],zi);class fo{constructor(e={}){Object.assign(this,e)}}p([g({type:zi,context:0,optional:!0})],fo.prototype,"distributionPoint",void 0);p([g({type:c7,context:1,optional:!0,implicit:!0})],fo.prototype,"reasons",void 0);p([g({type:le,context:2,optional:!0,repeated:"sequence",implicit:!0})],fo.prototype,"cRLIssuer",void 0);let Ps=bf=class extends Oe{constructor(e){super(e),Object.setPrototypeOf(this,bf.prototype)}};Ps=bf=p([I({type:k.Sequence,itemType:fo})],Ps);var Sf;let fm=Sf=class extends Ps{constructor(e){super(e),Object.setPrototypeOf(this,Sf.prototype)}};fm=Sf=p([I({type:k.Sequence,itemType:fo})],fm);class Ct{constructor(e={}){this.onlyContainsUserCerts=Ct.ONLY,this.onlyContainsCACerts=Ct.ONLY,this.indirectCRL=Ct.ONLY,this.onlyContainsAttributeCerts=Ct.ONLY,Object.assign(this,e)}}Ct.ONLY=!1;p([g({type:zi,context:0,optional:!0})],Ct.prototype,"distributionPoint",void 0);p([g({type:v.Boolean,context:1,defaultValue:Ct.ONLY,implicit:!0})],Ct.prototype,"onlyContainsUserCerts",void 0);p([g({type:v.Boolean,context:2,defaultValue:Ct.ONLY,implicit:!0})],Ct.prototype,"onlyContainsCACerts",void 0);p([g({type:c7,context:3,optional:!0,implicit:!0})],Ct.prototype,"onlySomeReasons",void 0);p([g({type:v.Boolean,context:4,defaultValue:Ct.ONLY,implicit:!0})],Ct.prototype,"indirectCRL",void 0);p([g({type:v.Boolean,context:5,defaultValue:Ct.ONLY,implicit:!0})],Ct.prototype,"onlyContainsAttributeCerts",void 0);var ya;(function(n){n[n.unspecified=0]="unspecified",n[n.keyCompromise=1]="keyCompromise",n[n.cACompromise=2]="cACompromise",n[n.affiliationChanged=3]="affiliationChanged",n[n.superseded=4]="superseded",n[n.cessationOfOperation=5]="cessationOfOperation",n[n.certificateHold=6]="certificateHold",n[n.removeFromCRL=8]="removeFromCRL",n[n.privilegeWithdrawn=9]="privilegeWithdrawn",n[n.aACompromise=10]="aACompromise"})(ya||(ya={}));let xf=class{constructor(e=ya.unspecified){this.reason=ya.unspecified,this.reason=e}toJSON(){return ya[this.reason]}toString(){return this.toJSON()}};p([g({type:v.Enumerated})],xf.prototype,"reason",void 0);xf=p([I({type:k.Choice})],xf);var Af;const l7=`${Dn}.37`;let cu=Af=class extends Oe{constructor(e){super(e),Object.setPrototypeOf(this,Af.prototype)}};cu=Af=p([I({type:k.Sequence,itemType:v.ObjectIdentifier})],cu);const ZP=`${ho}.1`,JP=`${ho}.2`,eO=`${ho}.3`,tO=`${ho}.4`,rO=`${ho}.8`,nO=`${ho}.9`;let kf=class{constructor(e=new ArrayBuffer(0)){this.value=e}};p([g({type:v.Integer,converter:ze})],kf.prototype,"value",void 0);kf=p([I({type:k.Choice})],kf);let _f=class{constructor(e){this.value=new Date,e&&(this.value=e)}};p([g({type:v.GeneralizedTime})],_f.prototype,"value",void 0);_f=p([I({type:k.Choice})],_f);var If;const u7=`${Dn}.18`;let pm=If=class extends Pt{constructor(e){super(e),Object.setPrototypeOf(this,If.prototype)}};pm=If=p([I({type:k.Sequence})],pm);const d7=`${Dn}.15`;var Pr;(function(n){n[n.digitalSignature=1]="digitalSignature",n[n.nonRepudiation=2]="nonRepudiation",n[n.keyEncipherment=4]="keyEncipherment",n[n.dataEncipherment=8]="dataEncipherment",n[n.keyAgreement=16]="keyAgreement",n[n.keyCertSign=32]="keyCertSign",n[n.cRLSign=64]="cRLSign",n[n.encipherOnly=128]="encipherOnly",n[n.decipherOnly=256]="decipherOnly"})(Pr||(Pr={}));class Zh extends Pd{toJSON(){const e=this.toNumber(),t=[];return e&Pr.cRLSign&&t.push("crlSign"),e&Pr.dataEncipherment&&t.push("dataEncipherment"),e&Pr.decipherOnly&&t.push("decipherOnly"),e&Pr.digitalSignature&&t.push("digitalSignature"),e&Pr.encipherOnly&&t.push("encipherOnly"),e&Pr.keyAgreement&&t.push("keyAgreement"),e&Pr.keyCertSign&&t.push("keyCertSign"),e&Pr.keyEncipherment&&t.push("keyEncipherment"),e&Pr.nonRepudiation&&t.push("nonRepudiation"),t}toString(){return`[${this.toJSON().join(", ")}]`}}var Cf;class Ld{constructor(e={}){this.base=new le,this.minimum=0,Object.assign(this,e)}}p([g({type:le})],Ld.prototype,"base",void 0);p([g({type:v.Integer,context:0,defaultValue:0,implicit:!0})],Ld.prototype,"minimum",void 0);p([g({type:v.Integer,context:1,optional:!0,implicit:!0})],Ld.prototype,"maximum",void 0);let lu=Cf=class extends Oe{constructor(e){super(e),Object.setPrototypeOf(this,Cf.prototype)}};lu=Cf=p([I({type:k.Sequence,itemType:Ld})],lu);class h7{constructor(e={}){Object.assign(this,e)}}p([g({type:lu,context:0,optional:!0,implicit:!0})],h7.prototype,"permittedSubtrees",void 0);p([g({type:lu,context:1,optional:!0,implicit:!0})],h7.prototype,"excludedSubtrees",void 0);class f7{constructor(e={}){Object.assign(this,e)}}p([g({type:v.Integer,context:0,implicit:!0,optional:!0,converter:ze})],f7.prototype,"requireExplicitPolicy",void 0);p([g({type:v.Integer,context:1,implicit:!0,optional:!0,converter:ze})],f7.prototype,"inhibitPolicyMapping",void 0);var Tf;class Wp{constructor(e={}){this.issuerDomainPolicy="",this.subjectDomainPolicy="",Object.assign(this,e)}}p([g({type:v.ObjectIdentifier})],Wp.prototype,"issuerDomainPolicy",void 0);p([g({type:v.ObjectIdentifier})],Wp.prototype,"subjectDomainPolicy",void 0);let gm=Tf=class extends Oe{constructor(e){super(e),Object.setPrototypeOf(this,Tf.prototype)}};gm=Tf=p([I({type:k.Sequence,itemType:Wp})],gm);var Rf;const p7=`${Dn}.17`;let Pf=Rf=class extends Pt{constructor(e){super(e),Object.setPrototypeOf(this,Rf.prototype)}};Pf=Rf=p([I({type:k.Sequence})],Pf);let _n=class{constructor(e={}){this.type="",this.values=[],Object.assign(this,e)}};p([g({type:v.ObjectIdentifier})],_n.prototype,"type",void 0);p([g({type:v.Any,repeated:"set"})],_n.prototype,"values",void 0);var Of;let mm=Of=class extends Oe{constructor(e){super(e),Object.setPrototypeOf(this,Of.prototype)}};mm=Of=p([I({type:k.Sequence,itemType:_n})],mm);const g7=`${Dn}.14`;class ri extends qp{}class m7{constructor(e={}){Object.assign(this,e)}}p([g({type:v.GeneralizedTime,context:0,implicit:!0,optional:!0})],m7.prototype,"notBefore",void 0);p([g({type:v.GeneralizedTime,context:1,implicit:!0,optional:!0})],m7.prototype,"notAfter",void 0);var wa;(function(n){n[n.keyUpdateAllowed=1]="keyUpdateAllowed",n[n.newExtensions=2]="newExtensions",n[n.pKIXCertificate=4]="pKIXCertificate"})(wa||(wa={}));class y7 extends Pd{toJSON(){const e=[],t=this.toNumber();return t&wa.pKIXCertificate&&e.push("pKIXCertificate"),t&wa.newExtensions&&e.push("newExtensions"),t&wa.keyUpdateAllowed&&e.push("keyUpdateAllowed"),e}toString(){return`[${this.toJSON().join(", ")}]`}}class w7{constructor(e={}){this.entrustVers="",this.entrustInfoFlags=new y7,Object.assign(this,e)}}p([g({type:v.GeneralString})],w7.prototype,"entrustVers",void 0);p([g({type:y7})],w7.prototype,"entrustInfoFlags",void 0);var Nf;let ym=Nf=class extends Oe{constructor(e){super(e),Object.setPrototypeOf(this,Nf.prototype)}};ym=Nf=p([I({type:k.Sequence,itemType:pc})],ym);class H{constructor(e={}){this.algorithm="",Object.assign(this,e)}isEqual(e){return e instanceof H&&e.algorithm==this.algorithm&&(e.parameters&&this.parameters&&my(e.parameters,this.parameters)||e.parameters===this.parameters)}}p([g({type:v.ObjectIdentifier})],H.prototype,"algorithm",void 0);p([g({type:v.Any,optional:!0})],H.prototype,"parameters",void 0);class Lr{constructor(e={}){this.algorithm=new H,this.subjectPublicKey=new ArrayBuffer(0),Object.assign(this,e)}}p([g({type:H})],Lr.prototype,"algorithm",void 0);p([g({type:v.BitString})],Lr.prototype,"subjectPublicKey",void 0);let Et=class{constructor(e){if(e)if(typeof e=="string"||typeof e=="number"||e instanceof Date){const t=new Date(e);t.getUTCFullYear()>2049?this.generalTime=t:this.utcTime=t}else Object.assign(this,e)}getTime(){const e=this.utcTime||this.generalTime;if(!e)throw new Error("Cannot get time from CHOICE object");return e}};p([g({type:v.UTCTime})],Et.prototype,"utcTime",void 0);p([g({type:v.GeneralizedTime})],Et.prototype,"generalTime",void 0);Et=p([I({type:k.Choice})],Et);class gc{constructor(e){this.notBefore=new Et(new Date),this.notAfter=new Et(new Date),e&&(this.notBefore=new Et(e.notBefore),this.notAfter=new Et(e.notAfter))}}p([g({type:Et})],gc.prototype,"notBefore",void 0);p([g({type:Et})],gc.prototype,"notAfter",void 0);var Df;let kr=class v7{constructor(e={}){this.extnID="",this.critical=v7.CRITICAL,this.extnValue=new be,Object.assign(this,e)}};kr.CRITICAL=!1;p([g({type:v.ObjectIdentifier})],kr.prototype,"extnID",void 0);p([g({type:v.Boolean,defaultValue:kr.CRITICAL})],kr.prototype,"critical",void 0);p([g({type:be})],kr.prototype,"extnValue",void 0);let li=Df=class extends Oe{constructor(e){super(e),Object.setPrototypeOf(this,Df.prototype)}};li=Df=p([I({type:k.Sequence,itemType:kr})],li);var Ki;(function(n){n[n.v1=0]="v1",n[n.v2=1]="v2",n[n.v3=2]="v3"})(Ki||(Ki={}));class wr{constructor(e={}){this.version=Ki.v1,this.serialNumber=new ArrayBuffer(0),this.signature=new H,this.issuer=new et,this.validity=new gc,this.subject=new et,this.subjectPublicKeyInfo=new Lr,Object.assign(this,e)}}p([g({type:v.Integer,context:0,defaultValue:Ki.v1})],wr.prototype,"version",void 0);p([g({type:v.Integer,converter:ze})],wr.prototype,"serialNumber",void 0);p([g({type:H})],wr.prototype,"signature",void 0);p([g({type:et})],wr.prototype,"issuer",void 0);p([g({type:gc})],wr.prototype,"validity",void 0);p([g({type:et})],wr.prototype,"subject",void 0);p([g({type:Lr})],wr.prototype,"subjectPublicKeyInfo",void 0);p([g({type:v.BitString,context:1,implicit:!0,optional:!0})],wr.prototype,"issuerUniqueID",void 0);p([g({type:v.BitString,context:2,implicit:!0,optional:!0})],wr.prototype,"subjectUniqueID",void 0);p([g({type:li,context:3,optional:!0})],wr.prototype,"extensions",void 0);class Wi{constructor(e={}){this.tbsCertificate=new wr,this.signatureAlgorithm=new H,this.signatureValue=new ArrayBuffer(0),Object.assign(this,e)}}p([g({type:wr,raw:!0})],Wi.prototype,"tbsCertificate",void 0);p([g({type:H})],Wi.prototype,"signatureAlgorithm",void 0);p([g({type:v.BitString})],Wi.prototype,"signatureValue",void 0);class Bd{constructor(e={}){this.userCertificate=new ArrayBuffer(0),this.revocationDate=new Et,Object.assign(this,e)}}p([g({type:v.Integer,converter:ze})],Bd.prototype,"userCertificate",void 0);p([g({type:Et})],Bd.prototype,"revocationDate",void 0);p([g({type:kr,optional:!0,repeated:"sequence"})],Bd.prototype,"crlEntryExtensions",void 0);class Ln{constructor(e={}){this.signature=new H,this.issuer=new et,this.thisUpdate=new Et,Object.assign(this,e)}}p([g({type:v.Integer,optional:!0})],Ln.prototype,"version",void 0);p([g({type:H})],Ln.prototype,"signature",void 0);p([g({type:et})],Ln.prototype,"issuer",void 0);p([g({type:Et})],Ln.prototype,"thisUpdate",void 0);p([g({type:Et,optional:!0})],Ln.prototype,"nextUpdate",void 0);p([g({type:Bd,repeated:"sequence",optional:!0})],Ln.prototype,"revokedCertificates",void 0);p([g({type:kr,optional:!0,context:0,repeated:"sequence"})],Ln.prototype,"crlExtensions",void 0);class Gp{constructor(e={}){this.tbsCertList=new Ln,this.signatureAlgorithm=new H,this.signature=new ArrayBuffer(0),Object.assign(this,e)}}p([g({type:Ln,raw:!0})],Gp.prototype,"tbsCertList",void 0);p([g({type:H})],Gp.prototype,"signatureAlgorithm",void 0);p([g({type:v.BitString})],Gp.prototype,"signature",void 0);class po{constructor(e={}){this.issuer=new et,this.serialNumber=new ArrayBuffer(0),Object.assign(this,e)}}p([g({type:et})],po.prototype,"issuer",void 0);p([g({type:v.Integer,converter:ze})],po.prototype,"serialNumber",void 0);let Ys=class{constructor(e={}){Object.assign(this,e)}};p([g({type:ri,context:0,implicit:!0})],Ys.prototype,"subjectKeyIdentifier",void 0);p([g({type:po})],Ys.prototype,"issuerAndSerialNumber",void 0);Ys=p([I({type:k.Choice})],Ys);var In;(function(n){n[n.v0=0]="v0",n[n.v1=1]="v1",n[n.v2=2]="v2",n[n.v3=3]="v3",n[n.v4=4]="v4",n[n.v5=5]="v5"})(In||(In={}));let Ka=class extends H{};Ka=p([I({type:k.Sequence})],Ka);let uu=class extends H{};uu=p([I({type:k.Sequence})],uu);let ln=class extends H{};ln=p([I({type:k.Sequence})],ln);let du=class extends H{};du=p([I({type:k.Sequence})],du);let wm=class extends H{};wm=p([I({type:k.Sequence})],wm);let Lf=class extends H{};Lf=p([I({type:k.Sequence})],Lf);let go=class{constructor(e={}){this.attrType="",this.attrValues=[],Object.assign(this,e)}};p([g({type:v.ObjectIdentifier})],go.prototype,"attrType",void 0);p([g({type:v.Any,repeated:"set"})],go.prototype,"attrValues",void 0);var Bf;class gn{constructor(e={}){this.version=In.v0,this.sid=new Ys,this.digestAlgorithm=new Ka,this.signatureAlgorithm=new uu,this.signature=new be,Object.assign(this,e)}}p([g({type:v.Integer})],gn.prototype,"version",void 0);p([g({type:Ys})],gn.prototype,"sid",void 0);p([g({type:Ka})],gn.prototype,"digestAlgorithm",void 0);p([g({type:go,repeated:"set",context:0,implicit:!0,optional:!0,raw:!0})],gn.prototype,"signedAttrs",void 0);p([g({type:uu})],gn.prototype,"signatureAlgorithm",void 0);p([g({type:be})],gn.prototype,"signature",void 0);p([g({type:go,repeated:"set",context:1,implicit:!0,optional:!0})],gn.prototype,"unsignedAttrs",void 0);let hu=Bf=class extends Oe{constructor(e){super(e),Object.setPrototypeOf(this,Bf.prototype)}};hu=Bf=p([I({type:k.Set,itemType:gn})],hu);let vm=class extends Et{};vm=p([I({type:k.Choice})],vm);let bm=class extends gn{};bm=p([I({type:k.Sequence})],bm);class jp{constructor(e={}){this.acIssuer=new le,this.acSerial=0,this.attrs=[],Object.assign(this,e)}}p([g({type:le})],jp.prototype,"acIssuer",void 0);p([g({type:v.Integer})],jp.prototype,"acSerial",void 0);p([g({type:_n,repeated:"sequence"})],jp.prototype,"attrs",void 0);var Mf;let fu=Mf=class extends Oe{constructor(e){super(e),Object.setPrototypeOf(this,Mf.prototype)}};fu=Mf=p([I({type:k.Sequence,itemType:v.ObjectIdentifier})],fu);class Md{constructor(e={}){this.permitUnSpecified=!0,Object.assign(this,e)}}p([g({type:v.Integer,optional:!0})],Md.prototype,"pathLenConstraint",void 0);p([g({type:fu,implicit:!0,context:0,optional:!0})],Md.prototype,"permittedAttrs",void 0);p([g({type:fu,implicit:!0,context:1,optional:!0})],Md.prototype,"excludedAttrs",void 0);p([g({type:v.Boolean,defaultValue:!0})],Md.prototype,"permitUnSpecified",void 0);class os{constructor(e={}){this.issuer=new Pt,this.serial=new ArrayBuffer(0),this.issuerUID=new ArrayBuffer(0),Object.assign(this,e)}}p([g({type:Pt})],os.prototype,"issuer",void 0);p([g({type:v.Integer,converter:ze})],os.prototype,"serial",void 0);p([g({type:v.BitString,optional:!0})],os.prototype,"issuerUID",void 0);var Ff;(function(n){n[n.publicKey=0]="publicKey",n[n.publicKeyCert=1]="publicKeyCert",n[n.otherObjectTypes=2]="otherObjectTypes"})(Ff||(Ff={}));class as{constructor(e={}){this.digestedObjectType=Ff.publicKey,this.digestAlgorithm=new H,this.objectDigest=new ArrayBuffer(0),Object.assign(this,e)}}p([g({type:v.Enumerated})],as.prototype,"digestedObjectType",void 0);p([g({type:v.ObjectIdentifier,optional:!0})],as.prototype,"otherObjectTypeID",void 0);p([g({type:H})],as.prototype,"digestAlgorithm",void 0);p([g({type:v.BitString})],as.prototype,"objectDigest",void 0);class Fd{constructor(e={}){Object.assign(this,e)}}p([g({type:Pt,optional:!0})],Fd.prototype,"issuerName",void 0);p([g({type:os,context:0,implicit:!0,optional:!0})],Fd.prototype,"baseCertificateID",void 0);p([g({type:as,context:1,implicit:!0,optional:!0})],Fd.prototype,"objectDigestInfo",void 0);let Xs=class{constructor(e={}){Object.assign(this,e)}};p([g({type:le,repeated:"sequence"})],Xs.prototype,"v1Form",void 0);p([g({type:Fd,context:0,implicit:!0})],Xs.prototype,"v2Form",void 0);Xs=p([I({type:k.Choice})],Xs);class Ud{constructor(e={}){this.notBeforeTime=new Date,this.notAfterTime=new Date,Object.assign(this,e)}}p([g({type:v.GeneralizedTime})],Ud.prototype,"notBeforeTime",void 0);p([g({type:v.GeneralizedTime})],Ud.prototype,"notAfterTime",void 0);class mc{constructor(e={}){Object.assign(this,e)}}p([g({type:os,implicit:!0,context:0,optional:!0})],mc.prototype,"baseCertificateID",void 0);p([g({type:Pt,implicit:!0,context:1,optional:!0})],mc.prototype,"entityName",void 0);p([g({type:as,implicit:!0,context:2,optional:!0})],mc.prototype,"objectDigestInfo",void 0);var Uf;(function(n){n[n.v2=1]="v2"})(Uf||(Uf={}));class jr{constructor(e={}){this.version=Uf.v2,this.holder=new mc,this.issuer=new Xs,this.signature=new H,this.serialNumber=new ArrayBuffer(0),this.attrCertValidityPeriod=new Ud,this.attributes=[],Object.assign(this,e)}}p([g({type:v.Integer})],jr.prototype,"version",void 0);p([g({type:mc})],jr.prototype,"holder",void 0);p([g({type:Xs})],jr.prototype,"issuer",void 0);p([g({type:H})],jr.prototype,"signature",void 0);p([g({type:v.Integer,converter:ze})],jr.prototype,"serialNumber",void 0);p([g({type:Ud})],jr.prototype,"attrCertValidityPeriod",void 0);p([g({type:_n,repeated:"sequence"})],jr.prototype,"attributes",void 0);p([g({type:v.BitString,optional:!0})],jr.prototype,"issuerUniqueID",void 0);p([g({type:li,optional:!0})],jr.prototype,"extensions",void 0);class $d{constructor(e={}){this.acinfo=new jr,this.signatureAlgorithm=new H,this.signatureValue=new ArrayBuffer(0),Object.assign(this,e)}}p([g({type:jr})],$d.prototype,"acinfo",void 0);p([g({type:H})],$d.prototype,"signatureAlgorithm",void 0);p([g({type:v.BitString})],$d.prototype,"signatureValue",void 0);var pu;(function(n){n[n.unmarked=1]="unmarked",n[n.unclassified=2]="unclassified",n[n.restricted=4]="restricted",n[n.confidential=8]="confidential",n[n.secret=16]="secret",n[n.topSecret=32]="topSecret"})(pu||(pu={}));class $f extends Pd{}class Qp{constructor(e={}){this.type="",this.value=new ArrayBuffer(0),Object.assign(this,e)}}p([g({type:v.ObjectIdentifier,implicit:!0,context:0})],Qp.prototype,"type",void 0);p([g({type:v.Any,implicit:!0,context:1})],Qp.prototype,"value",void 0);class Yp{constructor(e={}){this.policyId="",this.classList=new $f(pu.unclassified),Object.assign(this,e)}}p([g({type:v.ObjectIdentifier})],Yp.prototype,"policyId",void 0);p([g({type:$f,defaultValue:new $f(pu.unclassified)})],Yp.prototype,"classList",void 0);p([g({type:Qp,repeated:"set"})],Yp.prototype,"securityCategories",void 0);class Vd{constructor(e={}){Object.assign(this,e)}}p([g({type:be})],Vd.prototype,"cotets",void 0);p([g({type:v.ObjectIdentifier})],Vd.prototype,"oid",void 0);p([g({type:v.Utf8String})],Vd.prototype,"string",void 0);class b7{constructor(e={}){this.values=[],Object.assign(this,e)}}p([g({type:Pt,implicit:!0,context:0,optional:!0})],b7.prototype,"policyAuthority",void 0);p([g({type:Vd,repeated:"sequence"})],b7.prototype,"values",void 0);var Vf;class qd{constructor(e={}){this.targetCertificate=new os,Object.assign(this,e)}}p([g({type:os})],qd.prototype,"targetCertificate",void 0);p([g({type:le,optional:!0})],qd.prototype,"targetName",void 0);p([g({type:as,optional:!0})],qd.prototype,"certDigestInfo",void 0);let Zs=class{constructor(e={}){Object.assign(this,e)}};p([g({type:le,context:0,implicit:!0})],Zs.prototype,"targetName",void 0);p([g({type:le,context:1,implicit:!0})],Zs.prototype,"targetGroup",void 0);p([g({type:qd,context:2,implicit:!0})],Zs.prototype,"targetCert",void 0);Zs=p([I({type:k.Choice})],Zs);let qf=Vf=class extends Oe{constructor(e){super(e),Object.setPrototypeOf(this,Vf.prototype)}};qf=Vf=p([I({type:k.Sequence,itemType:Zs})],qf);var Hf;let Em=Hf=class extends Oe{constructor(e){super(e),Object.setPrototypeOf(this,Hf.prototype)}};Em=Hf=p([I({type:k.Sequence,itemType:qf})],Em);class E7{constructor(e={}){Object.assign(this,e)}}p([g({type:Pt,implicit:!0,context:0,optional:!0})],E7.prototype,"roleAuthority",void 0);p([g({type:le,implicit:!0,context:1})],E7.prototype,"roleName",void 0);class Xp{constructor(e={}){this.service=new le,this.ident=new le,Object.assign(this,e)}}p([g({type:le})],Xp.prototype,"service",void 0);p([g({type:le})],Xp.prototype,"ident",void 0);p([g({type:be,optional:!0})],Xp.prototype,"authInfo",void 0);var zf;class Zp{constructor(e={}){this.otherCertFormat="",this.otherCert=new ArrayBuffer(0),Object.assign(this,e)}}p([g({type:v.ObjectIdentifier})],Zp.prototype,"otherCertFormat",void 0);p([g({type:v.Any})],Zp.prototype,"otherCert",void 0);let Js=class{constructor(e={}){Object.assign(this,e)}};p([g({type:Wi})],Js.prototype,"certificate",void 0);p([g({type:$d,context:2,implicit:!0})],Js.prototype,"v2AttrCert",void 0);p([g({type:Zp,context:3,implicit:!0})],Js.prototype,"other",void 0);Js=p([I({type:k.Choice})],Js);let gu=zf=class extends Oe{constructor(e){super(e),Object.setPrototypeOf(this,zf.prototype)}};gu=zf=p([I({type:k.Set,itemType:Js})],gu);class mo{constructor(e={}){this.contentType="",this.content=new ArrayBuffer(0),Object.assign(this,e)}}p([g({type:v.ObjectIdentifier})],mo.prototype,"contentType",void 0);p([g({type:v.Any,context:0})],mo.prototype,"content",void 0);let Wa=class{constructor(e={}){Object.assign(this,e)}};p([g({type:be})],Wa.prototype,"single",void 0);p([g({type:v.Any})],Wa.prototype,"any",void 0);Wa=p([I({type:k.Choice})],Wa);class Hd{constructor(e={}){this.eContentType="",Object.assign(this,e)}}p([g({type:v.ObjectIdentifier})],Hd.prototype,"eContentType",void 0);p([g({type:Wa,context:0,optional:!0})],Hd.prototype,"eContent",void 0);let Ga=class{constructor(e={}){Object.assign(this,e)}};p([g({type:be,context:0,implicit:!0,optional:!0})],Ga.prototype,"value",void 0);p([g({type:be,converter:OP,context:0,implicit:!0,optional:!0,repeated:"sequence"})],Ga.prototype,"constructedValue",void 0);Ga=p([I({type:k.Choice})],Ga);class yc{constructor(e={}){this.contentType="",this.contentEncryptionAlgorithm=new du,Object.assign(this,e)}}p([g({type:v.ObjectIdentifier})],yc.prototype,"contentType",void 0);p([g({type:du})],yc.prototype,"contentEncryptionAlgorithm",void 0);p([g({type:Ga,optional:!0})],yc.prototype,"encryptedContent",void 0);class zd{constructor(e={}){this.keyAttrId="",Object.assign(this,e)}}p([g({type:v.ObjectIdentifier})],zd.prototype,"keyAttrId",void 0);p([g({type:v.Any,optional:!0})],zd.prototype,"keyAttr",void 0);var Kf;class Kd{constructor(e={}){this.subjectKeyIdentifier=new ri,Object.assign(this,e)}}p([g({type:ri})],Kd.prototype,"subjectKeyIdentifier",void 0);p([g({type:v.GeneralizedTime,optional:!0})],Kd.prototype,"date",void 0);p([g({type:zd,optional:!0})],Kd.prototype,"other",void 0);let eo=class{constructor(e={}){Object.assign(this,e)}};p([g({type:Kd,context:0,implicit:!0,optional:!0})],eo.prototype,"rKeyId",void 0);p([g({type:po,optional:!0})],eo.prototype,"issuerAndSerialNumber",void 0);eo=p([I({type:k.Choice})],eo);class Jp{constructor(e={}){this.rid=new eo,this.encryptedKey=new be,Object.assign(this,e)}}p([g({type:eo})],Jp.prototype,"rid",void 0);p([g({type:be})],Jp.prototype,"encryptedKey",void 0);let mu=Kf=class extends Oe{constructor(e){super(e),Object.setPrototypeOf(this,Kf.prototype)}};mu=Kf=p([I({type:k.Sequence,itemType:Jp})],mu);class e2{constructor(e={}){this.algorithm=new H,this.publicKey=new ArrayBuffer(0),Object.assign(this,e)}}p([g({type:H})],e2.prototype,"algorithm",void 0);p([g({type:v.BitString})],e2.prototype,"publicKey",void 0);let Gi=class{constructor(e={}){Object.assign(this,e)}};p([g({type:ri,context:0,implicit:!0,optional:!0})],Gi.prototype,"subjectKeyIdentifier",void 0);p([g({type:e2,context:1,implicit:!0,optional:!0})],Gi.prototype,"originatorKey",void 0);p([g({type:po,optional:!0})],Gi.prototype,"issuerAndSerialNumber",void 0);Gi=p([I({type:k.Choice})],Gi);class yo{constructor(e={}){this.version=In.v3,this.originator=new Gi,this.keyEncryptionAlgorithm=new ln,this.recipientEncryptedKeys=new mu,Object.assign(this,e)}}p([g({type:v.Integer})],yo.prototype,"version",void 0);p([g({type:Gi,context:0})],yo.prototype,"originator",void 0);p([g({type:be,context:1,optional:!0})],yo.prototype,"ukm",void 0);p([g({type:ln})],yo.prototype,"keyEncryptionAlgorithm",void 0);p([g({type:mu})],yo.prototype,"recipientEncryptedKeys",void 0);let to=class{constructor(e={}){Object.assign(this,e)}};p([g({type:ri,context:0,implicit:!0})],to.prototype,"subjectKeyIdentifier",void 0);p([g({type:po})],to.prototype,"issuerAndSerialNumber",void 0);to=p([I({type:k.Choice})],to);class wc{constructor(e={}){this.version=In.v0,this.rid=new to,this.keyEncryptionAlgorithm=new ln,this.encryptedKey=new be,Object.assign(this,e)}}p([g({type:v.Integer})],wc.prototype,"version",void 0);p([g({type:to})],wc.prototype,"rid",void 0);p([g({type:ln})],wc.prototype,"keyEncryptionAlgorithm",void 0);p([g({type:be})],wc.prototype,"encryptedKey",void 0);class vc{constructor(e={}){this.keyIdentifier=new be,Object.assign(this,e)}}p([g({type:be})],vc.prototype,"keyIdentifier",void 0);p([g({type:v.GeneralizedTime,optional:!0})],vc.prototype,"date",void 0);p([g({type:zd,optional:!0})],vc.prototype,"other",void 0);class bc{constructor(e={}){this.version=In.v4,this.kekid=new vc,this.keyEncryptionAlgorithm=new ln,this.encryptedKey=new be,Object.assign(this,e)}}p([g({type:v.Integer})],bc.prototype,"version",void 0);p([g({type:vc})],bc.prototype,"kekid",void 0);p([g({type:ln})],bc.prototype,"keyEncryptionAlgorithm",void 0);p([g({type:be})],bc.prototype,"encryptedKey",void 0);class Ec{constructor(e={}){this.version=In.v0,this.keyEncryptionAlgorithm=new ln,this.encryptedKey=new be,Object.assign(this,e)}}p([g({type:v.Integer})],Ec.prototype,"version",void 0);p([g({type:Lf,context:0,optional:!0})],Ec.prototype,"keyDerivationAlgorithm",void 0);p([g({type:ln})],Ec.prototype,"keyEncryptionAlgorithm",void 0);p([g({type:be})],Ec.prototype,"encryptedKey",void 0);class t2{constructor(e={}){this.oriType="",this.oriValue=new ArrayBuffer(0),Object.assign(this,e)}}p([g({type:v.ObjectIdentifier})],t2.prototype,"oriType",void 0);p([g({type:v.Any})],t2.prototype,"oriValue",void 0);let ui=class{constructor(e={}){Object.assign(this,e)}};p([g({type:wc,optional:!0})],ui.prototype,"ktri",void 0);p([g({type:yo,context:1,implicit:!0,optional:!0})],ui.prototype,"kari",void 0);p([g({type:bc,context:2,implicit:!0,optional:!0})],ui.prototype,"kekri",void 0);p([g({type:Ec,context:3,implicit:!0,optional:!0})],ui.prototype,"pwri",void 0);p([g({type:t2,context:4,implicit:!0,optional:!0})],ui.prototype,"ori",void 0);ui=p([I({type:k.Choice})],ui);var Wf;let yu=Wf=class extends Oe{constructor(e){super(e),Object.setPrototypeOf(this,Wf.prototype)}};yu=Wf=p([I({type:k.Set,itemType:ui})],yu);var Gf;class Wd{constructor(e={}){this.otherRevInfoFormat="",this.otherRevInfo=new ArrayBuffer(0),Object.assign(this,e)}}p([g({type:v.ObjectIdentifier})],Wd.prototype,"otherRevInfoFormat",void 0);p([g({type:v.Any})],Wd.prototype,"otherRevInfo",void 0);let wu=class{constructor(e={}){this.other=new Wd,Object.assign(this,e)}};p([g({type:Wd,context:1,implicit:!0})],wu.prototype,"other",void 0);wu=p([I({type:k.Choice})],wu);let vu=Gf=class extends Oe{constructor(e){super(e),Object.setPrototypeOf(this,Gf.prototype)}};vu=Gf=p([I({type:k.Set,itemType:wu})],vu);class r2{constructor(e={}){Object.assign(this,e)}}p([g({type:gu,context:0,implicit:!0,optional:!0})],r2.prototype,"certs",void 0);p([g({type:vu,context:1,implicit:!0,optional:!0})],r2.prototype,"crls",void 0);var jf;let Qf=jf=class extends Oe{constructor(e){super(e),Object.setPrototypeOf(this,jf.prototype)}};Qf=jf=p([I({type:k.Set,itemType:go})],Qf);class Sc{constructor(e={}){this.version=In.v0,this.recipientInfos=new yu,this.encryptedContentInfo=new yc,Object.assign(this,e)}}p([g({type:v.Integer})],Sc.prototype,"version",void 0);p([g({type:r2,context:0,implicit:!0,optional:!0})],Sc.prototype,"originatorInfo",void 0);p([g({type:yu})],Sc.prototype,"recipientInfos",void 0);p([g({type:yc})],Sc.prototype,"encryptedContentInfo",void 0);p([g({type:Qf,context:1,implicit:!0,optional:!0})],Sc.prototype,"unprotectedAttrs",void 0);const iO="1.2.840.113549.1.7.2";var Yf;let bu=Yf=class extends Oe{constructor(e){super(e),Object.setPrototypeOf(this,Yf.prototype)}};bu=Yf=p([I({type:k.Set,itemType:Ka})],bu);class wo{constructor(e={}){this.version=In.v0,this.digestAlgorithms=new bu,this.encapContentInfo=new Hd,this.signerInfos=new hu,Object.assign(this,e)}}p([g({type:v.Integer})],wo.prototype,"version",void 0);p([g({type:bu})],wo.prototype,"digestAlgorithms",void 0);p([g({type:Hd})],wo.prototype,"encapContentInfo",void 0);p([g({type:gu,context:0,implicit:!0,optional:!0})],wo.prototype,"certificates",void 0);p([g({type:vu,context:1,implicit:!0,optional:!0})],wo.prototype,"crls",void 0);p([g({type:hu})],wo.prototype,"signerInfos",void 0);const ja="1.2.840.10045.2.1",n2="1.2.840.10045.4.1",S7="1.2.840.10045.4.3.1",i2="1.2.840.10045.4.3.2",s2="1.2.840.10045.4.3.3",o2="1.2.840.10045.4.3.4",Sm="1.2.840.10045.3.1.7",xm="1.3.132.0.34",Am="1.3.132.0.35";function xc(n){return new H({algorithm:n})}const sO=xc(n2);xc(S7);const oO=xc(i2),aO=xc(s2),cO=xc(o2);let Qa=class{constructor(e={}){Object.assign(this,e)}};p([g({type:v.ObjectIdentifier})],Qa.prototype,"fieldType",void 0);p([g({type:v.Any})],Qa.prototype,"parameters",void 0);Qa=p([I({type:k.Sequence})],Qa);class lO extends be{}let ro=class{constructor(e={}){Object.assign(this,e)}};p([g({type:v.OctetString})],ro.prototype,"a",void 0);p([g({type:v.OctetString})],ro.prototype,"b",void 0);p([g({type:v.BitString,optional:!0})],ro.prototype,"seed",void 0);ro=p([I({type:k.Sequence})],ro);var Xf;(function(n){n[n.ecpVer1=1]="ecpVer1"})(Xf||(Xf={}));let Cn=class{constructor(e={}){this.version=Xf.ecpVer1,Object.assign(this,e)}};p([g({type:v.Integer})],Cn.prototype,"version",void 0);p([g({type:Qa})],Cn.prototype,"fieldID",void 0);p([g({type:ro})],Cn.prototype,"curve",void 0);p([g({type:lO})],Cn.prototype,"base",void 0);p([g({type:v.Integer,converter:ze})],Cn.prototype,"order",void 0);p([g({type:v.Integer,optional:!0})],Cn.prototype,"cofactor",void 0);Cn=p([I({type:k.Sequence})],Cn);let di=class{constructor(e={}){Object.assign(this,e)}};p([g({type:v.ObjectIdentifier})],di.prototype,"namedCurve",void 0);p([g({type:v.Null})],di.prototype,"implicitCurve",void 0);p([g({type:Cn})],di.prototype,"specifiedCurve",void 0);di=p([I({type:k.Choice})],di);class Gd{constructor(e={}){this.version=1,this.privateKey=new be,Object.assign(this,e)}}p([g({type:v.Integer})],Gd.prototype,"version",void 0);p([g({type:be})],Gd.prototype,"privateKey",void 0);p([g({type:di,context:0,optional:!0})],Gd.prototype,"parameters",void 0);p([g({type:v.BitString,context:1,optional:!0})],Gd.prototype,"publicKey",void 0);class Eu{constructor(e={}){this.r=new ArrayBuffer(0),this.s=new ArrayBuffer(0),Object.assign(this,e)}}p([g({type:v.Integer,converter:ze})],Eu.prototype,"r",void 0);p([g({type:v.Integer,converter:ze})],Eu.prototype,"s",void 0);const sr="1.2.840.113549.1.1",ji=`${sr}.1`,uO=`${sr}.7`,dO=`${sr}.9`,va=`${sr}.10`,hO=`${sr}.2`,fO=`${sr}.4`,Su=`${sr}.5`,pO=`${sr}.14`,Zf=`${sr}.11`,xu=`${sr}.12`,Au=`${sr}.13`,x7=`${sr}.15`,A7=`${sr}.16`,ku="1.3.14.3.2.26",k7="2.16.840.1.101.3.4.2.4",_u="2.16.840.1.101.3.4.2.1",Iu="2.16.840.1.101.3.4.2.2",Cu="2.16.840.1.101.3.4.2.3",gO="2.16.840.1.101.3.4.2.5",mO="2.16.840.1.101.3.4.2.6",yO="1.2.840.113549.2.2",wO="1.2.840.113549.2.5",jd=`${sr}.8`;function ct(n){return new H({algorithm:n,parameters:null})}ct(yO);ct(wO);const Qi=ct(ku);ct(k7);ct(_u);ct(Iu);ct(Cu);ct(gO);ct(mO);const _7=new H({algorithm:jd,parameters:D.serialize(Qi)}),I7=new H({algorithm:dO,parameters:D.serialize(nu.toASN(new Uint8Array([218,57,163,238,94,107,75,13,50,85,191,239,149,96,24,144,175,216,7,9]).buffer))});ct(ji);ct(hO);ct(fO);ct(Su);ct(x7);ct(A7);ct(xu);ct(Au);ct(x7);ct(A7);class Qd{constructor(e={}){this.hashAlgorithm=new H(Qi),this.maskGenAlgorithm=new H({algorithm:jd,parameters:D.serialize(Qi)}),this.pSourceAlgorithm=new H(I7),Object.assign(this,e)}}p([g({type:H,context:0,defaultValue:Qi})],Qd.prototype,"hashAlgorithm",void 0);p([g({type:H,context:1,defaultValue:_7})],Qd.prototype,"maskGenAlgorithm",void 0);p([g({type:H,context:2,defaultValue:I7})],Qd.prototype,"pSourceAlgorithm",void 0);new H({algorithm:uO,parameters:D.serialize(new Qd)});class Yi{constructor(e={}){this.hashAlgorithm=new H(Qi),this.maskGenAlgorithm=new H({algorithm:jd,parameters:D.serialize(Qi)}),this.saltLength=20,this.trailerField=1,Object.assign(this,e)}}p([g({type:H,context:0,defaultValue:Qi})],Yi.prototype,"hashAlgorithm",void 0);p([g({type:H,context:1,defaultValue:_7})],Yi.prototype,"maskGenAlgorithm",void 0);p([g({type:v.Integer,context:2,defaultValue:20})],Yi.prototype,"saltLength",void 0);p([g({type:v.Integer,context:3,defaultValue:1})],Yi.prototype,"trailerField",void 0);new H({algorithm:va,parameters:D.serialize(new Yi)});class Yd{constructor(e={}){this.digestAlgorithm=new H,this.digest=new be,Object.assign(this,e)}}p([g({type:H})],Yd.prototype,"digestAlgorithm",void 0);p([g({type:be})],Yd.prototype,"digest",void 0);var Jf;class Xd{constructor(e={}){this.prime=new ArrayBuffer(0),this.exponent=new ArrayBuffer(0),this.coefficient=new ArrayBuffer(0),Object.assign(this,e)}}p([g({type:v.Integer,converter:ze})],Xd.prototype,"prime",void 0);p([g({type:v.Integer,converter:ze})],Xd.prototype,"exponent",void 0);p([g({type:v.Integer,converter:ze})],Xd.prototype,"coefficient",void 0);let e0=Jf=class extends Oe{constructor(e){super(e),Object.setPrototypeOf(this,Jf.prototype)}};e0=Jf=p([I({type:k.Sequence,itemType:Xd})],e0);class mn{constructor(e={}){this.version=0,this.modulus=new ArrayBuffer(0),this.publicExponent=new ArrayBuffer(0),this.privateExponent=new ArrayBuffer(0),this.prime1=new ArrayBuffer(0),this.prime2=new ArrayBuffer(0),this.exponent1=new ArrayBuffer(0),this.exponent2=new ArrayBuffer(0),this.coefficient=new ArrayBuffer(0),Object.assign(this,e)}}p([g({type:v.Integer})],mn.prototype,"version",void 0);p([g({type:v.Integer,converter:ze})],mn.prototype,"modulus",void 0);p([g({type:v.Integer,converter:ze})],mn.prototype,"publicExponent",void 0);p([g({type:v.Integer,converter:ze})],mn.prototype,"privateExponent",void 0);p([g({type:v.Integer,converter:ze})],mn.prototype,"prime1",void 0);p([g({type:v.Integer,converter:ze})],mn.prototype,"prime2",void 0);p([g({type:v.Integer,converter:ze})],mn.prototype,"exponent1",void 0);p([g({type:v.Integer,converter:ze})],mn.prototype,"exponent2",void 0);p([g({type:v.Integer,converter:ze})],mn.prototype,"coefficient",void 0);p([g({type:e0,optional:!0})],mn.prototype,"otherPrimeInfos",void 0);class a2{constructor(e={}){this.modulus=new ArrayBuffer(0),this.publicExponent=new ArrayBuffer(0),Object.assign(this,e)}}p([g({type:v.Integer,converter:ze})],a2.prototype,"modulus",void 0);p([g({type:v.Integer,converter:ze})],a2.prototype,"publicExponent",void 0);var t0;(function(n){n[n.Transient=0]="Transient",n[n.Singleton=1]="Singleton",n[n.ResolutionScoped=2]="ResolutionScoped",n[n.ContainerScoped=3]="ContainerScoped"})(t0||(t0={}));const Gt=t0;var vO="injectionTokens";function bO(n){var e=Reflect.getMetadata("design:paramtypes",n)||[],t=Reflect.getOwnMetadata(vO,n)||{};return Object.keys(t).forEach(function(r){e[+r]=t[r]}),e}function C7(n){return!!n.useClass}function r0(n){return!!n.useFactory}var T7=(function(){function n(e){this.wrap=e,this.reflectMethods=["get","getPrototypeOf","setPrototypeOf","getOwnPropertyDescriptor","defineProperty","has","set","deleteProperty","apply","construct","ownKeys"]}return n.prototype.createProxy=function(e){var t=this,r={},i=!1,s,o=function(){return i||(s=e(t.wrap()),i=!0),s};return new Proxy(r,this.createHandler(o))},n.prototype.createHandler=function(e){var t={},r=function(i){t[i]=function(){for(var s=[],o=0;o<arguments.length;o++)s[o]=arguments[o];s[0]=e();var a=Reflect[i];return a.apply(void 0,Ai(s))}};return this.reflectMethods.forEach(r),t},n})();function ms(n){return typeof n=="string"||typeof n=="symbol"}function EO(n){return typeof n=="object"&&"token"in n&&"multiple"in n}function km(n){return typeof n=="object"&&"token"in n&&"transform"in n}function SO(n){return typeof n=="function"||n instanceof T7}function fl(n){return!!n.useToken}function pl(n){return n.useValue!=null}function xO(n){return C7(n)||pl(n)||fl(n)||r0(n)}var c2=(function(){function n(){this._registryMap=new Map}return n.prototype.entries=function(){return this._registryMap.entries()},n.prototype.getAll=function(e){return this.ensure(e),this._registryMap.get(e)},n.prototype.get=function(e){this.ensure(e);var t=this._registryMap.get(e);return t[t.length-1]||null},n.prototype.set=function(e,t){this.ensure(e),this._registryMap.get(e).push(t)},n.prototype.setAll=function(e,t){this._registryMap.set(e,t)},n.prototype.has=function(e){return this.ensure(e),this._registryMap.get(e).length>0},n.prototype.clear=function(){this._registryMap.clear()},n.prototype.ensure=function(e){this._registryMap.has(e)||this._registryMap.set(e,[])},n})(),AO=(function(n){Y0(e,n);function e(){return n!==null&&n.apply(this,arguments)||this}return e})(c2),el=(function(){function n(){this.scopedResolutions=new Map}return n})();function kO(n,e){if(n===null)return"at position #"+e;var t=n.split(",")[e].trim();return'"'+t+'" at position #'+e}function _O(n,e,t){return t===void 0&&(t="    "),Ai([n],e.message.split(`
`).map(function(r){return t+r})).join(`
`)}function IO(n,e,t){var r=k1(n.toString().match(/constructor\(([\w, ]+)\)/)||[],2),i=r[1],s=i===void 0?null:i,o=kO(s,e);return _O("Cannot inject the dependency "+o+' of "'+n.name+'" constructor. Reason:',t)}function CO(n){if(typeof n.dispose!="function")return!1;var e=n.dispose;return!(e.length>0)}var TO=(function(n){Y0(e,n);function e(){return n!==null&&n.apply(this,arguments)||this}return e})(c2),RO=(function(n){Y0(e,n);function e(){return n!==null&&n.apply(this,arguments)||this}return e})(c2),PO=(function(){function n(){this.preResolution=new TO,this.postResolution=new RO}return n})(),R7=new Map,OO=(function(){function n(e){this.parent=e,this._registry=new AO,this.interceptors=new PO,this.disposed=!1,this.disposables=new Set}return n.prototype.register=function(e,t,r){r===void 0&&(r={lifecycle:Gt.Transient}),this.ensureNotDisposed();var i;if(xO(t)?i=t:i={useClass:t},fl(i))for(var s=[e],o=i;o!=null;){var a=o.useToken;if(s.includes(a))throw new Error("Token registration cycle detected! "+Ai(s,[a]).join(" -> "));s.push(a);var c=this._registry.get(a);c&&fl(c.provider)?o=c.provider:o=null}if((r.lifecycle===Gt.Singleton||r.lifecycle==Gt.ContainerScoped||r.lifecycle==Gt.ResolutionScoped)&&(pl(i)||r0(i)))throw new Error('Cannot use lifecycle "'+Gt[r.lifecycle]+'" with ValueProviders or FactoryProviders');return this._registry.set(e,{provider:i,options:r}),this},n.prototype.registerType=function(e,t){return this.ensureNotDisposed(),ms(t)?this.register(e,{useToken:t}):this.register(e,{useClass:t})},n.prototype.registerInstance=function(e,t){return this.ensureNotDisposed(),this.register(e,{useValue:t})},n.prototype.registerSingleton=function(e,t){if(this.ensureNotDisposed(),ms(e)){if(ms(t))return this.register(e,{useToken:t},{lifecycle:Gt.Singleton});if(t)return this.register(e,{useClass:t},{lifecycle:Gt.Singleton});throw new Error('Cannot register a type name as a singleton without a "to" token')}var r=e;return t&&!ms(t)&&(r=t),this.register(e,{useClass:r},{lifecycle:Gt.Singleton})},n.prototype.resolve=function(e,t,r){t===void 0&&(t=new el),r===void 0&&(r=!1),this.ensureNotDisposed();var i=this.getRegistration(e);if(!i&&ms(e)){if(r)return;throw new Error('Attempted to resolve unregistered dependency token: "'+e.toString()+'"')}if(this.executePreResolutionInterceptor(e,"Single"),i){var s=this.resolveRegistration(i,t);return this.executePostResolutionInterceptor(e,s,"Single"),s}if(SO(e)){var s=this.construct(e,t);return this.executePostResolutionInterceptor(e,s,"Single"),s}throw new Error("Attempted to construct an undefined constructor. Could mean a circular dependency problem. Try using `delay` function.")},n.prototype.executePreResolutionInterceptor=function(e,t){var r,i;if(this.interceptors.preResolution.has(e)){var s=[];try{for(var o=Oc(this.interceptors.preResolution.getAll(e)),a=o.next();!a.done;a=o.next()){var c=a.value;c.options.frequency!="Once"&&s.push(c),c.callback(e,t)}}catch(l){r={error:l}}finally{try{a&&!a.done&&(i=o.return)&&i.call(o)}finally{if(r)throw r.error}}this.interceptors.preResolution.setAll(e,s)}},n.prototype.executePostResolutionInterceptor=function(e,t,r){var i,s;if(this.interceptors.postResolution.has(e)){var o=[];try{for(var a=Oc(this.interceptors.postResolution.getAll(e)),c=a.next();!c.done;c=a.next()){var l=c.value;l.options.frequency!="Once"&&o.push(l),l.callback(e,t,r)}}catch(u){i={error:u}}finally{try{c&&!c.done&&(s=a.return)&&s.call(a)}finally{if(i)throw i.error}}this.interceptors.postResolution.setAll(e,o)}},n.prototype.resolveRegistration=function(e,t){if(this.ensureNotDisposed(),e.options.lifecycle===Gt.ResolutionScoped&&t.scopedResolutions.has(e))return t.scopedResolutions.get(e);var r=e.options.lifecycle===Gt.Singleton,i=e.options.lifecycle===Gt.ContainerScoped,s=r||i,o;return pl(e.provider)?o=e.provider.useValue:fl(e.provider)?o=s?e.instance||(e.instance=this.resolve(e.provider.useToken,t)):this.resolve(e.provider.useToken,t):C7(e.provider)?o=s?e.instance||(e.instance=this.construct(e.provider.useClass,t)):this.construct(e.provider.useClass,t):r0(e.provider)?o=e.provider.useFactory(this):o=this.construct(e.provider,t),e.options.lifecycle===Gt.ResolutionScoped&&t.scopedResolutions.set(e,o),o},n.prototype.resolveAll=function(e,t,r){var i=this;t===void 0&&(t=new el),r===void 0&&(r=!1),this.ensureNotDisposed();var s=this.getAllRegistrations(e);if(!s&&ms(e)){if(r)return[];throw new Error('Attempted to resolve unregistered dependency token: "'+e.toString()+'"')}if(this.executePreResolutionInterceptor(e,"All"),s){var o=s.map(function(c){return i.resolveRegistration(c,t)});return this.executePostResolutionInterceptor(e,o,"All"),o}var a=[this.construct(e,t)];return this.executePostResolutionInterceptor(e,a,"All"),a},n.prototype.isRegistered=function(e,t){return t===void 0&&(t=!1),this.ensureNotDisposed(),this._registry.has(e)||t&&(this.parent||!1)&&this.parent.isRegistered(e,!0)},n.prototype.reset=function(){this.ensureNotDisposed(),this._registry.clear(),this.interceptors.preResolution.clear(),this.interceptors.postResolution.clear()},n.prototype.clearInstances=function(){var e,t;this.ensureNotDisposed();try{for(var r=Oc(this._registry.entries()),i=r.next();!i.done;i=r.next()){var s=k1(i.value,2),o=s[0],a=s[1];this._registry.setAll(o,a.filter(function(c){return!pl(c.provider)}).map(function(c){return c.instance=void 0,c}))}}catch(c){e={error:c}}finally{try{i&&!i.done&&(t=r.return)&&t.call(r)}finally{if(e)throw e.error}}},n.prototype.createChildContainer=function(){var e,t;this.ensureNotDisposed();var r=new n(this);try{for(var i=Oc(this._registry.entries()),s=i.next();!s.done;s=i.next()){var o=k1(s.value,2),a=o[0],c=o[1];c.some(function(l){var u=l.options;return u.lifecycle===Gt.ContainerScoped})&&r._registry.setAll(a,c.map(function(l){return l.options.lifecycle===Gt.ContainerScoped?{provider:l.provider,options:l.options}:l}))}}catch(l){e={error:l}}finally{try{s&&!s.done&&(t=i.return)&&t.call(i)}finally{if(e)throw e.error}}return r},n.prototype.beforeResolution=function(e,t,r){r===void 0&&(r={frequency:"Always"}),this.interceptors.preResolution.set(e,{callback:t,options:r})},n.prototype.afterResolution=function(e,t,r){r===void 0&&(r={frequency:"Always"}),this.interceptors.postResolution.set(e,{callback:t,options:r})},n.prototype.dispose=function(){return rv(this,void 0,void 0,function(){var e;return nv(this,function(t){switch(t.label){case 0:return this.disposed=!0,e=[],this.disposables.forEach(function(r){var i=r.dispose();i&&e.push(i)}),[4,Promise.all(e)];case 1:return t.sent(),[2]}})})},n.prototype.getRegistration=function(e){return this.isRegistered(e)?this._registry.get(e):this.parent?this.parent.getRegistration(e):null},n.prototype.getAllRegistrations=function(e){return this.isRegistered(e)?this._registry.getAll(e):this.parent?this.parent.getAllRegistrations(e):null},n.prototype.construct=function(e,t){var r=this;if(e instanceof T7)return e.createProxy(function(s){return r.resolve(s,t)});var i=(function(){var s=R7.get(e);if(!s||s.length===0){if(e.length===0)return new e;throw new Error('TypeInfo not known for "'+e.name+'"')}var o=s.map(r.resolveParams(t,e));return new(e.bind.apply(e,Ai([void 0],o)))})();return CO(i)&&this.disposables.add(i),i},n.prototype.resolveParams=function(e,t){var r=this;return function(i,s){var o,a,c;try{return EO(i)?km(i)?i.multiple?(o=r.resolve(i.transform)).transform.apply(o,Ai([r.resolveAll(i.token,new el,i.isOptional)],i.transformArgs)):(a=r.resolve(i.transform)).transform.apply(a,Ai([r.resolve(i.token,e,i.isOptional)],i.transformArgs)):i.multiple?r.resolveAll(i.token,new el,i.isOptional):r.resolve(i.token,e,i.isOptional):km(i)?(c=r.resolve(i.transform,e)).transform.apply(c,Ai([r.resolve(i.token,e)],i.transformArgs)):r.resolve(i,e)}catch(l){throw new Error(IO(t,s,l))}}},n.prototype.ensureNotDisposed=function(){if(this.disposed)throw new Error("This container has been disposed, you cannot interact with a disposed container")},n})(),_t=new OO;function Zd(n){return function(e){R7.set(e,bO(e))}}if(typeof Reflect>"u"||!Reflect.getMetadata)throw new Error(`tsyringe requires a reflect polyfill. Please add 'import "reflect-metadata"' to the top of your entry point.`);var n0;class Jd{constructor(e={}){this.attrId="",this.attrValues=[],Object.assign(e)}}p([g({type:v.ObjectIdentifier})],Jd.prototype,"attrId",void 0);p([g({type:v.Any,repeated:"set"})],Jd.prototype,"attrValues",void 0);let _m=n0=class extends Oe{constructor(e){super(e),Object.setPrototypeOf(this,n0.prototype)}};_m=n0=p([I({type:k.Sequence,itemType:Jd})],_m);var i0;let Im=i0=class extends Oe{constructor(e){super(e),Object.setPrototypeOf(this,i0.prototype)}};Im=i0=p([I({type:k.Sequence,itemType:mo})],Im);class P7{constructor(e={}){this.certId="",this.certValue=new ArrayBuffer(0),Object.assign(this,e)}}p([g({type:v.ObjectIdentifier})],P7.prototype,"certId",void 0);p([g({type:v.Any,context:0})],P7.prototype,"certValue",void 0);class O7{constructor(e={}){this.crlId="",this.crltValue=new ArrayBuffer(0),Object.assign(this,e)}}p([g({type:v.ObjectIdentifier})],O7.prototype,"crlId",void 0);p([g({type:v.Any,context:0})],O7.prototype,"crltValue",void 0);class N7 extends be{}let eh=class{constructor(e={}){this.encryptionAlgorithm=new H,this.encryptedData=new N7,Object.assign(this,e)}};p([g({type:H})],eh.prototype,"encryptionAlgorithm",void 0);p([g({type:N7})],eh.prototype,"encryptedData",void 0);var s0,o0;(function(n){n[n.v1=0]="v1"})(o0||(o0={}));class D7 extends be{}let a0=s0=class extends Oe{constructor(e){super(e),Object.setPrototypeOf(this,s0.prototype)}};a0=s0=p([I({type:k.Sequence,itemType:_n})],a0);class Ac{constructor(e={}){this.version=o0.v1,this.privateKeyAlgorithm=new H,this.privateKey=new D7,Object.assign(this,e)}}p([g({type:v.Integer})],Ac.prototype,"version",void 0);p([g({type:H})],Ac.prototype,"privateKeyAlgorithm",void 0);p([g({type:D7})],Ac.prototype,"privateKey",void 0);p([g({type:a0,implicit:!0,context:0,optional:!0})],Ac.prototype,"attributes",void 0);let Cm=class extends Ac{};Cm=p([I({type:k.Sequence})],Cm);let Tm=class extends eh{};Tm=p([I({type:k.Sequence})],Tm);class L7{constructor(e={}){this.secretTypeId="",this.secretValue=new ArrayBuffer(0),Object.assign(this,e)}}p([g({type:v.ObjectIdentifier})],L7.prototype,"secretTypeId",void 0);p([g({type:v.Any,context:0})],L7.prototype,"secretValue",void 0);class kc{constructor(e={}){this.mac=new Yd,this.macSalt=new be,this.iterations=1,Object.assign(this,e)}}p([g({type:Yd})],kc.prototype,"mac",void 0);p([g({type:be})],kc.prototype,"macSalt",void 0);p([g({type:v.Integer,defaultValue:1})],kc.prototype,"iterations",void 0);class th{constructor(e={}){this.version=3,this.authSafe=new mo,this.macData=new kc,Object.assign(this,e)}}p([g({type:v.Integer})],th.prototype,"version",void 0);p([g({type:mo})],th.prototype,"authSafe",void 0);p([g({type:kc,optional:!0})],th.prototype,"macData",void 0);var c0;class rh{constructor(e={}){this.bagId="",this.bagValue=new ArrayBuffer(0),Object.assign(this,e)}}p([g({type:v.ObjectIdentifier})],rh.prototype,"bagId",void 0);p([g({type:v.Any,context:0})],rh.prototype,"bagValue",void 0);p([g({type:Jd,repeated:"set",optional:!0})],rh.prototype,"bagAttributes",void 0);let Rm=c0=class extends Oe{constructor(e){super(e),Object.setPrototypeOf(this,c0.prototype)}};Rm=c0=p([I({type:k.Sequence,itemType:rh})],Rm);var l0,u0,d0;const B7="1.2.840.113549.1.9",M7=`${B7}.7`,l2=`${B7}.14`;let Tu=class extends kt{constructor(e={}){super(e)}toString(){return this.ia5String||super.toString()}};p([g({type:v.IA5String})],Tu.prototype,"ia5String",void 0);Tu=p([I({type:k.Choice})],Tu);let Pm=class extends mo{};Pm=p([I({type:k.Sequence})],Pm);let Om=class extends th{};Om=p([I({type:k.Sequence})],Om);let Nm=class extends eh{};Nm=p([I({type:k.Sequence})],Nm);let h0=class{constructor(e=""){this.value=e}toString(){return this.value}};p([g({type:v.IA5String})],h0.prototype,"value",void 0);h0=p([I({type:k.Choice})],h0);let Dm=class extends Tu{};Dm=p([I({type:k.Choice})],Dm);let Lm=class extends kt{};Lm=p([I({type:k.Choice})],Lm);let f0=class{constructor(e=new Date){this.value=e}};p([g({type:v.GeneralizedTime})],f0.prototype,"value",void 0);f0=p([I({type:k.Choice})],f0);let Bm=class extends kt{};Bm=p([I({type:k.Choice})],Bm);let p0=class{constructor(e="M"){this.value=e}toString(){return this.value}};p([g({type:v.PrintableString})],p0.prototype,"value",void 0);p0=p([I({type:k.Choice})],p0);let Ru=class{constructor(e=""){this.value=e}toString(){return this.value}};p([g({type:v.PrintableString})],Ru.prototype,"value",void 0);Ru=p([I({type:k.Choice})],Ru);let Mm=class extends Ru{};Mm=p([I({type:k.Choice})],Mm);let Fm=class extends kt{};Fm=p([I({type:k.Choice})],Fm);let g0=class{constructor(e=""){this.value=e}toString(){return this.value}};p([g({type:v.ObjectIdentifier})],g0.prototype,"value",void 0);g0=p([I({type:k.Choice})],g0);let Um=class extends Et{};Um=p([I({type:k.Choice})],Um);let m0=class{constructor(e=0){this.value=e}toString(){return this.value.toString()}};p([g({type:v.Integer})],m0.prototype,"value",void 0);m0=p([I({type:k.Choice})],m0);let $m=class extends gn{};$m=p([I({type:k.Sequence})],$m);let Pu=class extends kt{};Pu=p([I({type:k.Choice})],Pu);let Vm=l0=class extends li{constructor(e){super(e),Object.setPrototypeOf(this,l0.prototype)}};Vm=l0=p([I({type:k.Sequence})],Vm);let qm=u0=class extends Oe{constructor(e){super(e),Object.setPrototypeOf(this,u0.prototype)}};qm=u0=p([I({type:k.Set,itemType:go})],qm);let y0=class{constructor(e=""){this.value=e}toString(){return this.value}};p([g({type:v.BmpString})],y0.prototype,"value",void 0);y0=p([I({type:k.Choice})],y0);let w0=class extends H{};w0=p([I({type:k.Sequence})],w0);let Hm=d0=class extends Oe{constructor(e){super(e),Object.setPrototypeOf(this,d0.prototype)}};Hm=d0=p([I({type:k.Sequence,itemType:w0})],Hm);var v0;let Ou=v0=class extends Oe{constructor(e){super(e),Object.setPrototypeOf(this,v0.prototype)}};Ou=v0=p([I({type:k.Sequence,itemType:_n})],Ou);class vo{constructor(e={}){this.version=0,this.subject=new et,this.subjectPKInfo=new Lr,this.attributes=new Ou,Object.assign(this,e)}}p([g({type:v.Integer})],vo.prototype,"version",void 0);p([g({type:et})],vo.prototype,"subject",void 0);p([g({type:Lr})],vo.prototype,"subjectPKInfo",void 0);p([g({type:Ou,implicit:!0,context:0})],vo.prototype,"attributes",void 0);class Ya{constructor(e={}){this.certificationRequestInfo=new vo,this.signatureAlgorithm=new H,this.signature=new ArrayBuffer(0),Object.assign(this,e)}}p([g({type:vo,raw:!0})],Ya.prototype,"certificationRequestInfo",void 0);p([g({type:H})],Ya.prototype,"signatureAlgorithm",void 0);p([g({type:v.BitString})],Ya.prototype,"signature",void 0);/*!
 * MIT License
 * 
 * Copyright (c) Peculiar Ventures. All rights reserved.
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 * 
 */const _c="crypto.algorithm";class NO{getAlgorithms(){return _t.resolveAll(_c)}toAsnAlgorithm(e){({...e});for(const t of this.getAlgorithms()){const r=t.toAsnAlgorithm(e);if(r)return r}if(/^[0-9.]+$/.test(e.name)){const t=new H({algorithm:e.name});if("parameters"in e){const r=e;t.parameters=r.parameters}return t}throw new Error("Cannot convert WebCrypto algorithm to ASN.1 algorithm")}toWebAlgorithm(e){for(const r of this.getAlgorithms()){const i=r.toWebAlgorithm(e);if(i)return i}return{name:e.algorithm,parameters:e.parameters}}}const Xi="crypto.algorithmProvider";_t.registerSingleton(Xi,NO);var gl;const or="1.3.36.3.3.2.8.1.1",zm=`${or}.1`,Km=`${or}.2`,Wm=`${or}.3`,Gm=`${or}.4`,jm=`${or}.5`,Qm=`${or}.6`,Ym=`${or}.7`,Xm=`${or}.8`,Zm=`${or}.9`,Jm=`${or}.10`,e4=`${or}.11`,t4=`${or}.12`,r4=`${or}.13`,n4=`${or}.14`,i4="brainpoolP160r1",s4="brainpoolP160t1",o4="brainpoolP192r1",a4="brainpoolP192t1",c4="brainpoolP224r1",l4="brainpoolP224t1",u4="brainpoolP256r1",d4="brainpoolP256t1",h4="brainpoolP320r1",f4="brainpoolP320t1",p4="brainpoolP384r1",g4="brainpoolP384t1",m4="brainpoolP512r1",y4="brainpoolP512t1",je="ECDSA";let Xa=gl=class{toAsnAlgorithm(e){switch(e.name.toLowerCase()){case je.toLowerCase():if("hash"in e)switch((typeof e.hash=="string"?e.hash:e.hash.name).toLowerCase()){case"sha-1":return sO;case"sha-256":return oO;case"sha-384":return aO;case"sha-512":return cO}else if("namedCurve"in e){let t="";switch(e.namedCurve){case"P-256":t=Sm;break;case"K-256":t=gl.SECP256K1;break;case"P-384":t=xm;break;case"P-521":t=Am;break;case i4:t=zm;break;case s4:t=Km;break;case o4:t=Wm;break;case a4:t=Gm;break;case c4:t=jm;break;case l4:t=Qm;break;case u4:t=Ym;break;case d4:t=Xm;break;case h4:t=Zm;break;case f4:t=Jm;break;case p4:t=e4;break;case g4:t=t4;break;case m4:t=r4;break;case y4:t=n4;break}if(t)return new H({algorithm:ja,parameters:D.serialize(new di({namedCurve:t}))})}}return null}toWebAlgorithm(e){switch(e.algorithm){case n2:return{name:je,hash:{name:"SHA-1"}};case i2:return{name:je,hash:{name:"SHA-256"}};case s2:return{name:je,hash:{name:"SHA-384"}};case o2:return{name:je,hash:{name:"SHA-512"}};case ja:{if(!e.parameters)throw new TypeError("Cannot get required parameters from EC algorithm");switch(D.parse(e.parameters,di).namedCurve){case Sm:return{name:je,namedCurve:"P-256"};case gl.SECP256K1:return{name:je,namedCurve:"K-256"};case xm:return{name:je,namedCurve:"P-384"};case Am:return{name:je,namedCurve:"P-521"};case zm:return{name:je,namedCurve:i4};case Km:return{name:je,namedCurve:s4};case Wm:return{name:je,namedCurve:o4};case Gm:return{name:je,namedCurve:a4};case jm:return{name:je,namedCurve:c4};case Qm:return{name:je,namedCurve:l4};case Ym:return{name:je,namedCurve:u4};case Xm:return{name:je,namedCurve:d4};case Zm:return{name:je,namedCurve:h4};case Jm:return{name:je,namedCurve:f4};case e4:return{name:je,namedCurve:p4};case t4:return{name:je,namedCurve:g4};case r4:return{name:je,namedCurve:m4};case n4:return{name:je,namedCurve:y4}}}}return null}};Xa.SECP256K1="1.3.132.0.10";Xa=gl=p([Zd()],Xa);_t.registerSingleton(_c,Xa);const F7=Symbol("name"),U7=Symbol("value");class _e{constructor(e,t={},r=""){this[F7]=e,this[U7]=r;for(const i in t)this[i]=t[i]}}_e.NAME=F7;_e.VALUE=U7;class DO{static toTextObject(e){const t=new _e("Algorithm Identifier",{},pi.toString(e.algorithm));if(e.parameters)switch(e.algorithm){case ja:{const r=new Xa().toWebAlgorithm(e);r&&"namedCurve"in r?t["Named Curve"]=r.namedCurve:t.Parameters=e.parameters;break}default:t.Parameters=e.parameters}return t}}class pi{static toString(e){const t=this.items[e];return t||e}}pi.items={[ku]:"sha1",[k7]:"sha224",[_u]:"sha256",[Iu]:"sha384",[Cu]:"sha512",[ji]:"rsaEncryption",[Su]:"sha1WithRSAEncryption",[pO]:"sha224WithRSAEncryption",[Zf]:"sha256WithRSAEncryption",[xu]:"sha384WithRSAEncryption",[Au]:"sha512WithRSAEncryption",[ja]:"ecPublicKey",[n2]:"ecdsaWithSHA1",[S7]:"ecdsaWithSHA224",[i2]:"ecdsaWithSHA256",[s2]:"ecdsaWithSHA384",[o2]:"ecdsaWithSHA512",[ZP]:"TLS WWW server authentication",[JP]:"TLS WWW client authentication",[eO]:"Code Signing",[tO]:"E-mail Protection",[rO]:"Time Stamping",[nO]:"OCSP Signing",[iO]:"Signed Data"};class Zi{static serialize(e){return this.serializeObj(e).join(`
`)}static pad(e=0){return"".padStart(2*e," ")}static serializeObj(e,t=0){const r=[];let i=this.pad(t++),s="";const o=e[_e.VALUE];o&&(s=` ${o}`),r.push(`${i}${e[_e.NAME]}:${s}`),i=this.pad(t);for(const a in e){if(typeof a=="symbol")continue;const c=e[a],l=a?`${a}: `:"";if(typeof c=="string"||typeof c=="number"||typeof c=="boolean")r.push(`${i}${l}${c}`);else if(c instanceof Date)r.push(`${i}${l}${c.toUTCString()}`);else if(Array.isArray(c))for(const u of c)u[_e.NAME]=a,r.push(...this.serializeObj(u,t));else if(c instanceof _e)c[_e.NAME]=a,r.push(...this.serializeObj(c,t));else if(L.isBufferSource(c))a?(r.push(`${i}${l}`),r.push(...this.serializeBufferSource(c,t+1))):r.push(...this.serializeBufferSource(c,t));else if("toTextObject"in c){const u=c.toTextObject();u[_e.NAME]=a,r.push(...this.serializeObj(u,t))}else throw new TypeError("Cannot serialize data in text format. Unsupported type.")}return r}static serializeBufferSource(e,t=0){const r=this.pad(t),i=L.toUint8Array(e),s=[];for(let o=0;o<i.length;){const a=[];for(let c=0;c<16&&o<i.length;c++){c===8&&a.push("");const l=i[o++].toString(16).padStart(2,"0");a.push(l)}s.push(`${r}${a.join(" ")}`)}return s}static serializeAlgorithm(e){return this.algorithmSerializer.toTextObject(e)}}Zi.oidSerializer=pi;Zi.algorithmSerializer=DO;var vs;class gi{get rawData(){return de(this,vs,"f")||We(this,vs,D.serialize(this.asn),"f"),de(this,vs,"f")}constructor(...e){vs.set(this,void 0),L.isBufferSource(e[0])?(this.asn=D.parse(e[0],e[1]),We(this,vs,L.toArrayBuffer(e[0]),"f"),this.onInit(this.asn)):(this.asn=e[0],this.onInit(this.asn))}equal(e){return e instanceof gi?my(e.rawData,this.rawData):!1}toString(e="text"){switch(e){case"asn":return D.toString(this.rawData);case"text":return Zi.serialize(this.toTextObject());case"hex":return Q.ToHex(this.rawData);case"base64":return Q.ToBase64(this.rawData);case"base64url":return Q.ToBase64Url(this.rawData);default:throw TypeError("Argument 'format' is unsupported value")}}getTextName(){return this.constructor.NAME}toTextObject(){const e=this.toTextObjectEmpty();return e[""]=this.rawData,e}toTextObjectEmpty(e){return new _e(this.getTextName(),{},e)}}vs=new WeakMap;gi.NAME="ASN";class vr extends gi{constructor(...e){let t;L.isBufferSource(e[0])?t=L.toArrayBuffer(e[0]):t=D.serialize(new kr({extnID:e[0],critical:e[1],extnValue:new be(L.toArrayBuffer(e[2]))})),super(t,kr)}onInit(e){this.type=e.extnID,this.critical=e.critical,this.value=e.extnValue.buffer}toTextObject(){const e=this.toTextObjectWithoutValue();return e[""]=this.value,e}toTextObjectWithoutValue(){const e=this.toTextObjectEmpty(this.critical?"critical":void 0);return e[_e.NAME]===vr.NAME&&(e[_e.NAME]=pi.toString(this.type)),e}}var $7;class Qn{static isCryptoKeyPair(e){return e&&e.privateKey&&e.publicKey}static isCryptoKey(e){return e&&e.usages&&e.type&&e.algorithm&&e.extractable!==void 0}constructor(){this.items=new Map,this[$7]="CryptoProvider",typeof self<"u"&&typeof crypto<"u"?this.set(Qn.DEFAULT,crypto):typeof global<"u"&&global.crypto&&global.crypto.subtle&&this.set(Qn.DEFAULT,global.crypto)}clear(){this.items.clear()}delete(e){return this.items.delete(e)}forEach(e,t){return this.items.forEach(e,t)}has(e){return this.items.has(e)}get size(){return this.items.size}entries(){return this.items.entries()}keys(){return this.items.keys()}values(){return this.items.values()}[Symbol.iterator](){return this.items[Symbol.iterator]()}get(e=Qn.DEFAULT){const t=this.items.get(e.toLowerCase());if(!t)throw new Error(`Cannot get Crypto by name '${e}'`);return t}set(e,t){if(typeof e=="string"){if(!t)throw new TypeError("Argument 'value' is required");this.items.set(e.toLowerCase(),t)}else this.items.set(Qn.DEFAULT,e);return this}}$7=Symbol.toStringTag;Qn.DEFAULT="default";const dt=new Qn,LO=/^[0-2](?:\.[1-9][0-9]*)+$/;function BO(n){return new RegExp(LO).test(n)}class V7{constructor(e={}){this.items={};for(const t in e)this.register(t,e[t])}get(e){return this.items[e]||null}findId(e){return BO(e)?e:this.get(e)}register(e,t){this.items[e]=t,this.items[t]=e}}const nr=new V7;nr.register("CN","2.5.4.3");nr.register("L","2.5.4.7");nr.register("ST","2.5.4.8");nr.register("O","2.5.4.10");nr.register("OU","2.5.4.11");nr.register("C","2.5.4.6");nr.register("DC","0.9.2342.19200300.100.1.25");nr.register("E","1.2.840.113549.1.9.1");nr.register("G","2.5.4.42");nr.register("I","2.5.4.43");nr.register("SN","2.5.4.4");nr.register("T","2.5.4.12");function MO(n,e){return`\\${Q.ToHex(Q.FromUtf8String(e)).toUpperCase()}`}function FO(n){return n.replace(/([,+"\\<>;])/g,"\\$1").replace(/^([ #])/,"\\$1").replace(/([ ]$)/,"\\$1").replace(/([\r\n\t])/,MO)}class Br{static isASCII(e){for(let t=0;t<e.length;t++)if(e.charCodeAt(t)>255)return!1;return!0}static isPrintableString(e){return/^[A-Za-z0-9 '()+,-./:=?]*$/g.test(e)}constructor(e,t={}){this.extraNames=new V7,this.asn=new et;for(const r in t)if(Object.prototype.hasOwnProperty.call(t,r)){const i=t[r];this.extraNames.register(r,i)}typeof e=="string"?this.asn=this.fromString(e):e instanceof et?this.asn=e:L.isBufferSource(e)?this.asn=D.parse(e,et):this.asn=this.fromJSON(e)}getField(e){const t=this.extraNames.findId(e)||nr.findId(e),r=[];for(const i of this.asn)for(const s of i)s.type===t&&r.push(s.value.toString());return r}getName(e){return this.extraNames.get(e)||nr.get(e)}toString(){return this.asn.map(e=>e.map(t=>{const r=this.getName(t.type)||t.type,i=t.value.anyValue?`#${Q.ToHex(t.value.anyValue)}`:FO(t.value.toString());return`${r}=${i}`}).join("+")).join(", ")}toJSON(){var e;const t=[];for(const r of this.asn){const i={};for(const s of r){const o=this.getName(s.type)||s.type;(e=i[o])!==null&&e!==void 0||(i[o]=[]),i[o].push(s.value.anyValue?`#${Q.ToHex(s.value.anyValue)}`:s.value.toString())}t.push(i)}return t}fromString(e){const t=new et,r=/(\d\.[\d.]*\d|[A-Za-z]+)=((?:"")|(?:".*?[^\\]")|(?:[^,+"\\](?=[,+]|$))|(?:[^,+].*?(?:[^\\][,+]))|(?:))([,+])?/g;let i=null,s=",";for(;i=r.exec(`${e},`);){let[,o,a]=i;const c=a[a.length-1];(c===","||c==="+")&&(a=a.slice(0,a.length-1),i[3]=c);const l=i[3];o=this.getTypeOid(o);const u=this.createAttribute(o,a);s==="+"?t[t.length-1].push(u):t.push(new Qs([u])),s=l}return t}fromJSON(e){const t=new et;for(const r of e){const i=new Qs;for(const s in r){const o=this.getTypeOid(s),a=r[s];for(const c of a){const l=this.createAttribute(o,c);i.push(l)}}t.push(i)}return t}getTypeOid(e){if(/[\d.]+/.test(e)||(e=this.getName(e)||""),!e)throw new Error(`Cannot get OID for name type '${e}'`);return e}createAttribute(e,t){const r=new Od({type:e});if(typeof t=="object")for(const i in t)switch(i){case"ia5String":r.value.ia5String=t[i];break;case"utf8String":r.value.utf8String=t[i];break;case"universalString":r.value.universalString=t[i];break;case"bmpString":r.value.bmpString=t[i];break;case"printableString":r.value.printableString=t[i];break}else if(t[0]==="#")r.value.anyValue=Q.FromHex(t.slice(1));else{const i=this.processStringValue(t);e===this.getName("E")||e===this.getName("DC")?r.value.ia5String=i:Br.isPrintableString(i)?r.value.printableString=i:r.value.utf8String=i}return r}processStringValue(e){const t=/"(.*?[^\\])?"/.exec(e);return t&&(e=t[1]),e.replace(/\\0a/ig,`
`).replace(/\\0d/ig,"\r").replace(/\\0g/ig,"	").replace(/\\(.)/g,"$1")}toArrayBuffer(){return D.serialize(this.asn)}async getThumbprint(...e){var t;let r,i="SHA-1";return e.length>=1&&!(!((t=e[0])===null||t===void 0)&&t.subtle)?(i=e[0]||i,r=e[1]||dt.get()):r=e[0]||dt.get(),await r.subtle.digest(i,this.toArrayBuffer())}}const q7="Cannot initialize GeneralName from ASN.1 data.",w4=`${q7} Unsupported string format in use.`,UO=`${q7} Value doesn't match to GUID regular expression.`,v4=/^([0-9a-f]{8})-?([0-9a-f]{4})-?([0-9a-f]{4})-?([0-9a-f]{4})-?([0-9a-f]{12})$/i,b4="1.3.6.1.4.1.311.25.1",E4="1.3.6.1.4.1.311.20.2.3",Jh="dns",e1="dn",t1="email",r1="ip",n1="url",i1="guid",s1="upn",tl="id";class Yn extends gi{constructor(...e){let t;if(e.length===2)switch(e[0]){case e1:{const r=new Br(e[1]).toArrayBuffer(),i=D.parse(r,et);t=new le({directoryName:i});break}case Jh:t=new le({dNSName:e[1]});break;case t1:t=new le({rfc822Name:e[1]});break;case i1:{const r=new RegExp(v4,"i").exec(e[1]);if(!r)throw new Error("Cannot parse GUID value. Value doesn't match to regular expression");const i=r.slice(1).map((s,o)=>o<3?Q.ToHex(new Uint8Array(Q.FromHex(s)).reverse()):s).join("");t=new le({otherName:new za({typeId:b4,value:D.serialize(new be(Q.FromHex(i)))})});break}case r1:t=new le({iPAddress:e[1]});break;case tl:t=new le({registeredID:e[1]});break;case s1:{t=new le({otherName:new za({typeId:E4,value:D.serialize(i7.toASN(e[1]))})});break}case n1:t=new le({uniformResourceIdentifier:e[1]});break;default:throw new Error("Cannot create GeneralName. Unsupported type of the name")}else L.isBufferSource(e[0])?t=D.parse(e[0],le):t=e[0];super(t)}onInit(e){if(e.dNSName!=null)this.type=Jh,this.value=e.dNSName;else if(e.rfc822Name!=null)this.type=t1,this.value=e.rfc822Name;else if(e.iPAddress!=null)this.type=r1,this.value=e.iPAddress;else if(e.uniformResourceIdentifier!=null)this.type=n1,this.value=e.uniformResourceIdentifier;else if(e.registeredID!=null)this.type=tl,this.value=e.registeredID;else if(e.directoryName!=null)this.type=e1,this.value=new Br(e.directoryName).toString();else if(e.otherName!=null)if(e.otherName.typeId===b4){this.type=i1;const t=D.parse(e.otherName.value,be),r=new RegExp(v4,"i").exec(Q.ToHex(t));if(!r)throw new Error(UO);this.value=r.slice(1).map((i,s)=>s<3?Q.ToHex(new Uint8Array(Q.FromHex(i)).reverse()):i).join("-")}else if(e.otherName.typeId===E4)this.type=s1,this.value=D.parse(e.otherName.value,kt).toString();else throw new Error(w4);else throw new Error(w4)}toJSON(){return{type:this.type,value:this.value}}toTextObject(){let e;switch(this.type){case e1:case Jh:case i1:case r1:case tl:case s1:case n1:e=this.type.toUpperCase();break;case t1:e="Email";break;default:throw new Error("Unsupported GeneralName type")}let t=this.value;return this.type===tl&&(t=pi.toString(t)),new _e(e,void 0,t)}}class Ji extends gi{constructor(e){let t;if(e instanceof Pt)t=e;else if(Array.isArray(e)){const r=[];for(const i of e)if(i instanceof le)r.push(i);else{const s=D.parse(new Yn(i.type,i.value).rawData,le);r.push(s)}t=new Pt(r)}else if(L.isBufferSource(e))t=D.parse(e,Pt);else throw new Error("Cannot initialize GeneralNames. Incorrect incoming arguments");super(t)}onInit(e){const t=[];for(const r of e){let i=null;try{i=new Yn(r)}catch{continue}t.push(i)}this.items=t}toJSON(){return this.items.map(e=>e.toJSON())}toTextObject(){const e=super.toTextObjectEmpty();for(const t of this.items){const r=t.toTextObject();let i=e[r[_e.NAME]];Array.isArray(i)||(i=[],e[r[_e.NAME]]=i),i.push(r)}return e}}Ji.NAME="GeneralNames";const ba="-{5}",Za="\\n",$O=`[^${Za}]+`,VO=`${ba}BEGIN (${$O}(?=${ba}))${ba}`,qO=`${ba}END \\1${ba}`,no="\\n",HO=`[^:${Za}]+`,zO=`(?:[^${Za}]+${no}(?: +[^${Za}]+${no})*)`,KO="[a-zA-Z0-9=+/]+",WO=`(?:${KO}${no})+`,S4=`${VO}${no}(?:((?:${HO}: ${zO})+))?${no}?(${WO})${qO}`;class dr{static isPem(e){return typeof e=="string"&&new RegExp(S4,"g").test(e.replace(/\r/g,""))}static decodeWithHeaders(e){e=e.replace(/\r/g,"");const t=new RegExp(S4,"g"),r=[];let i=null;for(;i=t.exec(e);){const s=i[3].replace(new RegExp(`[${Za}]+`,"g"),""),o={type:i[1],headers:[],rawData:Q.FromBase64(s)},a=i[2];if(a){const c=a.split(new RegExp(no,"g"));let l=null;for(const u of c){const[d,h]=u.split(/:(.*)/);if(h===void 0){if(!l)throw new Error("Cannot parse PEM string. Incorrect header value");l.value+=d.trim()}else l&&o.headers.push(l),l={key:d,value:h.trim()}}l&&o.headers.push(l)}r.push(o)}return r}static decode(e){return this.decodeWithHeaders(e).map(r=>r.rawData)}static decodeFirst(e){const t=this.decode(e);if(!t.length)throw new RangeError("PEM string doesn't contain any objects");return t[0]}static encode(e,t){if(Array.isArray(e)){const r=new Array;return t?e.forEach(i=>{if(!L.isBufferSource(i))throw new TypeError("Cannot encode array of BufferSource in PEM format. Not all items of the array are BufferSource");r.push(this.encodeStruct({type:t,rawData:L.toArrayBuffer(i)}))}):e.forEach(i=>{if(!("type"in i))throw new TypeError("Cannot encode array of PemStruct in PEM format. Not all items of the array are PemStrut");r.push(this.encodeStruct(i))}),r.join(`
`)}else{if(!t)throw new Error("Required argument 'tag' is missed");return this.encodeStruct({type:t,rawData:L.toArrayBuffer(e)})}}static encodeStruct(e){var t;const r=e.type.toLocaleUpperCase(),i=[];if(i.push(`-----BEGIN ${r}-----`),!((t=e.headers)===null||t===void 0)&&t.length){for(const l of e.headers)i.push(`${l.key}: ${l.value}`);i.push("")}const s=Q.ToBase64(e.rawData);let o,a=0;const c=Array();for(;a<s.length&&(s.length-a<64?o=s.substring(a):(o=s.substring(a,a+64),a+=64),o.length!==0);)if(c.push(o),o.length<64)break;return i.push(...c),i.push(`-----END ${r}-----`),i.join(`
`)}}dr.CertificateTag="CERTIFICATE";dr.CrlTag="CRL";dr.CertificateRequestTag="CERTIFICATE REQUEST";dr.PublicKeyTag="PUBLIC KEY";dr.PrivateKeyTag="PRIVATE KEY";class Tn extends gi{static isAsnEncoded(e){return L.isBufferSource(e)||typeof e=="string"}static toArrayBuffer(e){if(typeof e=="string"){if(dr.isPem(e))return dr.decode(e)[0];if(Q.isHex(e))return Q.FromHex(e);if(Q.isBase64(e))return Q.FromBase64(e);if(Q.isBase64Url(e))return Q.FromBase64Url(e);throw new TypeError("Unsupported format of 'raw' argument. Must be one of DER, PEM, HEX, Base64, or Base4Url")}else{const t=L.toUint8Array(e);if(t.length>0&&t[0]===48)return L.toArrayBuffer(e);const r=Q.ToBinary(e);if(dr.isPem(r))return dr.decode(r)[0];if(Q.isHex(r))return Q.FromHex(r);if(Q.isBase64(r))return Q.FromBase64(r);if(Q.isBase64Url(r))return Q.FromBase64Url(r);throw new TypeError("Unsupported format of 'raw' argument. Must be one of DER, PEM, HEX, Base64, or Base4Url")}}constructor(...e){Tn.isAsnEncoded(e[0])?super(Tn.toArrayBuffer(e[0]),e[1]):super(e[0])}toString(e="pem"){switch(e){case"pem":return dr.encode(this.rawData,this.tag);default:return super.toString(e)}}}class Ur extends Tn{static async create(e,t=dt.get()){if(e instanceof Ur)return e;if(Qn.isCryptoKey(e)){if(e.type!=="public")throw new TypeError("Public key is required");const r=await t.subtle.exportKey("spki",e);return new Ur(r)}else{if(e.publicKey)return e.publicKey;if(L.isBufferSource(e))return new Ur(e);throw new TypeError("Unsupported PublicKeyType")}}constructor(e){Tn.isAsnEncoded(e)?super(e,Lr):super(e),this.tag=dr.PublicKeyTag}async export(...e){let t,r=["verify"],i={hash:"SHA-256",...this.algorithm};e.length>1?(i=e[0]||i,r=e[1]||r,t=e[2]||dt.get()):t=e[0]||dt.get();let s=this.rawData;const o=D.parse(this.rawData,Lr);return o.algorithm.algorithm===va&&(s=GO(o,s)),t.subtle.importKey("spki",s,i,!0,r)}onInit(e){const t=_t.resolve(Xi),r=this.algorithm=t.toWebAlgorithm(e.algorithm);switch(e.algorithm.algorithm){case ji:{const i=D.parse(e.subjectPublicKey,a2),s=L.toUint8Array(i.modulus);r.publicExponent=L.toUint8Array(i.publicExponent),r.modulusLength=(s[0]?s:s.slice(1)).byteLength<<3;break}}}async getThumbprint(...e){var t;let r,i="SHA-1";return e.length>=1&&!(!((t=e[0])===null||t===void 0)&&t.subtle)?(i=e[0]||i,r=e[1]||dt.get()):r=e[0]||dt.get(),await r.subtle.digest(i,this.rawData)}async getKeyIdentifier(...e){let t,r="SHA-1";e.length===1?typeof e[0]=="string"?(r=e[0],t=dt.get()):t=e[0]:e.length===2?(r=e[0],t=e[1]):t=dt.get();const i=D.parse(this.rawData,Lr);return await t.subtle.digest(r,i.subjectPublicKey)}toTextObject(){const e=this.toTextObjectEmpty(),t=D.parse(this.rawData,Lr);switch(e.Algorithm=Zi.serializeAlgorithm(t.algorithm),t.algorithm.algorithm){case ja:e["EC Point"]=t.subjectPublicKey;break;case ji:default:e["Raw Data"]=t.subjectPublicKey}return e}}function GO(n,e){return n.algorithm=new H({algorithm:ji,parameters:null}),e=D.serialize(n),e}class Ja extends vr{static async create(e,t=!1,r=dt.get()){if("name"in e&&"serialNumber"in e)return new Ja(e,t);const s=await(await Ur.create(e,r)).getKeyIdentifier(r);return new Ja(Q.ToHex(s),t)}constructor(...e){if(L.isBufferSource(e[0]))super(e[0]);else if(typeof e[0]=="string"){const t=new Pi({keyIdentifier:new qp(Q.FromHex(e[0]))});super(mf,e[1],D.serialize(t))}else{const t=e[0],r=t.name instanceof Ji?D.parse(t.name.rawData,Pt):t.name,i=new Pi({authorityCertIssuer:r,authorityCertSerialNumber:Q.FromHex(t.serialNumber)});super(mf,e[1],D.serialize(i))}}onInit(e){super.onInit(e);const t=D.parse(e.extnValue,Pi);t.keyIdentifier&&(this.keyId=Q.ToHex(t.keyIdentifier)),(t.authorityCertIssuer||t.authorityCertSerialNumber)&&(this.certId={name:t.authorityCertIssuer||[],serialNumber:t.authorityCertSerialNumber?Q.ToHex(t.authorityCertSerialNumber):""})}toTextObject(){const e=this.toTextObjectWithoutValue(),t=D.parse(this.value,Pi);return t.authorityCertIssuer&&(e["Authority Issuer"]=new Ji(t.authorityCertIssuer).toTextObject()),t.authorityCertSerialNumber&&(e["Authority Serial Number"]=t.authorityCertSerialNumber),t.keyIdentifier&&(e[""]=t.keyIdentifier),e}}Ja.NAME="Authority Key Identifier";class u2 extends vr{constructor(...e){if(L.isBufferSource(e[0])){super(e[0]);const t=D.parse(this.value,iu);this.ca=t.cA,this.pathLength=t.pathLenConstraint}else{const t=new iu({cA:e[0],pathLenConstraint:e[1]});super(o7,e[2],D.serialize(t)),this.ca=e[0],this.pathLength=e[1]}}toTextObject(){const e=this.toTextObjectWithoutValue();return this.ca&&(e.CA=this.ca),this.pathLength!==void 0&&(e["Path Length"]=this.pathLength),e}}u2.NAME="Basic Constraints";var x4;(function(n){n.serverAuth="1.3.6.1.5.5.7.3.1",n.clientAuth="1.3.6.1.5.5.7.3.2",n.codeSigning="1.3.6.1.5.5.7.3.3",n.emailProtection="1.3.6.1.5.5.7.3.4",n.timeStamping="1.3.6.1.5.5.7.3.8",n.ocspSigning="1.3.6.1.5.5.7.3.9"})(x4||(x4={}));class H7 extends vr{constructor(...e){if(L.isBufferSource(e[0])){super(e[0]);const t=D.parse(this.value,cu);this.usages=t.map(r=>r)}else{const t=new cu(e[0]);super(l7,e[1],D.serialize(t)),this.usages=e[0]}}toTextObject(){const e=this.toTextObjectWithoutValue();return e[""]=this.usages.map(t=>pi.toString(t)).join(", "),e}}H7.NAME="Extended Key Usages";var A4;(function(n){n[n.digitalSignature=1]="digitalSignature",n[n.nonRepudiation=2]="nonRepudiation",n[n.keyEncipherment=4]="keyEncipherment",n[n.dataEncipherment=8]="dataEncipherment",n[n.keyAgreement=16]="keyAgreement",n[n.keyCertSign=32]="keyCertSign",n[n.cRLSign=64]="cRLSign",n[n.encipherOnly=128]="encipherOnly",n[n.decipherOnly=256]="decipherOnly"})(A4||(A4={}));class z7 extends vr{constructor(...e){if(L.isBufferSource(e[0])){super(e[0]);const t=D.parse(this.value,Zh);this.usages=t.toNumber()}else{const t=new Zh(e[0]);super(d7,e[1],D.serialize(t)),this.usages=e[0]}}toTextObject(){const e=this.toTextObjectWithoutValue(),t=D.parse(this.value,Zh);return e[""]=t.toJSON().join(", "),e}}z7.NAME="Key Usages";class nh extends vr{static async create(e,t=!1,r=dt.get()){const s=await(await Ur.create(e,r)).getKeyIdentifier(r);return new nh(Q.ToHex(s),t)}constructor(...e){if(L.isBufferSource(e[0])){super(e[0]);const t=D.parse(this.value,ri);this.keyId=Q.ToHex(t)}else{const t=typeof e[0]=="string"?Q.FromHex(e[0]):e[0],r=new ri(t);super(g7,e[1],D.serialize(r)),this.keyId=Q.ToHex(t)}}toTextObject(){const e=this.toTextObjectWithoutValue(),t=D.parse(this.value,ri);return e[""]=t,e}}nh.NAME="Subject Key Identifier";class K7 extends vr{constructor(...e){L.isBufferSource(e[0])?super(e[0]):super(p7,e[1],new Ji(e[0]||[]).rawData)}onInit(e){super.onInit(e);const t=D.parse(e.extnValue,Pf);this.names=new Ji(t)}toTextObject(){const e=this.toTextObjectWithoutValue(),t=this.names.toTextObject();for(const r in t)e[r]=t[r];return e}}K7.NAME="Subject Alternative Name";class br{static register(e,t){this.items.set(e,t)}static create(e){const t=new vr(e),r=this.items.get(t.type);return r?new r(e):t}}br.items=new Map;class W7 extends vr{constructor(...e){var t;if(L.isBufferSource(e[0])){super(e[0]);const r=D.parse(this.value,ou);this.policies=r.map(i=>i.policyIdentifier)}else{const r=e[0],i=(t=e[1])!==null&&t!==void 0?t:!1,s=new ou(r.map(o=>new Dd({policyIdentifier:o})));super(a7,i,D.serialize(s)),this.policies=r}}toTextObject(){const e=this.toTextObjectWithoutValue();return e.Policy=this.policies.map(t=>new _e("",{},pi.toString(t))),e}}W7.NAME="Certificate Policies";br.register(a7,W7);class G7 extends vr{constructor(...e){var t;if(L.isBufferSource(e[0]))super(e[0]);else if(Array.isArray(e[0])&&typeof e[0][0]=="string"){const i=e[0].map(o=>new fo({distributionPoint:new zi({fullName:[new le({uniformResourceIdentifier:o})]})})),s=new Ps(i);super(Ef,e[1],D.serialize(s))}else{const r=new Ps(e[0]);super(Ef,e[1],D.serialize(r))}(t=this.distributionPoints)!==null&&t!==void 0||(this.distributionPoints=[])}onInit(e){super.onInit(e);const t=D.parse(e.extnValue,Ps);this.distributionPoints=t}toTextObject(){const e=this.toTextObjectWithoutValue();return e["Distribution Point"]=this.distributionPoints.map(t=>{var r;const i={};return t.distributionPoint&&(i[""]=(r=t.distributionPoint.fullName)===null||r===void 0?void 0:r.map(s=>new Yn(s).toString()).join(", ")),t.reasons&&(i.Reasons=t.reasons.toString()),t.cRLIssuer&&(i["CRL Issuer"]=t.cRLIssuer.map(s=>s.toString()).join(", ")),i}),e}}G7.NAME="CRL Distribution Points";class j7 extends vr{constructor(...e){var t,r,i,s;if(L.isBufferSource(e[0]))super(e[0]);else if(e[0]instanceof As){const o=new As(e[0]);super(gf,e[1],D.serialize(o))}else{const o=e[0],a=new As;nl(a,o,am,"ocsp"),nl(a,o,cm,"caIssuers"),nl(a,o,lm,"timeStamping"),nl(a,o,um,"caRepository"),super(gf,e[1],D.serialize(a))}(t=this.ocsp)!==null&&t!==void 0||(this.ocsp=[]),(r=this.caIssuers)!==null&&r!==void 0||(this.caIssuers=[]),(i=this.timeStamping)!==null&&i!==void 0||(this.timeStamping=[]),(s=this.caRepository)!==null&&s!==void 0||(this.caRepository=[])}onInit(e){super.onInit(e),this.ocsp=[],this.caIssuers=[],this.timeStamping=[],this.caRepository=[],D.parse(e.extnValue,As).forEach(r=>{switch(r.accessMethod){case am:this.ocsp.push(new Yn(r.accessLocation));break;case cm:this.caIssuers.push(new Yn(r.accessLocation));break;case lm:this.timeStamping.push(new Yn(r.accessLocation));break;case um:this.caRepository.push(new Yn(r.accessLocation));break}})}toTextObject(){const e=this.toTextObjectWithoutValue();return this.ocsp.length&&rl(e,"OCSP",this.ocsp),this.caIssuers.length&&rl(e,"CA Issuers",this.caIssuers),this.timeStamping.length&&rl(e,"Time Stamping",this.timeStamping),this.caRepository.length&&rl(e,"CA Repository",this.caRepository),e}}j7.NAME="Authority Info Access";function rl(n,e,t){if(t.length===1)n[e]=t[0].toTextObject();else{const r=new _e("");t.forEach((i,s)=>{const o=i.toTextObject(),a=`${o[_e.NAME]} ${s+1}`;let c=r[a];Array.isArray(c)||(c=[],r[a]=c),c.push(o)}),n[e]=r}}function nl(n,e,t,r){const i=e[r];i&&(Array.isArray(i)?i:[i]).forEach(o=>{typeof o=="string"&&(o=new Yn("url",o)),n.push(new pc({accessMethod:t,accessLocation:D.parse(o.rawData,le)}))})}class Q7 extends vr{constructor(...e){L.isBufferSource(e[0])?super(e[0]):super(u7,e[1],new Ji(e[0]||[]).rawData)}onInit(e){super.onInit(e);const t=D.parse(e.extnValue,Pt);this.names=new Ji(t)}toTextObject(){const e=this.toTextObjectWithoutValue(),t=this.names.toTextObject();for(const r in t)e[r]=t[r];return e}}Q7.NAME="Issuer Alternative Name";class bo extends gi{constructor(...e){let t;if(L.isBufferSource(e[0]))t=L.toArrayBuffer(e[0]);else{const r=e[0],i=Array.isArray(e[1])?e[1].map(s=>L.toArrayBuffer(s)):[];t=D.serialize(new _n({type:r,values:i}))}super(t,_n)}onInit(e){this.type=e.type,this.values=e.values}toTextObject(){const e=this.toTextObjectWithoutValue();return e.Value=this.values.map(t=>new _e("",{"":t})),e}toTextObjectWithoutValue(){const e=this.toTextObjectEmpty();return e[_e.NAME]===bo.NAME&&(e[_e.NAME]=pi.toString(this.type)),e}}bo.NAME="Attribute";class Y7 extends bo{constructor(...e){var t;if(L.isBufferSource(e[0]))super(e[0]);else{const r=new Pu({printableString:e[0]});super(M7,[D.serialize(r)])}(t=this.password)!==null&&t!==void 0||(this.password="")}onInit(e){if(super.onInit(e),this.values[0]){const t=D.parse(this.values[0],Pu);this.password=t.toString()}}toTextObject(){const e=this.toTextObjectWithoutValue();return e[_e.VALUE]=this.password,e}}Y7.NAME="Challenge Password";class d2 extends bo{constructor(...e){var t;if(L.isBufferSource(e[0]))super(e[0]);else{const r=e[0],i=new li;for(const s of r)i.push(D.parse(s.rawData,kr));super(l2,[D.serialize(i)])}(t=this.items)!==null&&t!==void 0||(this.items=[])}onInit(e){if(super.onInit(e),this.values[0]){const t=D.parse(this.values[0],li);this.items=t.map(r=>br.create(D.serialize(r)))}}toTextObject(){const e=this.toTextObjectWithoutValue(),t=this.items.map(r=>r.toTextObject());for(const r of t)e[r[_e.NAME]]=r;return e}}d2.NAME="Extensions";class ih{static register(e,t){this.items.set(e,t)}static create(e){const t=new bo(e),r=this.items.get(t.type);return r?new r(e):t}}ih.items=new Map;const Ic="crypto.signatureFormatter";class jO{toAsnSignature(e,t){return L.toArrayBuffer(t)}toWebSignature(e,t){return L.toArrayBuffer(t)}}var ml;let b0=ml=class{static createPssParams(e,t){const r=ml.getHashAlgorithm(e);return r?new Yi({hashAlgorithm:r,maskGenAlgorithm:new H({algorithm:jd,parameters:D.serialize(r)}),saltLength:t}):null}static getHashAlgorithm(e){const t=_t.resolve(Xi);return typeof e=="string"?t.toAsnAlgorithm({name:e}):typeof e=="object"&&e&&"name"in e?t.toAsnAlgorithm(e):null}toAsnAlgorithm(e){switch(e.name.toLowerCase()){case"rsassa-pkcs1-v1_5":if("hash"in e){let t;if(typeof e.hash=="string")t=e.hash;else if(e.hash&&typeof e.hash=="object"&&"name"in e.hash&&typeof e.hash.name=="string")t=e.hash.name.toUpperCase();else throw new Error("Cannot get hash algorithm name");switch(t.toLowerCase()){case"sha-1":return new H({algorithm:Su,parameters:null});case"sha-256":return new H({algorithm:Zf,parameters:null});case"sha-384":return new H({algorithm:xu,parameters:null});case"sha-512":return new H({algorithm:Au,parameters:null})}}else return new H({algorithm:ji,parameters:null});break;case"rsa-pss":if("hash"in e){if(!("saltLength"in e&&typeof e.saltLength=="number"))throw new Error("Cannot get 'saltLength' from 'alg' argument");const t=ml.createPssParams(e.hash,e.saltLength);if(!t)throw new Error("Cannot create PSS parameters");return new H({algorithm:va,parameters:D.serialize(t)})}else return new H({algorithm:va,parameters:null})}return null}toWebAlgorithm(e){switch(e.algorithm){case ji:return{name:"RSASSA-PKCS1-v1_5"};case Su:return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-1"}};case Zf:return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};case xu:return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-384"}};case Au:return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-512"}};case va:if(e.parameters){const t=D.parse(e.parameters,Yi);return{name:"RSA-PSS",hash:_t.resolve(Xi).toWebAlgorithm(t.hashAlgorithm),saltLength:t.saltLength}}else return{name:"RSA-PSS"}}return null}};b0=ml=p([Zd()],b0);_t.registerSingleton(_c,b0);let E0=class{toAsnAlgorithm(e){switch(e.name.toLowerCase()){case"sha-1":return new H({algorithm:ku});case"sha-256":return new H({algorithm:_u});case"sha-384":return new H({algorithm:Iu});case"sha-512":return new H({algorithm:Cu})}return null}toWebAlgorithm(e){switch(e.algorithm){case ku:return{name:"SHA-1"};case _u:return{name:"SHA-256"};case Iu:return{name:"SHA-384"};case Cu:return{name:"SHA-512"}}return null}};E0=p([Zd()],E0);_t.registerSingleton(_c,E0);class Sr{addPadding(e,t){const r=L.toUint8Array(t),i=new Uint8Array(e);return i.set(r,e-r.length),i.buffer}removePadding(e,t=!1){let r=L.toUint8Array(e);for(let i=0;i<r.length;i++)if(r[i]){r=r.slice(i);break}if(t&&r[0]>127){const i=new Uint8Array(r.length+1);return i.set(r,1),i.buffer}return r.buffer}toAsnSignature(e,t){if(e.name==="ECDSA"){const r=e.namedCurve,i=Sr.namedCurveSize.get(r)||Sr.defaultNamedCurveSize,s=new Eu,o=L.toUint8Array(t);return s.r=this.removePadding(o.slice(0,i),!0),s.s=this.removePadding(o.slice(i,i+i),!0),D.serialize(s)}return null}toWebSignature(e,t){if(e.name==="ECDSA"){const r=D.parse(t,Eu),i=e.namedCurve,s=Sr.namedCurveSize.get(i)||Sr.defaultNamedCurveSize,o=this.addPadding(s,this.removePadding(r.r)),a=this.addPadding(s,this.removePadding(r.s));return Bk(o,a)}return null}}Sr.namedCurveSize=new Map;Sr.defaultNamedCurveSize=32;const o1="1.3.101.110",k4="1.3.101.111",a1="1.3.101.112",_4="1.3.101.113";let S0=class{toAsnAlgorithm(e){let t=null;switch(e.name.toLowerCase()){case"ed25519":t=a1;break;case"x25519":t=o1;break;case"eddsa":switch(e.namedCurve.toLowerCase()){case"ed25519":t=a1;break;case"ed448":t=_4;break}break;case"ecdh-es":switch(e.namedCurve.toLowerCase()){case"x25519":t=o1;break;case"x448":t=k4;break}}return t?new H({algorithm:t}):null}toWebAlgorithm(e){switch(e.algorithm){case a1:return{name:"Ed25519"};case _4:return{name:"EdDSA",namedCurve:"Ed448"};case o1:return{name:"X25519"};case k4:return{name:"ECDH-ES",namedCurve:"X448"}}return null}};S0=p([Zd()],S0);_t.registerSingleton(_c,S0);var Fo,Uo,$o,Vo,qo,Ho,zo,bs;class QO extends Tn{get subjectName(){return de(this,Uo,"f")||We(this,Uo,new Br(this.asn.certificationRequestInfo.subject),"f"),de(this,Uo,"f")}get subject(){return de(this,$o,"f")||We(this,$o,this.subjectName.toString(),"f"),de(this,$o,"f")}get signatureAlgorithm(){if(!de(this,Vo,"f")){const e=_t.resolve(Xi);We(this,Vo,e.toWebAlgorithm(this.asn.signatureAlgorithm),"f")}return de(this,Vo,"f")}get signature(){return de(this,qo,"f")||We(this,qo,this.asn.signature,"f"),de(this,qo,"f")}get publicKey(){return de(this,Ho,"f")||We(this,Ho,new Ur(this.asn.certificationRequestInfo.subjectPKInfo),"f"),de(this,Ho,"f")}get attributes(){return de(this,zo,"f")||We(this,zo,this.asn.certificationRequestInfo.attributes.map(e=>ih.create(D.serialize(e))),"f"),de(this,zo,"f")}get extensions(){if(!de(this,bs,"f")){We(this,bs,[],"f");const e=this.getAttribute(l2);e instanceof d2&&We(this,bs,e.items,"f")}return de(this,bs,"f")}get tbs(){return de(this,Fo,"f")||We(this,Fo,this.asn.certificationRequestInfoRaw||D.serialize(this.asn.certificationRequestInfo),"f"),de(this,Fo,"f")}constructor(e){const t=Tn.isAsnEncoded(e)?[e,Ya]:[e];super(t[0],t[1]),Fo.set(this,void 0),Uo.set(this,void 0),$o.set(this,void 0),Vo.set(this,void 0),qo.set(this,void 0),Ho.set(this,void 0),zo.set(this,void 0),bs.set(this,void 0),this.tag=dr.CertificateRequestTag}onInit(e){}getAttribute(e){for(const t of this.attributes)if(t.type===e)return t;return null}getAttributes(e){return this.attributes.filter(t=>t.type===e)}getExtension(e){for(const t of this.extensions)if(t.type===e)return t;return null}getExtensions(e){return this.extensions.filter(t=>t.type===e)}async verify(e=dt.get()){const t={...this.publicKey.algorithm,...this.signatureAlgorithm},r=await this.publicKey.export(t,["verify"],e),i=_t.resolveAll(Ic).reverse();let s=null;for(const a of i)if(s=a.toWebSignature(t,this.signature),s)break;if(!s)throw Error("Cannot convert WebCrypto signature value to ASN.1 format");return await e.subtle.verify(this.signatureAlgorithm,r,s,this.tbs)}toTextObject(){const e=this.toTextObjectEmpty(),t=D.parse(this.rawData,Ya),r=t.certificationRequestInfo,i=new _e("",{Version:`${Ki[r.version]} (${r.version})`,Subject:this.subject,"Subject Public Key Info":this.publicKey});if(this.attributes.length){const s=new _e("");for(const o of this.attributes){const a=o.toTextObject();s[a[_e.NAME]]=a}i.Attributes=s}return e.Data=i,e.Signature=new _e("",{Algorithm:Zi.serializeAlgorithm(t.signatureAlgorithm),"":t.signature}),e}}Fo=new WeakMap,Uo=new WeakMap,$o=new WeakMap,Vo=new WeakMap,qo=new WeakMap,Ho=new WeakMap,zo=new WeakMap,bs=new WeakMap;QO.NAME="PKCS#10 Certificate Request";var Ko,Wo,Go,jo,Qo,Yo,Xo,Zo,Jo,ea,Es,ta;class h2 extends Tn{get publicKey(){return de(this,ta,"f")||We(this,ta,new Ur(this.asn.tbsCertificate.subjectPublicKeyInfo),"f"),de(this,ta,"f")}get serialNumber(){if(!de(this,Wo,"f")){const e=this.asn.tbsCertificate;let t=new Uint8Array(e.serialNumber);t.length>1&&t[0]===0&&t[1]>127&&(t=t.slice(1)),We(this,Wo,Q.ToHex(t),"f")}return de(this,Wo,"f")}get subjectName(){return de(this,Go,"f")||We(this,Go,new Br(this.asn.tbsCertificate.subject),"f"),de(this,Go,"f")}get subject(){return de(this,jo,"f")||We(this,jo,this.subjectName.toString(),"f"),de(this,jo,"f")}get issuerName(){return de(this,Qo,"f")||We(this,Qo,new Br(this.asn.tbsCertificate.issuer),"f"),de(this,Qo,"f")}get issuer(){return de(this,Yo,"f")||We(this,Yo,this.issuerName.toString(),"f"),de(this,Yo,"f")}get notBefore(){if(!de(this,Xo,"f")){const e=this.asn.tbsCertificate.validity.notBefore.utcTime||this.asn.tbsCertificate.validity.notBefore.generalTime;if(!e)throw new Error("Cannot get 'notBefore' value");We(this,Xo,e,"f")}return de(this,Xo,"f")}get notAfter(){if(!de(this,Zo,"f")){const e=this.asn.tbsCertificate.validity.notAfter.utcTime||this.asn.tbsCertificate.validity.notAfter.generalTime;if(!e)throw new Error("Cannot get 'notAfter' value");We(this,Zo,e,"f")}return de(this,Zo,"f")}get signatureAlgorithm(){if(!de(this,Jo,"f")){const e=_t.resolve(Xi);We(this,Jo,e.toWebAlgorithm(this.asn.signatureAlgorithm),"f")}return de(this,Jo,"f")}get signature(){return de(this,ea,"f")||We(this,ea,this.asn.signatureValue,"f"),de(this,ea,"f")}get extensions(){return de(this,Es,"f")||(We(this,Es,[],"f"),this.asn.tbsCertificate.extensions&&We(this,Es,this.asn.tbsCertificate.extensions.map(e=>br.create(D.serialize(e))),"f")),de(this,Es,"f")}get tbs(){return de(this,Ko,"f")||We(this,Ko,this.asn.tbsCertificateRaw||D.serialize(this.asn.tbsCertificate),"f"),de(this,Ko,"f")}constructor(e){const t=Tn.isAsnEncoded(e)?[e,Wi]:[e];super(t[0],t[1]),Ko.set(this,void 0),Wo.set(this,void 0),Go.set(this,void 0),jo.set(this,void 0),Qo.set(this,void 0),Yo.set(this,void 0),Xo.set(this,void 0),Zo.set(this,void 0),Jo.set(this,void 0),ea.set(this,void 0),Es.set(this,void 0),ta.set(this,void 0),this.tag=dr.CertificateTag}onInit(e){}getExtension(e){for(const t of this.extensions)if(typeof e=="string"){if(t.type===e)return t}else if(t instanceof e)return t;return null}getExtensions(e){return this.extensions.filter(t=>typeof e=="string"?t.type===e:t instanceof e)}async verify(e={},t=dt.get()){let r,i;const s=e.publicKey;try{if(!s)r={...this.publicKey.algorithm,...this.signatureAlgorithm},i=await this.publicKey.export(r,["verify"],t);else if("publicKey"in s)r={...s.publicKey.algorithm,...this.signatureAlgorithm},i=await s.publicKey.export(r,["verify"],t);else if(s instanceof Ur)r={...s.algorithm,...this.signatureAlgorithm},i=await s.export(r,["verify"],t);else if(L.isBufferSource(s)){const l=new Ur(s);r={...l.algorithm,...this.signatureAlgorithm},i=await l.export(r,["verify"],t)}else r={...s.algorithm,...this.signatureAlgorithm},i=s}catch{return!1}const o=_t.resolveAll(Ic).reverse();let a=null;for(const l of o)if(a=l.toWebSignature(r,this.signature),a)break;if(!a)throw Error("Cannot convert ASN.1 signature value to WebCrypto format");const c=await t.subtle.verify(this.signatureAlgorithm,i,a,this.tbs);if(e.signatureOnly)return c;{const u=(e.date||new Date).getTime();return c&&this.notBefore.getTime()<u&&u<this.notAfter.getTime()}}async getThumbprint(...e){let t,r="SHA-1";return e[0]&&(e[0].subtle?t=e[0]:(r=e[0]||r,t=e[1])),t??(t=dt.get()),await t.subtle.digest(r,this.rawData)}async isSelfSigned(e=dt.get()){return this.subject===this.issuer&&await this.verify({signatureOnly:!0},e)}toTextObject(){const e=this.toTextObjectEmpty(),t=D.parse(this.rawData,Wi),r=t.tbsCertificate,i=new _e("",{Version:`${Ki[r.version]} (${r.version})`,"Serial Number":r.serialNumber,"Signature Algorithm":Zi.serializeAlgorithm(r.signature),Issuer:this.issuer,Validity:new _e("",{"Not Before":r.validity.notBefore.getTime(),"Not After":r.validity.notAfter.getTime()}),Subject:this.subject,"Subject Public Key Info":this.publicKey});if(r.issuerUniqueID&&(i["Issuer Unique ID"]=r.issuerUniqueID),r.subjectUniqueID&&(i["Subject Unique ID"]=r.subjectUniqueID),this.extensions.length){const s=new _e("");for(const o of this.extensions){const a=o.toTextObject();s[a[_e.NAME]]=a}i.Extensions=s}return e.Data=i,e.Signature=new _e("",{Algorithm:Zi.serializeAlgorithm(t.signatureAlgorithm),"":t.signatureValue}),e}}Ko=new WeakMap,Wo=new WeakMap,Go=new WeakMap,jo=new WeakMap,Qo=new WeakMap,Yo=new WeakMap,Xo=new WeakMap,Zo=new WeakMap,Jo=new WeakMap,ea=new WeakMap,Es=new WeakMap,ta=new WeakMap;h2.NAME="Certificate";function YO(n,e=dt.get()){const t=L.toUint8Array(Q.FromHex(n||""));let r=t&&t.length&&t.some(s=>s>0)?new Uint8Array(t):void 0;r||(r=e.getRandomValues(new Uint8Array(16)));let i=0;for(;i<r.length-1&&r[i]===0;)i++;if(r=r.slice(i),r[0]>127){const s=new Uint8Array(r.length+1);s[0]=0,s.set(r,1),r=s}return r.buffer}class XO{static async createSelfSigned(e,t=dt.get()){if(!e.keys.privateKey)throw new Error("Bad field 'keys' in 'params' argument. 'privateKey' is empty");if(!e.keys.publicKey)throw new Error("Bad field 'keys' in 'params' argument. 'publicKey' is empty");return this.create({serialNumber:e.serialNumber,subject:e.name,issuer:e.name,notBefore:e.notBefore,notAfter:e.notAfter,publicKey:e.keys.publicKey,signingKey:e.keys.privateKey,signingAlgorithm:e.signingAlgorithm,extensions:e.extensions},t)}static async create(e,t=dt.get()){var r;let i;e.publicKey instanceof Ur?i=e.publicKey.rawData:"publicKey"in e.publicKey?i=e.publicKey.publicKey.rawData:L.isBufferSource(e.publicKey)?i=e.publicKey:i=await t.subtle.exportKey("spki",e.publicKey);const s=YO(e.serialNumber),o=e.notBefore||new Date,a=e.notAfter||new Date(o.getTime()+31536e6),c=new Wi({tbsCertificate:new wr({version:Ki.v3,serialNumber:s,validity:new gc({notBefore:o,notAfter:a}),extensions:new li(((r=e.extensions)===null||r===void 0?void 0:r.map(w=>D.parse(w.rawData,kr)))||[]),subjectPublicKeyInfo:D.parse(i,Lr)})});if(e.subject){const w=e.subject instanceof Br?e.subject:new Br(e.subject);c.tbsCertificate.subject=D.parse(w.toArrayBuffer(),et)}if(e.issuer){const w=e.issuer instanceof Br?e.issuer:new Br(e.issuer);c.tbsCertificate.issuer=D.parse(w.toArrayBuffer(),et)}const l={hash:"SHA-256"},u="signingKey"in e?{...l,...e.signingAlgorithm,...e.signingKey.algorithm}:{...l,...e.signingAlgorithm},d=_t.resolve(Xi);c.tbsCertificate.signature=c.signatureAlgorithm=d.toAsnAlgorithm(u);const h=D.serialize(c.tbsCertificate),f="signingKey"in e?await t.subtle.sign(u,e.signingKey,h):e.signature,m=_t.resolveAll(Ic).reverse();let y=null;for(const w of m)if(y=w.toAsnSignature(u,f),y)break;if(!y)throw Error("Cannot convert ASN.1 signature value to WebCrypto format");return c.signatureValue=y,new h2(D.serialize(c))}}var I4;(function(n){n[n.unspecified=0]="unspecified",n[n.keyCompromise=1]="keyCompromise",n[n.cACompromise=2]="cACompromise",n[n.affiliationChanged=3]="affiliationChanged",n[n.superseded=4]="superseded",n[n.cessationOfOperation=5]="cessationOfOperation",n[n.certificateHold=6]="certificateHold",n[n.removeFromCRL=8]="removeFromCRL",n[n.privilegeWithdrawn=9]="privilegeWithdrawn",n[n.aACompromise=10]="aACompromise"})(I4||(I4={}));br.register(o7,u2);br.register(l7,H7);br.register(d7,z7);br.register(g7,nh);br.register(mf,Ja);br.register(p7,K7);br.register(Ef,G7);br.register(gf,j7);br.register(u7,Q7);ih.register(M7,Y7);ih.register(l2,d2);_t.registerSingleton(Ic,jO);_t.registerSingleton(Ic,Sr);Sr.namedCurveSize.set("P-256",32);Sr.namedCurveSize.set("K-256",32);Sr.namedCurveSize.set("P-384",48);Sr.namedCurveSize.set("P-521",66);class ZO extends tt{async listen(){throw new wP("WebRTCTransport.createListener")}getAddrs(){return[]}updateAnnounceAddrs(){}async close(){}}const X7=Object.values(Gw).map(n=>n.decoder).reduce((n,e)=>n.or(e)),JO=/^a=fingerprint:(?:\w+-[0-9]+)\s(?<fingerprint>(:?[0-9a-fA-F]{2})+)$/m;function eN(n){return n?.match(JO)?.groups?.fingerprint}function Z7(n){const t=n.stringTuples().filter(r=>r[0]===tP).map(r=>r[1])[0];if(t===void 0||t==="")throw new $(`Couldn't find a certhash component of multiaddr: ${n.toString()}`);return t}function tN(n){return zt(X7.decode(n))}function rN(n){const e=tN(Z7(n)),t=iN(e.code),r=e.digest.reduce((s,o)=>s+o.toString(16).padStart(2,"0"),""),i=r.match(/.{1,2}/g);if(i==null)throw new yP(r,n.toString());return`${t} ${i.join(":").toUpperCase()}`}function nN(n){const e=n.split(":").map(i=>parseInt(i,16)),t=Uint8Array.from(e),r=c5(gt.code,t);return ue(`/certhash/${A5.encode(r.bytes)}`)}function iN(n){switch(n){case 17:return"sha-1";case 18:return"sha-256";case 19:return"sha-512";default:throw new vP(n)}}function sN(n,e){const{host:t,port:r,family:i}=n.toOptions(),s=rN(n);return{type:"answer",sdp:`v=0
o=- 0 0 IN IP${i} ${t}
s=-
t=0 0
a=ice-lite
m=application ${r} UDP/DTLS/SCTP webrtc-datachannel
c=IN IP${i} ${t}
a=mid:0
a=ice-options:ice2
a=ice-ufrag:${e}
a=ice-pwd:${e}
a=fingerprint:${s}
a=setup:passive
a=sctp-port:5000
a=max-message-size:${Rd}
a=candidate:1467250027 1 UDP 1467250027 ${t} ${r} typ host
a=end-of-candidates
`}}function oN(n,e){const{host:t,port:r,family:i}=n.toOptions();return{type:"offer",sdp:`v=0
o=- 0 0 IN IP${i} ${t}
s=-
c=IN IP${i} ${t}
t=0 0
a=ice-options:ice2,trickle
m=application ${r} UDP/DTLS/SCTP webrtc-datachannel
a=mid:0
a=setup:active
a=ice-ufrag:${e}
a=ice-pwd:${e}
a=fingerprint:sha-256 00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00
a=sctp-port:5000
a=max-message-size:${Rd}
a=candidate:1467250027 1 UDP 1467250027 ${t} ${r} typ host
a=end-of-candidates
`}}function C4(n,e){if(n.sdp===void 0)throw new $("Can't munge a missing SDP");const t=n.sdp.includes(`\r
`)?`\r
`:`
`;return n.sdp=n.sdp.replace(/\na=ice-ufrag:[^\n]*\n/,`
a=ice-ufrag:`+e+t).replace(/\na=ice-pwd:[^\n]*\n/,`
a=ice-pwd:`+e+t),n}const c1=C("libp2p-webrtc-noise:");function aN(n,e,t){const r=n.trim().toLowerCase().replaceAll(":",""),i=C(r,"hex"),s=c5(gt.code,i),o=X7.decode(Z7(e)),a=c1.byteLength+s.bytes.byteLength+o.byteLength;return t==="server"?tr([c1,o,s.bytes],a):tr([c1,s.bytes,o],a)}const cN=Lp?"iceconnectionstatechange":"connectionstatechange";async function lN(n,e,t){const r=n.createDataChannel("",{negotiated:!0,id:0});try{if(t.role==="client"){t.log.trace("client creating local offer");const d=await n.createOffer();t.log.trace("client created local offer %s",d.sdp);const h=C4(d,e);t.log.trace("client setting local offer %s",h.sdp),await n.setLocalDescription(h);const f=sN(t.remoteAddr,e);t.log.trace("client setting server description %s",f.sdp),await n.setRemoteDescription(f)}else{const d=oN(t.remoteAddr,e);t.log.trace("server setting client %s %s",d.type,d.sdp),await n.setRemoteDescription(d),t.log.trace("server creating local answer");const h=await n.createAnswer();t.log.trace("server created local answer");const f=C4(h,e);t.log.trace("server setting local description %s",h.sdp),await n.setLocalDescription(f)}if(r.readyState!=="open"&&(t.log.trace("%s wait for handshake channel to open, starting status %s",t.role,r.readyState),await Ut(r,"open",t.signal)),t.log.trace("%s handshake channel opened",t.role),t.role==="server"){const d=n.remoteFingerprint()?.value??"";t.remoteAddr=t.remoteAddr.encapsulate(nN(d))}const i=eN(n.localDescription?.sdp);if(i==null)throw new fc("Could not get fingerprint from local description sdp");t.log.trace("%s performing noise handshake",t.role);const s=aN(i,t.remoteAddr,t.role),o=k8({prologueBytes:s})(t),a=ru({channel:r,direction:"outbound",handshake:!0,log:t.log,...t.dataChannel??{}}),c=new lf(t,{peerConnection:n,remoteAddr:t.remoteAddr,timeline:{open:Date.now()},metrics:t.events});n.addEventListener(cN,()=>{switch(n.connectionState){case"failed":case"disconnected":case"closed":c.close().catch(d=>{t.log.error("error closing connection",d),c.abort(d)});break;default:break}}),t.events?.increment({peer_connection:!0});const l=new Bp(t,{peerConnection:n,metrics:t.events,dataChannelOptions:t.dataChannel});if(t.role==="client")return t.log.trace("%s secure inbound",t.role),await o.secureInbound(a,{remotePeer:t.remotePeerId,signal:t.signal,skipStreamMuxerNegotiation:!0}),t.log.trace("%s upgrade outbound",t.role),await t.upgrader.upgradeOutbound(c,{skipProtection:!0,skipEncryption:!0,muxerFactory:l,signal:t.signal});t.log.trace("%s secure outbound",t.role);const u=await o.secureOutbound(a,{remotePeer:t.remotePeerId,signal:t.signal,skipStreamMuxerNegotiation:!0});c.remoteAddr=c.remoteAddr.encapsulate(`/p2p/${u.remotePeer}`),t.log.trace("%s upgrade inbound",t.role),await t.upgrader.upgradeInbound(c,{skipProtection:!0,skipEncryption:!0,muxerFactory:l,signal:t.signal})}catch(i){throw r.close(),i}}async function uN(n,e,t,r){r==null&&(r=await RTCPeerConnection.generateCertificate({name:"ECDSA",namedCurve:"P-256"}));const i=typeof t=="function"?await t():t;return new RTCPeerConnection({...i??{},certificates:[r]})}async function dN(n){const e=await k5(n),t=await crypto.subtle.exportKey("pkcs8",e.privateKey);return["-----BEGIN PRIVATE KEY-----",...ee(new Uint8Array(t),"base64pad").split(/(.{64})/).filter(Boolean),"-----END PRIVATE KEY-----"].join(`
`)}class hN{log;metrics;components;init;certificate;privateKey;emitter;renewCertificateTask;constructor(e,t={}){if(this.log=e.logger.forComponent("libp2p:webrtc-direct"),this.components=e,this.init=t,this.emitter=new tt,t.certificateLifespan!=null&&t.certificateRenewalThreshold!=null&&t.certificateRenewalThreshold>=t.certificateLifespan)throw new $("Certificate renewal threshold must be less than certificate lifespan");e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webrtc-direct_dialer_events_total",{label:"event",help:"Total count of WebRTC-direct dial events by type"})})}[Yu]=!0;[Symbol.toStringTag]="@libp2p/webrtc-direct";[St]=["@libp2p/transport"];async start(){this.certificate=await this.getCertificate()}async stop(){this.renewCertificateTask!=null&&clearTimeout(this.renewCertificateTask),this.certificate=void 0}async dial(e,t){this.log("dial %a",e),t.signal.throwIfAborted();let r;const i=e.getPeerId();i!=null&&(r=Ot(i));const s=fP(),o=await uN("client",s,typeof this.init.rtcConfiguration=="function"?await this.init.rtcConfiguration():this.init.rtcConfiguration??{});try{return await lN(o,s,{role:"client",log:this.log,logger:this.components.logger,metrics:this.components.metrics,events:this.metrics?.dialerEvents,signal:t.signal,remoteAddr:e,dataChannel:this.init.dataChannel,upgrader:t.upgrader,peerId:this.components.peerId,remotePeerId:r,privateKey:this.components.privateKey})}catch(a){throw o.close(),a}}createListener(e){if(this.certificate==null)throw new Os;return new ZO(this.components,{...this.init,...e,certificate:this.certificate,emitter:this.emitter})}listenFilter(e){return e.filter(R1.exactMatch)}dialFilter(e){return this.listenFilter(e)}async getCertificate(e){if(fN(this.init.certificate))return this.log("using provided TLS certificate"),this.init.certificate;const t=await this.loadOrCreatePrivateKey(),{pem:r,certhash:i}=await this.loadOrCreateCertificate(t,e);return{privateKey:await dN(t),pem:r,certhash:i}}async loadOrCreatePrivateKey(){if(this.privateKey!=null)return this.privateKey;const e=this.init.certificateKeychainName??uP,t=this.getKeychain();try{if(t==null)throw this.log("no keychain configured - not checking for stored private key"),new Xe;this.log.trace("checking for stored private key"),this.privateKey=await t.exportKey(e)}catch(r){if(r.name!=="NotFoundError")throw r;this.log.trace("generating private key"),this.privateKey=await j0("ECDSA","P-256"),t!=null?(this.log.trace("storing private key"),await t.importKey(e,this.privateKey)):this.log("no keychain configured - not storing private key")}return this.privateKey}async loadOrCreateCertificate(e,t){if(this.certificate!=null&&t!==!0)return this.certificate;let r;const i=new Te(this.init.certificateDatastoreKey??lP),s=await k5(e);try{if(t===!0)throw this.log.trace("forcing renewal of TLS certificate"),new Xe;this.log.trace("checking for stored TLS certificate"),r=await this.loadCertificate(i,s)}catch(a){if(a.name!=="NotFoundError")throw a;this.log.trace("generating new TLS certificate"),r=await this.createCertificate(i,s)}let o=r.notAfter.getTime()-(this.init.certificateRenewalThreshold??em)-Date.now();return o<0&&(o=100),this.log("will renew TLS certificate after %d ms",o),this.renewCertificateTask=setTimeout(()=>{this.log("renewing TLS certificate"),this.getCertificate(!0).then(a=>{this.certificate=a,this.emitter.safeDispatchEvent("certificate:renew",{detail:a})}).catch(a=>{this.log.error("could not renew certificate - %e",a)})},o),{pem:r.toString("pem"),certhash:A5.encode((await gt.digest(new Uint8Array(r.rawData))).bytes)}}async loadCertificate(e,t){const r=await this.components.datastore.get(e),i=new h2(r),s=i.notAfter.getTime()-(this.init.certificateRenewalThreshold??em);if(Date.now()>s)throw this.log("stored TLS certificate has expired"),new Xe;this.log("loaded certificate, expires in %d ms",s);const o=await i.publicKey.export(crypto),a=await crypto.subtle.exportKey("raw",o),c=await crypto.subtle.exportKey("raw",t.publicKey);if(!Ue(new Uint8Array(a,0,a.byteLength),new Uint8Array(c,0,c.byteLength)))throw this.log("stored TLS certificate public key did not match public key from private key"),new Xe;return this.log("loaded certificate, expiry time is %o",s),i}async createCertificate(e,t){const r=new Date,i=new Date(Date.now()+(this.init.certificateLifespan??dP));r.setMilliseconds(0),i.setMilliseconds(0);const s=await XO.createSelfSigned({serialNumber:(BigInt(Math.random().toString().replace(".",""))*100000n).toString(16),name:"CN=example.com, C=US, L=CA, O=example, ST=CA",notBefore:r,notAfter:i,keys:t,extensions:[new u2(!1,void 0,!0)]},crypto);return this.getKeychain()!=null?(this.log.trace("storing TLS certificate"),await this.components.datastore.put(e,C(s.toString("pem")))):this.log("no keychain is configured so not storing TLS certificate since the private key will not be reused"),s}getKeychain(){try{return this.components.keychain}catch{}}}function fN(n){return n==null?!1:typeof n.privateKey=="string"&&typeof n.pem=="string"&&typeof n.certhash=="string"}function J7(n){return e=>new hN(e,n)}function pN(n){return e=>new xP(e,n)}const gN=async n=>{if(n.readyState>=2)throw new Error("socket closed");n.readyState!==1&&await new Promise((e,t)=>{function r(){n.removeEventListener("open",i),n.removeEventListener("error",s)}function i(){r(),e()}function s(o){r(),t(o.error??new Error(`connect ECONNREFUSED ${n.url}`))}n.addEventListener("open",i),n.addEventListener("error",s)})},mN=(n,e)=>(e=e??{},e.closeOnEnd=e.closeOnEnd!==!1,async r=>{for await(const i of r){try{await gN(n)}catch(s){if(s.message==="socket closed")break;throw s}if(n.readyState===n.CLOSING||n.readyState===n.CLOSED)break;n.send(i)}e.closeOnEnd!=null&&n.readyState<=1&&await new Promise((i,s)=>{n.addEventListener("close",o=>{if(o.wasClean||o.code===1006)i();else{const a=Object.assign(new Error("ws error"),{event:o});s(a)}}),setTimeout(()=>{n.close()})})});var ys={},No={},T4;function yN(){if(T4)return No;T4=1,Object.defineProperty(No,"__esModule",{value:!0});class n{constructor(){this.pullQueue=[],this.pushQueue=[],this.eventHandlers={},this.isPaused=!1,this.isStopped=!1}push(r){if(this.isStopped)return;const i={value:r,done:!1};if(this.pullQueue.length){const s=this.pullQueue.shift();s&&s.resolve(i)}else this.pushQueue.push(Promise.resolve(i)),this.highWaterMark!==void 0&&this.pushQueue.length>=this.highWaterMark&&!this.isPaused&&(this.isPaused=!0,this.eventHandlers.highWater?this.eventHandlers.highWater():console&&console.warn(`EventIterator queue reached ${this.pushQueue.length} items`))}stop(){if(!this.isStopped){this.isStopped=!0,this.remove();for(const r of this.pullQueue)r.resolve({value:void 0,done:!0});this.pullQueue.length=0}}fail(r){if(!this.isStopped)if(this.isStopped=!0,this.remove(),this.pullQueue.length){for(const i of this.pullQueue)i.reject(r);this.pullQueue.length=0}else{const i=Promise.reject(r);i.catch(()=>{}),this.pushQueue.push(i)}}remove(){Promise.resolve().then(()=>{this.removeCallback&&this.removeCallback()})}[Symbol.asyncIterator](){return{next:r=>{const i=this.pushQueue.shift();return i?(this.lowWaterMark!==void 0&&this.pushQueue.length<=this.lowWaterMark&&this.isPaused&&(this.isPaused=!1,this.eventHandlers.lowWater&&this.eventHandlers.lowWater()),i):this.isStopped?Promise.resolve({value:void 0,done:!0}):new Promise((s,o)=>{this.pullQueue.push({resolve:s,reject:o})})},return:()=>(this.isStopped=!0,this.pushQueue.length=0,this.remove(),Promise.resolve({value:void 0,done:!0}))}}}class e{constructor(r,{highWaterMark:i=100,lowWaterMark:s=1}={}){const o=new n;o.highWaterMark=i,o.lowWaterMark=s,o.removeCallback=r({push:a=>o.push(a),stop:()=>o.stop(),fail:a=>o.fail(a),on:(a,c)=>{o.eventHandlers[a]=c}})||(()=>{}),this[Symbol.asyncIterator]=()=>o[Symbol.asyncIterator](),Object.freeze(this)}}return No.EventIterator=e,No.default=e,No}var R4;function wN(){if(R4)return ys;R4=1,Object.defineProperty(ys,"__esModule",{value:!0});const n=yN();ys.EventIterator=n.EventIterator;function e(t,r,i){return new n.EventIterator(({push:s})=>(this.addEventListener(t,s,r),()=>this.removeEventListener(t,s,r)),i)}return ys.subscribe=e,ys.default=n.EventIterator,ys}var vN=wN();function P4(n){return n instanceof ArrayBuffer||n?.constructor?.name==="ArrayBuffer"&&typeof n?.byteLength=="number"}const bN=n=>{n.binaryType="arraybuffer";const e=async()=>{await new Promise((s,o)=>{if(r){s();return}if(i!=null){o(i);return}const a=u=>{n.removeEventListener("open",c),n.removeEventListener("error",l),u()},c=()=>{a(s)},l=u=>{a(()=>{o(u.error??new Error(`connect ECONNREFUSED ${n.url}`))})};n.addEventListener("open",c),n.addEventListener("error",l)})},t=(async function*(){const s=new vN.EventIterator(({push:o,stop:a,fail:c})=>{const l=d=>{let h=null;typeof d.data=="string"&&(h=C(d.data)),P4(d.data)&&(h=new Uint8Array(d.data)),d.data instanceof Uint8Array&&(h=d.data),h!=null&&o(h)},u=d=>{c(d.error??new Error("Socket error"))};return n.addEventListener("message",l),n.addEventListener("error",u),n.addEventListener("close",a),()=>{n.removeEventListener("message",l),n.removeEventListener("error",u),n.removeEventListener("close",a)}},{highWaterMark:1/0});await e();for await(const o of s)yield P4(o)?new Uint8Array(o):o})();let r=n.readyState===1,i;return n.addEventListener("open",()=>{r=!0,i=null}),n.addEventListener("close",()=>{r=!1,i=null}),n.addEventListener("error",s=>{r||(i=s.error??new Error(`connect ECONNREFUSED ${n.url}`))}),Object.assign(t,{connected:e})},EN=(n,e)=>{e=e??{};const t=bN(n);let r=e.remoteAddress,i=e.remotePort;if(n.url!=null)try{const o=new URL(n.url);r=o.hostname,i=parseInt(o.port,10)}catch{}if(r==null||i==null)throw new Error("Remote connection did not have address and/or port");return{sink:mN(n,e),source:t,connected:async()=>{await t.connected()},close:async()=>{(n.readyState===n.CONNECTING||n.readyState===n.OPEN)&&await new Promise(o=>{n.addEventListener("close",()=>{o()}),n.close()})},destroy:()=>{n.terminate!=null?n.terminate():n.close()},remoteAddress:r,remotePort:i,socket:n}},SN=WebSocket,xN={"http:":"ws:","https:":"wss:"},O4="ws:",AN=(n,e)=>{if(n.startsWith("//")&&(n=`${e?.protocol??O4}${n}`),n.startsWith("/")&&e!=null){const r=e.protocol??O4,i=e.host,s=e.port!=null&&i?.endsWith(`:${e.port}`)!==!0?`:${e.port}`:"";n=`${r}//${i}${s}${n}`}const t=new URL(n);for(const[r,i]of Object.entries(xN))t.protocol===r&&(t.protocol=i);return t};function kN(n,e){const t=typeof window>"u"?void 0:window.location;e=e??{};const r=AN(n,t),i=new SN(r.toString(),e.websocket);return EN(i,e)}function _N(n){return n.filter(e=>Pl.exactMatch(e)||Ua.exactMatch(e))}function IN(){throw new Error("WebSocket Servers can not be created in the browser!")}const CN=500;function TN(n,e,t){const r=t.metrics,i=t.metricPrefix??"",s={log:t.logger.forComponent("libp2p:websockets:connection"),async sink(c){try{await n.sink((async function*(){for await(const l of c)l instanceof Uint8Array?yield l:yield l.subarray()})())}catch(l){l.type!=="aborted"&&s.log.error(l)}},source:n.source,remoteAddr:e,timeline:{open:Date.now()},async close(c={}){const l=Date.now();if(c.signal==null){const d=AbortSignal.timeout(CN);c={...c,signal:d}}const u=()=>{const{host:d,port:h}=s.remoteAddr.toOptions();s.log("timeout closing stream to %s:%s after %dms, destroying it manually",d,h,Date.now()-l),this.abort(new pt("Socket close timeout"))};c.signal?.addEventListener("abort",u);try{await n.close()}catch(d){s.log.error("error closing WebSocket gracefully - %e",d),this.abort(d)}finally{c.signal?.removeEventListener("abort",u),s.timeline.close=Date.now()}},abort(c){s.log.error("destroying WebSocket after error - %e",c),n.destroy(),s.timeline.close=Date.now(),r?.increment({[`${i}error`]:!0})}};let o=!1;const a=n.socket.close.bind(n.socket);return n.socket.close=(...c)=>(o=!0,a(...c)),n.socket.addEventListener("close",c=>{if(s.log('closed %s, code %d, reason "%s", wasClean %s',o?"locally":"by remote",c.code,c.reason,c.wasClean),!c.wasClean){s.abort(new Q0(`${o?"Local":"Remote"} did not close WebSocket cleanly`));return}r?.increment({[`${i}close`]:!0}),s.timeline.close=Date.now()},{once:!0}),s}class RN{log;init;logger;metrics;components;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:websockets"),this.logger=e.logger,this.components=e,this.init=t,e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_websockets_dialer_events_total",{label:"event",help:"Total count of WebSockets dialer events by type"})})}[Yu]=!0;[Symbol.toStringTag]="@libp2p/websockets";[St]=["@libp2p/transport"];async dial(e,t){this.log("dialing %s",e),t=t??{};const r=await this._connect(e,t),i=TN(r,e,{logger:this.logger,metrics:this.metrics?.dialerEvents});this.log("new outbound connection %s",i.remoteAddr);const s=await t.upgrader.upgradeOutbound(i,t);return this.log("outbound connection %s upgraded",i.remoteAddr),s}async _connect(e,t){t?.signal?.throwIfAborted();const r=e.toOptions();this.log("dialing %s:%s",r.host,r.port);const i=we(),s=kN(H0(e),this.init);s.socket.addEventListener("error",()=>{const o=new Q0(`Could not connect to ${e.toString()}`);this.log.error("connection error:",o),this.metrics?.dialerEvents.increment({error:!0}),i.reject(o)});try{t.onProgress?.(new P("websockets:open-connection")),await ht(Promise.race([s.connected(),i.promise]),t.signal)}catch(o){throw t.signal?.aborted&&this.metrics?.dialerEvents.increment({abort:!0}),s.close().catch(a=>{this.log.error("error closing raw socket",a)}),o}return this.log("connected %s",e),this.metrics?.dialerEvents.increment({connect:!0}),s}createListener(e){return IN({logger:this.logger,events:this.components.events,metrics:this.components.metrics},{...this.init,...e})}listenFilter(e){return e=Array.isArray(e)?e:[e],this.init?.filter!=null?this.init?.filter(e):_N(e)}dialFilter(e){return this.listenFilter(e)}}function e9(n={}){return e=>new RN(e,n)}function t9(n,e){const t=e.map((r,i)=>({record:Jn(r),index:i}));return t.sort((r,i)=>{const s=r.record.sequence,o=i.record.sequence;if(s>o)return-1;if(s<o)return 1;if(r.record.validityType===mr.ValidityType.EOL&&i.record.validityType===mr.ValidityType.EOL){const a=Nl.fromString(r.record.validity).toDate(),c=Nl.fromString(i.record.validity).toDate();if(a.getTime()>c.getTime())return-1;if(a.getTime()<c.getTime())return 1}return 0}),t[0].index}const PN="5.5.1",ON="helia",NN={list:["/dnsaddr/bootstrap.libp2p.io/p2p/QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZg5gBMjTezGAJN","/dnsaddr/bootstrap.libp2p.io/p2p/QmbLHAnMoJPWSCR5Zhtx6BHJX9KiKNN6tpvbUcqanj75Nb","/dnsaddr/bootstrap.libp2p.io/p2p/QmcZf59bWwK5XFi76CZX8cbJ4BhTzzA3gU1ZjYZcYW3dwt","/dnsaddr/va1.bootstrap.libp2p.io/p2p/12D3KooWKnDdG3iXw9eTFijk3EWSunZcFi54Zka4wmtqtt6rPxc8","/ip4/104.131.131.82/tcp/4001/p2p/QmaCpDMGvV2BGHeYERUEnRQAwe3N8SzbUtfsmvsqQLuvuJ"]};function r9(n={}){const e=`${ON}/${PN} ${hy()}`;return{privateKey:n.privateKey,dns:n.dns,nodeInfo:{userAgent:e},addresses:{listen:["/p2p-circuit","/webrtc"]},transports:[bC(),pN(),J7(),e9()],connectionEncrypters:[k8()],streamMuxers:[OI(),zR()],peerDiscovery:[nC(NN)],services:{autoNAT:KI(),dcutr:SC(),delegatedRouting:()=>U6("https://delegated-ipfs.dev",RS()),dht:dR({clientMode:!0,validators:{ipns:ca},selectors:{ipns:t9}}),identify:LC(),identifyPush:BC(),keychain:_R(n.keychain),ping:ZR()}}}async function DN(n){const e=n.libp2p??{};e.privateKey==null&&n.datastore!=null&&(e.privateKey=await p_(n.datastore,n.keychain));const t=r9(e);return t.datastore=t.datastore??n.datastore,await py({...t,...e,start:!1})}async function LN(n={}){const e=n.datastore??new z6,t=n.blockstore??new ex;let r;return _k(n.libp2p)?r=n.libp2p:r=await DN({...n,libp2p:{dns:n.dns,...n.libp2p,start:void 0},datastore:e}),{...n,libp2p:r,datastore:e,blockstore:t,blockBrokers:n.blockBrokers??[P6(),y6()],routers:n.routers??[H6(r),q6()],metrics:r.metrics}}async function BN(n={}){const e=await LN(n),t=new wE(e);return e.start!==!1&&await t.start(),t}function MN(){const n=r9();n.start=!1,n.addresses={listen:[]},n.transports=[J7(),e9()],n.peerDiscovery=[];const e={dcutr:n.services.dcutr,identify:n.services.identify,keychain:n.services.keychain,ping:n.services.ping};return{...n,start:!1,services:e}}class FN extends Error{static name="DNSLinkNotFoundError";constructor(e="DNSLink not found"){super(e),this.name="DNSLinkNotFoundError"}}class UN extends Error{static name="RecordsFailedValidationError";constructor(e="Records failed validation"){super(e),this.name="RecordsFailedValidationError"}}class $N extends Error{static name="UnsupportedMultibasePrefixError";constructor(e="Unsupported multibase prefix"){super(e),this.name="UnsupportedMultibasePrefixError"}}class VN extends Error{static name="UnsupportedMultihashCodecError";constructor(e="Unsupported multihash codec"){super(e),this.name="UnsupportedMultihashCodecError"}}class qN extends Error{static name="InvalidValueError";constructor(e="Invalid value"){super(e),this.name="InvalidValueError"}}const HN=32;async function N4(n,e,t,r,i={}){if(e===0)throw new Error("recursion limit exceeded");r("query %s for TXT and CNAME records",n);const o=((await t.query(n,{...i,types:[cn.TXT]}))?.Answer??[]).sort((l,u)=>l.data.localeCompare(u.data));r("found %d TXT records for %s",o.length,n);for(const l of o)try{let u=l.data;if(u.startsWith('"')&&u.endsWith('"')&&(u=u.substring(1,u.length-1)),!u.startsWith("dnslink="))continue;r("%s TXT %s",l.name,u),u=u.replace("dnslink=","");const[,d,h,...f]=u.split("/");if(d==="ipfs")try{return{value:`/ipfs/${he.parse(h)}${f.length>0?`/${f.join("/")}`:""}`,answer:l}}catch{}else if(d==="ipns"){try{let m;return h.charAt(0)==="1"||h.charAt(0)==="Q"?m=Ot(h):m=rs(he.parse(h)),{value:`/ipns/${m}${f.length>0?`/${f.join("/")}`:""}`,answer:l}}catch{}return await yl(h,e-1,t,r,i)}else{if(d==="dnslink")return await yl(h,e-1,t,r,i);r('unknown protocol "%s" in DNSLink record for domain: %s',d,n);continue}}catch(u){r.error("could not parse DNS link record for domain %s, %s",n,l.data,u)}r("no DNSLink records found for %s, falling back to CNAME",n);const c=((await t.query(n,{...i,types:[cn.CNAME]}))?.Answer??[]).sort((l,u)=>l.data.localeCompare(u.data));r("found %d CNAME records for %s",c.length,n);for(const l of c)try{return await yl(l.data,e-1,t,r,i)}catch(u){r.error("domain %s cname %s had no DNSLink records",n,l.data,u)}throw new FN(`No DNSLink records found for domain: ${n}`)}async function yl(n,e,t,r,i={}){if(e===0)throw new Error("recursion limit exceeded");n.startsWith("_dnslink.")||(n=`_dnslink.${n}`);try{return await N4(n,e,t,r,i)}catch(s){if(s.code!=="ENOTFOUND"&&s.code!=="ENODATA"&&s.name!=="DNSLinkNotFoundError"&&s.name!=="NotFoundError")throw s;return n.startsWith("_dnslink.")?n=n.replace("_dnslink.",""):n=`_dnslink.${n}`,N4(n,e,t,r,i)}}async function zN(n,e,t,r={}){return yl(n,r.maxRecursiveDepth??HN,e,t,r)}class KN{routing;constructor(e){this.routing=e}async put(e,t,r={}){try{await this.routing.put(e,t,r)}catch(i){throw r.onProgress?.(new P("ipns:routing:helia:error",i)),i}}async get(e,t={}){try{return await this.routing.get(e,t)}catch(r){throw t.onProgress?.(new P("ipns:routing:helia:error",r)),r}}}function WN(n){return new KN(n)}function il(n){return new Te("/dht/record/"+ee(n,"base32"),!1)}function GN(n){return{async put(e,t,r={}){try{const i=il(e);try{const o=await n.get(i),a=Rt.deserialize(o);if(Ue(a.value,t))return}catch(o){if(o.name!=="NotFoundError")throw o}const s=new Rt(e,t,new Date);r.onProgress?.(new P("ipns:routing:datastore:put")),await n.put(i,s.serialize(),r)}catch(i){throw r.onProgress?.(new P("ipns:routing:datastore:error",i)),i}},async get(e,t={}){try{const r=il(e);t.onProgress?.(new P("ipns:routing:datastore:get"));const i=await n.get(r,t),s=Rt.deserialize(i);return{record:s.value,created:s.timeReceived}}catch(r){throw t.onProgress?.(new P("ipns:routing:datastore:error",r)),r}},async has(e,t={}){const r=il(e);return n.has(r,t)},async delete(e,t){const r=il(e);return n.delete(r,t)}}}const jN=0,QN=18,D4="/ipns/";function L4(n,e){return n.code===e}const yn=mt("helia:ipns"),n9=60*1e3,i9=60*n9,YN=48*i9,l1=23*i9,B4=BigInt(n9)*5000000n,M4={[Li.prefix]:Li,[Di.prefix]:Di};class XN{routers;localStore;timeout;dns;log;constructor(e,t=[]){this.routers=[WN(e.routing),...t],this.localStore=GN(e.datastore),this.dns=e.dns,this.log=e.logger.forComponent("helia:ipns")}async publish(e,t,r={}){try{let i=1n;const s=aa(e.publicKey.toMultihash());if(await this.localStore.has(s,r)){const{record:l}=await this.localStore.get(s,r);i=Jn(l).sequence+1n}const o=r.ttl!=null?BigInt(r.ttl)*1000000n:B4,a=await ES(e,t,i,r.lifetime??YN,{...r,ttlNs:o}),c=Dl(a);return await this.localStore.put(s,c,r),r.offline!==!0&&await Promise.all(this.routers.map(async l=>{await l.put(s,c,r)})),a}catch(i){throw r.onProgress?.(new P("ipns:publish:error",i)),i}}async resolve(e,t={}){const r=Av(e)?e.toMultihash():e,i=aa(r),s=await this.#t(i,t);return{...await this.#e(s.value,t),record:s}}async resolveDNSLink(e,t={}){const r=await zN(e,this.dns,this.log,t);return{...await this.#e(r.value,t),answer:r.answer}}republish(e={}){if(this.timeout!=null)throw new Error("Republish is already running");e.signal?.addEventListener("abort",()=>{clearTimeout(this.timeout)});async function t(){const r=Date.now();e.onProgress?.(new P("ipns:republish:start"));const s=Date.now()-r;let o=l1-s;o<0&&(o=e.interval??l1),setTimeout(()=>{t().catch(a=>{yn.error("error republishing",a)})},o)}this.timeout=setTimeout(()=>{t().catch(r=>{yn.error("error republishing",r)})},e.interval??l1)}async#e(e,t={}){const r=e.split("/");try{const i=r[1];if(i==="ipns"){const s=r[2],o=s.substring(0,1);let a;if(o==="1"||o==="Q")a=Di.decode(`z${s}`);else if(M4[o]!=null)a=M4[o].decode(s);else throw new $N(`Unsupported multibase prefix "${o}"`);let c;try{c=zt(a)}catch{c=he.decode(a).multihash}if(!L4(c,jN)&&!L4(c,QN))throw new VN(`Unsupported multihash codec "${c.code}"`);const{cid:l}=await this.resolve(c,t),u=r.slice(3).join("/");return{cid:l,path:u}}else if(i==="ipfs"){const s=he.parse(r[2]),o=r.slice(3).join("/");return{cid:s,path:o}}}catch(i){yn.error("error parsing ipfs path",i)}throw yn.error("invalid ipfs path %s",e),new qN("Invalid value")}async#t(e,t={}){const r=[];if(await this.localStore.has(e,t))if(yn("record is present in the cache"),t.nocache!==!0)try{const{record:a,created:c}=await this.localStore.get(e,t);this.log("record retrieved from cache"),await ca(e,a),this.log("record was valid");const l=Jn(a),u=Number((l.ttl??B4)/1000000n);if(c.getTime()+u>Date.now())return this.log("record TTL was valid"),l;if(t.offline===!0)return this.log("record TTL has been reached but we are resolving offline-only, returning record"),l;this.log("record TTL has been reached, searching routing for updates"),r.push(a)}catch(a){this.log("cached record was invalid",a),await this.localStore.delete(e,t)}else yn("ignoring local cache due to nocache=true option");if(t.offline===!0)throw new Xe("Record was not present in the cache or has expired");yn("did not have record locally");let s=0;if(await Promise.all(this.routers.map(async a=>{let c;try{c=await a.get(e,{...t,validate:!1})}catch(l){yn.error("error finding IPNS record",l);return}try{await ca(e,c),r.push(c)}catch(l){s++,yn.error("error finding IPNS record",l)}})),r.length===0)throw s>0?new UN(`${s>1?`${s} records`:"Record"} found for routing key ${s>1?"were":"was"} invalid`):new Xe("Could not find record for routing key");const o=r[t9(e,r)];return await this.localStore.put(e,o,t),Jn(o)}async republishRecord(e,t,r={}){let i;try{if(i=D6(t)?.toMultihash(),i==null)if(typeof e=="string"){e.startsWith(D4)&&(e=e.slice(D4.length));try{i=Ot(e).toMultihash()}catch(a){throw new Error(`Invalid string key: ${a.message}`)}}else i=e;if(i==null)throw new Error("No public key multihash found to determine the routing key");const s=aa(i),o=Dl(t);await ca(s,o),await this.localStore.put(s,o,r),r.offline!==!0&&await Promise.all(this.routers.map(async a=>{await a.put(s,o,r)}))}catch(s){throw r.onProgress?.(new P("ipns:republish:error",{key:i,record:t,err:s})),s}}}function ZN(n,{routers:e=[]}={}){return new XN(n,e)}class s9 extends Map{#e=0;#t=new Map;#r=new Map;#o;#c;#l;constructor(e={}){if(super(),!(e.maxSize&&e.maxSize>0))throw new TypeError("`maxSize` must be a number greater than 0");if(typeof e.maxAge=="number"&&e.maxAge===0)throw new TypeError("`maxAge` must be a number greater than 0");this.#o=e.maxSize,this.#c=e.maxAge||Number.POSITIVE_INFINITY,this.#l=e.onEviction}get __oldCache(){return this.#r}#s(e){if(typeof this.#l=="function")for(const[t,r]of e)this.#l(t,r.value)}#n(e,t){return typeof t.expiry=="number"&&t.expiry<=Date.now()?(typeof this.#l=="function"&&this.#l(e,t.value),this.delete(e)):!1}#i(e,t){if(this.#n(e,t)===!1)return t.value}#f(e,t){return t.expiry?this.#i(e,t):t.value}#a(e,t){const r=t.get(e);return this.#f(e,r)}#d(e,t){this.#t.set(e,t),this.#e++,this.#e>=this.#o&&(this.#e=0,this.#s(this.#r),this.#r=this.#t,this.#t=new Map)}#u(e,t){this.#r.delete(e),this.#d(e,t)}*#h(){for(const e of this.#r){const[t,r]=e;this.#t.has(t)||this.#n(t,r)===!1&&(yield e)}for(const e of this.#t){const[t,r]=e;this.#n(t,r)===!1&&(yield e)}}get(e){if(this.#t.has(e)){const t=this.#t.get(e);return this.#f(e,t)}if(this.#r.has(e)){const t=this.#r.get(e);if(this.#n(e,t)===!1)return this.#u(e,t),t.value}}set(e,t,{maxAge:r=this.#c}={}){const i=typeof r=="number"&&r!==Number.POSITIVE_INFINITY?Date.now()+r:void 0;return this.#t.has(e)?this.#t.set(e,{value:t,expiry:i}):this.#d(e,{value:t,expiry:i}),this}has(e){return this.#t.has(e)?!this.#n(e,this.#t.get(e)):this.#r.has(e)?!this.#n(e,this.#r.get(e)):!1}peek(e){if(this.#t.has(e))return this.#a(e,this.#t);if(this.#r.has(e))return this.#a(e,this.#r)}expiresIn(e){const t=this.#t.get(e)??this.#r.get(e);if(t)return t.expiry?t.expiry-Date.now():Number.POSITIVE_INFINITY}delete(e){const t=this.#t.delete(e);return t&&this.#e--,this.#r.delete(e)||t}clear(){this.#t.clear(),this.#r.clear(),this.#e=0}resize(e){if(!(e&&e>0))throw new TypeError("`maxSize` must be a number greater than 0");const t=[...this.#h()],r=t.length-e;r<0?(this.#t=new Map(t),this.#r=new Map,this.#e=t.length):(r>0&&this.#s(t.slice(0,r)),this.#r=new Map(t.slice(r)),this.#t=new Map,this.#e=0),this.#o=e}evict(e=1){const t=Number(e);if(!t||t<=0)return;const r=[...this.#h()],i=Math.trunc(Math.min(t,Math.max(r.length-1,0)));i<=0||(this.#s(r.slice(0,i)),this.#r=new Map(r.slice(i)),this.#t=new Map,this.#e=0)}*keys(){for(const[e]of this)yield e}*values(){for(const[,e]of this)yield e}*[Symbol.iterator](){for(const e of this.#t){const[t,r]=e;this.#n(t,r)===!1&&(yield[t,r.value])}for(const e of this.#r){const[t,r]=e;this.#t.has(t)||this.#n(t,r)===!1&&(yield[t,r.value])}}*entriesDescending(){let e=[...this.#t];for(let t=e.length-1;t>=0;--t){const r=e[t],[i,s]=r;this.#n(i,s)===!1&&(yield[i,s.value])}e=[...this.#r];for(let t=e.length-1;t>=0;--t){const r=e[t],[i,s]=r;this.#t.has(i)||this.#n(i,s)===!1&&(yield[i,s.value])}}*entriesAscending(){for(const[e,t]of this.#h())yield[e,t.value]}get size(){if(!this.#e)return this.#r.size;let e=0;for(const t of this.#r.keys())this.#t.has(t)||e++;return Math.min(this.#e+e,this.#o)}get maxSize(){return this.#o}entries(){return this.entriesAscending()}forEach(e,t=this){for(const[r,i]of this.entriesAscending())e.call(t,i,r,this)}get[Symbol.toStringTag](){return"QuickLRU"}toString(){return`QuickLRU(${this.size}/${this.maxSize})`}[Symbol.for("nodejs.util.inspect.custom")](){return this.toString()}}function f2(n,e={}){const t=Ip(n),r={_cancelled:!1,async start(){this._cancelled=!1},async pull(i){try{const{value:s,done:o}=await t.next();if(this._cancelled)return;if(o===!0){i.close();return}i.enqueue(s)}catch(s){i.error(s)}},cancel(){this._cancelled=!0}};return new globalThis.ReadableStream(r,e)}class pr extends Error{static name="InvalidRangeError";constructor(e="Invalid range request"){super(e),this.name="InvalidRangeError"}}let JN=class extends Error{static name="NoContentError";constructor(e="No content found"){super(e),this.name="NoContentError"}};class eD extends Error{static name="SubdomainNotSupportedError";constructor(e="Subdomain not supported"){super(e),this.name="SubdomainNotSupportedError"}}function tD(n,e){if(n==null)return;if(n instanceof Headers)return n.get(e)??void 0;if(Array.isArray(n))return n.find(([i])=>i.toLowerCase()===e.toLowerCase())?.[1];const t=Object.keys(n).find(r=>r.toLowerCase()===e.toLowerCase());if(t!=null)return n[t]}function rD(n,e,t){if((n??0)>(e??1/0))throw new pr("Invalid range: Range-start index is greater than range-end index.");if(n!=null&&(e??0)>=(t??1/0))throw new pr("Invalid range: Range-end index is greater than or equal to the size of the file.");if(n==null&&(e??0)>(t??1/0))throw new pr("Invalid range: Range-end index is greater than the size of the file.");if(n!=null&&n<0)throw new pr("Invalid range: Range-start index cannot be negative.");if(n!=null&&e!=null)return{byteSize:e-n+1,start:n,end:e};if(n==null&&e!=null)return t==null?{end:e}:e===t?{byteSize:t,start:0,end:t-1}:{byteSize:e,start:t-e,end:t-1};if(n!=null&&e==null){if(t==null)return{start:n};const r=t-1;return{byteSize:t-n,start:n,end:r}}return{byteSize:t,start:0,end:t!=null?t-1:0}}function nD({ttl:n,protocol:e,response:t}){if(t.headers.has("cache-control"))return;let r;e==="ipfs"?r="public, max-age=29030400, immutable":n==null?r="public, max-age=300":r=`public, max-age=${n}`,t.headers.set("cache-control",r)}function u1({byteStart:n,byteEnd:e,byteSize:t}){const r=t??"*";if((e??0)>=(t??1/0))throw new pr("Invalid range: Range-end index is greater than or equal to the size of the file.");if((n??0)>=(t??1/0))throw new pr("Invalid range: Range-start index is greater than or equal to the size of the file.");if(n!=null&&e==null)return t==null?`bytes */${r}`:`bytes ${n}-${t-1}/${t}`;if(n==null&&e!=null){if(t==null)return`bytes */${r}`;const i=t-1;return`bytes ${i-e+1}-${i}/${t}`}return n==null&&e==null?`bytes */${r}`:`bytes ${n}-${e}/${r}`}function o9(n,e){e!=null&&n.headers.set("X-Ipfs-Roots",iD(e))}function iD(n){return n.map(e=>e.toV1().toString()).join(",")}function sD(n){return typeof n=="string"?n.length:n instanceof ArrayBuffer||n instanceof Uint8Array?n.byteLength:n instanceof Blob?n.size:(n instanceof ReadableStream,null)}function oD(n){if(!n.startsWith("bytes="))throw new pr("Invalid range request");const t=n.substring(6).split(",").map(i=>i.trim()),r=[];for(const i of t){const s=i.match(/^(?<start>\d+)?-(?<end>\d+)?$/);if(s?.groups==null)throw new pr(`Invalid range specification: ${i}`);const{start:o,end:a}=s.groups;r.push({start:o??null,end:a??null})}if(r.length===0)throw new pr("No valid ranges found");return{ranges:r}}class aD{headers;isRangeRequest;_fileSize;_body=null;rangeRequestHeader;log;multiPartBoundary;requestRanges=[];byteRanges=[];isMultiRangeRequest=!1;_isValidRangeRequest=!1;constructor(e,t){if(this.headers=t,this.log=e.forComponent("helia:verified-fetch:byte-range-context"),this.rangeRequestHeader=tD(this.headers,"Range"),this.rangeRequestHeader!=null){this.isRangeRequest=!0,this.log.trace("range request detected");try{const{ranges:r}=oD(this.rangeRequestHeader);this.isMultiRangeRequest=r.length>1,this.requestRanges=r.map(i=>({start:i.start!=null?parseInt(i.start):null,end:i.end!=null?parseInt(i.end):null})),this.multiPartBoundary=`multipart_byteranges_${Math.floor(Math.random()*1e9)}`}catch(r){this.log.error("error parsing range request header - %e",r),this.requestRanges=[]}this.setOffsetDetails()}else this.log.trace("no range request detected"),this.isRangeRequest=!1}getByteRanges(){return this.byteRanges}setBody(e,t="application/octet-stream"){typeof e=="function"?this._body=this.createRangeStream(e,t):(this._body=e,this.setFileSize(this._fileSize??sD(e))),this.log.trace("set request body with fileSize %o",this._fileSize)}getBody(e){const t=this._body;if(t==null)return this.log.trace("body is null"),t;if(!this.isRangeRequest||!this.isValidRangeRequest)return this.log.trace("returning body unmodified for non-range, or invalid range, request"),t;if(this.isMultiRangeRequest)return this._body instanceof ReadableStream?this._body:f2(this.getMultipartBody(e));if(this.byteRanges.length>0){const r=this.byteRanges[0];return t instanceof ReadableStream?t:((r.start!=null||r.end!=null)&&this.log.trace("returning body with byteStart=%o, byteEnd=%o, byteSize=%o",r.start,r.end,r.size),this.getSlicedBody(t,r))}return this.log.error("returning unmodified body for valid range request"),t}getSlicedBody(e,t){const r=t.start??0;let i;return t.end!=null&&t.start!=null?i=t.end-t.start+1:i=void 0,this.log.trace("slicing body with offset=%o and length=%o",r,i),typeof e=="string"||e instanceof Blob||e instanceof ArrayBuffer||e instanceof Uint8Array?e.slice(r,i!==void 0?r+i:void 0):e}setFileSize(e){this._fileSize=e!=null?Number(e):null,this._isValidRangeRequest=!1,this.log.trace("set _fileSize to %o",this._fileSize),this.setOffsetDetails()}getFileSize(){return this._fileSize}isValidByteStart(e,t){return!(e!=null&&(e<0||this._fileSize!=null&&e>=this._fileSize||t!=null&&e>t))}isValidByteEnd(e,t){if(t!=null){if(t<0)return this.log.trace("invalid range request, byteEnd is less than 0"),!1;if(this._fileSize!=null&&t>=this._fileSize)return this.log.trace("invalid range request, byteEnd is greater than fileSize"),!1;if(e!=null&&t<e)return this.log.trace("invalid range request, byteEnd is less than byteStart"),!1}return!0}isValidByteRange(e){return this.log.trace("validating byte range: %o",e),e.start!=null&&!this.isValidByteStart(e.start,e.end)?(this.log.trace("invalid range request, byteStart is less than 0 or greater than fileSize"),!1):e.end!=null&&!this.isValidByteEnd(e.start,e.end)?(this.log.trace("invalid range request, byteEnd is less than 0 or greater than fileSize"),!1):!0}get isValidRangeRequest(){return this._isValidRangeRequest?!0:this.isRangeRequest?this.byteRanges.length===0?(this.log.trace("invalid range request, no valid ranges"),!1):this.byteRanges.every(t=>this.isValidByteRange(t))?(this._isValidRangeRequest=!0,!0):(this.log.trace("invalid range request, not all ranges are valid"),!1):!1}getLength(e){if(!this.isValidRangeRequest){this.log.error("cannot get length for invalid range request");return}if(!(this.isMultiRangeRequest&&e==null))return e??=this.byteRanges[0],this.log.trace("getting length for range: %o",e),e.end!=null&&e.start!=null?e.end-e.start+1:e.end!=null?e.end+1:e.size}setOffsetDetails(){if(this.requestRanges.length===0){this.log.trace("no request ranges defined");return}try{this.byteRanges=this.requestRanges.map(e=>{const{start:t,end:r,byteSize:i}=rD(e.start??void 0,e.end??void 0,this._fileSize??void 0);return{start:t,end:r,size:i}}),this.log.trace("set byte ranges: %o",this.byteRanges)}catch(e){this.log.error("error setting offset details: %o",e),this.byteRanges=[]}}async convertToUint8Array(e){if(typeof e=="string")return new TextEncoder().encode(e);if("arrayBuffer"in e&&typeof e.arrayBuffer=="function"){const t=await e.arrayBuffer();return new Uint8Array(t)}if("byteLength"in e&&!("buffer"in e))return new Uint8Array(e);if("buffer"in e&&"byteLength"in e&&"byteOffset"in e)return e;throw new Error("Unsupported content type for multipart response")}async*getMultipartBody(e="application/octet-stream"){const t=this._body;if(t instanceof ReadableStream)return t;if(t===null)throw new Error("Cannot create multipart body from null");const r=new TextEncoder;for(const i of this.byteRanges){if(i.start===void 0||i.end===void 0)continue;const s=`\r
--${this.multiPartBoundary}\r
Content-Type: ${e}\r
Content-Range: ${u1({byteStart:i.start,byteEnd:i.end,byteSize:this._fileSize??void 0})}\r
\r
`;yield r.encode(s);const o=this.getSlicedBodyForRange(t,i.start,i.end);yield await this.convertToUint8Array(o)}yield r.encode(`\r
--${this.multiPartBoundary}--`)}getSlicedBodyForRange(e,t,r){const i=t,s=r-t+1;return this.log.trace("slicing body with offset=%o and length=%o",i,s),typeof e=="string"||e instanceof Blob||e instanceof ArrayBuffer||e instanceof Uint8Array?e.slice(i,i+s):e}getContentType(){if(this.isMultiRangeRequest&&this.isValidRangeRequest)return`multipart/byteranges; boundary=${this.multiPartBoundary}`}get contentRangeHeaderValue(){if(!this.isValidRangeRequest)throw this.log.error("cannot get contentRangeHeaderValue for invalid range request"),new pr("Invalid range request");if(this.isMultiRangeRequest)throw this.log.error("contentRangeHeaderValue should not be called for multipart responses"),new pr("Content-Range header not applicable for multipart responses");if(this.byteRanges.length>0){const e=this.byteRanges[0];return u1({byteStart:e.start,byteEnd:e.end,byteSize:this._fileSize??void 0})}throw new pr("No valid ranges found")}createRangeStream(e,t){const r=new TextEncoder,i=this.byteRanges,s=this.multiPartBoundary,o=this._fileSize,a=this.log,c=this.isMultiRangeRequest;if(i.length===0)throw a.error("Cannot create range stream with no byte ranges"),new pr("No valid ranges found");return new ReadableStream({async start(l){try{for(const u of i){if(c){const d=`\r
--${s}\r
Content-Type: ${t}\r
Content-Range: ${u1({byteStart:u.start,byteEnd:u.end,byteSize:o??void 0})}\r
\r
`;l.enqueue(r.encode(d))}try{const d=e(u);for await(const h of d)l.enqueue(h)}catch(d){throw a.error("Error processing range %o: %o",u,d),d}}c&&l.enqueue(r.encode(`\r
--${s}--`)),l.close()}catch(u){a.error("Error processing range(s): %o",u),l.error(u)}}})}}function p2(n,e,t){Object.defineProperty(n,e,{enumerable:!0,configurable:!1,set:()=>{},get:()=>t})}function Bn(n,e){p2(n,"type",e)}function Mn(n,e){p2(n,"url",e)}function a9(n){p2(n,"redirected",!0)}function cD(n,e,t){const r=new Response(e,{...t??{},status:200,statusText:"OK"});return t?.redirected===!0&&a9(r),Bn(r,"basic"),Mn(r,n),r}function g2(n,e,t){const r=new Response(e,{status:502,statusText:"Bad Gateway"});return Bn(r,"basic"),Mn(r,n),r}function c9(n,e,t){const r=new Response(e,{status:501,statusText:"Not Implemented"});return r.headers.set("X-Content-Type-Options","nosniff"),Bn(r,"basic"),Mn(r,n),r}function ec(n,e,t){const r=new Response(e,{status:406,statusText:"Not Acceptable"});return Bn(r,"basic"),Mn(r,n),r}function l9(n,e,t){const r=new Response(e,{status:404,statusText:"Not Found"});return Bn(r,"basic"),Mn(r,n),r}function lD(n){return Array.isArray(n)&&n.every(e=>e instanceof Error)}function x0(n,e,t){let r,i;lD(e)?(r=e[e.length-1].stack,i=e.map(a=>({message:a.message,stack:a.stack??""}))):e instanceof Error&&(r=e.stack,i=[{message:e.message,stack:e.stack??""}]);const s=JSON.stringify({stack:r,errors:i}),o=new Response(s,{status:400,statusText:"Bad Request",headers:{"Content-Type":"application/json"}});return Bn(o,"basic"),Mn(o,n),o}function A0(n,e,t){const r=new Response(null,{status:301,statusText:"Moved Permanently",headers:{location:e}});return Bn(r,"basic"),Mn(r,n),r}function cs(n,e,{byteRangeContext:t,log:r},i){if(!t.isRangeRequest)return cD(n,e,i);if(!t.isValidRangeRequest)return Nu(n,e,i);let s;try{const o=new Headers(i?.headers),a=t.getContentType();a!=null?o.set("content-type",a):t.isMultiRangeRequest?o.set("content-type","multipart/byteranges"):o.set("content-range",t.contentRangeHeaderValue),s=new Response(e,{...i??{},status:206,statusText:"Partial Content",headers:o})}catch(o){return r?.error("failed to create range response",o),Nu(n,e,i)}return i?.redirected===!0&&a9(s),Bn(s,"basic"),Mn(s,n),s}function Nu(n,e,t){const r=new Response(e,{...t??{},status:416,statusText:"Requested Range Not Satisfiable"});return Bn(r,"basic"),Mn(r,n),r}class Fn{codes=[];pluginOptions;_log;get log(){return this._log==null&&(this._log=this.pluginOptions.logger.forComponent(this.id)),this._log}constructor(e){this.pluginOptions=e}}class uD extends Fn{id="byte-range-context-plugin";canHandle(e){return e.byteRangeContext==null}async handle(e){return e.byteRangeContext=new aD(this.pluginOptions.logger,e.options?.headers),e.modified++,e.byteRangeContext.isRangeRequest&&!e.byteRangeContext.isValidRangeRequest?Nu(e.resource):null}}const dD=1,hD=112,fD=85;class u9{async*export(e,t){for(const[,r]of t.links())yield r}}class pD{target;constructor(e){this.target=e}isTarget(e){return this.target.equals(e)}async*traverse(e,t){for(const[,r]of t.links())yield r}}class gD{components;log;constructor(e,t){this.components=e,this.log=e.logger.forComponent("helia:car")}async import(e,t){await xn(this.components.blockstore.putMany(un(e.blocks(),({cid:r,bytes:i})=>({cid:r,block:i})),t))}async export(e,t,r){const i=we(),s=Array.isArray(e)?e:[e],o={currentPath:[],pathsToTarget:null},a=r?.traversal,c=r?.exporter??new u9,l=new ed({concurrency:dD});let u=!1;l.on("idle",()=>{if(u)i.resolve();else if(!u&&o.pathsToTarget?.length===s.length){this.log.trace("starting export of blocks to the car file"),u=!0;for(const d of o.pathsToTarget){const h=d.length-1,f=d[h];d.slice(0,-1).forEach(m=>{l.add(async()=>{await this.#t({cid:m,queue:l,writer:t,strategy:c,options:r,recursive:!1})}).catch(y=>{this.log.error("error during queue operation - %e",y)})}),l.add(async()=>{await this.#t({cid:f,queue:l,writer:t,strategy:c,options:r})}).catch(m=>{this.log.error("error during queue operation - %e",m)})}}else this.log.trace("no paths to target, skipping export"),i.reject(new Error("Could not traverse to target CID(s)"))}),l.on("error",d=>{l.clear(),i.reject(d)});for(const d of s)l.add(async()=>{this.log.trace("traversing dag from %c",d),await this.#e({cid:d,queue:l,strategy:a??new pD(d),traversalContext:o,parentPath:[],options:r})}).catch(h=>{this.log.error("error during queue operation - %e",h)});try{await i.promise}finally{await t.close()}}async*stream(e,t){const{writer:r,out:i}=I5.create(e);this.export(e,r,t).catch(s=>{this.log.error("error during streaming export - %e",s)});for await(const s of i)yield s}async#e({cid:e,queue:t,strategy:r,traversalContext:i,parentPath:s,options:o}){const a=[...s,e];if(r.isTarget(e)){i.pathsToTarget=i.pathsToTarget??[],i.pathsToTarget.push([...a]),this.log.trace("found path to target %c",e);return}const c=await this.components.getCodec(e.code),l=await this.components.blockstore.get(e,o),u=A1({bytes:l,cid:e,codec:c});for await(const d of r.traverse(e,u))t.add(async()=>{await this.#e({cid:d,queue:t,strategy:r,traversalContext:i,parentPath:a??[],options:o})}).catch(h=>{this.log.error("error during traversal queue operation - %e",h)})}async#t({cid:e,queue:t,writer:r,strategy:i,options:s,recursive:o=!0}){if(s?.blockFilter?.has(e.multihash.bytes)===!0)return;const a=await this.components.getCodec(e.code),c=await this.components.blockstore.get(e,s);if(s?.blockFilter?.add(e.multihash.bytes),await r.put({cid:e,bytes:c}),o){const l=A1({bytes:c,cid:e,codec:a});for await(const u of i.export(e,l))t.add(async()=>{await this.#t({cid:u,queue:t,writer:r,strategy:i,options:s})}).catch(d=>{this.log.error("error during export queue operation - %e",d)})}}}class F4{async*export(e,t){}}let mD=class extends Error{static code="ERR_NOT_UNIXFS";static message="Not a UnixFS node";static name="NotUnixFSError";code="ERR_NOT_UNIXFS";message="Not a UnixFS node";name="NotUnixFSError"};class yD{async*export(e,t){if(e.code!==hD&&e.code!==fD)throw new mD("Target CID was not UnixFS - use the SubGraphExporter to export arbitrary graphs");for(const[,r]of t.links())yield r}}class wD{pathToTarget;target;constructor(e){this.pathToTarget=e,this.target=e[e.length-1]}isTarget(e){return this.target.equals(e)}async*traverse(e,t){const r=this.pathToTarget.indexOf(e);yield this.pathToTarget[r+1]}}class tc extends Error{static name="InvalidTypeError";static code="ERR_INVALID_TYPE";name=tc.name;code=tc.code;constructor(e="Invalid type"){super(e)}}class Du extends Error{static name="InvalidUnixFSMessageError";static code="ERR_INVALID_MESSAGE";name=Du.name;code=Du.code;constructor(e="Invalid message"){super(e)}}var en;(function(n){(function(r){r.Raw="Raw",r.Directory="Directory",r.File="File",r.Metadata="Metadata",r.Symlink="Symlink",r.HAMTShard="HAMTShard"})(n.DataType||(n.DataType={}));let e;(function(r){r[r.Raw=0]="Raw",r[r.Directory=1]="Directory",r[r.File=2]="File",r[r.Metadata=3]="Metadata",r[r.Symlink=4]="Symlink",r[r.HAMTShard=5]="HAMTShard"})(e||(e={})),(function(r){r.codec=()=>Jt(e)})(n.DataType||(n.DataType={}));let t;n.codec=()=>(t==null&&(t=pe((r,i,s={})=>{if(s.lengthDelimited!==!1&&i.fork(),r.Type!=null&&(i.uint32(8),n.DataType.codec().encode(r.Type,i)),r.Data!=null&&(i.uint32(18),i.bytes(r.Data)),r.filesize!=null&&(i.uint32(24),i.uint64(r.filesize)),r.blocksizes!=null)for(const o of r.blocksizes)i.uint32(32),i.uint64(o);r.hashType!=null&&(i.uint32(40),i.uint64(r.hashType)),r.fanout!=null&&(i.uint32(48),i.uint64(r.fanout)),r.mode!=null&&(i.uint32(56),i.uint32(r.mode)),r.mtime!=null&&(i.uint32(66),Lu.codec().encode(r.mtime,i)),s.lengthDelimited!==!1&&i.ldelim()},(r,i)=>{const s={blocksizes:[]},o=i==null?r.len:r.pos+i;for(;r.pos<o;){const a=r.uint32();switch(a>>>3){case 1:s.Type=n.DataType.codec().decode(r);break;case 2:s.Data=r.bytes();break;case 3:s.filesize=r.uint64();break;case 4:s.blocksizes.push(r.uint64());break;case 5:s.hashType=r.uint64();break;case 6:s.fanout=r.uint64();break;case 7:s.mode=r.uint32();break;case 8:s.mtime=Lu.codec().decode(r,r.uint32());break;default:r.skipType(a&7);break}}return s})),t),n.encode=r=>ge(r,n.codec()),n.decode=r=>me(r,n.codec())})(en||(en={}));var Lu;(function(n){let e;n.codec=()=>(e==null&&(e=pe((t,r,i={})=>{i.lengthDelimited!==!1&&r.fork(),t.Seconds!=null&&(r.uint32(8),r.int64(t.Seconds)),t.FractionalNanoseconds!=null&&(r.uint32(21),r.fixed32(t.FractionalNanoseconds)),i.lengthDelimited!==!1&&r.ldelim()},(t,r)=>{const i={},s=r==null?t.len:t.pos+r;for(;t.pos<s;){const o=t.uint32();switch(o>>>3){case 1:i.Seconds=t.int64();break;case 2:i.FractionalNanoseconds=t.fixed32();break;default:t.skipType(o&7);break}}return i})),e),n.encode=t=>ge(t,n.codec()),n.decode=t=>me(t,n.codec())})(Lu||(Lu={}));var U4;(function(n){let e;n.codec=()=>(e==null&&(e=pe((t,r,i={})=>{i.lengthDelimited!==!1&&r.fork(),t.MimeType!=null&&(r.uint32(10),r.string(t.MimeType)),i.lengthDelimited!==!1&&r.ldelim()},(t,r)=>{const i={},s=r==null?t.len:t.pos+r;for(;t.pos<s;){const o=t.uint32();switch(o>>>3){case 1:i.MimeType=t.string();break;default:t.skipType(o&7);break}}return i})),e),n.encode=t=>ge(t,n.codec()),n.decode=t=>me(t,n.codec())})(U4||(U4={}));const $4={Raw:"raw",Directory:"directory",File:"file",Metadata:"metadata",Symlink:"symlink",HAMTShard:"hamt-sharded-directory"},vD=["directory","hamt-sharded-directory"],V4=parseInt("0644",8),q4=parseInt("0755",8),H4=BigInt(1024);let xe=class d9{static unmarshal(e){const t=en.decode(e);if(t.fanout!=null&&t.fanout>H4)throw new Du(`Fanout size was too large - ${t.fanout} > ${H4}`);const r=new d9({type:$4[t.Type!=null?t.Type.toString():"File"],data:t.Data,blockSizes:t.blocksizes,mode:t.mode,mtime:t.mtime!=null?{secs:t.mtime.Seconds??0n,nsecs:t.mtime.FractionalNanoseconds}:void 0,fanout:t.fanout});return r._originalMode=t.mode??0,r}type;data;blockSizes;hashType;fanout;mtime;_mode;_originalMode;constructor(e={type:"file"}){const{type:t,data:r,blockSizes:i,hashType:s,fanout:o,mtime:a,mode:c}=e;if(t!=null&&!Object.values($4).includes(t))throw new tc("Type: "+t+" is not valid");this.type=t??"file",this.data=r,this.hashType=s,this.fanout=o,this.blockSizes=i??[],this._originalMode=0,this.mode=c,this.mtime=a}set mode(e){e==null?this._mode=this.isDirectory()?q4:V4:this._mode=e&4095}get mode(){return this._mode}isDirectory(){return vD.includes(this.type)}addBlockSize(e){this.blockSizes.push(e)}removeBlockSize(e){this.blockSizes.splice(e,1)}fileSize(){if(this.isDirectory())return 0n;let e=0n;return this.blockSizes.forEach(t=>{e+=t}),this.data!=null&&(e+=BigInt(this.data.length)),e}marshal(){let e;switch(this.type){case"raw":e=en.DataType.Raw;break;case"directory":e=en.DataType.Directory;break;case"file":e=en.DataType.File;break;case"metadata":e=en.DataType.Metadata;break;case"symlink":e=en.DataType.Symlink;break;case"hamt-sharded-directory":e=en.DataType.HAMTShard;break;default:throw new tc(`Type: ${e} is not valid`)}let t=this.data;(this.data==null||this.data.length===0)&&(t=void 0);let r;this.mode!=null&&(r=this._originalMode&4294963200|(this.mode??0),r===V4&&!this.isDirectory()&&(r=void 0),r===q4&&this.isDirectory()&&(r=void 0));let i;return this.mtime!=null&&(i={Seconds:this.mtime.secs,FractionalNanoseconds:this.mtime.nsecs}),en.encode({Type:e,Data:t,filesize:this.isDirectory()?void 0:this.fileSize(),blocksizes:this.blockSizes,hashType:this.hashType,fanout:this.fanout,mode:r,mtime:i})}};function bD(n,e={}){return new gD(n,e)}function ED({cid:n,ipfsPath:e,query:t}){return t.filename!=null?t.filename:`${e.replace(/\/ipfs\//,"").replace(/\/ipns\//,"").replace(/\//g,"_")}.car`}function SD({query:n}){const e=n["dag-scope"];return e==="all"||e==="entity"||e==="block"?e:"all"}class xD extends Fn{id="car-plugin";canHandle(e){return this.log("checking if we can handle %c with accept %s",e.cid,e.accept),e.byteRangeContext==null||e.pathDetails==null?!1:e.accept?.startsWith("application/vnd.ipld.car")===!0||e.query.format==="car"}async handle(e){const{options:t,pathDetails:r,cid:i}=e;if(r==null)throw new Error("attempted to handle request for car with no path details");const{getBlockstore:s,helia:o}=this.pluginOptions;e.reqFormat="car",e.query.download=!0,e.query.filename=ED(e);const a=s(i,e.resource,t?.session??!0,t),c=bD({blockstore:a,getCodec:o.getCodec,logger:o.logger}),l=r.ipfsRoots.filter(E=>!E.equals(i)),u={...t};l.length>0&&(u.traversal=new wD(l));const d=SD(e),h=r.terminalElement.cid??i;d==="block"?u.exporter=new F4:d==="entity"?h.code===qt?u.exporter=new yD:u.exporter=new F4:u.exporter=new u9;const{writer:f,out:m}=I5.create(h),y=async function*(){for await(const E of m)yield E};c.export(i,f,u).catch(E=>{this.log.error("error exporting car - %e",E)}),e.byteRangeContext.setBody(f2(y()));const w=cs(e.resource,e.byteRangeContext.getBody("application/vnd.ipld.car; version=1"),{byteRangeContext:e.byteRangeContext,log:this.log});return w.headers.set("content-type",e.byteRangeContext.getContentType()??"application/vnd.ipld.car; version=1"),w}}function AD(n){const e=Si(n,{allowIndefinite:!1,coerceUndefinedToNull:!1,allowNaN:!1,allowInfinity:!1,strict:!0,useMaps:!1,rejectDuplicateMapKeys:!0,allowBigInt:!1});return new TextDecoder().decode(jw(e))}class Un extends Error{name;code;constructor(e,t,r){super(e),this.name=t,this.code=r}}let Eo=class extends Un{constructor(e="not a Unixfs node"){super(e,"NotUnixFSError","ERR_NOT_UNIXFS")}};class es extends Un{constructor(e="invalid PBNode"){super(e,"InvalidPBNodeError","ERR_INVALID_PB_NODE")}}class m2 extends Un{constructor(e="unknown error"){super(e,"InvalidPBNodeError","ERR_UNKNOWN_ERROR")}}class h9 extends Un{constructor(e="path already exists"){super(e,"AlreadyExistsError","ERR_ALREADY_EXISTS")}}class f9 extends Un{constructor(e="path does not exist"){super(e,"DoesNotExistError","ERR_DOES_NOT_EXIST")}}class p9 extends Un{constructor(e="no content"){super(e,"NoContentError","ERR_NO_CONTENT")}}class kD extends Un{constructor(e="not a file"){super(e,"NotAFileError","ERR_NOT_A_FILE")}}class y2 extends Un{constructor(e="not a directory"){super(e,"NotADirectoryError","ERR_NOT_A_DIRECTORY")}}let $r=class extends Un{constructor(e="invalid parameters"){super(e,"InvalidParametersError","ERR_INVALID_PARAMETERS")}};class Bu extends Error{static name="BadPathError";static code="ERR_BAD_PATH";name=Bu.name;code=Bu.code;constructor(e="Bad path"){super(e)}}class Rn extends Error{static name="NotFoundError";static code="ERR_NOT_FOUND";name=Rn.name;code=Rn.code;constructor(e="Not found"){super(e)}}class Mu extends Error{static name="NoResolverError";static code="ERR_NO_RESOLVER";name=Mu.name;code=Mu.code;constructor(e="No resolver"){super(e)}}class Tt extends Error{static name="NotUnixFSError";static code="ERR_NOT_UNIXFS";name=Tt.name;code=Tt.code;constructor(e="Not UnixFS"){super(e)}}class Fu extends Error{static name="OverReadError";static code="ERR_OVER_READ";name=Fu.name;code=Fu.code;constructor(e="Over read"){super(e)}}class Uu extends Error{static name="UnderReadError";static code="ERR_UNDER_READ";name=Uu.name;code=Uu.code;constructor(e="Under read"){super(e)}}class $u extends Error{static name="NoPropError";static code="ERR_NO_PROP";name=$u.name;code=$u.code;constructor(e="No Property found"){super(e)}}let sl=class k0 extends Error{static name="InvalidParametersError";static code="ERR_INVALID_PARAMS";name=k0.name;code=k0.code;constructor(e="Invalid parameters"){super(e)}};function w2(n,e,t,r,i,s,o){let a=n,c=i;for(;s.length>0;){const l=s[0];if(l in a){s.shift(),c=`${c}/${l}`;const u=he.asCID(a[l]);if(u!=null)return{entry:{type:"object",name:r,path:i,cid:t,node:e,depth:o,size:BigInt(e.length),content:async function*(){yield n}},next:{cid:u,name:l,path:c,toResolve:s}};a=a[l]}else throw new $u(`No property named ${l} found in node ${t}`)}return{entry:{type:"object",name:r,path:i,cid:t,node:e,depth:o,size:BigInt(e.length),content:async function*(){yield n}}}}const _D=async(n,e,t,r,i,s,o,a)=>{const c=await o.get(n,a),l=$0(c);return w2(l,c,n,e,t,r,s)},ID=async(n,e,t,r,i,s,o,a)=>{const c=await o.get(n,a),l=_5(c);return w2(l,c,n,e,t,r,s)};function Vu(n,e,t,r){const i=BigInt(n.length),s=BigInt(e+i);return t>=s||r<e?new Uint8Array(0):(r>=e&&r<s&&(n=n.subarray(0,Number(r-e))),t>=e&&t<s&&(n=n.subarray(Number(t-e))),n)}const v2=(n,e=0,t=n)=>{const r=BigInt(n),i=BigInt(e??0);let s=BigInt(t);if(s!==r&&(s=i+s),s>r&&(s=r),i<0n)throw new sl("Offset must be greater than or equal to 0");if(i>r)throw new sl("Offset must be less than the file size");if(s<0n)throw new sl("Length must be greater than or equal to 0");if(s>r)throw new sl("Length must be less than the file size");return{start:i,end:s}},CD=n=>{async function*e(t={}){const{start:r,end:i}=v2(n.length,t.offset,t.length),s=Vu(n,0n,r,i);t.onProgress?.(new P("unixfs:exporter:progress:identity",{bytesRead:BigInt(s.byteLength),totalBytes:i-r,fileSize:BigInt(n.byteLength)})),yield s}return e},TD=async(n,e,t,r,i,s,o,a)=>{if(r.length>0)throw new Rn(`No link named ${t} found in raw node ${n}`);const c=zt(n.multihash.bytes);return{entry:{type:"identity",name:e,path:t,cid:n,content:CD(c.digest),depth:s,size:BigInt(c.digest.length),node:c.digest}}},RD=async(n,e,t,r,i,s,o,a)=>{const c=await o.get(n,a),l=Qw(c);return w2(l,c,n,e,t,r,s)},PD=n=>{async function*e(t={}){const{start:r,end:i}=v2(n.length,t.offset,t.length),s=Vu(n,0n,r,i);t.onProgress?.(new P("unixfs:exporter:progress:raw",{bytesRead:BigInt(s.byteLength),totalBytes:i-r,fileSize:BigInt(n.byteLength)})),yield s}return e},OD=async(n,e,t,r,i,s,o,a)=>{if(r.length>0)throw new Rn(`No link named ${t} found in raw node ${n}`);const c=await o.get(n,a);return{entry:{type:"raw",name:e,path:t,cid:n,content:PD(c),depth:s,size:BigInt(c.length),node:c}}};var d1,z4;function ND(){if(z4)return d1;z4=1;const n=7;d1=class{constructor(){this._bitArrays=[],this._data=[],this._length=0,this._changedLength=!1,this._changedData=!1}set(o,a){let c=this._internalPositionFor(o,!1);if(a===void 0)c!==-1&&(this._unsetInternalPos(c),this._unsetBit(o),this._changedLength=!0,this._changedData=!0);else{let l=!1;c===-1?(c=this._data.length,this._setBit(o),this._changedData=!0):l=!0,this._setInternalPos(c,o,a,l),this._changedLength=!0}}unset(o){this.set(o,void 0)}get(o){this._sortData();const a=this._internalPositionFor(o,!0);if(a!==-1)return this._data[a][1]}push(o){return this.set(this.length,o),this.length}get length(){if(this._sortData(),this._changedLength){const o=this._data[this._data.length-1];this._length=o?o[0]+1:0,this._changedLength=!1}return this._length}forEach(o){let a=0;for(;a<this.length;)o(this.get(a),a,this),a++}map(o){let a=0,c=new Array(this.length);for(;a<this.length;)c[a]=o(this.get(a),a,this),a++;return c}reduce(o,a){let c=0,l=a;for(;c<this.length;){const u=this.get(c);l=o(l,u,c),c++}return l}find(o){let a=0,c,l;for(;a<this.length&&!c;)l=this.get(a),c=o(l),a++;return c?l:void 0}_internalPositionFor(o,a){const c=this._bytePosFor(o,a);if(c>=this._bitArrays.length)return-1;const l=this._bitArrays[c],u=o-c*n;if(!((l&1<<u)>0))return-1;const h=this._bitArrays.slice(0,c).reduce(e,0),f=~(4294967295<<u+1),m=t(l&f);return h+m-1}_bytePosFor(o,a){const c=Math.floor(o/n),l=c+1;for(;!a&&this._bitArrays.length<l;)this._bitArrays.push(0);return c}_setBit(o){const a=this._bytePosFor(o,!1);this._bitArrays[a]|=1<<o-a*n}_unsetBit(o){const a=this._bytePosFor(o,!1);this._bitArrays[a]&=~(1<<o-a*n)}_setInternalPos(o,a,c,l){const u=this._data,d=[a,c];if(l)this._sortData(),u[o]=d;else{if(u.length)if(u[u.length-1][0]>=a)u.push(d);else if(u[0][0]<=a)u.unshift(d);else{const h=Math.round(u.length/2);this._data=u.slice(0,h).concat(d).concat(u.slice(h))}else this._data.push(d);this._changedData=!0,this._changedLength=!0}}_unsetInternalPos(o){this._data.splice(o,1)}_sortData(){this._changedData&&this._data.sort(r),this._changedData=!1}bitField(){const o=[];let a=8,c=0,l=0,u;const d=this._bitArrays.slice();for(;d.length||c;){c===0&&(u=d.shift(),c=7);const f=Math.min(c,a),m=~(255<<f),y=u&m;l|=y<<8-a,u=u>>>f,c-=f,a-=f,(!a||!c&&!d.length)&&(o.push(l),l=0,a=8)}for(var h=o.length-1;h>0&&o[h]===0;h--)o.pop();return o}compactArray(){return this._sortData(),this._data.map(i)}};function e(s,o){return s+t(o)}function t(s){let o=s;return o=o-(o>>1&1431655765),o=(o&858993459)+(o>>2&858993459),(o+(o>>4)&252645135)*16843009>>24}function r(s,o){return s[0]-o[0]}function i(s){return s[1]}return d1}var DD=ND();const qu=ao(DD);class Bt{_options;_popCount;_parent;_posAtParent;_children;key;constructor(e,t,r=0){this._options=e,this._popCount=0,this._parent=t,this._posAtParent=r,this._children=new qu,this.key=null}async put(e,t){const r=await this._findNewBucketAndPos(e);r.bucket._putAt(r,e,t)}async get(e){const t=await this._findChild(e);if(t!=null)return t.value}async del(e){const t=await this._findPlace(e),r=t.bucket._at(t.pos);r!=null&&r.key===e&&t.bucket._delAt(t.pos)}leafCount(){return this._children.compactArray().reduce((t,r)=>r instanceof Bt?t+r.leafCount():t+1,0)}childrenCount(){return this._children.length}onlyChild(){return this._children.get(0)}*eachLeafSeries(){const e=this._children.compactArray();for(const t of e)t instanceof Bt?yield*t.eachLeafSeries():yield t}serialize(e,t){const r=[];return t(this._children.reduce((i,s,o)=>(s!=null&&(s instanceof Bt?i.push(s.serialize(e,t)):i.push(e(s,o))),i),r))}async asyncTransform(e,t){return g9(this,e,t)}toJSON(){return this.serialize(BD,MD)}prettyPrint(){return JSON.stringify(this.toJSON(),null,"  ")}tableSize(){return Math.pow(2,this._options.bits)}async _findChild(e){const t=await this._findPlace(e),r=t.bucket._at(t.pos);if(!(r instanceof Bt)&&r!=null&&r.key===e)return r}async _findPlace(e){const t=this._options.hash(typeof e=="string"?C(e):e),r=await t.take(this._options.bits),i=this._children.get(r);return i instanceof Bt?i._findPlace(t):{bucket:this,pos:r,hash:t,existingChild:i}}async _findNewBucketAndPos(e){const t=await this._findPlace(e);if(t.existingChild!=null&&t.existingChild.key!==e){const r=new Bt(this._options,t.bucket,t.pos);t.bucket._putObjectAt(t.pos,r);const i=await r._findPlace(t.existingChild.hash);return i.bucket._putAt(i,t.existingChild.key,t.existingChild.value),r._findNewBucketAndPos(t.hash)}return t}_putAt(e,t,r){this._putObjectAt(e.pos,{key:t,value:r,hash:e.hash})}_putObjectAt(e,t){this._children.get(e)==null&&this._popCount++,this._children.set(e,t)}_delAt(e){if(e===-1)throw new Error("Invalid position");this._children.get(e)!=null&&this._popCount--,this._children.unset(e),this._level()}_level(){if(this._parent!=null&&this._popCount<=1)if(this._popCount===1){const e=this._children.find(LD);if(e!=null&&!(e instanceof Bt)){const t=e.hash;t.untake(this._options.bits);const r={pos:this._posAtParent,hash:t,bucket:this._parent};this._parent._putAt(r,e.key,e.value)}}else this._parent._delAt(this._posAtParent)}_at(e){return this._children.get(e)}}function LD(n){return!!n}function BD(n,e){return n.key}function MD(n){return n}async function g9(n,e,t){const r=[];for(const i of n._children.compactArray())if(i instanceof Bt)await g9(i,e,t);else{const s=await e(i);r.push({bitField:n._children.bitField(),children:s})}return t(r)}const FD=[255,254,252,248,240,224,192,128],UD=[1,3,7,15,31,63,127,255];let $D=class{_value;_currentBytePos;_currentBitPos;constructor(e){this._value=e,this._currentBytePos=e.length-1,this._currentBitPos=7}availableBits(){return this._currentBitPos+1+this._currentBytePos*8}totalBits(){return this._value.length*8}take(e){let t=e,r=0;for(;t>0&&this._haveBits();){const i=this._value[this._currentBytePos],s=this._currentBitPos+1,o=Math.min(s,t),a=VD(i,s-o,o);r=(r<<o)+a,t-=o,this._currentBitPos-=o,this._currentBitPos<0&&(this._currentBitPos=7,this._currentBytePos--)}return r}untake(e){for(this._currentBitPos+=e;this._currentBitPos>7;)this._currentBitPos-=8,this._currentBytePos+=1}_haveBits(){return this._currentBytePos>=0}};function VD(n,e,t){const r=qD(e,t);return(n&r)>>>e}function qD(n,e){return FD[n]&UD[Math.min(e+n-1,7)]}function HD(n){function e(t){return t instanceof K4?t:new K4(t,n)}return e}let K4=class{_value;_hashFn;_depth;_availableBits;_currentBufferIndex;_buffers;constructor(e,t){if(!(e instanceof Uint8Array))throw new Error("can only hash Uint8Arrays");this._value=e,this._hashFn=t,this._depth=-1,this._availableBits=0,this._currentBufferIndex=0,this._buffers=[]}async take(e){let t=e;for(;this._availableBits<t;)await this._produceMoreBits();let r=0;for(;t>0;){const i=this._buffers[this._currentBufferIndex],s=Math.min(i.availableBits(),t),o=i.take(s);r=(r<<s)+o,t-=s,this._availableBits-=s,i.availableBits()===0&&this._currentBufferIndex++}return r}untake(e){let t=e;for(;t>0;){const r=this._buffers[this._currentBufferIndex],i=Math.min(r.totalBits()-r.availableBits(),t);r.untake(i),t-=i,this._availableBits+=i,this._currentBufferIndex>0&&r.totalBits()===r.availableBits()&&(this._depth--,this._currentBufferIndex--)}}async _produceMoreBits(){this._depth++;const e=this._depth>0?tr([this._value,Uint8Array.from([this._depth])]):this._value,t=await this._hashFn(e),r=new $D(t);this._buffers.push(r),this._availableBits+=r.availableBits()}};function b2(n){if(n==null||n.hashFn==null)throw new Error("please define an options.hashFn");const e={bits:n.bits??8,hash:HD(n.hashFn)};return new Bt(e)}const zD=async function(n){return(await ju.encode(n)).slice(0,8).reverse()},KD=async(n,e,t)=>{const r=(e.tableSize()-1).toString(16).length;await Promise.all(n.map(async i=>{if(i.Name==null)throw new Error("Unexpected Link without a Name");if(i.Name.length===r){const s=parseInt(i.Name,16);e._putObjectAt(s,new Bt({hash:t._options.hash,bits:t._options.bits},e,s));return}await t.put(i.Name.substring(2),!0)}))},W4=(n,e)=>n.toString(16).toUpperCase().padStart(e,"0").substring(0,e),WD=n=>{let e=n.bucket;const t=[];for(;e._parent!=null;)t.push(e),e=e._parent;return t.push(e),t.reverse()},m9=async(n,e,t,r,i)=>{if(r==null){if(n.Data==null)throw new Tt("no data in PBNode");let d;try{d=xe.unmarshal(n.Data)}catch(f){throw new Tt(f.message)}if(d.type!=="hamt-sharded-directory")throw new Tt("not a HAMT");if(d.fanout==null)throw new Tt("missing fanout");const h=b2({hashFn:zD,bits:Math.log2(Number(d.fanout))});r={rootBucket:h,hamtDepth:1,lastBucket:h}}const s=(r.lastBucket.tableSize()-1).toString(16).length;await KD(n.Links,r.lastBucket,r.rootBucket);const o=await r.rootBucket._findNewBucketAndPos(e);let a=W4(o.pos,s);const c=WD(o);c.length>r.hamtDepth&&(r.lastBucket=c[r.hamtDepth],a=W4(r.lastBucket._posAtParent,s));const l=n.Links.find(d=>{if(d.Name==null)return!1;const h=d.Name.substring(0,s),f=d.Name.substring(s);return!(h!==a||f!==""&&f!==e)});if(l==null)return;if(l.Name!=null&&l.Name.substring(s)===e)return l.Hash;r.hamtDepth++;const u=await t.get(l.Hash,i);return n=hn(u),m9(n,e,t,r,i)};function E2(n){return n?.extended===!1}const GD=(n,e,t,r,i,s,o)=>{async function*a(c={}){const l=c.offset??0,u=c.length??e.Links.length,d=e.Links.slice(l,u);c.onProgress?.(new P("unixfs:exporter:walk:directory",{cid:n})),yield*rr(d,h=>un(h,f=>async()=>{const m=f.Name??"",y=`${r}/${m}`;return E2(c)?{cid:f.Hash,name:m,path:y}:(await i(f.Hash,m,y,[],s+1,o,c)).entry}),h=>is(h,{ordered:!0,concurrency:c.blockReadConcurrency}),h=>zn(h,f=>f!=null))}return a};async function y9(n,e,t,r,i,s,o){if(e instanceof Uint8Array){const l=Vu(e,r,i,s);t.push(l);return}if(e.Data==null)throw new Tt("no data in PBNode");let a;try{a=xe.unmarshal(e.Data)}catch(l){throw new Tt(l.message)}if(a.data!=null){const l=a.data,u=Vu(l,r,i,s);t.push(u),r+=BigInt(u.byteLength)}const c=[];if(e.Links.length!==a.blockSizes.length)throw new Tt("Inconsistent block sizes and dag links");for(let l=0;l<e.Links.length;l++){const u=e.Links[l],d=r,h=d+a.blockSizes[l];if((i>=d&&i<h||s>=d&&s<=h||i<d&&s>h)&&c.push({link:u,blockStart:r}),r=h,r>s)break}await rr(c,l=>un(l,u=>async()=>{const d=await n.get(u.link.Hash,o);return{...u,block:d}}),l=>is(l,{ordered:!0,concurrency:o.blockReadConcurrency}),async l=>{for await(const{link:u,block:d,blockStart:h}of l){let f;switch(u.Hash.code){case qt:f=hn(d);break;case er:f=d;break;default:t.end(new Tt(`Unsupported codec: ${u.Hash.code}`));return}const m=new ed({concurrency:1});m.on("error",y=>{t.end(y)}),m.add(async()=>{o.onProgress?.(new P("unixfs:exporter:walk:file",{cid:u.Hash})),await y9(n,f,t,h,i,s,o)}),await m.onIdle()}}),r>=s&&t.end()}const G4=(n,e,t,r,i,s,o)=>{async function*a(c={}){const l=t.fileSize();if(l===void 0)throw new Error("File was a directory");const{start:u,end:d}=v2(l,c.offset,c.length);if(d===0n)return;let h=0n;const f=d-u,m=fn();c.onProgress?.(new P("unixfs:exporter:walk:file",{cid:n})),y9(o,e,m,0n,u,d,c).catch(y=>{m.end(y)});for await(const y of m)if(y!=null){if(h+=BigInt(y.byteLength),h>f)throw m.end(),new Fu("Read too many bytes - the file size reported by the UnixFS data in the root node may be incorrect");h===f&&m.end(),c.onProgress?.(new P("unixfs:exporter:progress:unixfs:file",{bytesRead:h,totalBytes:f,fileSize:l})),yield y}if(h<f)throw new Uu("Traversed entire DAG but did not read enough bytes")}return a},jD=(n,e,t,r,i,s,o)=>{function a(c={}){return c.onProgress?.(new P("unixfs:exporter:walk:hamt-sharded-directory",{cid:n})),w9(e,r,i,s,o,c)}return a};async function*w9(n,e,t,r,i,s){const o=n.Links;if(n.Data==null)throw new Tt("no data in PBNode");let a;try{a=xe.unmarshal(n.Data)}catch(u){throw new Tt(u.message)}if(a.fanout==null)throw new Tt("missing fanout");const c=(a.fanout-1n).toString(16).length,l=rr(o,u=>un(u,d=>async()=>{const h=d.Name!=null?d.Name.substring(c):null;if(h!=null&&h!==""){const f=`${e}/${h}`;return E2(s)?{entries:[{cid:d.Hash,name:h,path:f}]}:{entries:[(await t(d.Hash,h,f,[],r+1,i,s)).entry].filter(Boolean)}}else{const f=await i.get(d.Hash,s);return n=hn(f),s.onProgress?.(new P("unixfs:exporter:walk:hamt-sharded-directory",{cid:d.Hash})),{entries:w9(n,e,t,r,i,s)}}}),u=>is(u,{ordered:!0,concurrency:s.blockReadConcurrency}));for await(const{entries:u}of l)yield*u}const QD=(n,e)=>n.Links.find(r=>r.Name===e)?.Hash,YD={raw:G4,file:G4,directory:GD,"hamt-sharded-directory":jD,metadata:(n,e,t,r,i,s,o)=>()=>[],symlink:(n,e,t,r,i,s,o)=>()=>[]},XD=async(n,e,t,r,i,s,o,a)=>{if(E2(a)&&r.length===0)return{entry:{cid:n,name:e,path:t}};const c=await o.get(n,a),l=hn(c);let u,d;if(e==null&&(e=n.toString()),l.Data==null)throw new Tt("no data in PBNode");try{u=xe.unmarshal(l.Data)}catch(f){throw new Tt(f.message)}if(t==null&&(t=e),r.length>0){let f;if(u?.type==="hamt-sharded-directory"?f=await m9(l,r[0],o):f=QD(l,r[0]),f==null)throw new Rn("file does not exist");const m=r.shift(),y=`${t}/${m}`;d={cid:f,toResolve:r,name:m??"",path:y}}const h=YD[u.type](n,l,u,t,i,s,o);if(h==null)throw new Rn("could not find content exporter");return u.isDirectory()?{entry:{type:"directory",name:e,path:t,cid:n,content:h,unixfs:u,depth:s,node:l,size:u.fileSize()},next:d}:{entry:{type:"file",name:e,path:t,cid:n,content:h,unixfs:u,depth:s,node:l,size:u.fileSize()},next:d}},ZD={[qt]:XD,[er]:OD,[ii]:_D,[Is]:ID,[_a.code]:TD,[ka]:RD},v9=async(n,e,t,r,i,s,o)=>{const a=ZD[n.code];if(a==null)throw new Mu(`No resolver for code ${n.code}`);return a(n,e,t,r,v9,i,s,o)},JD=(n="")=>(n.trim().match(/([^\\^/]|\\\/)+/g)??[]).filter(Boolean),eL=n=>{if(n instanceof Uint8Array)return{cid:he.decode(n),toResolve:[]};const e=he.asCID(n);if(e!=null)return{cid:e,toResolve:[]};if(typeof n=="string"){n.indexOf("/ipfs/")===0&&(n=n.substring(6));const t=JD(n);return{cid:he.parse(t[0]),toResolve:t.slice(1)}}throw new Bu(`Unknown path type ${n}`)};async function*S2(n,e,t={}){let{cid:r,toResolve:i}=eL(n),s=r.toString(),o=s;const a=i.length;for(;;){const c=await v9(r,s,o,i,a,e,t);if(c.entry==null&&c.next==null)throw new Rn(`Could not resolve ${n}`);if(c.entry!=null&&(yield c.entry),c.next==null)return;i=c.next.toResolve,r=c.next.cid,s=c.next.name,o=c.next.path}}async function Kr(n,e,t={}){const r=await oo(S2(n,e,t));if(r==null)throw new Rn(`Could not resolve ${n}`);return r}async function*x2(n,e,t={}){const r=await Kr(n,e,t);if(r==null)return;if(yield r,r.type==="directory")for await(const s of i(r,t))yield s;async function*i(s,o){for await(const a of s.content(o))yield a,!(a instanceof Uint8Array)&&a.type==="directory"&&(yield*i(a,o))}}async function tL(n,e,t){const r=[];let i;for await(const s of S2(e,n,t))r.push(s.cid),i=s;if(i==null)throw new f9("No terminal element found");return{ipfsRoots:r,terminalElement:i}}function j4(n){return n.type==="object"}async function rL({cid:n,path:e,resource:t,options:r,blockstore:i,log:s}){try{return await tL(i,`${n.toString()}/${e}`,r)}catch(o){if(r?.signal?.aborted)throw new pt(r?.signal?.reason);return["ERR_NO_PROP","ERR_NO_TERMINAL_ELEMENT","ERR_NOT_FOUND"].includes(o.code)?l9(t):(s.error("error walking path %s",e,o),g2(t,"Error walking path"))}}class nL extends Fn{id="dag-cbor-plugin";codes=[ii];canHandle({cid:e,accept:t,pathDetails:r,byteRangeContext:i,plugins:s}){return this.log("checking if we can handle %c with accept %s",e,t),r==null||!j4(r.terminalElement)||e.code!==ii||i==null||t!=null&&t.includes("text/html")&&s.includes("dag-cbor-plugin-html-preview")?!1:j4(r.terminalElement)}async handle(e){const{cid:t,path:r,resource:i,accept:s,pathDetails:{terminalElement:o,ipfsRoots:a}}=e;this.log.trace("fetching %c/%s",t,r);const c=o.node;let l;if(s==="application/octet-stream"||s==="application/vnd.ipld.dag-cbor"||s==="application/cbor")l=c;else if(s==="application/vnd.ipld.dag-json")try{const h=$0(c);l=Yw(h)}catch(h){return this.log.error("could not transform %c to application/vnd.ipld.dag-json",h),ec(i)}else try{l=AD(c)}catch(h){if(s==="application/json")return this.log('could not decode DAG-CBOR as JSON-safe, but the client sent "Accept: application/json"',h),ec(i);this.log("could not decode DAG-CBOR as JSON-safe, falling back to `application/octet-stream`",h),l=c}e.byteRangeContext.setBody(l);const u=s??(l instanceof Uint8Array?"application/octet-stream":"application/json"),d=cs(i,e.byteRangeContext.getBody(u),{byteRangeContext:e.byteRangeContext,log:this.log});return d.headers.set("content-type",e.byteRangeContext.getContentType()??u),this.log.trace('setting content type to "%s"',e.byteRangeContext.getContentType()??u),o9(d,a),d}}function iL(n){return n[Symbol.asyncIterator]!=null}function b9(n,e=1){return e=Number(e),iL(n)?(async function*(){let t=[];if(e<1&&(e=1),e!==Math.round(e))throw new Error("Batch size must be an integer");for await(const r of n)for(t.push(r);t.length>=e;)yield t.slice(0,e),t=t.slice(e);for(;t.length>0;)yield t.slice(0,e),t=t.slice(e)})():(function*(){let t=[];if(e<1&&(e=1),e!==Math.round(e))throw new Error("Batch size must be an integer");for(const r of n)for(t.push(r);t.length>=e;)yield t.slice(0,e),t=t.slice(e);for(;t.length>0;)yield t.slice(0,e),t=t.slice(e)})()}async function*E9(n,e=1){for await(const t of b9(n,e)){const r=t.map(async i=>i().then(s=>({ok:!0,value:s}),s=>({ok:!1,err:s})));for(let i=0;i<r.length;i++){const s=await r[i];if(s.ok)yield s.value;else throw s.err}}}const sL=262144,S9=(n={})=>{const e=n.chunkSize??sL;return async function*(r){let i=new $e,s=0,o=!1;for await(const a of r)for(i.append(a),s+=a.length;s>=e;)if(yield i.slice(0,e),o=!0,e===i.length)i=new $e,s=0;else{const c=new $e;c.append(i.sublist(e)),i=c,s-=e}(!o||s>0)&&(yield i.subarray(0,s))}},io=async(n,e,t)=>{t.codec==null&&(t.codec=ic);const r=await gt.digest(n),i=he.create(t.cidVersion,t.codec.code,r);return await e.put(i,n,t),i};function oL(n){return async function*(t,r){let i=0n;for await(let s of t.content)yield async()=>{let o;const a={codec:ic,cidVersion:n.cidVersion,onProgress:n.onProgress};n.rawLeaves?(a.codec=d5,a.cidVersion=1):(o=new xe({type:n.leafType,data:s}),s=it({Data:o.marshal(),Links:[]}));const c=await io(s,r,a);return i+=BigInt(s.byteLength),n.onProgress?.(new P("unixfs:importer:progress:file:write",{bytesWritten:i,cid:c,path:t.path})),{cid:c,unixfs:o,size:BigInt(s.length),block:s}}}}class Hu extends Error{static name="InvalidParametersError";static code="ERR_INVALID_PARAMS";name=Hu.name;code=Hu.code;constructor(e="Invalid parameters"){super(e)}}class ts extends Error{static name="InvalidContentError";static code="ERR_INVALID_CONTENT";name=ts.name;code=ts.code;constructor(e="Invalid content"){super(e)}}const aL=async(n,e,t)=>{const r=new xe({type:"directory",mtime:n.mtime,mode:n.mode}),i=it(qr({Data:r.marshal()})),s=await io(i,e,t),o=n.path;return{cid:s,path:o,unixfs:r,size:BigInt(i.length),originalPath:n.originalPath,block:i}};async function*cL(n,e,t){let r=-1,i;for await(const s of E9(t.bufferImporter(n,e),t.blockWriteConcurrency)){if(r++,r===0){i={...s,single:!0};continue}else r===1&&i!=null&&(yield{...i,block:void 0,single:void 0},i=void 0);yield{...s,block:void 0}}i!=null&&(yield i)}function Q4(n){return n.single===!0}const lL=(n,e,t)=>async function(i){if(i.length===1&&Q4(i[0])&&t.reduceSingleLeafToSelf){const u=i[0];let d=u.block;return Q4(u)&&(n.mtime!==void 0||n.mode!==void 0)&&(u.unixfs=new xe({type:"file",mtime:n.mtime,mode:n.mode,data:u.block}),d={Data:u.unixfs.marshal(),Links:[]},u.block=it(qr(d)),u.cid=await io(u.block,e,{...t,cidVersion:t.cidVersion}),u.size=BigInt(u.block.length)),t.onProgress?.(new P("unixfs:importer:progress:file:layout",{cid:u.cid,path:u.originalPath})),{cid:u.cid,path:n.path,unixfs:u.unixfs,size:u.size,originalPath:u.originalPath}}const s=new xe({type:"file",mtime:n.mtime,mode:n.mode}),o=i.filter(u=>u.cid.code===er&&u.size>0||u.unixfs!=null&&u.unixfs.data==null&&u.unixfs.fileSize()>0n?!0:!!u.unixfs?.data?.length).map(u=>u.cid.code===er?(s.addBlockSize(u.size),{Name:"",Tsize:Number(u.size),Hash:u.cid}):(u.unixfs?.data==null?s.addBlockSize(u.unixfs?.fileSize()??0n):s.addBlockSize(BigInt(u.unixfs.data.length)),{Name:"",Tsize:Number(u.size),Hash:u.cid})),a={Data:s.marshal(),Links:o},c=it(qr(a)),l=await io(c,e,t);return t.onProgress?.(new P("unixfs:importer:progress:file:layout",{cid:l,path:n.originalPath})),{cid:l,path:n.path,unixfs:s,size:BigInt(c.length+a.Links.reduce((u,d)=>u+(d.Tsize??0),0)),originalPath:n.originalPath,block:c}},uL=async(n,e,t)=>t.layout(cL(n,e,t),lL(n,e,t));function dL(n){return Symbol.iterator in n}function hL(n){return Symbol.asyncIterator in n}function fL(n){try{if(n instanceof Uint8Array)return(async function*(){yield n})();if(dL(n))return(async function*(){yield*n})();if(hL(n))return n}catch{throw new ts("Content was invalid")}throw new ts("Content was invalid")}function pL(n){return async function*(t,r){for await(const i of t){let s;if(i.path!=null&&(s=i.path,i.path=i.path.split("/").filter(o=>o!=null&&o!==".").join("/")),gL(i)){const o={path:i.path,mtime:i.mtime,mode:i.mode,content:(async function*(){let c=0n;for await(const l of n.chunker(n.chunkValidator(fL(i.content)))){const u=BigInt(l.byteLength);c+=u,n.onProgress?.(new P("unixfs:importer:progress:file:read",{bytesRead:c,chunkSize:u,path:i.path})),yield l}})(),originalPath:s},a=n.fileBuilder??uL;yield async()=>a(o,r,n)}else if(i.path!=null){const o={path:i.path,mtime:i.mtime,mode:i.mode,originalPath:s},a=n.dirBuilder??aL;yield async()=>a(o,r,n)}else throw new Error("Import candidate must have content or path or both")}}}function gL(n){return n.content!=null}const mL=()=>async function*(e){for await(const t of e){if(t.length===void 0)throw new ts("Content was invalid");if(typeof t=="string"||t instanceof String)yield C(t.toString());else if(Array.isArray(t))yield Uint8Array.from(t);else if(t instanceof Uint8Array)yield t;else throw new ts("Content was invalid")}},yL=174;function x9(n){const e=n?.maxChildrenPerNode??yL;return async function t(r,i){const s=[];for await(const o of b9(r,e))s.push(await i(o));return s.length>1?t(s,i):s[0]}}let rc=class{options;root;dir;path;dirty;flat;parent;parentKey;unixfs;mode;mtime;cid;size;nodeSize;constructor(e,t){this.options=t??{},this.root=e.root,this.dir=e.dir,this.path=e.path,this.dirty=e.dirty,this.flat=e.flat,this.parent=e.parent,this.parentKey=e.parentKey,this.unixfs=e.unixfs,this.mode=e.mode,this.mtime=e.mtime}};const _0=he.parse("QmUNLLsPACCz1vLxQVkXqqLX5R1X345qqfHbsf67hvA3Nn"),I0=he.parse("zdj7WbTaiJT1fgatdet9Ei9iDB5hdCxkbVyhyh8YTUnXMiwYi");class A2 extends rc{_children;constructor(e,t){super(e,t),this._children=new Map}async put(e,t){this.cid=void 0,this.size=void 0,this.nodeSize=void 0,this._children.set(e,t)}async get(e){return Promise.resolve(this._children.get(e))}childCount(){return this._children.size}directChildrenCount(){return this.childCount()}onlyChild(){return this._children.values().next().value}*eachChildSeries(){for(const[e,t]of this._children.entries())yield{key:e,child:t}}estimateNodeSize(){if(this.nodeSize!==void 0)return this.nodeSize;this.nodeSize=0;for(const[e,t]of this._children.entries())t.size!=null&&t.cid!=null&&(this.nodeSize+=e.length+(this.options.cidVersion===1?I0.bytes.byteLength:_0.bytes.byteLength));return this.nodeSize}async*flush(e){const t=[];for(const[c,l]of this._children.entries()){let u=l;if(l instanceof rc)for await(const d of l.flush(e))u=d,yield d;u.size!=null&&u.cid!=null&&t.push({Name:c,Tsize:Number(u.size),Hash:u.cid})}const r=new xe({type:"directory",mtime:this.mtime,mode:this.mode}),i={Data:r.marshal(),Links:t},s=it(qr(i)),o=await io(s,e,this.options),a=s.length+i.Links.reduce((c,l)=>c+(l.Tsize??0),0);this.cid=o,this.size=a,yield{cid:o,unixfs:r,path:this.path,size:BigInt(a)}}}async function wL(n){return(await ju.encode(n)).slice(0,8).reverse()}const A9=BigInt(34),vL=8;let bL=class extends rc{_bucket;constructor(e,t){super(e,t),this._bucket=b2({hashFn:wL,bits:t.shardFanoutBits??vL})}async put(e,t){this.cid=void 0,this.size=void 0,this.nodeSize=void 0,await this._bucket.put(e,t)}async get(e){return this._bucket.get(e)}childCount(){return this._bucket.leafCount()}directChildrenCount(){return this._bucket.childrenCount()}onlyChild(){return this._bucket.onlyChild()}*eachChildSeries(){for(const{key:e,value:t}of this._bucket.eachLeafSeries())yield{key:e,child:t}}estimateNodeSize(){return this.nodeSize!==void 0?this.nodeSize:(this.nodeSize=_9(this._bucket,this,this.options),this.nodeSize)}async*flush(e){for await(const t of k9(this._bucket,e,this,this.options))yield{...t,path:this.path}}};async function*k9(n,e,t,r){const i=n._children,s=(n.tableSize()-1).toString(16).length,o=[];let a=0n;for(let m=0;m<i.length;m++){const y=i.get(m);if(y==null)continue;const w=m.toString(16).toUpperCase().padStart(s,"0");if(y instanceof Bt){let E;for await(const A of k9(y,e,null,r))E=A;if(E==null)throw new Error("Could not flush sharded directory, no subshard found");o.push({Name:w,Tsize:Number(E.size),Hash:E.cid}),a+=E.size}else if(EL(y.value)){const E=y.value;let A;for await(const R of E.flush(e))A=R,yield A;if(A==null)throw new Error("Did not flush dir");const T=w+y.key;o.push({Name:T,Tsize:Number(A.size),Hash:A.cid}),a+=A.size}else{const E=y.value;if(E.cid==null)continue;const A=w+y.key,T=E.size;o.push({Name:A,Tsize:Number(T),Hash:E.cid}),a+=BigInt(T??0)}}const c=Uint8Array.from(i.bitField().reverse()),l=new xe({type:"hamt-sharded-directory",data:c,fanout:BigInt(n.tableSize()),hashType:A9,mtime:t?.mtime,mode:t?.mode}),u={Data:l.marshal(),Links:o},d=it(qr(u)),h=await io(d,e,r),f=BigInt(d.byteLength)+a;yield{cid:h,unixfs:l,size:f}}function EL(n){return typeof n.flush=="function"}function _9(n,e,t){const r=n._children,i=(n.tableSize()-1).toString(16).length,s=[];for(let l=0;l<r.length;l++){const u=r.get(l);if(u==null)continue;const d=l.toString(16).toUpperCase().padStart(i,"0");if(u instanceof Bt){const h=_9(u,null,t);s.push({Name:d,Tsize:Number(h),Hash:t.cidVersion===0?_0:I0})}else if(typeof u.value.flush=="function"){const f=u.value.nodeSize();s.push({Name:d+u.key,Tsize:Number(f),Hash:t.cidVersion===0?_0:I0})}else{const h=u.value;if(h.cid==null)continue;const f=d+u.key,m=h.size;s.push({Name:f,Tsize:Number(m),Hash:h.cid})}}const o=Uint8Array.from(r.bitField().reverse()),a=new xe({type:"hamt-sharded-directory",data:o,fanout:BigInt(n.tableSize()),hashType:A9,mtime:e?.mtime,mode:e?.mode});return it(qr({Data:a.marshal(),Links:s})).length}async function I9(n,e,t,r){let i=e;e instanceof A2&&e.estimateNodeSize()>t&&(i=await SL(e,r));const s=i.parent;if(s!=null){if(i!==e){if(n!=null&&(n.parent=i),i.parentKey==null)throw new Error("No parent key found");await s.put(i.parentKey,i)}return I9(i,s,t,r)}return i}async function SL(n,e){const t=new bL({root:n.root,dir:!0,parent:n.parent,parentKey:n.parentKey,path:n.path,dirty:n.dirty,flat:!1,mtime:n.mtime,mode:n.mode},e);for(const{key:r,child:i}of n.eachChildSeries())await t.put(r,i);return t}const xL=(n="")=>n.split(new RegExp("(?<!\\\\)\\/")).filter(Boolean);async function AL(n,e,t){const r=xL(n.path??""),i=r.length-1;let s=e,o="";for(let a=0;a<r.length;a++){const c=r[a];o+=`${o!==""?"/":""}${c}`;const l=a===i;if(s.dirty=!0,s.cid=void 0,s.size=void 0,l)await s.put(c,n),e=await I9(null,s,t.shardSplitThresholdBytes,t);else{let u=await s.get(c);(u==null||!(u instanceof rc))&&(u=new A2({root:!1,dir:!0,parent:s,parentKey:c,path:o,dirty:!0,flat:!0,mtime:u?.unixfs?.mtime,mode:u?.unixfs?.mode},t)),await s.put(c,u),s=u}}return e}async function*Y4(n,e){if(!(n instanceof rc)){n.unixfs?.isDirectory()===!0&&(yield n);return}yield*n.flush(e)}function kL(n){return async function*(t,r){let i=new A2({root:!0,dir:!0,path:"",dirty:!0,flat:!0},n),s,o=!1;for await(const a of t){if(a==null)continue;const c=`${a.originalPath??""}`.split("/")[0];c!=null&&c!==""&&(s==null?(s=c,o=!0):s!==c&&(o=!1)),i=await AL(a,i,n),a.unixfs?.isDirectory()!==!0&&(yield a)}if(n.wrapWithDirectory||o&&i.childCount()>1)yield*Y4(i,r);else for(const a of i.eachChildSeries())a!=null&&(yield*Y4(a.child,r))}}async function*sh(n,e,t={}){let r;Symbol.asyncIterator in n||Symbol.iterator in n?r=n:r=[n];const i=t.wrapWithDirectory??!1,s=t.shardSplitThresholdBytes??262144,o=t.shardFanoutBits??8,a=t.cidVersion??1,c=t.rawLeaves??!0,l=t.leafType??"file",u=t.fileImportConcurrency??50,d=t.blockWriteConcurrency??10,h=t.reduceSingleLeafToSelf??!0,f=t.chunker??S9(),m=t.chunkValidator??mL(),y=t.dagBuilder??pL({chunker:f,chunkValidator:m,wrapWithDirectory:i,layout:t.layout??x9(),bufferImporter:t.bufferImporter??oL({cidVersion:a,rawLeaves:c,leafType:l,onProgress:t.onProgress}),blockWriteConcurrency:d,reduceSingleLeafToSelf:h,cidVersion:a,onProgress:t.onProgress,dirBuilder:t.dirBuilder,fileBuilder:t.fileBuilder}),w=t.treeBuilder??kL({wrapWithDirectory:i,shardSplitThresholdBytes:s,shardFanoutBits:o,cidVersion:a,onProgress:t.onProgress});for await(const E of w(E9(y(r,e),u),e))yield{cid:E.cid,path:E.path,unixfs:E.unixfs,size:E.size}}async function C9(n,e,t={}){const r=await z0(sh([n],e,t));if(r==null)throw new Hu("Nothing imported");return r}async function _L(n,e,t={}){return C9({content:n},e,t)}async function IL(n,e,t={}){return C9({content:n},e,t)}const Cc={cidVersion:1,rawLeaves:!0,layout:x9({maxChildrenPerNode:1024}),chunker:S9({chunkSize:1048576})};async function*k2(n,e,t={}){yield*sh(n,e,{...Cc,...t})}async function CL(n,e,t={}){const{cid:r}=await _L(n,e,{...Cc,...t});return r}async function TL(n,e,t={}){const{cid:r}=await IL(n,e,{...Cc,...t});return r}async function RL(n,e,t={}){if(n.path==null)throw new $r("path is required");if(n.content==null)throw new $r("content is required");const r=await oo(k2([n],e,{...Cc,...t,wrapWithDirectory:!0}));if(r==null)throw new $r("Nothing imported");return r.cid}async function PL(n,e,t={}){if(n.content!=null)throw new $r("Directories cannot have content, use addFile instead");const i=await(n.path==null?z0:oo)(k2([{...n,path:n.path??"-"}],e,{...Cc,...t,wrapWithDirectory:n.path!=null}));if(i==null)throw new $r("Nothing imported");return i.cid}function T9(n){function e(t){return t instanceof X4?t:new X4(t,n)}return e}class X4{_value;_hashFn;_depth;_availableBits;_currentBufferIndex;_buffers;constructor(e,t){if(!(e instanceof Uint8Array))throw new Error("can only hash Uint8Arrays");this._value=e,this._hashFn=t,this._depth=-1,this._availableBits=0,this._currentBufferIndex=0,this._buffers=[]}async take(e){let t=e;for(;this._availableBits<t;)await this._produceMoreBits();let r=0;for(;t>0;){const i=this._buffers[this._currentBufferIndex],s=Math.min(i.availableBits(),t),o=i.take(s);r=(r<<s)+o,t-=s,this._availableBits-=s,i.availableBits()===0&&this._currentBufferIndex++}return r}untake(e){let t=e;for(;t>0;){const r=this._buffers[this._currentBufferIndex],i=Math.min(r.totalBits()-r.availableBits(),t);r.untake(i),t-=i,this._availableBits+=i,this._currentBufferIndex>0&&r.totalBits()===r.availableBits()&&(this._depth--,this._currentBufferIndex--)}}async _produceMoreBits(){this._depth++;const e=this._depth>0?tr([this._value,Uint8Array.from([this._depth])]):this._value,t=await this._hashFn(e),r=new DL(t);this._buffers.push(r),this._availableBits+=r.availableBits()}}const OL=[255,254,252,248,240,224,192,128],NL=[1,3,7,15,31,63,127,255];class DL{_value;_currentBytePos;_currentBitPos;constructor(e){this._value=e,this._currentBytePos=e.length-1,this._currentBitPos=7}availableBits(){return this._currentBitPos+1+this._currentBytePos*8}totalBits(){return this._value.length*8}take(e){let t=e,r=0;for(;t>0&&this._haveBits();){const i=this._value[this._currentBytePos],s=this._currentBitPos+1,o=Math.min(s,t),a=LL(i,s-o,o);r=(r<<o)+a,t-=o,this._currentBitPos-=o,this._currentBitPos<0&&(this._currentBitPos=7,this._currentBytePos--)}return r}untake(e){for(this._currentBitPos+=e;this._currentBitPos>7;)this._currentBitPos-=8,this._currentBytePos+=1}_haveBits(){return this._currentBytePos>=0}}function LL(n,e,t){const r=BL(e,t);return(n&r)>>>e}function BL(n,e){return OL[n]&NL[Math.min(e+n-1,7)]}const _2=BigInt(ju.code),Ea=8;async function I2(n){return(await ju.encode(n)).subarray(0,8).reverse()}const So=async(n,e,t)=>{t.codec==null&&(t.codec=ic);const r=await gt.digest(n),i=he.create(t.cidVersion,t.codec.code,r);return await e.put(i,n,{...t,signal:t.signal}),i};class ML{options;root;dir;path;dirty;flat;parent;parentKey;unixfs;mode;mtime;cid;size;nodeSize;constructor(e,t){this.options=t??{},this.root=e.root,this.dir=e.dir,this.path=e.path,this.dirty=e.dirty,this.flat=e.flat,this.parent=e.parent,this.parentKey=e.parentKey,this.unixfs=e.unixfs,this.mode=e.mode,this.mtime=e.mtime}}class FL extends ML{_bucket;constructor(e,t){super(e,t),this._bucket=b2({hashFn:I2,bits:8})}async put(e,t){this.cid=void 0,this.size=void 0,this.nodeSize=void 0,await this._bucket.put(e,t)}async get(e){return this._bucket.get(e)}childCount(){return this._bucket.leafCount()}directChildrenCount(){return this._bucket.childrenCount()}onlyChild(){return this._bucket.onlyChild()}async*eachChildSeries(){for(const{key:e,value:t}of this._bucket.eachLeafSeries())yield{key:e,child:t}}estimateNodeSize(){return this.nodeSize!==void 0?this.nodeSize:(this.nodeSize=P9(this._bucket,this,this.options),this.nodeSize)}async*flush(e){for await(const t of R9(this._bucket,e,this,this.options))yield{...t,path:this.path}}}async function*R9(n,e,t,r){const i=n._children,s=[];let o=0n;for(let f=0;f<i.length;f++){const m=i.get(f);if(m==null)continue;const y=f.toString(16).toUpperCase().padStart(2,"0");if(m instanceof Bt){let w;for await(const E of R9(m,e,null,r))w=E;if(w==null)throw new Error("Could not flush sharded directory, no sub-shard found");s.push({Name:y,Tsize:Number(w.size),Hash:w.cid}),o+=w.size}else if(UL(m.value)){const w=m.value;let E;for await(const T of w.flush(e))E=T,yield E;if(E==null)throw new Error("Did not flush dir");const A=y+m.key;s.push({Name:A,Tsize:Number(E.size),Hash:E.cid}),o+=E.size}else{const w=m.value;if(w.cid==null)continue;const E=y+m.key,A=w.size;s.push({Name:E,Tsize:Number(A),Hash:w.cid}),o+=BigInt(A??0)}}const a=Uint8Array.from(i.bitField().reverse()),c=new xe({type:"hamt-sharded-directory",data:a,fanout:BigInt(n.tableSize()),hashType:_2,mtime:t?.mtime,mode:t?.mode}),l={Data:c.marshal(),Links:s},u=it(qr(l)),d=await So(u,e,r),h=BigInt(u.byteLength)+o;yield{cid:d,unixfs:c,size:h}}function UL(n){return typeof n.flush=="function"}function P9(n,e,t){const r=n._children,i=[];for(let c=0;c<r.length;c++){const l=r.get(c);if(l==null)continue;const u=c.toString(16).toUpperCase().padStart(2,"0");if(l instanceof Bt){const d=P9(l,null,t);i.push({Name:u,Tsize:Number(d),Hash:t.cidVersion===0?C0:T0})}else if(typeof l.value.flush=="function"){const h=l.value.nodeSize();i.push({Name:u+l.key,Tsize:Number(h),Hash:t.cidVersion===0?C0:T0})}else{const d=l.value;if(d.cid==null)continue;const h=u+l.key,f=d.size;i.push({Name:h,Tsize:Number(f),Hash:d.cid})}}const s=Uint8Array.from(r.bitField().reverse()),o=new xe({type:"hamt-sharded-directory",data:s,fanout:BigInt(n.tableSize()),hashType:_2,mtime:e?.mtime,mode:e?.mode});return it(qr({Data:o.marshal(),Links:i})).length}const C0=he.parse("QmUNLLsPACCz1vLxQVkXqqLX5R1X345qqfHbsf67hvA3Nn"),T0=he.parse("zdj7WbTaiJT1fgatdet9Ei9iDB5hdCxkbVyhyh8YTUnXMiwYi"),R0=mt("helia:unixfs:commands:utils:hamt-utils"),P0=n=>n.toString(16).toUpperCase().padStart(2,"0").substring(0,2),$L=async(n,e,t)=>{const r=new FL({root:!0,dir:!0,parent:void 0,parentKey:void 0,path:"",dirty:!0,flat:!1,mtime:t.mtime,mode:t.mode},t);for(let s=0;s<e.length;s++)await r._bucket.put(e[s].name,{size:e[s].size,cid:e[s].cid});const i=await oo(r.flush(n));if(i==null)throw new Error("Flushing shard yielded no result");return i},O9=async(n,e,t)=>{const r=xe.unmarshal(n[0].node.Data??new Uint8Array(0)),i=BigInt(Math.pow(2,Ea));n.reverse();let s,o;for(let a=0;a<n.length;a++){const c=a===n.length-1,l=n[a],u=Uint8Array.from(l.children.bitField().reverse()),d=new xe({type:"hamt-sharded-directory",data:u,fanout:i,hashType:_2});c&&(d.mtime=r.mtime,d.mode=r.mode),o={Data:d.marshal(),Links:l.node.Links};const h=it(qr(o));if(s=await So(h,e,t),!c){const f=n[a+1];if(f==null)throw new Error("Was not operating on shard root but also had no parent?");R0("updating link in parent sub-shard with prefix %s",f.prefix),f.node.Links=f.node.Links.filter(m=>m.Name!==f.prefix),f.node.Links.push({Name:f.prefix,Hash:s,Tsize:l.node.Links.reduce((m,y)=>m+(y.Tsize??0),h.byteLength)})}}if(s==null||o==null)throw new Error("Noting persisted");return{cid:s,node:o}},N9=async(n,e,t,r)=>{const s=T9(I2)(C(e)),o=[];for(;;){const a=await t.get(n,r),c=hn(a),l=new qu,u=await s.take(Ea),d=P0(u);o.push({prefix:d,children:l,node:c});let h;for(const m of c.Links){const y=m.Name??"";if(y.length<2)throw new Error("Invalid HAMT - link name was too short");const w=parseInt(y.substring(0,2),16);l.set(w,!0),y.startsWith(d)&&(h=m)}if(h==null){R0("no link found with prefix %s for %s",d,e);break}const f=h.Name??"";if(f.length<2)throw new Error("Invalid HAMT - link name was too short");if(f.length===2){n=h.Hash,R0("descend into sub-shard with prefix %s",f);continue}break}return{path:o,hash:s}};async function D9(n,e,t,r){if(n.Data==null)throw new Error("DagPB node had no data");const i=xe.unmarshal(n.Data);let s;if(i.type==="directory")s=VL(n);else if(i.type==="hamt-sharded-directory")s=await L9(n,0,t,e,r);else throw new Error("Can only estimate the size of directories or shards");return s>t}function VL(n){let e=0;for(const t of n.Links)e+=(t.Name??"").length,e+=t.Hash.version===1?T0.bytes.byteLength:C0.bytes.byteLength;return e}async function L9(n,e,t,r,i){if(e>t)return t;if(n.Data==null||!xe.unmarshal(n.Data).isDirectory())return e;for(const o of n.Links){let a=o.Name??"";if(a=a.substring(2),e+=a.length,e+=o.Hash.bytes.byteLength,o.Hash.code===qt){const c=await r.get(o.Hash,i),l=hn(c);e+=await L9(l,e,t,r,i)}}return e}const tn=mt("helia:unixfs:components:utils:add-link");async function C2(n,e,t,r){if(n.node.Data==null)throw new $r("Invalid parent passed to addLink");if(xe.unmarshal(n.node.Data).type==="hamt-sharded-directory")return tn("adding link to sharded directory"),zL(n,e,t,r);tn(`adding ${e.Name} (${e.Hash}) to regular directory`);const s=await HL(n,e,t,r);if(await D9(s.node,t,r.shardSplitThresholdBytes,r)){tn("converting directory to sharded directory");const o=await qL(s,t);s.cid=o.cid,s.node=hn(await t.get(o.cid,r))}return s}const qL=async(n,e)=>{if(n.node.Data==null)throw new $r("Invalid parent passed to convertToShardedDirectory");const t=xe.unmarshal(n.node.Data),r=await $L(e,n.node.Links.map(i=>({name:i.Name??"",size:BigInt(i.Tsize??0),cid:i.Hash})),{mode:t.mode,mtime:t.mtime,cidVersion:n.cid.version});return tn(`converted directory to sharded directory ${r.cid}`),r},HL=async(n,e,t,r)=>{const i=n.node.Links.filter(u=>{const d=u.Name===e.Name;if(d&&!r.allowOverwriting)throw new h9;return!d});if(i.push(e),n.node.Data==null)throw new es("Parent node with no data passed to addToDirectory");const s=xe.unmarshal(n.node.Data);let o;if(s.mtime!=null){const u=Date.now(),d=Math.floor(u/1e3);s.mtime={secs:BigInt(d),nsecs:(u-d*1e3)*1e3},o=s.marshal()}else o=n.node.Data;n.node=qr({Data:o,Links:i});const a=it(n.node),c=await gt.digest(a),l=he.create(n.cid.version,qt,c);return await t.put(l,a),{node:n.node,cid:l}},zL=async(n,e,t,r)=>{const{path:i,hash:s}=await N9(n.cid,e.Name,t,r),o=i[i.length-1];if(o==null)throw new Error("Invalid HAMT, could not generate path");const a=o.prefix,c=parseInt(a,16);tn("next prefix for %s is %s",e.Name,a);const l=`${a}${e.Name}`,u=o.node.Links.find(d=>(d.Name??"").startsWith(a));if(u!=null)if(tn("link %s was present in shard",l),u.Name===l){if(!r.allowOverwriting)throw new h9;tn("overwriting %s in sub-shard",e.Name),o.node.Links=o.node.Links.filter(d=>d.Name!==l),o.node.Links.push({Name:l,Hash:e.Hash,Tsize:e.Tsize})}else{if(u.Name?.length===2)throw new Error("Existing link was sub-shard?!");{tn("prefix %s already exists, creating new sub-shard",a);const d=o.node.Links.findIndex(w=>w.Name?.startsWith(a)),h=o.node.Links.splice(d,1)[0],f=(h.Name??"").substring(2),y=T9(I2)(C(f));for(let w=0;w<i.length;w++)await y.take(Ea);for(;;){const w=await y.take(Ea),E=P0(w);h.Name=`${E}${f}`;const A=await s.take(Ea),T=P0(A);if(E===T){const ie=new qu;ie.set(A,!0),i.push({prefix:T,children:ie,node:{Links:[]}});continue}const R=new qu;R.set(A,!0),R.set(w,!0),i.push({prefix:a,children:R,node:{Links:[h,{Name:`${T}${e.Name}`,Hash:e.Hash,Tsize:e.Tsize}]}});break}}}else tn("link %s was not present in sub-shard",l),e.Name=l,o.node.Links.push(e),o.children.set(c,!0),tn("adding %s to existing sub-shard",l);return O9(i,t,r)};async function oh(n,e,t={}){const r=await Kr(n,e,t);if(r.type!=="directory")throw new y2(`${n.toString()} was not a UnixFS directory`);return{cid:n,node:r.node}}async function T2(n,e,t,r){const i=await Kr(n,t,r);if(i.type!=="directory"&&i.type!=="file"&&i.type!=="raw")throw new Eo(`${n.toString()} was not a UnixFS node`);return{Name:e,Tsize:i.node instanceof Uint8Array?i.node.byteLength:KL(i.node),Hash:n}}function KL(n){const e=n.Links.reduce((t,r)=>t+(r.Tsize??0),0);return it(n).byteLength+e}const WL=mt("helia:unixfs:components:utils:resolve");async function Tc(n,e,t,r){if(e==null||e==="")return{cid:n};const i=`/ipfs/${n}${e==null?"":`/${e}`}`,s=await Ia(S2(i,t,r));if(s.length===0)throw new f9("Could not find path in directory");return WL("resolved %s to %c",e,n),{cid:s[s.length-1].cid,path:e,segments:s}}async function zu(n,e,t,r){if(e.segments==null||e.segments.length===0)return n;let i=e.segments.pop();if(i==null)throw new Error("Insufficient segments");i.cid=n,e.segments.reverse();for(const s of e.segments){const[o,a]=await Promise.all([oh(s.cid,t,r),T2(i.cid,i.name,t,r)]);n=(await C2(o,a,t,{...r,allowOverwriting:!0,cidVersion:n.version})).cid,s.cid=n,i=s}return n}const GL=Wr.bind({ignoreUndefined:!0}),jL={};async function*QL(n,e,t={}){const r=GL(jL,t),i=await Tc(n,r.path,e,r),s=await Kr(i.cid,e,r);if(s.type!=="file"&&s.type!=="raw")throw new kD;if(s.content==null)throw new p9;yield*s.content(r)}const Rc=262144,YL=Wr.bind({ignoreUndefined:!0}),XL=mt("helia:unixfs:chmod"),ZL={recursive:!1,shardSplitThresholdBytes:Rc};async function JL(n,e,t,r={}){const i=YL(ZL,r),s=await Tc(n,i.path,t,r);if(XL("chmod %c %d",s.cid,e),i.recursive){const h=await rr(async function*(){for await(const f of x2(s.cid,t,r)){let m,y=[];if(f.type==="raw")m=new xe({type:"file",data:f.node});else if(f.type==="file"||f.type==="directory")m=f.unixfs,y=f.node.Links;else throw new Eo;m.mode=e;const w={Data:m.marshal(),Links:y};yield{path:f.path,content:w}}},f=>sh(f,t,{...i,dagBuilder:async function*(m,y){for await(const w of m)yield async function(){const E=w.content,A=it(E),T=await So(A,y,{...i,cidVersion:n.version});if(E.Data==null)throw new es(`${T} had no data`);const R=xe.unmarshal(E.Data);return{cid:T,size:BigInt(A.length),path:w.path,unixfs:R}}}}),async f=>oo(f));if(h==null)throw new m2(`Could not chmod ${s.cid.toString()}`);return zu(h.cid,s,t,i)}const o=await t.get(s.cid,r);let a,c=[];if(s.cid.code===er)a=new xe({type:"file",data:o});else{const h=hn(o);if(h.Data==null)throw new es(`${s.cid.toString()} had no data`);c=h.Links,a=xe.unmarshal(h.Data)}a.mode=e;const l=it({Data:a.marshal(),Links:c}),u=await gt.digest(l),d=he.create(s.cid.version,qt,u);return await t.put(d,l),zu(d,s,t,i)}const eB=Wr.bind({ignoreUndefined:!0}),tB=mt("helia:unixfs:cp"),rB={force:!1,shardSplitThresholdBytes:Rc};async function nB(n,e,t,r,i={}){const s=eB(rB,i);if(t.includes("/"))throw new $r("Name must not have slashes");const[o,a]=await Promise.all([oh(e,r,s),T2(n,t,r,s)]);return tB('Adding %c as "%s" to %c',n,t,e),(await C2(o,a,r,{allowOverwriting:s.force,cidVersion:e.version,...s})).cid}const iB=Wr.bind({ignoreUndefined:!0}),sB={};async function*oB(n,e,t={}){const r=iB(sB,t),i=await Tc(n,r.path,e,r),s=await Kr(i.cid,e,{...t,extended:!0});if(s.type==="file"||s.type==="raw"){t.extended===!1?yield{name:s.name,path:s.path,cid:s.cid}:yield s;return}if(s.content==null)throw new p9;if(s.type!=="directory")throw new y2;yield*s.content(t)}const aB=Wr.bind({ignoreUndefined:!0}),Z4=mt("helia:unixfs:mkdir"),cB={cidVersion:1,force:!1,shardSplitThresholdBytes:Rc};async function lB(n,e,t,r={}){const i=aB(cB,r);if(e.includes("/"))throw new $r("Path must not have slashes");if((await Kr(n,t,r)).type!=="directory")throw new y2(`${n.toString()} was not a UnixFS directory`);Z4("creating %s",e);const a={Data:new xe({type:"directory",mode:i.mode,mtime:i.mtime}).marshal(),Links:[]},c=it(a),l=await gt.digest(c),u=he.create(i.cidVersion,qt,l);await t.put(u,c);const[d,h]=await Promise.all([oh(n,t,i),T2(u,e,t,i)]);return Z4("adding empty dir called %s to %c",e,n),(await C2(d,h,t,{...i,allowOverwriting:i.force})).cid}const wl=mt("helia:unixfs:utils:remove-link");async function uB(n,e,t,r){if(n.node.Data==null)throw new es("Parent node had no data");if(xe.unmarshal(n.node.Data).type==="hamt-sharded-directory"){wl(`removing ${e} from sharded directory`);const s=await hB(n,e,t,r);return await D9(s.node,t,r.shardSplitThresholdBytes,r)?s:(wl("converting shard to flat directory %c",n.cid),fB(s,t,r))}return wl(`removing link ${e} regular directory`),dB(n,e,t,r)}const dB=async(n,e,t,r)=>{n.node.Links=n.node.Links.filter(o=>o.Name!==e);const i=it(n.node),s=await So(i,t,{...r,cidVersion:n.cid.version});return wl(`Updated regular directory ${s}`),{node:n.node,cid:s}},hB=async(n,e,t,r)=>{const{path:i}=await N9(n.cid,e,t,r),s=i[i.length-1];if(s==null)throw new Error("Invalid HAMT, could not generate path");const o=s.node.Links.filter(l=>(l.Name??"").substring(2)===e).map(l=>l.Name).pop();if(o==null)throw new Error("File not found");const a=o.substring(0,2),c=parseInt(a,16);if(s.node.Links=s.node.Links.filter(l=>l.Name!==o),s.children.unset(c),s.node.Links.length===1)for(;i.length!==1;){const l=i[i.length-1];if(l==null||l.node.Links.length>1)break;i.pop();const u=i[i.length-1];if(u==null)break;const d=l.node.Links[0];u.node.Links=u.node.Links.filter(h=>!(h.Name??"").startsWith(u.prefix)),u.node.Links.push({Hash:d.Hash,Name:`${u.prefix}${(d.Name??"").substring(2)}`,Tsize:d.Tsize})}return O9(i,t,r)},fB=async(n,e,t)=>{if(n.node.Data==null)throw new $r("Invalid parent passed to convertToFlatDirectory");const r={Links:[]},i=await Kr(n.cid,e);if(i.type!=="directory")throw new Error("Unexpected node type");for await(const c of i.content()){let l=0;c.node instanceof Uint8Array?l=c.node.byteLength:l=it(c.node).length,r.Links.push({Hash:c.cid,Name:c.name,Tsize:l})}const s=xe.unmarshal(n.node.Data);r.Data=new xe({type:"directory",mode:s.mode,mtime:s.mtime}).marshal();const o=it(qr(r));return{cid:await So(o,e,{codec:ic,cidVersion:n.cid.version,signal:t.signal}),node:r}},pB=Wr.bind({ignoreUndefined:!0}),gB=mt("helia:unixfs:rm"),mB={shardSplitThresholdBytes:Rc};async function yB(n,e,t,r={}){const i=pB(mB,r);if(e.includes("/"))throw new $r("Name must not have slashes");const s=await oh(n,t,i);return gB("Removing %s from %c",e,n),(await uB(s,e,t,{...i,cidVersion:n.version})).cid}const B9=1877,ah=1604,wB=Wr.bind({ignoreUndefined:!0}),vB=mt("helia:unixfs:stat"),bB={};async function EB(n,e,t={}){const r=wB(bB,t),i=await Tc(n,t.path,e,r);vB("stat %c",i.cid);const s=await Kr(i.cid,e,r);if(s.type==="raw")return t.extended===!0?kB(s):AB(s);if(s.type==="file"||s.type==="directory")return t.extended===!0?xB(s,e,t.filter??new G5({filterSize:1024}),t):SB(s);throw new Eo}function SB(n){return{type:n.type,cid:n.cid,unixfs:n.unixfs,mode:n.unixfs.mode??(n.unixfs.isDirectory()?B9:ah),mtime:n.unixfs.mtime,size:n.unixfs.fileSize()}}async function xB(n,e,t,r){const i=await M9(n.cid,e,!1,t,r);return{type:n.type,cid:n.cid,unixfs:n.unixfs,size:n.unixfs.isDirectory()?i.dirSize:n.unixfs.fileSize(),mode:n.unixfs.mode??(n.unixfs.isDirectory()?B9:ah),mtime:n.unixfs.mtime,localSize:i.localSize,dagSize:i.dagSize,deduplicatedDagSize:i.deduplicatedDagSize,blocks:i.blocks,uniqueBlocks:i.uniqueBlocks}}function AB(n){return{type:n.type,cid:n.cid,unixfs:void 0,mode:ah,mtime:void 0,size:BigInt(n.node.byteLength)}}function kB(n){return{type:n.type,cid:n.cid,unixfs:void 0,mode:ah,mtime:void 0,size:BigInt(n.node.byteLength),localSize:BigInt(n.node.byteLength),dagSize:BigInt(n.node.byteLength),deduplicatedDagSize:BigInt(n.node.byteLength),blocks:1n,uniqueBlocks:1n}}async function M9(n,e,t,r,i){const s={dirSize:0n,localSize:0n,dagSize:0n,deduplicatedDagSize:0n,blocks:0n,uniqueBlocks:0n};try{const o=r.has(n.bytes);r.add(n.bytes);const a=await e.get(n,i);if(s.blocks++,s.dagSize+=BigInt(a.byteLength),o||(s.uniqueBlocks++,s.deduplicatedDagSize+=BigInt(a.byteLength)),n.code===er)s.localSize+=BigInt(a.byteLength),t&&(s.dirSize+=BigInt(a.byteLength));else if(n.code===qt){const c=hn(a);let l;if(c.Data!=null&&(l=xe.unmarshal(c.Data)),c.Links.length>0){for(const u of c.Links){const d=await M9(u.Hash,e,_B(u,l),r,i);s.localSize+=d.localSize,s.dagSize+=d.dagSize,s.deduplicatedDagSize+=d.deduplicatedDagSize,s.blocks+=d.blocks,s.uniqueBlocks+=d.uniqueBlocks,s.dirSize+=d.dirSize}t&&l!=null&&(s.dirSize+=l.fileSize())}else{if(l==null)throw new es(`PBNode ${n.toString()} had no data`);l.data!=null&&(s.localSize+=BigInt(l.data.byteLength??0)),t&&(s.dirSize+=l.fileSize())}}else throw new m2(`${n.toString()} was neither DAG_PB nor RAW`)}catch(o){if(o.name!=="NotFoundError"||i.offline!==!0)throw o}return s}function _B(n,e){if(e==null)return!1;const t=n.Name;return t==null?!1:e.type==="directory"?!0:e.type==="hamt-sharded-directory"&&t.length>2}const IB=Wr.bind({ignoreUndefined:!0}),CB=mt("helia:unixfs:touch"),TB={recursive:!1,shardSplitThresholdBytes:Rc};async function RB(n,e,t={}){const r=IB(TB,t),i=await Tc(n,r.path,e,r),s=r.mtime??{secs:BigInt(Math.round(Date.now()/1e3)),nsecs:0};if(CB("touch %c %o",i.cid,s),r.recursive){const h=await rr(async function*(){for await(const f of x2(i.cid,e)){let m,y;if(f.type==="raw")m=new xe({data:f.node}),y=[];else if(f.type==="file"||f.type==="directory")m=f.unixfs,y=f.node.Links;else throw new Eo;m.mtime=s;const w={Data:m.marshal(),Links:y};yield{path:f.path,content:w}}},f=>sh(f,e,{...r,dagBuilder:async function*(m,y){for await(const w of m)yield async function(){const E=w.content,A=it(E),T=await So(A,y,{...r,cidVersion:n.version});if(E.Data==null)throw new es(`${T} had no data`);const R=xe.unmarshal(E.Data);return{cid:T,size:BigInt(A.length),path:w.path,unixfs:R}}}}),async f=>oo(f));if(h==null)throw new m2(`Could not chmod ${i.cid.toString()}`);return zu(h.cid,i,e,r)}const o=await e.get(i.cid,t);let a,c=[];if(i.cid.code===er)a=new xe({data:o});else{const h=hn(o);if(c=h.Links,h.Data==null)throw new es(`${i.cid.toString()} had no data`);a=xe.unmarshal(h.Data)}a.mtime=s;const l=it({Data:a.marshal(),Links:c}),u=await gt.digest(l),d=he.create(i.cid.version,qt,u);return await e.put(d,l),zu(d,i,e,r)}class PB{components;constructor(e){this.components=e}async*addAll(e,t={}){yield*k2(e,this.components.blockstore,t)}async addBytes(e,t={}){return CL(e,this.components.blockstore,t)}async addByteStream(e,t={}){return TL(e,this.components.blockstore,t)}async addFile(e,t={}){return RL(e,this.components.blockstore,t)}async addDirectory(e={},t={}){return PL(e,this.components.blockstore,t)}async*cat(e,t={}){yield*QL(e,this.components.blockstore,t)}async chmod(e,t,r={}){return JL(e,t,this.components.blockstore,r)}async cp(e,t,r,i={}){return nB(e,t,r,this.components.blockstore,i)}async*ls(e,t={}){yield*oB(e,this.components.blockstore,t)}async mkdir(e,t,r={}){return lB(e,t,this.components.blockstore,r)}async rm(e,t,r={}){return yB(e,t,this.components.blockstore,r)}async stat(e,t={}){return EB(e,this.components.blockstore,t)}async touch(e,t={}){return RB(e,this.components.blockstore,t)}}function OB(n){return new PB(n)}hv();const O0={128:"",130:"",131:"",132:"",133:"",134:"",135:"",136:"",137:"",138:"",139:"",140:"",142:"",145:"",146:"",147:"",148:"",149:"",150:"",151:"",152:"",153:"",154:"",155:"",156:"",158:"",159:""};for(const[n,e]of Object.entries(O0));function NB(n,e="utf-8"){switch(e.toLowerCase()){case"utf-8":case"utf8":return typeof globalThis.TextDecoder<"u"?new globalThis.TextDecoder("utf-8").decode(n):DB(n);case"utf-16le":return LB(n);case"ascii":return BB(n);case"latin1":case"iso-8859-1":return MB(n);case"windows-1252":return FB(n);default:throw new RangeError(`Encoding '${e}' not supported`)}}function DB(n){let e="",t=0;for(;t<n.length;){const r=n[t++];if(r<128)e+=String.fromCharCode(r);else if(r<224){const i=n[t++]&63;e+=String.fromCharCode((r&31)<<6|i)}else if(r<240){const i=n[t++]&63,s=n[t++]&63;e+=String.fromCharCode((r&15)<<12|i<<6|s)}else{const i=n[t++]&63,s=n[t++]&63,o=n[t++]&63;let a=(r&7)<<18|i<<12|s<<6|o;a-=65536,e+=String.fromCharCode(55296+(a>>10&1023),56320+(a&1023))}}return e}function LB(n){let e="";for(let t=0;t<n.length;t+=2)e+=String.fromCharCode(n[t]|n[t+1]<<8);return e}function BB(n){return String.fromCharCode(...n.map(e=>e&127))}function MB(n){return String.fromCharCode(...n)}function FB(n){let e="";for(const t of n)t>=128&&t<=159&&O0[t]?e+=O0[t]:e+=String.fromCharCode(t);return e}function ir(n){return new DataView(n.buffer,n.byteOffset)}const UB={len:1,get(n,e){return ir(n).getUint8(e)},put(n,e,t){return ir(n).setUint8(e,t),e+1}},Ye={len:2,get(n,e){return ir(n).getUint16(e,!0)},put(n,e,t){return ir(n).setUint16(e,t,!0),e+2}},Do={len:2,get(n,e){return ir(n).getUint16(e)},put(n,e,t){return ir(n).setUint16(e,t),e+2}},ft={len:4,get(n,e){return ir(n).getUint32(e,!0)},put(n,e,t){return ir(n).setUint32(e,t,!0),e+4}},$B={len:4,get(n,e){return ir(n).getUint32(e)},put(n,e,t){return ir(n).setUint32(e,t),e+4}},VB={len:4,get(n,e){return ir(n).getInt32(e)},put(n,e,t){return ir(n).setInt32(e,t),e+4}},qB={len:8,get(n,e){return ir(n).getBigUint64(e,!0)},put(n,e,t){return ir(n).setBigUint64(e,t,!0),e+8}};class bn{constructor(e,t){this.len=e,this.encoding=t}get(e,t=0){const r=e.subarray(t,t+this.len);return NB(r,this.encoding)}}const HB="End-Of-Stream";class gr extends Error{constructor(){super(HB),this.name="EndOfStreamError"}}class zB extends Error{constructor(e="The operation was aborted"){super(e),this.name="AbortError"}}class F9{constructor(){this.endOfStream=!1,this.interrupted=!1,this.peekQueue=[]}async peek(e,t=!1){const r=await this.read(e,t);return this.peekQueue.push(e.subarray(0,r)),r}async read(e,t=!1){if(e.length===0)return 0;let r=this.readFromPeekBuffer(e);if(this.endOfStream||(r+=await this.readRemainderFromStream(e.subarray(r),t)),r===0&&!t)throw new gr;return r}readFromPeekBuffer(e){let t=e.length,r=0;for(;this.peekQueue.length>0&&t>0;){const i=this.peekQueue.pop();if(!i)throw new Error("peekData should be defined");const s=Math.min(i.length,t);e.set(i.subarray(0,s),r),r+=s,t-=s,s<i.length&&this.peekQueue.push(i.subarray(s))}return r}async readRemainderFromStream(e,t){let r=0;for(;r<e.length&&!this.endOfStream;){if(this.interrupted)throw new zB;const i=await this.readFromStream(e.subarray(r),t);if(i===0)break;r+=i}if(!t&&r<e.length)throw new gr;return r}}class KB extends F9{constructor(e){super(),this.reader=e}async abort(){return this.close()}async close(){this.reader.releaseLock()}}class WB extends KB{async readFromStream(e,t){if(e.length===0)return 0;const r=await this.reader.read(new Uint8Array(e.length),{min:t?void 0:e.length});return r.done&&(this.endOfStream=r.done),r.value?(e.set(r.value),r.value.length):0}}class J4 extends F9{constructor(e){super(),this.reader=e,this.buffer=null}writeChunk(e,t){const r=Math.min(t.length,e.length);return e.set(t.subarray(0,r)),r<t.length?this.buffer=t.subarray(r):this.buffer=null,r}async readFromStream(e,t){if(e.length===0)return 0;let r=0;for(this.buffer&&(r+=this.writeChunk(e,this.buffer));r<e.length&&!this.endOfStream;){const i=await this.reader.read();if(i.done){this.endOfStream=!0;break}i.value&&(r+=this.writeChunk(e.subarray(r),i.value))}if(!t&&r===0&&this.endOfStream)throw new gr;return r}abort(){return this.interrupted=!0,this.reader.cancel()}async close(){await this.abort(),this.reader.releaseLock()}}function GB(n){try{const e=n.getReader({mode:"byob"});return e instanceof ReadableStreamDefaultReader?new J4(e):new WB(e)}catch(e){if(e instanceof TypeError)return new J4(n.getReader());throw e}}class U9{constructor(e){this.numBuffer=new Uint8Array(8),this.position=0,this.onClose=e?.onClose,e?.abortSignal&&e.abortSignal.addEventListener("abort",()=>{this.abort()})}async readToken(e,t=this.position){const r=new Uint8Array(e.len);if(await this.readBuffer(r,{position:t})<e.len)throw new gr;return e.get(r,0)}async peekToken(e,t=this.position){const r=new Uint8Array(e.len);if(await this.peekBuffer(r,{position:t})<e.len)throw new gr;return e.get(r,0)}async readNumber(e){if(await this.readBuffer(this.numBuffer,{length:e.len})<e.len)throw new gr;return e.get(this.numBuffer,0)}async peekNumber(e){if(await this.peekBuffer(this.numBuffer,{length:e.len})<e.len)throw new gr;return e.get(this.numBuffer,0)}async ignore(e){if(this.fileInfo.size!==void 0){const t=this.fileInfo.size-this.position;if(e>t)return this.position+=t,t}return this.position+=e,e}async close(){await this.abort(),await this.onClose?.()}normalizeOptions(e,t){if(!this.supportsRandomAccess()&&t&&t.position!==void 0&&t.position<this.position)throw new Error("`options.position` must be equal or greater than `tokenizer.position`");return{mayBeLess:!1,offset:0,length:e.length,position:this.position,...t}}abort(){return Promise.resolve()}}const jB=256e3;class QB extends U9{constructor(e,t){super(t),this.streamReader=e,this.fileInfo=t?.fileInfo??{}}async readBuffer(e,t){const r=this.normalizeOptions(e,t),i=r.position-this.position;if(i>0)return await this.ignore(i),this.readBuffer(e,t);if(i<0)throw new Error("`options.position` must be equal or greater than `tokenizer.position`");if(r.length===0)return 0;const s=await this.streamReader.read(e.subarray(0,r.length),r.mayBeLess);if(this.position+=s,(!t||!t.mayBeLess)&&s<r.length)throw new gr;return s}async peekBuffer(e,t){const r=this.normalizeOptions(e,t);let i=0;if(r.position){const s=r.position-this.position;if(s>0){const o=new Uint8Array(r.length+s);return i=await this.peekBuffer(o,{mayBeLess:r.mayBeLess}),e.set(o.subarray(s)),i-s}if(s<0)throw new Error("Cannot peek from a negative offset in a stream")}if(r.length>0){try{i=await this.streamReader.peek(e.subarray(0,r.length),r.mayBeLess)}catch(s){if(t?.mayBeLess&&s instanceof gr)return 0;throw s}if(!r.mayBeLess&&i<r.length)throw new gr}return i}async ignore(e){const t=Math.min(jB,e),r=new Uint8Array(t);let i=0;for(;i<e;){const s=e-i,o=await this.readBuffer(r,{length:Math.min(t,s)});if(o<0)return o;i+=o}return i}abort(){return this.streamReader.abort()}async close(){return this.streamReader.close()}supportsRandomAccess(){return!1}}class YB extends U9{constructor(e,t){super(t),this.uint8Array=e,this.fileInfo={...t?.fileInfo??{},size:e.length}}async readBuffer(e,t){t?.position&&(this.position=t.position);const r=await this.peekBuffer(e,t);return this.position+=r,r}async peekBuffer(e,t){const r=this.normalizeOptions(e,t),i=Math.min(this.uint8Array.length-r.position,r.length);if(!r.mayBeLess&&i<r.length)throw new gr;return e.set(this.uint8Array.subarray(r.position,r.position+i)),i}close(){return super.close()}supportsRandomAccess(){return!0}setPosition(e){this.position=e}}function XB(n,e){const t=GB(n),r=e??{},i=r.onClose;return r.onClose=async()=>{if(await t.close(),i)return i()},new QB(t,r)}function ZB(n,e){return new YB(n,e)}var hr=Uint8Array,ks=Uint16Array,JB=Int32Array,$9=new hr([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),V9=new hr([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),eM=new hr([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),q9=function(n,e){for(var t=new ks(31),r=0;r<31;++r)t[r]=e+=1<<n[r-1];for(var i=new JB(t[30]),r=1;r<30;++r)for(var s=t[r];s<t[r+1];++s)i[s]=s-t[r]<<5|r;return{b:t,r:i}},H9=q9($9,2),z9=H9.b,tM=H9.r;z9[28]=258,tM[258]=28;var rM=q9(V9,0),nM=rM.b,N0=new ks(32768);for(var He=0;He<32768;++He){var qn=(He&43690)>>1|(He&21845)<<1;qn=(qn&52428)>>2|(qn&13107)<<2,qn=(qn&61680)>>4|(qn&3855)<<4,N0[He]=((qn&65280)>>8|(qn&255)<<8)>>1}var Sa=(function(n,e,t){for(var r=n.length,i=0,s=new ks(e);i<r;++i)n[i]&&++s[n[i]-1];var o=new ks(e);for(i=1;i<e;++i)o[i]=o[i-1]+s[i-1]<<1;var a;if(t){a=new ks(1<<e);var c=15-e;for(i=0;i<r;++i)if(n[i])for(var l=i<<4|n[i],u=e-n[i],d=o[n[i]-1]++<<u,h=d|(1<<u)-1;d<=h;++d)a[N0[d]>>c]=l}else for(a=new ks(r),i=0;i<r;++i)n[i]&&(a[i]=N0[o[n[i]-1]++]>>15-n[i]);return a}),Pc=new hr(288);for(var He=0;He<144;++He)Pc[He]=8;for(var He=144;He<256;++He)Pc[He]=9;for(var He=256;He<280;++He)Pc[He]=7;for(var He=280;He<288;++He)Pc[He]=8;var K9=new hr(32);for(var He=0;He<32;++He)K9[He]=5;var iM=Sa(Pc,9,1),sM=Sa(K9,5,1),h1=function(n){for(var e=n[0],t=1;t<n.length;++t)n[t]>e&&(e=n[t]);return e},Cr=function(n,e,t){var r=e/8|0;return(n[r]|n[r+1]<<8)>>(e&7)&t},f1=function(n,e){var t=e/8|0;return(n[t]|n[t+1]<<8|n[t+2]<<16)>>(e&7)},oM=function(n){return(n+7)/8|0},aM=function(n,e,t){return(t==null||t>n.length)&&(t=n.length),new hr(n.subarray(e,t))},cM=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],cr=function(n,e,t){var r=new Error(e||cM[n]);if(r.code=n,Error.captureStackTrace&&Error.captureStackTrace(r,cr),!t)throw r;return r},R2=function(n,e,t,r){var i=n.length,s=0;if(!i||e.f&&!e.l)return t||new hr(0);var o=!t,a=o||e.i!=2,c=e.i;o&&(t=new hr(i*3));var l=function(ar){var xo=t.length;if(ar>xo){var mi=new hr(Math.max(xo*2,ar));mi.set(t),t=mi}},u=e.f||0,d=e.p||0,h=e.b||0,f=e.l,m=e.d,y=e.m,w=e.n,E=i*8;do{if(!f){u=Cr(n,d,1);var A=Cr(n,d+1,3);if(d+=3,A)if(A==1)f=iM,m=sM,y=9,w=5;else if(A==2){var re=Cr(n,d,31)+257,j=Cr(n,d+10,15)+4,se=re+Cr(n,d+5,31)+1;d+=14;for(var _=new hr(se),M=new hr(19),O=0;O<j;++O)M[eM[O]]=Cr(n,d+O*3,7);d+=j*3;for(var F=h1(M),U=(1<<F)-1,X=Sa(M,F,1),O=0;O<se;){var te=X[Cr(n,d,U)];d+=te&15;var T=te>>4;if(T<16)_[O++]=T;else{var G=0,Z=0;for(T==16?(Z=3+Cr(n,d,3),d+=2,G=_[O-1]):T==17?(Z=3+Cr(n,d,7),d+=3):T==18&&(Z=11+Cr(n,d,127),d+=7);Z--;)_[O++]=G}}var ce=_.subarray(0,re),N=_.subarray(re);y=h1(ce),w=h1(N),f=Sa(ce,y,1),m=Sa(N,w,1)}else cr(1);else{var T=oM(d)+4,R=n[T-4]|n[T-3]<<8,ie=T+R;if(ie>i){c&&cr(0);break}a&&l(h+R),t.set(n.subarray(T,ie),h),e.b=h+=R,e.p=d=ie*8,e.f=u;continue}if(d>E){c&&cr(0);break}}a&&l(h+131072);for(var fe=(1<<y)-1,Ce=(1<<w)-1,Ee=d;;Ee=d){var G=f[f1(n,d)&fe],K=G>>4;if(d+=G&15,d>E){c&&cr(0);break}if(G||cr(2),K<256)t[h++]=K;else if(K==256){Ee=d,f=null;break}else{var lt=K-254;if(K>264){var O=K-257,It=$9[O];lt=Cr(n,d,(1<<It)-1)+z9[O],d+=It}var Se=m[f1(n,d)&Ce],Dt=Se>>4;Se||cr(3),d+=Se&15;var N=nM[Dt];if(Dt>3){var It=V9[Dt];N+=f1(n,d)&(1<<It)-1,d+=It}if(d>E){c&&cr(0);break}a&&l(h+131072);var Wt=h+lt;if(h<N){var Lt=s-N,ch=Math.min(N,Wt);for(Lt+h<0&&cr(3);h<ch;++h)t[h]=r[Lt+h]}for(;h<Wt;++h)t[h]=t[h-N]}}e.l=f,e.p=Ee,e.b=h,e.f=u,f&&(u=1,e.m=y,e.d=m,e.n=w)}while(!u);return h!=t.length&&o?aM(t,0,h):t.subarray(0,h)},lM=new hr(0),uM=function(n){(n[0]!=31||n[1]!=139||n[2]!=8)&&cr(6,"invalid gzip data");var e=n[3],t=10;e&4&&(t+=(n[10]|n[11]<<8)+2);for(var r=(e>>3&1)+(e>>4&1);r>0;r-=!n[t++]);return t+(e&2)},dM=function(n){var e=n.length;return(n[e-4]|n[e-3]<<8|n[e-2]<<16|n[e-1]<<24)>>>0},hM=function(n,e){return((n[0]&15)!=8||n[0]>>4>7||(n[0]<<8|n[1])%31)&&cr(6,"invalid zlib data"),(n[1]>>5&1)==1&&cr(6,"invalid zlib data: "+(n[1]&32?"need":"unexpected")+" dictionary"),(n[1]>>3&4)+2};function fM(n,e){return R2(n,{i:2},e,e)}function pM(n,e){var t=uM(n);return t+8>n.length&&cr(6,"invalid gzip data"),R2(n.subarray(t,-8),{i:2},new hr(dM(n)),e)}function gM(n,e){return R2(n.subarray(hM(n),-4),{i:2},e,e)}function mM(n,e){return n[0]==31&&n[1]==139&&n[2]==8?pM(n,e):(n[0]&15)!=8||n[0]>>4>7||(n[0]<<8|n[1])%31?fM(n,e):gM(n,e)}var yM=typeof TextDecoder<"u"&&new TextDecoder,wM=0;try{yM.decode(lM,{stream:!0}),wM=1}catch{}var vM=dv();const bM=ao(vM),_s={LocalFileHeader:67324752,DataDescriptor:134695760,CentralFileHeader:33639248,EndOfCentralDirectory:101010256},e5={get(n){return Ye.get(n,6),{signature:ft.get(n,0),compressedSize:ft.get(n,8),uncompressedSize:ft.get(n,12)}},len:16},EM={get(n){const e=Ye.get(n,6);return{signature:ft.get(n,0),minVersion:Ye.get(n,4),dataDescriptor:!!(e&8),compressedMethod:Ye.get(n,8),compressedSize:ft.get(n,18),uncompressedSize:ft.get(n,22),filenameLength:Ye.get(n,26),extraFieldLength:Ye.get(n,28),filename:null}},len:30},SM={get(n){return{signature:ft.get(n,0),nrOfThisDisk:Ye.get(n,4),nrOfThisDiskWithTheStart:Ye.get(n,6),nrOfEntriesOnThisDisk:Ye.get(n,8),nrOfEntriesOfSize:Ye.get(n,10),sizeOfCd:ft.get(n,12),offsetOfStartOfCd:ft.get(n,16),zipFileCommentLength:Ye.get(n,20)}},len:22},xM={get(n){const e=Ye.get(n,8);return{signature:ft.get(n,0),minVersion:Ye.get(n,6),dataDescriptor:!!(e&8),compressedMethod:Ye.get(n,10),compressedSize:ft.get(n,20),uncompressedSize:ft.get(n,24),filenameLength:Ye.get(n,28),extraFieldLength:Ye.get(n,30),fileCommentLength:Ye.get(n,32),relativeOffsetOfLocalHeader:ft.get(n,42),filename:null}},len:46};function W9(n){const e=new Uint8Array(ft.len);return ft.put(e,0,n),e}const Yr=bM("tokenizer:inflate"),p1=256*1024,AM=W9(_s.DataDescriptor),ol=W9(_s.EndOfCentralDirectory);class kM{constructor(e){this.tokenizer=e,this.syncBuffer=new Uint8Array(p1)}async isZip(){return await this.peekSignature()===_s.LocalFileHeader}peekSignature(){return this.tokenizer.peekToken(ft)}async findEndOfCentralDirectoryLocator(){const e=this.tokenizer,t=Math.min(16*1024,e.fileInfo.size),r=this.syncBuffer.subarray(0,t);await this.tokenizer.readBuffer(r,{position:e.fileInfo.size-t});for(let i=r.length-4;i>=0;i--)if(r[i]===ol[0]&&r[i+1]===ol[1]&&r[i+2]===ol[2]&&r[i+3]===ol[3])return e.fileInfo.size-t+i;return-1}async readCentralDirectory(){if(!this.tokenizer.supportsRandomAccess()){Yr("Cannot reading central-directory without random-read support");return}Yr("Reading central-directory...");const e=this.tokenizer.position,t=await this.findEndOfCentralDirectoryLocator();if(t>0){Yr("Central-directory 32-bit signature found");const r=await this.tokenizer.readToken(SM,t),i=[];this.tokenizer.setPosition(r.offsetOfStartOfCd);for(let s=0;s<r.nrOfEntriesOfSize;++s){const o=await this.tokenizer.readToken(xM);if(o.signature!==_s.CentralFileHeader)throw new Error("Expected Central-File-Header signature");o.filename=await this.tokenizer.readToken(new bn(o.filenameLength,"utf-8")),await this.tokenizer.ignore(o.extraFieldLength),await this.tokenizer.ignore(o.fileCommentLength),i.push(o),Yr(`Add central-directory file-entry: n=${s+1}/${i.length}: filename=${i[s].filename}`)}return this.tokenizer.setPosition(e),i}this.tokenizer.setPosition(e)}async unzip(e){const t=await this.readCentralDirectory();if(t)return this.iterateOverCentralDirectory(t,e);let r=!1;do{const i=await this.readLocalFileHeader();if(!i)break;const s=e(i);r=!!s.stop;let o;if(await this.tokenizer.ignore(i.extraFieldLength),i.dataDescriptor&&i.compressedSize===0){const a=[];let c=p1;Yr("Compressed-file-size unknown, scanning for next data-descriptor-signature....");let l=-1;for(;l<0&&c===p1;){c=await this.tokenizer.peekBuffer(this.syncBuffer,{mayBeLess:!0}),l=_M(this.syncBuffer.subarray(0,c),AM);const u=l>=0?l:c;if(s.handler){const d=new Uint8Array(u);await this.tokenizer.readBuffer(d),a.push(d)}else await this.tokenizer.ignore(u)}Yr(`Found data-descriptor-signature at pos=${this.tokenizer.position}`),s.handler&&await this.inflate(i,IM(a),s.handler)}else s.handler?(Yr(`Reading compressed-file-data: ${i.compressedSize} bytes`),o=new Uint8Array(i.compressedSize),await this.tokenizer.readBuffer(o),await this.inflate(i,o,s.handler)):(Yr(`Ignoring compressed-file-data: ${i.compressedSize} bytes`),await this.tokenizer.ignore(i.compressedSize));if(Yr(`Reading data-descriptor at pos=${this.tokenizer.position}`),i.dataDescriptor&&(await this.tokenizer.readToken(e5)).signature!==134695760)throw new Error(`Expected data-descriptor-signature at position ${this.tokenizer.position-e5.len}`)}while(!r)}async iterateOverCentralDirectory(e,t){for(const r of e){const i=t(r);if(i.handler){this.tokenizer.setPosition(r.relativeOffsetOfLocalHeader);const s=await this.readLocalFileHeader();if(s){await this.tokenizer.ignore(s.extraFieldLength);const o=new Uint8Array(r.compressedSize);await this.tokenizer.readBuffer(o),await this.inflate(s,o,i.handler)}}if(i.stop)break}}inflate(e,t,r){if(e.compressedMethod===0)return r(t);Yr(`Decompress filename=${e.filename}, compressed-size=${t.length}`);const i=mM(t);return r(i)}async readLocalFileHeader(){const e=await this.tokenizer.peekToken(ft);if(e===_s.LocalFileHeader){const t=await this.tokenizer.readToken(EM);return t.filename=await this.tokenizer.readToken(new bn(t.filenameLength,"utf-8")),t}if(e===_s.CentralFileHeader)return!1;throw e===3759263696?new Error("Encrypted ZIP"):new Error("Unexpected signature")}}function _M(n,e){const t=n.length,r=e.length;if(r>t)return-1;for(let i=0;i<=t-r;i++){let s=!0;for(let o=0;o<r;o++)if(n[i+o]!==e[o]){s=!1;break}if(s)return i}return-1}function IM(n){const e=n.reduce((i,s)=>i+s.length,0),t=new Uint8Array(e);let r=0;for(const i of n)t.set(i,r),r+=i.length;return t}new globalThis.TextDecoder("utf8");new globalThis.TextEncoder;Array.from({length:256},(n,e)=>e.toString(16).padStart(2,"0"));function t5(n){const{byteLength:e}=n;if(e===6)return n.getUint16(0)*2**32+n.getUint32(2);if(e===5)return n.getUint8(0)*2**32+n.getUint32(1);if(e===4)return n.getUint32(0);if(e===3)return n.getUint8(0)*2**16+n.getUint16(1);if(e===2)return n.getUint16(0);if(e===1)return n.getUint8(0)}function CM(n,e){const t=n.length,r=e.length;if(r===0||r>t)return-1;const i=t-r;for(let s=0;s<=i;s++){let o=!0;for(let a=0;a<r;a++)if(n[s+a]!==e[a]){o=!1;break}if(o)return s}return-1}function TM(n,e){return CM(n,e)!==-1}function RM(n){return[...n].map(e=>e.charCodeAt(0))}function PM(n,e=0){const t=Number.parseInt(new bn(6).get(n,148).replace(/\0.*$/,"").trim(),8);if(Number.isNaN(t))return!1;let r=256;for(let i=e;i<e+148;i++)r+=n[i];for(let i=e+156;i<e+512;i++)r+=n[i];return t===r}const OM={get:(n,e)=>n[e+3]&127|n[e+2]<<7|n[e+1]<<14|n[e]<<21,len:4},NM=["jpg","png","apng","gif","webp","flif","xcf","cr2","cr3","orf","arw","dng","nef","rw2","raf","tif","bmp","icns","jxr","psd","indd","zip","tar","rar","gz","bz2","7z","dmg","mp4","mid","mkv","webm","mov","avi","mpg","mp2","mp3","m4a","oga","ogg","ogv","opus","flac","wav","spx","amr","pdf","epub","elf","macho","exe","swf","rtf","wasm","woff","woff2","eot","ttf","otf","ttc","ico","flv","ps","xz","sqlite","nes","crx","xpi","cab","deb","ar","rpm","Z","lz","cfb","mxf","mts","blend","bpg","docx","pptx","xlsx","3gp","3g2","j2c","jp2","jpm","jpx","mj2","aif","qcp","odt","ods","odp","xml","mobi","heic","cur","ktx","ape","wv","dcm","ics","glb","pcap","dsf","lnk","alias","voc","ac3","m4v","m4p","m4b","f4v","f4p","f4b","f4a","mie","asf","ogm","ogx","mpc","arrow","shp","aac","mp1","it","s3m","xm","ai","skp","avif","eps","lzh","pgp","asar","stl","chm","3mf","zst","jxl","vcf","jls","pst","dwg","parquet","class","arj","cpio","ace","avro","icc","fbx","vsdx","vtt","apk","drc","lz4","potx","xltx","dotx","xltm","ott","ots","otp","odg","otg","xlsm","docm","dotm","potm","pptm","jar","rm","ppsm","ppsx"],DM=["image/jpeg","image/png","image/gif","image/webp","image/flif","image/x-xcf","image/x-canon-cr2","image/x-canon-cr3","image/tiff","image/bmp","image/vnd.ms-photo","image/vnd.adobe.photoshop","application/x-indesign","application/epub+zip","application/x-xpinstall","application/vnd.ms-powerpoint.slideshow.macroenabled.12","application/vnd.oasis.opendocument.text","application/vnd.oasis.opendocument.spreadsheet","application/vnd.oasis.opendocument.presentation","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.presentationml.presentation","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.openxmlformats-officedocument.presentationml.slideshow","application/zip","application/x-tar","application/x-rar-compressed","application/gzip","application/x-bzip2","application/x-7z-compressed","application/x-apple-diskimage","application/x-apache-arrow","video/mp4","audio/midi","video/x-matroska","video/webm","video/quicktime","video/vnd.avi","audio/wav","audio/qcelp","audio/x-ms-asf","video/x-ms-asf","application/vnd.ms-asf","video/mpeg","video/3gpp","audio/mpeg","audio/mp4","video/ogg","audio/ogg","audio/ogg; codecs=opus","application/ogg","audio/x-flac","audio/ape","audio/wavpack","audio/amr","application/pdf","application/x-elf","application/x-mach-binary","application/x-msdownload","application/x-shockwave-flash","application/rtf","application/wasm","font/woff","font/woff2","application/vnd.ms-fontobject","font/ttf","font/otf","font/collection","image/x-icon","video/x-flv","application/postscript","application/eps","application/x-xz","application/x-sqlite3","application/x-nintendo-nes-rom","application/x-google-chrome-extension","application/vnd.ms-cab-compressed","application/x-deb","application/x-unix-archive","application/x-rpm","application/x-compress","application/x-lzip","application/x-cfb","application/x-mie","application/mxf","video/mp2t","application/x-blender","image/bpg","image/j2c","image/jp2","image/jpx","image/jpm","image/mj2","audio/aiff","application/xml","application/x-mobipocket-ebook","image/heif","image/heif-sequence","image/heic","image/heic-sequence","image/icns","image/ktx","application/dicom","audio/x-musepack","text/calendar","text/vcard","text/vtt","model/gltf-binary","application/vnd.tcpdump.pcap","audio/x-dsf","application/x.ms.shortcut","application/x.apple.alias","audio/x-voc","audio/vnd.dolby.dd-raw","audio/x-m4a","image/apng","image/x-olympus-orf","image/x-sony-arw","image/x-adobe-dng","image/x-nikon-nef","image/x-panasonic-rw2","image/x-fujifilm-raf","video/x-m4v","video/3gpp2","application/x-esri-shape","audio/aac","audio/x-it","audio/x-s3m","audio/x-xm","video/MP1S","video/MP2P","application/vnd.sketchup.skp","image/avif","application/x-lzh-compressed","application/pgp-encrypted","application/x-asar","model/stl","application/vnd.ms-htmlhelp","model/3mf","image/jxl","application/zstd","image/jls","application/vnd.ms-outlook","image/vnd.dwg","application/x-parquet","application/java-vm","application/x-arj","application/x-cpio","application/x-ace-compressed","application/avro","application/vnd.iccprofile","application/x.autodesk.fbx","application/vnd.visio","application/vnd.android.package-archive","application/vnd.google.draco","application/x-lz4","application/vnd.openxmlformats-officedocument.presentationml.template","application/vnd.openxmlformats-officedocument.spreadsheetml.template","application/vnd.openxmlformats-officedocument.wordprocessingml.template","application/vnd.ms-excel.template.macroenabled.12","application/vnd.oasis.opendocument.text-template","application/vnd.oasis.opendocument.spreadsheet-template","application/vnd.oasis.opendocument.presentation-template","application/vnd.oasis.opendocument.graphics","application/vnd.oasis.opendocument.graphics-template","application/vnd.ms-excel.sheet.macroenabled.12","application/vnd.ms-word.document.macroenabled.12","application/vnd.ms-word.template.macroenabled.12","application/vnd.ms-powerpoint.template.macroenabled.12","application/vnd.ms-powerpoint.presentation.macroenabled.12","application/java-archive","application/vnd.rn-realmedia"],g1=4100;async function LM(n){return new BM().fromBuffer(n)}function m1(n){switch(n.toLowerCase()){case"application/epub+zip":return{ext:"epub",mime:"application/epub+zip"};case"application/vnd.oasis.opendocument.text":return{ext:"odt",mime:"application/vnd.oasis.opendocument.text"};case"application/vnd.oasis.opendocument.text-template":return{ext:"ott",mime:"application/vnd.oasis.opendocument.text-template"};case"application/vnd.oasis.opendocument.spreadsheet":return{ext:"ods",mime:"application/vnd.oasis.opendocument.spreadsheet"};case"application/vnd.oasis.opendocument.spreadsheet-template":return{ext:"ots",mime:"application/vnd.oasis.opendocument.spreadsheet-template"};case"application/vnd.oasis.opendocument.presentation":return{ext:"odp",mime:"application/vnd.oasis.opendocument.presentation"};case"application/vnd.oasis.opendocument.presentation-template":return{ext:"otp",mime:"application/vnd.oasis.opendocument.presentation-template"};case"application/vnd.oasis.opendocument.graphics":return{ext:"odg",mime:"application/vnd.oasis.opendocument.graphics"};case"application/vnd.oasis.opendocument.graphics-template":return{ext:"otg",mime:"application/vnd.oasis.opendocument.graphics-template"};case"application/vnd.openxmlformats-officedocument.presentationml.slideshow":return{ext:"ppsx",mime:"application/vnd.openxmlformats-officedocument.presentationml.slideshow"};case"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":return{ext:"xlsx",mime:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"};case"application/vnd.ms-excel.sheet.macroenabled":return{ext:"xlsm",mime:"application/vnd.ms-excel.sheet.macroenabled.12"};case"application/vnd.openxmlformats-officedocument.spreadsheetml.template":return{ext:"xltx",mime:"application/vnd.openxmlformats-officedocument.spreadsheetml.template"};case"application/vnd.ms-excel.template.macroenabled":return{ext:"xltm",mime:"application/vnd.ms-excel.template.macroenabled.12"};case"application/vnd.ms-powerpoint.slideshow.macroenabled":return{ext:"ppsm",mime:"application/vnd.ms-powerpoint.slideshow.macroenabled.12"};case"application/vnd.openxmlformats-officedocument.wordprocessingml.document":return{ext:"docx",mime:"application/vnd.openxmlformats-officedocument.wordprocessingml.document"};case"application/vnd.ms-word.document.macroenabled":return{ext:"docm",mime:"application/vnd.ms-word.document.macroenabled.12"};case"application/vnd.openxmlformats-officedocument.wordprocessingml.template":return{ext:"dotx",mime:"application/vnd.openxmlformats-officedocument.wordprocessingml.template"};case"application/vnd.ms-word.template.macroenabledtemplate":return{ext:"dotm",mime:"application/vnd.ms-word.template.macroenabled.12"};case"application/vnd.openxmlformats-officedocument.presentationml.template":return{ext:"potx",mime:"application/vnd.openxmlformats-officedocument.presentationml.template"};case"application/vnd.ms-powerpoint.template.macroenabled":return{ext:"potm",mime:"application/vnd.ms-powerpoint.template.macroenabled.12"};case"application/vnd.openxmlformats-officedocument.presentationml.presentation":return{ext:"pptx",mime:"application/vnd.openxmlformats-officedocument.presentationml.presentation"};case"application/vnd.ms-powerpoint.presentation.macroenabled":return{ext:"pptm",mime:"application/vnd.ms-powerpoint.presentation.macroenabled.12"};case"application/vnd.ms-visio.drawing":return{ext:"vsdx",mime:"application/vnd.visio"};case"application/vnd.ms-package.3dmanufacturing-3dmodel+xml":return{ext:"3mf",mime:"model/3mf"}}}function Xr(n,e,t){t={offset:0,...t};for(const[r,i]of e.entries())if(t.mask){if(i!==(t.mask[r]&n[r+t.offset]))return!1}else if(i!==n[r+t.offset])return!1;return!0}class BM{constructor(e){this.detectors=[...e?.customDetectors??[],{id:"core",detect:this.detectConfident},{id:"core.imprecise",detect:this.detectImprecise}],this.tokenizerOptions={abortSignal:e?.signal}}async fromTokenizer(e){const t=e.position;for(const r of this.detectors){const i=await r.detect(e);if(i)return i;if(t!==e.position)return}}async fromBuffer(e){if(!(e instanceof Uint8Array||e instanceof ArrayBuffer))throw new TypeError(`Expected the \`input\` argument to be of type \`Uint8Array\` or \`ArrayBuffer\`, got \`${typeof e}\``);const t=e instanceof Uint8Array?e:new Uint8Array(e);if(t?.length>1)return this.fromTokenizer(ZB(t,this.tokenizerOptions))}async fromBlob(e){return this.fromStream(e.stream())}async fromStream(e){const t=await XB(e,this.tokenizerOptions);try{return await this.fromTokenizer(t)}finally{await t.close()}}async toDetectionStream(e,t){const{sampleSize:r=g1}=t;let i,s;const o=e.getReader({mode:"byob"});try{const{value:l,done:u}=await o.read(new Uint8Array(r));if(s=l,!u&&l)try{i=await this.fromBuffer(l.slice(0,r))}catch(d){if(!(d instanceof gr))throw d;i=void 0}s=l}finally{o.releaseLock()}const a=new TransformStream({async start(l){l.enqueue(s)},transform(l,u){u.enqueue(l)}}),c=e.pipeThrough(a);return c.fileType=i,c}check(e,t){return Xr(this.buffer,e,t)}checkString(e,t){return this.check(RM(e),t)}detectConfident=async e=>{if(this.buffer=new Uint8Array(g1),e.fileInfo.size===void 0&&(e.fileInfo.size=Number.MAX_SAFE_INTEGER),this.tokenizer=e,await e.peekBuffer(this.buffer,{length:12,mayBeLess:!0}),this.check([66,77]))return{ext:"bmp",mime:"image/bmp"};if(this.check([11,119]))return{ext:"ac3",mime:"audio/vnd.dolby.dd-raw"};if(this.check([120,1]))return{ext:"dmg",mime:"application/x-apple-diskimage"};if(this.check([77,90]))return{ext:"exe",mime:"application/x-msdownload"};if(this.check([37,33]))return await e.peekBuffer(this.buffer,{length:24,mayBeLess:!0}),this.checkString("PS-Adobe-",{offset:2})&&this.checkString(" EPSF-",{offset:14})?{ext:"eps",mime:"application/eps"}:{ext:"ps",mime:"application/postscript"};if(this.check([31,160])||this.check([31,157]))return{ext:"Z",mime:"application/x-compress"};if(this.check([199,113]))return{ext:"cpio",mime:"application/x-cpio"};if(this.check([96,234]))return{ext:"arj",mime:"application/x-arj"};if(this.check([239,187,191]))return this.tokenizer.ignore(3),this.detectConfident(e);if(this.check([71,73,70]))return{ext:"gif",mime:"image/gif"};if(this.check([73,73,188]))return{ext:"jxr",mime:"image/vnd.ms-photo"};if(this.check([31,139,8]))return{ext:"gz",mime:"application/gzip"};if(this.check([66,90,104]))return{ext:"bz2",mime:"application/x-bzip2"};if(this.checkString("ID3")){await e.ignore(6);const t=await e.readToken(OM);return e.position+t>e.fileInfo.size?{ext:"mp3",mime:"audio/mpeg"}:(await e.ignore(t),this.fromTokenizer(e))}if(this.checkString("MP+"))return{ext:"mpc",mime:"audio/x-musepack"};if((this.buffer[0]===67||this.buffer[0]===70)&&this.check([87,83],{offset:1}))return{ext:"swf",mime:"application/x-shockwave-flash"};if(this.check([255,216,255]))return this.check([247],{offset:3})?{ext:"jls",mime:"image/jls"}:{ext:"jpg",mime:"image/jpeg"};if(this.check([79,98,106,1]))return{ext:"avro",mime:"application/avro"};if(this.checkString("FLIF"))return{ext:"flif",mime:"image/flif"};if(this.checkString("8BPS"))return{ext:"psd",mime:"image/vnd.adobe.photoshop"};if(this.checkString("MPCK"))return{ext:"mpc",mime:"audio/x-musepack"};if(this.checkString("FORM"))return{ext:"aif",mime:"audio/aiff"};if(this.checkString("icns",{offset:0}))return{ext:"icns",mime:"image/icns"};if(this.check([80,75,3,4])){let t;return await new kM(e).unzip(r=>{switch(r.filename){case"META-INF/mozilla.rsa":return t={ext:"xpi",mime:"application/x-xpinstall"},{stop:!0};case"META-INF/MANIFEST.MF":return t={ext:"jar",mime:"application/java-archive"},{stop:!0};case"mimetype":return{async handler(i){const s=new TextDecoder("utf-8").decode(i).trim();t=m1(s)},stop:!0};case"[Content_Types].xml":return{async handler(i){let s=new TextDecoder("utf-8").decode(i);const o=s.indexOf('.main+xml"');if(o===-1){const a="application/vnd.ms-package.3dmanufacturing-3dmodel+xml";s.includes(`ContentType="${a}"`)&&(t=m1(a))}else{s=s.slice(0,Math.max(0,o));const a=s.lastIndexOf('"'),c=s.slice(Math.max(0,a+1));t=m1(c)}},stop:!0};default:return/classes\d*\.dex/.test(r.filename)?(t={ext:"apk",mime:"application/vnd.android.package-archive"},{stop:!0}):{}}}),t??{ext:"zip",mime:"application/zip"}}if(this.checkString("OggS")){await e.ignore(28);const t=new Uint8Array(8);return await e.readBuffer(t),Xr(t,[79,112,117,115,72,101,97,100])?{ext:"opus",mime:"audio/ogg; codecs=opus"}:Xr(t,[128,116,104,101,111,114,97])?{ext:"ogv",mime:"video/ogg"}:Xr(t,[1,118,105,100,101,111,0])?{ext:"ogm",mime:"video/ogg"}:Xr(t,[127,70,76,65,67])?{ext:"oga",mime:"audio/ogg"}:Xr(t,[83,112,101,101,120,32,32])?{ext:"spx",mime:"audio/ogg"}:Xr(t,[1,118,111,114,98,105,115])?{ext:"ogg",mime:"audio/ogg"}:{ext:"ogx",mime:"application/ogg"}}if(this.check([80,75])&&(this.buffer[2]===3||this.buffer[2]===5||this.buffer[2]===7)&&(this.buffer[3]===4||this.buffer[3]===6||this.buffer[3]===8))return{ext:"zip",mime:"application/zip"};if(this.checkString("MThd"))return{ext:"mid",mime:"audio/midi"};if(this.checkString("wOFF")&&(this.check([0,1,0,0],{offset:4})||this.checkString("OTTO",{offset:4})))return{ext:"woff",mime:"font/woff"};if(this.checkString("wOF2")&&(this.check([0,1,0,0],{offset:4})||this.checkString("OTTO",{offset:4})))return{ext:"woff2",mime:"font/woff2"};if(this.check([212,195,178,161])||this.check([161,178,195,212]))return{ext:"pcap",mime:"application/vnd.tcpdump.pcap"};if(this.checkString("DSD "))return{ext:"dsf",mime:"audio/x-dsf"};if(this.checkString("LZIP"))return{ext:"lz",mime:"application/x-lzip"};if(this.checkString("fLaC"))return{ext:"flac",mime:"audio/x-flac"};if(this.check([66,80,71,251]))return{ext:"bpg",mime:"image/bpg"};if(this.checkString("wvpk"))return{ext:"wv",mime:"audio/wavpack"};if(this.checkString("%PDF")){try{if(await e.ignore(1350)===1350){const i=new Uint8Array(Math.min(10485760,e.fileInfo.size-1350));if(await e.readBuffer(i,{mayBeLess:!0}),TM(i,new TextEncoder().encode("AIPrivateData")))return{ext:"ai",mime:"application/postscript"}}}catch(t){if(!(t instanceof gr))throw t}return{ext:"pdf",mime:"application/pdf"}}if(this.check([0,97,115,109]))return{ext:"wasm",mime:"application/wasm"};if(this.check([73,73])){const t=await this.readTiffHeader(!1);if(t)return t}if(this.check([77,77])){const t=await this.readTiffHeader(!0);if(t)return t}if(this.checkString("MAC "))return{ext:"ape",mime:"audio/ape"};if(this.check([26,69,223,163])){async function t(){const a=await e.peekNumber(UB);let c=128,l=0;for(;(a&c)===0&&c!==0;)++l,c>>=1;const u=new Uint8Array(l+1);return await e.readBuffer(u),u}async function r(){const a=await t(),c=await t();c[0]^=128>>c.length-1;const l=Math.min(6,c.length),u=new DataView(a.buffer),d=new DataView(c.buffer,c.length-l,l);return{id:t5(u),len:t5(d)}}async function i(a){for(;a>0;){const c=await r();if(c.id===17026)return(await e.readToken(new bn(c.len))).replaceAll(/\00.*$/g,"");await e.ignore(c.len),--a}}const s=await r();switch(await i(s.len)){case"webm":return{ext:"webm",mime:"video/webm"};case"matroska":return{ext:"mkv",mime:"video/x-matroska"};default:return}}if(this.checkString("SQLi"))return{ext:"sqlite",mime:"application/x-sqlite3"};if(this.check([78,69,83,26]))return{ext:"nes",mime:"application/x-nintendo-nes-rom"};if(this.checkString("Cr24"))return{ext:"crx",mime:"application/x-google-chrome-extension"};if(this.checkString("MSCF")||this.checkString("ISc("))return{ext:"cab",mime:"application/vnd.ms-cab-compressed"};if(this.check([237,171,238,219]))return{ext:"rpm",mime:"application/x-rpm"};if(this.check([197,208,211,198]))return{ext:"eps",mime:"application/eps"};if(this.check([40,181,47,253]))return{ext:"zst",mime:"application/zstd"};if(this.check([127,69,76,70]))return{ext:"elf",mime:"application/x-elf"};if(this.check([33,66,68,78]))return{ext:"pst",mime:"application/vnd.ms-outlook"};if(this.checkString("PAR1"))return{ext:"parquet",mime:"application/x-parquet"};if(this.checkString("ttcf"))return{ext:"ttc",mime:"font/collection"};if(this.check([207,250,237,254]))return{ext:"macho",mime:"application/x-mach-binary"};if(this.check([4,34,77,24]))return{ext:"lz4",mime:"application/x-lz4"};if(this.check([79,84,84,79,0]))return{ext:"otf",mime:"font/otf"};if(this.checkString("#!AMR"))return{ext:"amr",mime:"audio/amr"};if(this.checkString("{\\rtf"))return{ext:"rtf",mime:"application/rtf"};if(this.check([70,76,86,1]))return{ext:"flv",mime:"video/x-flv"};if(this.checkString("IMPM"))return{ext:"it",mime:"audio/x-it"};if(this.checkString("-lh0-",{offset:2})||this.checkString("-lh1-",{offset:2})||this.checkString("-lh2-",{offset:2})||this.checkString("-lh3-",{offset:2})||this.checkString("-lh4-",{offset:2})||this.checkString("-lh5-",{offset:2})||this.checkString("-lh6-",{offset:2})||this.checkString("-lh7-",{offset:2})||this.checkString("-lzs-",{offset:2})||this.checkString("-lz4-",{offset:2})||this.checkString("-lz5-",{offset:2})||this.checkString("-lhd-",{offset:2}))return{ext:"lzh",mime:"application/x-lzh-compressed"};if(this.check([0,0,1,186])){if(this.check([33],{offset:4,mask:[241]}))return{ext:"mpg",mime:"video/MP1S"};if(this.check([68],{offset:4,mask:[196]}))return{ext:"mpg",mime:"video/MP2P"}}if(this.checkString("ITSF"))return{ext:"chm",mime:"application/vnd.ms-htmlhelp"};if(this.check([202,254,186,190]))return{ext:"class",mime:"application/java-vm"};if(this.checkString(".RMF"))return{ext:"rm",mime:"application/vnd.rn-realmedia"};if(this.checkString("DRACO"))return{ext:"drc",mime:"application/vnd.google.draco"};if(this.check([253,55,122,88,90,0]))return{ext:"xz",mime:"application/x-xz"};if(this.checkString("<?xml "))return{ext:"xml",mime:"application/xml"};if(this.check([55,122,188,175,39,28]))return{ext:"7z",mime:"application/x-7z-compressed"};if(this.check([82,97,114,33,26,7])&&(this.buffer[6]===0||this.buffer[6]===1))return{ext:"rar",mime:"application/x-rar-compressed"};if(this.checkString("solid "))return{ext:"stl",mime:"model/stl"};if(this.checkString("AC")){const t=new bn(4,"latin1").get(this.buffer,2);if(t.match("^d*")&&t>=1e3&&t<=1050)return{ext:"dwg",mime:"image/vnd.dwg"}}if(this.checkString("070707"))return{ext:"cpio",mime:"application/x-cpio"};if(this.checkString("BLENDER"))return{ext:"blend",mime:"application/x-blender"};if(this.checkString("!<arch>"))return await e.ignore(8),await e.readToken(new bn(13,"ascii"))==="debian-binary"?{ext:"deb",mime:"application/x-deb"}:{ext:"ar",mime:"application/x-unix-archive"};if(this.checkString("WEBVTT")&&[`
`,"\r","	"," ","\0"].some(t=>this.checkString(t,{offset:6})))return{ext:"vtt",mime:"text/vtt"};if(this.check([137,80,78,71,13,10,26,10])){await e.ignore(8);async function t(){return{length:await e.readToken(VB),type:await e.readToken(new bn(4,"latin1"))}}do{const r=await t();if(r.length<0)return;switch(r.type){case"IDAT":return{ext:"png",mime:"image/png"};case"acTL":return{ext:"apng",mime:"image/apng"};default:await e.ignore(r.length+4)}}while(e.position+8<e.fileInfo.size);return{ext:"png",mime:"image/png"}}if(this.check([65,82,82,79,87,49,0,0]))return{ext:"arrow",mime:"application/x-apache-arrow"};if(this.check([103,108,84,70,2,0,0,0]))return{ext:"glb",mime:"model/gltf-binary"};if(this.check([102,114,101,101],{offset:4})||this.check([109,100,97,116],{offset:4})||this.check([109,111,111,118],{offset:4})||this.check([119,105,100,101],{offset:4}))return{ext:"mov",mime:"video/quicktime"};if(this.check([73,73,82,79,8,0,0,0,24]))return{ext:"orf",mime:"image/x-olympus-orf"};if(this.checkString("gimp xcf "))return{ext:"xcf",mime:"image/x-xcf"};if(this.checkString("ftyp",{offset:4})&&(this.buffer[8]&96)!==0){const t=new bn(4,"latin1").get(this.buffer,8).replace("\0"," ").trim();switch(t){case"avif":case"avis":return{ext:"avif",mime:"image/avif"};case"mif1":return{ext:"heic",mime:"image/heif"};case"msf1":return{ext:"heic",mime:"image/heif-sequence"};case"heic":case"heix":return{ext:"heic",mime:"image/heic"};case"hevc":case"hevx":return{ext:"heic",mime:"image/heic-sequence"};case"qt":return{ext:"mov",mime:"video/quicktime"};case"M4V":case"M4VH":case"M4VP":return{ext:"m4v",mime:"video/x-m4v"};case"M4P":return{ext:"m4p",mime:"video/mp4"};case"M4B":return{ext:"m4b",mime:"audio/mp4"};case"M4A":return{ext:"m4a",mime:"audio/x-m4a"};case"F4V":return{ext:"f4v",mime:"video/mp4"};case"F4P":return{ext:"f4p",mime:"video/mp4"};case"F4A":return{ext:"f4a",mime:"audio/mp4"};case"F4B":return{ext:"f4b",mime:"audio/mp4"};case"crx":return{ext:"cr3",mime:"image/x-canon-cr3"};default:return t.startsWith("3g")?t.startsWith("3g2")?{ext:"3g2",mime:"video/3gpp2"}:{ext:"3gp",mime:"video/3gpp"}:{ext:"mp4",mime:"video/mp4"}}}if(this.check([82,73,70,70])){if(this.checkString("WEBP",{offset:8}))return{ext:"webp",mime:"image/webp"};if(this.check([65,86,73],{offset:8}))return{ext:"avi",mime:"video/vnd.avi"};if(this.check([87,65,86,69],{offset:8}))return{ext:"wav",mime:"audio/wav"};if(this.check([81,76,67,77],{offset:8}))return{ext:"qcp",mime:"audio/qcelp"}}if(this.check([73,73,85,0,24,0,0,0,136,231,116,216]))return{ext:"rw2",mime:"image/x-panasonic-rw2"};if(this.check([48,38,178,117,142,102,207,17,166,217])){async function t(){const r=new Uint8Array(16);return await e.readBuffer(r),{id:r,size:Number(await e.readToken(qB))}}for(await e.ignore(30);e.position+24<e.fileInfo.size;){const r=await t();let i=r.size-24;if(Xr(r.id,[145,7,220,183,183,169,207,17,142,230,0,192,12,32,83,101])){const s=new Uint8Array(16);if(i-=await e.readBuffer(s),Xr(s,[64,158,105,248,77,91,207,17,168,253,0,128,95,92,68,43]))return{ext:"asf",mime:"audio/x-ms-asf"};if(Xr(s,[192,239,25,188,77,91,207,17,168,253,0,128,95,92,68,43]))return{ext:"asf",mime:"video/x-ms-asf"};break}await e.ignore(i)}return{ext:"asf",mime:"application/vnd.ms-asf"}}if(this.check([171,75,84,88,32,49,49,187,13,10,26,10]))return{ext:"ktx",mime:"image/ktx"};if((this.check([126,16,4])||this.check([126,24,4]))&&this.check([48,77,73,69],{offset:4}))return{ext:"mie",mime:"application/x-mie"};if(this.check([39,10,0,0,0,0,0,0,0,0,0,0],{offset:2}))return{ext:"shp",mime:"application/x-esri-shape"};if(this.check([255,79,255,81]))return{ext:"j2c",mime:"image/j2c"};if(this.check([0,0,0,12,106,80,32,32,13,10,135,10]))switch(await e.ignore(20),await e.readToken(new bn(4,"ascii"))){case"jp2 ":return{ext:"jp2",mime:"image/jp2"};case"jpx ":return{ext:"jpx",mime:"image/jpx"};case"jpm ":return{ext:"jpm",mime:"image/jpm"};case"mjp2":return{ext:"mj2",mime:"image/mj2"};default:return}if(this.check([255,10])||this.check([0,0,0,12,74,88,76,32,13,10,135,10]))return{ext:"jxl",mime:"image/jxl"};if(this.check([254,255]))return this.check([0,60,0,63,0,120,0,109,0,108],{offset:2})?{ext:"xml",mime:"application/xml"}:void 0;if(this.check([208,207,17,224,161,177,26,225]))return{ext:"cfb",mime:"application/x-cfb"};if(await e.peekBuffer(this.buffer,{length:Math.min(256,e.fileInfo.size),mayBeLess:!0}),this.check([97,99,115,112],{offset:36}))return{ext:"icc",mime:"application/vnd.iccprofile"};if(this.checkString("**ACE",{offset:7})&&this.checkString("**",{offset:12}))return{ext:"ace",mime:"application/x-ace-compressed"};if(this.checkString("BEGIN:")){if(this.checkString("VCARD",{offset:6}))return{ext:"vcf",mime:"text/vcard"};if(this.checkString("VCALENDAR",{offset:6}))return{ext:"ics",mime:"text/calendar"}}if(this.checkString("FUJIFILMCCD-RAW"))return{ext:"raf",mime:"image/x-fujifilm-raf"};if(this.checkString("Extended Module:"))return{ext:"xm",mime:"audio/x-xm"};if(this.checkString("Creative Voice File"))return{ext:"voc",mime:"audio/x-voc"};if(this.check([4,0,0,0])&&this.buffer.length>=16){const t=new DataView(this.buffer.buffer).getUint32(12,!0);if(t>12&&this.buffer.length>=t+16)try{const r=new TextDecoder().decode(this.buffer.slice(16,t+16));if(JSON.parse(r).files)return{ext:"asar",mime:"application/x-asar"}}catch{}}if(this.check([6,14,43,52,2,5,1,1,13,1,2,1,1,2]))return{ext:"mxf",mime:"application/mxf"};if(this.checkString("SCRM",{offset:44}))return{ext:"s3m",mime:"audio/x-s3m"};if(this.check([71])&&this.check([71],{offset:188}))return{ext:"mts",mime:"video/mp2t"};if(this.check([71],{offset:4})&&this.check([71],{offset:196}))return{ext:"mts",mime:"video/mp2t"};if(this.check([66,79,79,75,77,79,66,73],{offset:60}))return{ext:"mobi",mime:"application/x-mobipocket-ebook"};if(this.check([68,73,67,77],{offset:128}))return{ext:"dcm",mime:"application/dicom"};if(this.check([76,0,0,0,1,20,2,0,0,0,0,0,192,0,0,0,0,0,0,70]))return{ext:"lnk",mime:"application/x.ms.shortcut"};if(this.check([98,111,111,107,0,0,0,0,109,97,114,107,0,0,0,0]))return{ext:"alias",mime:"application/x.apple.alias"};if(this.checkString("Kaydara FBX Binary  \0"))return{ext:"fbx",mime:"application/x.autodesk.fbx"};if(this.check([76,80],{offset:34})&&(this.check([0,0,1],{offset:8})||this.check([1,0,2],{offset:8})||this.check([2,0,2],{offset:8})))return{ext:"eot",mime:"application/vnd.ms-fontobject"};if(this.check([6,6,237,245,216,29,70,229,189,49,239,231,254,116,183,29]))return{ext:"indd",mime:"application/x-indesign"};if(await e.peekBuffer(this.buffer,{length:Math.min(512,e.fileInfo.size),mayBeLess:!0}),PM(this.buffer))return{ext:"tar",mime:"application/x-tar"};if(this.check([255,254]))return this.check([60,0,63,0,120,0,109,0,108,0],{offset:2})?{ext:"xml",mime:"application/xml"}:this.check([255,14,83,0,107,0,101,0,116,0,99,0,104,0,85,0,112,0,32,0,77,0,111,0,100,0,101,0,108,0],{offset:2})?{ext:"skp",mime:"application/vnd.sketchup.skp"}:void 0;if(this.checkString("-----BEGIN PGP MESSAGE-----"))return{ext:"pgp",mime:"application/pgp-encrypted"}};detectImprecise=async e=>{if(this.buffer=new Uint8Array(g1),await e.peekBuffer(this.buffer,{length:Math.min(8,e.fileInfo.size),mayBeLess:!0}),this.check([0,0,1,186])||this.check([0,0,1,179]))return{ext:"mpg",mime:"video/mpeg"};if(this.check([0,1,0,0,0]))return{ext:"ttf",mime:"font/ttf"};if(this.check([0,0,1,0]))return{ext:"ico",mime:"image/x-icon"};if(this.check([0,0,2,0]))return{ext:"cur",mime:"image/x-icon"};if(this.buffer.length>=2&&this.check([255,224],{offset:0,mask:[255,224]})){if(this.check([16],{offset:1,mask:[22]}))return this.check([8],{offset:1,mask:[8]})?{ext:"aac",mime:"audio/aac"}:{ext:"aac",mime:"audio/aac"};if(this.check([2],{offset:1,mask:[6]}))return{ext:"mp3",mime:"audio/mpeg"};if(this.check([4],{offset:1,mask:[6]}))return{ext:"mp2",mime:"audio/mpeg"};if(this.check([6],{offset:1,mask:[6]}))return{ext:"mp1",mime:"audio/mpeg"}}};async readTiffTag(e){const t=await this.tokenizer.readToken(e?Do:Ye);switch(this.tokenizer.ignore(10),t){case 50341:return{ext:"arw",mime:"image/x-sony-arw"};case 50706:return{ext:"dng",mime:"image/x-adobe-dng"}}}async readTiffIFD(e){const t=await this.tokenizer.readToken(e?Do:Ye);for(let r=0;r<t;++r){const i=await this.readTiffTag(e);if(i)return i}}async readTiffHeader(e){const t=(e?Do:Ye).get(this.buffer,2),r=(e?$B:ft).get(this.buffer,4);if(t===42){if(r>=6){if(this.checkString("CR",{offset:8}))return{ext:"cr2",mime:"image/x-canon-cr2"};if(r>=8){const s=(e?Do:Ye).get(this.buffer,8),o=(e?Do:Ye).get(this.buffer,10);if(s===28&&o===254||s===31&&o===11)return{ext:"nef",mime:"image/x-nikon-nef"}}}return await this.tokenizer.ignore(r),await this.readTiffIFD(e)??{ext:"tif",mime:"image/tiff"}}if(t===43)return{ext:"tif",mime:"image/tiff"}}}new Set(NM);new Set(DM);const ni=mt("helia:verified-fetch:content-type-parser"),D0="application/octet-stream";function MM(n){return ni("checking for svg"),/^(<\?xml[^>]+>)?[^<^\w]+<svg/ig.test(n)}async function FM(n){ni("checking for json");try{return JSON.parse(n),!0}catch(e){return ni("failed to parse as json",e),!1}}function UM(n){ni("checking for text");const e=new TextDecoder("utf-8",{fatal:!0});try{return e.decode(n)}catch{return null}}async function $M(n){return ni("checking for html"),/^\s*<(?:!doctype\s+html|html|head|body)\b/i.test(n)}async function VM(n,e){ni("contentTypeParser called for fileName: %s, byte size=%s",e,n.length);const t=(await LM(n))?.mime;if(t!=null)return ni("detectedType: %s",t),t==="application/xml"&&e?.toLowerCase().endsWith(".svg")?"image/svg+xml":t;if(ni("no detectedType"),e==null){const r=UM(n);return r!=null?MM(r)?"image/svg+xml":await FM(r)?"application/json":await $M(r)?"text/html; charset=utf-8":"text/plain; charset=utf-8":D0}switch(e.split(".").pop()){case"css":return"text/css";case"html":return"text/html; charset=utf-8";case"js":return"application/javascript";case"json":return"application/json";case"txt":return"text/plain";case"woff2":return"font/woff2";case"svg":return"image/svg+xml";case"csv":return"text/csv";case"doc":return"application/msword";case"xls":return"application/vnd.ms-excel";case"ppt":return"application/vnd.ms-powerpoint";case"msi":return"application/x-msdownload";default:return D0}}function qM(n){return n?.then!=null}async function L0({bytes:n,path:e,contentTypeParser:t,log:r,defaultContentType:i="application/octet-stream",filename:s}){let o;if(t!=null)try{let a;s==null?(a=e.split("/").pop()?.trim(),a=a===""||a?.split(".").length===1?void 0:a):a=s;const c=t(n,a);if(qM(c)){const l=await c;l!=null&&(o=l)}else c!=null&&(o=c);r.trace("contentTypeParser returned %s",o)}catch(a){r.error("error parsing content type",a)}return o===D0&&(o=i),o??i}async function r5(n,e,t,r){const i=t.forComponent("helia:verified-fetch:get-stream-from-async-iterable"),s=n[Symbol.asyncIterator](),{value:o,done:a}=await s.next();if(a===!0)throw i.error("no content found for path",e),new JN;return{stream:new ReadableStream({async start(l){r?.onProgress?.(new P("verified-fetch:request:progress:chunk")),l.enqueue(o)},async pull(l){const{value:u,done:d}=await s.next();if(r?.signal?.aborted){l.error(new pt(r.signal.reason??"signal aborted by user")),l.close();return}if(d===!0){u!=null&&(r?.onProgress?.(new P("verified-fetch:request:progress:chunk")),l.enqueue(u)),l.close();return}r?.onProgress?.(new P("verified-fetch:request:progress:chunk")),l.enqueue(u)}}),firstChunk:o}}class HM extends Fn{id="dag-pb-plugin";codes=[qt];canHandle({cid:e,accept:t,pathDetails:r,byteRangeContext:i}){return this.log("checking if we can handle %c with accept %s",e,t),r==null||i==null?!1:e.code===qt}getRedirectUrl(e){const{resource:t,path:r}=e;if(r===""?!t.toString().endsWith("/"):!r.endsWith("/"))try{const s=new URL(t.toString());return s.pathname.endsWith("/")?null:(s.pathname=`${s.pathname}/`,s.toString())}catch{return`${t.toString()}/`}return null}async handle(e){const{cid:t,options:r,withServerTiming:i=!1,pathDetails:s,query:o}=e,{handleServerTiming:a,contentTypeParser:c,helia:l,getBlockstore:u}=this.pluginOptions,d=this.log;let h=e.resource,f=e.path,m=!1;const y=e.byteRangeContext,w=s.ipfsRoots,E=s.terminalElement;let A=E.cid;const T=OB({...l,blockstore:u(e.cid,e.resource,r?.session??!0,r)});if(E?.type==="directory"){const R=E.cid,ie=this.getRedirectUrl(e);if(ie!=null){if(d.trace("directory url normalization spec requires redirect..."),r?.redirect==="error")throw d('could not redirect to %s as redirect option was set to "error"',ie),new TypeError("Failed to fetch");if(r?.redirect==="manual")return d("returning 301 permanent redirect to %s",ie),A0(h,ie);d("following redirect to %s",ie),h=ie,m=!0}const re="index.html";try{d.trace("found directory at %c/%s, looking for index.html",t,f);const j=await a("exporter-dir","",async()=>Kr(`/ipfs/${R}/${re}`,l.blockstore,{signal:r?.signal,onProgress:r?.onProgress}),i);d.trace("found root file at %c/%s with cid %c",R,re,j.cid),f=re,A=j.cid}catch(j){if(r?.signal?.aborted)throw new pt(r?.signal?.reason);this.log.error("error loading path %c/%s",R,re,j),e.isDirectory=!0,e.directoryEntries=[],e.modified++,this.log.trace("attempting to get directory entries because index.html was not found");try{for await(const se of T.ls(R,{signal:r?.signal,onProgress:r?.onProgress,extended:!1}))e.directoryEntries.push(se);return null}catch(se){return d.error("error listing directory %c",R,se),c9("Unable to get directory contents")}}finally{r?.onProgress?.(new P("verified-fetch:request:end",{cid:R,path:re}))}}try{const R=await T.stat(A,{extended:!0,signal:AbortSignal.timeout(500)});y.setFileSize(R.size)}catch(R){d.error("error getting exact file size for %c/%s - %e",t,f,R),y.setFileSize(s.terminalElement.size),d.trace("using terminal element size of %d for %c/%s",s.terminalElement.size,t,f)}try{const R=await a("exporter-file","",async()=>Kr(A,l.blockstore,{signal:r?.signal,onProgress:r?.onProgress}),i);let ie,re;if(y.isValidRangeRequest)re=await this.handleRangeRequest(e,R);else{const se=R.content({signal:r?.signal,onProgress:r?.onProgress});d("got async iterator for %c/%s",t,f);const _=await a("stream-and-chunk","",async()=>r5(se,f??"",this.pluginOptions.logger,{onProgress:r?.onProgress,signal:r?.signal}),i),M=_.stream;ie=_.firstChunk,re=await a("get-content-type","",async()=>L0({filename:o.filename,bytes:ie,path:f,contentTypeParser:c,log:d}),i),y.setBody(M)}const j=cs(h,y.getBody(re),{byteRangeContext:y,log:d},{redirected:m});return j.headers.set("Content-Type",y.getContentType()??re),o9(j,w),j}catch(R){if(r?.signal?.aborted)throw new pt(r?.signal?.reason);return d.error("error streaming %c/%s",t,f,R),y.isRangeRequest&&R.code==="ERR_INVALID_PARAMS"?Nu(h):g2(h.toString(),"Unable to stream content")}}async handleRangeRequest(e,t){const{path:r,byteRangeContext:i,options:s,withServerTiming:o=!1}=e,{handleServerTiming:a,contentTypeParser:c}=this.pluginOptions,l=this.log,u=t.content({signal:s?.signal,onProgress:s?.onProgress,offset:0,length:8192}),{firstChunk:d}=await r5(u,r??"",this.pluginOptions.logger,{onProgress:s?.onProgress,signal:s?.signal}),h=await a("get-content-type","",async()=>L0({bytes:d,path:r,contentTypeParser:c,log:l}),o);return i?.setBody(f=>{if(s?.signal?.aborted)throw new pt(s?.signal?.reason??"aborted while streaming");return t.content({signal:s?.signal,onProgress:s?.onProgress,offset:f.start??0,length:i.getLength(f)})},h),h}}class zM extends Fn{id="dag-walk-plugin";canHandle(e){this.log("checking if we can handle %c with accept %s",e.cid,e.accept);const{pathDetails:t,cid:r}=e;return t!=null?!1:r.code===qt||r.code===ii}async handle(e){const{cid:t,resource:r,options:i,withServerTiming:s=!1}=e,{getBlockstore:o,handleServerTiming:a}=this.pluginOptions,c=o(t,r,i?.session??!0,i),l=await a("path-walking","",async()=>rL({...e,blockstore:c,log:this.log}),s);return l instanceof Response?(this.log.trace("path walking failed"),l.status===404?l:null):(e.modified++,e.pathDetails=l,null)}}function G9(n){return n.charAt(0)==="1"||n.charAt(0)==="Q"?Ot(n):rs(he.parse(n))}class KM extends Error{name="PluginError";code;fatal;details;response;constructor(e,t,r){super(t),this.code=e,this.fatal=r?.fatal??!1,this.details=r?.details,this.response=r?.response}}class B0 extends KM{name="PluginFatalError";constructor(e,t,r){super(e,t,{...r,fatal:!0}),this.name="PluginFatalError"}}class WM extends Fn{id="ipns-record-plugin";codes=[];canHandle({cid:e,accept:t,query:r,byteRangeContext:i}){return this.log("checking if we can handle %c with accept %s",e,t),i==null?!1:t==="application/vnd.ipfs.ipns-record"||r.format==="ipns-record"}async handle(e){const{resource:t,path:r,options:i}=e,{helia:s}=this.pluginOptions;if(e.reqFormat="ipns-record",r!==""||!(t.startsWith("ipns://")||t.includes(".ipns.")||t.includes("/ipns/")))throw this.log.error('invalid request for IPNS name "%s" and path "%s"',t,r),new B0("ERR_INVALID_IPNS_NAME","Invalid IPNS name",{response:x0(t,new Error("Invalid IPNS name"))});let o;try{let h;t.startsWith("ipns://")?h=t.replace("ipns://",""):t.includes("/ipns/")?h=t.split("/ipns/")[1].split("/")[0].split("?")[0]:h=t.split(".ipns.")[0].split("://")[1],this.log.trace('trying to parse peer id from "%s"',h),o=G9(h)}catch(h){throw this.log.error("could not parse peer id from IPNS url %s",t,h),new B0("ERR_NO_PEER_ID_FOUND","could not parse peer id from url",{response:x0(t,h)})}const a=tr([C("/ipns/"),o.toMultihash().bytes]),c=new Te("/dht/record/"+ee(a,"base32"),!1),l=await s.datastore.get(c,i),u=Rt.deserialize(l);e.byteRangeContext.setBody(u.value);const d=cs(t,e.byteRangeContext.getBody("application/vnd.ipfs.ipns-record"),{byteRangeContext:e.byteRangeContext,log:this.log});return d.headers.set("content-type",e.byteRangeContext.getContentType()??"application/vnd.ipfs.ipns-record"),d}}class GM extends Fn{id="json-plugin";codes=[Is,ka];canHandle({cid:e,accept:t,byteRangeContext:r}){return this.log("checking if we can handle %c with accept %s",e,t),r==null?!1:t==="application/vnd.ipld.dag-json"&&e.code!==ii?!0:Is===e.code||ka===e.code}async handle(e){const{path:t,resource:r,cid:i,accept:s,options:o}=e,{getBlockstore:a}=this.pluginOptions,c=o?.session??!0;this.log.trace("fetching %c/%s",i,t);const l=e.pathDetails?.terminalElement.cid??e.cid,d=await a(l,r,c,o).get(l,o);let h;if(s==="application/vnd.ipld.dag-cbor"||s==="application/cbor")try{const y=_5(d);h=l5(y)}catch(y){return this.log.error("could not transform %c to application/vnd.ipld.dag-cbor",y),ec(r)}else h=d;let f;s==null?Is===i.code?f="application/vnd.ipld.dag-json":f="application/json":f=s.split(";")[0],e.byteRangeContext.setBody(h);const m=cs(r,e.byteRangeContext.getBody(f),{byteRangeContext:e.byteRangeContext,log:this.log});return m.headers.set("content-type",e.byteRangeContext.getContentType()??f),e.byteRangeContext.isValidRangeRequest||m.headers.set("content-length",h.length.toString()),m}}const jM=["application/vnd.ipld.dag-json","application/vnd.ipld.raw","application/octet-stream"];function QM({headers:n,accept:e}){const r=(e??new Headers(n).get("accept")??"").split(",").map(i=>i.split(";")[0]).map(i=>i.trim());for(const i of r){if(i==="*/*")return;if(jM.includes(i??""))return i}}class YM extends Fn{id="raw-plugin";codes=[er,_a.code];canHandle({cid:e,accept:t,query:r,byteRangeContext:i}){return this.log("checking if we can handle %c with accept %s",e,t),i==null?!1:t==="application/vnd.ipld.raw"||r.format==="raw"}async handle(e){const{path:t,resource:r,cid:i,accept:s,query:o,options:a}=e,{getBlockstore:c,contentTypeParser:l}=this.pluginOptions,u=a?.session??!0,d=this.log;if(s==="application/vnd.ipld.raw"||o.format==="raw"?(e.reqFormat="raw",e.query.download=!0,e.query.filename=e.query.filename??`${i.toString()}.bin`,d.trace("Set content disposition...")):d.trace("Did NOT set content disposition..."),t!==""&&i.code===er)throw d.trace("404-ing raw codec request for %c/%s",i,t),new B0("ERR_RAW_PATHS_NOT_SUPPORTED","Raw codec does not support paths",{response:l9(r,"Raw codec does not support paths")});const h=e.pathDetails?.terminalElement.cid??e.cid,m=await c(h,r,u,a).get(h,a);e.byteRangeContext.setBody(m);const y=await L0({filename:o.filename,bytes:m,path:t,defaultContentType:QM({headers:a?.headers,accept:s}),contentTypeParser:l,log:d}),w=cs(r,e.byteRangeContext.getBody(y),{byteRangeContext:e.byteRangeContext,log:d},{redirected:!1});return w.headers.set("content-type",e.byteRangeContext.getContentType()??y),w}}const XM=({weak:n,reqFormat:e})=>e==="tar"||e==="car"||e==="ipns-record"||n===!0?"W/":"",ZM=({reqFormat:n})=>n==null?"":n==="tar"?".x-tar":`.${n}`;function j9({cid:n,reqFormat:e,weak:t,rangeStart:r,rangeEnd:i,contentPrefix:s}){const o=XM({weak:t,reqFormat:e});let a=ZM({reqFormat:e});return(r!=null||i!=null)&&(a+=`.${r??"0"}-${i??"N"}`),`${o}"${s??""}${n.toString()}${a}"`}C("ustar\0","binary");C("ustar ","binary");C(" \0","binary");var y1,n5;function JM(){return n5||(n5=1,y1={COPYFILE_EXCL:1,COPYFILE_FICLONE:2,COPYFILE_FICLONE_FORCE:4,F_OK:0,O_APPEND:1024,O_CREAT:64,O_DIRECT:16384,O_DIRECTORY:65536,O_DSYNC:4096,O_EXCL:128,O_NOATIME:262144,O_NOCTTY:256,O_NOFOLLOW:131072,O_NONBLOCK:2048,O_RDONLY:0,O_RDWR:2,O_SYNC:1052672,O_TRUNC:512,O_WRONLY:1,R_OK:4,S_IFBLK:24576,S_IFCHR:8192,S_IFDIR:16384,S_IFIFO:4096,S_IFLNK:40960,S_IFMT:61440,S_IFREG:32768,S_IFSOCK:49152,S_IRGRP:32,S_IROTH:4,S_IRUSR:256,S_IRWXG:56,S_IRWXO:7,S_IRWXU:448,S_IWGRP:16,S_IWOTH:2,S_IWUSR:128,S_IXGRP:8,S_IXOTH:1,S_IXUSR:64,UV_DIRENT_BLOCK:7,UV_DIRENT_CHAR:6,UV_DIRENT_DIR:2,UV_DIRENT_FIFO:4,UV_DIRENT_FILE:1,UV_DIRENT_LINK:3,UV_DIRENT_SOCKET:5,UV_DIRENT_UNKNOWN:0,UV_FS_COPYFILE_EXCL:1,UV_FS_COPYFILE_FICLONE:2,UV_FS_COPYFILE_FICLONE_FORCE:4,UV_FS_O_FILEMAP:0,UV_FS_SYMLINK_DIR:1,UV_FS_SYMLINK_JUNCTION:2,W_OK:2,X_OK:1,RTLD_LAZY:1,RTLD_NOW:2,RTLD_GLOBAL:256,RTLD_LOCAL:0,RTLD_DEEPBIND:8,E2BIG:7,EACCES:13,EADDRINUSE:98,EADDRNOTAVAIL:99,EAFNOSUPPORT:97,EAGAIN:11,EALREADY:114,EBADF:9,EBADMSG:74,EBUSY:16,ECANCELED:125,ECHILD:10,ECONNABORTED:103,ECONNREFUSED:111,ECONNRESET:104,EDEADLK:35,EDESTADDRREQ:89,EDOM:33,EDQUOT:122,EEXIST:17,EFAULT:14,EFBIG:27,EHOSTUNREACH:113,EIDRM:43,EILSEQ:84,EINPROGRESS:115,EINTR:4,EINVAL:22,EIO:5,EISCONN:106,EISDIR:21,ELOOP:40,EMFILE:24,EMLINK:31,EMSGSIZE:90,EMULTIHOP:72,ENAMETOOLONG:36,ENETDOWN:100,ENETRESET:102,ENETUNREACH:101,ENFILE:23,ENOBUFS:105,ENODATA:61,ENODEV:19,ENOENT:2,ENOEXEC:8,ENOLCK:37,ENOLINK:67,ENOMEM:12,ENOMSG:42,ENOPROTOOPT:92,ENOSPC:28,ENOSR:63,ENOSTR:60,ENOSYS:38,ENOTCONN:107,ENOTDIR:20,ENOTEMPTY:39,ENOTSOCK:88,ENOTSUP:95,ENOTTY:25,ENXIO:6,EOPNOTSUPP:95,EOVERFLOW:75,EPERM:1,EPIPE:32,EPROTO:71,EPROTONOSUPPORT:93,EPROTOTYPE:91,ERANGE:34,EROFS:30,ESPIPE:29,ESRCH:3,ESTALE:116,ETIME:62,ETIMEDOUT:110,ETXTBSY:26,EWOULDBLOCK:11,EXDEV:18,SIGHUP:1,SIGINT:2,SIGQUIT:3,SIGILL:4,SIGTRAP:5,SIGABRT:6,SIGIOT:6,SIGBUS:7,SIGFPE:8,SIGKILL:9,SIGUSR1:10,SIGSEGV:11,SIGUSR2:12,SIGPIPE:13,SIGALRM:14,SIGTERM:15,SIGCHLD:17,SIGSTKFLT:16,SIGCONT:18,SIGSTOP:19,SIGTSTP:20,SIGTTIN:21,SIGTTOU:22,SIGURG:23,SIGXCPU:24,SIGXFSZ:25,SIGVTALRM:26,SIGPROF:27,SIGWINCH:28,SIGIO:29,SIGPOLL:29,SIGPWR:30,SIGSYS:31,SIGUNUSED:31,PRIORITY_LOW:19,PRIORITY_BELOW_NORMAL:10,PRIORITY_NORMAL:0,PRIORITY_ABOVE_NORMAL:-7,PRIORITY_HIGH:-14,PRIORITY_HIGHEST:-20,OPENSSL_VERSION_NUMBER:269488319,SSL_OP_ALL:2147485780,SSL_OP_ALLOW_NO_DHE_KEX:1024,SSL_OP_ALLOW_UNSAFE_LEGACY_RENEGOTIATION:262144,SSL_OP_CIPHER_SERVER_PREFERENCE:4194304,SSL_OP_CISCO_ANYCONNECT:32768,SSL_OP_COOKIE_EXCHANGE:8192,SSL_OP_CRYPTOPRO_TLSEXT_BUG:2147483648,SSL_OP_DONT_INSERT_EMPTY_FRAGMENTS:2048,SSL_OP_EPHEMERAL_RSA:0,SSL_OP_LEGACY_SERVER_CONNECT:4,SSL_OP_MICROSOFT_BIG_SSLV3_BUFFER:0,SSL_OP_MICROSOFT_SESS_ID_BUG:0,SSL_OP_MSIE_SSLV2_RSA_PADDING:0,SSL_OP_NETSCAPE_CA_DN_BUG:0,SSL_OP_NETSCAPE_CHALLENGE_BUG:0,SSL_OP_NETSCAPE_DEMO_CIPHER_CHANGE_BUG:0,SSL_OP_NETSCAPE_REUSE_CIPHER_CHANGE_BUG:0,SSL_OP_NO_COMPRESSION:131072,SSL_OP_NO_ENCRYPT_THEN_MAC:524288,SSL_OP_NO_QUERY_MTU:4096,SSL_OP_NO_RENEGOTIATION:1073741824,SSL_OP_NO_SESSION_RESUMPTION_ON_RENEGOTIATION:65536,SSL_OP_NO_SSLv2:0,SSL_OP_NO_SSLv3:33554432,SSL_OP_NO_TICKET:16384,SSL_OP_NO_TLSv1:67108864,SSL_OP_NO_TLSv1_1:268435456,SSL_OP_NO_TLSv1_2:134217728,SSL_OP_NO_TLSv1_3:536870912,SSL_OP_PKCS1_CHECK_1:0,SSL_OP_PKCS1_CHECK_2:0,SSL_OP_PRIORITIZE_CHACHA:2097152,SSL_OP_SINGLE_DH_USE:0,SSL_OP_SINGLE_ECDH_USE:0,SSL_OP_SSLEAY_080_CLIENT_DH_BUG:0,SSL_OP_SSLREF2_REUSE_CERT_TYPE_BUG:0,SSL_OP_TLS_BLOCK_PADDING_BUG:0,SSL_OP_TLS_D5_BUG:0,SSL_OP_TLS_ROLLBACK_BUG:8388608,ENGINE_METHOD_RSA:1,ENGINE_METHOD_DSA:2,ENGINE_METHOD_DH:4,ENGINE_METHOD_RAND:8,ENGINE_METHOD_EC:2048,ENGINE_METHOD_CIPHERS:64,ENGINE_METHOD_DIGESTS:128,ENGINE_METHOD_PKEY_METHS:512,ENGINE_METHOD_PKEY_ASN1_METHS:1024,ENGINE_METHOD_ALL:65535,ENGINE_METHOD_NONE:0,DH_CHECK_P_NOT_SAFE_PRIME:2,DH_CHECK_P_NOT_PRIME:1,DH_UNABLE_TO_CHECK_GENERATOR:4,DH_NOT_SUITABLE_GENERATOR:8,ALPN_ENABLED:1,RSA_PKCS1_PADDING:1,RSA_SSLV23_PADDING:2,RSA_NO_PADDING:3,RSA_PKCS1_OAEP_PADDING:4,RSA_X931_PADDING:5,RSA_PKCS1_PSS_PADDING:6,RSA_PSS_SALTLEN_DIGEST:-1,RSA_PSS_SALTLEN_MAX_SIGN:-2,RSA_PSS_SALTLEN_AUTO:-2,defaultCoreCipherList:"TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA384:DHE-RSA-AES256-SHA384:ECDHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA256:HIGH:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!SRP:!CAMELLIA",TLS1_VERSION:769,TLS1_1_VERSION:770,TLS1_2_VERSION:771,TLS1_3_VERSION:772,POINT_CONVERSION_COMPRESSED:2,POINT_CONVERSION_UNCOMPRESSED:4,POINT_CONVERSION_HYBRID:6,Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_VERSION_ERROR:-6,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,ZLIB_VERNUM:4784,DEFLATE:1,INFLATE:2,GZIP:3,GUNZIP:4,DEFLATERAW:5,INFLATERAW:6,UNZIP:7,BROTLI_DECODE:8,BROTLI_ENCODE:9,ZSTD_COMPRESS:10,ZSTD_DECOMPRESS:11,Z_MIN_WINDOWBITS:8,Z_MAX_WINDOWBITS:15,Z_DEFAULT_WINDOWBITS:15,Z_MIN_CHUNK:64,Z_MAX_CHUNK:null,Z_DEFAULT_CHUNK:16384,Z_MIN_MEMLEVEL:1,Z_MAX_MEMLEVEL:9,Z_DEFAULT_MEMLEVEL:8,Z_MIN_LEVEL:-1,Z_MAX_LEVEL:9,Z_DEFAULT_LEVEL:-1,BROTLI_OPERATION_PROCESS:0,BROTLI_OPERATION_FLUSH:1,BROTLI_OPERATION_FINISH:2,BROTLI_OPERATION_EMIT_METADATA:3,BROTLI_PARAM_MODE:0,BROTLI_MODE_GENERIC:0,BROTLI_MODE_TEXT:1,BROTLI_MODE_FONT:2,BROTLI_DEFAULT_MODE:0,BROTLI_PARAM_QUALITY:1,BROTLI_MIN_QUALITY:0,BROTLI_MAX_QUALITY:11,BROTLI_DEFAULT_QUALITY:11,BROTLI_PARAM_LGWIN:2,BROTLI_MIN_WINDOW_BITS:10,BROTLI_MAX_WINDOW_BITS:24,BROTLI_LARGE_MAX_WINDOW_BITS:30,BROTLI_DEFAULT_WINDOW:22,BROTLI_PARAM_LGBLOCK:3,BROTLI_MIN_INPUT_BLOCK_BITS:16,BROTLI_MAX_INPUT_BLOCK_BITS:24,BROTLI_PARAM_DISABLE_LITERAL_CONTEXT_MODELING:4,BROTLI_PARAM_SIZE_HINT:5,BROTLI_PARAM_LARGE_WINDOW:6,BROTLI_PARAM_NPOSTFIX:7,BROTLI_PARAM_NDIRECT:8,BROTLI_DECODER_RESULT_ERROR:0,BROTLI_DECODER_RESULT_SUCCESS:1,BROTLI_DECODER_RESULT_NEEDS_MORE_INPUT:2,BROTLI_DECODER_RESULT_NEEDS_MORE_OUTPUT:3,BROTLI_DECODER_PARAM_DISABLE_RING_BUFFER_REALLOCATION:0,BROTLI_DECODER_PARAM_LARGE_WINDOW:1,BROTLI_DECODER_NO_ERROR:0,BROTLI_DECODER_SUCCESS:1,BROTLI_DECODER_NEEDS_MORE_INPUT:2,BROTLI_DECODER_NEEDS_MORE_OUTPUT:3,BROTLI_DECODER_ERROR_FORMAT_EXUBERANT_NIBBLE:-1,BROTLI_DECODER_ERROR_FORMAT_RESERVED:-2,BROTLI_DECODER_ERROR_FORMAT_EXUBERANT_META_NIBBLE:-3,BROTLI_DECODER_ERROR_FORMAT_SIMPLE_HUFFMAN_ALPHABET:-4,BROTLI_DECODER_ERROR_FORMAT_SIMPLE_HUFFMAN_SAME:-5,BROTLI_DECODER_ERROR_FORMAT_CL_SPACE:-6,BROTLI_DECODER_ERROR_FORMAT_HUFFMAN_SPACE:-7,BROTLI_DECODER_ERROR_FORMAT_CONTEXT_MAP_REPEAT:-8,BROTLI_DECODER_ERROR_FORMAT_BLOCK_LENGTH_1:-9,BROTLI_DECODER_ERROR_FORMAT_BLOCK_LENGTH_2:-10,BROTLI_DECODER_ERROR_FORMAT_TRANSFORM:-11,BROTLI_DECODER_ERROR_FORMAT_DICTIONARY:-12,BROTLI_DECODER_ERROR_FORMAT_WINDOW_BITS:-13,BROTLI_DECODER_ERROR_FORMAT_PADDING_1:-14,BROTLI_DECODER_ERROR_FORMAT_PADDING_2:-15,BROTLI_DECODER_ERROR_FORMAT_DISTANCE:-16,BROTLI_DECODER_ERROR_DICTIONARY_NOT_SET:-19,BROTLI_DECODER_ERROR_INVALID_ARGUMENTS:-20,BROTLI_DECODER_ERROR_ALLOC_CONTEXT_MODES:-21,BROTLI_DECODER_ERROR_ALLOC_TREE_GROUPS:-22,BROTLI_DECODER_ERROR_ALLOC_CONTEXT_MAP:-25,BROTLI_DECODER_ERROR_ALLOC_RING_BUFFER_1:-26,BROTLI_DECODER_ERROR_ALLOC_RING_BUFFER_2:-27,BROTLI_DECODER_ERROR_ALLOC_BLOCK_TYPE_TREES:-30,BROTLI_DECODER_ERROR_UNREACHABLE:-31}),y1}var eF=JM();const tF=ao(eF);function rF(n){return n[Symbol.asyncIterator]!=null}function nF(n){if(rF(n))return(async()=>{let r=new Uint8Array(0);for await(const i of n)r=tr([r,i],r.length+i.length);return r})();const e=[];let t=0;for(const r of n)e.push(r),t+=r.byteLength;return tr(e,t)}const iF="0000000000000000000",sF="7777777777777777777",oF=48,aF=C("ustar\0","binary"),cF=C("00","binary"),lF=parseInt("7777",8),uF=257,dF=263,hF=function(n){switch(n){case"file":return 0;case"link":return 1;case"symlink":return 2;case"character-device":return 3;case"block-device":return 4;case"directory":return 5;case"fifo":return 6;case"contiguous-file":return 7;case"pax-header":return 72;default:return 0}},fF=function(n){let e=256;for(let t=0;t<148;t++)e+=n[t];for(let t=156;t<512;t++)e+=n[t];return e},Hn=function(n,e){const t=n.toString(8);return t.length>e?C(sF.slice(0,e)+" "):C(iF.slice(0,e-t.length)+t+" ")},w1=function(n){const e=C(n).byteLength;let t=Math.floor(Math.log(e)/Math.log(10))+1;return e+t>=Math.pow(10,t)&&t++,`${e+t}${n}`};function pF(n){let e="";n.name!=null&&(e+=w1(" path="+n.name+`
`)),n.linkname!=null&&(e+=w1(" linkpath="+n.linkname+`
`));const t=n.pax;if(t!=null)for(const r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e+=w1(" "+r+"="+t[r]+`
`));return C(e)}function M0(n){const e=new Uint8Array(512);let t=n.name,r="";if(n.typeflag===5&&t[t.length-1]!=="/"&&(t+="/"),C(t).byteLength!==t.length)return null;for(;C(t).byteLength>100;){const i=t.indexOf("/");if(i===-1)return null;r+=r!==""?"/"+t.slice(0,i):t.slice(0,i),t=t.slice(i+1)}return C(t).byteLength>100||C(r).byteLength>155||n.linkname!=null&&C(n.linkname).byteLength>100?null:(e.set(C(t),0),e.set(Hn(n.mode&lF,6),100),e.set(Hn(n.uid,6),108),e.set(Hn(n.gid,6),116),e.set(Hn(n.size,11),124),e.set(Hn(n.mtime.getTime()/1e3|0,11),136),e[156]=oF+hF(n.type),n.linkname!=null&&e.set(C(n.linkname),157),e.set(aF,uF),e.set(cF,dF),n.uname!=null&&e.set(C(n.uname),265),n.gname!=null&&e.set(C(n.gname),297),e.set(Hn(n.devmajor??0,6),329),e.set(Hn(n.devminor??0,6),337),r!=null&&e.set(C(r),345),e.set(Hn(fF(e),6),148),e)}const{S_IFMT:gF,S_IFBLK:mF,S_IFCHR:yF,S_IFDIR:wF,S_IFIFO:vF,S_IFLNK:bF}=tF,EF=parseInt("755",8),SF=parseInt("644",8),Q9=new Uint8Array(1024);function xF(n=0){switch(n&gF){case mF:return"block-device";case yF:return"character-device";case wF:return"directory";case vF:return"fifo";case bF:return"symlink";default:return"file"}}function F0(n){return n&=511,n!==0?Q9.subarray(0,512-n):new Uint8Array(0)}function v1(n){if(n.pax==null){const e=M0(n);if(e!=null)return e}return AF(n)}function AF(n){const e=pF(n),t={name:"PaxHeader",mode:n.mode,uid:n.uid,gid:n.gid,size:e.length,mtime:n.mtime,type:"pax-header",linkname:n.linkname,uname:n.uname,gname:n.gname,devmajor:n.devmajor,devminor:n.devminor};return new $e(M0(t)??new Uint8Array(0),e,F0(e.length),M0({...t,size:n.size,type:n.type})??new Uint8Array(0)).subarray()}function i5(){return async function*(n){for await(let{header:e,body:t}of n){const r={...e,size:e.type==="symlink"?0:e.size??0,type:e.type??xF(e.mode),mode:e.mode??(e.type==="directory"?EF:SF),uid:e.uid??0,gid:e.gid??0,mtime:e.mtime??new Date};if(typeof t=="string"&&(t=C(t)),t instanceof Uint8Array||ll(t)){r.size=t.length,yield v1(r),yield ll(t)?t.subarray():t,yield F0(r.size);continue}if(r.type==="symlink"&&r.linkname==null){if(t==null)throw new Error("type was symlink but no linkname or body specified");r.linkname=ee(await nF(t)),yield v1(r);continue}if(yield v1(r),r.type!=="file"&&r.type!=="contiguous-file")continue;let i=0;for await(const s of t??[])i+=s.length,yield ll(s)?s.subarray():s;if(i!==r.size)throw new Error(`size mismatch, wrote ${i} of ${r.size} bytes`);yield F0(r.size)}yield Q9}}const kF=["file","raw","directory"];function _F(n){let e,t;return(n.type==="file"||n.type==="directory")&&(e=n.unixfs.mode,t=n.unixfs.mtime!=null?new Date(Number(n.unixfs.mtime.secs*1000n)):void 0),{name:n.path,mode:e,mtime:t,size:Number(n.size),type:n.type==="directory"?"directory":"file"}}function s5(n){if(!kF.includes(n.type))throw new Eo(`${n.type} is not a UnixFS node`);const e={header:_F(n)};return(n.type==="file"||n.type==="raw")&&(e.body=n.content()),e}async function*IF(n,e,t){const r=await Kr(n,e,t);if(r.type==="file"||r.type==="raw"){yield*rr([s5(r)],i5());return}if(r.type==="directory"){yield*rr(x2(n,e,t),i=>un(i,s=>s5(s)),i5());return}throw new Eo("Not a UnixFS node")}class CF extends Fn{id="tar-plugin";codes=[];canHandle({cid:e,accept:t,query:r,byteRangeContext:i}){return this.log("checking if we can handle %c with accept %s",e,t),i==null?!1:t==="application/x-tar"||r.format==="tar"}async handle(e){const{cid:t,path:r,resource:i,options:s,pathDetails:o}=e,{getBlockstore:a}=this.pluginOptions,c=o?.terminalElement.cid??t;if(c.code!==qt&&c.code!==er)return ec("only UnixFS data can be returned in a TAR file");e.reqFormat="tar",e.query.download=!0,e.query.filename=e.query.filename??`${c.toString()}.tar`;const l=a(c,i,s?.session,s),u=f2(IF(`/ipfs/${t}/${r}`,l,s));e.byteRangeContext.setBody(u);const d=cs(i,e.byteRangeContext.getBody("application/x-tar"),{byteRangeContext:e.byteRangeContext,log:this.log});return d.headers.set("content-type",e.byteRangeContext.getContentType()??"application/x-tar"),d.headers.set("etag",j9({cid:c,reqFormat:e.reqFormat,weak:!0})),d}}function TF(n){const e=RF(n);return e===n?`filename="${n}"`:`filename="${e}"; filename*=UTF-8''${encodeURIComponent(n)}`}function RF(n){return n.replace(/[^\x00-\x7F]/g,"_")}const PF={[ii]:["application/json","application/vnd.ipld.dag-cbor","application/cbor","application/vnd.ipld.dag-json","application/octet-stream","application/vnd.ipld.raw","application/vnd.ipfs.ipns-record","application/vnd.ipld.car","text/html"],[Is]:["application/json","application/vnd.ipld.dag-cbor","application/cbor","application/vnd.ipld.dag-json","application/octet-stream","application/vnd.ipld.raw","application/vnd.ipfs.ipns-record","application/vnd.ipld.car"],[ka]:["application/json","application/vnd.ipld.dag-cbor","application/cbor","application/vnd.ipld.dag-json","application/octet-stream","application/vnd.ipld.raw","application/vnd.ipfs.ipns-record","application/vnd.ipld.car"],[qt]:["application/octet-stream","application/json","application/vnd.ipld.dag-cbor","application/cbor","application/vnd.ipld.dag-json","application/vnd.ipld.raw","application/vnd.ipfs.ipns-record","application/vnd.ipld.car","application/x-tar"],[er]:["application/octet-stream","application/vnd.ipld.raw","application/vnd.ipfs.ipns-record","application/vnd.ipld.dag-json","application/vnd.ipld.car","application/x-tar"]};function OF(n,e){const t=PF[n.code];if(e!=null)return NF(e,t)}function NF(n,e){const t=n.split(",").map(r=>{const i=r.trim().split(";");return{mimeType:`${i[0]}`.trim(),weight:DF(i[1])}}).sort((r,i)=>r.weight===i.weight?0:r.weight>i.weight?-1:1).map(r=>r.mimeType);for(const r of t)for(const i of e)if(r.includes(i)||r==="*/*"||r.startsWith("*/")&&i.split("/")[1]===r.split("/")[1]||r.endsWith("/*")&&i.split("/")[0]===r.split("/")[0])return i}function DF(n){if(n!=null&&(n=n.trim()),n?.startsWith("q=")!==!0)return 1;const e=parseFloat(n.replace("q=",""));return isNaN(e)?0:e}const P2={raw:"application/vnd.ipld.raw",car:"application/vnd.ipld.car","dag-json":"application/vnd.ipld.dag-json","dag-cbor":"application/vnd.ipld.dag-cbor",json:"application/json",cbor:"application/cbor","ipns-record":"application/vnd.ipfs.ipns-record",tar:"application/x-tar"};function LF(n){if(n!=null)return P2[n]}function Y9(n){const e=n.get("accept");return!!(e!=null&&Object.values(P2).includes(e))}function X9(n){const e=n?.format;return!!(e!=null&&Object.keys(P2).includes(e))}function BF({query:n,headers:e}){return Y9(e)||X9(n)}function MF({query:n,headers:e,logger:t}){const r=t.forComponent("helia:verified-fetch:get-resolved-accept-header"),i=new Headers(e),s=i.get("accept")??void 0;if(s!=null&&r('incoming accept header "%s"',s),!BF({query:n,headers:i}))return r("no explicit IPLD content-type requested, returning incoming accept header %s",s),s;const o=LF(n?.format);n?.format!=null&&r('incoming query format "%s", mapped to %s',n.format,o);let a=s;return!Y9(i)&&X9(n)&&(r("accept header not recognized, but query format provided, setting accept header to %s",o),a=o),r('resolved accept header to "%s"',a),a}async function U0(n,e,t){const r=performance.now();try{const i=await t(),o=(performance.now()-r).toFixed(1),a=`${n};dur=${o};desc="${e}"`;return{result:i,header:a,error:null}}catch(i){const o=(performance.now()-r).toFixed(1),a=`${n};dur=${o};desc="${e}"`;return{result:null,error:i,header:a}}}class FF{lru;constructor(e){this.lru=new s9({maxSize:e})}get(e){return this.lru.get(e)}set(e,t,r){this.lru.set(e,t,{maxAge:Date.now()+r})}has(e){return this.get(e)!=null}remove(e){this.lru.delete(e)}clear(){this.lru.clear()}}const o5=new FF(1e3),UF=/^(?<protocol>ip[fn]s):\/\/(?<cidOrPeerIdOrDnsLink>[^/?]+)\/?(?<path>[^?]*)\??(?<queryString>.*)$/,$F=/^\/(?<protocol>ip[fn]s)\/(?<cidOrPeerIdOrDnsLink>[^/?]+)\/?(?<path>[^?]*)\??(?<queryString>.*)$/,VF=/^https?:\/\/(.*[^/])\/(?<protocol>ip[fn]s)\/(?<cidOrPeerIdOrDnsLink>[^/?]+)\/?(?<path>[^?]*)\??(?<queryString>.*)$/,qF=/^https?:\/\/(?<cidOrPeerIdOrDnsLink>[^/?]+)\.(?<protocol>ip[fn]s)\.([^/?]+)\/?(?<path>[^?]*)\??(?<queryString>.*)$/;function HF(n){const e=n?.protocol;if(e==null)return!1;const t=n?.cidOrPeerIdOrDnsLink;if(t==null)return!1;const r=n?.path,i=n?.queryString;return["ipns","ipfs"].includes(e)&&typeof t=="string"&&(r==null||typeof r=="string")&&(i==null||typeof i=="string")}function O2(n){for(const e of[qF,UF,VF,$F]){const t=n.match(e);if(HF(t?.groups))return t.groups}throw new TypeError(`Invalid URL: ${n}, please use ipfs://, ipns://, or gateway URLs only`)}function zF(n){if(n==null)return;const e=n.answer?.TTL,t=n.record?.ttl,r=t!=null?Number(t/BigInt(1e9)):void 0;return e??r}const KF=/^[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?$/;function WF(n){return KF.test(n)&&n.includes("-")&&!n.includes(".")}function GF(n){return n.replace(/--/g,"%").replace(/-/g,".").replace(/%/g,"-")}async function jF({urlString:n,ipns:e,logger:t,withServerTiming:r=!1},i){const s=t.forComponent("helia:verified-fetch:parse-url-string"),{protocol:o,cidOrPeerIdOrDnsLink:a,path:c,queryString:l}=O2(n);let u,d;const h=[];let f;const m=[];if(o==="ipfs")try{u=he.parse(a)}catch(E){s.error(E),h.push(new TypeError("Invalid CID for ipfs://<cid> URL"))}else if(f=o5.get(a),f!=null)u=f.cid,d=f.path,s.trace("resolved %s to %c from cache",a,u);else{s.trace("Attempting to resolve PeerId for %s",a);let E;try{E=G9(a);const A=E?.publicKey;if(A==null)throw new TypeError("cidOrPeerIdOrDnsLink contains no public key");if(r){const T=async()=>e.resolve(A,i),R=await U0("ipns.resolve",`Resolve IPNS name ${a}`,T);if(m.push(R),R.error!=null)throw R.error;f=R.result}else f=await e.resolve(A,i);u=f?.cid,d=f?.path,s.trace("resolved %s to %c",a,u)}catch(A){if(i?.signal?.aborted)throw new pt(i?.signal?.reason);E==null?(s.error('could not parse PeerId string "%s"',a,A),h.push(new TypeError(`Could not parse PeerId in ipns url "${a}", ${A.message}`))):(s.error("could not resolve PeerId %c",E,A),h.push(new TypeError(`Could not resolve PeerId "${a}": ${A.message}`)))}if(u==null){let A=a;WF(a)&&(A=GF(a),s.trace('decoded dnslink from "%s" to "%s"',a,A)),s.trace("Attempting to resolve DNSLink for %s",A);try{if(r){const T=await U0("ipns.resolveDNSLink",`Resolve DNSLink ${A}`,e.resolveDNSLink.bind(e,A,i));if(m.push(T),T.error!=null)throw T.error;f=T.result}else f=await e.resolveDNSLink(A,i);u=f?.cid,d=f?.path,s.trace("resolved %s to %c",A,u)}catch(T){if(i?.signal?.aborted)throw new pt(i?.signal?.reason);s.error('could not resolve DnsLink for "%s"',a,T),h.push(T)}}}if(u==null)throw h.length===1?h[0]:(h.push(new Error(`Invalid resource. Cannot determine CID from URL "${n}".`)),h);let y=zF(f);f!=null&&(y=y??120,s.trace("caching %s resolved to %s with TTL: %s",a,u,y),o5.set(a,f,y*1e3));const w={};if(l!=null&&l.length>0){const E=l.split("&");for(const A of E){const[T,R]=A.split("=");w[T]=decodeURIComponent(R)}w.download!=null&&(w.download=w.download==="true"),w.filename!=null&&(w.filename=w.filename.toString())}return{protocol:o,cid:u,path:QF(d,c??""),query:w,ttl:y,ipfsPath:`/${o}/${a}${c!=null&&c!==""?`/${c}`:""}`,serverTimings:m}}function QF(n,e){let t="";return n!=null&&(t+=n),e.length>0&&(t=`${t.length>0?`${t}/`:t}${e}`),t=t.replace(/\/(\/)+/g,"/"),t.startsWith("/")&&(t=t.substring(1)),t.split("/").map(decodeURIComponent).join("/")}function a5(n){return n.match(/\.[a-zA-Z0-9]{1,4}$/)!=null||n.endsWith("/")?n:`${n}/`}async function YF({resource:n,options:e,logger:t,cid:r,fetch:i=globalThis.fetch}){const s=t.forComponent("helia:verified-fetch:get-redirect-response");if(typeof n!="string"||e==null||["ipfs://","ipns://"].some(u=>n.startsWith(u)))return null;const o=new Headers(e?.headers),a=o.get("x-forwarded-host"),c=o.get("host");if(o.get("x-forwarded-for")==null&&a==null&&c==null)return s.trace("no redirect info found in headers"),null;s.trace("checking for redirect info");try{const u=O2(n),d=new URL(n),h=a??d.host,f=new URL(d);if(u.protocol==="ipfs"&&r.version===0?f.host=`${r.toV1()}.ipfs.${h}`:f.host=`${u.cidOrPeerIdOrDnsLink}.${u.protocol}.${h}`,c?.includes(u.protocol)===!0&&f.host.includes(c))return s.trace("request was for a subdomain already, not setting location header"),null;if(c!=null&&!f.host.includes(c))return s.trace("host header is not the same as the subdomain url host, not setting location header"),null;if(d.host===f.host)return s.trace("req url is the same as the subdomain url, not setting location header"),null;f.pathname=a5(d.pathname.replace(`/${u.cidOrPeerIdOrDnsLink}`,"").replace(`/${u.protocol}`,"")),s.trace("subdomain url %s",f.href);const m=new URL(d,`${d.protocol}//${h}`);m.pathname=a5(d.pathname),s.trace("path url %s",m.href);try{const y=await i(f,{method:"HEAD"});if(y.ok)return s("subdomain supported, redirecting to subdomain"),A0(n.toString(),f.href);throw s("subdomain not supported, subdomain failed with status %s %s",y.status,y.statusText),new eD("subdomain not supported")}catch(y){return s("subdomain not supported",y),m.href===d.href?(s("path url is the same as the request url, not setting location header"),null):A0(n.toString(),m.href)}}catch(u){s.error("error setting location header for x-forwarded-host",u)}return null}async function XF(n,{ipns:e,logger:t},{withServerTiming:r=!1,...i}={withServerTiming:!1}){if(typeof n=="string")return jF({urlString:n,ipns:e,logger:t,withServerTiming:r},i);const s=he.asCID(n);if(s!=null)return{cid:s,protocol:"ipfs",path:"",query:{},ipfsPath:`/ipfs/${s.toString()}`,ttl:29030400,serverTimings:[]};throw new TypeError(`Invalid resource. Cannot determine CID from resource: ${n}`)}function ZF(n){const e=he.asCID(n);if(e!=null)return`ipfs://${e}`;try{return`ipfs://${he.parse(n.toString())}`}catch{}const{protocol:t,cidOrPeerIdOrDnsLink:r}=O2(n.toString());return`${t}://${r}`}const JF=100,eU=60*1e3;function tU(n){if(n==null)return;let e;return n?.signal===null?e=void 0:e=n?.signal,{...n,signal:e}}class rU{helia;ipns;log;contentTypeParser;blockstoreSessions;serverTimingHeaders=[];withServerTiming;plugins=[];constructor({helia:e,ipns:t},r){this.helia=e,this.log=e.logger.forComponent("helia:verified-fetch"),this.ipns=t??ZN(e),this.contentTypeParser=r?.contentTypeParser??VM,this.blockstoreSessions=new s9({maxSize:r?.sessionCacheSize??JF,maxAge:r?.sessionTTLms??eU,onEviction:(a,c)=>{c.close()}}),this.withServerTiming=r?.withServerTiming??!1;const i={...r,logger:Xw("helia:verified-fetch"),getBlockstore:(a,c,l,u)=>this.getBlockstore(a,c,l,u),handleServerTiming:async(a,c,l)=>this.handleServerTiming(a,c,l,this.withServerTiming),helia:e,contentTypeParser:this.contentTypeParser},s=[new zM(i),new uD(i),new WM(i),new xD(i),new YM(i),new CF(i),new GM(i),new nL(i),new HM(i)],o=r?.plugins?.map(a=>a(i))??[];if(o.length>0){const a=new Map(s.map(l=>[l.id,l])),c=new Map(o.map(l=>[l.id,l]));this.plugins=s.map(l=>c.get(l.id)??l),this.plugins.push(...o.filter(l=>!a.has(l.id)))}else this.plugins=s;this.log.trace("created VerifiedFetch instance")}getBlockstore(e,t,r=!0,i={}){const s=ZF(t);if(!r)return this.helia.blockstore;let o=this.blockstoreSessions.get(s);return o==null&&(o=this.helia.blockstore.createSession(e,i),this.blockstoreSessions.set(s,o)),o}async handleServerTiming(e,t,r,i){if(!i)return r();const{error:s,result:o,header:a}=await U0(e,t,r);if(this.serverTimingHeaders.push(a),s!=null)throw s;return o}handleFinalResponse(e,{query:t,cid:r,reqFormat:i,ttl:s,protocol:o,ipfsPath:a,pathDetails:c,byteRangeContext:l,options:u}={}){if(this.serverTimingHeaders.length>0){const h=this.serverTimingHeaders.join(", ");e.headers.set("Server-Timing",h),this.serverTimingHeaders=[]}if(e.headers.get("Transfer-Encoding")!=="chunked"&&l!=null){const h=l.getLength();h!=null&&(this.log.trace("Setting Content-Length from byteRangeContext: %d",h),e.headers.set("Content-Length",h.toString()))}let d;if(this.log.trace("checking for content disposition"),t?.download===!0?d="attachment":this.log.trace("download not requested"),t?.filename!=null?(d==null&&(d="inline"),d=`${d}; ${TF(t.filename)}`):this.log.trace("no filename specified in query"),d!=null?e.headers.set("Content-Disposition",d):this.log.trace("no content disposition specified"),r!=null&&e.headers.get("etag")==null&&e.headers.set("etag",j9({cid:c?.terminalElement.cid??r,reqFormat:i,weak:!1})),o!=null&&nD({response:e,ttl:s,protocol:o}),a!=null&&e.headers.set("X-Ipfs-Path",a),e.headers.set("Access-Control-Allow-Origin","*"),e.headers.set("Access-Control-Allow-Methods","GET, HEAD, OPTIONS"),e.headers.set("Access-Control-Allow-Headers","Range, X-Requested-With"),e.headers.set("Access-Control-Expose-Headers","Content-Range, Content-Length, X-Ipfs-Path, X-Stream-Output"),i!=="car"?e.headers.set("Accept-Ranges","bytes"):e.headers.set("Accept-Ranges","none"),u?.method==="HEAD"){const h=e?.headers;return new Response(null,{status:200,headers:h})}return e}async runPluginPipeline(e,t=3){let r,i=0;const s=new Set;let o=e.modified;for(;i<t;){this.log(`Starting pipeline pass #${i+1}`),i++;const a=this.plugins.filter(u=>!s.has(u.id)).filter(u=>u.canHandle(e));if(a.length===0){this.log.trace("No plugins can handle the current context.. checking by CID code");const u=this.plugins.filter(d=>d.codes.includes(e.cid.code));if(u.length>0)a.push(...u);else{this.log.trace("No plugins found that can handle request by CID code; exiting pipeline.");break}}this.log.trace("Plugins ready to handle request: ",a.map(u=>u.id).join(", "));let c=!1,l=!1;for(const u of a){try{this.log.trace("Invoking plugin:",u.id),s.add(u.id);const d=await u.handle(e);if(d!=null){r=d,l=!0;break}}catch(d){if(e.options?.signal?.aborted)throw new pt(e.options?.signal?.reason);if(this.log.error("Error in plugin:",u.constructor.name,d),d.name==="PluginFatalError")return d.response??g2(e.resource,"Failed to fetch")}finally{const d=e.modified;c=d!==o,c&&(o=d)}if(r!=null){this.log.trace("Plugin produced final response:",u.id);break}}if(l&&r!=null)break;if(!c){this.log.trace("No context changes and no final response; exiting pipeline.");break}}return r}async fetch(e,t){if(this.log("fetch %s",e),t?.method==="OPTIONS")return this.handleFinalResponse(new Response(null,{status:200}));const r=tU(t),i=r?.withServerTiming??this.withServerTiming;r?.onProgress?.(new P("verified-fetch:request:start",{resource:e}));let s;try{s=await this.handleServerTiming("parse-resource","",async()=>XF(e,{ipns:this.ipns,logger:this.helia.logger},{withServerTiming:i,...r}),i),this.serverTimingHeaders.push(...s.serverTimings.map(({header:h})=>h))}catch(h){if(r?.signal?.aborted)throw new pt(r?.signal?.reason);return this.log.error("error parsing resource %s",e,h),this.handleFinalResponse(x0(e.toString(),h))}r?.onProgress?.(new P("verified-fetch:request:resolve",{cid:s.cid,path:s.path}));const o=MF({query:s.query,headers:r?.headers,logger:this.helia.logger}),a=OF(s.cid,o);if(this.log("output type %s",a),o!=null&&a==null)return this.handleFinalResponse(ec(e.toString()));const c=a?.split(";")[0]??"application/octet-stream",l=await YF({resource:e,options:r,logger:this.helia.logger,cid:s.cid});if(l!=null)return this.handleFinalResponse(l);const u={...s,resource:e.toString(),accept:a,options:r,withServerTiming:i,onProgress:r?.onProgress,modified:0,plugins:this.plugins.map(h=>h.id)};this.log.trace('finding handler for cid code "%s" and response content type "%s"',s.cid.code,c);const d=await this.runPluginPipeline(u);return r?.onProgress?.(new P("verified-fetch:request:end",{cid:s.cid,path:s.path})),this.handleFinalResponse(d??c9(e.toString()),u)}async start(){await this.helia.start()}async stop(){await this.helia.stop()}}let xa;const N2=async function(e,t){return xa==null&&(xa=await nU()),xa(e,t)};N2.start=async function(){await xa?.start()};N2.stop=async function(){await xa?.stop()};async function nU(n,e){let t;if(!iU(n)){const s=sU(n?.dnsResolvers),o=MN();o.dns=s;const a=n?.routers??["https://delegated-ipfs.dev"];for(let u=0;u<a.length;u++){const d=a[u];o.services[`delegatedRouting${u}`]=()=>U6(d)}n?.libp2pConfig!=null&&Object.assign(o,n.libp2pConfig),t=await py(o);const c=[y6()],l=[H6(t)];(n?.gateways==null||n.gateways.length>0)&&(c.push(P6({allowInsecure:n?.allowInsecure,allowLocal:n?.allowLocal})),l.push(q6({gateways:n?.gateways??["https://trustless-gateway.link"]}))),n=await BN({libp2p:t,blockBrokers:c,dns:s,routers:l,hashers:n?.hashers}),n.logger.forComponent("helia:verified-fetch").trace("created verified-fetch with libp2p config: %j",o)}const r=new rU({helia:n},e);async function i(s,o){return r.fetch(s,o)}return i.start=r.start.bind(r),i.stop=r.stop.bind(r),i}function iU(n){return n?.blockstore!=null&&n?.datastore!=null&&n?.gc!=null&&n?.stop!=null&&n?.start!=null}function sU(n){if(n!=null)return Array.isArray(n)?Cl({resolvers:{".":n}}):Cl({resolvers:n})}async function WV(n){const e=El();n=n.filter(Boolean);const t=n.pop();await Promise.all(n.map(async r=>{const i=e.session();try{await i.run(`
        MATCH (e) WHERE e.mmid = $equivId
        MATCH (t) WHERE t.mmid = $targetId
        MERGE (e)-[eq:EQUALS]->(t)
        ON CREATE SET eq.mmid = $uuid
        ON CREATE SET eq.created_at = toString(datetime())
        RETURN $uuid
      `,{equivId:r,targetId:t,uuid:sa()})}finally{i.close()}}))}async function GV({path:n}){const e=El().session();try{const t=`
      MERGE (r:Root)
      ON CREATE SET r.mmid = $uuid
      ON CREATE SET created_at = toString(datetime())
      RETURN r.mmid AS id
    `,{records:[r]}=await e.run(t,{uuid:sa()});let i=r.get("id");const s=[...n];for(;s.length>0;){const o=s.shift(),a=`
        MATCH (base) WHERE base.mmid = $current
        MERGE (base)-[cont:CONTAINS { path: $elem }]->(node:Spot)
        ON CREATE SET cont.mmid = $contUUID
        ON CREATE SET node.mmid = $nodeUUID
        ON CREATE SET created_at = toString(datetime())
        RETURN node.mmid AS id
      `,{records:[c]}=await e.run(a,{current:i,elem:o,contUUID:sa(),nodeUUID:sa()});i=c.get("id")}return i}finally{e.close()}}const oU={sha256:async(n,{base:e=64}={})=>(typeof n=="string"&&(n=new TextEncoder().encode(n)),await gt.digest(n))};class Z9{ops=new Map;rec;exec;last=null;car={readable:null,writable:null,writer:null};blocks=[];constructor(){this.rec=this.record.bind(this),this.exec=this.execute.bind(this),this.reset()}reset(){const{readable:e,writable:t}=new TransformStream;this.car.readable=e,this.car.writable=t,this.car.writer=t.getWriter();const r=this.blocks;this.car.readable.pipeTo(new WritableStream({write(i){r.push(i)}}))}async record({statement:e,params:t}){const r={statement:e.trim(),at:new Date().toISOString(),mmid:sa()};t&&(r.params=t),this.last&&(r.previous=this.last);const i=await l5(r),s=await oU.sha256(i);return this.last=he.create(1,ii,s),this.ops.set(this.last.toString(),r),this.car.writer!=null&&await this.car.writer.write({cid:this.last,bytes:i}),r}set recording(e){e?this.car.writer||this.reset():this.car.writer=null}async execute({statement:e,params:t},{session:r=null,record:i=null}={}){i==null&&(i=!!this.car.writer);let s=!1;r==null&&(r=El().session(),s=!0);try{return i&&await this.record({statement:e,params:t}),await r.run(e,t)}finally{s&&r.close()}}async run(){const t=El().session();try{if(this.last){let r=this.ops.get(this.last.toString())??null;do r&&(await this.execute(r,{session:t}),r=r.previous!=null?this.ops.get(r.previous.toString())??null:null);while(r)}}finally{t.close()}}generateCAR(){return aU(this.blocks)}static async fromCID(e){typeof e=="string"&&(e=he.parse(e));const t=new Z9;let r=500,i=e;do{const o=await(await N2(`ipfs://${i.toString()}`)).arrayBuffer(),a=$0(o);t.ops.set(e.toString(),a),t.last==null&&(t.last=e),i=a.previous??null}while(i!=null&&r-- >0);return t}}async function aU(n,{log:e=null}={}){e?.("Generating CAR URL");const t=[...n],r=new ReadableStream({pull(o){t.length>0?o.enqueue(t.shift()):o.close()}});if(!t||t.length===0)throw new Error("No blocks generated.");const i=t.at(-1);if(!i)throw new Error("No root block found.");const s=[];return await r.pipeThrough(new Zw([i.cid])).pipeTo(new WritableStream({write(o){s.push(o)}})),{url:URL.createObjectURL(new Blob(s)),cid:i.cid}}export{Z9 as R,GV as c,WV as e,aU as g};
